{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/index.tsx", "relative_path": "cline/webview-ui/src/index.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/index.tsx", "source_code": "import React from \"react\"\nimport ReactDOM from \"react-dom/client\"\nimport \"./index.css\"\nimport App from \"./App\"\nimport reportWebVitals from \"./reportWebVitals\"\nimport \"../../node_modules/@vscode/codicons/dist/codicon.css\"\n\nconst root = ReactDOM.createRoot(document.getElementById(\"root\") as HTMLElement)\nroot.render(\n\t<React.StrictMode>\n\t\t<App />\n\t</React.StrictMode>,\n)\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals()\n", "tag": "", "tokens": 184, "metadata": {}}], "modify_time": 1733144568.7410145}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/App.tsx", "relative_path": "cline/webview-ui/src/App.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/App.tsx", "source_code": "import { useCallback, useEffect, useState } from \"react\"\nimport { useEvent } from \"react-use\"\nimport { ExtensionMessage } from \"../../src/shared/ExtensionMessage\"\nimport ChatView from \"./components/chat/ChatView\"\nimport HistoryView from \"./components/history/HistoryView\"\nimport SettingsView from \"./components/settings/SettingsView\"\nimport WelcomeView from \"./components/welcome/WelcomeView\"\nimport { ExtensionStateContextProvider, useExtensionState } from \"./context/ExtensionStateContext\"\nimport { vscode } from \"./utils/vscode\"\n\nconst AppContent = () => {\n\tconst { didHydrateState, showWelcome, shouldShowAnnouncement } = useExtensionState()\n\tconst [showSettings, setShowSettings] = useState(false)\n\tconst [showHistory, setShowHistory] = useState(false)\n\tconst [showAnnouncement, setShowAnnouncement] = useState(false)\n\n\tconst handleMessage = useCallback((e: MessageEvent) => {\n\t\tconst message: ExtensionMessage = e.data\n\t\tswitch (message.type) {\n\t\t\tcase \"action\":\n\t\t\t\tswitch (message.action!) {\n\t\t\t\t\tcase \"settingsButtonClicked\":\n\t\t\t\t\t\tsetShowSettings(true)\n\t\t\t\t\t\tsetShowHistory(false)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"historyButtonClicked\":\n\t\t\t\t\t\tsetShowSettings(false)\n\t\t\t\t\t\tsetShowHistory(true)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"chatButtonClicked\":\n\t\t\t\t\t\tsetShowSettings(false)\n\t\t\t\t\t\tsetShowHistory(false)\n\t\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t}\n\t}, [])\n\n\tuseEvent(\"message\", handleMessage)\n\n\tuseEffect(() => {\n\t\tif (shouldShowAnnouncement) {\n\t\t\tsetShowAnnouncement(true)\n\t\t\tvscode.postMessage({ type: \"didShowAnnouncement\" })\n\t\t}\n\t}, [shouldShowAnnouncement])\n\n\tif (!didHydrateState) {\n\t\treturn null\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t{showWelcome ? (\n\t\t\t\t<WelcomeView />\n\t\t\t) : (\n\t\t\t\t<>\n\t\t\t\t\t{showSettings && <SettingsView onDone={() => setShowSettings(false)} />}\n\t\t\t\t\t{showHistory && <HistoryView onDone={() => setShowHistory(false)} />}\n\t\t\t\t\t{/* Do not conditionally load ChatView, it's expensive and there's state we don't want to lose (user input, disableInput, askResponse promise, etc.) */}\n\t\t\t\t\t<ChatView\n\t\t\t\t\t\tshowHistoryView={() => {\n\t\t\t\t\t\t\tsetShowSettings(false)\n\t\t\t\t\t\t\tsetShowHistory(true)\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tisHidden={showSettings || showHistory}\n\t\t\t\t\t\tshowAnnouncement={showAnnouncement}\n\t\t\t\t\t\thideAnnouncement={() => {\n\t\t\t\t\t\t\tsetShowAnnouncement(false)\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t</>\n\t\t\t)}\n\t\t</>\n\t)\n}\n\nconst App = () => {\n\treturn (\n\t\t<ExtensionStateContextProvider>\n\t\t\t<AppContent />\n\t\t</ExtensionStateContextProvider>\n\t)\n}\n\nexport default App\n", "tag": "", "tokens": 697, "metadata": {}}], "modify_time": 1733144568.7365282}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/index.css", "relative_path": "cline/webview-ui/src/index.css", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/index.css", "source_code": "textarea:focus {\n\toutline: 1.5px solid var(--vscode-focusBorder, #007fd4);\n}\n\nvscode-button::part(control):focus {\n\toutline: none;\n}\n\n/*\nUse vscode native scrollbar styles\nhttps://github.com/gitkraken/vscode-gitlens/blob/b1d71d4844523e8b2ef16f9e007068e91f46fd88/src/webviews/apps/home/home.scss\n*/\n\nhtml {\n\theight: 100%;\n\t-webkit-font-smoothing: antialiased;\n\t-moz-osx-font-smoothing: grayscale;\n}\n\nbody {\n\tmargin: 0;\n\tline-height: 1.25;\n}\n\nbody.scrollable,\n.scrollable,\nbody.code-block-scrollable,\n.code-block-scrollable {\n\tborder-color: transparent;\n\ttransition: border-color 0.7s linear;\n}\n\nbody:hover.scrollable,\nbody:hover .scrollable,\nbody:focus-within.scrollable,\nbody:focus-within .scrollable,\nbody:hover.code-block-scrollable,\nbody:hover .code-block-scrollable,\nbody:focus-within.code-block-scrollable,\nbody:focus-within .code-block-scrollable {\n\tborder-color: var(--vscode-scrollbarSlider-background);\n\ttransition: none;\n}\n\n.scrollable::-webkit-scrollbar-corner {\n\tbackground-color: transparent !important;\n}\n\n.scrollable::-webkit-scrollbar-thumb {\n\tbackground-color: transparent;\n\tborder-color: inherit;\n\tborder-right-style: inset;\n\tborder-right-width: calc(100vw + 100vh);\n\tborder-radius: unset !important;\n}\n\n.scrollable::-webkit-scrollbar-thumb:hover {\n\tborder-color: var(--vscode-scrollbarSlider-hoverBackground);\n}\n\n.scrollable::-webkit-scrollbar-thumb:active {\n\tborder-color: var(--vscode-scrollbarSlider-activeBackground);\n}\n\n/*\nFix VSCode ignoring webkit scrollbar modifiers\nhttps://github.com/microsoft/vscode/issues/213045\n*/\n@supports selector(::-webkit-scrollbar) {\n\thtml {\n\t\tscrollbar-color: unset;\n\t}\n}\n\n/*\nThe above scrollbar styling uses some transparent background color magic to accomplish its animation. However this doesn't play nicely with SyntaxHighlighter, so we need to set a background color for the code blocks' horizontal scrollbar. This actually has the unintended consequence of always showing the scrollbar which I prefer since it makes it more obvious that there is more content to scroll to.\n*/\n\n.code-block-scrollable::-webkit-scrollbar-track {\n\tbackground: transparent;\n}\n\n.code-block-scrollable::-webkit-scrollbar-thumb {\n\tbackground-color: var(--vscode-scrollbarSlider-background);\n\tborder-radius: 5px;\n\tborder: 2px solid transparent;\n\tbackground-clip: content-box;\n}\n\n.code-block-scrollable::-webkit-scrollbar-thumb:hover {\n\tbackground-color: var(--vscode-scrollbarSlider-hoverBackground);\n}\n\n.code-block-scrollable::-webkit-scrollbar-thumb:active {\n\tbackground-color: var(--vscode-scrollbarSlider-activeBackground);\n}\n\n.code-block-scrollable::-webkit-scrollbar-corner {\n\tbackground-color: transparent;\n}\n\n/*\nDropdown label\nhttps://github.com/microsoft/vscode-webview-ui-toolkit/tree/main/src/dropdown#with-label\n*/\n.dropdown-container {\n\tbox-sizing: border-box;\n\tdisplay: flex;\n\tflex-flow: column nowrap;\n\talign-items: flex-start;\n\tjustify-content: flex-start;\n}\n.dropdown-container label {\n\tdisplay: block;\n\tcolor: var(--vscode-foreground);\n\tcursor: pointer;\n\tfont-size: var(--vscode-font-size);\n\tline-height: normal;\n\tmargin-bottom: 2px;\n}\n\n/* Fix scrollbar in dropdown */\n\nvscode-dropdown::part(listbox) {\n\tborder-color: var(--vscode-scrollbarSlider-background);\n\ttransition: none;\n\tscrollbar-color: var(--vscode-scrollbarSlider-background) transparent;\n}\n\n/* Faded icon buttons in textfields */\n\n.input-icon-button {\n\tcursor: pointer;\n\topacity: 0.65;\n}\n.input-icon-button:hover {\n\topacity: 1;\n}\n.input-icon-button.disabled {\n\tcursor: not-allowed;\n\topacity: 0.4;\n}\n.input-icon-button.disabled:hover {\n\topacity: 0.4;\n}\n\n/* Context mentions */\n\n.mention-context-textarea-highlight {\n\tbackground-color: color-mix(in srgb, var(--vscode-badge-foreground) 30%, transparent);\n\tborder-radius: 3px;\n\tbox-shadow: 0 0 0 0.5px color-mix(in srgb, var(--vscode-badge-foreground) 30%, transparent);\n\tcolor: transparent;\n\t/* padding: 0.5px;\n\tmargin: -0.5px;\n\tposition: relative;\n\tbottom: -0.5px; */\n}\n\n.mention-context-highlight {\n\tbackground-color: color-mix(in srgb, var(--vscode-badge-foreground) 30%, transparent);\n\tborder-radius: 3px;\n}\n\n.mention-context-highlight-with-shadow {\n\tbackground-color: color-mix(in srgb, var(--vscode-badge-foreground) 30%, transparent);\n\tborder-radius: 3px;\n\tbox-shadow: 0 0 0 0.5px color-mix(in srgb, var(--vscode-badge-foreground) 30%, transparent);\n}\n", "tag": "", "tokens": 1446, "metadata": {}}], "modify_time": 1733144568.7409012}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/setupTests.ts", "relative_path": "cline/webview-ui/src/setupTests.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/setupTests.ts", "source_code": "// jest-dom adds custom jest matchers for asserting on DOM nodes.\n// allows you to do things like:\n// expect(element).toHaveTextContent(/react/i)\n// learn more: https://github.com/testing-library/jest-dom\nimport \"@testing-library/jest-dom\"\n", "tag": "", "tokens": 78, "metadata": {}}], "modify_time": 1733144568.74138}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/reportWebVitals.ts", "relative_path": "cline/webview-ui/src/reportWebVitals.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/reportWebVitals.ts", "source_code": "import { ReportHandler } from \"web-vitals\"\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\n\tif (onPerfEntry && onPerfEntry instanceof Function) {\n\t\timport(\"web-vitals\").then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n\t\t\tgetCLS(onPerfEntry)\n\t\t\tgetFID(onPerfEntry)\n\t\t\tgetFCP(onPerfEntry)\n\t\t\tgetLCP(onPerfEntry)\n\t\t\tgetTTFB(onPerfEntry)\n\t\t})\n\t}\n}\n\nexport default reportWebVitals\n", "tag": "", "tokens": 153, "metadata": {}}], "modify_time": 1733144568.7412436}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/react-app-env.d.ts", "relative_path": "cline/webview-ui/src/react-app-env.d.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/react-app-env.d.ts", "source_code": "/// <reference types=\"react-scripts\" />\n", "tag": "", "tokens": 19, "metadata": {}}], "modify_time": 1733144568.7411158}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/context/ExtensionStateContext.tsx", "relative_path": "cline/webview-ui/src/context/ExtensionStateContext.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/context/ExtensionStateContext.tsx", "source_code": "import React, { createContext, useCallback, useContext, useEffect, useState } from \"react\"\nimport { useEvent } from \"react-use\"\nimport { ExtensionMessage, ExtensionState } from \"../../../src/shared/ExtensionMessage\"\nimport {\n\tApiConfiguration,\n\tModelInfo,\n\topenRouterDefaultModelId,\n\topenRouterDefaultModelInfo,\n} from \"../../../src/shared/api\"\nimport { vscode } from \"../utils/vscode\"\nimport { convertTextMateToHljs } from \"../utils/textMateToHljs\"\nimport { findLastIndex } from \"../../../src/shared/array\"\n\ninterface ExtensionStateContextType extends ExtensionState {\n\tdidHydrateState: boolean\n\tshowWelcome: boolean\n\ttheme: any\n\topenRouterModels: Record<string, ModelInfo>\n\tfilePaths: string[]\n\tsetApiConfiguration: (config: ApiConfiguration) => void\n\tsetCustomInstructions: (value?: string) => void\n\tsetAlwaysAllowReadOnly: (value: boolean) => void\n\tsetShowAnnouncement: (value: boolean) => void\n}\n\nconst ExtensionStateContext = createContext<ExtensionStateContextType | undefined>(undefined)\n\nexport const ExtensionStateContextProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\n\tconst [state, setState] = useState<ExtensionState>({\n\t\tversion: \"\",\n\t\tclineMessages: [],\n\t\ttaskHistory: [],\n\t\tshouldShowAnnouncement: false,\n\t})\n\tconst [didHydrateState, setDidHydrateState] = useState(false)\n\tconst [showWelcome, setShowWelcome] = useState(false)\n\tconst [theme, setTheme] = useState<any>(undefined)\n\tconst [filePaths, setFilePaths] = useState<string[]>([])\n\tconst [openRouterModels, setOpenRouterModels] = useState<Record<string, ModelInfo>>({\n\t\t[openRouterDefaultModelId]: openRouterDefaultModelInfo,\n\t})\n\n\tconst handleMessage = useCallback((event: MessageEvent) => {\n\t\tconst message: ExtensionMessage = event.data\n\t\tswitch (message.type) {\n\t\t\tcase \"state\": {\n\t\t\t\tsetState(message.state!)\n\t\t\t\tconst config = message.state?.apiConfiguration\n\t\t\t\tconst hasKey = config\n\t\t\t\t\t? [\n\t\t\t\t\t\t\tconfig.apiKey,\n\t\t\t\t\t\t\tconfig.openRouterApiKey,\n\t\t\t\t\t\t\tconfig.awsRegion,\n\t\t\t\t\t\t\tconfig.vertexProjectId,\n\t\t\t\t\t\t\tconfig.openAiApiKey,\n\t\t\t\t\t\t\tconfig.ollamaModelId,\n\t\t\t\t\t\t\tconfig.lmStudioModelId,\n\t\t\t\t\t\t\tconfig.geminiApiKey,\n\t\t\t\t\t\t\tconfig.openAiNativeApiKey,\n\t\t\t\t\t\t].some((key) => key !== undefined)\n\t\t\t\t\t: false\n\t\t\t\tsetShowWelcome(!hasKey)\n\t\t\t\tsetDidHydrateState(true)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase \"theme\": {\n\t\t\t\tif (message.text) {\n\t\t\t\t\tsetTheme(convertTextMateToHljs(JSON.parse(message.text)))\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase \"workspaceUpdated\": {\n\t\t\t\tsetFilePaths(message.filePaths ?? [])\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase \"partialMessage\": {\n\t\t\t\tconst partialMessage = message.partialMessage!\n\t\t\t\tsetState((prevState) => {\n\t\t\t\t\t// worth noting it will never be possible for a more up-to-date message to be sent here or in normal messages post since the presentAssistantContent function uses lock\n\t\t\t\t\tconst lastIndex = findLastIndex(prevState.clineMessages, (msg) => msg.ts === partialMessage.ts)\n\t\t\t\t\tif (lastIndex !== -1) {\n\t\t\t\t\t\tconst newClineMessages = [...prevState.clineMessages]\n\t\t\t\t\t\tnewClineMessages[lastIndex] = partialMessage\n\t\t\t\t\t\treturn { ...prevState, clineMessages: newClineMessages }\n\t\t\t\t\t}\n\t\t\t\t\treturn prevState\n\t\t\t\t})\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase \"openRouterModels\": {\n\t\t\t\tconst updatedModels = message.openRouterModels ?? {}\n\t\t\t\tsetOpenRouterModels({\n\t\t\t\t\t[openRouterDefaultModelId]: openRouterDefaultModelInfo, // in case the extension sent a model list without the default model\n\t\t\t\t\t...updatedModels,\n\t\t\t\t})\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}, [])\n\n\tuseEvent(\"message\", handleMessage)\n\n\tuseEffect(() => {\n\t\tvscode.postMessage({ type: \"webviewDidLaunch\" })\n\t}, [])\n\n\tconst contextValue: ExtensionStateContextType = {\n\t\t...state,\n\t\tdidHydrateState,\n\t\tshowWelcome,\n\t\ttheme,\n\t\topenRouterModels,\n\t\tfilePaths,\n\t\tsetApiConfiguration: (value) => setState((prevState) => ({ ...prevState, apiConfiguration: value })),\n\t\tsetCustomInstructions: (value) => setState((prevState) => ({ ...prevState, customInstructions: value })),\n\t\tsetAlwaysAllowReadOnly: (value) => setState((prevState) => ({ ...prevState, alwaysAllowReadOnly: value })),\n\t\tsetShowAnnouncement: (value) => setState((prevState) => ({ ...prevState, shouldShowAnnouncement: value })),\n\t}\n\n\treturn <ExtensionStateContext.Provider value={contextValue}>{children}</ExtensionStateContext.Provider>\n}\n\nexport const useExtensionState = () => {\n\tconst context = useContext(ExtensionStateContext)\n\tif (context === undefined) {\n\t\tthrow new Error(\"useExtensionState must be used within an ExtensionStateContextProvider\")\n\t}\n\treturn context\n}\n", "tag": "", "tokens": 1253, "metadata": {}}], "modify_time": 1733144568.7406461}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/getLanguageFromPath.ts", "relative_path": "cline/webview-ui/src/utils/getLanguageFromPath.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/getLanguageFromPath.ts", "source_code": "const extensionToLanguage: { [key: string]: string } = {\n\t// Web technologies\n\thtml: \"html\",\n\thtm: \"html\",\n\tcss: \"css\",\n\tjs: \"javascript\",\n\tjsx: \"jsx\",\n\tts: \"typescript\",\n\ttsx: \"tsx\",\n\n\t// Backend languages\n\tpy: \"python\",\n\trb: \"ruby\",\n\tphp: \"php\",\n\tjava: \"java\",\n\tcs: \"csharp\",\n\tgo: \"go\",\n\trs: \"rust\",\n\tscala: \"scala\",\n\tkt: \"kotlin\",\n\tswift: \"swift\",\n\n\t// Markup and data\n\tjson: \"json\",\n\txml: \"xml\",\n\tyaml: \"yaml\",\n\tyml: \"yaml\",\n\tmd: \"markdown\",\n\tcsv: \"csv\",\n\n\t// Shell and scripting\n\tsh: \"bash\",\n\tbash: \"bash\",\n\tzsh: \"bash\",\n\tps1: \"powershell\",\n\n\t// Configuration\n\ttoml: \"toml\",\n\tini: \"ini\",\n\tcfg: \"ini\",\n\tconf: \"ini\",\n\n\t// Other\n\tsql: \"sql\",\n\tgraphql: \"graphql\",\n\tgql: \"graphql\",\n\ttex: \"latex\",\n\tsvg: \"svg\",\n\ttxt: \"text\",\n\n\t// C-family languages\n\tc: \"c\",\n\tcpp: \"cpp\",\n\th: \"c\",\n\thpp: \"cpp\",\n\n\t// Functional languages\n\ths: \"haskell\",\n\tlhs: \"haskell\",\n\telm: \"elm\",\n\tclj: \"clojure\",\n\tcljs: \"clojure\",\n\terl: \"erlang\",\n\tex: \"elixir\",\n\texs: \"elixir\",\n\n\t// Mobile development\n\tdart: \"dart\",\n\tm: \"objectivec\",\n\tmm: \"objectivec\",\n\n\t// Game development\n\tlua: \"lua\",\n\tgd: \"gdscript\", // Godot\n\tunity: \"csharp\", // Unity (using C#)\n\n\t// Data science and ML\n\tr: \"r\",\n\tjl: \"julia\",\n\tipynb: \"jupyter\", // Jupyter notebooks\n}\n\n// Example usage:\n// console.log(getLanguageFromPath('/path/to/file.js')); // Output: javascript\n\nexport function getLanguageFromPath(path: string): string | undefined {\n\tconst extension = path.split(\".\").pop()?.toLowerCase() || \"\"\n\treturn extensionToLanguage[extension]\n}\n", "tag": "", "tokens": 608, "metadata": {}}], "modify_time": 1733144568.7418265}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/validate.ts", "relative_path": "cline/webview-ui/src/utils/validate.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/validate.ts", "source_code": "import { ApiConfiguration, openRouterDefaultModelId } from \"../../../src/shared/api\"\nimport { ModelInfo } from \"../../../src/shared/api\"\nexport function validateApiConfiguration(apiConfiguration?: ApiConfiguration): string | undefined {\n\tif (apiConfiguration) {\n\t\tswitch (apiConfiguration.apiProvider) {\n\t\t\tcase \"anthropic\":\n\t\t\t\tif (!apiConfiguration.apiKey) {\n\t\t\t\t\treturn \"You must provide a valid API key or choose a different provider.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"bedrock\":\n\t\t\t\tif (!apiConfiguration.awsRegion) {\n\t\t\t\t\treturn \"You must choose a region to use with AWS Bedrock.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"openrouter\":\n\t\t\t\tif (!apiConfiguration.openRouterApiKey) {\n\t\t\t\t\treturn \"You must provide a valid API key or choose a different provider.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"vertex\":\n\t\t\t\tif (!apiConfiguration.vertexProjectId || !apiConfiguration.vertexRegion) {\n\t\t\t\t\treturn \"You must provide a valid Google Cloud Project ID and Region.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"gemini\":\n\t\t\t\tif (!apiConfiguration.geminiApiKey) {\n\t\t\t\t\treturn \"You must provide a valid API key or choose a different provider.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"openai-native\":\n\t\t\t\tif (!apiConfiguration.openAiNativeApiKey) {\n\t\t\t\t\treturn \"You must provide a valid API key or choose a different provider.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"openai\":\n\t\t\t\tif (\n\t\t\t\t\t!apiConfiguration.openAiBaseUrl ||\n\t\t\t\t\t!apiConfiguration.openAiApiKey ||\n\t\t\t\t\t!apiConfiguration.openAiModelId\n\t\t\t\t) {\n\t\t\t\t\treturn \"You must provide a valid base URL, API key, and model ID.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"ollama\":\n\t\t\t\tif (!apiConfiguration.ollamaModelId) {\n\t\t\t\t\treturn \"You must provide a valid model ID.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"lmstudio\":\n\t\t\t\tif (!apiConfiguration.lmStudioModelId) {\n\t\t\t\t\treturn \"You must provide a valid model ID.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t}\n\t}\n\treturn undefined\n}\n\nexport function validateModelId(\n\tapiConfiguration?: ApiConfiguration,\n\topenRouterModels?: Record<string, ModelInfo>,\n): string | undefined {\n\tif (apiConfiguration) {\n\t\tswitch (apiConfiguration.apiProvider) {\n\t\t\tcase \"openrouter\":\n\t\t\t\tconst modelId = apiConfiguration.openRouterModelId || openRouterDefaultModelId // in case the user hasn't changed the model id, it will be undefined by default\n\t\t\t\tif (!modelId) {\n\t\t\t\t\treturn \"You must provide a model ID.\"\n\t\t\t\t}\n\t\t\t\tif (openRouterModels && !Object.keys(openRouterModels).includes(modelId)) {\n\t\t\t\t\t// even if the model list endpoint failed, extensionstatecontext will always have the default model info\n\t\t\t\t\treturn \"The model ID you provided is not available. Please choose a different model.\"\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t}\n\t}\n\treturn undefined\n}\n", "tag": "", "tokens": 699, "metadata": {}}], "modify_time": 1733144568.742053}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/vscode.ts", "relative_path": "cline/webview-ui/src/utils/vscode.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/vscode.ts", "source_code": "import { WebviewMessage } from \"../../../src/shared/WebviewMessage\"\nimport type { WebviewApi } from \"vscode-webview\"\n\n/**\n * A utility wrapper around the acquireVsCodeApi() function, which enables\n * message passing and state management between the webview and extension\n * contexts.\n *\n * This utility also enables webview code to be run in a web browser-based\n * dev server by using native web browser features that mock the functionality\n * enabled by acquireVsCodeApi.\n */\nclass VSCodeAPIWrapper {\n\tprivate readonly vsCodeApi: WebviewApi<unknown> | undefined\n\n\tconstructor() {\n\t\t// Check if the acquireVsCodeApi function exists in the current development\n\t\t// context (i.e. VS Code development window or web browser)\n\t\tif (typeof acquireVsCodeApi === \"function\") {\n\t\t\tthis.vsCodeApi = acquireVsCodeApi()\n\t\t}\n\t}\n\n\t/**\n\t * Post a message (i.e. send arbitrary data) to the owner of the webview.\n\t *\n\t * @remarks When running webview code inside a web browser, postMessage will instead\n\t * log the given message to the console.\n\t *\n\t * @param message Abitrary data (must be JSON serializable) to send to the extension context.\n\t */\n\tpublic postMessage(message: WebviewMessage) {\n\t\tif (this.vsCodeApi) {\n\t\t\tthis.vsCodeApi.postMessage(message)\n\t\t} else {\n\t\t\tconsole.log(message)\n\t\t}\n\t}\n\n\t/**\n\t * Get the persistent state stored for this webview.\n\t *\n\t * @remarks When running webview source code inside a web browser, getState will retrieve state\n\t * from local storage (https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage).\n\t *\n\t * @return The current state or `undefined` if no state has been set.\n\t */\n\tpublic getState(): unknown | undefined {\n\t\tif (this.vsCodeApi) {\n\t\t\treturn this.vsCodeApi.getState()\n\t\t} else {\n\t\t\tconst state = localStorage.getItem(\"vscodeState\")\n\t\t\treturn state ? JSON.parse(state) : undefined\n\t\t}\n\t}\n\n\t/**\n\t * Set the persistent state stored for this webview.\n\t *\n\t * @remarks When running webview source code inside a web browser, setState will set the given\n\t * state using local storage (https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage).\n\t *\n\t * @param newState New persisted state. This must be a JSON serializable object. Can be retrieved\n\t * using {@link getState}.\n\t *\n\t * @return The new state.\n\t */\n\tpublic setState<T extends unknown | undefined>(newState: T): T {\n\t\tif (this.vsCodeApi) {\n\t\t\treturn this.vsCodeApi.setState(newState)\n\t\t} else {\n\t\t\tlocalStorage.setItem(\"vscodeState\", JSON.stringify(newState))\n\t\t\treturn newState\n\t\t}\n\t}\n}\n\n// Exports class singleton to prevent multiple invocations of acquireVsCodeApi.\nexport const vscode = new VSCodeAPIWrapper()\n", "tag": "", "tokens": 749, "metadata": {}}], "modify_time": 1733144568.742158}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/format.ts", "relative_path": "cline/webview-ui/src/utils/format.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/format.ts", "source_code": "export function formatLargeNumber(num: number): string {\n\tif (num >= 1e9) {\n\t\treturn (num / 1e9).toFixed(1) + \"b\"\n\t}\n\tif (num >= 1e6) {\n\t\treturn (num / 1e6).toFixed(1) + \"m\"\n\t}\n\tif (num >= 1e3) {\n\t\treturn (num / 1e3).toFixed(1) + \"k\"\n\t}\n\treturn num.toString()\n}\n", "tag": "", "tokens": 125, "metadata": {}}], "modify_time": 1733144568.7417247}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/textMateToHljs.ts", "relative_path": "cline/webview-ui/src/utils/textMateToHljs.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/textMateToHljs.ts", "source_code": "const hljsToTextMate: Record<string, string[]> = {\n\t\".hljs-comment\": [\"comment\"],\n\t\".hljs-tag\": [\"tag\"],\n\t\".hljs-doctag\": [\"keyword\"],\n\t\".hljs-keyword\": [\"keyword\"],\n\t\".hljs-meta .hljs-keyword\": [\"keyword\"],\n\t\".hljs-template-tag\": [\"keyword\"],\n\t\".hljs-template-variable\": [\"keyword\"],\n\t\".hljs-type\": [\"keyword\"],\n\t\".hljs-variable.language_\": [\"keyword\"],\n\t\".hljs-title\": [\"title\", \"function\", \"class\"],\n\t\".hljs-title.class_\": [\"title\", \"function\", \"class\", \"variable\"],\n\t\".hljs-title.class_.inherited__\": [\"title\", \"function\", \"class\", \"variable\"],\n\t\".hljs-title.function_\": [\"support.function\", \"entity.name.function\", \"title\", \"function\", \"class\"],\n\t\".hljs-built_in\": [\"support.function\", \"entity.name.function\", \"title\", \"function\", \"class\"],\n\t\".hljs-name\": [\"constant\"],\n\t\".hljs-attr\": [\"variable\", \"operator\", \"number\"],\n\t\".hljs-attribute\": [\"attribute\", \"variable\", \"operator\", \"number\"],\n\t\".hljs-literal\": [\"variable\", \"operator\", \"number\"],\n\t\".hljs-meta\": [\"variable\", \"operator\", \"number\"],\n\t\".hljs-number\": [\"constant.numeric\", \"number\", \"variable\", \"operator\"],\n\t\".hljs-operator\": [\"variable\", \"operator\", \"number\"],\n\t\".hljs-variable\": [\"variable\", \"operator\", \"number\"],\n\t\".hljs-selector-attr\": [\"variable\", \"operator\", \"number\"],\n\t\".hljs-selector-class\": [\"variable\", \"operator\", \"number\"],\n\t\".hljs-selector-id\": [\"variable\", \"operator\", \"number\"],\n\t\".hljs-regexp\": [\"string\"],\n\t\".hljs-string\": [\"string\"],\n\t\".hljs-meta .hljs-string\": [\"string\"],\n\t\".hljs-params\": [\"variable\", \"operator\", \"number\"],\n}\n\ntype FullColorTheme = {\n\trules?: {\n\t\ttoken?: string\n\t\tforeground?: string\n\t}[]\n}\n\nfunction constructTheme(tmTheme: FullColorTheme): Record<string, string> {\n\tconst rules = tmTheme[\"rules\"] || []\n\n\tconst tokenToForeground: Record<string, string> = {}\n\trules.forEach(({ token, foreground }) => {\n\t\tif (!foreground || !token) {\n\t\t\treturn\n\t\t}\n\t\ttokenToForeground[token] = foreground\n\t})\n\n\tconst theme: Record<string, string> = {}\n\tObject.keys(hljsToTextMate).forEach((className) => {\n\t\tconst tokens = hljsToTextMate[className]\n\t\tfor (const scope of tokens) {\n\t\t\tif (tokenToForeground[scope]) {\n\t\t\t\ttheme[className] = tokenToForeground[scope]\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t})\n\n\tif (Object.keys(theme).length === 0) {\n\t\treturn fallbackTheme()\n\t}\n\n\treturn theme\n}\n\nfunction fallbackTheme() {\n\tconst styles = getComputedStyle(document.body)\n\tconst backgroundColor = styles.getPropertyValue(\"--vscode-editor-background\")\n\tconst { r, g, b } = parseHexColor(backgroundColor)\n\tconst avg = (r + g + b) / 3\n\n\treturn avg >= 128\n\t\t? {\n\t\t\t\t\".hljs-comment\": \"#008000\",\n\t\t\t\t\".hljs-doctag\": \"#0000ff\",\n\t\t\t\t\".hljs-keyword\": \"#0000ff\",\n\t\t\t\t\".hljs-meta .hljs-keyword\": \"#0000ff\",\n\t\t\t\t\".hljs-template-tag\": \"#0000ff\",\n\t\t\t\t\".hljs-template-variable\": \"#0000ff\",\n\t\t\t\t\".hljs-type\": \"#0000ff\",\n\t\t\t\t\".hljs-variable.language_\": \"#0000ff\",\n\t\t\t\t\".hljs-title.class_\": \"#001080\",\n\t\t\t\t\".hljs-title.class_.inherited__\": \"#001080\",\n\t\t\t\t\".hljs-title.function_\": \"#795E26\",\n\t\t\t\t\".hljs-built_in\": \"#795E26\",\n\t\t\t\t\".hljs-attr\": \"#001080\",\n\t\t\t\t\".hljs-attribute\": \"#001080\",\n\t\t\t\t\".hljs-literal\": \"#001080\",\n\t\t\t\t\".hljs-meta\": \"#001080\",\n\t\t\t\t\".hljs-number\": \"#098658\",\n\t\t\t\t\".hljs-operator\": \"#001080\",\n\t\t\t\t\".hljs-variable\": \"#001080\",\n\t\t\t\t\".hljs-selector-attr\": \"#001080\",\n\t\t\t\t\".hljs-selector-class\": \"#001080\",\n\t\t\t\t\".hljs-selector-id\": \"#001080\",\n\t\t\t\t\".hljs-regexp\": \"#a31515\",\n\t\t\t\t\".hljs-string\": \"#a31515\",\n\t\t\t\t\".hljs-meta .hljs-string\": \"#a31515\",\n\t\t\t\t\".hljs-params\": \"#001080\",\n\t\t\t}\n\t\t: {\n\t\t\t\t\".hljs-comment\": \"#6A9955\",\n\t\t\t\t\".hljs-doctag\": \"#569cd6\",\n\t\t\t\t\".hljs-keyword\": \"#569cd6\",\n\t\t\t\t\".hljs-meta .hljs-keyword\": \"#569cd6\",\n\t\t\t\t\".hljs-template-tag\": \"#569cd6\",\n\t\t\t\t\".hljs-template-variable\": \"#569cd6\",\n\t\t\t\t\".hljs-type\": \"#569cd6\",\n\t\t\t\t\".hljs-variable.language_\": \"#569cd6\",\n\t\t\t\t\".hljs-title.class_\": \"#9CDCFE\",\n\t\t\t\t\".hljs-title.class_.inherited__\": \"#9CDCFE\",\n\t\t\t\t\".hljs-title.function_\": \"#DCDCAA\",\n\t\t\t\t\".hljs-built_in\": \"#DCDCAA\",\n\t\t\t\t\".hljs-attr\": \"#9CDCFE\",\n\t\t\t\t\".hljs-attribute\": \"#9CDCFE\",\n\t\t\t\t\".hljs-literal\": \"#9CDCFE\",\n\t\t\t\t\".hljs-meta\": \"#9CDCFE\",\n\t\t\t\t\".hljs-number\": \"#b5cea8\",\n\t\t\t\t\".hljs-operator\": \"#9CDCFE\",\n\t\t\t\t\".hljs-variable\": \"#9CDCFE\",\n\t\t\t\t\".hljs-selector-attr\": \"#9CDCFE\",\n\t\t\t\t\".hljs-selector-class\": \"#9CDCFE\",\n\t\t\t\t\".hljs-selector-id\": \"#9CDCFE\",\n\t\t\t\t\".hljs-regexp\": \"#ce9178\",\n\t\t\t\t\".hljs-string\": \"#ce9178\",\n\t\t\t\t\".hljs-meta .hljs-string\": \"#ce9178\",\n\t\t\t\t\".hljs-params\": \"#9CDCFE\",\n\t\t\t}\n}\n\nexport function convertTextMateToHljs(fullColorTheme: any) {\n\treturn constructTheme(fullColorTheme || {})\n}\n\nfunction parseHexColor(hexColor: string): {\n\tr: number\n\tg: number\n\tb: number\n} {\n\tif (hexColor.startsWith(\"#\")) {\n\t\thexColor = hexColor.slice(1)\n\t}\n\n\tif (hexColor.length > 6) {\n\t\thexColor = hexColor.slice(0, 6)\n\t}\n\n\tconst r = parseInt(hexColor.substring(0, 2), 16)\n\tconst g = parseInt(hexColor.substring(2, 4), 16)\n\tconst b = parseInt(hexColor.substring(4, 6), 16)\n\n\treturn { r, g, b }\n}\n", "tag": "", "tokens": 1842, "metadata": {}}], "modify_time": 1733144568.7419376}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/context-mentions.ts", "relative_path": "cline/webview-ui/src/utils/context-mentions.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/utils/context-mentions.ts", "source_code": "import { mentionRegex } from \"../../../src/shared/context-mentions\"\n\nexport function insertMention(\n\ttext: string,\n\tposition: number,\n\tvalue: string,\n): { newValue: string; mentionIndex: number } {\n\tconst beforeCursor = text.slice(0, position)\n\tconst afterCursor = text.slice(position)\n\n\t// Find the position of the last '@' symbol before the cursor\n\tconst lastAtIndex = beforeCursor.lastIndexOf(\"@\")\n\n\tlet newValue: string\n\tlet mentionIndex: number\n\n\tif (lastAtIndex !== -1) {\n\t\t// If there's an '@' symbol, replace everything after it with the new mention\n\t\tconst beforeMention = text.slice(0, lastAtIndex)\n\t\tnewValue = beforeMention + \"@\" + value + \" \" + afterCursor.replace(/^[^\\s]*/, \"\")\n\t\tmentionIndex = lastAtIndex\n\t} else {\n\t\t// If there's no '@' symbol, insert the mention at the cursor position\n\t\tnewValue = beforeCursor + \"@\" + value + \" \" + afterCursor\n\t\tmentionIndex = position\n\t}\n\n\treturn { newValue, mentionIndex }\n}\n\nexport function removeMention(text: string, position: number): { newText: string; newPosition: number } {\n\tconst beforeCursor = text.slice(0, position)\n\tconst afterCursor = text.slice(position)\n\n\t// Check if we're at the end of a mention\n\tconst matchEnd = beforeCursor.match(new RegExp(mentionRegex.source + \"$\"))\n\n\tif (matchEnd) {\n\t\t// If we're at the end of a mention, remove it\n\t\tconst newText = text.slice(0, position - matchEnd[0].length) + afterCursor.replace(\" \", \"\") // removes the first space after the mention\n\t\tconst newPosition = position - matchEnd[0].length\n\t\treturn { newText, newPosition }\n\t}\n\n\t// If we're not at the end of a mention, just return the original text and position\n\treturn { newText: text, newPosition: position }\n}\n\nexport enum ContextMenuOptionType {\n\tFile = \"file\",\n\tFolder = \"folder\",\n\tProblems = \"problems\",\n\tURL = \"url\",\n\tNoResults = \"noResults\",\n}\n\nexport interface ContextMenuQueryItem {\n\ttype: ContextMenuOptionType\n\tvalue?: string\n}\n\nexport function getContextMenuOptions(\n\tquery: string,\n\tselectedType: ContextMenuOptionType | null = null,\n\tqueryItems: ContextMenuQueryItem[],\n): ContextMenuQueryItem[] {\n\tif (query === \"\") {\n\t\tif (selectedType === ContextMenuOptionType.File) {\n\t\t\tconst files = queryItems\n\t\t\t\t.filter((item) => item.type === ContextMenuOptionType.File)\n\t\t\t\t.map((item) => ({ type: ContextMenuOptionType.File, value: item.value }))\n\t\t\treturn files.length > 0 ? files : [{ type: ContextMenuOptionType.NoResults }]\n\t\t}\n\n\t\tif (selectedType === ContextMenuOptionType.Folder) {\n\t\t\tconst folders = queryItems\n\t\t\t\t.filter((item) => item.type === ContextMenuOptionType.Folder)\n\t\t\t\t.map((item) => ({ type: ContextMenuOptionType.Folder, value: item.value }))\n\t\t\treturn folders.length > 0 ? folders : [{ type: ContextMenuOptionType.NoResults }]\n\t\t}\n\n\t\treturn [\n\t\t\t{ type: ContextMenuOptionType.URL },\n\t\t\t{ type: ContextMenuOptionType.Problems },\n\t\t\t{ type: ContextMenuOptionType.Folder },\n\t\t\t{ type: ContextMenuOptionType.File },\n\t\t]\n\t}\n\n\tconst lowerQuery = query.toLowerCase()\n\n\tif (query.startsWith(\"http\")) {\n\t\treturn [{ type: ContextMenuOptionType.URL, value: query }]\n\t} else {\n\t\tconst matchingItems = queryItems.filter((item) => item.value?.toLowerCase().includes(lowerQuery))\n\n\t\tif (matchingItems.length > 0) {\n\t\t\treturn matchingItems.map((item) => ({\n\t\t\t\ttype: item.type,\n\t\t\t\tvalue: item.value,\n\t\t\t}))\n\t\t} else {\n\t\t\treturn [{ type: ContextMenuOptionType.NoResults }]\n\t\t}\n\t}\n}\n\nexport function shouldShowContextMenu(text: string, position: number): boolean {\n\tconst beforeCursor = text.slice(0, position)\n\tconst atIndex = beforeCursor.lastIndexOf(\"@\")\n\n\tif (atIndex === -1) return false\n\n\tconst textAfterAt = beforeCursor.slice(atIndex + 1)\n\n\t// Check if there's any whitespace after the '@'\n\tif (/\\s/.test(textAfterAt)) return false\n\n\t// Don't show the menu if it's a URL\n\tif (textAfterAt.toLowerCase().startsWith(\"http\")) return false\n\n\t// Don't show the menu if it's a problems\n\tif (textAfterAt.toLowerCase().startsWith(\"problems\")) return false\n\n\t// NOTE: it's okay that menu shows when there's trailing punctuation since user could be inputting a path with marks\n\n\t// Show the menu if there's just '@' or '@' followed by some text (but not a URL)\n\treturn true\n}\n", "tag": "", "tokens": 1206, "metadata": {}}], "modify_time": 1733144568.7415886}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/settings/OpenRouterModelPicker.tsx", "relative_path": "cline/webview-ui/src/components/settings/OpenRouterModelPicker.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/settings/OpenRouterModelPicker.tsx", "source_code": "import { VSCodeLink, VSCodeTextField } from \"@vscode/webview-ui-toolkit/react\"\nimport Fuse from \"fuse.js\"\nimport React, { KeyboardEvent, memo, useEffect, useMemo, useRef, useState } from \"react\"\nimport { useRemark } from \"react-remark\"\nimport { useMount } from \"react-use\"\nimport styled from \"styled-components\"\nimport { openRouterDefaultModelId } from \"../../../../src/shared/api\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport { vscode } from \"../../utils/vscode\"\nimport { highlight } from \"../history/HistoryView\"\nimport { ModelInfoView, normalizeApiConfiguration } from \"./ApiOptions\"\n\nconst OpenRouterModelPicker: React.FC = () => {\n\tconst { apiConfiguration, setApiConfiguration, openRouterModels } = useExtensionState()\n\tconst [searchTerm, setSearchTerm] = useState(apiConfiguration?.openRouterModelId || openRouterDefaultModelId)\n\tconst [isDropdownVisible, setIsDropdownVisible] = useState(false)\n\tconst [selectedIndex, setSelectedIndex] = useState(-1)\n\tconst dropdownRef = useRef<HTMLDivElement>(null)\n\tconst itemRefs = useRef<(HTMLDivElement | null)[]>([])\n\tconst [isDescriptionExpanded, setIsDescriptionExpanded] = useState(false)\n\tconst dropdownListRef = useRef<HTMLDivElement>(null)\n\n\tconst handleModelChange = (newModelId: string) => {\n\t\t// could be setting invalid model id/undefined info but validation will catch it\n\t\tsetApiConfiguration({\n\t\t\t...apiConfiguration,\n\t\t\topenRouterModelId: newModelId,\n\t\t\topenRouterModelInfo: openRouterModels[newModelId],\n\t\t})\n\t\tsetSearchTerm(newModelId)\n\t}\n\n\tconst { selectedModelId, selectedModelInfo } = useMemo(() => {\n\t\treturn normalizeApiConfiguration(apiConfiguration)\n\t}, [apiConfiguration])\n\n\tuseMount(() => {\n\t\tvscode.postMessage({ type: \"refreshOpenRouterModels\" })\n\t})\n\n\tuseEffect(() => {\n\t\tconst handleClickOutside = (event: MouseEvent) => {\n\t\t\tif (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\n\t\t\t\tsetIsDropdownVisible(false)\n\t\t\t}\n\t\t}\n\n\t\tdocument.addEventListener(\"mousedown\", handleClickOutside)\n\t\treturn () => {\n\t\t\tdocument.removeEventListener(\"mousedown\", handleClickOutside)\n\t\t}\n\t}, [])\n\n\tconst modelIds = useMemo(() => {\n\t\treturn Object.keys(openRouterModels).sort((a, b) => a.localeCompare(b))\n\t}, [openRouterModels])\n\n\tconst searchableItems = useMemo(() => {\n\t\treturn modelIds.map((id) => ({\n\t\t\tid,\n\t\t\thtml: id,\n\t\t}))\n\t}, [modelIds])\n\n\tconst fuse = useMemo(() => {\n\t\treturn new Fuse(searchableItems, {\n\t\t\tkeys: [\"html\"], // highlight function will update this\n\t\t\tthreshold: 0.6,\n\t\t\tshouldSort: true,\n\t\t\tisCaseSensitive: false,\n\t\t\tignoreLocation: false,\n\t\t\tincludeMatches: true,\n\t\t\tminMatchCharLength: 1,\n\t\t})\n\t}, [searchableItems])\n\n\tconst modelSearchResults = useMemo(() => {\n\t\tlet results: { id: string; html: string }[] = searchTerm\n\t\t\t? highlight(fuse.search(searchTerm), \"model-item-highlight\")\n\t\t\t: searchableItems\n\t\t// results.sort((a, b) => a.id.localeCompare(b.id)) NOTE: sorting like this causes ids in objects to be reordered and mismatched\n\t\treturn results\n\t}, [searchableItems, searchTerm, fuse])\n\n\tconst handleKeyDown = (event: KeyboardEvent<HTMLInputElement>) => {\n\t\tif (!isDropdownVisible) return\n\n\t\tswitch (event.key) {\n\t\t\tcase \"ArrowDown\":\n\t\t\t\tevent.preventDefault()\n\t\t\t\tsetSelectedIndex((prev) => (prev < modelSearchResults.length - 1 ? prev + 1 : prev))\n\t\t\t\tbreak\n\t\t\tcase \"ArrowUp\":\n\t\t\t\tevent.preventDefault()\n\t\t\t\tsetSelectedIndex((prev) => (prev > 0 ? prev - 1 : prev))\n\t\t\t\tbreak\n\t\t\tcase \"Enter\":\n\t\t\t\tevent.preventDefault()\n\t\t\t\tif (selectedIndex >= 0 && selectedIndex < modelSearchResults.length) {\n\t\t\t\t\thandleModelChange(modelSearchResults[selectedIndex].id)\n\t\t\t\t\tsetIsDropdownVisible(false)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase \"Escape\":\n\t\t\t\tsetIsDropdownVisible(false)\n\t\t\t\tsetSelectedIndex(-1)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\tconst hasInfo = useMemo(() => {\n\t\treturn modelIds.some((id) => id.toLowerCase() === searchTerm.toLowerCase())\n\t}, [modelIds, searchTerm])\n\n\tuseEffect(() => {\n\t\tsetSelectedIndex(-1)\n\t\tif (dropdownListRef.current) {\n\t\t\tdropdownListRef.current.scrollTop = 0\n\t\t}\n\t}, [searchTerm])\n\n\tuseEffect(() => {\n\t\tif (selectedIndex >= 0 && itemRefs.current[selectedIndex]) {\n\t\t\titemRefs.current[selectedIndex]?.scrollIntoView({\n\t\t\t\tblock: \"nearest\",\n\t\t\t\tbehavior: \"smooth\",\n\t\t\t})\n\t\t}\n\t}, [selectedIndex])\n\n\treturn (\n\t\t<>\n\t\t\t<style>\n\t\t\t\t{`\n\t\t\t\t.model-item-highlight {\n\t\t\t\t\tbackground-color: var(--vscode-editor-findMatchHighlightBackground);\n\t\t\t\t\tcolor: inherit;\n\t\t\t\t}\n\t\t\t\t`}\n\t\t\t</style>\n\t\t\t<div>\n\t\t\t\t<label htmlFor=\"model-search\">\n\t\t\t\t\t<span style={{ fontWeight: 500 }}>Model</span>\n\t\t\t\t</label>\n\t\t\t\t<DropdownWrapper ref={dropdownRef}>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tid=\"model-search\"\n\t\t\t\t\t\tplaceholder=\"Search and select a model...\"\n\t\t\t\t\t\tvalue={searchTerm}\n\t\t\t\t\t\tonInput={(e) => {\n\t\t\t\t\t\t\thandleModelChange((e.target as HTMLInputElement)?.value?.toLowerCase())\n\t\t\t\t\t\t\tsetIsDropdownVisible(true)\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tonFocus={() => setIsDropdownVisible(true)}\n\t\t\t\t\t\tonKeyDown={handleKeyDown}\n\t\t\t\t\t\tstyle={{ width: \"100%\", zIndex: OPENROUTER_MODEL_PICKER_Z_INDEX, position: \"relative\" }}>\n\t\t\t\t\t\t{searchTerm && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclassName=\"input-icon-button codicon codicon-close\"\n\t\t\t\t\t\t\t\taria-label=\"Clear search\"\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\thandleModelChange(\"\")\n\t\t\t\t\t\t\t\t\tsetIsDropdownVisible(true)\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tslot=\"end\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\tjustifyContent: \"center\",\n\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\theight: \"100%\",\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t{isDropdownVisible && (\n\t\t\t\t\t\t<DropdownList ref={dropdownListRef}>\n\t\t\t\t\t\t\t{modelSearchResults.map((item, index) => (\n\t\t\t\t\t\t\t\t<DropdownItem\n\t\t\t\t\t\t\t\t\tkey={item.id}\n\t\t\t\t\t\t\t\t\tref={(el) => (itemRefs.current[index] = el)}\n\t\t\t\t\t\t\t\t\tisSelected={index === selectedIndex}\n\t\t\t\t\t\t\t\t\tonMouseEnter={() => setSelectedIndex(index)}\n\t\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\t\thandleModelChange(item.id)\n\t\t\t\t\t\t\t\t\t\tsetIsDropdownVisible(false)\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t\t\t\t\t__html: item.html,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</DropdownList>\n\t\t\t\t\t)}\n\t\t\t\t</DropdownWrapper>\n\t\t\t</div>\n\n\t\t\t{hasInfo ? (\n\t\t\t\t<ModelInfoView\n\t\t\t\t\tselectedModelId={selectedModelId}\n\t\t\t\t\tmodelInfo={selectedModelInfo}\n\t\t\t\t\tisDescriptionExpanded={isDescriptionExpanded}\n\t\t\t\t\tsetIsDescriptionExpanded={setIsDescriptionExpanded}\n\t\t\t\t/>\n\t\t\t) : (\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\tmarginTop: 0,\n\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t}}>\n\t\t\t\t\tThe extension automatically fetches the latest list of models available on{\" \"}\n\t\t\t\t\t<VSCodeLink style={{ display: \"inline\", fontSize: \"inherit\" }} href=\"https://openrouter.ai/models\">\n\t\t\t\t\t\tOpenRouter.\n\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\tIf you're unsure which model to choose, Cline works best with{\" \"}\n\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\tstyle={{ display: \"inline\", fontSize: \"inherit\" }}\n\t\t\t\t\t\tonClick={() => handleModelChange(\"anthropic/claude-3.5-sonnet:beta\")}>\n\t\t\t\t\t\tanthropic/claude-3.5-sonnet:beta.\n\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\tYou can also try searching \"free\" for no-cost options currently available.\n\t\t\t\t</p>\n\t\t\t)}\n\t\t</>\n\t)\n}\n\nexport default OpenRouterModelPicker\n\n// Dropdown\n\nconst DropdownWrapper = styled.div`\n\tposition: relative;\n\twidth: 100%;\n`\n\nexport const OPENROUTER_MODEL_PICKER_Z_INDEX = 1_000\n\nconst DropdownList = styled.div`\n\tposition: absolute;\n\ttop: calc(100% - 3px);\n\tleft: 0;\n\twidth: calc(100% - 2px);\n\tmax-height: 200px;\n\toverflow-y: auto;\n\tbackground-color: var(--vscode-dropdown-background);\n\tborder: 1px solid var(--vscode-list-activeSelectionBackground);\n\tz-index: ${OPENROUTER_MODEL_PICKER_Z_INDEX - 1};\n\tborder-bottom-left-radius: 3px;\n\tborder-bottom-right-radius: 3px;\n`\n\nconst DropdownItem = styled.div<{ isSelected: boolean }>`\n\tpadding: 5px 10px;\n\tcursor: pointer;\n\tword-break: break-all;\n\twhite-space: normal;\n\n\tbackground-color: ${({ isSelected }) => (isSelected ? \"var(--vscode-list-activeSelectionBackground)\" : \"inherit\")};\n\n\t&:hover {\n\t\tbackground-color: var(--vscode-list-activeSelectionBackground);\n\t}\n`\n\n// Markdown\n\nconst StyledMarkdown = styled.div`\n\tfont-family:\n\t\tvar(--vscode-font-family),\n\t\tsystem-ui,\n\t\t-apple-system,\n\t\tBlinkMacSystemFont,\n\t\t\"Segoe UI\",\n\t\tRoboto,\n\t\tOxygen,\n\t\tUbuntu,\n\t\tCantarell,\n\t\t\"Open Sans\",\n\t\t\"Helvetica Neue\",\n\t\tsans-serif;\n\tfont-size: 12px;\n\tcolor: var(--vscode-descriptionForeground);\n\n\tp,\n\tli,\n\tol,\n\tul {\n\t\tline-height: 1.25;\n\t\tmargin: 0;\n\t}\n\n\tol,\n\tul {\n\t\tpadding-left: 1.5em;\n\t\tmargin-left: 0;\n\t}\n\n\tp {\n\t\twhite-space: pre-wrap;\n\t}\n\n\ta {\n\t\ttext-decoration: none;\n\t}\n\ta {\n\t\t&:hover {\n\t\t\ttext-decoration: underline;\n\t\t}\n\t}\n`\n\nexport const ModelDescriptionMarkdown = memo(\n\t({\n\t\tmarkdown,\n\t\tkey,\n\t\tisExpanded,\n\t\tsetIsExpanded,\n\t}: {\n\t\tmarkdown?: string\n\t\tkey: string\n\t\tisExpanded: boolean\n\t\tsetIsExpanded: (isExpanded: boolean) => void\n\t}) => {\n\t\tconst [reactContent, setMarkdown] = useRemark()\n\t\t// const [isExpanded, setIsExpanded] = useState(false)\n\t\tconst [showSeeMore, setShowSeeMore] = useState(false)\n\t\tconst textContainerRef = useRef<HTMLDivElement>(null)\n\t\tconst textRef = useRef<HTMLDivElement>(null)\n\n\t\tuseEffect(() => {\n\t\t\tsetMarkdown(markdown || \"\")\n\t\t}, [markdown, setMarkdown])\n\n\t\tuseEffect(() => {\n\t\t\tif (textRef.current && textContainerRef.current) {\n\t\t\t\tconst { scrollHeight } = textRef.current\n\t\t\t\tconst { clientHeight } = textContainerRef.current\n\t\t\t\tconst isOverflowing = scrollHeight > clientHeight\n\t\t\t\tsetShowSeeMore(isOverflowing)\n\t\t\t\t// if (!isOverflowing) {\n\t\t\t\t// \tsetIsExpanded(false)\n\t\t\t\t// }\n\t\t\t}\n\t\t}, [reactContent, setIsExpanded])\n\n\t\treturn (\n\t\t\t<StyledMarkdown key={key} style={{ display: \"inline-block\", marginBottom: 0 }}>\n\t\t\t\t<div\n\t\t\t\t\tref={textContainerRef}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\toverflowY: isExpanded ? \"auto\" : \"hidden\",\n\t\t\t\t\t\tposition: \"relative\",\n\t\t\t\t\t\twordBreak: \"break-word\",\n\t\t\t\t\t\toverflowWrap: \"anywhere\",\n\t\t\t\t\t}}>\n\t\t\t\t\t<div\n\t\t\t\t\t\tref={textRef}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: \"-webkit-box\",\n\t\t\t\t\t\t\tWebkitLineClamp: isExpanded ? \"unset\" : 3,\n\t\t\t\t\t\t\tWebkitBoxOrient: \"vertical\",\n\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t// whiteSpace: \"pre-wrap\",\n\t\t\t\t\t\t\t// wordBreak: \"break-word\",\n\t\t\t\t\t\t\t// overflowWrap: \"anywhere\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\t{reactContent}\n\t\t\t\t\t</div>\n\t\t\t\t\t{!isExpanded && showSeeMore && (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twidth: 30,\n\t\t\t\t\t\t\t\t\theight: \"1.2em\",\n\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\"linear-gradient(to right, transparent, var(--vscode-sideBar-background))\",\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t// cursor: \"pointer\",\n\t\t\t\t\t\t\t\t\t// color: \"var(--vscode-textLink-foreground)\",\n\t\t\t\t\t\t\t\t\tfontSize: \"inherit\",\n\t\t\t\t\t\t\t\t\tpaddingRight: 0,\n\t\t\t\t\t\t\t\t\tpaddingLeft: 3,\n\t\t\t\t\t\t\t\t\tbackgroundColor: \"var(--vscode-sideBar-background)\",\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonClick={() => setIsExpanded(true)}>\n\t\t\t\t\t\t\t\tSee more\n\t\t\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t\t{/* {isExpanded && showSeeMore && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\tcolor: \"var(--vscode-textLink-foreground)\",\n\t\t\t\t\t\tmarginLeft: \"auto\",\n\t\t\t\t\t\ttextAlign: \"right\",\n\t\t\t\t\t\tpaddingRight: 2,\n\t\t\t\t\t}}\n\t\t\t\t\tonClick={() => setIsExpanded(false)}>\n\t\t\t\t\tSee less\n\t\t\t\t</div>\n\t\t\t)} */}\n\t\t\t</StyledMarkdown>\n\t\t)\n\t},\n)\n", "tag": "", "tokens": 3556, "metadata": {}}], "modify_time": 1733144568.7397654}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/settings/SettingsView.tsx", "relative_path": "cline/webview-ui/src/components/settings/SettingsView.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/settings/SettingsView.tsx", "source_code": "import { VSCodeButton, VSCodeCheckbox, VSCodeLink, VSCodeTextArea } from \"@vscode/webview-ui-toolkit/react\"\nimport { memo, useEffect, useState } from \"react\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport { validateApiConfiguration, validateModelId } from \"../../utils/validate\"\nimport { vscode } from \"../../utils/vscode\"\nimport ApiOptions from \"./ApiOptions\"\n\nconst IS_DEV = false // FIXME: use flags when packaging\n\ntype SettingsViewProps = {\n\tonDone: () => void\n}\n\nconst SettingsView = ({ onDone }: SettingsViewProps) => {\n\tconst {\n\t\tapiConfiguration,\n\t\tversion,\n\t\tcustomInstructions,\n\t\tsetCustomInstructions,\n\t\talwaysAllowReadOnly,\n\t\tsetAlwaysAllowReadOnly,\n\t\topenRouterModels,\n\t} = useExtensionState()\n\tconst [apiErrorMessage, setApiErrorMessage] = useState<string | undefined>(undefined)\n\tconst [modelIdErrorMessage, setModelIdErrorMessage] = useState<string | undefined>(undefined)\n\tconst handleSubmit = () => {\n\t\tconst apiValidationResult = validateApiConfiguration(apiConfiguration)\n\t\tconst modelIdValidationResult = validateModelId(apiConfiguration, openRouterModels)\n\n\t\tsetApiErrorMessage(apiValidationResult)\n\t\tsetModelIdErrorMessage(modelIdValidationResult)\n\t\tif (!apiValidationResult && !modelIdValidationResult) {\n\t\t\tvscode.postMessage({ type: \"apiConfiguration\", apiConfiguration })\n\t\t\tvscode.postMessage({ type: \"customInstructions\", text: customInstructions })\n\t\t\tvscode.postMessage({ type: \"alwaysAllowReadOnly\", bool: alwaysAllowReadOnly })\n\t\t\tonDone()\n\t\t}\n\t}\n\n\tuseEffect(() => {\n\t\tsetApiErrorMessage(undefined)\n\t\tsetModelIdErrorMessage(undefined)\n\t}, [apiConfiguration])\n\n\t// validate as soon as the component is mounted\n\t/*\n\tuseEffect will use stale values of variables if they are not included in the dependency array. so trying to use useEffect with a dependency array of only one value for example will use any other variables' old values. In most cases you don't want this, and should opt to use react-use hooks.\n\t\n\tuseEffect(() => {\n\t\t// uses someVar and anotherVar\n\t// eslint-disable-next-line react-hooks/exhaustive-deps\n\t}, [someVar])\n\n\tIf we only want to run code once on mount we can use react-use's useEffectOnce or useMount\n\t*/\n\n\tconst handleResetState = () => {\n\t\tvscode.postMessage({ type: \"resetState\" })\n\t}\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: \"fixed\",\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tpadding: \"10px 0px 0px 20px\",\n\t\t\t\tdisplay: \"flex\",\n\t\t\t\tflexDirection: \"column\",\n\t\t\t\toverflow: \"hidden\",\n\t\t\t}}>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\tmarginBottom: \"17px\",\n\t\t\t\t\tpaddingRight: 17,\n\t\t\t\t}}>\n\t\t\t\t<h3 style={{ color: \"var(--vscode-foreground)\", margin: 0 }}>Settings</h3>\n\t\t\t\t<VSCodeButton onClick={handleSubmit}>Done</VSCodeButton>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tstyle={{ flexGrow: 1, overflowY: \"scroll\", paddingRight: 8, display: \"flex\", flexDirection: \"column\" }}>\n\t\t\t\t<div style={{ marginBottom: 5 }}>\n\t\t\t\t\t<ApiOptions\n\t\t\t\t\t\tshowModelOptions={true}\n\t\t\t\t\t\tapiErrorMessage={apiErrorMessage}\n\t\t\t\t\t\tmodelIdErrorMessage={modelIdErrorMessage}\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\n\t\t\t\t<div style={{ marginBottom: 5 }}>\n\t\t\t\t\t<VSCodeTextArea\n\t\t\t\t\t\tvalue={customInstructions ?? \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\trows={4}\n\t\t\t\t\t\tplaceholder={\n\t\t\t\t\t\t\t'e.g. \"Run unit tests at the end\", \"Use TypeScript with async/await\", \"Speak in Spanish\"'\n\t\t\t\t\t\t}\n\t\t\t\t\t\tonInput={(e: any) => setCustomInstructions(e.target?.value ?? \"\")}>\n\t\t\t\t\t\t<span style={{ fontWeight: \"500\" }}>Custom Instructions</span>\n\t\t\t\t\t</VSCodeTextArea>\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: \"5px\",\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tThese instructions are added to the end of the system prompt sent with every request.\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\n\t\t\t\t<div style={{ marginBottom: 5 }}>\n\t\t\t\t\t<VSCodeCheckbox\n\t\t\t\t\t\tchecked={alwaysAllowReadOnly}\n\t\t\t\t\t\tonChange={(e: any) => setAlwaysAllowReadOnly(e.target.checked)}>\n\t\t\t\t\t\t<span style={{ fontWeight: \"500\" }}>Always approve read-only operations</span>\n\t\t\t\t\t</VSCodeCheckbox>\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: \"5px\",\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tWhen enabled, Cline will automatically view directory contents and read files without requiring\n\t\t\t\t\t\tyou to click the Approve button.\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\n\t\t\t\t{IS_DEV && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div style={{ marginTop: \"10px\", marginBottom: \"4px\" }}>Debug</div>\n\t\t\t\t\t\t<VSCodeButton onClick={handleResetState} style={{ marginTop: \"5px\", width: \"auto\" }}>\n\t\t\t\t\t\t\tReset State\n\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t\t<p\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\t\tmarginTop: \"5px\",\n\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\tThis will reset all global state and secret storage in the extension.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\ttextAlign: \"center\",\n\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\tlineHeight: \"1.2\",\n\t\t\t\t\t\tmarginTop: \"auto\",\n\t\t\t\t\t\tpadding: \"10px 8px 15px 0px\",\n\t\t\t\t\t}}>\n\t\t\t\t\t<p style={{ wordWrap: \"break-word\", margin: 0, padding: 0 }}>\n\t\t\t\t\t\tIf you have any questions or feedback, feel free to open an issue at{\" \"}\n\t\t\t\t\t\t<VSCodeLink href=\"https://github.com/cline/cline\" style={{ display: \"inline\" }}>\n\t\t\t\t\t\t\thttps://github.com/cline/cline\n\t\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\t</p>\n\t\t\t\t\t<p style={{ fontStyle: \"italic\", margin: \"10px 0 0 0\", padding: 0 }}>v{version}</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n\nexport default memo(SettingsView)\n", "tag": "", "tokens": 1688, "metadata": {}}], "modify_time": 1733144568.7399964}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/settings/TabNavbar.tsx", "relative_path": "cline/webview-ui/src/components/settings/TabNavbar.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/settings/TabNavbar.tsx", "source_code": "import { VSCodeButton } from \"@vscode/webview-ui-toolkit/react\"\nimport React, { useState } from \"react\"\n\nexport const TAB_NAVBAR_HEIGHT = 24\nconst BUTTON_MARGIN_RIGHT = \"3px\"\nconst LAST_BUTTON_MARGIN_RIGHT = \"13px\"\n\ntype TabNavbarProps = {\n\tonPlusClick: () => void\n\tonHistoryClick: () => void\n\tonSettingsClick: () => void\n}\n\ntype TooltipProps = {\n\ttext: string\n\tisVisible: boolean\n\tposition: { x: number; y: number }\n\talign?: \"left\" | \"center\" | \"right\"\n}\n\nconst Tooltip: React.FC<TooltipProps> = ({ text, isVisible, position, align = \"center\" }) => {\n\tlet leftPosition = position.x\n\tlet triangleStyle: React.CSSProperties = {\n\t\tleft: \"50%\",\n\t\tmarginLeft: \"-5px\",\n\t}\n\n\tif (align === \"right\") {\n\t\tleftPosition = position.x - 10 // Adjust this value as needed\n\t\ttriangleStyle = {\n\t\t\tright: \"10px\", // Adjust this value to match the tooltip's right padding\n\t\t\tmarginLeft: \"0\",\n\t\t}\n\t} else if (align === \"left\") {\n\t\tleftPosition = position.x + 10 // Adjust this value as needed\n\t\ttriangleStyle = {\n\t\t\tleft: \"10px\", // Adjust this value to match the tooltip's left padding\n\t\t\tmarginLeft: \"0\",\n\t\t}\n\t}\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: \"fixed\",\n\t\t\t\ttop: `${position.y}px`,\n\t\t\t\tleft: align === \"center\" ? leftPosition + \"px\" : \"auto\",\n\t\t\t\tright: align === \"right\" ? \"10px\" : \"auto\", // Ensure 10px from screen edge\n\t\t\t\ttransform: align === \"center\" ? \"translateX(-50%)\" : \"none\",\n\t\t\t\topacity: isVisible ? 1 : 0,\n\t\t\t\tvisibility: isVisible ? \"visible\" : \"hidden\",\n\t\t\t\ttransition: \"opacity 0.1s ease-out 0.1s, visibility 0.1s ease-out 0.1s\",\n\t\t\t\tbackgroundColor: \"var(--vscode-editorHoverWidget-background)\",\n\t\t\t\tcolor: \"var(--vscode-editorHoverWidget-foreground)\",\n\t\t\t\tpadding: \"4px 8px\",\n\t\t\t\tborderRadius: \"3px\",\n\t\t\t\tfontSize: \"12px\",\n\t\t\t\tpointerEvents: \"none\",\n\t\t\t\tzIndex: 1000,\n\t\t\t\tboxShadow: \"0 2px 8px var(--vscode-widget-shadow)\",\n\t\t\t\tborder: \"1px solid var(--vscode-editorHoverWidget-border)\",\n\t\t\t\ttextAlign: \"center\",\n\t\t\t\twhiteSpace: \"nowrap\",\n\t\t\t}}>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\ttop: \"-5px\",\n\t\t\t\t\t...triangleStyle,\n\t\t\t\t\tborderLeft: \"5px solid transparent\",\n\t\t\t\t\tborderRight: \"5px solid transparent\",\n\t\t\t\t\tborderBottom: \"5px solid var(--vscode-editorHoverWidget-border)\",\n\t\t\t\t}}\n\t\t\t/>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\ttop: \"-4px\",\n\t\t\t\t\t...triangleStyle,\n\t\t\t\t\tborderLeft: \"5px solid transparent\",\n\t\t\t\t\tborderRight: \"5px solid transparent\",\n\t\t\t\t\tborderBottom: \"5px solid var(--vscode-editorHoverWidget-background)\",\n\t\t\t\t}}\n\t\t\t/>\n\t\t\t{text}\n\t\t</div>\n\t)\n}\n\nconst TabNavbar = ({ onPlusClick, onHistoryClick, onSettingsClick }: TabNavbarProps) => {\n\tconst [tooltip, setTooltip] = useState<TooltipProps>({\n\t\ttext: \"\",\n\t\tisVisible: false,\n\t\tposition: { x: 0, y: 0 },\n\t\talign: \"center\",\n\t})\n\n\tconst showTooltip = (text: string, event: React.MouseEvent, align: \"left\" | \"center\" | \"right\" = \"center\") => {\n\t\tconst rect = event.currentTarget.getBoundingClientRect()\n\t\tsetTooltip({\n\t\t\ttext,\n\t\t\tisVisible: true,\n\t\t\tposition: { x: rect.left + rect.width / 2, y: rect.bottom + 7 },\n\t\t\talign,\n\t\t})\n\t}\n\n\tconst hideTooltip = () => {\n\t\tsetTooltip((prev) => ({ ...prev, isVisible: false }))\n\t}\n\n\tconst buttonStyle = {\n\t\tmarginRight: BUTTON_MARGIN_RIGHT,\n\t}\n\n\tconst lastButtonStyle = {\n\t\t...buttonStyle,\n\t\tmarginRight: LAST_BUTTON_MARGIN_RIGHT,\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\ttop: 4,\n\t\t\t\t\tright: 0,\n\t\t\t\t\tleft: 0,\n\t\t\t\t\theight: TAB_NAVBAR_HEIGHT,\n\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\tjustifyContent: \"flex-end\",\n\t\t\t\t\talignItems: \"center\",\n\t\t\t\t}}>\n\t\t\t\t<VSCodeButton\n\t\t\t\t\tappearance=\"icon\"\n\t\t\t\t\tonClick={onPlusClick}\n\t\t\t\t\tstyle={buttonStyle}\n\t\t\t\t\tonMouseEnter={(e) => showTooltip(\"New Chat\", e, \"center\")}\n\t\t\t\t\tonMouseLeave={hideTooltip}\n\t\t\t\t\tonMouseMove={(e) => showTooltip(\"New Chat\", e, \"center\")}>\n\t\t\t\t\t<span className=\"codicon codicon-add\"></span>\n\t\t\t\t</VSCodeButton>\n\t\t\t\t<VSCodeButton\n\t\t\t\t\tappearance=\"icon\"\n\t\t\t\t\tonClick={onHistoryClick}\n\t\t\t\t\tstyle={buttonStyle}\n\t\t\t\t\tonMouseEnter={(e) => showTooltip(\"History\", e, \"center\")}\n\t\t\t\t\tonMouseLeave={hideTooltip}\n\t\t\t\t\tonMouseMove={(e) => showTooltip(\"History\", e, \"center\")}>\n\t\t\t\t\t<span className=\"codicon codicon-history\"></span>\n\t\t\t\t</VSCodeButton>\n\t\t\t\t<VSCodeButton\n\t\t\t\t\tappearance=\"icon\"\n\t\t\t\t\tonClick={onSettingsClick}\n\t\t\t\t\tstyle={lastButtonStyle}\n\t\t\t\t\tonMouseEnter={(e) => showTooltip(\"Settings\", e, \"right\")}\n\t\t\t\t\tonMouseLeave={hideTooltip}\n\t\t\t\t\tonMouseMove={(e) => showTooltip(\"Settings\", e, \"right\")}>\n\t\t\t\t\t<span className=\"codicon codicon-settings-gear\"></span>\n\t\t\t\t</VSCodeButton>\n\t\t\t</div>\n\t\t\t<Tooltip {...tooltip} />\n\t\t</>\n\t)\n}\n\nexport default TabNavbar\n", "tag": "", "tokens": 1553, "metadata": {}}], "modify_time": 1733144568.7401507}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/settings/ApiOptions.tsx", "relative_path": "cline/webview-ui/src/components/settings/ApiOptions.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/settings/ApiOptions.tsx", "source_code": "import {\n\tVSCodeCheckbox,\n\tVSCodeDropdown,\n\tVSCodeLink,\n\tVSCodeOption,\n\tVSCodeRadio,\n\tVSCodeRadioGroup,\n\tVSCodeTextField,\n} from \"@vscode/webview-ui-toolkit/react\"\nimport { Fragment, memo, useCallback, useEffect, useMemo, useState } from \"react\"\nimport { useEvent, useInterval } from \"react-use\"\nimport {\n\tApiConfiguration,\n\tModelInfo,\n\tanthropicDefaultModelId,\n\tanthropicModels,\n\tazureOpenAiDefaultApiVersion,\n\tbedrockDefaultModelId,\n\tbedrockModels,\n\tgeminiDefaultModelId,\n\tgeminiModels,\n\topenAiModelInfoSaneDefaults,\n\topenAiNativeDefaultModelId,\n\topenAiNativeModels,\n\topenRouterDefaultModelId,\n\topenRouterDefaultModelInfo,\n\tvertexDefaultModelId,\n\tvertexModels,\n} from \"../../../../src/shared/api\"\nimport { ExtensionMessage } from \"../../../../src/shared/ExtensionMessage\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport { vscode } from \"../../utils/vscode\"\nimport VSCodeButtonLink from \"../common/VSCodeButtonLink\"\nimport OpenRouterModelPicker, {\n\tModelDescriptionMarkdown,\n\tOPENROUTER_MODEL_PICKER_Z_INDEX,\n} from \"./OpenRouterModelPicker\"\n\ninterface ApiOptionsProps {\n\tshowModelOptions: boolean\n\tapiErrorMessage?: string\n\tmodelIdErrorMessage?: string\n}\n\nconst ApiOptions = ({ showModelOptions, apiErrorMessage, modelIdErrorMessage }: ApiOptionsProps) => {\n\tconst { apiConfiguration, setApiConfiguration, uriScheme } = useExtensionState()\n\tconst [ollamaModels, setOllamaModels] = useState<string[]>([])\n\tconst [lmStudioModels, setLmStudioModels] = useState<string[]>([])\n\tconst [anthropicBaseUrlSelected, setAnthropicBaseUrlSelected] = useState(!!apiConfiguration?.anthropicBaseUrl)\n\tconst [azureApiVersionSelected, setAzureApiVersionSelected] = useState(!!apiConfiguration?.azureApiVersion)\n\tconst [isDescriptionExpanded, setIsDescriptionExpanded] = useState(false)\n\n\tconst handleInputChange = (field: keyof ApiConfiguration) => (event: any) => {\n\t\tsetApiConfiguration({ ...apiConfiguration, [field]: event.target.value })\n\t}\n\n\tconst { selectedProvider, selectedModelId, selectedModelInfo } = useMemo(() => {\n\t\treturn normalizeApiConfiguration(apiConfiguration)\n\t}, [apiConfiguration])\n\n\t// Poll ollama/lmstudio models\n\tconst requestLocalModels = useCallback(() => {\n\t\tif (selectedProvider === \"ollama\") {\n\t\t\tvscode.postMessage({ type: \"requestOllamaModels\", text: apiConfiguration?.ollamaBaseUrl })\n\t\t} else if (selectedProvider === \"lmstudio\") {\n\t\t\tvscode.postMessage({ type: \"requestLmStudioModels\", text: apiConfiguration?.lmStudioBaseUrl })\n\t\t}\n\t}, [selectedProvider, apiConfiguration?.ollamaBaseUrl, apiConfiguration?.lmStudioBaseUrl])\n\tuseEffect(() => {\n\t\tif (selectedProvider === \"ollama\" || selectedProvider === \"lmstudio\") {\n\t\t\trequestLocalModels()\n\t\t}\n\t}, [selectedProvider, requestLocalModels])\n\tuseInterval(requestLocalModels, selectedProvider === \"ollama\" || selectedProvider === \"lmstudio\" ? 2000 : null)\n\n\tconst handleMessage = useCallback((event: MessageEvent) => {\n\t\tconst message: ExtensionMessage = event.data\n\t\tif (message.type === \"ollamaModels\" && message.ollamaModels) {\n\t\t\tsetOllamaModels(message.ollamaModels)\n\t\t} else if (message.type === \"lmStudioModels\" && message.lmStudioModels) {\n\t\t\tsetLmStudioModels(message.lmStudioModels)\n\t\t}\n\t}, [])\n\tuseEvent(\"message\", handleMessage)\n\n\t/*\n\tVSCodeDropdown has an open bug where dynamically rendered options don't auto select the provided value prop. You can see this for yourself by comparing  it with normal select/option elements, which work as expected.\n\thttps://github.com/microsoft/vscode-webview-ui-toolkit/issues/433\n\n\tIn our case, when the user switches between providers, we recalculate the selectedModelId depending on the provider, the default model for that provider, and a modelId that the user may have selected. Unfortunately, the VSCodeDropdown component wouldn't select this calculated value, and would default to the first \"Select a model...\" option instead, which makes it seem like the model was cleared out when it wasn't. \n\n\tAs a workaround, we create separate instances of the dropdown for each provider, and then conditionally render the one that matches the current provider.\n\t*/\n\tconst createDropdown = (models: Record<string, ModelInfo>) => {\n\t\treturn (\n\t\t\t<VSCodeDropdown\n\t\t\t\tid=\"model-id\"\n\t\t\t\tvalue={selectedModelId}\n\t\t\t\tonChange={handleInputChange(\"apiModelId\")}\n\t\t\t\tstyle={{ width: \"100%\" }}>\n\t\t\t\t<VSCodeOption value=\"\">Select a model...</VSCodeOption>\n\t\t\t\t{Object.keys(models).map((modelId) => (\n\t\t\t\t\t<VSCodeOption\n\t\t\t\t\t\tkey={modelId}\n\t\t\t\t\t\tvalue={modelId}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\twhiteSpace: \"normal\",\n\t\t\t\t\t\t\twordWrap: \"break-word\",\n\t\t\t\t\t\t\tmaxWidth: \"100%\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\t{modelId}\n\t\t\t\t\t</VSCodeOption>\n\t\t\t\t))}\n\t\t\t</VSCodeDropdown>\n\t\t)\n\t}\n\n\treturn (\n\t\t<div style={{ display: \"flex\", flexDirection: \"column\", gap: 5 }}>\n\t\t\t<div className=\"dropdown-container\">\n\t\t\t\t<label htmlFor=\"api-provider\">\n\t\t\t\t\t<span style={{ fontWeight: 500 }}>API Provider</span>\n\t\t\t\t</label>\n\t\t\t\t<VSCodeDropdown\n\t\t\t\t\tid=\"api-provider\"\n\t\t\t\t\tvalue={selectedProvider}\n\t\t\t\t\tonChange={handleInputChange(\"apiProvider\")}\n\t\t\t\t\tstyle={{ minWidth: 130, position: \"relative\", zIndex: OPENROUTER_MODEL_PICKER_Z_INDEX + 1 }}>\n\t\t\t\t\t<VSCodeOption value=\"openrouter\">OpenRouter</VSCodeOption>\n\t\t\t\t\t<VSCodeOption value=\"anthropic\">Anthropic</VSCodeOption>\n\t\t\t\t\t<VSCodeOption value=\"gemini\">Google Gemini</VSCodeOption>\n\t\t\t\t\t<VSCodeOption value=\"vertex\">GCP Vertex AI</VSCodeOption>\n\t\t\t\t\t<VSCodeOption value=\"bedrock\">AWS Bedrock</VSCodeOption>\n\t\t\t\t\t<VSCodeOption value=\"openai-native\">OpenAI</VSCodeOption>\n\t\t\t\t\t<VSCodeOption value=\"openai\">OpenAI Compatible</VSCodeOption>\n\t\t\t\t\t<VSCodeOption value=\"lmstudio\">LM Studio</VSCodeOption>\n\t\t\t\t\t<VSCodeOption value=\"ollama\">Ollama</VSCodeOption>\n\t\t\t\t</VSCodeDropdown>\n\t\t\t</div>\n\n\t\t\t{selectedProvider === \"anthropic\" && (\n\t\t\t\t<div>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.apiKey || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"password\"\n\t\t\t\t\t\tonInput={handleInputChange(\"apiKey\")}\n\t\t\t\t\t\tplaceholder=\"Enter API Key...\">\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Anthropic API Key</span>\n\t\t\t\t\t</VSCodeTextField>\n\n\t\t\t\t\t<VSCodeCheckbox\n\t\t\t\t\t\tchecked={anthropicBaseUrlSelected}\n\t\t\t\t\t\tonChange={(e: any) => {\n\t\t\t\t\t\t\tconst isChecked = e.target.checked === true\n\t\t\t\t\t\t\tsetAnthropicBaseUrlSelected(isChecked)\n\t\t\t\t\t\t\tif (!isChecked) {\n\t\t\t\t\t\t\t\tsetApiConfiguration({ ...apiConfiguration, anthropicBaseUrl: \"\" })\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tUse custom base URL\n\t\t\t\t\t</VSCodeCheckbox>\n\n\t\t\t\t\t{anthropicBaseUrlSelected && (\n\t\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\t\tvalue={apiConfiguration?.anthropicBaseUrl || \"\"}\n\t\t\t\t\t\t\tstyle={{ width: \"100%\", marginTop: 3 }}\n\t\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\t\tonInput={handleInputChange(\"anthropicBaseUrl\")}\n\t\t\t\t\t\t\tplaceholder=\"Default: https://api.anthropic.com\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: 3,\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tThis key is stored locally and only used to make API requests from this extension.\n\t\t\t\t\t\t{!apiConfiguration?.apiKey && (\n\t\t\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\t\t\thref=\"https://console.anthropic.com/settings/keys\"\n\t\t\t\t\t\t\t\tstyle={{ display: \"inline\", fontSize: \"inherit\" }}>\n\t\t\t\t\t\t\t\tYou can get an Anthropic API key by signing up here.\n\t\t\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{selectedProvider === \"openai-native\" && (\n\t\t\t\t<div>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.openAiNativeApiKey || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"password\"\n\t\t\t\t\t\tonInput={handleInputChange(\"openAiNativeApiKey\")}\n\t\t\t\t\t\tplaceholder=\"Enter API Key...\">\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>OpenAI API Key</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: 3,\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tThis key is stored locally and only used to make API requests from this extension.\n\t\t\t\t\t\t{!apiConfiguration?.openAiNativeApiKey && (\n\t\t\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\t\t\thref=\"https://platform.openai.com/api-keys\"\n\t\t\t\t\t\t\t\tstyle={{ display: \"inline\", fontSize: \"inherit\" }}>\n\t\t\t\t\t\t\t\tYou can get an OpenAI API key by signing up here.\n\t\t\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{selectedProvider === \"openrouter\" && (\n\t\t\t\t<div>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.openRouterApiKey || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"password\"\n\t\t\t\t\t\tonInput={handleInputChange(\"openRouterApiKey\")}\n\t\t\t\t\t\tplaceholder=\"Enter API Key...\">\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>OpenRouter API Key</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t{!apiConfiguration?.openRouterApiKey && (\n\t\t\t\t\t\t<VSCodeButtonLink\n\t\t\t\t\t\t\thref={getOpenRouterAuthUrl(uriScheme)}\n\t\t\t\t\t\t\tstyle={{ margin: \"5px 0 0 0\" }}\n\t\t\t\t\t\t\tappearance=\"secondary\">\n\t\t\t\t\t\t\tGet OpenRouter API Key\n\t\t\t\t\t\t</VSCodeButtonLink>\n\t\t\t\t\t)}\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: \"5px\",\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tThis key is stored locally and only used to make API requests from this extension.{\" \"}\n\t\t\t\t\t\t{/* {!apiConfiguration?.openRouterApiKey && (\n\t\t\t\t\t\t\t<span style={{ color: \"var(--vscode-charts-green)\" }}>\n\t\t\t\t\t\t\t\t(<span style={{ fontWeight: 500 }}>Note:</span> OpenRouter is recommended for high rate\n\t\t\t\t\t\t\t\tlimits, prompt caching, and wider selection of models.)\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)} */}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{selectedProvider === \"bedrock\" && (\n\t\t\t\t<div style={{ display: \"flex\", flexDirection: \"column\", gap: 5 }}>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.awsAccessKey || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"password\"\n\t\t\t\t\t\tonInput={handleInputChange(\"awsAccessKey\")}\n\t\t\t\t\t\tplaceholder=\"Enter Access Key...\">\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>AWS Access Key</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.awsSecretKey || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"password\"\n\t\t\t\t\t\tonInput={handleInputChange(\"awsSecretKey\")}\n\t\t\t\t\t\tplaceholder=\"Enter Secret Key...\">\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>AWS Secret Key</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.awsSessionToken || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"password\"\n\t\t\t\t\t\tonInput={handleInputChange(\"awsSessionToken\")}\n\t\t\t\t\t\tplaceholder=\"Enter Session Token...\">\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>AWS Session Token</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<div className=\"dropdown-container\">\n\t\t\t\t\t\t<label htmlFor=\"aws-region-dropdown\">\n\t\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>AWS Region</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<VSCodeDropdown\n\t\t\t\t\t\t\tid=\"aws-region-dropdown\"\n\t\t\t\t\t\t\tvalue={apiConfiguration?.awsRegion || \"\"}\n\t\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\t\tonChange={handleInputChange(\"awsRegion\")}>\n\t\t\t\t\t\t\t<VSCodeOption value=\"\">Select a region...</VSCodeOption>\n\t\t\t\t\t\t\t{/* The user will have to choose a region that supports the model they use, but this shouldn't be a problem since they'd have to request access for it in that region in the first place. */}\n\t\t\t\t\t\t\t<VSCodeOption value=\"us-east-1\">us-east-1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"us-east-2\">us-east-2</VSCodeOption>\n\t\t\t\t\t\t\t{/* <VSCodeOption value=\"us-west-1\">us-west-1</VSCodeOption> */}\n\t\t\t\t\t\t\t<VSCodeOption value=\"us-west-2\">us-west-2</VSCodeOption>\n\t\t\t\t\t\t\t{/* <VSCodeOption value=\"af-south-1\">af-south-1</VSCodeOption> */}\n\t\t\t\t\t\t\t{/* <VSCodeOption value=\"ap-east-1\">ap-east-1</VSCodeOption> */}\n\t\t\t\t\t\t\t<VSCodeOption value=\"ap-south-1\">ap-south-1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"ap-northeast-1\">ap-northeast-1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"ap-northeast-2\">ap-northeast-2</VSCodeOption>\n\t\t\t\t\t\t\t{/* <VSCodeOption value=\"ap-northeast-3\">ap-northeast-3</VSCodeOption> */}\n\t\t\t\t\t\t\t<VSCodeOption value=\"ap-southeast-1\">ap-southeast-1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"ap-southeast-2\">ap-southeast-2</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"ca-central-1\">ca-central-1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"eu-central-1\">eu-central-1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"eu-west-1\">eu-west-1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"eu-west-2\">eu-west-2</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"eu-west-3\">eu-west-3</VSCodeOption>\n\t\t\t\t\t\t\t{/* <VSCodeOption value=\"eu-north-1\">eu-north-1</VSCodeOption> */}\n\t\t\t\t\t\t\t{/* <VSCodeOption value=\"me-south-1\">me-south-1</VSCodeOption> */}\n\t\t\t\t\t\t\t<VSCodeOption value=\"sa-east-1\">sa-east-1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"us-gov-west-1\">us-gov-west-1</VSCodeOption>\n\t\t\t\t\t\t\t{/* <VSCodeOption value=\"us-gov-east-1\">us-gov-east-1</VSCodeOption> */}\n\t\t\t\t\t\t</VSCodeDropdown>\n\t\t\t\t\t</div>\n\t\t\t\t\t<VSCodeCheckbox\n\t\t\t\t\t\tchecked={apiConfiguration?.awsUseCrossRegionInference || false}\n\t\t\t\t\t\tonChange={(e: any) => {\n\t\t\t\t\t\t\tconst isChecked = e.target.checked === true\n\t\t\t\t\t\t\tsetApiConfiguration({ ...apiConfiguration, awsUseCrossRegionInference: isChecked })\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tUse cross-region inference\n\t\t\t\t\t</VSCodeCheckbox>\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: \"5px\",\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tAuthenticate by either providing the keys above or use the default AWS credential providers,\n\t\t\t\t\t\ti.e. ~/.aws/credentials or environment variables. These credentials are only used locally to\n\t\t\t\t\t\tmake API requests from this extension.\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{apiConfiguration?.apiProvider === \"vertex\" && (\n\t\t\t\t<div style={{ display: \"flex\", flexDirection: \"column\", gap: 5 }}>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.vertexProjectId || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\tonInput={handleInputChange(\"vertexProjectId\")}\n\t\t\t\t\t\tplaceholder=\"Enter Project ID...\">\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Google Cloud Project ID</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<div className=\"dropdown-container\">\n\t\t\t\t\t\t<label htmlFor=\"vertex-region-dropdown\">\n\t\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Google Cloud Region</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<VSCodeDropdown\n\t\t\t\t\t\t\tid=\"vertex-region-dropdown\"\n\t\t\t\t\t\t\tvalue={apiConfiguration?.vertexRegion || \"\"}\n\t\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\t\tonChange={handleInputChange(\"vertexRegion\")}>\n\t\t\t\t\t\t\t<VSCodeOption value=\"\">Select a region...</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"us-east5\">us-east5</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"us-central1\">us-central1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"europe-west1\">europe-west1</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"europe-west4\">europe-west4</VSCodeOption>\n\t\t\t\t\t\t\t<VSCodeOption value=\"asia-southeast1\">asia-southeast1</VSCodeOption>\n\t\t\t\t\t\t</VSCodeDropdown>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: \"5px\",\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tTo use Google Cloud Vertex AI, you need to\n\t\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\t\thref=\"https://cloud.google.com/vertex-ai/generative-ai/docs/partner-models/use-claude#before_you_begin\"\n\t\t\t\t\t\t\tstyle={{ display: \"inline\", fontSize: \"inherit\" }}>\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"1) create a Google Cloud account › enable the Vertex AI API › enable the desired Claude models,\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t</VSCodeLink>{\" \"}\n\t\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\t\thref=\"https://cloud.google.com/docs/authentication/provide-credentials-adc#google-idp\"\n\t\t\t\t\t\t\tstyle={{ display: \"inline\", fontSize: \"inherit\" }}>\n\t\t\t\t\t\t\t{\"2) install the Google Cloud CLI › configure Application Default Credentials.\"}\n\t\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{selectedProvider === \"gemini\" && (\n\t\t\t\t<div>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.geminiApiKey || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"password\"\n\t\t\t\t\t\tonInput={handleInputChange(\"geminiApiKey\")}\n\t\t\t\t\t\tplaceholder=\"Enter API Key...\">\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Gemini API Key</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: 3,\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tThis key is stored locally and only used to make API requests from this extension.\n\t\t\t\t\t\t{!apiConfiguration?.geminiApiKey && (\n\t\t\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\t\t\thref=\"https://ai.google.dev/\"\n\t\t\t\t\t\t\t\tstyle={{ display: \"inline\", fontSize: \"inherit\" }}>\n\t\t\t\t\t\t\t\tYou can get a Gemini API key by signing up here.\n\t\t\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{selectedProvider === \"openai\" && (\n\t\t\t\t<div>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.openAiBaseUrl || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\tonInput={handleInputChange(\"openAiBaseUrl\")}\n\t\t\t\t\t\tplaceholder={\"Enter base URL...\"}>\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Base URL</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.openAiApiKey || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"password\"\n\t\t\t\t\t\tonInput={handleInputChange(\"openAiApiKey\")}\n\t\t\t\t\t\tplaceholder=\"Enter API Key...\">\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>API Key</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.openAiModelId || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\tonInput={handleInputChange(\"openAiModelId\")}\n\t\t\t\t\t\tplaceholder={\"Enter Model ID...\"}>\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Model ID</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<VSCodeCheckbox\n\t\t\t\t\t\tchecked={azureApiVersionSelected}\n\t\t\t\t\t\tonChange={(e: any) => {\n\t\t\t\t\t\t\tconst isChecked = e.target.checked === true\n\t\t\t\t\t\t\tsetAzureApiVersionSelected(isChecked)\n\t\t\t\t\t\t\tif (!isChecked) {\n\t\t\t\t\t\t\t\tsetApiConfiguration({ ...apiConfiguration, azureApiVersion: \"\" })\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tSet Azure API version\n\t\t\t\t\t</VSCodeCheckbox>\n\t\t\t\t\t{azureApiVersionSelected && (\n\t\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\t\tvalue={apiConfiguration?.azureApiVersion || \"\"}\n\t\t\t\t\t\t\tstyle={{ width: \"100%\", marginTop: 3 }}\n\t\t\t\t\t\t\tonInput={handleInputChange(\"azureApiVersion\")}\n\t\t\t\t\t\t\tplaceholder={`Default: ${azureOpenAiDefaultApiVersion}`}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: 3,\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\t<span style={{ color: \"var(--vscode-errorForeground)\" }}>\n\t\t\t\t\t\t\t(<span style={{ fontWeight: 500 }}>Note:</span> Cline uses complex prompts and works best\n\t\t\t\t\t\t\twith Claude models. Less capable models may not work as expected.)\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{selectedProvider === \"lmstudio\" && (\n\t\t\t\t<div>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.lmStudioBaseUrl || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\tonInput={handleInputChange(\"lmStudioBaseUrl\")}\n\t\t\t\t\t\tplaceholder={\"Default: http://localhost:1234\"}>\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Base URL (optional)</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.lmStudioModelId || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\tonInput={handleInputChange(\"lmStudioModelId\")}\n\t\t\t\t\t\tplaceholder={\"e.g. meta-llama-3.1-8b-instruct\"}>\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Model ID</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t{lmStudioModels.length > 0 && (\n\t\t\t\t\t\t<VSCodeRadioGroup\n\t\t\t\t\t\t\tvalue={\n\t\t\t\t\t\t\t\tlmStudioModels.includes(apiConfiguration?.lmStudioModelId || \"\")\n\t\t\t\t\t\t\t\t\t? apiConfiguration?.lmStudioModelId\n\t\t\t\t\t\t\t\t\t: \"\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\tconst value = (e.target as HTMLInputElement)?.value\n\t\t\t\t\t\t\t\t// need to check value first since radio group returns empty string sometimes\n\t\t\t\t\t\t\t\tif (value) {\n\t\t\t\t\t\t\t\t\thandleInputChange(\"lmStudioModelId\")({\n\t\t\t\t\t\t\t\t\t\ttarget: { value },\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t{lmStudioModels.map((model) => (\n\t\t\t\t\t\t\t\t<VSCodeRadio\n\t\t\t\t\t\t\t\t\tkey={model}\n\t\t\t\t\t\t\t\t\tvalue={model}\n\t\t\t\t\t\t\t\t\tchecked={apiConfiguration?.lmStudioModelId === model}>\n\t\t\t\t\t\t\t\t\t{model}\n\t\t\t\t\t\t\t\t</VSCodeRadio>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</VSCodeRadioGroup>\n\t\t\t\t\t)}\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: \"5px\",\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tLM Studio allows you to run models locally on your computer. For instructions on how to get\n\t\t\t\t\t\tstarted, see their\n\t\t\t\t\t\t<VSCodeLink href=\"https://lmstudio.ai/docs\" style={{ display: \"inline\", fontSize: \"inherit\" }}>\n\t\t\t\t\t\t\tquickstart guide.\n\t\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\t\tYou will also need to start LM Studio's{\" \"}\n\t\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\t\thref=\"https://lmstudio.ai/docs/basics/server\"\n\t\t\t\t\t\t\tstyle={{ display: \"inline\", fontSize: \"inherit\" }}>\n\t\t\t\t\t\t\tlocal server\n\t\t\t\t\t\t</VSCodeLink>{\" \"}\n\t\t\t\t\t\tfeature to use it with this extension.{\" \"}\n\t\t\t\t\t\t<span style={{ color: \"var(--vscode-errorForeground)\" }}>\n\t\t\t\t\t\t\t(<span style={{ fontWeight: 500 }}>Note:</span> Cline uses complex prompts and works best\n\t\t\t\t\t\t\twith Claude models. Less capable models may not work as expected.)\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{selectedProvider === \"ollama\" && (\n\t\t\t\t<div>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.ollamaBaseUrl || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\ttype=\"url\"\n\t\t\t\t\t\tonInput={handleInputChange(\"ollamaBaseUrl\")}\n\t\t\t\t\t\tplaceholder={\"Default: http://localhost:11434\"}>\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Base URL (optional)</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\tvalue={apiConfiguration?.ollamaModelId || \"\"}\n\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\tonInput={handleInputChange(\"ollamaModelId\")}\n\t\t\t\t\t\tplaceholder={\"e.g. llama3.1\"}>\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Model ID</span>\n\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t{ollamaModels.length > 0 && (\n\t\t\t\t\t\t<VSCodeRadioGroup\n\t\t\t\t\t\t\tvalue={\n\t\t\t\t\t\t\t\tollamaModels.includes(apiConfiguration?.ollamaModelId || \"\")\n\t\t\t\t\t\t\t\t\t? apiConfiguration?.ollamaModelId\n\t\t\t\t\t\t\t\t\t: \"\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\t\tconst value = (e.target as HTMLInputElement)?.value\n\t\t\t\t\t\t\t\t// need to check value first since radio group returns empty string sometimes\n\t\t\t\t\t\t\t\tif (value) {\n\t\t\t\t\t\t\t\t\thandleInputChange(\"ollamaModelId\")({\n\t\t\t\t\t\t\t\t\t\ttarget: { value },\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t{ollamaModels.map((model) => (\n\t\t\t\t\t\t\t\t<VSCodeRadio\n\t\t\t\t\t\t\t\t\tkey={model}\n\t\t\t\t\t\t\t\t\tvalue={model}\n\t\t\t\t\t\t\t\t\tchecked={apiConfiguration?.ollamaModelId === model}>\n\t\t\t\t\t\t\t\t\t{model}\n\t\t\t\t\t\t\t\t</VSCodeRadio>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</VSCodeRadioGroup>\n\t\t\t\t\t)}\n\t\t\t\t\t<p\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\tmarginTop: \"5px\",\n\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\tOllama allows you to run models locally on your computer. For instructions on how to get\n\t\t\t\t\t\tstarted, see their\n\t\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\t\thref=\"https://github.com/ollama/ollama/blob/main/README.md\"\n\t\t\t\t\t\t\tstyle={{ display: \"inline\", fontSize: \"inherit\" }}>\n\t\t\t\t\t\t\tquickstart guide.\n\t\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\t\t<span style={{ color: \"var(--vscode-errorForeground)\" }}>\n\t\t\t\t\t\t\t(<span style={{ fontWeight: 500 }}>Note:</span> Cline uses complex prompts and works best\n\t\t\t\t\t\t\twith Claude models. Less capable models may not work as expected.)\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t{apiErrorMessage && (\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: \"-10px 0 4px 0\",\n\t\t\t\t\t\tfontSize: 12,\n\t\t\t\t\t\tcolor: \"var(--vscode-errorForeground)\",\n\t\t\t\t\t}}>\n\t\t\t\t\t{apiErrorMessage}\n\t\t\t\t</p>\n\t\t\t)}\n\n\t\t\t{selectedProvider === \"openrouter\" && showModelOptions && <OpenRouterModelPicker />}\n\n\t\t\t{selectedProvider !== \"openrouter\" &&\n\t\t\t\tselectedProvider !== \"openai\" &&\n\t\t\t\tselectedProvider !== \"ollama\" &&\n\t\t\t\tselectedProvider !== \"lmstudio\" &&\n\t\t\t\tshowModelOptions && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div className=\"dropdown-container\">\n\t\t\t\t\t\t\t<label htmlFor=\"model-id\">\n\t\t\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Model</span>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t{selectedProvider === \"anthropic\" && createDropdown(anthropicModels)}\n\t\t\t\t\t\t\t{selectedProvider === \"bedrock\" && createDropdown(bedrockModels)}\n\t\t\t\t\t\t\t{selectedProvider === \"vertex\" && createDropdown(vertexModels)}\n\t\t\t\t\t\t\t{selectedProvider === \"gemini\" && createDropdown(geminiModels)}\n\t\t\t\t\t\t\t{selectedProvider === \"openai-native\" && createDropdown(openAiNativeModels)}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<ModelInfoView\n\t\t\t\t\t\t\tselectedModelId={selectedModelId}\n\t\t\t\t\t\t\tmodelInfo={selectedModelInfo}\n\t\t\t\t\t\t\tisDescriptionExpanded={isDescriptionExpanded}\n\t\t\t\t\t\t\tsetIsDescriptionExpanded={setIsDescriptionExpanded}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\n\t\t\t{modelIdErrorMessage && (\n\t\t\t\t<p\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: \"-10px 0 4px 0\",\n\t\t\t\t\t\tfontSize: 12,\n\t\t\t\t\t\tcolor: \"var(--vscode-errorForeground)\",\n\t\t\t\t\t}}>\n\t\t\t\t\t{modelIdErrorMessage}\n\t\t\t\t</p>\n\t\t\t)}\n\t\t</div>\n\t)\n}\n\nexport function getOpenRouterAuthUrl(uriScheme?: string) {\n\treturn `https://openrouter.ai/auth?callback_url=${uriScheme || \"vscode\"}://saoudrizwan.claude-dev/openrouter`\n}\n\nexport const formatPrice = (price: number) => {\n\treturn new Intl.NumberFormat(\"en-US\", {\n\t\tstyle: \"currency\",\n\t\tcurrency: \"USD\",\n\t\tminimumFractionDigits: 2,\n\t\tmaximumFractionDigits: 2,\n\t}).format(price)\n}\n\nexport const ModelInfoView = ({\n\tselectedModelId,\n\tmodelInfo,\n\tisDescriptionExpanded,\n\tsetIsDescriptionExpanded,\n}: {\n\tselectedModelId: string\n\tmodelInfo: ModelInfo\n\tisDescriptionExpanded: boolean\n\tsetIsDescriptionExpanded: (isExpanded: boolean) => void\n}) => {\n\tconst isGemini = Object.keys(geminiModels).includes(selectedModelId)\n\n\tconst infoItems = [\n\t\tmodelInfo.description && (\n\t\t\t<ModelDescriptionMarkdown\n\t\t\t\tkey=\"description\"\n\t\t\t\tmarkdown={modelInfo.description}\n\t\t\t\tisExpanded={isDescriptionExpanded}\n\t\t\t\tsetIsExpanded={setIsDescriptionExpanded}\n\t\t\t/>\n\t\t),\n\t\t<ModelInfoSupportsItem\n\t\t\tkey=\"supportsImages\"\n\t\t\tisSupported={modelInfo.supportsImages ?? false}\n\t\t\tsupportsLabel=\"Supports images\"\n\t\t\tdoesNotSupportLabel=\"Does not support images\"\n\t\t/>,\n\t\t<ModelInfoSupportsItem\n\t\t\tkey=\"supportsComputerUse\"\n\t\t\tisSupported={modelInfo.supportsComputerUse ?? false}\n\t\t\tsupportsLabel=\"Supports computer use\"\n\t\t\tdoesNotSupportLabel=\"Does not support computer use\"\n\t\t/>,\n\t\t!isGemini && (\n\t\t\t<ModelInfoSupportsItem\n\t\t\t\tkey=\"supportsPromptCache\"\n\t\t\t\tisSupported={modelInfo.supportsPromptCache}\n\t\t\t\tsupportsLabel=\"Supports prompt caching\"\n\t\t\t\tdoesNotSupportLabel=\"Does not support prompt caching\"\n\t\t\t/>\n\t\t),\n\t\tmodelInfo.maxTokens !== undefined && modelInfo.maxTokens > 0 && (\n\t\t\t<span key=\"maxTokens\">\n\t\t\t\t<span style={{ fontWeight: 500 }}>Max output:</span> {modelInfo.maxTokens?.toLocaleString()} tokens\n\t\t\t</span>\n\t\t),\n\t\tmodelInfo.inputPrice !== undefined && modelInfo.inputPrice > 0 && (\n\t\t\t<span key=\"inputPrice\">\n\t\t\t\t<span style={{ fontWeight: 500 }}>Input price:</span> {formatPrice(modelInfo.inputPrice)}/million tokens\n\t\t\t</span>\n\t\t),\n\t\tmodelInfo.supportsPromptCache && modelInfo.cacheWritesPrice && (\n\t\t\t<span key=\"cacheWritesPrice\">\n\t\t\t\t<span style={{ fontWeight: 500 }}>Cache writes price:</span>{\" \"}\n\t\t\t\t{formatPrice(modelInfo.cacheWritesPrice || 0)}/million tokens\n\t\t\t</span>\n\t\t),\n\t\tmodelInfo.supportsPromptCache && modelInfo.cacheReadsPrice && (\n\t\t\t<span key=\"cacheReadsPrice\">\n\t\t\t\t<span style={{ fontWeight: 500 }}>Cache reads price:</span>{\" \"}\n\t\t\t\t{formatPrice(modelInfo.cacheReadsPrice || 0)}/million tokens\n\t\t\t</span>\n\t\t),\n\t\tmodelInfo.outputPrice !== undefined && modelInfo.outputPrice > 0 && (\n\t\t\t<span key=\"outputPrice\">\n\t\t\t\t<span style={{ fontWeight: 500 }}>Output price:</span> {formatPrice(modelInfo.outputPrice)}/million\n\t\t\t\ttokens\n\t\t\t</span>\n\t\t),\n\t\tisGemini && (\n\t\t\t<span key=\"geminiInfo\" style={{ fontStyle: \"italic\" }}>\n\t\t\t\t* Free up to {selectedModelId && selectedModelId.includes(\"flash\") ? \"15\" : \"2\"} requests per minute.\n\t\t\t\tAfter that, billing depends on prompt size.{\" \"}\n\t\t\t\t<VSCodeLink href=\"https://ai.google.dev/pricing\" style={{ display: \"inline\", fontSize: \"inherit\" }}>\n\t\t\t\t\tFor more info, see pricing details.\n\t\t\t\t</VSCodeLink>\n\t\t\t</span>\n\t\t),\n\t].filter(Boolean)\n\n\treturn (\n\t\t<p style={{ fontSize: \"12px\", marginTop: \"2px\", color: \"var(--vscode-descriptionForeground)\" }}>\n\t\t\t{infoItems.map((item, index) => (\n\t\t\t\t<Fragment key={index}>\n\t\t\t\t\t{item}\n\t\t\t\t\t{index < infoItems.length - 1 && <br />}\n\t\t\t\t</Fragment>\n\t\t\t))}\n\t\t</p>\n\t)\n}\n\nconst ModelInfoSupportsItem = ({\n\tisSupported,\n\tsupportsLabel,\n\tdoesNotSupportLabel,\n}: {\n\tisSupported: boolean\n\tsupportsLabel: string\n\tdoesNotSupportLabel: string\n}) => (\n\t<span\n\t\tstyle={{\n\t\t\tfontWeight: 500,\n\t\t\tcolor: isSupported ? \"var(--vscode-charts-green)\" : \"var(--vscode-errorForeground)\",\n\t\t}}>\n\t\t<i\n\t\t\tclassName={`codicon codicon-${isSupported ? \"check\" : \"x\"}`}\n\t\t\tstyle={{\n\t\t\t\tmarginRight: 4,\n\t\t\t\tmarginBottom: isSupported ? 1 : -1,\n\t\t\t\tfontSize: isSupported ? 11 : 13,\n\t\t\t\tfontWeight: 700,\n\t\t\t\tdisplay: \"inline-block\",\n\t\t\t\tverticalAlign: \"bottom\",\n\t\t\t}}></i>\n\t\t{isSupported ? supportsLabel : doesNotSupportLabel}\n\t</span>\n)\n\nexport function normalizeApiConfiguration(apiConfiguration?: ApiConfiguration) {\n\tconst provider = apiConfiguration?.apiProvider || \"anthropic\"\n\tconst modelId = apiConfiguration?.apiModelId\n\n\tconst getProviderData = (models: Record<string, ModelInfo>, defaultId: string) => {\n\t\tlet selectedModelId: string\n\t\tlet selectedModelInfo: ModelInfo\n\t\tif (modelId && modelId in models) {\n\t\t\tselectedModelId = modelId\n\t\t\tselectedModelInfo = models[modelId]\n\t\t} else {\n\t\t\tselectedModelId = defaultId\n\t\t\tselectedModelInfo = models[defaultId]\n\t\t}\n\t\treturn { selectedProvider: provider, selectedModelId, selectedModelInfo }\n\t}\n\tswitch (provider) {\n\t\tcase \"anthropic\":\n\t\t\treturn getProviderData(anthropicModels, anthropicDefaultModelId)\n\t\tcase \"bedrock\":\n\t\t\treturn getProviderData(bedrockModels, bedrockDefaultModelId)\n\t\tcase \"vertex\":\n\t\t\treturn getProviderData(vertexModels, vertexDefaultModelId)\n\t\tcase \"gemini\":\n\t\t\treturn getProviderData(geminiModels, geminiDefaultModelId)\n\t\tcase \"openai-native\":\n\t\t\treturn getProviderData(openAiNativeModels, openAiNativeDefaultModelId)\n\t\tcase \"openrouter\":\n\t\t\treturn {\n\t\t\t\tselectedProvider: provider,\n\t\t\t\tselectedModelId: apiConfiguration?.openRouterModelId || openRouterDefaultModelId,\n\t\t\t\tselectedModelInfo: apiConfiguration?.openRouterModelInfo || openRouterDefaultModelInfo,\n\t\t\t}\n\t\tcase \"openai\":\n\t\t\treturn {\n\t\t\t\tselectedProvider: provider,\n\t\t\t\tselectedModelId: apiConfiguration?.openAiModelId || \"\",\n\t\t\t\tselectedModelInfo: openAiModelInfoSaneDefaults,\n\t\t\t}\n\t\tcase \"ollama\":\n\t\t\treturn {\n\t\t\t\tselectedProvider: provider,\n\t\t\t\tselectedModelId: apiConfiguration?.ollamaModelId || \"\",\n\t\t\t\tselectedModelInfo: openAiModelInfoSaneDefaults,\n\t\t\t}\n\t\tcase \"lmstudio\":\n\t\t\treturn {\n\t\t\t\tselectedProvider: provider,\n\t\t\t\tselectedModelId: apiConfiguration?.lmStudioModelId || \"\",\n\t\t\t\tselectedModelInfo: openAiModelInfoSaneDefaults,\n\t\t\t}\n\t\tdefault:\n\t\t\treturn getProviderData(anthropicModels, anthropicDefaultModelId)\n\t}\n}\n\nexport default memo(ApiOptions)\n", "tag": "", "tokens": 9135, "metadata": {}}], "modify_time": 1733144568.7395976}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/ChatTextArea.tsx", "relative_path": "cline/webview-ui/src/components/chat/ChatTextArea.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/ChatTextArea.tsx", "source_code": "import React, { forwardRef, useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from \"react\"\nimport DynamicTextArea from \"react-textarea-autosize\"\nimport { mentionRegex, mentionRegexGlobal } from \"../../../../src/shared/context-mentions\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport {\n\tContextMenuOptionType,\n\tgetContextMenuOptions,\n\tinsertMention,\n\tremoveMention,\n\tshouldShowContextMenu,\n} from \"../../utils/context-mentions\"\nimport { MAX_IMAGES_PER_MESSAGE } from \"./ChatView\"\nimport ContextMenu from \"./ContextMenu\"\nimport Thumbnails from \"../common/Thumbnails\"\n\ninterface ChatTextAreaProps {\n\tinputValue: string\n\tsetInputValue: (value: string) => void\n\ttextAreaDisabled: boolean\n\tplaceholderText: string\n\tselectedImages: string[]\n\tsetSelectedImages: React.Dispatch<React.SetStateAction<string[]>>\n\tonSend: () => void\n\tonSelectImages: () => void\n\tshouldDisableImages: boolean\n\tonHeightChange?: (height: number) => void\n}\n\nconst ChatTextArea = forwardRef<HTMLTextAreaElement, ChatTextAreaProps>(\n\t(\n\t\t{\n\t\t\tinputValue,\n\t\t\tsetInputValue,\n\t\t\ttextAreaDisabled,\n\t\t\tplaceholderText,\n\t\t\tselectedImages,\n\t\t\tsetSelectedImages,\n\t\t\tonSend,\n\t\t\tonSelectImages,\n\t\t\tshouldDisableImages,\n\t\t\tonHeightChange,\n\t\t},\n\t\tref,\n\t) => {\n\t\tconst { filePaths } = useExtensionState()\n\t\tconst [isTextAreaFocused, setIsTextAreaFocused] = useState(false)\n\t\tconst [thumbnailsHeight, setThumbnailsHeight] = useState(0)\n\t\tconst [textAreaBaseHeight, setTextAreaBaseHeight] = useState<number | undefined>(undefined)\n\t\tconst [showContextMenu, setShowContextMenu] = useState(false)\n\t\tconst [cursorPosition, setCursorPosition] = useState(0)\n\t\tconst [searchQuery, setSearchQuery] = useState(\"\")\n\t\tconst textAreaRef = useRef<HTMLTextAreaElement | null>(null)\n\t\tconst [isMouseDownOnMenu, setIsMouseDownOnMenu] = useState(false)\n\t\tconst highlightLayerRef = useRef<HTMLDivElement>(null)\n\t\tconst [selectedMenuIndex, setSelectedMenuIndex] = useState(-1)\n\t\tconst [selectedType, setSelectedType] = useState<ContextMenuOptionType | null>(null)\n\t\tconst [justDeletedSpaceAfterMention, setJustDeletedSpaceAfterMention] = useState(false)\n\t\tconst [intendedCursorPosition, setIntendedCursorPosition] = useState<number | null>(null)\n\t\tconst contextMenuContainerRef = useRef<HTMLDivElement>(null)\n\n\t\tconst queryItems = useMemo(() => {\n\t\t\treturn [\n\t\t\t\t{ type: ContextMenuOptionType.Problems, value: \"problems\" },\n\t\t\t\t...filePaths\n\t\t\t\t\t.map((file) => \"/\" + file)\n\t\t\t\t\t.map((path) => ({\n\t\t\t\t\t\ttype: path.endsWith(\"/\") ? ContextMenuOptionType.Folder : ContextMenuOptionType.File,\n\t\t\t\t\t\tvalue: path,\n\t\t\t\t\t})),\n\t\t\t]\n\t\t}, [filePaths])\n\n\t\tuseEffect(() => {\n\t\t\tconst handleClickOutside = (event: MouseEvent) => {\n\t\t\t\tif (\n\t\t\t\t\tcontextMenuContainerRef.current &&\n\t\t\t\t\t!contextMenuContainerRef.current.contains(event.target as Node)\n\t\t\t\t) {\n\t\t\t\t\tsetShowContextMenu(false)\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (showContextMenu) {\n\t\t\t\tdocument.addEventListener(\"mousedown\", handleClickOutside)\n\t\t\t}\n\n\t\t\treturn () => {\n\t\t\t\tdocument.removeEventListener(\"mousedown\", handleClickOutside)\n\t\t\t}\n\t\t}, [showContextMenu, setShowContextMenu])\n\n\t\tconst handleMentionSelect = useCallback(\n\t\t\t(type: ContextMenuOptionType, value?: string) => {\n\t\t\t\tif (type === ContextMenuOptionType.NoResults) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tif (type === ContextMenuOptionType.File || type === ContextMenuOptionType.Folder) {\n\t\t\t\t\tif (!value) {\n\t\t\t\t\t\tsetSelectedType(type)\n\t\t\t\t\t\tsetSearchQuery(\"\")\n\t\t\t\t\t\tsetSelectedMenuIndex(0)\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tsetShowContextMenu(false)\n\t\t\t\tsetSelectedType(null)\n\t\t\t\tif (textAreaRef.current) {\n\t\t\t\t\tlet insertValue = value || \"\"\n\t\t\t\t\tif (type === ContextMenuOptionType.URL) {\n\t\t\t\t\t\tinsertValue = value || \"\"\n\t\t\t\t\t} else if (type === ContextMenuOptionType.File || type === ContextMenuOptionType.Folder) {\n\t\t\t\t\t\tinsertValue = value || \"\"\n\t\t\t\t\t} else if (type === ContextMenuOptionType.Problems) {\n\t\t\t\t\t\tinsertValue = \"problems\"\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { newValue, mentionIndex } = insertMention(\n\t\t\t\t\t\ttextAreaRef.current.value,\n\t\t\t\t\t\tcursorPosition,\n\t\t\t\t\t\tinsertValue,\n\t\t\t\t\t)\n\n\t\t\t\t\tsetInputValue(newValue)\n\t\t\t\t\tconst newCursorPosition = newValue.indexOf(\" \", mentionIndex + insertValue.length) + 1\n\t\t\t\t\tsetCursorPosition(newCursorPosition)\n\t\t\t\t\tsetIntendedCursorPosition(newCursorPosition)\n\t\t\t\t\t// textAreaRef.current.focus()\n\n\t\t\t\t\t// scroll to cursor\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tif (textAreaRef.current) {\n\t\t\t\t\t\t\ttextAreaRef.current.blur()\n\t\t\t\t\t\t\ttextAreaRef.current.focus()\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 0)\n\t\t\t\t}\n\t\t\t},\n\t\t\t[setInputValue, cursorPosition],\n\t\t)\n\n\t\tconst handleKeyDown = useCallback(\n\t\t\t(event: React.KeyboardEvent<HTMLTextAreaElement>) => {\n\t\t\t\tif (showContextMenu) {\n\t\t\t\t\tif (event.key === \"Escape\") {\n\t\t\t\t\t\t// event.preventDefault()\n\t\t\t\t\t\tsetSelectedType(null)\n\t\t\t\t\t\tsetSelectedMenuIndex(3) // File by default\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\tif (event.key === \"ArrowUp\" || event.key === \"ArrowDown\") {\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t\tsetSelectedMenuIndex((prevIndex) => {\n\t\t\t\t\t\t\tconst direction = event.key === \"ArrowUp\" ? -1 : 1\n\t\t\t\t\t\t\tconst options = getContextMenuOptions(searchQuery, selectedType, queryItems)\n\t\t\t\t\t\t\tconst optionsLength = options.length\n\n\t\t\t\t\t\t\tif (optionsLength === 0) return prevIndex\n\n\t\t\t\t\t\t\t// Find selectable options (non-URL types)\n\t\t\t\t\t\t\tconst selectableOptions = options.filter(\n\t\t\t\t\t\t\t\t(option) =>\n\t\t\t\t\t\t\t\t\toption.type !== ContextMenuOptionType.URL &&\n\t\t\t\t\t\t\t\t\toption.type !== ContextMenuOptionType.NoResults,\n\t\t\t\t\t\t\t)\n\n\t\t\t\t\t\t\tif (selectableOptions.length === 0) return -1 // No selectable options\n\n\t\t\t\t\t\t\t// Find the index of the next selectable option\n\t\t\t\t\t\t\tconst currentSelectableIndex = selectableOptions.findIndex(\n\t\t\t\t\t\t\t\t(option) => option === options[prevIndex],\n\t\t\t\t\t\t\t)\n\n\t\t\t\t\t\t\tconst newSelectableIndex =\n\t\t\t\t\t\t\t\t(currentSelectableIndex + direction + selectableOptions.length) %\n\t\t\t\t\t\t\t\tselectableOptions.length\n\n\t\t\t\t\t\t\t// Find the index of the selected option in the original options array\n\t\t\t\t\t\t\treturn options.findIndex((option) => option === selectableOptions[newSelectableIndex])\n\t\t\t\t\t\t})\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tif ((event.key === \"Enter\" || event.key === \"Tab\") && selectedMenuIndex !== -1) {\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t\tconst selectedOption = getContextMenuOptions(searchQuery, selectedType, queryItems)[\n\t\t\t\t\t\t\tselectedMenuIndex\n\t\t\t\t\t\t]\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tselectedOption &&\n\t\t\t\t\t\t\tselectedOption.type !== ContextMenuOptionType.URL &&\n\t\t\t\t\t\t\tselectedOption.type !== ContextMenuOptionType.NoResults\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\thandleMentionSelect(selectedOption.type, selectedOption.value)\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst isComposing = event.nativeEvent?.isComposing ?? false\n\t\t\t\tif (event.key === \"Enter\" && !event.shiftKey && !isComposing) {\n\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\tonSend()\n\t\t\t\t}\n\n\t\t\t\tif (event.key === \"Backspace\" && !isComposing) {\n\t\t\t\t\tconst charBeforeCursor = inputValue[cursorPosition - 1]\n\t\t\t\t\tconst charAfterCursor = inputValue[cursorPosition + 1]\n\n\t\t\t\t\tconst charBeforeIsWhitespace =\n\t\t\t\t\t\tcharBeforeCursor === \" \" || charBeforeCursor === \"\\n\" || charBeforeCursor === \"\\r\\n\"\n\t\t\t\t\tconst charAfterIsWhitespace =\n\t\t\t\t\t\tcharAfterCursor === \" \" || charAfterCursor === \"\\n\" || charAfterCursor === \"\\r\\n\"\n\t\t\t\t\t// checks if char before cusor is whitespace after a mention\n\t\t\t\t\tif (\n\t\t\t\t\t\tcharBeforeIsWhitespace &&\n\t\t\t\t\t\tinputValue.slice(0, cursorPosition - 1).match(new RegExp(mentionRegex.source + \"$\")) // \"$\" is added to ensure the match occurs at the end of the string\n\t\t\t\t\t) {\n\t\t\t\t\t\tconst newCursorPosition = cursorPosition - 1\n\t\t\t\t\t\t// if mention is followed by another word, then instead of deleting the space separating them we just move the cursor to the end of the mention\n\t\t\t\t\t\tif (!charAfterIsWhitespace) {\n\t\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t\t\ttextAreaRef.current?.setSelectionRange(newCursorPosition, newCursorPosition)\n\t\t\t\t\t\t\tsetCursorPosition(newCursorPosition)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsetCursorPosition(newCursorPosition)\n\t\t\t\t\t\tsetJustDeletedSpaceAfterMention(true)\n\t\t\t\t\t} else if (justDeletedSpaceAfterMention) {\n\t\t\t\t\t\tconst { newText, newPosition } = removeMention(inputValue, cursorPosition)\n\t\t\t\t\t\tif (newText !== inputValue) {\n\t\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t\t\tsetInputValue(newText)\n\t\t\t\t\t\t\tsetIntendedCursorPosition(newPosition) // Store the new cursor position in state\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsetJustDeletedSpaceAfterMention(false)\n\t\t\t\t\t\tsetShowContextMenu(false)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tsetJustDeletedSpaceAfterMention(false)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t[\n\t\t\t\tonSend,\n\t\t\t\tshowContextMenu,\n\t\t\t\tsearchQuery,\n\t\t\t\tselectedMenuIndex,\n\t\t\t\thandleMentionSelect,\n\t\t\t\tselectedType,\n\t\t\t\tinputValue,\n\t\t\t\tcursorPosition,\n\t\t\t\tsetInputValue,\n\t\t\t\tjustDeletedSpaceAfterMention,\n\t\t\t\tqueryItems,\n\t\t\t],\n\t\t)\n\n\t\tuseLayoutEffect(() => {\n\t\t\tif (intendedCursorPosition !== null && textAreaRef.current) {\n\t\t\t\ttextAreaRef.current.setSelectionRange(intendedCursorPosition, intendedCursorPosition)\n\t\t\t\tsetIntendedCursorPosition(null) // Reset the state\n\t\t\t}\n\t\t}, [inputValue, intendedCursorPosition])\n\n\t\tconst handleInputChange = useCallback(\n\t\t\t(e: React.ChangeEvent<HTMLTextAreaElement>) => {\n\t\t\t\tconst newValue = e.target.value\n\t\t\t\tconst newCursorPosition = e.target.selectionStart\n\t\t\t\tsetInputValue(newValue)\n\t\t\t\tsetCursorPosition(newCursorPosition)\n\t\t\t\tconst showMenu = shouldShowContextMenu(newValue, newCursorPosition)\n\n\t\t\t\tsetShowContextMenu(showMenu)\n\t\t\t\tif (showMenu) {\n\t\t\t\t\tconst lastAtIndex = newValue.lastIndexOf(\"@\", newCursorPosition - 1)\n\t\t\t\t\tconst query = newValue.slice(lastAtIndex + 1, newCursorPosition)\n\t\t\t\t\tsetSearchQuery(query)\n\t\t\t\t\tif (query.length > 0) {\n\t\t\t\t\t\tsetSelectedMenuIndex(0)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tsetSelectedMenuIndex(3) // Set to \"File\" option by default\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tsetSearchQuery(\"\")\n\t\t\t\t\tsetSelectedMenuIndex(-1)\n\t\t\t\t}\n\t\t\t},\n\t\t\t[setInputValue],\n\t\t)\n\n\t\tuseEffect(() => {\n\t\t\tif (!showContextMenu) {\n\t\t\t\tsetSelectedType(null)\n\t\t\t}\n\t\t}, [showContextMenu])\n\n\t\tconst handleBlur = useCallback(() => {\n\t\t\t// Only hide the context menu if the user didn't click on it\n\t\t\tif (!isMouseDownOnMenu) {\n\t\t\t\tsetShowContextMenu(false)\n\t\t\t}\n\t\t\tsetIsTextAreaFocused(false)\n\t\t}, [isMouseDownOnMenu])\n\n\t\tconst handlePaste = useCallback(\n\t\t\tasync (e: React.ClipboardEvent) => {\n\t\t\t\tconst items = e.clipboardData.items\n\n\t\t\t\tconst pastedText = e.clipboardData.getData(\"text\")\n\t\t\t\t// Check if the pasted content is a URL, add space after so user can easily delete if they don't want it\n\t\t\t\tconst urlRegex = /^\\S+:\\/\\/\\S+$/\n\t\t\t\tif (urlRegex.test(pastedText.trim())) {\n\t\t\t\t\te.preventDefault()\n\t\t\t\t\tconst trimmedUrl = pastedText.trim()\n\t\t\t\t\tconst newValue =\n\t\t\t\t\t\tinputValue.slice(0, cursorPosition) + trimmedUrl + \" \" + inputValue.slice(cursorPosition)\n\t\t\t\t\tsetInputValue(newValue)\n\t\t\t\t\tconst newCursorPosition = cursorPosition + trimmedUrl.length + 1\n\t\t\t\t\tsetCursorPosition(newCursorPosition)\n\t\t\t\t\tsetIntendedCursorPosition(newCursorPosition)\n\t\t\t\t\tsetShowContextMenu(false)\n\n\t\t\t\t\t// Scroll to new cursor position\n\t\t\t\t\t// https://stackoverflow.com/questions/29899364/how-do-you-scroll-to-the-position-of-the-cursor-in-a-textarea/40951875#40951875\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tif (textAreaRef.current) {\n\t\t\t\t\t\t\ttextAreaRef.current.blur()\n\t\t\t\t\t\t\ttextAreaRef.current.focus()\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 0)\n\t\t\t\t\t// NOTE: callbacks dont utilize return function to cleanup, but it's fine since this timeout immediately executes and will be cleaned up by the browser (no chance component unmounts before it executes)\n\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tconst acceptedTypes = [\"png\", \"jpeg\", \"webp\"] // supported by anthropic and openrouter (jpg is just a file extension but the image will be recognized as jpeg)\n\t\t\t\tconst imageItems = Array.from(items).filter((item) => {\n\t\t\t\t\tconst [type, subtype] = item.type.split(\"/\")\n\t\t\t\t\treturn type === \"image\" && acceptedTypes.includes(subtype)\n\t\t\t\t})\n\t\t\t\tif (!shouldDisableImages && imageItems.length > 0) {\n\t\t\t\t\te.preventDefault()\n\t\t\t\t\tconst imagePromises = imageItems.map((item) => {\n\t\t\t\t\t\treturn new Promise<string | null>((resolve) => {\n\t\t\t\t\t\t\tconst blob = item.getAsFile()\n\t\t\t\t\t\t\tif (!blob) {\n\t\t\t\t\t\t\t\tresolve(null)\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst reader = new FileReader()\n\t\t\t\t\t\t\treader.onloadend = () => {\n\t\t\t\t\t\t\t\tif (reader.error) {\n\t\t\t\t\t\t\t\t\tconsole.error(\"Error reading file:\", reader.error)\n\t\t\t\t\t\t\t\t\tresolve(null)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tconst result = reader.result\n\t\t\t\t\t\t\t\t\tresolve(typeof result === \"string\" ? result : null)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treader.readAsDataURL(blob)\n\t\t\t\t\t\t})\n\t\t\t\t\t})\n\t\t\t\t\tconst imageDataArray = await Promise.all(imagePromises)\n\t\t\t\t\tconst dataUrls = imageDataArray.filter((dataUrl): dataUrl is string => dataUrl !== null)\n\t\t\t\t\t//.map((dataUrl) => dataUrl.split(\",\")[1]) // strip the mime type prefix, sharp doesn't need it\n\t\t\t\t\tif (dataUrls.length > 0) {\n\t\t\t\t\t\tsetSelectedImages((prevImages) => [...prevImages, ...dataUrls].slice(0, MAX_IMAGES_PER_MESSAGE))\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn(\"No valid images were processed\")\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t[shouldDisableImages, setSelectedImages, cursorPosition, setInputValue, inputValue],\n\t\t)\n\n\t\tconst handleThumbnailsHeightChange = useCallback((height: number) => {\n\t\t\tsetThumbnailsHeight(height)\n\t\t}, [])\n\n\t\tuseEffect(() => {\n\t\t\tif (selectedImages.length === 0) {\n\t\t\t\tsetThumbnailsHeight(0)\n\t\t\t}\n\t\t}, [selectedImages])\n\n\t\tconst handleMenuMouseDown = useCallback(() => {\n\t\t\tsetIsMouseDownOnMenu(true)\n\t\t}, [])\n\n\t\tconst updateHighlights = useCallback(() => {\n\t\t\tif (!textAreaRef.current || !highlightLayerRef.current) return\n\n\t\t\tconst text = textAreaRef.current.value\n\n\t\t\thighlightLayerRef.current.innerHTML = text\n\t\t\t\t.replace(/\\n$/, \"\\n\\n\")\n\t\t\t\t.replace(/[<>&]/g, (c) => ({ \"<\": \"&lt;\", \">\": \"&gt;\", \"&\": \"&amp;\" })[c] || c)\n\t\t\t\t.replace(mentionRegexGlobal, '<mark class=\"mention-context-textarea-highlight\">$&</mark>')\n\n\t\t\thighlightLayerRef.current.scrollTop = textAreaRef.current.scrollTop\n\t\t\thighlightLayerRef.current.scrollLeft = textAreaRef.current.scrollLeft\n\t\t}, [])\n\n\t\tuseLayoutEffect(() => {\n\t\t\tupdateHighlights()\n\t\t}, [inputValue, updateHighlights])\n\n\t\tconst updateCursorPosition = useCallback(() => {\n\t\t\tif (textAreaRef.current) {\n\t\t\t\tsetCursorPosition(textAreaRef.current.selectionStart)\n\t\t\t}\n\t\t}, [])\n\n\t\tconst handleKeyUp = useCallback(\n\t\t\t(e: React.KeyboardEvent<HTMLTextAreaElement>) => {\n\t\t\t\tif ([\"ArrowLeft\", \"ArrowRight\", \"ArrowUp\", \"ArrowDown\", \"Home\", \"End\"].includes(e.key)) {\n\t\t\t\t\tupdateCursorPosition()\n\t\t\t\t}\n\t\t\t},\n\t\t\t[updateCursorPosition],\n\t\t)\n\n\t\treturn (\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tpadding: \"10px 15px\",\n\t\t\t\t\topacity: textAreaDisabled ? 0.5 : 1,\n\t\t\t\t\tposition: \"relative\",\n\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t}}>\n\t\t\t\t{showContextMenu && (\n\t\t\t\t\t<div ref={contextMenuContainerRef}>\n\t\t\t\t\t\t<ContextMenu\n\t\t\t\t\t\t\tonSelect={handleMentionSelect}\n\t\t\t\t\t\t\tsearchQuery={searchQuery}\n\t\t\t\t\t\t\tonMouseDown={handleMenuMouseDown}\n\t\t\t\t\t\t\tselectedIndex={selectedMenuIndex}\n\t\t\t\t\t\t\tsetSelectedIndex={setSelectedMenuIndex}\n\t\t\t\t\t\t\tselectedType={selectedType}\n\t\t\t\t\t\t\tqueryItems={queryItems}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t\t{!isTextAreaFocused && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\t\tinset: \"10px 15px\",\n\t\t\t\t\t\t\tborder: \"1px solid var(--vscode-input-border)\",\n\t\t\t\t\t\t\tborderRadius: 2,\n\t\t\t\t\t\t\tpointerEvents: \"none\",\n\t\t\t\t\t\t\tzIndex: 5,\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t\t<div\n\t\t\t\t\tref={highlightLayerRef}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\ttop: 10,\n\t\t\t\t\t\tleft: 15,\n\t\t\t\t\t\tright: 15,\n\t\t\t\t\t\tbottom: 10,\n\t\t\t\t\t\tpointerEvents: \"none\",\n\t\t\t\t\t\twhiteSpace: \"pre-wrap\",\n\t\t\t\t\t\twordWrap: \"break-word\",\n\t\t\t\t\t\tcolor: \"transparent\",\n\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\tbackgroundColor: \"var(--vscode-input-background)\",\n\t\t\t\t\t\tfontFamily: \"var(--vscode-font-family)\",\n\t\t\t\t\t\tfontSize: \"var(--vscode-editor-font-size)\",\n\t\t\t\t\t\tlineHeight: \"var(--vscode-editor-line-height)\",\n\t\t\t\t\t\tborderRadius: 2,\n\t\t\t\t\t\tborderLeft: 0,\n\t\t\t\t\t\tborderRight: 0,\n\t\t\t\t\t\tborderTop: 0,\n\t\t\t\t\t\tborderColor: \"transparent\",\n\t\t\t\t\t\tborderBottom: `${thumbnailsHeight + 6}px solid transparent`,\n\t\t\t\t\t\tpadding: \"9px 49px 3px 9px\",\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t\t<DynamicTextArea\n\t\t\t\t\tref={(el) => {\n\t\t\t\t\t\tif (typeof ref === \"function\") {\n\t\t\t\t\t\t\tref(el)\n\t\t\t\t\t\t} else if (ref) {\n\t\t\t\t\t\t\tref.current = el\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttextAreaRef.current = el\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={inputValue}\n\t\t\t\t\tdisabled={textAreaDisabled}\n\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\thandleInputChange(e)\n\t\t\t\t\t\tupdateHighlights()\n\t\t\t\t\t}}\n\t\t\t\t\tonKeyDown={handleKeyDown}\n\t\t\t\t\tonKeyUp={handleKeyUp}\n\t\t\t\t\tonFocus={() => setIsTextAreaFocused(true)}\n\t\t\t\t\tonBlur={handleBlur}\n\t\t\t\t\tonPaste={handlePaste}\n\t\t\t\t\tonSelect={updateCursorPosition}\n\t\t\t\t\tonMouseUp={updateCursorPosition}\n\t\t\t\t\tonHeightChange={(height) => {\n\t\t\t\t\t\tif (textAreaBaseHeight === undefined || height < textAreaBaseHeight) {\n\t\t\t\t\t\t\tsetTextAreaBaseHeight(height)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tonHeightChange?.(height)\n\t\t\t\t\t}}\n\t\t\t\t\tplaceholder={placeholderText}\n\t\t\t\t\tmaxRows={10}\n\t\t\t\t\tautoFocus={true}\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\twidth: \"100%\",\n\t\t\t\t\t\tboxSizing: \"border-box\",\n\t\t\t\t\t\tbackgroundColor: \"transparent\",\n\t\t\t\t\t\tcolor: \"var(--vscode-input-foreground)\",\n\t\t\t\t\t\t//border: \"1px solid var(--vscode-input-border)\",\n\t\t\t\t\t\tborderRadius: 2,\n\t\t\t\t\t\tfontFamily: \"var(--vscode-font-family)\",\n\t\t\t\t\t\tfontSize: \"var(--vscode-editor-font-size)\",\n\t\t\t\t\t\tlineHeight: \"var(--vscode-editor-line-height)\",\n\t\t\t\t\t\tresize: \"none\",\n\t\t\t\t\t\toverflowX: \"hidden\",\n\t\t\t\t\t\toverflowY: \"scroll\",\n\t\t\t\t\t\tscrollbarWidth: \"none\",\n\t\t\t\t\t\t// Since we have maxRows, when text is long enough it starts to overflow the bottom padding, appearing behind the thumbnails. To fix this, we use a transparent border to push the text up instead. (https://stackoverflow.com/questions/42631947/maintaining-a-padding-inside-of-text-area/52538410#52538410)\n\t\t\t\t\t\t// borderTop: \"9px solid transparent\",\n\t\t\t\t\t\tborderLeft: 0,\n\t\t\t\t\t\tborderRight: 0,\n\t\t\t\t\t\tborderTop: 0,\n\t\t\t\t\t\tborderBottom: `${thumbnailsHeight + 6}px solid transparent`,\n\t\t\t\t\t\tborderColor: \"transparent\",\n\t\t\t\t\t\t// borderRight: \"54px solid transparent\",\n\t\t\t\t\t\t// borderLeft: \"9px solid transparent\", // NOTE: react-textarea-autosize doesn't calculate correct height when using borderLeft/borderRight so we need to use horizontal padding instead\n\t\t\t\t\t\t// Instead of using boxShadow, we use a div with a border to better replicate the behavior when the textarea is focused\n\t\t\t\t\t\t// boxShadow: \"0px 0px 0px 1px var(--vscode-input-border)\",\n\t\t\t\t\t\tpadding: \"9px 49px 3px 9px\",\n\t\t\t\t\t\tcursor: textAreaDisabled ? \"not-allowed\" : undefined,\n\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\tzIndex: 1,\n\t\t\t\t\t}}\n\t\t\t\t\tonScroll={() => updateHighlights()}\n\t\t\t\t/>\n\t\t\t\t{selectedImages.length > 0 && (\n\t\t\t\t\t<Thumbnails\n\t\t\t\t\t\timages={selectedImages}\n\t\t\t\t\t\tsetImages={setSelectedImages}\n\t\t\t\t\t\tonHeightChange={handleThumbnailsHeightChange}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\t\tpaddingTop: 4,\n\t\t\t\t\t\t\tbottom: 14,\n\t\t\t\t\t\t\tleft: 22,\n\t\t\t\t\t\t\tright: 67, // (54 + 9) + 4 extra padding\n\t\t\t\t\t\t\tzIndex: 2,\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\tright: 23,\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\talignItems: \"flex-center\",\n\t\t\t\t\t\theight: textAreaBaseHeight || 31,\n\t\t\t\t\t\tbottom: 9.5, // should be 10 but doesnt look good on mac\n\t\t\t\t\t\tzIndex: 2,\n\t\t\t\t\t}}>\n\t\t\t\t\t<div style={{ display: \"flex\", flexDirection: \"row\", alignItems: \"center\" }}>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclassName={`input-icon-button ${\n\t\t\t\t\t\t\t\tshouldDisableImages ? \"disabled\" : \"\"\n\t\t\t\t\t\t\t} codicon codicon-device-camera`}\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!shouldDisableImages) {\n\t\t\t\t\t\t\t\t\tonSelectImages()\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginRight: 5.5,\n\t\t\t\t\t\t\t\tfontSize: 16.5,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclassName={`input-icon-button ${textAreaDisabled ? \"disabled\" : \"\"} codicon codicon-send`}\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tif (!textAreaDisabled) {\n\t\t\t\t\t\t\t\t\tonSend()\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{ fontSize: 15 }}></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t)\n\t},\n)\n\nexport default ChatTextArea\n", "tag": "", "tokens": 5815, "metadata": {}}], "modify_time": 1733144568.737472}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/TaskHeader.tsx", "relative_path": "cline/webview-ui/src/components/chat/TaskHeader.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/TaskHeader.tsx", "source_code": "import { VSCodeButton } from \"@vscode/webview-ui-toolkit/react\"\nimport React, { memo, useEffect, useMemo, useRef, useState } from \"react\"\nimport { useWindowSize } from \"react-use\"\nimport { ClineMessage } from \"../../../../src/shared/ExtensionMessage\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport { vscode } from \"../../utils/vscode\"\nimport Thumbnails from \"../common/Thumbnails\"\nimport { mentionRegexGlobal } from \"../../../../src/shared/context-mentions\"\nimport { formatLargeNumber } from \"../../utils/format\"\n\ninterface TaskHeaderProps {\n\ttask: ClineMessage\n\ttokensIn: number\n\ttokensOut: number\n\tdoesModelSupportPromptCache: boolean\n\tcacheWrites?: number\n\tcacheReads?: number\n\ttotalCost: number\n\tonClose: () => void\n}\n\nconst TaskHeader: React.FC<TaskHeaderProps> = ({\n\ttask,\n\ttokensIn,\n\ttokensOut,\n\tdoesModelSupportPromptCache,\n\tcacheWrites,\n\tcacheReads,\n\ttotalCost,\n\tonClose,\n}) => {\n\tconst { apiConfiguration } = useExtensionState()\n\tconst [isTaskExpanded, setIsTaskExpanded] = useState(true)\n\tconst [isTextExpanded, setIsTextExpanded] = useState(false)\n\tconst [showSeeMore, setShowSeeMore] = useState(false)\n\tconst textContainerRef = useRef<HTMLDivElement>(null)\n\tconst textRef = useRef<HTMLDivElement>(null)\n\n\t/*\n\tWhen dealing with event listeners in React components that depend on state variables, we face a challenge. We want our listener to always use the most up-to-date version of a callback function that relies on current state, but we don't want to constantly add and remove event listeners as that function updates. This scenario often arises with resize listeners or other window events. Simply adding the listener in a useEffect with an empty dependency array risks using stale state, while including the callback in the dependencies can lead to unnecessary re-registrations of the listener. There are react hook libraries that provide a elegant solution to this problem by utilizing the useRef hook to maintain a reference to the latest callback function without triggering re-renders or effect re-runs. This approach ensures that our event listener always has access to the most current state while minimizing performance overhead and potential memory leaks from multiple listener registrations. \n\tSources\n\t- https://usehooks-ts.com/react-hook/use-event-listener\n\t- https://streamich.github.io/react-use/?path=/story/sensors-useevent--docs\n\t- https://github.com/streamich/react-use/blob/master/src/useEvent.ts\n\t- https://stackoverflow.com/questions/55565444/how-to-register-event-with-useeffect-hooks\n\n\tBefore:\n\t\n\tconst updateMaxHeight = useCallback(() => {\n\t\tif (isExpanded && textContainerRef.current) {\n\t\t\tconst maxHeight = window.innerHeight * (3 / 5)\n\t\t\ttextContainerRef.current.style.maxHeight = `${maxHeight}px`\n\t\t}\n\t}, [isExpanded])\n\n\tuseEffect(() => {\n\t\tupdateMaxHeight()\n\t}, [isExpanded, updateMaxHeight])\n\n\tuseEffect(() => {\n\t\twindow.removeEventListener(\"resize\", updateMaxHeight)\n\t\twindow.addEventListener(\"resize\", updateMaxHeight)\n\t\treturn () => {\n\t\t\twindow.removeEventListener(\"resize\", updateMaxHeight)\n\t\t}\n\t}, [updateMaxHeight])\n\n\tAfter:\n\t*/\n\n\tconst { height: windowHeight, width: windowWidth } = useWindowSize()\n\n\tuseEffect(() => {\n\t\tif (isTextExpanded && textContainerRef.current) {\n\t\t\tconst maxHeight = windowHeight * (1 / 2)\n\t\t\ttextContainerRef.current.style.maxHeight = `${maxHeight}px`\n\t\t}\n\t}, [isTextExpanded, windowHeight])\n\n\tuseEffect(() => {\n\t\tif (textRef.current && textContainerRef.current) {\n\t\t\tlet textContainerHeight = textContainerRef.current.clientHeight\n\t\t\tif (!textContainerHeight) {\n\t\t\t\ttextContainerHeight = textContainerRef.current.getBoundingClientRect().height\n\t\t\t}\n\t\t\tconst isOverflowing = textRef.current.scrollHeight > textContainerHeight\n\t\t\t// necessary to show see more button again if user resizes window to expand and then back to collapse\n\t\t\tif (!isOverflowing) {\n\t\t\t\tsetIsTextExpanded(false)\n\t\t\t}\n\t\t\tsetShowSeeMore(isOverflowing)\n\t\t}\n\t}, [task.text, windowWidth])\n\n\tconst isCostAvailable = useMemo(() => {\n\t\treturn (\n\t\t\tapiConfiguration?.apiProvider !== \"openai\" &&\n\t\t\tapiConfiguration?.apiProvider !== \"ollama\" &&\n\t\t\tapiConfiguration?.apiProvider !== \"lmstudio\" &&\n\t\t\tapiConfiguration?.apiProvider !== \"gemini\"\n\t\t)\n\t}, [apiConfiguration?.apiProvider])\n\n\tconst shouldShowPromptCacheInfo = doesModelSupportPromptCache && apiConfiguration?.apiProvider !== \"openrouter\"\n\n\treturn (\n\t\t<div style={{ padding: \"10px 13px 10px 13px\" }}>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tbackgroundColor: \"var(--vscode-badge-background)\",\n\t\t\t\t\tcolor: \"var(--vscode-badge-foreground)\",\n\t\t\t\t\tborderRadius: \"3px\",\n\t\t\t\t\tpadding: \"9px 10px 9px 14px\",\n\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\tflexDirection: \"column\",\n\t\t\t\t\tgap: 6,\n\t\t\t\t\tposition: \"relative\",\n\t\t\t\t\tzIndex: 1,\n\t\t\t\t}}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t}}>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\tmarginLeft: -2,\n\t\t\t\t\t\t\tuserSelect: \"none\",\n\t\t\t\t\t\t\tWebkitUserSelect: \"none\",\n\t\t\t\t\t\t\tMozUserSelect: \"none\",\n\t\t\t\t\t\t\tmsUserSelect: \"none\",\n\t\t\t\t\t\t\tflexGrow: 1,\n\t\t\t\t\t\t\tminWidth: 0, // This allows the div to shrink below its content size\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tonClick={() => setIsTaskExpanded(!isTaskExpanded)}>\n\t\t\t\t\t\t<div style={{ display: \"flex\", alignItems: \"center\", flexShrink: 0 }}>\n\t\t\t\t\t\t\t<span className={`codicon codicon-chevron-${isTaskExpanded ? \"down\" : \"right\"}`}></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginLeft: 6,\n\t\t\t\t\t\t\t\twhiteSpace: \"nowrap\",\n\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\ttextOverflow: \"ellipsis\",\n\t\t\t\t\t\t\t\tflexGrow: 1,\n\t\t\t\t\t\t\t\tminWidth: 0, // This allows the div to shrink below its content size\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>Task{!isTaskExpanded && \":\"}</span>\n\t\t\t\t\t\t\t{!isTaskExpanded && (\n\t\t\t\t\t\t\t\t<span style={{ marginLeft: 4 }}>{highlightMentions(task.text, false)}</span>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t{!isTaskExpanded && isCostAvailable && (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginLeft: 10,\n\t\t\t\t\t\t\t\tbackgroundColor: \"color-mix(in srgb, var(--vscode-badge-foreground) 70%, transparent)\",\n\t\t\t\t\t\t\t\tcolor: \"var(--vscode-badge-background)\",\n\t\t\t\t\t\t\t\tpadding: \"2px 4px\",\n\t\t\t\t\t\t\t\tborderRadius: \"500px\",\n\t\t\t\t\t\t\t\tfontSize: \"11px\",\n\t\t\t\t\t\t\t\tfontWeight: 500,\n\t\t\t\t\t\t\t\tdisplay: \"inline-block\",\n\t\t\t\t\t\t\t\tflexShrink: 0,\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t${totalCost?.toFixed(4)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t\t<VSCodeButton appearance=\"icon\" onClick={onClose} style={{ marginLeft: 6, flexShrink: 0 }}>\n\t\t\t\t\t\t<span className=\"codicon codicon-close\"></span>\n\t\t\t\t\t</VSCodeButton>\n\t\t\t\t</div>\n\t\t\t\t{isTaskExpanded && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tref={textContainerRef}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: -2,\n\t\t\t\t\t\t\t\tfontSize: \"var(--vscode-font-size)\",\n\t\t\t\t\t\t\t\toverflowY: isTextExpanded ? \"auto\" : \"hidden\",\n\t\t\t\t\t\t\t\twordBreak: \"break-word\",\n\t\t\t\t\t\t\t\toverflowWrap: \"anywhere\",\n\t\t\t\t\t\t\t\tposition: \"relative\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tref={textRef}\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: \"-webkit-box\",\n\t\t\t\t\t\t\t\t\tWebkitLineClamp: isTextExpanded ? \"unset\" : 3,\n\t\t\t\t\t\t\t\t\tWebkitBoxOrient: \"vertical\",\n\t\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\t\twhiteSpace: \"pre-wrap\",\n\t\t\t\t\t\t\t\t\twordBreak: \"break-word\",\n\t\t\t\t\t\t\t\t\toverflowWrap: \"anywhere\",\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t{highlightMentions(task.text, false)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{!isTextExpanded && showSeeMore && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\t\t\t\t\tright: 0,\n\t\t\t\t\t\t\t\t\t\tbottom: 0,\n\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\twidth: 30,\n\t\t\t\t\t\t\t\t\t\t\theight: \"1.2em\",\n\t\t\t\t\t\t\t\t\t\t\tbackground:\n\t\t\t\t\t\t\t\t\t\t\t\t\"linear-gradient(to right, transparent, var(--vscode-badge-background))\",\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-textLink-foreground)\",\n\t\t\t\t\t\t\t\t\t\t\tpaddingRight: 0,\n\t\t\t\t\t\t\t\t\t\t\tpaddingLeft: 3,\n\t\t\t\t\t\t\t\t\t\t\tbackgroundColor: \"var(--vscode-badge-background)\",\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonClick={() => setIsTextExpanded(!isTextExpanded)}>\n\t\t\t\t\t\t\t\t\t\tSee more\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{isTextExpanded && showSeeMore && (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-textLink-foreground)\",\n\t\t\t\t\t\t\t\t\tmarginLeft: \"auto\",\n\t\t\t\t\t\t\t\t\ttextAlign: \"right\",\n\t\t\t\t\t\t\t\t\tpaddingRight: 2,\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonClick={() => setIsTextExpanded(!isTextExpanded)}>\n\t\t\t\t\t\t\t\tSee less\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{task.images && task.images.length > 0 && <Thumbnails images={task.images} />}\n\t\t\t\t\t\t<div style={{ display: \"flex\", flexDirection: \"column\", gap: \"4px\" }}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t<div style={{ display: \"flex\", alignItems: \"center\", gap: \"4px\", flexWrap: \"wrap\" }}>\n\t\t\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>Tokens:</span>\n\t\t\t\t\t\t\t\t\t<span style={{ display: \"flex\", alignItems: \"center\", gap: \"3px\" }}>\n\t\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-arrow-up\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ fontSize: \"12px\", fontWeight: \"bold\", marginBottom: \"-2px\" }}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t{formatLargeNumber(tokensIn || 0)}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t<span style={{ display: \"flex\", alignItems: \"center\", gap: \"3px\" }}>\n\t\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-arrow-down\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ fontSize: \"12px\", fontWeight: \"bold\", marginBottom: \"-2px\" }}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t{formatLargeNumber(tokensOut || 0)}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t{!isCostAvailable && <ExportButton />}\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t{shouldShowPromptCacheInfo && (cacheReads !== undefined || cacheWrites !== undefined) && (\n\t\t\t\t\t\t\t\t<div style={{ display: \"flex\", alignItems: \"center\", gap: \"4px\", flexWrap: \"wrap\" }}>\n\t\t\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>Cache:</span>\n\t\t\t\t\t\t\t\t\t<span style={{ display: \"flex\", alignItems: \"center\", gap: \"3px\" }}>\n\t\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-database\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ fontSize: \"12px\", fontWeight: \"bold\", marginBottom: \"-1px\" }}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t+{formatLargeNumber(cacheWrites || 0)}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t<span style={{ display: \"flex\", alignItems: \"center\", gap: \"3px\" }}>\n\t\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-arrow-right\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ fontSize: \"12px\", fontWeight: \"bold\", marginBottom: 0 }}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t{formatLargeNumber(cacheReads || 0)}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t{isCostAvailable && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t<div style={{ display: \"flex\", alignItems: \"center\", gap: \"4px\" }}>\n\t\t\t\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>API Cost:</span>\n\t\t\t\t\t\t\t\t\t\t<span>${totalCost?.toFixed(4)}</span>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<ExportButton />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t\t{/* {apiProvider === \"\" && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tbackgroundColor: \"color-mix(in srgb, var(--vscode-badge-background) 50%, transparent)\",\n\t\t\t\t\t\tcolor: \"var(--vscode-badge-foreground)\",\n\t\t\t\t\t\tborderRadius: \"0 0 3px 3px\",\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\tpadding: \"4px 12px 6px 12px\",\n\t\t\t\t\t\tfontSize: \"0.9em\",\n\t\t\t\t\t\tmarginLeft: \"10px\",\n\t\t\t\t\t\tmarginRight: \"10px\",\n\t\t\t\t\t}}>\n\t\t\t\t\t<div style={{ fontWeight: \"500\" }}>Credits Remaining:</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t{formatPrice(Credits || 0)}\n\t\t\t\t\t\t{(Credits || 0) < 1 && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t{\" \"}\n\t\t\t\t\t\t\t\t<VSCodeLink style={{ fontSize: \"0.9em\" }} href={getAddCreditsUrl(vscodeUriScheme)}>\n\t\t\t\t\t\t\t\t\t(get more?)\n\t\t\t\t\t\t\t\t</VSCodeLink>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)} */}\n\t\t</div>\n\t)\n}\n\nexport const highlightMentions = (text?: string, withShadow = true) => {\n\tif (!text) return text\n\tconst parts = text.split(mentionRegexGlobal)\n\treturn parts.map((part, index) => {\n\t\tif (index % 2 === 0) {\n\t\t\t// This is regular text\n\t\t\treturn part\n\t\t} else {\n\t\t\t// This is a mention\n\t\t\treturn (\n\t\t\t\t<span\n\t\t\t\t\tkey={index}\n\t\t\t\t\tclassName={withShadow ? \"mention-context-highlight-with-shadow\" : \"mention-context-highlight\"}\n\t\t\t\t\tstyle={{ cursor: \"pointer\" }}\n\t\t\t\t\tonClick={() => vscode.postMessage({ type: \"openMention\", text: part })}>\n\t\t\t\t\t@{part}\n\t\t\t\t</span>\n\t\t\t)\n\t\t}\n\t})\n}\n\nconst ExportButton = () => (\n\t<VSCodeButton\n\t\tappearance=\"icon\"\n\t\tonClick={() => vscode.postMessage({ type: \"exportCurrentTask\" })}\n\t\tstyle={\n\t\t\t{\n\t\t\t\t// marginBottom: \"-2px\",\n\t\t\t\t// marginRight: \"-2.5px\",\n\t\t\t}\n\t\t}>\n\t\t<div style={{ fontSize: \"10.5px\", fontWeight: \"bold\", opacity: 0.6 }}>EXPORT</div>\n\t</VSCodeButton>\n)\n\nexport default memo(TaskHeader)\n", "tag": "", "tokens": 3874, "metadata": {}}], "modify_time": 1733144568.7380419}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/ChatRow.tsx", "relative_path": "cline/webview-ui/src/components/chat/ChatRow.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/ChatRow.tsx", "source_code": "import { VSCodeBadge, VSCodeProgressRing } from \"@vscode/webview-ui-toolkit/react\"\nimport deepEqual from \"fast-deep-equal\"\nimport React, { memo, useEffect, useMemo, useRef } from \"react\"\nimport { useSize } from \"react-use\"\nimport { ClineApiReqInfo, ClineMessage, ClineSayTool } from \"../../../../src/shared/ExtensionMessage\"\nimport { COMMAND_OUTPUT_STRING } from \"../../../../src/shared/combineCommandSequences\"\nimport { vscode } from \"../../utils/vscode\"\nimport CodeAccordian, { removeLeadingNonAlphanumeric } from \"../common/CodeAccordian\"\nimport CodeBlock, { CODE_BLOCK_BG_COLOR } from \"../common/CodeBlock\"\nimport MarkdownBlock from \"../common/MarkdownBlock\"\nimport Thumbnails from \"../common/Thumbnails\"\nimport { highlightMentions } from \"./TaskHeader\"\n\ninterface ChatRowProps {\n\tmessage: ClineMessage\n\tisExpanded: boolean\n\tonToggleExpand: () => void\n\tlastModifiedMessage?: ClineMessage\n\tisLast: boolean\n\tonHeightChange: (isTaller: boolean) => void\n}\n\ninterface ChatRowContentProps extends Omit<ChatRowProps, \"onHeightChange\"> {}\n\nconst ChatRow = memo(\n\t(props: ChatRowProps) => {\n\t\tconst { isLast, onHeightChange, message } = props\n\t\t// Store the previous height to compare with the current height\n\t\t// This allows us to detect changes without causing re-renders\n\t\tconst prevHeightRef = useRef(0)\n\n\t\tconst [chatrow, { height }] = useSize(\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tpadding: \"10px 6px 10px 15px\",\n\t\t\t\t}}>\n\t\t\t\t<ChatRowContent {...props} />\n\t\t\t</div>,\n\t\t)\n\n\t\tuseEffect(() => {\n\t\t\t// used for partials, command output, etc.\n\t\t\t// NOTE: it's important we don't distinguish between partial or complete here since our scroll effects in chatview need to handle height change during partial -> complete\n\t\t\tconst isInitialRender = prevHeightRef.current === 0 // prevents scrolling when new element is added since we already scroll for that\n\t\t\t// height starts off at Infinity\n\t\t\tif (isLast && height !== 0 && height !== Infinity && height !== prevHeightRef.current) {\n\t\t\t\tif (!isInitialRender) {\n\t\t\t\t\tonHeightChange(height > prevHeightRef.current)\n\t\t\t\t}\n\t\t\t\tprevHeightRef.current = height\n\t\t\t}\n\t\t}, [height, isLast, onHeightChange, message])\n\n\t\t// we cannot return null as virtuoso does not support it, so we use a separate visibleMessages array to filter out messages that should not be rendered\n\t\treturn chatrow\n\t},\n\t// memo does shallow comparison of props, so we need to do deep comparison of arrays/objects whose properties might change\n\tdeepEqual,\n)\n\nexport default ChatRow\n\nexport const ChatRowContent = ({\n\tmessage,\n\tisExpanded,\n\tonToggleExpand,\n\tlastModifiedMessage,\n\tisLast,\n}: ChatRowContentProps) => {\n\tconst [cost, apiReqCancelReason, apiReqStreamingFailedMessage] = useMemo(() => {\n\t\tif (message.text != null && message.say === \"api_req_started\") {\n\t\t\tconst info: ClineApiReqInfo = JSON.parse(message.text)\n\t\t\treturn [info.cost, info.cancelReason, info.streamingFailedMessage]\n\t\t}\n\t\treturn [undefined, undefined, undefined]\n\t}, [message.text, message.say])\n\t// when resuming task, last wont be api_req_failed but a resume_task message, so api_req_started will show loading spinner. that's why we just remove the last api_req_started that failed without streaming anything\n\tconst apiRequestFailedMessage =\n\t\tisLast && lastModifiedMessage?.ask === \"api_req_failed\" // if request is retried then the latest message is a api_req_retried\n\t\t\t? lastModifiedMessage?.text\n\t\t\t: undefined\n\tconst isCommandExecuting =\n\t\tisLast && lastModifiedMessage?.ask === \"command\" && lastModifiedMessage?.text?.includes(COMMAND_OUTPUT_STRING)\n\tconst type = message.type === \"ask\" ? message.ask : message.say\n\n\tconst normalColor = \"var(--vscode-foreground)\"\n\tconst errorColor = \"var(--vscode-errorForeground)\"\n\tconst successColor = \"var(--vscode-charts-green)\"\n\tconst cancelledColor = \"var(--vscode-descriptionForeground)\"\n\n\tconst [icon, title] = useMemo(() => {\n\t\tswitch (type) {\n\t\t\tcase \"error\":\n\t\t\t\treturn [\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName=\"codicon codicon-error\"\n\t\t\t\t\t\tstyle={{ color: errorColor, marginBottom: \"-1.5px\" }}></span>,\n\t\t\t\t\t<span style={{ color: errorColor, fontWeight: \"bold\" }}>Error</span>,\n\t\t\t\t]\n\t\t\tcase \"mistake_limit_reached\":\n\t\t\t\treturn [\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName=\"codicon codicon-error\"\n\t\t\t\t\t\tstyle={{ color: errorColor, marginBottom: \"-1.5px\" }}></span>,\n\t\t\t\t\t<span style={{ color: errorColor, fontWeight: \"bold\" }}>Cline is having trouble...</span>,\n\t\t\t\t]\n\t\t\tcase \"command\":\n\t\t\t\treturn [\n\t\t\t\t\tisCommandExecuting ? (\n\t\t\t\t\t\t<ProgressIndicator />\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tclassName=\"codicon codicon-terminal\"\n\t\t\t\t\t\t\tstyle={{ color: normalColor, marginBottom: \"-1.5px\" }}></span>\n\t\t\t\t\t),\n\t\t\t\t\t<span style={{ color: normalColor, fontWeight: \"bold\" }}>\n\t\t\t\t\t\tCline wants to execute this command:\n\t\t\t\t\t</span>,\n\t\t\t\t]\n\t\t\tcase \"completion_result\":\n\t\t\t\treturn [\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName=\"codicon codicon-check\"\n\t\t\t\t\t\tstyle={{ color: successColor, marginBottom: \"-1.5px\" }}></span>,\n\t\t\t\t\t<span style={{ color: successColor, fontWeight: \"bold\" }}>Task Completed</span>,\n\t\t\t\t]\n\t\t\tcase \"api_req_started\":\n\t\t\t\tconst getIconSpan = (iconName: string, color: string) => (\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\twidth: 16,\n\t\t\t\t\t\t\theight: 16,\n\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\tjustifyContent: \"center\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tclassName={`codicon codicon-${iconName}`}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tcolor,\n\t\t\t\t\t\t\t\tfontSize: 16,\n\t\t\t\t\t\t\t\tmarginBottom: \"-1.5px\",\n\t\t\t\t\t\t\t}}></span>\n\t\t\t\t\t</div>\n\t\t\t\t)\n\t\t\t\treturn [\n\t\t\t\t\tapiReqCancelReason != null ? (\n\t\t\t\t\t\tapiReqCancelReason === \"user_cancelled\" ? (\n\t\t\t\t\t\t\tgetIconSpan(\"error\", cancelledColor)\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\tgetIconSpan(\"error\", errorColor)\n\t\t\t\t\t\t)\n\t\t\t\t\t) : cost != null ? (\n\t\t\t\t\t\tgetIconSpan(\"check\", successColor)\n\t\t\t\t\t) : apiRequestFailedMessage ? (\n\t\t\t\t\t\tgetIconSpan(\"error\", errorColor)\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<ProgressIndicator />\n\t\t\t\t\t),\n\t\t\t\t\tapiReqCancelReason != null ? (\n\t\t\t\t\t\tapiReqCancelReason === \"user_cancelled\" ? (\n\t\t\t\t\t\t\t<span style={{ color: normalColor, fontWeight: \"bold\" }}>API Request Cancelled</span>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<span style={{ color: errorColor, fontWeight: \"bold\" }}>API Streaming Failed</span>\n\t\t\t\t\t\t)\n\t\t\t\t\t) : cost != null ? (\n\t\t\t\t\t\t<span style={{ color: normalColor, fontWeight: \"bold\" }}>API Request</span>\n\t\t\t\t\t) : apiRequestFailedMessage ? (\n\t\t\t\t\t\t<span style={{ color: errorColor, fontWeight: \"bold\" }}>API Request Failed</span>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<span style={{ color: normalColor, fontWeight: \"bold\" }}>API Request...</span>\n\t\t\t\t\t),\n\t\t\t\t]\n\t\t\tcase \"followup\":\n\t\t\t\treturn [\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName=\"codicon codicon-question\"\n\t\t\t\t\t\tstyle={{ color: normalColor, marginBottom: \"-1.5px\" }}></span>,\n\t\t\t\t\t<span style={{ color: normalColor, fontWeight: \"bold\" }}>Cline has a question:</span>,\n\t\t\t\t]\n\t\t\tdefault:\n\t\t\t\treturn [null, null]\n\t\t}\n\t}, [type, cost, apiRequestFailedMessage, isCommandExecuting, apiReqCancelReason])\n\n\tconst headerStyle: React.CSSProperties = {\n\t\tdisplay: \"flex\",\n\t\talignItems: \"center\",\n\t\tgap: \"10px\",\n\t\tmarginBottom: \"10px\",\n\t}\n\n\tconst pStyle: React.CSSProperties = {\n\t\tmargin: 0,\n\t\twhiteSpace: \"pre-wrap\",\n\t\twordBreak: \"break-word\",\n\t\toverflowWrap: \"anywhere\",\n\t}\n\n\tconst tool = useMemo(() => {\n\t\tif (message.ask === \"tool\" || message.say === \"tool\") {\n\t\t\treturn JSON.parse(message.text || \"{}\") as ClineSayTool\n\t\t}\n\t\treturn null\n\t}, [message.ask, message.say, message.text])\n\n\tif (tool) {\n\t\tconst toolIcon = (name: string) => (\n\t\t\t<span\n\t\t\t\tclassName={`codicon codicon-${name}`}\n\t\t\t\tstyle={{ color: \"var(--vscode-foreground)\", marginBottom: \"-1.5px\" }}></span>\n\t\t)\n\n\t\tswitch (tool.tool) {\n\t\t\tcase \"editedExistingFile\":\n\t\t\t\treturn (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t{toolIcon(\"edit\")}\n\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>Cline wants to edit this file:</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<CodeAccordian\n\t\t\t\t\t\t\tisLoading={message.partial}\n\t\t\t\t\t\t\tdiff={tool.diff!}\n\t\t\t\t\t\t\tpath={tool.path!}\n\t\t\t\t\t\t\tisExpanded={isExpanded}\n\t\t\t\t\t\t\tonToggleExpand={onToggleExpand}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</>\n\t\t\t\t)\n\t\t\tcase \"newFileCreated\":\n\t\t\t\treturn (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t{toolIcon(\"new-file\")}\n\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>Cline wants to create a new file:</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<CodeAccordian\n\t\t\t\t\t\t\tisLoading={message.partial}\n\t\t\t\t\t\t\tcode={tool.content!}\n\t\t\t\t\t\t\tpath={tool.path!}\n\t\t\t\t\t\t\tisExpanded={isExpanded}\n\t\t\t\t\t\t\tonToggleExpand={onToggleExpand}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</>\n\t\t\t\t)\n\t\t\tcase \"readFile\":\n\t\t\t\treturn (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t{toolIcon(\"file-code\")}\n\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>\n\t\t\t\t\t\t\t\t{message.type === \"ask\" ? \"Cline wants to read this file:\" : \"Cline read this file:\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{/* <CodeAccordian\n\t\t\t\t\t\t\tcode={tool.content!}\n\t\t\t\t\t\t\tpath={tool.path!}\n\t\t\t\t\t\t\tisExpanded={isExpanded}\n\t\t\t\t\t\t\tonToggleExpand={onToggleExpand}\n\t\t\t\t\t\t/> */}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tborderRadius: 3,\n\t\t\t\t\t\t\t\tbackgroundColor: CODE_BLOCK_BG_COLOR,\n\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\tborder: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\tpadding: \"9px 10px\",\n\t\t\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\t\t\tuserSelect: \"none\",\n\t\t\t\t\t\t\t\t\tWebkitUserSelect: \"none\",\n\t\t\t\t\t\t\t\t\tMozUserSelect: \"none\",\n\t\t\t\t\t\t\t\t\tmsUserSelect: \"none\",\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tvscode.postMessage({ type: \"openFile\", text: tool.content })\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t{tool.path?.startsWith(\".\") && <span>.</span>}\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\twhiteSpace: \"nowrap\",\n\t\t\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\t\t\ttextOverflow: \"ellipsis\",\n\t\t\t\t\t\t\t\t\t\tmarginRight: \"8px\",\n\t\t\t\t\t\t\t\t\t\tdirection: \"rtl\",\n\t\t\t\t\t\t\t\t\t\ttextAlign: \"left\",\n\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t{removeLeadingNonAlphanumeric(tool.path ?? \"\") + \"\\u200E\"}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t<div style={{ flexGrow: 1 }}></div>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tclassName={`codicon codicon-link-external`}\n\t\t\t\t\t\t\t\t\tstyle={{ fontSize: 13.5, margin: \"1px 0\" }}></span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</>\n\t\t\t\t)\n\t\t\tcase \"listFilesTopLevel\":\n\t\t\t\treturn (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t{toolIcon(\"folder-opened\")}\n\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>\n\t\t\t\t\t\t\t\t{message.type === \"ask\"\n\t\t\t\t\t\t\t\t\t? \"Cline wants to view the top level files in this directory:\"\n\t\t\t\t\t\t\t\t\t: \"Cline viewed the top level files in this directory:\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<CodeAccordian\n\t\t\t\t\t\t\tcode={tool.content!}\n\t\t\t\t\t\t\tpath={tool.path!}\n\t\t\t\t\t\t\tlanguage=\"shell-session\"\n\t\t\t\t\t\t\tisExpanded={isExpanded}\n\t\t\t\t\t\t\tonToggleExpand={onToggleExpand}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</>\n\t\t\t\t)\n\t\t\tcase \"listFilesRecursive\":\n\t\t\t\treturn (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t{toolIcon(\"folder-opened\")}\n\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>\n\t\t\t\t\t\t\t\t{message.type === \"ask\"\n\t\t\t\t\t\t\t\t\t? \"Cline wants to recursively view all files in this directory:\"\n\t\t\t\t\t\t\t\t\t: \"Cline recursively viewed all files in this directory:\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<CodeAccordian\n\t\t\t\t\t\t\tcode={tool.content!}\n\t\t\t\t\t\t\tpath={tool.path!}\n\t\t\t\t\t\t\tlanguage=\"shell-session\"\n\t\t\t\t\t\t\tisExpanded={isExpanded}\n\t\t\t\t\t\t\tonToggleExpand={onToggleExpand}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</>\n\t\t\t\t)\n\t\t\tcase \"listCodeDefinitionNames\":\n\t\t\t\treturn (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t{toolIcon(\"file-code\")}\n\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>\n\t\t\t\t\t\t\t\t{message.type === \"ask\"\n\t\t\t\t\t\t\t\t\t? \"Cline wants to view source code definition names used in this directory:\"\n\t\t\t\t\t\t\t\t\t: \"Cline viewed source code definition names used in this directory:\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<CodeAccordian\n\t\t\t\t\t\t\tcode={tool.content!}\n\t\t\t\t\t\t\tpath={tool.path!}\n\t\t\t\t\t\t\tisExpanded={isExpanded}\n\t\t\t\t\t\t\tonToggleExpand={onToggleExpand}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</>\n\t\t\t\t)\n\t\t\tcase \"searchFiles\":\n\t\t\t\treturn (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t{toolIcon(\"search\")}\n\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>\n\t\t\t\t\t\t\t\t{message.type === \"ask\" ? (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\tCline wants to search this directory for <code>{tool.regex}</code>:\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\tCline searched this directory for <code>{tool.regex}</code>:\n\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<CodeAccordian\n\t\t\t\t\t\t\tcode={tool.content!}\n\t\t\t\t\t\t\tpath={tool.path! + (tool.filePattern ? `/(${tool.filePattern})` : \"\")}\n\t\t\t\t\t\t\tlanguage=\"plaintext\"\n\t\t\t\t\t\t\tisExpanded={isExpanded}\n\t\t\t\t\t\t\tonToggleExpand={onToggleExpand}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</>\n\t\t\t\t)\n\t\t\t// case \"inspectSite\":\n\t\t\t// \tconst isInspecting =\n\t\t\t// \t\tisLast && lastModifiedMessage?.say === \"inspect_site_result\" && !lastModifiedMessage?.images\n\t\t\t// \treturn (\n\t\t\t// \t\t<>\n\t\t\t// \t\t\t<div style={headerStyle}>\n\t\t\t// \t\t\t\t{isInspecting ? <ProgressIndicator /> : toolIcon(\"inspect\")}\n\t\t\t// \t\t\t\t<span style={{ fontWeight: \"bold\" }}>\n\t\t\t// \t\t\t\t\t{message.type === \"ask\" ? (\n\t\t\t// \t\t\t\t\t\t<>Cline wants to inspect this website:</>\n\t\t\t// \t\t\t\t\t) : (\n\t\t\t// \t\t\t\t\t\t<>Cline is inspecting this website:</>\n\t\t\t// \t\t\t\t\t)}\n\t\t\t// \t\t\t\t</span>\n\t\t\t// \t\t\t</div>\n\t\t\t// \t\t\t<div\n\t\t\t// \t\t\t\tstyle={{\n\t\t\t// \t\t\t\t\tborderRadius: 3,\n\t\t\t// \t\t\t\t\tborder: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t// \t\t\t\t\toverflow: \"hidden\",\n\t\t\t// \t\t\t\t\tbackgroundColor: CODE_BLOCK_BG_COLOR,\n\t\t\t// \t\t\t\t}}>\n\t\t\t// \t\t\t\t<CodeBlock source={`${\"```\"}shell\\n${tool.path}\\n${\"```\"}`} forceWrap={true} />\n\t\t\t// \t\t\t</div>\n\t\t\t// \t\t</>\n\t\t\t// \t)\n\t\t\tdefault:\n\t\t\t\treturn null\n\t\t}\n\t}\n\n\tswitch (message.type) {\n\t\tcase \"say\":\n\t\t\tswitch (message.say) {\n\t\t\t\tcase \"api_req_started\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t...headerStyle,\n\t\t\t\t\t\t\t\t\tmarginBottom:\n\t\t\t\t\t\t\t\t\t\t(cost == null && apiRequestFailedMessage) || apiReqStreamingFailedMessage\n\t\t\t\t\t\t\t\t\t\t\t? 10\n\t\t\t\t\t\t\t\t\t\t\t: 0,\n\t\t\t\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\t\t\tuserSelect: \"none\",\n\t\t\t\t\t\t\t\t\tWebkitUserSelect: \"none\",\n\t\t\t\t\t\t\t\t\tMozUserSelect: \"none\",\n\t\t\t\t\t\t\t\t\tmsUserSelect: \"none\",\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonClick={onToggleExpand}>\n\t\t\t\t\t\t\t\t<div style={{ display: \"flex\", alignItems: \"center\", gap: \"10px\" }}>\n\t\t\t\t\t\t\t\t\t{icon}\n\t\t\t\t\t\t\t\t\t{title}\n\t\t\t\t\t\t\t\t\t{/* Need to render this everytime since it affects height of row by 2px */}\n\t\t\t\t\t\t\t\t\t<VSCodeBadge style={{ opacity: cost != null && cost > 0 ? 1 : 0 }}>\n\t\t\t\t\t\t\t\t\t\t${Number(cost || 0)?.toFixed(4)}\n\t\t\t\t\t\t\t\t\t</VSCodeBadge>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<span className={`codicon codicon-chevron-${isExpanded ? \"up\" : \"down\"}`}></span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{((cost == null && apiRequestFailedMessage) || apiReqStreamingFailedMessage) && (\n\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t<p style={{ ...pStyle, color: \"var(--vscode-errorForeground)\" }}>\n\t\t\t\t\t\t\t\t\t\t{apiRequestFailedMessage || apiReqStreamingFailedMessage}\n\t\t\t\t\t\t\t\t\t\t{apiRequestFailedMessage?.toLowerCase().includes(\"powershell\") && (\n\t\t\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\t\t\t\t\tIt seems like you're having Windows PowerShell issues, please see this{\" \"}\n\t\t\t\t\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\t\t\t\t\thref=\"https://github.com/cline/cline/wiki/TroubleShooting-%E2%80%90-%22PowerShell-is-not-recognized-as-an-internal-or-external-command%22\"\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{ color: \"inherit\", textDecoration: \"underline\" }}>\n\t\t\t\t\t\t\t\t\t\t\t\t\ttroubleshooting guide\n\t\t\t\t\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t\t\t\t\t\t.\n\t\t\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t\t\t{/* {apiProvider === \"\" && (\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tbackgroundColor:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"color-mix(in srgb, var(--vscode-errorForeground) 20%, transparent)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-editor-foreground)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tpadding: \"6px 8px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tborderRadius: \"3px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tmargin: \"10px 0 0 0\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-warning\"\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmarginRight: 6,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: 16,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-errorForeground)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}></i>\n\t\t\t\t\t\t\t\t\t\t\t\t<span>\n\t\t\t\t\t\t\t\t\t\t\t\t\tUh-oh, this could be a problem on end. We've been alerted and\n\t\t\t\t\t\t\t\t\t\t\t\t\twill resolve this ASAP. You can also{\" \"}\n\t\t\t\t\t\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\t\t\t\t\t\thref=\"\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{ color: \"inherit\", textDecoration: \"underline\" }}>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcontact us\n\t\t\t\t\t\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t\t\t\t\t\t\t.\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)} */}\n\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t{isExpanded && (\n\t\t\t\t\t\t\t\t<div style={{ marginTop: \"10px\" }}>\n\t\t\t\t\t\t\t\t\t<CodeAccordian\n\t\t\t\t\t\t\t\t\t\tcode={JSON.parse(message.text || \"{}\").request}\n\t\t\t\t\t\t\t\t\t\tlanguage=\"markdown\"\n\t\t\t\t\t\t\t\t\t\tisExpanded={true}\n\t\t\t\t\t\t\t\t\t\tonToggleExpand={onToggleExpand}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\t\t\t\tcase \"api_req_finished\":\n\t\t\t\t\treturn null // we should never see this message type\n\t\t\t\tcase \"text\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<Markdown markdown={message.text} />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)\n\t\t\t\tcase \"user_feedback\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tbackgroundColor: \"var(--vscode-badge-background)\",\n\t\t\t\t\t\t\t\tcolor: \"var(--vscode-badge-foreground)\",\n\t\t\t\t\t\t\t\tborderRadius: \"3px\",\n\t\t\t\t\t\t\t\tpadding: \"9px\",\n\t\t\t\t\t\t\t\twhiteSpace: \"pre-line\",\n\t\t\t\t\t\t\t\twordWrap: \"break-word\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<span style={{ display: \"block\" }}>{highlightMentions(message.text)}</span>\n\t\t\t\t\t\t\t{message.images && message.images.length > 0 && (\n\t\t\t\t\t\t\t\t<Thumbnails images={message.images} style={{ marginTop: \"8px\" }} />\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)\n\t\t\t\tcase \"user_feedback_diff\":\n\t\t\t\t\tconst tool = JSON.parse(message.text || \"{}\") as ClineSayTool\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tmarginTop: -10,\n\t\t\t\t\t\t\t\twidth: \"100%\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<CodeAccordian\n\t\t\t\t\t\t\t\tdiff={tool.diff!}\n\t\t\t\t\t\t\t\tisFeedback={true}\n\t\t\t\t\t\t\t\tisExpanded={isExpanded}\n\t\t\t\t\t\t\t\tonToggleExpand={onToggleExpand}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)\n\t\t\t\tcase \"error\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t{title && (\n\t\t\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t\t\t{icon}\n\t\t\t\t\t\t\t\t\t{title}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<p style={{ ...pStyle, color: \"var(--vscode-errorForeground)\" }}>{message.text}</p>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\t\t\t\tcase \"completion_result\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t\t{icon}\n\t\t\t\t\t\t\t\t{title}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div style={{ color: \"var(--vscode-charts-green)\", paddingTop: 10 }}>\n\t\t\t\t\t\t\t\t<Markdown markdown={message.text} />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\t\t\t\tcase \"shell_integration_warning\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\tflexDirection: \"column\",\n\t\t\t\t\t\t\t\t\tbackgroundColor: \"rgba(255, 191, 0, 0.1)\",\n\t\t\t\t\t\t\t\t\tpadding: 8,\n\t\t\t\t\t\t\t\t\tborderRadius: 3,\n\t\t\t\t\t\t\t\t\tfontSize: 12,\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t<div style={{ display: \"flex\", alignItems: \"center\", marginBottom: 4 }}>\n\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-warning\"\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tmarginRight: 8,\n\t\t\t\t\t\t\t\t\t\t\tfontSize: 18,\n\t\t\t\t\t\t\t\t\t\t\tcolor: \"#FFA500\",\n\t\t\t\t\t\t\t\t\t\t}}></i>\n\t\t\t\t\t\t\t\t\t<span style={{ fontWeight: 500, color: \"#FFA500\" }}>\n\t\t\t\t\t\t\t\t\t\tShell Integration Unavailable\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\tCline won't be able to view the command's output. Please update VSCode (\n\t\t\t\t\t\t\t\t\t<code>CMD/CTRL + Shift + P</code> → \"Update\") and make sure you're using a supported\n\t\t\t\t\t\t\t\t\tshell: zsh, bash, fish, or PowerShell (<code>CMD/CTRL + Shift + P</code> →\n\t\t\t\t\t\t\t\t\t\"Terminal: Select Default Profile\").{\" \"}\n\t\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\t\thref=\"https://github.com/cline/cline/wiki/Troubleshooting-%E2%80%90-Shell-Integration-Unavailable\"\n\t\t\t\t\t\t\t\t\t\tstyle={{ color: \"inherit\", textDecoration: \"underline\" }}>\n\t\t\t\t\t\t\t\t\t\tStill having trouble?\n\t\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\t\t\t\tdefault:\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t{title && (\n\t\t\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t\t\t{icon}\n\t\t\t\t\t\t\t\t\t{title}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<div style={{ paddingTop: 10 }}>\n\t\t\t\t\t\t\t\t<Markdown markdown={message.text} />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\t\t\t}\n\t\tcase \"ask\":\n\t\t\tswitch (message.ask) {\n\t\t\t\tcase \"mistake_limit_reached\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t\t{icon}\n\t\t\t\t\t\t\t\t{title}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p style={{ ...pStyle, color: \"var(--vscode-errorForeground)\" }}>{message.text}</p>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\t\t\t\tcase \"command\":\n\t\t\t\t\tconst splitMessage = (text: string) => {\n\t\t\t\t\t\tconst outputIndex = text.indexOf(COMMAND_OUTPUT_STRING)\n\t\t\t\t\t\tif (outputIndex === -1) {\n\t\t\t\t\t\t\treturn { command: text, output: \"\" }\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tcommand: text.slice(0, outputIndex).trim(),\n\t\t\t\t\t\t\toutput: text\n\t\t\t\t\t\t\t\t.slice(outputIndex + COMMAND_OUTPUT_STRING.length)\n\t\t\t\t\t\t\t\t.trim()\n\t\t\t\t\t\t\t\t.split(\"\")\n\t\t\t\t\t\t\t\t.map((char) => {\n\t\t\t\t\t\t\t\t\tswitch (char) {\n\t\t\t\t\t\t\t\t\t\tcase \"\\t\":\n\t\t\t\t\t\t\t\t\t\t\treturn \"→   \"\n\t\t\t\t\t\t\t\t\t\tcase \"\\b\":\n\t\t\t\t\t\t\t\t\t\t\treturn \"⌫\"\n\t\t\t\t\t\t\t\t\t\tcase \"\\f\":\n\t\t\t\t\t\t\t\t\t\t\treturn \"⏏\"\n\t\t\t\t\t\t\t\t\t\tcase \"\\v\":\n\t\t\t\t\t\t\t\t\t\t\treturn \"⇳\"\n\t\t\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\t\t\treturn char\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.join(\"\"),\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { command, output } = splitMessage(message.text || \"\")\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t\t{icon}\n\t\t\t\t\t\t\t\t{title}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{/* <Terminal\n\t\t\t\t\t\t\t\trawOutput={command + (output ? \"\\n\" + output : \"\")}\n\t\t\t\t\t\t\t\tshouldAllowInput={!!isCommandExecuting && output.length > 0}\n\t\t\t\t\t\t\t/> */}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tborderRadius: 3,\n\t\t\t\t\t\t\t\t\tborder: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\t\tbackgroundColor: CODE_BLOCK_BG_COLOR,\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t<CodeBlock source={`${\"```\"}shell\\n${command}\\n${\"```\"}`} forceWrap={true} />\n\t\t\t\t\t\t\t\t{output.length > 0 && (\n\t\t\t\t\t\t\t\t\t<div style={{ width: \"100%\" }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tonClick={onToggleExpand}\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t\tgap: \"4px\",\n\t\t\t\t\t\t\t\t\t\t\t\twidth: \"100%\",\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: \"flex-start\",\n\t\t\t\t\t\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\t\t\t\t\t\tpadding: `2px 8px ${isExpanded ? 0 : 8}px 8px`,\n\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tclassName={`codicon codicon-chevron-${isExpanded ? \"down\" : \"right\"}`}></span>\n\t\t\t\t\t\t\t\t\t\t\t<span style={{ fontSize: \"0.8em\" }}>Command Output</span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{isExpanded && <CodeBlock source={`${\"```\"}shell\\n${output}\\n${\"```\"}`} />}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\t\t\t\tcase \"completion_result\":\n\t\t\t\t\tif (message.text) {\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t\t\t{icon}\n\t\t\t\t\t\t\t\t\t{title}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div style={{ color: \"var(--vscode-charts-green)\", paddingTop: 10 }}>\n\t\t\t\t\t\t\t\t\t<Markdown markdown={message.text} />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn null // Don't render anything when we get a completion_result ask without text\n\t\t\t\t\t}\n\t\t\t\tcase \"followup\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t{title && (\n\t\t\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t\t\t{icon}\n\t\t\t\t\t\t\t\t\t{title}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t<div style={{ paddingTop: 10 }}>\n\t\t\t\t\t\t\t\t<Markdown markdown={message.text} />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\t\t\t\tdefault:\n\t\t\t\t\treturn null\n\t\t\t}\n\t}\n}\n\nexport const ProgressIndicator = () => (\n\t<div\n\t\tstyle={{\n\t\t\twidth: \"16px\",\n\t\t\theight: \"16px\",\n\t\t\tdisplay: \"flex\",\n\t\t\talignItems: \"center\",\n\t\t\tjustifyContent: \"center\",\n\t\t}}>\n\t\t<div style={{ transform: \"scale(0.55)\", transformOrigin: \"center\" }}>\n\t\t\t<VSCodeProgressRing />\n\t\t</div>\n\t</div>\n)\n\nconst Markdown = memo(({ markdown }: { markdown?: string }) => {\n\treturn (\n\t\t<div style={{ wordBreak: \"break-word\", overflowWrap: \"anywhere\", marginBottom: -15, marginTop: -15 }}>\n\t\t\t<MarkdownBlock markdown={markdown} />\n\t\t</div>\n\t)\n})\n", "tag": "", "tokens": 7130, "metadata": {}}], "modify_time": 1733144568.737248}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/BrowserSessionRow.tsx", "relative_path": "cline/webview-ui/src/components/chat/BrowserSessionRow.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/BrowserSessionRow.tsx", "source_code": "import deepEqual from \"fast-deep-equal\"\nimport React, { memo, useEffect, useMemo, useRef, useState } from \"react\"\nimport { useSize } from \"react-use\"\nimport {\n\tBrowserAction,\n\tBrowserActionResult,\n\tClineMessage,\n\tClineSayBrowserAction,\n} from \"../../../../src/shared/ExtensionMessage\"\nimport { vscode } from \"../../utils/vscode\"\nimport CodeBlock, { CODE_BLOCK_BG_COLOR } from \"../common/CodeBlock\"\nimport { ChatRowContent, ProgressIndicator } from \"./ChatRow\"\nimport { VSCodeButton } from \"@vscode/webview-ui-toolkit/react\"\n\ninterface BrowserSessionRowProps {\n\tmessages: ClineMessage[]\n\tisExpanded: (messageTs: number) => boolean\n\tonToggleExpand: (messageTs: number) => void\n\tlastModifiedMessage?: ClineMessage\n\tisLast: boolean\n\tonHeightChange: (isTaller: boolean) => void\n}\n\nconst BrowserSessionRow = memo((props: BrowserSessionRowProps) => {\n\tconst { messages, isLast, onHeightChange, lastModifiedMessage } = props\n\tconst prevHeightRef = useRef(0)\n\tconst [maxActionHeight, setMaxActionHeight] = useState(0)\n\tconst [consoleLogsExpanded, setConsoleLogsExpanded] = useState(false)\n\n\tconst isLastApiReqInterrupted = useMemo(() => {\n\t\t// Check if last api_req_started is cancelled\n\t\tconst lastApiReqStarted = [...messages].reverse().find((m) => m.say === \"api_req_started\")\n\t\tif (lastApiReqStarted?.text != null) {\n\t\t\tconst info = JSON.parse(lastApiReqStarted.text)\n\t\t\tif (info.cancelReason != null) {\n\t\t\t\treturn true\n\t\t\t}\n\t\t}\n\t\tconst lastApiReqFailed = isLast && lastModifiedMessage?.ask === \"api_req_failed\"\n\t\tif (lastApiReqFailed) {\n\t\t\treturn true\n\t\t}\n\t\treturn false\n\t}, [messages, lastModifiedMessage, isLast])\n\n\tconst isBrowsing = useMemo(() => {\n\t\treturn isLast && messages.some((m) => m.say === \"browser_action_result\") && !isLastApiReqInterrupted // after user approves, browser_action_result with \"\" is sent to indicate that the session has started\n\t}, [isLast, messages, isLastApiReqInterrupted])\n\n\t// Organize messages into pages with current state and next action\n\tconst pages = useMemo(() => {\n\t\tconst result: {\n\t\t\tcurrentState: {\n\t\t\t\turl?: string\n\t\t\t\tscreenshot?: string\n\t\t\t\tmousePosition?: string\n\t\t\t\tconsoleLogs?: string\n\t\t\t\tmessages: ClineMessage[] // messages up to and including the result\n\t\t\t}\n\t\t\tnextAction?: {\n\t\t\t\tmessages: ClineMessage[] // messages leading to next result\n\t\t\t}\n\t\t}[] = []\n\n\t\tlet currentStateMessages: ClineMessage[] = []\n\t\tlet nextActionMessages: ClineMessage[] = []\n\n\t\tmessages.forEach((message) => {\n\t\t\tif (message.ask === \"browser_action_launch\") {\n\t\t\t\t// Start first page\n\t\t\t\tcurrentStateMessages = [message]\n\t\t\t} else if (message.say === \"browser_action_result\") {\n\t\t\t\tif (message.text === \"\") {\n\t\t\t\t\t// first browser_action_result is an empty string that signals that session has started\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\t// Complete current state\n\t\t\t\tcurrentStateMessages.push(message)\n\t\t\t\tconst resultData = JSON.parse(message.text || \"{}\") as BrowserActionResult\n\n\t\t\t\t// Add page with current state and previous next actions\n\t\t\t\tresult.push({\n\t\t\t\t\tcurrentState: {\n\t\t\t\t\t\turl: resultData.currentUrl,\n\t\t\t\t\t\tscreenshot: resultData.screenshot,\n\t\t\t\t\t\tmousePosition: resultData.currentMousePosition,\n\t\t\t\t\t\tconsoleLogs: resultData.logs,\n\t\t\t\t\t\tmessages: [...currentStateMessages],\n\t\t\t\t\t},\n\t\t\t\t\tnextAction:\n\t\t\t\t\t\tnextActionMessages.length > 0\n\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tmessages: [...nextActionMessages],\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: undefined,\n\t\t\t\t})\n\n\t\t\t\t// Reset for next page\n\t\t\t\tcurrentStateMessages = []\n\t\t\t\tnextActionMessages = []\n\t\t\t} else if (\n\t\t\t\tmessage.say === \"api_req_started\" ||\n\t\t\t\tmessage.say === \"text\" ||\n\t\t\t\tmessage.say === \"browser_action\"\n\t\t\t) {\n\t\t\t\t// These messages lead to the next result, so they should always go in nextActionMessages\n\t\t\t\tnextActionMessages.push(message)\n\t\t\t} else {\n\t\t\t\t// Any other message types\n\t\t\t\tcurrentStateMessages.push(message)\n\t\t\t}\n\t\t})\n\n\t\t// Add incomplete page if exists\n\t\tif (currentStateMessages.length > 0 || nextActionMessages.length > 0) {\n\t\t\tresult.push({\n\t\t\t\tcurrentState: {\n\t\t\t\t\tmessages: [...currentStateMessages],\n\t\t\t\t},\n\t\t\t\tnextAction:\n\t\t\t\t\tnextActionMessages.length > 0\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tmessages: [...nextActionMessages],\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t: undefined,\n\t\t\t})\n\t\t}\n\n\t\treturn result\n\t}, [messages])\n\n\t// Auto-advance to latest page\n\tconst [currentPageIndex, setCurrentPageIndex] = useState(0)\n\tuseEffect(() => {\n\t\tsetCurrentPageIndex(pages.length - 1)\n\t}, [pages.length])\n\n\t// Get initial URL from launch message\n\tconst initialUrl = useMemo(() => {\n\t\tconst launchMessage = messages.find((m) => m.ask === \"browser_action_launch\")\n\t\treturn launchMessage?.text || \"\"\n\t}, [messages])\n\n\t// Find the latest available URL and screenshot\n\tconst latestState = useMemo(() => {\n\t\tfor (let i = pages.length - 1; i >= 0; i--) {\n\t\t\tconst page = pages[i]\n\t\t\tif (page.currentState.url || page.currentState.screenshot) {\n\t\t\t\treturn {\n\t\t\t\t\turl: page.currentState.url,\n\t\t\t\t\tmousePosition: page.currentState.mousePosition,\n\t\t\t\t\tconsoleLogs: page.currentState.consoleLogs,\n\t\t\t\t\tscreenshot: page.currentState.screenshot,\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn { url: undefined, mousePosition: undefined, consoleLogs: undefined, screenshot: undefined }\n\t}, [pages])\n\n\tconst currentPage = pages[currentPageIndex]\n\tconst isLastPage = currentPageIndex === pages.length - 1\n\n\t// Use latest state if we're on the last page and don't have a state yet\n\tconst displayState = isLastPage\n\t\t? {\n\t\t\t\turl: currentPage?.currentState.url || latestState.url || initialUrl,\n\t\t\t\tmousePosition: currentPage?.currentState.mousePosition || latestState.mousePosition || \"700,400\",\n\t\t\t\tconsoleLogs: currentPage?.currentState.consoleLogs,\n\t\t\t\tscreenshot: currentPage?.currentState.screenshot || latestState.screenshot,\n\t\t\t}\n\t\t: {\n\t\t\t\turl: currentPage?.currentState.url || initialUrl,\n\t\t\t\tmousePosition: currentPage?.currentState.mousePosition || \"700,400\",\n\t\t\t\tconsoleLogs: currentPage?.currentState.consoleLogs,\n\t\t\t\tscreenshot: currentPage?.currentState.screenshot,\n\t\t\t}\n\n\tconst [actionContent, { height: actionHeight }] = useSize(\n\t\t<div>\n\t\t\t{currentPage?.nextAction?.messages.map((message) => (\n\t\t\t\t<BrowserSessionRowContent\n\t\t\t\t\tkey={message.ts}\n\t\t\t\t\t{...props}\n\t\t\t\t\tmessage={message}\n\t\t\t\t\tsetMaxActionHeight={setMaxActionHeight}\n\t\t\t\t/>\n\t\t\t))}\n\t\t\t{!isBrowsing && messages.some((m) => m.say === \"browser_action_result\") && currentPageIndex === 0 && (\n\t\t\t\t<BrowserActionBox action={\"launch\"} text={initialUrl} />\n\t\t\t)}\n\t\t</div>,\n\t)\n\n\tuseEffect(() => {\n\t\tif (actionHeight === 0 || actionHeight === Infinity) {\n\t\t\treturn\n\t\t}\n\t\tif (actionHeight > maxActionHeight) {\n\t\t\tsetMaxActionHeight(actionHeight)\n\t\t}\n\t}, [actionHeight, maxActionHeight])\n\n\t// Track latest click coordinate\n\tconst latestClickPosition = useMemo(() => {\n\t\tif (!isBrowsing) return undefined\n\n\t\t// Look through current page's next actions for the latest browser_action\n\t\tconst actions = currentPage?.nextAction?.messages || []\n\t\tfor (let i = actions.length - 1; i >= 0; i--) {\n\t\t\tconst message = actions[i]\n\t\t\tif (message.say === \"browser_action\") {\n\t\t\t\tconst browserAction = JSON.parse(message.text || \"{}\") as ClineSayBrowserAction\n\t\t\t\tif (browserAction.action === \"click\" && browserAction.coordinate) {\n\t\t\t\t\treturn browserAction.coordinate\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn undefined\n\t}, [isBrowsing, currentPage?.nextAction?.messages])\n\n\t// Use latest click position while browsing, otherwise use display state\n\tconst mousePosition = isBrowsing ? latestClickPosition || displayState.mousePosition : displayState.mousePosition\n\n\tconst [browserSessionRow, { height }] = useSize(\n\t\t<div style={{ padding: \"10px 6px 10px 15px\", marginBottom: -10 }}>\n\t\t\t<div style={{ display: \"flex\", alignItems: \"center\", gap: \"10px\", marginBottom: \"10px\" }}>\n\t\t\t\t{isBrowsing ? (\n\t\t\t\t\t<ProgressIndicator />\n\t\t\t\t) : (\n\t\t\t\t\t<span\n\t\t\t\t\t\tclassName={`codicon codicon-inspect`}\n\t\t\t\t\t\tstyle={{ color: \"var(--vscode-foreground)\", marginBottom: \"-1.5px\" }}></span>\n\t\t\t\t)}\n\t\t\t\t<span style={{ fontWeight: \"bold\" }}>\n\t\t\t\t\t<>Cline wants to use the browser:</>\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tborderRadius: 3,\n\t\t\t\t\tborder: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\tbackgroundColor: CODE_BLOCK_BG_COLOR,\n\t\t\t\t\tmarginBottom: 10,\n\t\t\t\t}}>\n\t\t\t\t{/* URL Bar */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tmargin: \"5px auto\",\n\t\t\t\t\t\twidth: \"calc(100% - 10px)\",\n\t\t\t\t\t\tboxSizing: \"border-box\", // includes padding in width calculation\n\t\t\t\t\t\tbackgroundColor: \"var(--vscode-input-background)\",\n\t\t\t\t\t\tborder: \"1px solid var(--vscode-input-border)\",\n\t\t\t\t\t\tborderRadius: \"4px\",\n\t\t\t\t\t\tpadding: \"3px 5px\",\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\tjustifyContent: \"center\",\n\t\t\t\t\t\tcolor: displayState.url\n\t\t\t\t\t\t\t? \"var(--vscode-input-foreground)\"\n\t\t\t\t\t\t\t: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t}}>\n\t\t\t\t\t<div\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\ttextOverflow: \"ellipsis\",\n\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\twhiteSpace: \"nowrap\",\n\t\t\t\t\t\t\twidth: \"100%\",\n\t\t\t\t\t\t\ttextAlign: \"center\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\t{displayState.url || \"http\"}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{/* Screenshot Area */}\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\twidth: \"100%\",\n\t\t\t\t\t\tpaddingBottom: \"calc(200%/3)\",\n\t\t\t\t\t\tposition: \"relative\",\n\t\t\t\t\t\tbackgroundColor: \"var(--vscode-input-background)\",\n\t\t\t\t\t}}>\n\t\t\t\t\t{displayState.screenshot ? (\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc={displayState.screenshot}\n\t\t\t\t\t\t\talt=\"Browser screenshot\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\t\t\twidth: \"100%\",\n\t\t\t\t\t\t\t\theight: \"100%\",\n\t\t\t\t\t\t\t\tobjectFit: \"contain\",\n\t\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tonClick={() =>\n\t\t\t\t\t\t\t\tvscode.postMessage({\n\t\t\t\t\t\t\t\t\ttype: \"openImage\",\n\t\t\t\t\t\t\t\t\ttext: displayState.screenshot,\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t/>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\t\t\ttop: \"50%\",\n\t\t\t\t\t\t\t\tleft: \"50%\",\n\t\t\t\t\t\t\t\ttransform: \"translate(-50%, -50%)\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tclassName=\"codicon codicon-globe\"\n\t\t\t\t\t\t\t\tstyle={{ fontSize: \"80px\", color: \"var(--vscode-descriptionForeground)\" }}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t\t{displayState.mousePosition && (\n\t\t\t\t\t\t<BrowserCursor\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\t\t\ttop: `${(parseInt(mousePosition.split(\",\")[1]) / 600) * 100}%`,\n\t\t\t\t\t\t\t\tleft: `${(parseInt(mousePosition.split(\",\")[0]) / 900) * 100}%`,\n\t\t\t\t\t\t\t\ttransition: \"top 0.3s ease-out, left 0.3s ease-out\",\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\n\t\t\t\t<div style={{ width: \"100%\" }}>\n\t\t\t\t\t<div\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tsetConsoleLogsExpanded(!consoleLogsExpanded)\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\tgap: \"4px\",\n\t\t\t\t\t\t\twidth: \"100%\",\n\t\t\t\t\t\t\tjustifyContent: \"flex-start\",\n\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\tpadding: `9px 8px ${consoleLogsExpanded ? 0 : 8}px 8px`,\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\t<span className={`codicon codicon-chevron-${consoleLogsExpanded ? \"down\" : \"right\"}`}></span>\n\t\t\t\t\t\t<span style={{ fontSize: \"0.8em\" }}>Console Logs</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t{consoleLogsExpanded && (\n\t\t\t\t\t\t<CodeBlock source={`${\"```\"}shell\\n${displayState.consoleLogs || \"(No new logs)\"}\\n${\"```\"}`} />\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{/* Action content with min height */}\n\t\t\t<div style={{ minHeight: maxActionHeight }}>{actionContent}</div>\n\n\t\t\t{/* Pagination moved to bottom */}\n\t\t\t{pages.length > 1 && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\tpadding: \"8px 0px\",\n\t\t\t\t\t\tmarginTop: \"15px\",\n\t\t\t\t\t\tborderTop: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t\t\t}}>\n\t\t\t\t\t<div>\n\t\t\t\t\t\tStep {currentPageIndex + 1} of {pages.length}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div style={{ display: \"flex\", gap: \"4px\" }}>\n\t\t\t\t\t\t<VSCodeButton\n\t\t\t\t\t\t\tdisabled={currentPageIndex === 0 || isBrowsing}\n\t\t\t\t\t\t\tonClick={() => setCurrentPageIndex((i) => i - 1)}>\n\t\t\t\t\t\t\tPrevious\n\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t\t<VSCodeButton\n\t\t\t\t\t\t\tdisabled={currentPageIndex === pages.length - 1 || isBrowsing}\n\t\t\t\t\t\t\tonClick={() => setCurrentPageIndex((i) => i + 1)}>\n\t\t\t\t\t\t\tNext\n\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>,\n\t)\n\n\t// Height change effect\n\tuseEffect(() => {\n\t\tconst isInitialRender = prevHeightRef.current === 0\n\t\tif (isLast && height !== 0 && height !== Infinity && height !== prevHeightRef.current) {\n\t\t\tif (!isInitialRender) {\n\t\t\t\tonHeightChange(height > prevHeightRef.current)\n\t\t\t}\n\t\t\tprevHeightRef.current = height\n\t\t}\n\t}, [height, isLast, onHeightChange])\n\n\treturn browserSessionRow\n}, deepEqual)\n\ninterface BrowserSessionRowContentProps extends Omit<BrowserSessionRowProps, \"messages\"> {\n\tmessage: ClineMessage\n\tsetMaxActionHeight: (height: number) => void\n}\n\nconst BrowserSessionRowContent = ({\n\tmessage,\n\tisExpanded,\n\tonToggleExpand,\n\tlastModifiedMessage,\n\tisLast,\n\tsetMaxActionHeight,\n}: BrowserSessionRowContentProps) => {\n\tconst headerStyle: React.CSSProperties = {\n\t\tdisplay: \"flex\",\n\t\talignItems: \"center\",\n\t\tgap: \"10px\",\n\t\tmarginBottom: \"10px\",\n\t}\n\n\tswitch (message.type) {\n\t\tcase \"say\":\n\t\t\tswitch (message.say) {\n\t\t\t\tcase \"api_req_started\":\n\t\t\t\tcase \"text\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<div style={{ padding: \"10px 0 10px 0\" }}>\n\t\t\t\t\t\t\t<ChatRowContent\n\t\t\t\t\t\t\t\tmessage={message}\n\t\t\t\t\t\t\t\tisExpanded={isExpanded(message.ts)}\n\t\t\t\t\t\t\t\tonToggleExpand={() => {\n\t\t\t\t\t\t\t\t\tif (message.say === \"api_req_started\") {\n\t\t\t\t\t\t\t\t\t\tsetMaxActionHeight(0)\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tonToggleExpand(message.ts)\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tlastModifiedMessage={lastModifiedMessage}\n\t\t\t\t\t\t\t\tisLast={isLast}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)\n\n\t\t\t\tcase \"browser_action\":\n\t\t\t\t\tconst browserAction = JSON.parse(message.text || \"{}\") as ClineSayBrowserAction\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<BrowserActionBox\n\t\t\t\t\t\t\taction={browserAction.action}\n\t\t\t\t\t\t\tcoordinate={browserAction.coordinate}\n\t\t\t\t\t\t\ttext={browserAction.text}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)\n\n\t\t\t\tdefault:\n\t\t\t\t\treturn null\n\t\t\t}\n\n\t\tcase \"ask\":\n\t\t\tswitch (message.ask) {\n\t\t\t\tcase \"browser_action_launch\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<div style={headerStyle}>\n\t\t\t\t\t\t\t\t<span style={{ fontWeight: \"bold\" }}>Browser Session Started</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tborderRadius: 3,\n\t\t\t\t\t\t\t\t\tborder: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\t\tbackgroundColor: CODE_BLOCK_BG_COLOR,\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t<CodeBlock source={`${\"```\"}shell\\n${message.text}\\n${\"```\"}`} forceWrap={true} />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\n\t\t\t\tdefault:\n\t\t\t\t\treturn null\n\t\t\t}\n\t}\n}\n\nconst BrowserActionBox = ({\n\taction,\n\tcoordinate,\n\ttext,\n}: {\n\taction: BrowserAction\n\tcoordinate?: string\n\ttext?: string\n}) => {\n\tconst getBrowserActionText = (action: BrowserAction, coordinate?: string, text?: string) => {\n\t\tswitch (action) {\n\t\t\tcase \"launch\":\n\t\t\t\treturn `Launch browser at ${text}`\n\t\t\tcase \"click\":\n\t\t\t\treturn `Click (${coordinate?.replace(\",\", \", \")})`\n\t\t\tcase \"type\":\n\t\t\t\treturn `Type \"${text}\"`\n\t\t\tcase \"scroll_down\":\n\t\t\t\treturn \"Scroll down\"\n\t\t\tcase \"scroll_up\":\n\t\t\t\treturn \"Scroll up\"\n\t\t\tcase \"close\":\n\t\t\t\treturn \"Close browser\"\n\t\t\tdefault:\n\t\t\t\treturn action\n\t\t}\n\t}\n\treturn (\n\t\t<div style={{ padding: \"10px 0 0 0\" }}>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tborderRadius: 3,\n\t\t\t\t\tbackgroundColor: CODE_BLOCK_BG_COLOR,\n\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\tborder: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t\t}}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\tpadding: \"9px 10px\",\n\t\t\t\t\t}}>\n\t\t\t\t\t<span\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\twhiteSpace: \"normal\",\n\t\t\t\t\t\t\twordBreak: \"break-word\",\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\t<span style={{ fontWeight: 500 }}>Browse Action: </span>\n\t\t\t\t\t\t{getBrowserActionText(action, coordinate, text)}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n\nconst BrowserCursor: React.FC<{ style?: React.CSSProperties }> = ({ style }) => {\n\t// (can't use svgs in vsc extensions)\n\tconst cursorBase64 =\n\t\t\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAYCAYAAAAVibZIAAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAFaADAAQAAAABAAAAGAAAAADwi9a/AAADGElEQVQ4EZ2VbUiTURTH772be/PxZdsz3cZwC4RVaB8SAjMpxQwSWZbQG/TFkN7oW1Df+h6IRV9C+hCpKUSIZUXOfGM5tAKViijFFEyfZ7Ol29S1Pbdzl8Uw9+aBu91zzv3/nt17zt2DEZjBYOAkKrtFMXIghAWM8U2vMN/FctsxGRMpM7NbEEYNMM2CYUSInlJx3OpawO9i+XSNQYkmk2uFb9njzkcfVSr1p/GJiQKMULVaw2WuBv296UKRxWJR6wxGCmM1EAhSNppv33GBH9qI32cPTAtss9lUm6EM3N7R+RbigT+5/CeosFCZKpjEW+iorS1pb30wDUXzQfHqtD/9L3ieZ2ee1OJCmbL8QHnRs+4uj0wmW4QzrpCwvJ8zGg3JqAmhTLynuLiwv8/5KyND8Q3cEkUEDWu15oJE4KRQJt5hs1rcriGNRqP+DK4dyyWXXm/aFQ+cEpSJ8/LyDGPuEZNOmzsOroUSOqzXG/dtBU4ZysTZYKNut91sNo2Cq6cE9enz86s2g9OCMrFSqVC5hgb32u072W3jKMU90Hb1seC0oUwsB+t92bO/rKx0EFGkgFCnjjc1/gVvC8rE0L+4o63t4InjxwbAJQjTe3qD8QrLkXA4DC24fWtuajp06cLFYSBIFKGmXKPRRmAnME9sPt+yLwIWb9WN69fKoTneQz4Dh2mpPNkvfeV0jjecb9wNAkwIEVQq5VJOds4Kb+DXoAsiVquVwI1Dougpij6UyGYx+5cKroeDEFibm5lWRRMbH1+npmYrq6qhwlQHIbajZEf1fElcqGGFpGg9HMuKzpfBjhytCTMgkJ56RX09zy/ysENTBElmjIgJnmNChJqohDVQqpEfwkILE8v/o0GAnV9F1eEvofVQCbiTBEXOIPQh5PGgefDZeAcjrpGZjULBr/m3tZOnz7oEQWRAQZLjWlEU/XEJWySiILgRc5Cz1DkcAyuBFcnpfF0JiXWKpcolQXizhS5hKAqFpr0MVbgbuxJ6+5xX+P4wNpbqPPrugZfbmIbLmgQR3Aw8QSi66hUXulOFbF73GxqjE5BNXWNeAAAAAElFTkSuQmCC\"\n\n\treturn (\n\t\t<img\n\t\t\tsrc={cursorBase64}\n\t\t\tstyle={{\n\t\t\t\twidth: \"17px\",\n\t\t\t\theight: \"22px\",\n\t\t\t\t...style,\n\t\t\t}}\n\t\t\talt=\"cursor\"\n\t\t/>\n\t)\n}\n\nexport default BrowserSessionRow\n", "tag": "", "tokens": 5807, "metadata": {}}], "modify_time": 1733144568.7369542}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/ChatView.tsx", "relative_path": "cline/webview-ui/src/components/chat/ChatView.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/ChatView.tsx", "source_code": "import { VSCodeButton, VSCodeLink } from \"@vscode/webview-ui-toolkit/react\"\nimport debounce from \"debounce\"\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\"\nimport { useDeepCompareEffect, useEvent, useMount } from \"react-use\"\nimport { Virtuoso, type VirtuosoHandle } from \"react-virtuoso\"\nimport styled from \"styled-components\"\nimport {\n\tClineAsk,\n\tClineMessage,\n\tClineSayBrowserAction,\n\tClineSayTool,\n\tExtensionMessage,\n} from \"../../../../src/shared/ExtensionMessage\"\nimport { findLast } from \"../../../../src/shared/array\"\nimport { combineApiRequests } from \"../../../../src/shared/combineApiRequests\"\nimport { combineCommandSequences } from \"../../../../src/shared/combineCommandSequences\"\nimport { getApiMetrics } from \"../../../../src/shared/getApiMetrics\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport { vscode } from \"../../utils/vscode\"\nimport HistoryPreview from \"../history/HistoryPreview\"\nimport { normalizeApiConfiguration } from \"../settings/ApiOptions\"\nimport Announcement from \"./Announcement\"\nimport BrowserSessionRow from \"./BrowserSessionRow\"\nimport ChatRow from \"./ChatRow\"\nimport ChatTextArea from \"./ChatTextArea\"\nimport TaskHeader from \"./TaskHeader\"\n\ninterface ChatViewProps {\n\tisHidden: boolean\n\tshowAnnouncement: boolean\n\thideAnnouncement: () => void\n\tshowHistoryView: () => void\n}\n\nexport const MAX_IMAGES_PER_MESSAGE = 20 // Anthropic limits to 20 images\n\nconst ChatView = ({ isHidden, showAnnouncement, hideAnnouncement, showHistoryView }: ChatViewProps) => {\n\tconst { version, clineMessages: messages, taskHistory, apiConfiguration } = useExtensionState()\n\n\t//const task = messages.length > 0 ? (messages[0].say === \"task\" ? messages[0] : undefined) : undefined) : undefined\n\tconst task = useMemo(() => messages.at(0), [messages]) // leaving this less safe version here since if the first message is not a task, then the extension is in a bad state and needs to be debugged (see Cline.abort)\n\tconst modifiedMessages = useMemo(() => combineApiRequests(combineCommandSequences(messages.slice(1))), [messages])\n\t// has to be after api_req_finished are all reduced into api_req_started messages\n\tconst apiMetrics = useMemo(() => getApiMetrics(modifiedMessages), [modifiedMessages])\n\n\tconst [inputValue, setInputValue] = useState(\"\")\n\tconst textAreaRef = useRef<HTMLTextAreaElement>(null)\n\tconst [textAreaDisabled, setTextAreaDisabled] = useState(false)\n\tconst [selectedImages, setSelectedImages] = useState<string[]>([])\n\n\t// we need to hold on to the ask because useEffect > lastMessage will always let us know when an ask comes in and handle it, but by the time handleMessage is called, the last message might not be the ask anymore (it could be a say that followed)\n\tconst [clineAsk, setClineAsk] = useState<ClineAsk | undefined>(undefined)\n\tconst [enableButtons, setEnableButtons] = useState<boolean>(false)\n\tconst [primaryButtonText, setPrimaryButtonText] = useState<string | undefined>(undefined)\n\tconst [secondaryButtonText, setSecondaryButtonText] = useState<string | undefined>(undefined)\n\tconst [didClickCancel, setDidClickCancel] = useState(false)\n\tconst virtuosoRef = useRef<VirtuosoHandle>(null)\n\tconst [expandedRows, setExpandedRows] = useState<Record<number, boolean>>({})\n\tconst scrollContainerRef = useRef<HTMLDivElement>(null)\n\tconst disableAutoScrollRef = useRef(false)\n\tconst [showScrollToBottom, setShowScrollToBottom] = useState(false)\n\tconst [isAtBottom, setIsAtBottom] = useState(false)\n\n\t// UI layout depends on the last 2 messages\n\t// (since it relies on the content of these messages, we are deep comparing. i.e. the button state after hitting button sets enableButtons to false, and this effect otherwise would have to true again even if messages didn't change\n\tconst lastMessage = useMemo(() => messages.at(-1), [messages])\n\tconst secondLastMessage = useMemo(() => messages.at(-2), [messages])\n\tuseDeepCompareEffect(() => {\n\t\t// if last message is an ask, show user ask UI\n\t\t// if user finished a task, then start a new task with a new conversation history since in this moment that the extension is waiting for user response, the user could close the extension and the conversation history would be lost.\n\t\t// basically as long as a task is active, the conversation history will be persisted\n\t\tif (lastMessage) {\n\t\t\tswitch (lastMessage.type) {\n\t\t\t\tcase \"ask\":\n\t\t\t\t\tconst isPartial = lastMessage.partial === true\n\t\t\t\t\tswitch (lastMessage.ask) {\n\t\t\t\t\t\tcase \"api_req_failed\":\n\t\t\t\t\t\t\tsetTextAreaDisabled(true)\n\t\t\t\t\t\t\tsetClineAsk(\"api_req_failed\")\n\t\t\t\t\t\t\tsetEnableButtons(true)\n\t\t\t\t\t\t\tsetPrimaryButtonText(\"Retry\")\n\t\t\t\t\t\t\tsetSecondaryButtonText(\"Start New Task\")\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"mistake_limit_reached\":\n\t\t\t\t\t\t\tsetTextAreaDisabled(false)\n\t\t\t\t\t\t\tsetClineAsk(\"mistake_limit_reached\")\n\t\t\t\t\t\t\tsetEnableButtons(true)\n\t\t\t\t\t\t\tsetPrimaryButtonText(\"Proceed Anyways\")\n\t\t\t\t\t\t\tsetSecondaryButtonText(\"Start New Task\")\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"followup\":\n\t\t\t\t\t\t\tsetTextAreaDisabled(isPartial)\n\t\t\t\t\t\t\tsetClineAsk(\"followup\")\n\t\t\t\t\t\t\tsetEnableButtons(isPartial)\n\t\t\t\t\t\t\t// setPrimaryButtonText(undefined)\n\t\t\t\t\t\t\t// setSecondaryButtonText(undefined)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"tool\":\n\t\t\t\t\t\t\tsetTextAreaDisabled(isPartial)\n\t\t\t\t\t\t\tsetClineAsk(\"tool\")\n\t\t\t\t\t\t\tsetEnableButtons(!isPartial)\n\t\t\t\t\t\t\tconst tool = JSON.parse(lastMessage.text || \"{}\") as ClineSayTool\n\t\t\t\t\t\t\tswitch (tool.tool) {\n\t\t\t\t\t\t\t\tcase \"editedExistingFile\":\n\t\t\t\t\t\t\t\tcase \"newFileCreated\":\n\t\t\t\t\t\t\t\t\tsetPrimaryButtonText(\"Save\")\n\t\t\t\t\t\t\t\t\tsetSecondaryButtonText(\"Reject\")\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\tsetPrimaryButtonText(\"Approve\")\n\t\t\t\t\t\t\t\t\tsetSecondaryButtonText(\"Reject\")\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"browser_action_launch\":\n\t\t\t\t\t\t\tsetTextAreaDisabled(isPartial)\n\t\t\t\t\t\t\tsetClineAsk(\"browser_action_launch\")\n\t\t\t\t\t\t\tsetEnableButtons(!isPartial)\n\t\t\t\t\t\t\tsetPrimaryButtonText(\"Approve\")\n\t\t\t\t\t\t\tsetSecondaryButtonText(\"Reject\")\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"command\":\n\t\t\t\t\t\t\tsetTextAreaDisabled(isPartial)\n\t\t\t\t\t\t\tsetClineAsk(\"command\")\n\t\t\t\t\t\t\tsetEnableButtons(!isPartial)\n\t\t\t\t\t\t\tsetPrimaryButtonText(\"Run Command\")\n\t\t\t\t\t\t\tsetSecondaryButtonText(\"Reject\")\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"command_output\":\n\t\t\t\t\t\t\tsetTextAreaDisabled(false)\n\t\t\t\t\t\t\tsetClineAsk(\"command_output\")\n\t\t\t\t\t\t\tsetEnableButtons(true)\n\t\t\t\t\t\t\tsetPrimaryButtonText(\"Proceed While Running\")\n\t\t\t\t\t\t\tsetSecondaryButtonText(undefined)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"completion_result\":\n\t\t\t\t\t\t\t// extension waiting for feedback. but we can just present a new task button\n\t\t\t\t\t\t\tsetTextAreaDisabled(isPartial)\n\t\t\t\t\t\t\tsetClineAsk(\"completion_result\")\n\t\t\t\t\t\t\tsetEnableButtons(!isPartial)\n\t\t\t\t\t\t\tsetPrimaryButtonText(\"Start New Task\")\n\t\t\t\t\t\t\tsetSecondaryButtonText(undefined)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"resume_task\":\n\t\t\t\t\t\t\tsetTextAreaDisabled(false)\n\t\t\t\t\t\t\tsetClineAsk(\"resume_task\")\n\t\t\t\t\t\t\tsetEnableButtons(true)\n\t\t\t\t\t\t\tsetPrimaryButtonText(\"Resume Task\")\n\t\t\t\t\t\t\tsetSecondaryButtonText(undefined)\n\t\t\t\t\t\t\tsetDidClickCancel(false) // special case where we reset the cancel button state\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"resume_completed_task\":\n\t\t\t\t\t\t\tsetTextAreaDisabled(false)\n\t\t\t\t\t\t\tsetClineAsk(\"resume_completed_task\")\n\t\t\t\t\t\t\tsetEnableButtons(true)\n\t\t\t\t\t\t\tsetPrimaryButtonText(\"Start New Task\")\n\t\t\t\t\t\t\tsetSecondaryButtonText(undefined)\n\t\t\t\t\t\t\tsetDidClickCancel(false)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"say\":\n\t\t\t\t\t// don't want to reset since there could be a \"say\" after an \"ask\" while ask is waiting for response\n\t\t\t\t\tswitch (lastMessage.say) {\n\t\t\t\t\t\tcase \"api_req_started\":\n\t\t\t\t\t\t\tif (secondLastMessage?.ask === \"command_output\") {\n\t\t\t\t\t\t\t\t// if the last ask is a command_output, and we receive an api_req_started, then that means the command has finished and we don't need input from the user anymore (in every other case, the user has to interact with input field or buttons to continue, which does the following automatically)\n\t\t\t\t\t\t\t\tsetInputValue(\"\")\n\t\t\t\t\t\t\t\tsetTextAreaDisabled(true)\n\t\t\t\t\t\t\t\tsetSelectedImages([])\n\t\t\t\t\t\t\t\tsetClineAsk(undefined)\n\t\t\t\t\t\t\t\tsetEnableButtons(false)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"task\":\n\t\t\t\t\t\tcase \"error\":\n\t\t\t\t\t\tcase \"api_req_finished\":\n\t\t\t\t\t\tcase \"text\":\n\t\t\t\t\t\tcase \"browser_action\":\n\t\t\t\t\t\tcase \"browser_action_result\":\n\t\t\t\t\t\tcase \"command_output\":\n\t\t\t\t\t\tcase \"completion_result\":\n\t\t\t\t\t\tcase \"tool\":\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t} else {\n\t\t\t// this would get called after sending the first message, so we have to watch messages.length instead\n\t\t\t// No messages, so user has to submit a task\n\t\t\t// setTextAreaDisabled(false)\n\t\t\t// setClineAsk(undefined)\n\t\t\t// setPrimaryButtonText(undefined)\n\t\t\t// setSecondaryButtonText(undefined)\n\t\t}\n\t}, [lastMessage, secondLastMessage])\n\n\tuseEffect(() => {\n\t\tif (messages.length === 0) {\n\t\t\tsetTextAreaDisabled(false)\n\t\t\tsetClineAsk(undefined)\n\t\t\tsetEnableButtons(false)\n\t\t\tsetPrimaryButtonText(undefined)\n\t\t\tsetSecondaryButtonText(undefined)\n\t\t}\n\t}, [messages.length])\n\n\tuseEffect(() => {\n\t\tsetExpandedRows({})\n\t}, [task?.ts])\n\n\tconst isStreaming = useMemo(() => {\n\t\tconst isLastAsk = !!modifiedMessages.at(-1)?.ask // checking clineAsk isn't enough since messages effect may be called again for a tool for example, set clineAsk to its value, and if the next message is not an ask then it doesn't reset. This is likely due to how much more often we're updating messages as compared to before, and should be resolved with optimizations as it's likely a rendering bug. but as a final guard for now, the cancel button will show if the last message is not an ask\n\t\tconst isToolCurrentlyAsking =\n\t\t\tisLastAsk && clineAsk !== undefined && enableButtons && primaryButtonText !== undefined\n\t\tif (isToolCurrentlyAsking) {\n\t\t\treturn false\n\t\t}\n\n\t\tconst isLastMessagePartial = modifiedMessages.at(-1)?.partial === true\n\t\tif (isLastMessagePartial) {\n\t\t\treturn true\n\t\t} else {\n\t\t\tconst lastApiReqStarted = findLast(modifiedMessages, (message) => message.say === \"api_req_started\")\n\t\t\tif (lastApiReqStarted && lastApiReqStarted.text != null && lastApiReqStarted.say === \"api_req_started\") {\n\t\t\t\tconst cost = JSON.parse(lastApiReqStarted.text).cost\n\t\t\t\tif (cost === undefined) {\n\t\t\t\t\t// api request has not finished yet\n\t\t\t\t\treturn true\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn false\n\t}, [modifiedMessages, clineAsk, enableButtons, primaryButtonText])\n\n\tconst handleSendMessage = useCallback(\n\t\t(text: string, images: string[]) => {\n\t\t\ttext = text.trim()\n\t\t\tif (text || images.length > 0) {\n\t\t\t\tif (messages.length === 0) {\n\t\t\t\t\tvscode.postMessage({ type: \"newTask\", text, images })\n\t\t\t\t} else if (clineAsk) {\n\t\t\t\t\tswitch (clineAsk) {\n\t\t\t\t\t\tcase \"followup\":\n\t\t\t\t\t\tcase \"tool\":\n\t\t\t\t\t\tcase \"browser_action_launch\":\n\t\t\t\t\t\tcase \"command\": // user can provide feedback to a tool or command use\n\t\t\t\t\t\tcase \"command_output\": // user can send input to command stdin\n\t\t\t\t\t\tcase \"completion_result\": // if this happens then the user has feedback for the completion result\n\t\t\t\t\t\tcase \"resume_task\":\n\t\t\t\t\t\tcase \"resume_completed_task\":\n\t\t\t\t\t\tcase \"mistake_limit_reached\":\n\t\t\t\t\t\t\tvscode.postMessage({\n\t\t\t\t\t\t\t\ttype: \"askResponse\",\n\t\t\t\t\t\t\t\taskResponse: \"messageResponse\",\n\t\t\t\t\t\t\t\ttext,\n\t\t\t\t\t\t\t\timages,\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t// there is no other case that a textfield should be enabled\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsetInputValue(\"\")\n\t\t\t\tsetTextAreaDisabled(true)\n\t\t\t\tsetSelectedImages([])\n\t\t\t\tsetClineAsk(undefined)\n\t\t\t\tsetEnableButtons(false)\n\t\t\t\t// setPrimaryButtonText(undefined)\n\t\t\t\t// setSecondaryButtonText(undefined)\n\t\t\t\tdisableAutoScrollRef.current = false\n\t\t\t}\n\t\t},\n\t\t[messages.length, clineAsk],\n\t)\n\n\tconst startNewTask = useCallback(() => {\n\t\tvscode.postMessage({ type: \"clearTask\" })\n\t}, [])\n\n\t/*\n\tThis logic depends on the useEffect[messages] above to set clineAsk, after which buttons are shown and we then send an askResponse to the extension.\n\t*/\n\tconst handlePrimaryButtonClick = useCallback(() => {\n\t\tswitch (clineAsk) {\n\t\t\tcase \"api_req_failed\":\n\t\t\tcase \"command\":\n\t\t\tcase \"command_output\":\n\t\t\tcase \"tool\":\n\t\t\tcase \"browser_action_launch\":\n\t\t\tcase \"resume_task\":\n\t\t\tcase \"mistake_limit_reached\":\n\t\t\t\tvscode.postMessage({ type: \"askResponse\", askResponse: \"yesButtonClicked\" })\n\t\t\t\tbreak\n\t\t\tcase \"completion_result\":\n\t\t\tcase \"resume_completed_task\":\n\t\t\t\t// extension waiting for feedback. but we can just present a new task button\n\t\t\t\tstartNewTask()\n\t\t\t\tbreak\n\t\t}\n\t\tsetTextAreaDisabled(true)\n\t\tsetClineAsk(undefined)\n\t\tsetEnableButtons(false)\n\t\t// setPrimaryButtonText(undefined)\n\t\t// setSecondaryButtonText(undefined)\n\t\tdisableAutoScrollRef.current = false\n\t}, [clineAsk, startNewTask])\n\n\tconst handleSecondaryButtonClick = useCallback(() => {\n\t\tif (isStreaming) {\n\t\t\tvscode.postMessage({ type: \"cancelTask\" })\n\t\t\tsetDidClickCancel(true)\n\t\t\treturn\n\t\t}\n\n\t\tswitch (clineAsk) {\n\t\t\tcase \"api_req_failed\":\n\t\t\tcase \"mistake_limit_reached\":\n\t\t\t\tstartNewTask()\n\t\t\t\tbreak\n\t\t\tcase \"command\":\n\t\t\tcase \"tool\":\n\t\t\tcase \"browser_action_launch\":\n\t\t\t\t// responds to the API with a \"This operation failed\" and lets it try again\n\t\t\t\tvscode.postMessage({ type: \"askResponse\", askResponse: \"noButtonClicked\" })\n\t\t\t\tbreak\n\t\t}\n\t\tsetTextAreaDisabled(true)\n\t\tsetClineAsk(undefined)\n\t\tsetEnableButtons(false)\n\t\t// setPrimaryButtonText(undefined)\n\t\t// setSecondaryButtonText(undefined)\n\t\tdisableAutoScrollRef.current = false\n\t}, [clineAsk, startNewTask, isStreaming])\n\n\tconst handleTaskCloseButtonClick = useCallback(() => {\n\t\tstartNewTask()\n\t}, [startNewTask])\n\n\tconst { selectedModelInfo } = useMemo(() => {\n\t\treturn normalizeApiConfiguration(apiConfiguration)\n\t}, [apiConfiguration])\n\n\tconst selectImages = useCallback(() => {\n\t\tvscode.postMessage({ type: \"selectImages\" })\n\t}, [])\n\n\tconst shouldDisableImages =\n\t\t!selectedModelInfo.supportsImages || textAreaDisabled || selectedImages.length >= MAX_IMAGES_PER_MESSAGE\n\n\tconst handleMessage = useCallback(\n\t\t(e: MessageEvent) => {\n\t\t\tconst message: ExtensionMessage = e.data\n\t\t\tswitch (message.type) {\n\t\t\t\tcase \"action\":\n\t\t\t\t\tswitch (message.action!) {\n\t\t\t\t\t\tcase \"didBecomeVisible\":\n\t\t\t\t\t\t\tif (!isHidden && !textAreaDisabled && !enableButtons) {\n\t\t\t\t\t\t\t\ttextAreaRef.current?.focus()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"selectedImages\":\n\t\t\t\t\tconst newImages = message.images ?? []\n\t\t\t\t\tif (newImages.length > 0) {\n\t\t\t\t\t\tsetSelectedImages((prevImages) =>\n\t\t\t\t\t\t\t[...prevImages, ...newImages].slice(0, MAX_IMAGES_PER_MESSAGE),\n\t\t\t\t\t\t)\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"invoke\":\n\t\t\t\t\tswitch (message.invoke!) {\n\t\t\t\t\t\tcase \"sendMessage\":\n\t\t\t\t\t\t\thandleSendMessage(message.text ?? \"\", message.images ?? [])\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"primaryButtonClick\":\n\t\t\t\t\t\t\thandlePrimaryButtonClick()\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"secondaryButtonClick\":\n\t\t\t\t\t\t\thandleSecondaryButtonClick()\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t}\n\t\t\t// textAreaRef.current is not explicitly required here since react gaurantees that ref will be stable across re-renders, and we're not using its value but its reference.\n\t\t},\n\t\t[\n\t\t\tisHidden,\n\t\t\ttextAreaDisabled,\n\t\t\tenableButtons,\n\t\t\thandleSendMessage,\n\t\t\thandlePrimaryButtonClick,\n\t\t\thandleSecondaryButtonClick,\n\t\t],\n\t)\n\n\tuseEvent(\"message\", handleMessage)\n\n\tuseMount(() => {\n\t\t// NOTE: the vscode window needs to be focused for this to work\n\t\ttextAreaRef.current?.focus()\n\t})\n\n\tuseEffect(() => {\n\t\tconst timer = setTimeout(() => {\n\t\t\tif (!isHidden && !textAreaDisabled && !enableButtons) {\n\t\t\t\ttextAreaRef.current?.focus()\n\t\t\t}\n\t\t}, 50)\n\t\treturn () => {\n\t\t\tclearTimeout(timer)\n\t\t}\n\t}, [isHidden, textAreaDisabled, enableButtons])\n\n\tconst visibleMessages = useMemo(() => {\n\t\treturn modifiedMessages.filter((message) => {\n\t\t\tswitch (message.ask) {\n\t\t\t\tcase \"completion_result\":\n\t\t\t\t\t// don't show a chat row for a completion_result ask without text. This specific type of message only occurs if cline wants to execute a command as part of its completion result, in which case we interject the completion_result tool with the execute_command tool.\n\t\t\t\t\tif (message.text === \"\") {\n\t\t\t\t\t\treturn false\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"api_req_failed\": // this message is used to update the latest api_req_started that the request failed\n\t\t\t\tcase \"resume_task\":\n\t\t\t\tcase \"resume_completed_task\":\n\t\t\t\t\treturn false\n\t\t\t}\n\t\t\tswitch (message.say) {\n\t\t\t\tcase \"api_req_finished\": // combineApiRequests removes this from modifiedMessages anyways\n\t\t\t\tcase \"api_req_retried\": // this message is used to update the latest api_req_started that the request was retried\n\t\t\t\t\treturn false\n\t\t\t\tcase \"text\":\n\t\t\t\t\t// Sometimes cline returns an empty text message, we don't want to render these. (We also use a say text for user messages, so in case they just sent images we still render that)\n\t\t\t\t\tif ((message.text ?? \"\") === \"\" && (message.images?.length ?? 0) === 0) {\n\t\t\t\t\t\treturn false\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}, [modifiedMessages])\n\n\tconst isBrowserSessionMessage = (message: ClineMessage): boolean => {\n\t\t// which of visible messages are browser session messages, see above\n\t\tif (message.type === \"ask\") {\n\t\t\treturn [\"browser_action_launch\"].includes(message.ask!)\n\t\t}\n\t\tif (message.type === \"say\") {\n\t\t\treturn [\"api_req_started\", \"text\", \"browser_action\", \"browser_action_result\"].includes(message.say!)\n\t\t}\n\t\treturn false\n\t}\n\n\tconst groupedMessages = useMemo(() => {\n\t\tconst result: (ClineMessage | ClineMessage[])[] = []\n\t\tlet currentGroup: ClineMessage[] = []\n\t\tlet isInBrowserSession = false\n\n\t\tconst endBrowserSession = () => {\n\t\t\tif (currentGroup.length > 0) {\n\t\t\t\tresult.push([...currentGroup])\n\t\t\t\tcurrentGroup = []\n\t\t\t\tisInBrowserSession = false\n\t\t\t}\n\t\t}\n\n\t\tvisibleMessages.forEach((message) => {\n\t\t\tif (message.ask === \"browser_action_launch\") {\n\t\t\t\t// complete existing browser session if any\n\t\t\t\tendBrowserSession()\n\t\t\t\t// start new\n\t\t\t\tisInBrowserSession = true\n\t\t\t\tcurrentGroup.push(message)\n\t\t\t} else if (isInBrowserSession) {\n\t\t\t\t// end session if api_req_started is cancelled\n\n\t\t\t\tif (message.say === \"api_req_started\") {\n\t\t\t\t\t// get last api_req_started in currentGroup to check if it's cancelled. If it is then this api req is not part of the current browser session\n\t\t\t\t\tconst lastApiReqStarted = [...currentGroup].reverse().find((m) => m.say === \"api_req_started\")\n\t\t\t\t\tif (lastApiReqStarted?.text != null) {\n\t\t\t\t\t\tconst info = JSON.parse(lastApiReqStarted.text)\n\t\t\t\t\t\tconst isCancelled = info.cancelReason != null\n\t\t\t\t\t\tif (isCancelled) {\n\t\t\t\t\t\t\tendBrowserSession()\n\t\t\t\t\t\t\tresult.push(message)\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (isBrowserSessionMessage(message)) {\n\t\t\t\t\tcurrentGroup.push(message)\n\n\t\t\t\t\t// Check if this is a close action\n\t\t\t\t\tif (message.say === \"browser_action\") {\n\t\t\t\t\t\tconst browserAction = JSON.parse(message.text || \"{}\") as ClineSayBrowserAction\n\t\t\t\t\t\tif (browserAction.action === \"close\") {\n\t\t\t\t\t\t\tendBrowserSession()\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// complete existing browser session if any\n\t\t\t\t\tendBrowserSession()\n\t\t\t\t\tresult.push(message)\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tresult.push(message)\n\t\t\t}\n\t\t})\n\n\t\t// Handle case where browser session is the last group\n\t\tif (currentGroup.length > 0) {\n\t\t\tresult.push([...currentGroup])\n\t\t}\n\n\t\treturn result\n\t}, [visibleMessages])\n\n\t// scrolling\n\n\tconst scrollToBottomSmooth = useMemo(\n\t\t() =>\n\t\t\tdebounce(\n\t\t\t\t() => {\n\t\t\t\t\tvirtuosoRef.current?.scrollTo({\n\t\t\t\t\t\ttop: Number.MAX_SAFE_INTEGER,\n\t\t\t\t\t\tbehavior: \"smooth\",\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t\t10,\n\t\t\t\t{ immediate: true },\n\t\t\t),\n\t\t[],\n\t)\n\n\tconst scrollToBottomAuto = useCallback(() => {\n\t\tvirtuosoRef.current?.scrollTo({\n\t\t\ttop: Number.MAX_SAFE_INTEGER,\n\t\t\tbehavior: \"auto\", // instant causes crash\n\t\t})\n\t}, [])\n\n\t// scroll when user toggles certain rows\n\tconst toggleRowExpansion = useCallback(\n\t\t(ts: number) => {\n\t\t\tconst isCollapsing = expandedRows[ts] ?? false\n\t\t\tconst lastGroup = groupedMessages.at(-1)\n\t\t\tconst isLast = Array.isArray(lastGroup) ? lastGroup[0].ts === ts : lastGroup?.ts === ts\n\t\t\tconst secondToLastGroup = groupedMessages.at(-2)\n\t\t\tconst isSecondToLast = Array.isArray(secondToLastGroup)\n\t\t\t\t? secondToLastGroup[0].ts === ts\n\t\t\t\t: secondToLastGroup?.ts === ts\n\n\t\t\tconst isLastCollapsedApiReq =\n\t\t\t\tisLast &&\n\t\t\t\t!Array.isArray(lastGroup) && // Make sure it's not a browser session group\n\t\t\t\tlastGroup?.say === \"api_req_started\" &&\n\t\t\t\t!expandedRows[lastGroup.ts]\n\n\t\t\tsetExpandedRows((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\t[ts]: !prev[ts],\n\t\t\t}))\n\n\t\t\t// disable auto scroll when user expands row\n\t\t\tif (!isCollapsing) {\n\t\t\t\tdisableAutoScrollRef.current = true\n\t\t\t}\n\n\t\t\tif (isCollapsing && isAtBottom) {\n\t\t\t\tconst timer = setTimeout(() => {\n\t\t\t\t\tscrollToBottomAuto()\n\t\t\t\t}, 0)\n\t\t\t\treturn () => clearTimeout(timer)\n\t\t\t} else if (isLast || isSecondToLast) {\n\t\t\t\tif (isCollapsing) {\n\t\t\t\t\tif (isSecondToLast && !isLastCollapsedApiReq) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tconst timer = setTimeout(() => {\n\t\t\t\t\t\tscrollToBottomAuto()\n\t\t\t\t\t}, 0)\n\t\t\t\t\treturn () => clearTimeout(timer)\n\t\t\t\t} else {\n\t\t\t\t\tconst timer = setTimeout(() => {\n\t\t\t\t\t\tvirtuosoRef.current?.scrollToIndex({\n\t\t\t\t\t\t\tindex: groupedMessages.length - (isLast ? 1 : 2),\n\t\t\t\t\t\t\talign: \"start\",\n\t\t\t\t\t\t})\n\t\t\t\t\t}, 0)\n\t\t\t\t\treturn () => clearTimeout(timer)\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t[groupedMessages, expandedRows, scrollToBottomAuto, isAtBottom],\n\t)\n\n\tconst handleRowHeightChange = useCallback(\n\t\t(isTaller: boolean) => {\n\t\t\tif (!disableAutoScrollRef.current) {\n\t\t\t\tif (isTaller) {\n\t\t\t\t\tscrollToBottomSmooth()\n\t\t\t\t} else {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tscrollToBottomAuto()\n\t\t\t\t\t}, 0)\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t[scrollToBottomSmooth, scrollToBottomAuto],\n\t)\n\n\tuseEffect(() => {\n\t\tif (!disableAutoScrollRef.current) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tscrollToBottomSmooth()\n\t\t\t}, 50)\n\t\t\t// return () => clearTimeout(timer) // dont cleanup since if visibleMessages.length changes it cancels.\n\t\t}\n\t}, [groupedMessages.length, scrollToBottomSmooth])\n\n\tconst handleWheel = useCallback((event: Event) => {\n\t\tconst wheelEvent = event as WheelEvent\n\t\tif (wheelEvent.deltaY && wheelEvent.deltaY < 0) {\n\t\t\tif (scrollContainerRef.current?.contains(wheelEvent.target as Node)) {\n\t\t\t\t// user scrolled up\n\t\t\t\tdisableAutoScrollRef.current = true\n\t\t\t}\n\t\t}\n\t}, [])\n\tuseEvent(\"wheel\", handleWheel, window, { passive: true }) // passive improves scrolling performance\n\n\tconst placeholderText = useMemo(() => {\n\t\tconst text = task ? \"Type a message (@ to add context)...\" : \"Type your task here (@ to add context)...\"\n\t\treturn text\n\t}, [task])\n\n\tconst itemContent = useCallback(\n\t\t(index: number, messageOrGroup: ClineMessage | ClineMessage[]) => {\n\t\t\t// browser session group\n\t\t\tif (Array.isArray(messageOrGroup)) {\n\t\t\t\treturn (\n\t\t\t\t\t<BrowserSessionRow\n\t\t\t\t\t\tmessages={messageOrGroup}\n\t\t\t\t\t\tisLast={index === groupedMessages.length - 1}\n\t\t\t\t\t\tlastModifiedMessage={modifiedMessages.at(-1)}\n\t\t\t\t\t\tonHeightChange={handleRowHeightChange}\n\t\t\t\t\t\t// Pass handlers for each message in the group\n\t\t\t\t\t\tisExpanded={(messageTs: number) => expandedRows[messageTs] ?? false}\n\t\t\t\t\t\tonToggleExpand={(messageTs: number) => {\n\t\t\t\t\t\t\tsetExpandedRows((prev) => ({\n\t\t\t\t\t\t\t\t...prev,\n\t\t\t\t\t\t\t\t[messageTs]: !prev[messageTs],\n\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t)\n\t\t\t}\n\n\t\t\t// regular message\n\t\t\treturn (\n\t\t\t\t<ChatRow\n\t\t\t\t\tkey={messageOrGroup.ts}\n\t\t\t\t\tmessage={messageOrGroup}\n\t\t\t\t\tisExpanded={expandedRows[messageOrGroup.ts] || false}\n\t\t\t\t\tonToggleExpand={() => toggleRowExpansion(messageOrGroup.ts)}\n\t\t\t\t\tlastModifiedMessage={modifiedMessages.at(-1)}\n\t\t\t\t\tisLast={index === groupedMessages.length - 1}\n\t\t\t\t\tonHeightChange={handleRowHeightChange}\n\t\t\t\t/>\n\t\t\t)\n\t\t},\n\t\t[expandedRows, modifiedMessages, groupedMessages.length, toggleRowExpansion, handleRowHeightChange],\n\t)\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: \"fixed\",\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t\tdisplay: isHidden ? \"none\" : \"flex\",\n\t\t\t\tflexDirection: \"column\",\n\t\t\t\toverflow: \"hidden\",\n\t\t\t}}>\n\t\t\t{task ? (\n\t\t\t\t<TaskHeader\n\t\t\t\t\ttask={task}\n\t\t\t\t\ttokensIn={apiMetrics.totalTokensIn}\n\t\t\t\t\ttokensOut={apiMetrics.totalTokensOut}\n\t\t\t\t\tdoesModelSupportPromptCache={selectedModelInfo.supportsPromptCache}\n\t\t\t\t\tcacheWrites={apiMetrics.totalCacheWrites}\n\t\t\t\t\tcacheReads={apiMetrics.totalCacheReads}\n\t\t\t\t\ttotalCost={apiMetrics.totalCost}\n\t\t\t\t\tonClose={handleTaskCloseButtonClick}\n\t\t\t\t/>\n\t\t\t) : (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tflexGrow: 1,\n\t\t\t\t\t\toverflowY: \"auto\",\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\tflexDirection: \"column\",\n\t\t\t\t\t}}>\n\t\t\t\t\t{showAnnouncement && <Announcement version={version} hideAnnouncement={hideAnnouncement} />}\n\t\t\t\t\t<div style={{ padding: \"0 20px\", flexShrink: 0 }}>\n\t\t\t\t\t\t<h2>What can I do for you?</h2>\n\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\tThanks to{\" \"}\n\t\t\t\t\t\t\t<VSCodeLink\n\t\t\t\t\t\t\t\thref=\"https://www-cdn.anthropic.com/fed9cc193a14b84131812372d8d5857f8f304c52/Model_Card_Claude_3_Addendum.pdf\"\n\t\t\t\t\t\t\t\tstyle={{ display: \"inline\" }}>\n\t\t\t\t\t\t\t\tClaude 3.5 Sonnet's agentic coding capabilities,\n\t\t\t\t\t\t\t</VSCodeLink>{\" \"}\n\t\t\t\t\t\t\tI can handle complex software development tasks step-by-step. With tools that let me create\n\t\t\t\t\t\t\t& edit files, explore complex projects, use the browser, and execute terminal commands\n\t\t\t\t\t\t\t(after you grant permission), I can assist you in ways that go beyond code completion or\n\t\t\t\t\t\t\ttech support.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t{taskHistory.length > 0 && <HistoryPreview showHistoryView={showHistoryView} />}\n\t\t\t\t</div>\n\t\t\t)}\n\t\t\t{task && (\n\t\t\t\t<>\n\t\t\t\t\t<div style={{ flexGrow: 1, display: \"flex\" }} ref={scrollContainerRef}>\n\t\t\t\t\t\t<Virtuoso\n\t\t\t\t\t\t\tref={virtuosoRef}\n\t\t\t\t\t\t\tkey={task.ts} // trick to make sure virtuoso re-renders when task changes, and we use initialTopMostItemIndex to start at the bottom\n\t\t\t\t\t\t\tclassName=\"scrollable\"\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tflexGrow: 1,\n\t\t\t\t\t\t\t\toverflowY: \"scroll\", // always show scrollbar\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tcomponents={{\n\t\t\t\t\t\t\t\tFooter: () => <div style={{ height: 5 }} />, // Add empty padding at the bottom\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t// increasing top by 3_000 to prevent jumping around when user collapses a row\n\t\t\t\t\t\t\tincreaseViewportBy={{ top: 3_000, bottom: Number.MAX_SAFE_INTEGER }} // hack to make sure the last message is always rendered to get truly perfect scroll to bottom animation when new messages are added (Number.MAX_SAFE_INTEGER is safe for arithmetic operations, which is all virtuoso uses this value for in src/sizeRangeSystem.ts)\n\t\t\t\t\t\t\tdata={groupedMessages} // messages is the raw format returned by extension, modifiedMessages is the manipulated structure that combines certain messages of related type, and visibleMessages is the filtered structure that removes messages that should not be rendered\n\t\t\t\t\t\t\titemContent={itemContent}\n\t\t\t\t\t\t\tatBottomStateChange={(isAtBottom) => {\n\t\t\t\t\t\t\t\tsetIsAtBottom(isAtBottom)\n\t\t\t\t\t\t\t\tif (isAtBottom) {\n\t\t\t\t\t\t\t\t\tdisableAutoScrollRef.current = false\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tsetShowScrollToBottom(disableAutoScrollRef.current && !isAtBottom)\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tatBottomThreshold={10} // anything lower causes issues with followOutput\n\t\t\t\t\t\t\tinitialTopMostItemIndex={groupedMessages.length - 1}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t{showScrollToBottom ? (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\tpadding: \"10px 15px 0px 15px\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<ScrollToBottomButton\n\t\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\t\tscrollToBottomSmooth()\n\t\t\t\t\t\t\t\t\tdisableAutoScrollRef.current = false\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t<span className=\"codicon codicon-chevron-down\" style={{ fontSize: \"18px\" }}></span>\n\t\t\t\t\t\t\t</ScrollToBottomButton>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\topacity:\n\t\t\t\t\t\t\t\t\tprimaryButtonText || secondaryButtonText || isStreaming\n\t\t\t\t\t\t\t\t\t\t? enableButtons || (isStreaming && !didClickCancel)\n\t\t\t\t\t\t\t\t\t\t\t? 1\n\t\t\t\t\t\t\t\t\t\t\t: 0.5\n\t\t\t\t\t\t\t\t\t\t: 0,\n\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\tpadding: \"10px 15px 0px 15px\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t{primaryButtonText && !isStreaming && (\n\t\t\t\t\t\t\t\t<VSCodeButton\n\t\t\t\t\t\t\t\t\tappearance=\"primary\"\n\t\t\t\t\t\t\t\t\tdisabled={!enableButtons}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: secondaryButtonText ? 1 : 2,\n\t\t\t\t\t\t\t\t\t\tmarginRight: secondaryButtonText ? \"6px\" : \"0\",\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonClick={handlePrimaryButtonClick}>\n\t\t\t\t\t\t\t\t\t{primaryButtonText}\n\t\t\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t{(secondaryButtonText || isStreaming) && (\n\t\t\t\t\t\t\t\t<VSCodeButton\n\t\t\t\t\t\t\t\t\tappearance=\"secondary\"\n\t\t\t\t\t\t\t\t\tdisabled={!enableButtons && !(isStreaming && !didClickCancel)}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tflex: isStreaming ? 2 : 1,\n\t\t\t\t\t\t\t\t\t\tmarginLeft: isStreaming ? 0 : \"6px\",\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\tonClick={handleSecondaryButtonClick}>\n\t\t\t\t\t\t\t\t\t{isStreaming ? \"Cancel\" : secondaryButtonText}\n\t\t\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</>\n\t\t\t)}\n\t\t\t<ChatTextArea\n\t\t\t\tref={textAreaRef}\n\t\t\t\tinputValue={inputValue}\n\t\t\t\tsetInputValue={setInputValue}\n\t\t\t\ttextAreaDisabled={textAreaDisabled}\n\t\t\t\tplaceholderText={placeholderText}\n\t\t\t\tselectedImages={selectedImages}\n\t\t\t\tsetSelectedImages={setSelectedImages}\n\t\t\t\tonSend={() => handleSendMessage(inputValue, selectedImages)}\n\t\t\t\tonSelectImages={selectImages}\n\t\t\t\tshouldDisableImages={shouldDisableImages}\n\t\t\t\tonHeightChange={() => {\n\t\t\t\t\tif (isAtBottom) {\n\t\t\t\t\t\tscrollToBottomAuto()\n\t\t\t\t\t}\n\t\t\t\t}}\n\t\t\t/>\n\t\t</div>\n\t)\n}\n\nconst ScrollToBottomButton = styled.div`\n\tbackground-color: color-mix(in srgb, var(--vscode-toolbar-hoverBackground) 55%, transparent);\n\tborder-radius: 3px;\n\toverflow: hidden;\n\tcursor: pointer;\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n\tflex: 1;\n\theight: 25px;\n\n\t&:hover {\n\t\tbackground-color: color-mix(in srgb, var(--vscode-toolbar-hoverBackground) 90%, transparent);\n\t}\n\n\t&:active {\n\t\tbackground-color: color-mix(in srgb, var(--vscode-toolbar-hoverBackground) 70%, transparent);\n\t}\n`\n\nexport default ChatView\n", "tag": "", "tokens": 8304, "metadata": {}}], "modify_time": 1733144568.7377713}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/ContextMenu.tsx", "relative_path": "cline/webview-ui/src/components/chat/ContextMenu.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/ContextMenu.tsx", "source_code": "import React, { useEffect, useMemo, useRef } from \"react\"\nimport { ContextMenuOptionType, ContextMenuQueryItem, getContextMenuOptions } from \"../../utils/context-mentions\"\nimport { removeLeadingNonAlphanumeric } from \"../common/CodeAccordian\"\n\ninterface ContextMenuProps {\n\tonSelect: (type: ContextMenuOptionType, value?: string) => void\n\tsearchQuery: string\n\tonMouseDown: () => void\n\tselectedIndex: number\n\tsetSelectedIndex: (index: number) => void\n\tselectedType: ContextMenuOptionType | null\n\tqueryItems: ContextMenuQueryItem[]\n}\n\nconst ContextMenu: React.FC<ContextMenuProps> = ({\n\tonSelect,\n\tsearchQuery,\n\tonMouseDown,\n\tselectedIndex,\n\tsetSelectedIndex,\n\tselectedType,\n\tqueryItems,\n}) => {\n\tconst menuRef = useRef<HTMLDivElement>(null)\n\n\tconst filteredOptions = useMemo(\n\t\t() => getContextMenuOptions(searchQuery, selectedType, queryItems),\n\t\t[searchQuery, selectedType, queryItems],\n\t)\n\n\tuseEffect(() => {\n\t\tif (menuRef.current) {\n\t\t\tconst selectedElement = menuRef.current.children[selectedIndex] as HTMLElement\n\t\t\tif (selectedElement) {\n\t\t\t\tconst menuRect = menuRef.current.getBoundingClientRect()\n\t\t\t\tconst selectedRect = selectedElement.getBoundingClientRect()\n\n\t\t\t\tif (selectedRect.bottom > menuRect.bottom) {\n\t\t\t\t\tmenuRef.current.scrollTop += selectedRect.bottom - menuRect.bottom\n\t\t\t\t} else if (selectedRect.top < menuRect.top) {\n\t\t\t\t\tmenuRef.current.scrollTop -= menuRect.top - selectedRect.top\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}, [selectedIndex])\n\n\tconst renderOptionContent = (option: ContextMenuQueryItem) => {\n\t\tswitch (option.type) {\n\t\t\tcase ContextMenuOptionType.Problems:\n\t\t\t\treturn <span>Problems</span>\n\t\t\tcase ContextMenuOptionType.URL:\n\t\t\t\treturn <span>Paste URL to fetch contents</span>\n\t\t\tcase ContextMenuOptionType.NoResults:\n\t\t\t\treturn <span>No results found</span>\n\t\t\tcase ContextMenuOptionType.File:\n\t\t\tcase ContextMenuOptionType.Folder:\n\t\t\t\tif (option.value) {\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<span>/</span>\n\t\t\t\t\t\t\t{option.value?.startsWith(\"/.\") && <span>.</span>}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twhiteSpace: \"nowrap\",\n\t\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\t\ttextOverflow: \"ellipsis\",\n\t\t\t\t\t\t\t\t\tdirection: \"rtl\",\n\t\t\t\t\t\t\t\t\ttextAlign: \"left\",\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t{removeLeadingNonAlphanumeric(option.value || \"\") + \"\\u200E\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)\n\t\t\t\t} else {\n\t\t\t\t\treturn <span>Add {option.type === ContextMenuOptionType.File ? \"File\" : \"Folder\"}</span>\n\t\t\t\t}\n\t\t}\n\t}\n\n\tconst getIconForOption = (option: ContextMenuQueryItem): string => {\n\t\tswitch (option.type) {\n\t\t\tcase ContextMenuOptionType.File:\n\t\t\t\treturn \"file\"\n\t\t\tcase ContextMenuOptionType.Folder:\n\t\t\t\treturn \"folder\"\n\t\t\tcase ContextMenuOptionType.Problems:\n\t\t\t\treturn \"warning\"\n\t\t\tcase ContextMenuOptionType.URL:\n\t\t\t\treturn \"link\"\n\t\t\tcase ContextMenuOptionType.NoResults:\n\t\t\t\treturn \"info\"\n\t\t\tdefault:\n\t\t\t\treturn \"file\"\n\t\t}\n\t}\n\n\tconst isOptionSelectable = (option: ContextMenuQueryItem): boolean => {\n\t\treturn option.type !== ContextMenuOptionType.NoResults && option.type !== ContextMenuOptionType.URL\n\t}\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tposition: \"absolute\",\n\t\t\t\tbottom: \"calc(100% - 10px)\",\n\t\t\t\tleft: 15,\n\t\t\t\tright: 15,\n\t\t\t\toverflowX: \"hidden\",\n\t\t\t}}\n\t\t\tonMouseDown={onMouseDown}>\n\t\t\t<div\n\t\t\t\tref={menuRef}\n\t\t\t\tstyle={{\n\t\t\t\t\tbackgroundColor: \"var(--vscode-dropdown-background)\",\n\t\t\t\t\tborder: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t\t\tborderRadius: \"3px\",\n\t\t\t\t\tboxShadow: \"0 4px 10px rgba(0, 0, 0, 0.25)\",\n\t\t\t\t\tzIndex: 1000,\n\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\tflexDirection: \"column\",\n\t\t\t\t\tmaxHeight: \"200px\",\n\t\t\t\t\toverflowY: \"auto\",\n\t\t\t\t}}>\n\t\t\t\t{/* Can't use virtuoso since it requires fixed height and menu height is dynamic based on # of items */}\n\t\t\t\t{filteredOptions.map((option, index) => (\n\t\t\t\t\t<div\n\t\t\t\t\t\tkey={`${option.type}-${option.value || index}`}\n\t\t\t\t\t\tonClick={() => isOptionSelectable(option) && onSelect(option.type, option.value)}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tpadding: \"8px 12px\",\n\t\t\t\t\t\t\tcursor: isOptionSelectable(option) ? \"pointer\" : \"default\",\n\t\t\t\t\t\t\tcolor: \"var(--vscode-dropdown-foreground)\",\n\t\t\t\t\t\t\tborderBottom: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\t\tbackgroundColor:\n\t\t\t\t\t\t\t\tindex === selectedIndex && isOptionSelectable(option)\n\t\t\t\t\t\t\t\t\t? \"var(--vscode-list-activeSelectionBackground)\"\n\t\t\t\t\t\t\t\t\t: \"\",\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tonMouseEnter={() => isOptionSelectable(option) && setSelectedIndex(index)}>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\tflex: 1,\n\t\t\t\t\t\t\t\tminWidth: 0,\n\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\tclassName={`codicon codicon-${getIconForOption(option)}`}\n\t\t\t\t\t\t\t\tstyle={{ marginRight: \"8px\", flexShrink: 0, fontSize: \"14px\" }}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t{renderOptionContent(option)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{(option.type === ContextMenuOptionType.File || option.type === ContextMenuOptionType.Folder) &&\n\t\t\t\t\t\t\t!option.value && (\n\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-chevron-right\"\n\t\t\t\t\t\t\t\t\tstyle={{ fontSize: \"14px\", flexShrink: 0, marginLeft: 8 }}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t{(option.type === ContextMenuOptionType.Problems ||\n\t\t\t\t\t\t\t((option.type === ContextMenuOptionType.File ||\n\t\t\t\t\t\t\t\toption.type === ContextMenuOptionType.Folder) &&\n\t\t\t\t\t\t\t\toption.value)) && (\n\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\tclassName=\"codicon codicon-add\"\n\t\t\t\t\t\t\t\tstyle={{ fontSize: \"14px\", flexShrink: 0, marginLeft: 8 }}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n\nexport default ContextMenu\n", "tag": "", "tokens": 1700, "metadata": {}}], "modify_time": 1733144568.7379024}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/Announcement.tsx", "relative_path": "cline/webview-ui/src/components/chat/Announcement.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/chat/Announcement.tsx", "source_code": "import { VSCodeButton, VSCodeLink } from \"@vscode/webview-ui-toolkit/react\"\nimport { memo } from \"react\"\n// import VSCodeButtonLink from \"./VSCodeButtonLink\"\n// import { getOpenRouterAuthUrl } from \"./ApiOptions\"\n// import { vscode } from \"../utils/vscode\"\n\ninterface AnnouncementProps {\n\tversion: string\n\thideAnnouncement: () => void\n}\n/*\nYou must update the latestAnnouncementId in ClineProvider for new announcements to show to users. This new id will be compared with whats in state for the 'last announcement shown', and if it's different then the announcement will render. As soon as an announcement is shown, the id will be updated in state. This ensures that announcements are not shown more than once, even if the user doesn't close it themselves.\n*/\nconst Announcement = ({ version, hideAnnouncement }: AnnouncementProps) => {\n\tconst minorVersion = version.split(\".\").slice(0, 2).join(\".\") // 2.0.0 -> 2.0\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tbackgroundColor: \"var(--vscode-editor-inactiveSelectionBackground)\",\n\t\t\t\tborderRadius: \"3px\",\n\t\t\t\tpadding: \"12px 16px\",\n\t\t\t\tmargin: \"5px 15px 5px 15px\",\n\t\t\t\tposition: \"relative\",\n\t\t\t\tflexShrink: 0,\n\t\t\t}}>\n\t\t\t<VSCodeButton\n\t\t\t\tappearance=\"icon\"\n\t\t\t\tonClick={hideAnnouncement}\n\t\t\t\tstyle={{ position: \"absolute\", top: \"8px\", right: \"8px\" }}>\n\t\t\t\t<span className=\"codicon codicon-close\"></span>\n\t\t\t</VSCodeButton>\n\t\t\t<h3 style={{ margin: \"0 0 8px\" }}>\n\t\t\t\t🎉{\"  \"}New in v{minorVersion}\n\t\t\t</h3>\n\t\t\t<p style={{ margin: \"5px 0px\" }}>\n\t\t\t\tCline now uses Anthropic's new{\" \"}\n\t\t\t\t<VSCodeLink\n\t\t\t\t\thref=\"https://www.anthropic.com/news/3-5-models-and-computer-use\"\n\t\t\t\t\tstyle={{ display: \"inline\" }}>\n\t\t\t\t\t\"Computer Use\"\n\t\t\t\t</VSCodeLink>{\" \"}\n\t\t\t\tfeature to launch a browser, click, type, and scroll. This gives him more autonomy in runtime debugging,\n\t\t\t\tend-to-end testing, and even general web use. Try asking \"Look up the weather in Colorado\" to see it in\n\t\t\t\taction, or{\" \"}\n\t\t\t\t<VSCodeLink href=\"https://x.com/sdrzn/status/1850880547825823989\" style={{ display: \"inline\" }}>\n\t\t\t\t\tsee a full demo here.\n\t\t\t\t</VSCodeLink>\n\t\t\t</p>\n\t\t\t{/*<ul style={{ margin: \"0 0 8px\", paddingLeft: \"12px\" }}>\n\t\t\t\t <li>\n\t\t\t\t\tOpenRouter now supports prompt caching! They also have much higher rate limits than other providers,\n\t\t\t\t\tso I recommend trying them out.\n\t\t\t\t\t<br />\n\t\t\t\t\t{!apiConfiguration?.openRouterApiKey && (\n\t\t\t\t\t\t<VSCodeButtonLink\n\t\t\t\t\t\t\thref={getOpenRouterAuthUrl(vscodeUriScheme)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\ttransform: \"scale(0.85)\",\n\t\t\t\t\t\t\t\ttransformOrigin: \"left center\",\n\t\t\t\t\t\t\t\tmargin: \"4px -30px 2px 0\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\tGet OpenRouter API Key\n\t\t\t\t\t\t</VSCodeButtonLink>\n\t\t\t\t\t)}\n\t\t\t\t\t{apiConfiguration?.openRouterApiKey && apiConfiguration?.apiProvider !== \"openrouter\" && (\n\t\t\t\t\t\t<VSCodeButton\n\t\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\t\tvscode.postMessage({\n\t\t\t\t\t\t\t\t\ttype: \"apiConfiguration\",\n\t\t\t\t\t\t\t\t\tapiConfiguration: { ...apiConfiguration, apiProvider: \"openrouter\" },\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\ttransform: \"scale(0.85)\",\n\t\t\t\t\t\t\t\ttransformOrigin: \"left center\",\n\t\t\t\t\t\t\t\tmargin: \"4px -30px 2px 0\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\tSwitch to OpenRouter\n\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t)}\n\t\t\t\t</li> \n\t\t\t\t<li>\n\t\t\t\t\t<b>Edit Cline's changes before accepting!</b> When he creates or edits a file, you can modify his\n\t\t\t\t\tchanges directly in the right side of the diff view (+ hover over the 'Revert Block' arrow button in\n\t\t\t\t\tthe center to undo \"<code>{\"// rest of code here\"}</code>\" shenanigans)\n\t\t\t\t</li>\n\t\t\t\t<li>\n\t\t\t\t\tNew <code>search_files</code> tool that lets Cline perform regex searches in your project, letting\n\t\t\t\t\thim refactor code, address TODOs and FIXMEs, remove dead code, and more!\n\t\t\t\t</li>\n\t\t\t\t<li>\n\t\t\t\t\tWhen Cline runs commands, you can now type directly in the terminal (+ support for Python\n\t\t\t\t\tenvironments)\n\t\t\t\t</li>\n\t\t\t</ul>*/}\n\t\t\t<p style={{ margin: \"0\" }}>\n\t\t\t\tJoin\n\t\t\t\t<VSCodeLink style={{ display: \"inline\" }} href=\"https://discord.gg/cline\">\n\t\t\t\t\tdiscord.gg/cline\n\t\t\t\t</VSCodeLink>\n\t\t\t\tfor more updates!\n\t\t\t</p>\n\t\t</div>\n\t)\n}\n\nexport default memo(Announcement)\n", "tag": "", "tokens": 1284, "metadata": {}}], "modify_time": 1733144568.736786}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/welcome/WelcomeView.tsx", "relative_path": "cline/webview-ui/src/components/welcome/WelcomeView.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/welcome/WelcomeView.tsx", "source_code": "import { VSCodeButton, VSCodeLink } from \"@vscode/webview-ui-toolkit/react\"\nimport { useEffect, useState } from \"react\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport { validateApiConfiguration } from \"../../utils/validate\"\nimport { vscode } from \"../../utils/vscode\"\nimport ApiOptions from \"../settings/ApiOptions\"\n\nconst WelcomeView = () => {\n\tconst { apiConfiguration } = useExtensionState()\n\n\tconst [apiErrorMessage, setApiErrorMessage] = useState<string | undefined>(undefined)\n\n\tconst disableLetsGoButton = apiErrorMessage != null\n\n\tconst handleSubmit = () => {\n\t\tvscode.postMessage({ type: \"apiConfiguration\", apiConfiguration })\n\t}\n\n\tuseEffect(() => {\n\t\tsetApiErrorMessage(validateApiConfiguration(apiConfiguration))\n\t}, [apiConfiguration])\n\n\treturn (\n\t\t<div style={{ position: \"fixed\", top: 0, left: 0, right: 0, bottom: 0, padding: \"0 20px\" }}>\n\t\t\t<h2>Hi, I'm Cline</h2>\n\t\t\t<p>\n\t\t\t\tI can do all kinds of tasks thanks to the latest breakthroughs in{\" \"}\n\t\t\t\t<VSCodeLink\n\t\t\t\t\thref=\"https://www-cdn.anthropic.com/fed9cc193a14b84131812372d8d5857f8f304c52/Model_Card_Claude_3_Addendum.pdf\"\n\t\t\t\t\tstyle={{ display: \"inline\" }}>\n\t\t\t\t\tClaude 3.5 Sonnet's agentic coding capabilities\n\t\t\t\t</VSCodeLink>{\" \"}\n\t\t\t\tand access to tools that let me create & edit files, explore complex projects, use the browser, and\n\t\t\t\texecute terminal commands (with your permission, of course).\n\t\t\t</p>\n\n\t\t\t<b>To get started, this extension needs an API provider for Claude 3.5 Sonnet.</b>\n\n\t\t\t<div style={{ marginTop: \"10px\" }}>\n\t\t\t\t<ApiOptions showModelOptions={false} />\n\t\t\t\t<VSCodeButton onClick={handleSubmit} disabled={disableLetsGoButton} style={{ marginTop: \"3px\" }}>\n\t\t\t\t\tLet's go!\n\t\t\t\t</VSCodeButton>\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n\nexport default WelcomeView\n", "tag": "", "tokens": 563, "metadata": {}}], "modify_time": 1733144568.7403514}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/Demo.tsx", "relative_path": "cline/webview-ui/src/components/common/Demo.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/Demo.tsx", "source_code": "import {\n\tVSCodeBadge,\n\tVSCodeButton,\n\tVSCodeCheckbox,\n\tVSCodeDataGrid,\n\tVSCodeDataGridCell,\n\tVSCodeDataGridRow,\n\tVSCodeDivider,\n\tVSCodeDropdown,\n\tVSCodeLink,\n\tVSCodeOption,\n\tVSCodePanels,\n\tVSCodePanelTab,\n\tVSCodePanelView,\n\tVSCodeProgressRing,\n\tVSCodeRadio,\n\tVSCodeRadioGroup,\n\tVSCodeTag,\n\tVSCodeTextArea,\n\tVSCodeTextField,\n} from \"@vscode/webview-ui-toolkit/react\"\n\nfunction Demo() {\n\t// function handleHowdyClick() {\n\t// \tvscode.postMessage({\n\t// \t\tcommand: \"hello\",\n\t// \t\ttext: \"Hey there partner! 🤠\",\n\t// \t})\n\t// }\n\n\tconst rowData = [\n\t\t{\n\t\t\tcell1: \"Cell Data\",\n\t\t\tcell2: \"Cell Data\",\n\t\t\tcell3: \"Cell Data\",\n\t\t\tcell4: \"Cell Data\",\n\t\t},\n\t\t{\n\t\t\tcell1: \"Cell Data\",\n\t\t\tcell2: \"Cell Data\",\n\t\t\tcell3: \"Cell Data\",\n\t\t\tcell4: \"Cell Data\",\n\t\t},\n\t\t{\n\t\t\tcell1: \"Cell Data\",\n\t\t\tcell2: \"Cell Data\",\n\t\t\tcell3: \"Cell Data\",\n\t\t\tcell4: \"Cell Data\",\n\t\t},\n\t]\n\n\treturn (\n\t\t<main>\n\t\t\t<h1>Hello World!</h1>\n\t\t\t<VSCodeButton>Howdy!</VSCodeButton>\n\n\t\t\t<div className=\"grid gap-3 p-2 place-items-start\">\n\t\t\t\t<VSCodeDataGrid>\n\t\t\t\t\t<VSCodeDataGridRow row-type=\"header\">\n\t\t\t\t\t\t<VSCodeDataGridCell cell-type=\"columnheader\" grid-column=\"1\">\n\t\t\t\t\t\t\tA Custom Header Title\n\t\t\t\t\t\t</VSCodeDataGridCell>\n\t\t\t\t\t\t<VSCodeDataGridCell cell-type=\"columnheader\" grid-column=\"2\">\n\t\t\t\t\t\t\tAnother Custom Title\n\t\t\t\t\t\t</VSCodeDataGridCell>\n\t\t\t\t\t\t<VSCodeDataGridCell cell-type=\"columnheader\" grid-column=\"3\">\n\t\t\t\t\t\t\tTitle Is Custom\n\t\t\t\t\t\t</VSCodeDataGridCell>\n\t\t\t\t\t\t<VSCodeDataGridCell cell-type=\"columnheader\" grid-column=\"4\">\n\t\t\t\t\t\t\tCustom Title\n\t\t\t\t\t\t</VSCodeDataGridCell>\n\t\t\t\t\t</VSCodeDataGridRow>\n\t\t\t\t\t{rowData.map((row, index) => (\n\t\t\t\t\t\t<VSCodeDataGridRow key={index}>\n\t\t\t\t\t\t\t<VSCodeDataGridCell grid-column=\"1\">{row.cell1}</VSCodeDataGridCell>\n\t\t\t\t\t\t\t<VSCodeDataGridCell grid-column=\"2\">{row.cell2}</VSCodeDataGridCell>\n\t\t\t\t\t\t\t<VSCodeDataGridCell grid-column=\"3\">{row.cell3}</VSCodeDataGridCell>\n\t\t\t\t\t\t\t<VSCodeDataGridCell grid-column=\"4\">{row.cell4}</VSCodeDataGridCell>\n\t\t\t\t\t\t</VSCodeDataGridRow>\n\t\t\t\t\t))}\n\t\t\t\t</VSCodeDataGrid>\n\n\t\t\t\t<VSCodeTextField>\n\t\t\t\t\t<section slot=\"end\" style={{ display: \"flex\", alignItems: \"center\" }}>\n\t\t\t\t\t\t<VSCodeButton appearance=\"icon\" aria-label=\"Match Case\">\n\t\t\t\t\t\t\t<span className=\"codicon codicon-case-sensitive\"></span>\n\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t\t<VSCodeButton appearance=\"icon\" aria-label=\"Match Whole Word\">\n\t\t\t\t\t\t\t<span className=\"codicon codicon-whole-word\"></span>\n\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t\t<VSCodeButton appearance=\"icon\" aria-label=\"Use Regular Expression\">\n\t\t\t\t\t\t\t<span className=\"codicon codicon-regex\"></span>\n\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t</section>\n\t\t\t\t</VSCodeTextField>\n\t\t\t\t<span slot=\"end\" className=\"codicon codicon-chevron-right\"></span>\n\n\t\t\t\t<span className=\"flex gap-3\">\n\t\t\t\t\t<VSCodeProgressRing />\n\t\t\t\t\t<VSCodeTextField />\n\t\t\t\t\t<VSCodeButton>Add</VSCodeButton>\n\t\t\t\t\t<VSCodeButton appearance=\"secondary\">Remove</VSCodeButton>\n\t\t\t\t</span>\n\n\t\t\t\t<VSCodeBadge>Badge</VSCodeBadge>\n\t\t\t\t<VSCodeCheckbox>Checkbox</VSCodeCheckbox>\n\t\t\t\t<VSCodeDivider />\n\t\t\t\t<VSCodeDropdown>\n\t\t\t\t\t<VSCodeOption>Option 1</VSCodeOption>\n\t\t\t\t\t<VSCodeOption>Option 2</VSCodeOption>\n\t\t\t\t</VSCodeDropdown>\n\t\t\t\t<VSCodeLink href=\"#\">Link</VSCodeLink>\n\t\t\t\t<VSCodePanels>\n\t\t\t\t\t<VSCodePanelTab id=\"tab-1\">Tab 1</VSCodePanelTab>\n\t\t\t\t\t<VSCodePanelTab id=\"tab-2\">Tab 2</VSCodePanelTab>\n\t\t\t\t\t<VSCodePanelView id=\"view-1\">Panel View 1</VSCodePanelView>\n\t\t\t\t\t<VSCodePanelView id=\"view-2\">Panel View 2</VSCodePanelView>\n\t\t\t\t</VSCodePanels>\n\t\t\t\t<VSCodeRadioGroup>\n\t\t\t\t\t<VSCodeRadio>Radio 1</VSCodeRadio>\n\t\t\t\t\t<VSCodeRadio>Radio 2</VSCodeRadio>\n\t\t\t\t</VSCodeRadioGroup>\n\t\t\t\t<VSCodeTag>Tag</VSCodeTag>\n\t\t\t\t<VSCodeTextArea placeholder=\"Text Area\" />\n\t\t\t</div>\n\t\t</main>\n\t)\n}\n\nexport default Demo\n", "tag": "", "tokens": 1273, "metadata": {}}], "modify_time": 1733144568.7384632}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/CodeAccordian.tsx", "relative_path": "cline/webview-ui/src/components/common/CodeAccordian.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/CodeAccordian.tsx", "source_code": "import { memo, useMemo } from \"react\"\nimport { getLanguageFromPath } from \"../../utils/getLanguageFromPath\"\nimport CodeBlock, { CODE_BLOCK_BG_COLOR } from \"./CodeBlock\"\n\ninterface CodeAccordianProps {\n\tcode?: string\n\tdiff?: string\n\tlanguage?: string | undefined\n\tpath?: string\n\tisFeedback?: boolean\n\tisConsoleLogs?: boolean\n\tisExpanded: boolean\n\tonToggleExpand: () => void\n\tisLoading?: boolean\n}\n\n/*\nWe need to remove leading non-alphanumeric characters from the path in order for our leading ellipses trick to work.\n^: Anchors the match to the start of the string.\n[^a-zA-Z0-9]+: Matches one or more characters that are not alphanumeric.\nThe replace method removes these matched characters, effectively trimming the string up to the first alphanumeric character.\n*/\nexport const removeLeadingNonAlphanumeric = (path: string): string => path.replace(/^[^a-zA-Z0-9]+/, \"\")\n\nconst CodeAccordian = ({\n\tcode,\n\tdiff,\n\tlanguage,\n\tpath,\n\tisFeedback,\n\tisConsoleLogs,\n\tisExpanded,\n\tonToggleExpand,\n\tisLoading,\n}: CodeAccordianProps) => {\n\tconst inferredLanguage = useMemo(\n\t\t() => code && (language ?? (path ? getLanguageFromPath(path) : undefined)),\n\t\t[path, language, code],\n\t)\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\tborderRadius: 3,\n\t\t\t\tbackgroundColor: CODE_BLOCK_BG_COLOR,\n\t\t\t\toverflow: \"hidden\", // This ensures the inner scrollable area doesn't overflow the rounded corners\n\t\t\t\tborder: \"1px solid var(--vscode-editorGroup-border)\",\n\t\t\t}}>\n\t\t\t{(path || isFeedback || isConsoleLogs) && (\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\tpadding: \"9px 10px\",\n\t\t\t\t\t\tcursor: isLoading ? \"wait\" : \"pointer\",\n\t\t\t\t\t\topacity: isLoading ? 0.7 : 1,\n\t\t\t\t\t\t// pointerEvents: isLoading ? \"none\" : \"auto\",\n\t\t\t\t\t\tuserSelect: \"none\",\n\t\t\t\t\t\tWebkitUserSelect: \"none\",\n\t\t\t\t\t\tMozUserSelect: \"none\",\n\t\t\t\t\t\tmsUserSelect: \"none\",\n\t\t\t\t\t}}\n\t\t\t\t\tonClick={isLoading ? undefined : onToggleExpand}>\n\t\t\t\t\t{isFeedback || isConsoleLogs ? (\n\t\t\t\t\t\t<div style={{ display: \"flex\", alignItems: \"center\" }}>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tclassName={`codicon codicon-${isFeedback ? \"feedback\" : \"output\"}`}\n\t\t\t\t\t\t\t\tstyle={{ marginRight: \"6px\" }}></span>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twhiteSpace: \"nowrap\",\n\t\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\t\ttextOverflow: \"ellipsis\",\n\t\t\t\t\t\t\t\t\tmarginRight: \"8px\",\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t{isFeedback ? \"User Edits\" : \"Console Logs\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t) : (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t{path?.startsWith(\".\") && <span>.</span>}\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\twhiteSpace: \"nowrap\",\n\t\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\t\ttextOverflow: \"ellipsis\",\n\t\t\t\t\t\t\t\t\tmarginRight: \"8px\",\n\t\t\t\t\t\t\t\t\t// trick to get ellipsis at beginning of string\n\t\t\t\t\t\t\t\t\tdirection: \"rtl\",\n\t\t\t\t\t\t\t\t\ttextAlign: \"left\",\n\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t{removeLeadingNonAlphanumeric(path ?? \"\") + \"\\u200E\"}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)}\n\t\t\t\t\t<div style={{ flexGrow: 1 }}></div>\n\t\t\t\t\t<span className={`codicon codicon-chevron-${isExpanded ? \"up\" : \"down\"}`}></span>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t\t{(!(path || isFeedback || isConsoleLogs) || isExpanded) && (\n\t\t\t\t<div\n\t\t\t\t\t//className=\"code-block-scrollable\" this doesn't seem to be necessary anymore, on silicon macs it shows the native mac scrollbar instead of the vscode styled one\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\toverflowX: \"auto\",\n\t\t\t\t\t\toverflowY: \"hidden\",\n\t\t\t\t\t\tmaxWidth: \"100%\",\n\t\t\t\t\t}}>\n\t\t\t\t\t<CodeBlock\n\t\t\t\t\t\tsource={`${\"```\"}${diff !== undefined ? \"diff\" : inferredLanguage}\\n${(\n\t\t\t\t\t\t\tcode ??\n\t\t\t\t\t\t\tdiff ??\n\t\t\t\t\t\t\t\"\"\n\t\t\t\t\t\t).trim()}\\n${\"```\"}`}\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t)\n}\n\n// memo does shallow comparison of props, so if you need it to re-render when a nested object changes, you need to pass a custom comparison function\nexport default memo(CodeAccordian)\n", "tag": "", "tokens": 1158, "metadata": {}}], "modify_time": 1733144568.738207}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/Thumbnails.tsx", "relative_path": "cline/webview-ui/src/components/common/Thumbnails.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/Thumbnails.tsx", "source_code": "import React, { useState, useRef, useLayoutEffect, memo } from \"react\"\nimport { useWindowSize } from \"react-use\"\nimport { vscode } from \"../../utils/vscode\"\n\ninterface ThumbnailsProps {\n\timages: string[]\n\tstyle?: React.CSSProperties\n\tsetImages?: React.Dispatch<React.SetStateAction<string[]>>\n\tonHeightChange?: (height: number) => void\n}\n\nconst Thumbnails = ({ images, style, setImages, onHeightChange }: ThumbnailsProps) => {\n\tconst [hoveredIndex, setHoveredIndex] = useState<number | null>(null)\n\tconst containerRef = useRef<HTMLDivElement>(null)\n\tconst { width } = useWindowSize()\n\n\tuseLayoutEffect(() => {\n\t\tif (containerRef.current) {\n\t\t\tlet height = containerRef.current.clientHeight\n\t\t\t// some browsers return 0 for clientHeight\n\t\t\tif (!height) {\n\t\t\t\theight = containerRef.current.getBoundingClientRect().height\n\t\t\t}\n\t\t\tonHeightChange?.(height)\n\t\t}\n\t\tsetHoveredIndex(null)\n\t}, [images, width, onHeightChange])\n\n\tconst handleDelete = (index: number) => {\n\t\tsetImages?.((prevImages) => prevImages.filter((_, i) => i !== index))\n\t}\n\n\tconst isDeletable = setImages !== undefined\n\n\tconst handleImageClick = (image: string) => {\n\t\tvscode.postMessage({ type: \"openImage\", text: image })\n\t}\n\n\treturn (\n\t\t<div\n\t\t\tref={containerRef}\n\t\t\tstyle={{\n\t\t\t\tdisplay: \"flex\",\n\t\t\t\tflexWrap: \"wrap\",\n\t\t\t\tgap: 5,\n\t\t\t\trowGap: 3,\n\t\t\t\t...style,\n\t\t\t}}>\n\t\t\t{images.map((image, index) => (\n\t\t\t\t<div\n\t\t\t\t\tkey={index}\n\t\t\t\t\tstyle={{ position: \"relative\" }}\n\t\t\t\t\tonMouseEnter={() => setHoveredIndex(index)}\n\t\t\t\t\tonMouseLeave={() => setHoveredIndex(null)}>\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc={image}\n\t\t\t\t\t\talt={`Thumbnail ${index + 1}`}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\twidth: 34,\n\t\t\t\t\t\t\theight: 34,\n\t\t\t\t\t\t\tobjectFit: \"cover\",\n\t\t\t\t\t\t\tborderRadius: 4,\n\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tonClick={() => handleImageClick(image)}\n\t\t\t\t\t/>\n\t\t\t\t\t{isDeletable && hoveredIndex === index && (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tonClick={() => handleDelete(index)}\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\t\t\t\ttop: -4,\n\t\t\t\t\t\t\t\tright: -4,\n\t\t\t\t\t\t\t\twidth: 13,\n\t\t\t\t\t\t\t\theight: 13,\n\t\t\t\t\t\t\t\tborderRadius: \"50%\",\n\t\t\t\t\t\t\t\tbackgroundColor: \"var(--vscode-badge-background)\",\n\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\tjustifyContent: \"center\",\n\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tclassName=\"codicon codicon-close\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-foreground)\",\n\t\t\t\t\t\t\t\t\tfontSize: 10,\n\t\t\t\t\t\t\t\t\tfontWeight: \"bold\",\n\t\t\t\t\t\t\t\t}}></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t))}\n\t\t</div>\n\t)\n}\n\nexport default memo(Thumbnails)\n", "tag": "", "tokens": 810, "metadata": {}}], "modify_time": 1733144568.7387955}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/VSCodeButtonLink.tsx", "relative_path": "cline/webview-ui/src/components/common/VSCodeButtonLink.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/VSCodeButtonLink.tsx", "source_code": "import React from \"react\"\nimport { VSCodeButton } from \"@vscode/webview-ui-toolkit/react\"\n\ninterface VSCodeButtonLinkProps {\n\thref: string\n\tchildren: React.ReactNode\n\t[key: string]: any\n}\n\nconst VSCodeButtonLink: React.FC<VSCodeButtonLinkProps> = ({ href, children, ...props }) => {\n\treturn (\n\t\t<a\n\t\t\thref={href}\n\t\t\tstyle={{\n\t\t\t\ttextDecoration: \"none\",\n\t\t\t\tcolor: \"inherit\",\n\t\t\t}}>\n\t\t\t<VSCodeButton {...props}>{children}</VSCodeButton>\n\t\t</a>\n\t)\n}\n\nexport default VSCodeButtonLink\n", "tag": "", "tokens": 168, "metadata": {}}], "modify_time": 1733144568.7389133}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/MarkdownBlock.tsx", "relative_path": "cline/webview-ui/src/components/common/MarkdownBlock.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/MarkdownBlock.tsx", "source_code": "import { memo, useEffect } from \"react\"\nimport { useRemark } from \"react-remark\"\nimport rehypeHighlight, { Options } from \"rehype-highlight\"\nimport styled from \"styled-components\"\nimport { visit } from \"unist-util-visit\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport { CODE_BLOCK_BG_COLOR } from \"./CodeBlock\"\n\ninterface MarkdownBlockProps {\n\tmarkdown?: string\n}\n\nconst StyledMarkdown = styled.div`\n\tpre {\n\t\tbackground-color: ${CODE_BLOCK_BG_COLOR};\n\t\tborder-radius: 3px;\n\t\tmargin: 13x 0;\n\t\tpadding: 10px 10px;\n\t\tmax-width: calc(100vw - 20px);\n\t\toverflow-x: auto;\n\t\toverflow-y: hidden;\n\t}\n\n\tpre > code {\n\t\t.hljs-deletion {\n\t\t\tbackground-color: var(--vscode-diffEditor-removedTextBackground);\n\t\t\tdisplay: inline-block;\n\t\t\twidth: 100%;\n\t\t}\n\t\t.hljs-addition {\n\t\t\tbackground-color: var(--vscode-diffEditor-insertedTextBackground);\n\t\t\tdisplay: inline-block;\n\t\t\twidth: 100%;\n\t\t}\n\t}\n\n\tcode {\n\t\tspan.line:empty {\n\t\t\tdisplay: none;\n\t\t}\n\t\tword-wrap: break-word;\n\t\tborder-radius: 3px;\n\t\tbackground-color: ${CODE_BLOCK_BG_COLOR};\n\t\tfont-size: var(--vscode-editor-font-size, var(--vscode-font-size, 12px));\n\t\tfont-family: var(--vscode-editor-font-family);\n\t}\n\n\tcode:not(pre > code) {\n\t\tfont-family: var(--vscode-editor-font-family, monospace);\n\t\tcolor: var(--vscode-textPreformat-foreground, #f78383);\n\t\tbackground-color: var(--vscode-textCodeBlock-background, #1e1e1e);\n\t\tpadding: 0px 2px;\n\t\tborder-radius: 3px;\n\t\tborder: 1px solid var(--vscode-textSeparator-foreground, #424242);\n\t\twhite-space: pre-line;\n\t\tword-break: break-word;\n\t\toverflow-wrap: anywhere;\n\t}\n\n\tfont-family:\n\t\tvar(--vscode-font-family),\n\t\tsystem-ui,\n\t\t-apple-system,\n\t\tBlinkMacSystemFont,\n\t\t\"Segoe UI\",\n\t\tRoboto,\n\t\tOxygen,\n\t\tUbuntu,\n\t\tCantarell,\n\t\t\"Open Sans\",\n\t\t\"Helvetica Neue\",\n\t\tsans-serif;\n\tfont-size: var(--vscode-font-size, 13px);\n\n\tp,\n\tli,\n\tol,\n\tul {\n\t\tline-height: 1.25;\n\t}\n\n\tol,\n\tul {\n\t\tpadding-left: 2.5em;\n\t\tmargin-left: 0;\n\t}\n\n\tp {\n\t\twhite-space: pre-wrap;\n\t}\n`\n\nconst StyledPre = styled.pre<{ theme: any }>`\n\t& .hljs {\n\t\tcolor: var(--vscode-editor-foreground, #fff);\n\t}\n\n\t${(props) =>\n\t\tObject.keys(props.theme)\n\t\t\t.map((key, index) => {\n\t\t\t\treturn `\n      & ${key} {\n        color: ${props.theme[key]};\n      }\n    `\n\t\t\t})\n\t\t\t.join(\"\")}\n`\n\nconst MarkdownBlock = memo(({ markdown }: MarkdownBlockProps) => {\n\tconst { theme } = useExtensionState()\n\tconst [reactContent, setMarkdown] = useRemark({\n\t\tremarkPlugins: [\n\t\t\t() => {\n\t\t\t\treturn (tree) => {\n\t\t\t\t\tvisit(tree, \"code\", (node: any) => {\n\t\t\t\t\t\tif (!node.lang) {\n\t\t\t\t\t\t\tnode.lang = \"javascript\"\n\t\t\t\t\t\t} else if (node.lang.includes(\".\")) {\n\t\t\t\t\t\t\tnode.lang = node.lang.split(\".\").slice(-1)[0]\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t},\n\t\t],\n\t\trehypePlugins: [\n\t\t\trehypeHighlight as any,\n\t\t\t{\n\t\t\t\t// languages: {},\n\t\t\t} as Options,\n\t\t],\n\t\trehypeReactOptions: {\n\t\t\tcomponents: {\n\t\t\t\tpre: ({ node, ...preProps }: any) => <StyledPre {...preProps} theme={theme} />,\n\t\t\t},\n\t\t},\n\t})\n\n\tuseEffect(() => {\n\t\tsetMarkdown(markdown || \"\")\n\t}, [markdown, setMarkdown, theme])\n\n\treturn (\n\t\t<div style={{}}>\n\t\t\t<StyledMarkdown>{reactContent}</StyledMarkdown>\n\t\t</div>\n\t)\n})\n\nexport default MarkdownBlock\n", "tag": "", "tokens": 1202, "metadata": {}}], "modify_time": 1733144568.7386122}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/CodeBlock.tsx", "relative_path": "cline/webview-ui/src/components/common/CodeBlock.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/common/CodeBlock.tsx", "source_code": "import { memo, useEffect } from \"react\"\nimport { useRemark } from \"react-remark\"\nimport rehypeHighlight, { Options } from \"rehype-highlight\"\nimport styled from \"styled-components\"\nimport { visit } from \"unist-util-visit\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\n\nexport const CODE_BLOCK_BG_COLOR = \"var(--vscode-editor-background, --vscode-sideBar-background, rgb(30 30 30))\"\n\n/*\noverflowX: auto + inner div with padding results in an issue where the top/left/bottom padding renders but the right padding inside does not count as overflow as the width of the element is not exceeded. Once the inner div is outside the boundaries of the parent it counts as overflow.\nhttps://stackoverflow.com/questions/60778406/why-is-padding-right-clipped-with-overflowscroll/77292459#77292459\nthis fixes the issue of right padding clipped off \n“ideal” size in a given axis when given infinite available space--allows the syntax highlighter to grow to largest possible width including its padding\nminWidth: \"max-content\",\n*/\n\ninterface CodeBlockProps {\n\tsource?: string\n\tforceWrap?: boolean\n}\n\nconst StyledMarkdown = styled.div<{ forceWrap: boolean }>`\n\t${({ forceWrap }) =>\n\t\tforceWrap &&\n\t\t`\n    pre, code {\n      white-space: pre-wrap;\n      word-break: break-all;\n      overflow-wrap: anywhere;\n    }\n  `}\n\n\tpre {\n\t\tbackground-color: ${CODE_BLOCK_BG_COLOR};\n\t\tborder-radius: 5px;\n\t\tmargin: 0;\n\t\tmin-width: ${({ forceWrap }) => (forceWrap ? \"auto\" : \"max-content\")};\n\t\tpadding: 10px 10px;\n\t}\n\n\tpre > code {\n\t\t.hljs-deletion {\n\t\t\tbackground-color: var(--vscode-diffEditor-removedTextBackground);\n\t\t\tdisplay: inline-block;\n\t\t\twidth: 100%;\n\t\t}\n\t\t.hljs-addition {\n\t\t\tbackground-color: var(--vscode-diffEditor-insertedTextBackground);\n\t\t\tdisplay: inline-block;\n\t\t\twidth: 100%;\n\t\t}\n\t}\n\n\tcode {\n\t\tspan.line:empty {\n\t\t\tdisplay: none;\n\t\t}\n\t\tword-wrap: break-word;\n\t\tborder-radius: 5px;\n\t\tbackground-color: ${CODE_BLOCK_BG_COLOR};\n\t\tfont-size: var(--vscode-editor-font-size, var(--vscode-font-size, 12px));\n\t\tfont-family: var(--vscode-editor-font-family);\n\t}\n\n\tcode:not(pre > code) {\n\t\tfont-family: var(--vscode-editor-font-family);\n\t\tcolor: #f78383;\n\t}\n\n\tbackground-color: ${CODE_BLOCK_BG_COLOR};\n\tfont-family:\n\t\tvar(--vscode-font-family),\n\t\tsystem-ui,\n\t\t-apple-system,\n\t\tBlinkMacSystemFont,\n\t\t\"Segoe UI\",\n\t\tRoboto,\n\t\tOxygen,\n\t\tUbuntu,\n\t\tCantarell,\n\t\t\"Open Sans\",\n\t\t\"Helvetica Neue\",\n\t\tsans-serif;\n\tfont-size: var(--vscode-editor-font-size, var(--vscode-font-size, 12px));\n\tcolor: var(--vscode-editor-foreground, #fff);\n\n\tp,\n\tli,\n\tol,\n\tul {\n\t\tline-height: 1.5;\n\t}\n`\n\nconst StyledPre = styled.pre<{ theme: any }>`\n\t& .hljs {\n\t\tcolor: var(--vscode-editor-foreground, #fff);\n\t}\n\n\t${(props) =>\n\t\tObject.keys(props.theme)\n\t\t\t.map((key, index) => {\n\t\t\t\treturn `\n      & ${key} {\n        color: ${props.theme[key]};\n      }\n    `\n\t\t\t})\n\t\t\t.join(\"\")}\n`\n\nconst CodeBlock = memo(({ source, forceWrap = false }: CodeBlockProps) => {\n\tconst { theme } = useExtensionState()\n\tconst [reactContent, setMarkdownSource] = useRemark({\n\t\tremarkPlugins: [\n\t\t\t() => {\n\t\t\t\treturn (tree) => {\n\t\t\t\t\tvisit(tree, \"code\", (node: any) => {\n\t\t\t\t\t\tif (!node.lang) {\n\t\t\t\t\t\t\tnode.lang = \"javascript\"\n\t\t\t\t\t\t} else if (node.lang.includes(\".\")) {\n\t\t\t\t\t\t\t// if the langauge is a file, get the extension\n\t\t\t\t\t\t\tnode.lang = node.lang.split(\".\").slice(-1)[0]\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t},\n\t\t],\n\t\trehypePlugins: [\n\t\t\trehypeHighlight as any,\n\t\t\t{\n\t\t\t\t// languages: {},\n\t\t\t} as Options,\n\t\t],\n\t\trehypeReactOptions: {\n\t\t\tcomponents: {\n\t\t\t\tpre: ({ node, ...preProps }: any) => <StyledPre {...preProps} theme={theme} />,\n\t\t\t},\n\t\t},\n\t})\n\n\tuseEffect(() => {\n\t\tsetMarkdownSource(source || \"\")\n\t}, [source, setMarkdownSource, theme])\n\n\treturn (\n\t\t<div\n\t\t\tstyle={{\n\t\t\t\toverflowY: forceWrap ? \"visible\" : \"auto\",\n\t\t\t\tmaxHeight: forceWrap ? \"none\" : \"100%\",\n\t\t\t\tbackgroundColor: CODE_BLOCK_BG_COLOR,\n\t\t\t}}>\n\t\t\t<StyledMarkdown forceWrap={forceWrap}>{reactContent}</StyledMarkdown>\n\t\t</div>\n\t)\n})\n\nexport default CodeBlock\n", "tag": "", "tokens": 1402, "metadata": {}}], "modify_time": 1733144568.7383482}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/history/HistoryView.tsx", "relative_path": "cline/webview-ui/src/components/history/HistoryView.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/history/HistoryView.tsx", "source_code": "import { VSCodeButton, VSCodeTextField, VSCodeRadioGroup, VSCodeRadio } from \"@vscode/webview-ui-toolkit/react\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport { vscode } from \"../../utils/vscode\"\nimport { Virtuoso } from \"react-virtuoso\"\nimport { memo, useMemo, useState, useEffect } from \"react\"\nimport Fuse, { FuseResult } from \"fuse.js\"\nimport { formatLargeNumber } from \"../../utils/format\"\n\ntype HistoryViewProps = {\n\tonDone: () => void\n}\n\ntype SortOption = \"newest\" | \"oldest\" | \"mostExpensive\" | \"mostTokens\" | \"mostRelevant\"\n\nconst HistoryView = ({ onDone }: HistoryViewProps) => {\n\tconst { taskHistory } = useExtensionState()\n\tconst [searchQuery, setSearchQuery] = useState(\"\")\n\tconst [sortOption, setSortOption] = useState<SortOption>(\"newest\")\n\tconst [lastNonRelevantSort, setLastNonRelevantSort] = useState<SortOption | null>(\"newest\")\n\n\tuseEffect(() => {\n\t\tif (searchQuery && sortOption !== \"mostRelevant\" && !lastNonRelevantSort) {\n\t\t\tsetLastNonRelevantSort(sortOption)\n\t\t\tsetSortOption(\"mostRelevant\")\n\t\t} else if (!searchQuery && sortOption === \"mostRelevant\" && lastNonRelevantSort) {\n\t\t\tsetSortOption(lastNonRelevantSort)\n\t\t\tsetLastNonRelevantSort(null)\n\t\t}\n\t}, [searchQuery, sortOption, lastNonRelevantSort])\n\n\tconst handleHistorySelect = (id: string) => {\n\t\tvscode.postMessage({ type: \"showTaskWithId\", text: id })\n\t}\n\n\tconst handleDeleteHistoryItem = (id: string) => {\n\t\tvscode.postMessage({ type: \"deleteTaskWithId\", text: id })\n\t}\n\n\tconst formatDate = (timestamp: number) => {\n\t\tconst date = new Date(timestamp)\n\t\treturn date\n\t\t\t?.toLocaleString(\"en-US\", {\n\t\t\t\tmonth: \"long\",\n\t\t\t\tday: \"numeric\",\n\t\t\t\thour: \"numeric\",\n\t\t\t\tminute: \"2-digit\",\n\t\t\t\thour12: true,\n\t\t\t})\n\t\t\t.replace(\", \", \" \")\n\t\t\t.replace(\" at\", \",\")\n\t\t\t.toUpperCase()\n\t}\n\n\tconst presentableTasks = useMemo(() => {\n\t\treturn taskHistory.filter((item) => item.ts && item.task)\n\t}, [taskHistory])\n\n\tconst fuse = useMemo(() => {\n\t\treturn new Fuse(presentableTasks, {\n\t\t\tkeys: [\"task\"],\n\t\t\tthreshold: 0.6,\n\t\t\tshouldSort: true,\n\t\t\tisCaseSensitive: false,\n\t\t\tignoreLocation: false,\n\t\t\tincludeMatches: true,\n\t\t\tminMatchCharLength: 1,\n\t\t})\n\t}, [presentableTasks])\n\n\tconst taskHistorySearchResults = useMemo(() => {\n\t\tlet results = searchQuery ? highlight(fuse.search(searchQuery)) : presentableTasks\n\n\t\tresults.sort((a, b) => {\n\t\t\tswitch (sortOption) {\n\t\t\t\tcase \"oldest\":\n\t\t\t\t\treturn a.ts - b.ts\n\t\t\t\tcase \"mostExpensive\":\n\t\t\t\t\treturn (b.totalCost || 0) - (a.totalCost || 0)\n\t\t\t\tcase \"mostTokens\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\t(b.tokensIn || 0) +\n\t\t\t\t\t\t(b.tokensOut || 0) +\n\t\t\t\t\t\t(b.cacheWrites || 0) +\n\t\t\t\t\t\t(b.cacheReads || 0) -\n\t\t\t\t\t\t((a.tokensIn || 0) + (a.tokensOut || 0) + (a.cacheWrites || 0) + (a.cacheReads || 0))\n\t\t\t\t\t)\n\t\t\t\tcase \"mostRelevant\":\n\t\t\t\t\t// NOTE: you must never sort directly on object since it will cause members to be reordered\n\t\t\t\t\treturn searchQuery ? 0 : b.ts - a.ts // Keep fuse order if searching, otherwise sort by newest\n\t\t\t\tcase \"newest\":\n\t\t\t\tdefault:\n\t\t\t\t\treturn b.ts - a.ts\n\t\t\t}\n\t\t})\n\n\t\treturn results\n\t}, [presentableTasks, searchQuery, fuse, sortOption])\n\n\treturn (\n\t\t<>\n\t\t\t<style>\n\t\t\t\t{`\n\t\t\t\t\t.history-item:hover {\n\t\t\t\t\t\tbackground-color: var(--vscode-list-hoverBackground);\n\t\t\t\t\t}\n\t\t\t\t\t.delete-button, .export-button {\n\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\tpointer-events: none;\n\t\t\t\t\t}\n\t\t\t\t\t.history-item:hover .delete-button,\n\t\t\t\t\t.history-item:hover .export-button {\n\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\tpointer-events: auto;\n\t\t\t\t\t}\n\t\t\t\t\t.history-item-highlight {\n\t\t\t\t\t\tbackground-color: var(--vscode-editor-findMatchHighlightBackground);\n\t\t\t\t\t\tcolor: inherit;\n\t\t\t\t\t}\n\t\t\t\t`}\n\t\t\t</style>\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tposition: \"fixed\",\n\t\t\t\t\ttop: 0,\n\t\t\t\t\tleft: 0,\n\t\t\t\t\tright: 0,\n\t\t\t\t\tbottom: 0,\n\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\tflexDirection: \"column\",\n\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t}}>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\tpadding: \"10px 17px 10px 20px\",\n\t\t\t\t\t}}>\n\t\t\t\t\t<h3 style={{ color: \"var(--vscode-foreground)\", margin: 0 }}>History</h3>\n\t\t\t\t\t<VSCodeButton onClick={onDone}>Done</VSCodeButton>\n\t\t\t\t</div>\n\t\t\t\t<div style={{ padding: \"5px 17px 6px 17px\" }}>\n\t\t\t\t\t<div style={{ display: \"flex\", flexDirection: \"column\", gap: \"6px\" }}>\n\t\t\t\t\t\t<VSCodeTextField\n\t\t\t\t\t\t\tstyle={{ width: \"100%\" }}\n\t\t\t\t\t\t\tplaceholder=\"Fuzzy search history...\"\n\t\t\t\t\t\t\tvalue={searchQuery}\n\t\t\t\t\t\t\tonInput={(e) => {\n\t\t\t\t\t\t\t\tconst newValue = (e.target as HTMLInputElement)?.value\n\t\t\t\t\t\t\t\tsetSearchQuery(newValue)\n\t\t\t\t\t\t\t\tif (newValue && !searchQuery && sortOption !== \"mostRelevant\") {\n\t\t\t\t\t\t\t\t\tsetLastNonRelevantSort(sortOption)\n\t\t\t\t\t\t\t\t\tsetSortOption(\"mostRelevant\")\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tslot=\"start\"\n\t\t\t\t\t\t\t\tclassName=\"codicon codicon-search\"\n\t\t\t\t\t\t\t\tstyle={{ fontSize: 13, marginTop: 2.5, opacity: 0.8 }}></div>\n\t\t\t\t\t\t\t{searchQuery && (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tclassName=\"input-icon-button codicon codicon-close\"\n\t\t\t\t\t\t\t\t\taria-label=\"Clear search\"\n\t\t\t\t\t\t\t\t\tonClick={() => setSearchQuery(\"\")}\n\t\t\t\t\t\t\t\t\tslot=\"end\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\tjustifyContent: \"center\",\n\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\theight: \"100%\",\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</VSCodeTextField>\n\t\t\t\t\t\t<VSCodeRadioGroup\n\t\t\t\t\t\t\tstyle={{ display: \"flex\", flexWrap: \"wrap\" }}\n\t\t\t\t\t\t\tvalue={sortOption}\n\t\t\t\t\t\t\tonChange={(e) => setSortOption((e.target as HTMLInputElement).value as SortOption)}>\n\t\t\t\t\t\t\t<VSCodeRadio value=\"newest\">Newest</VSCodeRadio>\n\t\t\t\t\t\t\t<VSCodeRadio value=\"oldest\">Oldest</VSCodeRadio>\n\t\t\t\t\t\t\t<VSCodeRadio value=\"mostExpensive\">Most Expensive</VSCodeRadio>\n\t\t\t\t\t\t\t<VSCodeRadio value=\"mostTokens\">Most Tokens</VSCodeRadio>\n\t\t\t\t\t\t\t<VSCodeRadio\n\t\t\t\t\t\t\t\tvalue=\"mostRelevant\"\n\t\t\t\t\t\t\t\tdisabled={!searchQuery}\n\t\t\t\t\t\t\t\tstyle={{ opacity: searchQuery ? 1 : 0.5 }}>\n\t\t\t\t\t\t\t\tMost Relevant\n\t\t\t\t\t\t\t</VSCodeRadio>\n\t\t\t\t\t\t</VSCodeRadioGroup>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div style={{ flexGrow: 1, overflowY: \"auto\", margin: 0 }}>\n\t\t\t\t\t{/* {presentableTasks.length === 0 && (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\tfontStyle: \"italic\",\n\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\ttextAlign: \"center\",\n\t\t\t\t\t\t\t\tpadding: \"0px 10px\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tclassName=\"codicon codicon-robot\"\n\t\t\t\t\t\t\t\tstyle={{ fontSize: \"60px\", marginBottom: \"10px\" }}></span>\n\t\t\t\t\t\t\t<div>Start a task to see it here</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)} */}\n\t\t\t\t\t<Virtuoso\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tflexGrow: 1,\n\t\t\t\t\t\t\toverflowY: \"scroll\",\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tdata={taskHistorySearchResults}\n\t\t\t\t\t\titemContent={(index, item) => (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tkey={item.id}\n\t\t\t\t\t\t\t\tclassName=\"history-item\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tcursor: \"pointer\",\n\t\t\t\t\t\t\t\t\tborderBottom:\n\t\t\t\t\t\t\t\t\t\tindex < taskHistory.length - 1\n\t\t\t\t\t\t\t\t\t\t\t? \"1px solid var(--vscode-panel-border)\"\n\t\t\t\t\t\t\t\t\t\t\t: \"none\",\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\tonClick={() => handleHistorySelect(item.id)}>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\tflexDirection: \"column\",\n\t\t\t\t\t\t\t\t\t\tgap: \"8px\",\n\t\t\t\t\t\t\t\t\t\tpadding: \"12px 20px\",\n\t\t\t\t\t\t\t\t\t\tposition: \"relative\",\n\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: 500,\n\t\t\t\t\t\t\t\t\t\t\t\tfontSize: \"0.85em\",\n\t\t\t\t\t\t\t\t\t\t\t\ttextTransform: \"uppercase\",\n\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t{formatDate(item.ts)}\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t<VSCodeButton\n\t\t\t\t\t\t\t\t\t\t\tappearance=\"icon\"\n\t\t\t\t\t\t\t\t\t\t\tonClick={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.stopPropagation()\n\t\t\t\t\t\t\t\t\t\t\t\thandleDeleteHistoryItem(item.id)\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"delete-button\">\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"codicon codicon-trash\"></span>\n\t\t\t\t\t\t\t\t\t\t</VSCodeButton>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tfontSize: \"var(--vscode-font-size)\",\n\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-foreground)\",\n\t\t\t\t\t\t\t\t\t\t\tdisplay: \"-webkit-box\",\n\t\t\t\t\t\t\t\t\t\t\tWebkitLineClamp: 3,\n\t\t\t\t\t\t\t\t\t\t\tWebkitBoxOrient: \"vertical\",\n\t\t\t\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\t\t\t\twhiteSpace: \"pre-wrap\",\n\t\t\t\t\t\t\t\t\t\t\twordBreak: \"break-word\",\n\t\t\t\t\t\t\t\t\t\t\toverflowWrap: \"anywhere\",\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tdangerouslySetInnerHTML={{ __html: item.task }}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<div style={{ display: \"flex\", flexDirection: \"column\", gap: \"4px\" }}>\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tgap: \"4px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tflexWrap: \"wrap\",\n\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: 500,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t\tTokens:\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tgap: \"3px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-arrow-up\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: \"bold\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: \"-2px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{formatLargeNumber(item.tokensIn || 0)}\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tgap: \"3px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-arrow-down\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: \"bold\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: \"-2px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{formatLargeNumber(item.tokensOut || 0)}\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t{!item.totalCost && <ExportButton itemId={item.id} />}\n\t\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t\t{!!item.cacheWrites && (\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tgap: \"4px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tflexWrap: \"wrap\",\n\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: 500,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t\tCache:\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tgap: \"3px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-database\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: \"bold\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: \"-1px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t+{formatLargeNumber(item.cacheWrites || 0)}\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tgap: \"3px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"codicon codicon-arrow-right\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontSize: \"12px\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: \"bold\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmarginBottom: 0,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{formatLargeNumber(item.cacheReads || 0)}\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t{!!item.totalCost && (\n\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tjustifyContent: \"space-between\",\n\t\t\t\t\t\t\t\t\t\t\t\t\talignItems: \"center\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tmarginTop: -2,\n\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t<div style={{ display: \"flex\", alignItems: \"center\", gap: \"4px\" }}>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfontWeight: 500,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tAPI Cost:\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span style={{ color: \"var(--vscode-descriptionForeground)\" }}>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t${item.totalCost?.toFixed(4)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t<ExportButton itemId={item.id} />\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</>\n\t)\n}\n\nconst ExportButton = ({ itemId }: { itemId: string }) => (\n\t<VSCodeButton\n\t\tclassName=\"export-button\"\n\t\tappearance=\"icon\"\n\t\tonClick={(e) => {\n\t\t\te.stopPropagation()\n\t\t\tvscode.postMessage({ type: \"exportTaskWithId\", text: itemId })\n\t\t}}>\n\t\t<div style={{ fontSize: \"11px\", fontWeight: 500, opacity: 1 }}>EXPORT</div>\n\t</VSCodeButton>\n)\n\n// https://gist.github.com/evenfrost/1ba123656ded32fb7a0cd4651efd4db0\nexport const highlight = (\n\tfuseSearchResult: FuseResult<any>[],\n\thighlightClassName: string = \"history-item-highlight\",\n) => {\n\tconst set = (obj: Record<string, any>, path: string, value: any) => {\n\t\tconst pathValue = path.split(\".\")\n\t\tlet i: number\n\n\t\tfor (i = 0; i < pathValue.length - 1; i++) {\n\t\t\tobj = obj[pathValue[i]] as Record<string, any>\n\t\t}\n\n\t\tobj[pathValue[i]] = value\n\t}\n\n\t// Function to merge overlapping regions\n\tconst mergeRegions = (regions: [number, number][]): [number, number][] => {\n\t\tif (regions.length === 0) return regions\n\n\t\t// Sort regions by start index\n\t\tregions.sort((a, b) => a[0] - b[0])\n\n\t\tconst merged: [number, number][] = [regions[0]]\n\n\t\tfor (let i = 1; i < regions.length; i++) {\n\t\t\tconst last = merged[merged.length - 1]\n\t\t\tconst current = regions[i]\n\n\t\t\tif (current[0] <= last[1] + 1) {\n\t\t\t\t// Overlapping or adjacent regions\n\t\t\t\tlast[1] = Math.max(last[1], current[1])\n\t\t\t} else {\n\t\t\t\tmerged.push(current)\n\t\t\t}\n\t\t}\n\n\t\treturn merged\n\t}\n\n\tconst generateHighlightedText = (inputText: string, regions: [number, number][] = []) => {\n\t\tif (regions.length === 0) {\n\t\t\treturn inputText\n\t\t}\n\n\t\t// Sort and merge overlapping regions\n\t\tconst mergedRegions = mergeRegions(regions)\n\n\t\tlet content = \"\"\n\t\tlet nextUnhighlightedRegionStartingIndex = 0\n\n\t\tmergedRegions.forEach((region) => {\n\t\t\tconst start = region[0]\n\t\t\tconst end = region[1]\n\t\t\tconst lastRegionNextIndex = end + 1\n\n\t\t\tcontent += [\n\t\t\t\tinputText.substring(nextUnhighlightedRegionStartingIndex, start),\n\t\t\t\t`<span class=\"${highlightClassName}\">`,\n\t\t\t\tinputText.substring(start, lastRegionNextIndex),\n\t\t\t\t\"</span>\",\n\t\t\t].join(\"\")\n\n\t\t\tnextUnhighlightedRegionStartingIndex = lastRegionNextIndex\n\t\t})\n\n\t\tcontent += inputText.substring(nextUnhighlightedRegionStartingIndex)\n\n\t\treturn content\n\t}\n\n\treturn fuseSearchResult\n\t\t.filter(({ matches }) => matches && matches.length)\n\t\t.map(({ item, matches }) => {\n\t\t\tconst highlightedItem = { ...item }\n\n\t\t\tmatches?.forEach((match) => {\n\t\t\t\tif (match.key && typeof match.value === \"string\" && match.indices) {\n\t\t\t\t\t// Merge overlapping regions before generating highlighted text\n\t\t\t\t\tconst mergedIndices = mergeRegions([...match.indices])\n\t\t\t\t\tset(highlightedItem, match.key, generateHighlightedText(match.value, mergedIndices))\n\t\t\t\t}\n\t\t\t})\n\n\t\t\treturn highlightedItem\n\t\t})\n}\n\nexport default memo(HistoryView)\n", "tag": "", "tokens": 4571, "metadata": {}}], "modify_time": 1733144568.7393506}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/history/HistoryPreview.tsx", "relative_path": "cline/webview-ui/src/components/history/HistoryPreview.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/webview-ui/src/components/history/HistoryPreview.tsx", "source_code": "import { VSCodeButton } from \"@vscode/webview-ui-toolkit/react\"\nimport { useExtensionState } from \"../../context/ExtensionStateContext\"\nimport { vscode } from \"../../utils/vscode\"\nimport { memo } from \"react\"\nimport { formatLargeNumber } from \"../../utils/format\"\n\ntype HistoryPreviewProps = {\n\tshowHistoryView: () => void\n}\n\nconst HistoryPreview = ({ showHistoryView }: HistoryPreviewProps) => {\n\tconst { taskHistory } = useExtensionState()\n\tconst handleHistorySelect = (id: string) => {\n\t\tvscode.postMessage({ type: \"showTaskWithId\", text: id })\n\t}\n\n\tconst formatDate = (timestamp: number) => {\n\t\tconst date = new Date(timestamp)\n\t\treturn date\n\t\t\t?.toLocaleString(\"en-US\", {\n\t\t\t\tmonth: \"long\",\n\t\t\t\tday: \"numeric\",\n\t\t\t\thour: \"numeric\",\n\t\t\t\tminute: \"2-digit\",\n\t\t\t\thour12: true,\n\t\t\t})\n\t\t\t.replace(\", \", \" \")\n\t\t\t.replace(\" at\", \",\")\n\t\t\t.toUpperCase()\n\t}\n\n\treturn (\n\t\t<div style={{ flexShrink: 0 }}>\n\t\t\t<style>\n\t\t\t\t{`\n\t\t\t\t\t.history-preview-item {\n\t\t\t\t\t\tbackground-color: color-mix(in srgb, var(--vscode-toolbar-hoverBackground) 65%, transparent);\n\t\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\t\tposition: relative;\n\t\t\t\t\t\toverflow: hidden;\n\t\t\t\t\t\topacity: 0.8;\n\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t\tmargin-bottom: 12px;\n\t\t\t\t\t}\n\t\t\t\t\t.history-preview-item:hover {\n\t\t\t\t\t\tbackground-color: color-mix(in srgb, var(--vscode-toolbar-hoverBackground) 100%, transparent);\n\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t\tpointer-events: auto;\n\t\t\t\t\t}\n\t\t\t\t`}\n\t\t\t</style>\n\n\t\t\t<div\n\t\t\t\tstyle={{\n\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\tmargin: \"10px 20px 10px 20px\",\n\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\talignItems: \"center\",\n\t\t\t\t}}>\n\t\t\t\t<span\n\t\t\t\t\tclassName=\"codicon codicon-comment-discussion\"\n\t\t\t\t\tstyle={{ marginRight: \"4px\", transform: \"scale(0.9)\" }}></span>\n\t\t\t\t<span\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tfontWeight: 500,\n\t\t\t\t\t\tfontSize: \"0.85em\",\n\t\t\t\t\t\ttextTransform: \"uppercase\",\n\t\t\t\t\t}}>\n\t\t\t\t\tRecent Tasks\n\t\t\t\t</span>\n\t\t\t</div>\n\n\t\t\t<div style={{ padding: \"0px 20px 0 20px\" }}>\n\t\t\t\t{taskHistory\n\t\t\t\t\t.filter((item) => item.ts && item.task)\n\t\t\t\t\t.slice(0, 3)\n\t\t\t\t\t.map((item) => (\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tkey={item.id}\n\t\t\t\t\t\t\tclassName=\"history-preview-item\"\n\t\t\t\t\t\t\tonClick={() => handleHistorySelect(item.id)}>\n\t\t\t\t\t\t\t<div style={{ padding: \"12px\" }}>\n\t\t\t\t\t\t\t\t<div style={{ marginBottom: \"8px\" }}>\n\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\t\tfontWeight: 500,\n\t\t\t\t\t\t\t\t\t\t\tfontSize: \"0.85em\",\n\t\t\t\t\t\t\t\t\t\t\ttextTransform: \"uppercase\",\n\t\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t\t{formatDate(item.ts)}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tfontSize: \"var(--vscode-font-size)\",\n\t\t\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t\t\t\tmarginBottom: \"8px\",\n\t\t\t\t\t\t\t\t\t\tdisplay: \"-webkit-box\",\n\t\t\t\t\t\t\t\t\t\tWebkitLineClamp: 3,\n\t\t\t\t\t\t\t\t\t\tWebkitBoxOrient: \"vertical\",\n\t\t\t\t\t\t\t\t\t\toverflow: \"hidden\",\n\t\t\t\t\t\t\t\t\t\twhiteSpace: \"pre-wrap\",\n\t\t\t\t\t\t\t\t\t\twordBreak: \"break-word\",\n\t\t\t\t\t\t\t\t\t\toverflowWrap: \"anywhere\",\n\t\t\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\t\t\t{item.task}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div style={{ fontSize: \"0.85em\", color: \"var(--vscode-descriptionForeground)\" }}>\n\t\t\t\t\t\t\t\t\t<span>\n\t\t\t\t\t\t\t\t\t\tTokens: ↑{formatLargeNumber(item.tokensIn || 0)} ↓\n\t\t\t\t\t\t\t\t\t\t{formatLargeNumber(item.tokensOut || 0)}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t{!!item.cacheWrites && (\n\t\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t\t{\" • \"}\n\t\t\t\t\t\t\t\t\t\t\t<span>\n\t\t\t\t\t\t\t\t\t\t\t\tCache: +{formatLargeNumber(item.cacheWrites || 0)} →{\" \"}\n\t\t\t\t\t\t\t\t\t\t\t\t{formatLargeNumber(item.cacheReads || 0)}\n\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t{!!item.totalCost && (\n\t\t\t\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t\t\t\t{\" • \"}\n\t\t\t\t\t\t\t\t\t\t\t<span>API Cost: ${item.totalCost?.toFixed(4)}</span>\n\t\t\t\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t))}\n\t\t\t\t<div style={{ display: \"flex\", alignItems: \"center\", justifyContent: \"center\" }}>\n\t\t\t\t\t<VSCodeButton\n\t\t\t\t\t\tappearance=\"icon\"\n\t\t\t\t\t\tonClick={() => showHistoryView()}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\topacity: 0.9,\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\tfontSize: \"var(--vscode-font-size)\",\n\t\t\t\t\t\t\t\tcolor: \"var(--vscode-descriptionForeground)\",\n\t\t\t\t\t\t\t}}>\n\t\t\t\t\t\t\tView all history\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</VSCodeButton>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n\nexport default memo(HistoryPreview)\n", "tag": "", "tokens": 1359, "metadata": {}}], "modify_time": 1733144568.7391744}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/extension.ts", "relative_path": "cline/src/extension.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/extension.ts", "source_code": "// The module 'vscode' contains the VS Code extensibility API\n// Import the module and reference it with the alias vscode in your code below\nimport delay from \"delay\"\nimport * as vscode from \"vscode\"\nimport { ClineProvider } from \"./core/webview/ClineProvider\"\nimport { createClineAPI } from \"./exports\"\nimport \"./utils/path\" // necessary to have access to String.prototype.toPosix\nimport { DIFF_VIEW_URI_SCHEME } from \"./integrations/editor/DiffViewProvider\"\n\n/*\nBuilt using https://github.com/microsoft/vscode-webview-ui-toolkit\n\nInspired by\nhttps://github.com/microsoft/vscode-webview-ui-toolkit-samples/tree/main/default/weather-webview\nhttps://github.com/microsoft/vscode-webview-ui-toolkit-samples/tree/main/frameworks/hello-world-react-cra\n\n*/\n\nlet outputChannel: vscode.OutputChannel\n\n// This method is called when your extension is activated\n// Your extension is activated the very first time the command is executed\nexport function activate(context: vscode.ExtensionContext) {\n\toutputChannel = vscode.window.createOutputChannel(\"Cline\")\n\tcontext.subscriptions.push(outputChannel)\n\n\toutputChannel.appendLine(\"Cline extension activated\")\n\n\tconst sidebarProvider = new ClineProvider(context, outputChannel)\n\n\tcontext.subscriptions.push(\n\t\tvscode.window.registerWebviewViewProvider(ClineProvider.sideBarId, sidebarProvider, {\n\t\t\twebviewOptions: { retainContextWhenHidden: true },\n\t\t}),\n\t)\n\n\tcontext.subscriptions.push(\n\t\tvscode.commands.registerCommand(\"cline.plusButtonClicked\", async () => {\n\t\t\toutputChannel.appendLine(\"Plus button Clicked\")\n\t\t\tawait sidebarProvider.clearTask()\n\t\t\tawait sidebarProvider.postStateToWebview()\n\t\t\tawait sidebarProvider.postMessageToWebview({ type: \"action\", action: \"chatButtonClicked\" })\n\t\t}),\n\t)\n\n\tconst openClineInNewTab = async () => {\n\t\toutputChannel.appendLine(\"Opening Cline in new tab\")\n\t\t// (this example uses webviewProvider activation event which is necessary to deserialize cached webview, but since we use retainContextWhenHidden, we don't need to use that event)\n\t\t// https://github.com/microsoft/vscode-extension-samples/blob/main/webview-sample/src/extension.ts\n\t\tconst tabProvider = new ClineProvider(context, outputChannel)\n\t\t//const column = vscode.window.activeTextEditor ? vscode.window.activeTextEditor.viewColumn : undefined\n\t\tconst lastCol = Math.max(...vscode.window.visibleTextEditors.map((editor) => editor.viewColumn || 0))\n\n\t\t// Check if there are any visible text editors, otherwise open a new group to the right\n\t\tconst hasVisibleEditors = vscode.window.visibleTextEditors.length > 0\n\t\tif (!hasVisibleEditors) {\n\t\t\tawait vscode.commands.executeCommand(\"workbench.action.newGroupRight\")\n\t\t}\n\t\tconst targetCol = hasVisibleEditors ? Math.max(lastCol + 1, 1) : vscode.ViewColumn.Two\n\n\t\tconst panel = vscode.window.createWebviewPanel(ClineProvider.tabPanelId, \"Cline\", targetCol, {\n\t\t\tenableScripts: true,\n\t\t\tretainContextWhenHidden: true,\n\t\t\tlocalResourceRoots: [context.extensionUri],\n\t\t})\n\t\t// TODO: use better svg icon with light and dark variants (see https://stackoverflow.com/questions/58365687/vscode-extension-iconpath)\n\n\t\tpanel.iconPath = {\n\t\t\tlight: vscode.Uri.joinPath(context.extensionUri, \"assets\", \"icons\", \"robot_panel_light.png\"),\n\t\t\tdark: vscode.Uri.joinPath(context.extensionUri, \"assets\", \"icons\", \"robot_panel_dark.png\"),\n\t\t}\n\t\ttabProvider.resolveWebviewView(panel)\n\n\t\t// Lock the editor group so clicking on files doesn't open them over the panel\n\t\tawait delay(100)\n\t\tawait vscode.commands.executeCommand(\"workbench.action.lockEditorGroup\")\n\t}\n\n\tcontext.subscriptions.push(vscode.commands.registerCommand(\"cline.popoutButtonClicked\", openClineInNewTab))\n\tcontext.subscriptions.push(vscode.commands.registerCommand(\"cline.openInNewTab\", openClineInNewTab))\n\n\tcontext.subscriptions.push(\n\t\tvscode.commands.registerCommand(\"cline.settingsButtonClicked\", () => {\n\t\t\t//vscode.window.showInformationMessage(message)\n\t\t\tsidebarProvider.postMessageToWebview({ type: \"action\", action: \"settingsButtonClicked\" })\n\t\t}),\n\t)\n\n\tcontext.subscriptions.push(\n\t\tvscode.commands.registerCommand(\"cline.historyButtonClicked\", () => {\n\t\t\tsidebarProvider.postMessageToWebview({ type: \"action\", action: \"historyButtonClicked\" })\n\t\t}),\n\t)\n\n\t/*\n\tWe use the text document content provider API to show the left side for diff view by creating a virtual document for the original content. This makes it readonly so users know to edit the right side if they want to keep their changes.\n\n\t- This API allows you to create readonly documents in VSCode from arbitrary sources, and works by claiming an uri-scheme for which your provider then returns text contents. The scheme must be provided when registering a provider and cannot change afterwards.\n\t- Note how the provider doesn't create uris for virtual documents - its role is to provide contents given such an uri. In return, content providers are wired into the open document logic so that providers are always considered.\n\thttps://code.visualstudio.com/api/extension-guides/virtual-documents\n\t*/\n\tconst diffContentProvider = new (class implements vscode.TextDocumentContentProvider {\n\t\tprovideTextDocumentContent(uri: vscode.Uri): string {\n\t\t\treturn Buffer.from(uri.query, \"base64\").toString(\"utf-8\")\n\t\t}\n\t})()\n\tcontext.subscriptions.push(\n\t\tvscode.workspace.registerTextDocumentContentProvider(DIFF_VIEW_URI_SCHEME, diffContentProvider),\n\t)\n\n\t// URI Handler\n\tconst handleUri = async (uri: vscode.Uri) => {\n\t\tconst path = uri.path\n\t\tconst query = new URLSearchParams(uri.query.replace(/\\+/g, \"%2B\"))\n\t\tconst visibleProvider = ClineProvider.getVisibleInstance()\n\t\tif (!visibleProvider) {\n\t\t\treturn\n\t\t}\n\t\tswitch (path) {\n\t\t\tcase \"/openrouter\": {\n\t\t\t\tconst code = query.get(\"code\")\n\t\t\t\tif (code) {\n\t\t\t\t\tawait visibleProvider.handleOpenRouterCallback(code)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tbreak\n\t\t}\n\t}\n\tcontext.subscriptions.push(vscode.window.registerUriHandler({ handleUri }))\n\n\treturn createClineAPI(outputChannel, sidebarProvider)\n}\n\n// This method is called when your extension is deactivated\nexport function deactivate() {\n\toutputChannel.appendLine(\"Cline extension deactivated\")\n}\n", "tag": "", "tokens": 1690, "metadata": {}}], "modify_time": 1733144568.7226744}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/Cline.ts", "relative_path": "cline/src/core/Cline.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/Cline.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport cloneDeep from \"clone-deep\"\nimport delay from \"delay\"\nimport fs from \"fs/promises\"\nimport os from \"os\"\nimport pWaitFor from \"p-wait-for\"\nimport * as path from \"path\"\nimport { serializeError } from \"serialize-error\"\nimport * as vscode from \"vscode\"\nimport { ApiHandler, buildApiHandler } from \"../api\"\nimport { ApiStream } from \"../api/transform/stream\"\nimport { DiffViewProvider } from \"../integrations/editor/DiffViewProvider\"\nimport { findToolName, formatContentBlockToMarkdown } from \"../integrations/misc/export-markdown\"\nimport { extractTextFromFile } from \"../integrations/misc/extract-text\"\nimport { TerminalManager } from \"../integrations/terminal/TerminalManager\"\nimport { UrlContentFetcher } from \"../services/browser/UrlContentFetcher\"\nimport { listFiles } from \"../services/glob/list-files\"\nimport { regexSearchFiles } from \"../services/ripgrep\"\nimport { parseSourceCodeForDefinitionsTopLevel } from \"../services/tree-sitter\"\nimport { ApiConfiguration } from \"../shared/api\"\nimport { findLastIndex } from \"../shared/array\"\nimport { combineApiRequests } from \"../shared/combineApiRequests\"\nimport { combineCommandSequences } from \"../shared/combineCommandSequences\"\nimport {\n\tBrowserAction,\n\tBrowserActionResult,\n\tbrowserActions,\n\tClineApiReqCancelReason,\n\tClineApiReqInfo,\n\tClineAsk,\n\tClineMessage,\n\tClineSay,\n\tClineSayBrowserAction,\n\tClineSayTool,\n} from \"../shared/ExtensionMessage\"\nimport { getApiMetrics } from \"../shared/getApiMetrics\"\nimport { HistoryItem } from \"../shared/HistoryItem\"\nimport { ClineAskResponse } from \"../shared/WebviewMessage\"\nimport { calculateApiCost } from \"../utils/cost\"\nimport { fileExistsAtPath } from \"../utils/fs\"\nimport { arePathsEqual, getReadablePath } from \"../utils/path\"\nimport { parseMentions } from \"./mentions\"\nimport { AssistantMessageContent, parseAssistantMessage, ToolParamName, ToolUseName } from \"./assistant-message\"\nimport { formatResponse } from \"./prompts/responses\"\nimport { addCustomInstructions, SYSTEM_PROMPT } from \"./prompts/system\"\nimport { truncateHalfConversation } from \"./sliding-window\"\nimport { ClineProvider, GlobalFileNames } from \"./webview/ClineProvider\"\nimport { showOmissionWarning } from \"../integrations/editor/detect-omission\"\nimport { BrowserSession } from \"../services/browser/BrowserSession\"\n\nconst cwd =\n\tvscode.workspace.workspaceFolders?.map((folder) => folder.uri.fsPath).at(0) ?? path.join(os.homedir(), \"Desktop\") // may or may not exist but fs checking existence would immediately ask for permission which would be bad UX, need to come up with a better solution\n\ntype ToolResponse = string | Array<Anthropic.TextBlockParam | Anthropic.ImageBlockParam>\ntype UserContent = Array<\n\tAnthropic.TextBlockParam | Anthropic.ImageBlockParam | Anthropic.ToolUseBlockParam | Anthropic.ToolResultBlockParam\n>\n\nexport class Cline {\n\treadonly taskId: string\n\tapi: ApiHandler\n\tprivate terminalManager: TerminalManager\n\tprivate urlContentFetcher: UrlContentFetcher\n\tprivate browserSession: BrowserSession\n\tprivate didEditFile: boolean = false\n\tcustomInstructions?: string\n\talwaysAllowReadOnly: boolean\n\tapiConversationHistory: Anthropic.MessageParam[] = []\n\tclineMessages: ClineMessage[] = []\n\tprivate askResponse?: ClineAskResponse\n\tprivate askResponseText?: string\n\tprivate askResponseImages?: string[]\n\tprivate lastMessageTs?: number\n\tprivate consecutiveMistakeCount: number = 0\n\tprivate providerRef: WeakRef<ClineProvider>\n\tprivate abort: boolean = false\n\tdidFinishAborting = false\n\tabandoned = false\n\tprivate diffViewProvider: DiffViewProvider\n\n\t// streaming\n\tprivate currentStreamingContentIndex = 0\n\tprivate assistantMessageContent: AssistantMessageContent[] = []\n\tprivate presentAssistantMessageLocked = false\n\tprivate presentAssistantMessageHasPendingUpdates = false\n\tprivate userMessageContent: (Anthropic.TextBlockParam | Anthropic.ImageBlockParam)[] = []\n\tprivate userMessageContentReady = false\n\tprivate didRejectTool = false\n\tprivate didAlreadyUseTool = false\n\tprivate didCompleteReadingStream = false\n\n\tconstructor(\n\t\tprovider: ClineProvider,\n\t\tapiConfiguration: ApiConfiguration,\n\t\tcustomInstructions?: string,\n\t\talwaysAllowReadOnly?: boolean,\n\t\ttask?: string,\n\t\timages?: string[],\n\t\thistoryItem?: HistoryItem,\n\t) {\n\t\tthis.providerRef = new WeakRef(provider)\n\t\tthis.api = buildApiHandler(apiConfiguration)\n\t\tthis.terminalManager = new TerminalManager()\n\t\tthis.urlContentFetcher = new UrlContentFetcher(provider.context)\n\t\tthis.browserSession = new BrowserSession(provider.context)\n\t\tthis.diffViewProvider = new DiffViewProvider(cwd)\n\t\tthis.customInstructions = customInstructions\n\t\tthis.alwaysAllowReadOnly = alwaysAllowReadOnly ?? false\n\n\t\tif (historyItem) {\n\t\t\tthis.taskId = historyItem.id\n\t\t\tthis.resumeTaskFromHistory()\n\t\t} else if (task || images) {\n\t\t\tthis.taskId = Date.now().toString()\n\t\t\tthis.startTask(task, images)\n\t\t} else {\n\t\t\tthrow new Error(\"Either historyItem or task/images must be provided\")\n\t\t}\n\t}\n\n\t// Storing task to disk for history\n\n\tprivate async ensureTaskDirectoryExists(): Promise<string> {\n\t\tconst globalStoragePath = this.providerRef.deref()?.context.globalStorageUri.fsPath\n\t\tif (!globalStoragePath) {\n\t\t\tthrow new Error(\"Global storage uri is invalid\")\n\t\t}\n\t\tconst taskDir = path.join(globalStoragePath, \"tasks\", this.taskId)\n\t\tawait fs.mkdir(taskDir, { recursive: true })\n\t\treturn taskDir\n\t}\n\n\tprivate async getSavedApiConversationHistory(): Promise<Anthropic.MessageParam[]> {\n\t\tconst filePath = path.join(await this.ensureTaskDirectoryExists(), GlobalFileNames.apiConversationHistory)\n\t\tconst fileExists = await fileExistsAtPath(filePath)\n\t\tif (fileExists) {\n\t\t\treturn JSON.parse(await fs.readFile(filePath, \"utf8\"))\n\t\t}\n\t\treturn []\n\t}\n\n\tprivate async addToApiConversationHistory(message: Anthropic.MessageParam) {\n\t\tthis.apiConversationHistory.push(message)\n\t\tawait this.saveApiConversationHistory()\n\t}\n\n\tprivate async overwriteApiConversationHistory(newHistory: Anthropic.MessageParam[]) {\n\t\tthis.apiConversationHistory = newHistory\n\t\tawait this.saveApiConversationHistory()\n\t}\n\n\tprivate async saveApiConversationHistory() {\n\t\ttry {\n\t\t\tconst filePath = path.join(await this.ensureTaskDirectoryExists(), GlobalFileNames.apiConversationHistory)\n\t\t\tawait fs.writeFile(filePath, JSON.stringify(this.apiConversationHistory))\n\t\t} catch (error) {\n\t\t\t// in the off chance this fails, we don't want to stop the task\n\t\t\tconsole.error(\"Failed to save API conversation history:\", error)\n\t\t}\n\t}\n\n\tprivate async getSavedClineMessages(): Promise<ClineMessage[]> {\n\t\tconst filePath = path.join(await this.ensureTaskDirectoryExists(), GlobalFileNames.uiMessages)\n\t\tif (await fileExistsAtPath(filePath)) {\n\t\t\treturn JSON.parse(await fs.readFile(filePath, \"utf8\"))\n\t\t} else {\n\t\t\t// check old location\n\t\t\tconst oldPath = path.join(await this.ensureTaskDirectoryExists(), \"claude_messages.json\")\n\t\t\tif (await fileExistsAtPath(oldPath)) {\n\t\t\t\tconst data = JSON.parse(await fs.readFile(oldPath, \"utf8\"))\n\t\t\t\tawait fs.unlink(oldPath) // remove old file\n\t\t\t\treturn data\n\t\t\t}\n\t\t}\n\t\treturn []\n\t}\n\n\tprivate async addToClineMessages(message: ClineMessage) {\n\t\tthis.clineMessages.push(message)\n\t\tawait this.saveClineMessages()\n\t}\n\n\tprivate async overwriteClineMessages(newMessages: ClineMessage[]) {\n\t\tthis.clineMessages = newMessages\n\t\tawait this.saveClineMessages()\n\t}\n\n\tprivate async saveClineMessages() {\n\t\ttry {\n\t\t\tconst filePath = path.join(await this.ensureTaskDirectoryExists(), GlobalFileNames.uiMessages)\n\t\t\tawait fs.writeFile(filePath, JSON.stringify(this.clineMessages))\n\t\t\t// combined as they are in ChatView\n\t\t\tconst apiMetrics = getApiMetrics(combineApiRequests(combineCommandSequences(this.clineMessages.slice(1))))\n\t\t\tconst taskMessage = this.clineMessages[0] // first message is always the task say\n\t\t\tconst lastRelevantMessage =\n\t\t\t\tthis.clineMessages[\n\t\t\t\t\tfindLastIndex(\n\t\t\t\t\t\tthis.clineMessages,\n\t\t\t\t\t\t(m) => !(m.ask === \"resume_task\" || m.ask === \"resume_completed_task\"),\n\t\t\t\t\t)\n\t\t\t\t]\n\t\t\tawait this.providerRef.deref()?.updateTaskHistory({\n\t\t\t\tid: this.taskId,\n\t\t\t\tts: lastRelevantMessage.ts,\n\t\t\t\ttask: taskMessage.text ?? \"\",\n\t\t\t\ttokensIn: apiMetrics.totalTokensIn,\n\t\t\t\ttokensOut: apiMetrics.totalTokensOut,\n\t\t\t\tcacheWrites: apiMetrics.totalCacheWrites,\n\t\t\t\tcacheReads: apiMetrics.totalCacheReads,\n\t\t\t\ttotalCost: apiMetrics.totalCost,\n\t\t\t})\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Failed to save cline messages:\", error)\n\t\t}\n\t}\n\n\t// Communicate with webview\n\n\t// partial has three valid states true (partial message), false (completion of partial message), undefined (individual complete message)\n\tasync ask(\n\t\ttype: ClineAsk,\n\t\ttext?: string,\n\t\tpartial?: boolean,\n\t): Promise<{ response: ClineAskResponse; text?: string; images?: string[] }> {\n\t\t// If this Cline instance was aborted by the provider, then the only thing keeping us alive is a promise still running in the background, in which case we don't want to send its result to the webview as it is attached to a new instance of Cline now. So we can safely ignore the result of any active promises, and this class will be deallocated. (Although we set Cline = undefined in provider, that simply removes the reference to this instance, but the instance is still alive until this promise resolves or rejects.)\n\t\tif (this.abort) {\n\t\t\tthrow new Error(\"Cline instance aborted\")\n\t\t}\n\t\tlet askTs: number\n\t\tif (partial !== undefined) {\n\t\t\tconst lastMessage = this.clineMessages.at(-1)\n\t\t\tconst isUpdatingPreviousPartial =\n\t\t\t\tlastMessage && lastMessage.partial && lastMessage.type === \"ask\" && lastMessage.ask === type\n\t\t\tif (partial) {\n\t\t\t\tif (isUpdatingPreviousPartial) {\n\t\t\t\t\t// existing partial message, so update it\n\t\t\t\t\tlastMessage.text = text\n\t\t\t\t\tlastMessage.partial = partial\n\t\t\t\t\t// todo be more efficient about saving and posting only new data or one whole message at a time so ignore partial for saves, and only post parts of partial message instead of whole array in new listener\n\t\t\t\t\t// await this.saveClineMessages()\n\t\t\t\t\t// await this.providerRef.deref()?.postStateToWebview()\n\t\t\t\t\tawait this.providerRef\n\t\t\t\t\t\t.deref()\n\t\t\t\t\t\t?.postMessageToWebview({ type: \"partialMessage\", partialMessage: lastMessage })\n\t\t\t\t\tthrow new Error(\"Current ask promise was ignored 1\")\n\t\t\t\t} else {\n\t\t\t\t\t// this is a new partial message, so add it with partial state\n\t\t\t\t\t// this.askResponse = undefined\n\t\t\t\t\t// this.askResponseText = undefined\n\t\t\t\t\t// this.askResponseImages = undefined\n\t\t\t\t\taskTs = Date.now()\n\t\t\t\t\tthis.lastMessageTs = askTs\n\t\t\t\t\tawait this.addToClineMessages({ ts: askTs, type: \"ask\", ask: type, text, partial })\n\t\t\t\t\tawait this.providerRef.deref()?.postStateToWebview()\n\t\t\t\t\tthrow new Error(\"Current ask promise was ignored 2\")\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// partial=false means its a complete version of a previously partial message\n\t\t\t\tif (isUpdatingPreviousPartial) {\n\t\t\t\t\t// this is the complete version of a previously partial message, so replace the partial with the complete version\n\t\t\t\t\tthis.askResponse = undefined\n\t\t\t\t\tthis.askResponseText = undefined\n\t\t\t\t\tthis.askResponseImages = undefined\n\n\t\t\t\t\t/*\n\t\t\t\t\tBug for the history books:\n\t\t\t\t\tIn the webview we use the ts as the chatrow key for the virtuoso list. Since we would update this ts right at the end of streaming, it would cause the view to flicker. The key prop has to be stable otherwise react has trouble reconciling items between renders, causing unmounting and remounting of components (flickering).\n\t\t\t\t\tThe lesson here is if you see flickering when rendering lists, it's likely because the key prop is not stable.\n\t\t\t\t\tSo in this case we must make sure that the message ts is never altered after first setting it.\n\t\t\t\t\t*/\n\t\t\t\t\taskTs = lastMessage.ts\n\t\t\t\t\tthis.lastMessageTs = askTs\n\t\t\t\t\t// lastMessage.ts = askTs\n\t\t\t\t\tlastMessage.text = text\n\t\t\t\t\tlastMessage.partial = false\n\t\t\t\t\tawait this.saveClineMessages()\n\t\t\t\t\t// await this.providerRef.deref()?.postStateToWebview()\n\t\t\t\t\tawait this.providerRef\n\t\t\t\t\t\t.deref()\n\t\t\t\t\t\t?.postMessageToWebview({ type: \"partialMessage\", partialMessage: lastMessage })\n\t\t\t\t} else {\n\t\t\t\t\t// this is a new partial=false message, so add it like normal\n\t\t\t\t\tthis.askResponse = undefined\n\t\t\t\t\tthis.askResponseText = undefined\n\t\t\t\t\tthis.askResponseImages = undefined\n\t\t\t\t\taskTs = Date.now()\n\t\t\t\t\tthis.lastMessageTs = askTs\n\t\t\t\t\tawait this.addToClineMessages({ ts: askTs, type: \"ask\", ask: type, text })\n\t\t\t\t\tawait this.providerRef.deref()?.postStateToWebview()\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// this is a new non-partial message, so add it like normal\n\t\t\t// const lastMessage = this.clineMessages.at(-1)\n\t\t\tthis.askResponse = undefined\n\t\t\tthis.askResponseText = undefined\n\t\t\tthis.askResponseImages = undefined\n\t\t\taskTs = Date.now()\n\t\t\tthis.lastMessageTs = askTs\n\t\t\tawait this.addToClineMessages({ ts: askTs, type: \"ask\", ask: type, text })\n\t\t\tawait this.providerRef.deref()?.postStateToWebview()\n\t\t}\n\n\t\tawait pWaitFor(() => this.askResponse !== undefined || this.lastMessageTs !== askTs, { interval: 100 })\n\t\tif (this.lastMessageTs !== askTs) {\n\t\t\tthrow new Error(\"Current ask promise was ignored\") // could happen if we send multiple asks in a row i.e. with command_output. It's important that when we know an ask could fail, it is handled gracefully\n\t\t}\n\t\tconst result = { response: this.askResponse!, text: this.askResponseText, images: this.askResponseImages }\n\t\tthis.askResponse = undefined\n\t\tthis.askResponseText = undefined\n\t\tthis.askResponseImages = undefined\n\t\treturn result\n\t}\n\n\tasync handleWebviewAskResponse(askResponse: ClineAskResponse, text?: string, images?: string[]) {\n\t\tthis.askResponse = askResponse\n\t\tthis.askResponseText = text\n\t\tthis.askResponseImages = images\n\t}\n\n\tasync say(type: ClineSay, text?: string, images?: string[], partial?: boolean): Promise<undefined> {\n\t\tif (this.abort) {\n\t\t\tthrow new Error(\"Cline instance aborted\")\n\t\t}\n\n\t\tif (partial !== undefined) {\n\t\t\tconst lastMessage = this.clineMessages.at(-1)\n\t\t\tconst isUpdatingPreviousPartial =\n\t\t\t\tlastMessage && lastMessage.partial && lastMessage.type === \"say\" && lastMessage.say === type\n\t\t\tif (partial) {\n\t\t\t\tif (isUpdatingPreviousPartial) {\n\t\t\t\t\t// existing partial message, so update it\n\t\t\t\t\tlastMessage.text = text\n\t\t\t\t\tlastMessage.images = images\n\t\t\t\t\tlastMessage.partial = partial\n\t\t\t\t\tawait this.providerRef\n\t\t\t\t\t\t.deref()\n\t\t\t\t\t\t?.postMessageToWebview({ type: \"partialMessage\", partialMessage: lastMessage })\n\t\t\t\t} else {\n\t\t\t\t\t// this is a new partial message, so add it with partial state\n\t\t\t\t\tconst sayTs = Date.now()\n\t\t\t\t\tthis.lastMessageTs = sayTs\n\t\t\t\t\tawait this.addToClineMessages({ ts: sayTs, type: \"say\", say: type, text, images, partial })\n\t\t\t\t\tawait this.providerRef.deref()?.postStateToWebview()\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// partial=false means its a complete version of a previously partial message\n\t\t\t\tif (isUpdatingPreviousPartial) {\n\t\t\t\t\t// this is the complete version of a previously partial message, so replace the partial with the complete version\n\t\t\t\t\tthis.lastMessageTs = lastMessage.ts\n\t\t\t\t\t// lastMessage.ts = sayTs\n\t\t\t\t\tlastMessage.text = text\n\t\t\t\t\tlastMessage.images = images\n\t\t\t\t\tlastMessage.partial = false\n\n\t\t\t\t\t// instead of streaming partialMessage events, we do a save and post like normal to persist to disk\n\t\t\t\t\tawait this.saveClineMessages()\n\t\t\t\t\t// await this.providerRef.deref()?.postStateToWebview()\n\t\t\t\t\tawait this.providerRef\n\t\t\t\t\t\t.deref()\n\t\t\t\t\t\t?.postMessageToWebview({ type: \"partialMessage\", partialMessage: lastMessage }) // more performant than an entire postStateToWebview\n\t\t\t\t} else {\n\t\t\t\t\t// this is a new partial=false message, so add it like normal\n\t\t\t\t\tconst sayTs = Date.now()\n\t\t\t\t\tthis.lastMessageTs = sayTs\n\t\t\t\t\tawait this.addToClineMessages({ ts: sayTs, type: \"say\", say: type, text, images })\n\t\t\t\t\tawait this.providerRef.deref()?.postStateToWebview()\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// this is a new non-partial message, so add it like normal\n\t\t\tconst sayTs = Date.now()\n\t\t\tthis.lastMessageTs = sayTs\n\t\t\tawait this.addToClineMessages({ ts: sayTs, type: \"say\", say: type, text, images })\n\t\t\tawait this.providerRef.deref()?.postStateToWebview()\n\t\t}\n\t}\n\n\tasync sayAndCreateMissingParamError(toolName: ToolUseName, paramName: string, relPath?: string) {\n\t\tawait this.say(\n\t\t\t\"error\",\n\t\t\t`Cline tried to use ${toolName}${\n\t\t\t\trelPath ? ` for '${relPath.toPosix()}'` : \"\"\n\t\t\t} without value for required parameter '${paramName}'. Retrying...`,\n\t\t)\n\t\treturn formatResponse.toolError(formatResponse.missingToolParameterError(paramName))\n\t}\n\n\t// Task lifecycle\n\n\tprivate async startTask(task?: string, images?: string[]): Promise<void> {\n\t\t// conversationHistory (for API) and clineMessages (for webview) need to be in sync\n\t\t// if the extension process were killed, then on restart the clineMessages might not be empty, so we need to set it to [] when we create a new Cline client (otherwise webview would show stale messages from previous session)\n\t\tthis.clineMessages = []\n\t\tthis.apiConversationHistory = []\n\t\tawait this.providerRef.deref()?.postStateToWebview()\n\n\t\tawait this.say(\"text\", task, images)\n\n\t\tlet imageBlocks: Anthropic.ImageBlockParam[] = formatResponse.imageBlocks(images)\n\t\tawait this.initiateTaskLoop([\n\t\t\t{\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: `<task>\\n${task}\\n</task>`,\n\t\t\t},\n\t\t\t...imageBlocks,\n\t\t])\n\t}\n\n\tprivate async resumeTaskFromHistory() {\n\t\tconst modifiedClineMessages = await this.getSavedClineMessages()\n\n\t\t// Remove any resume messages that may have been added before\n\t\tconst lastRelevantMessageIndex = findLastIndex(\n\t\t\tmodifiedClineMessages,\n\t\t\t(m) => !(m.ask === \"resume_task\" || m.ask === \"resume_completed_task\"),\n\t\t)\n\t\tif (lastRelevantMessageIndex !== -1) {\n\t\t\tmodifiedClineMessages.splice(lastRelevantMessageIndex + 1)\n\t\t}\n\n\t\t// since we don't use api_req_finished anymore, we need to check if the last api_req_started has a cost value, if it doesn't and no cancellation reason to present, then we remove it since it indicates an api request without any partial content streamed\n\t\tconst lastApiReqStartedIndex = findLastIndex(\n\t\t\tmodifiedClineMessages,\n\t\t\t(m) => m.type === \"say\" && m.say === \"api_req_started\",\n\t\t)\n\t\tif (lastApiReqStartedIndex !== -1) {\n\t\t\tconst lastApiReqStarted = modifiedClineMessages[lastApiReqStartedIndex]\n\t\t\tconst { cost, cancelReason }: ClineApiReqInfo = JSON.parse(lastApiReqStarted.text || \"{}\")\n\t\t\tif (cost === undefined && cancelReason === undefined) {\n\t\t\t\tmodifiedClineMessages.splice(lastApiReqStartedIndex, 1)\n\t\t\t}\n\t\t}\n\n\t\tawait this.overwriteClineMessages(modifiedClineMessages)\n\t\tthis.clineMessages = await this.getSavedClineMessages()\n\n\t\t// Now present the cline messages to the user and ask if they want to resume\n\n\t\tconst lastClineMessage = this.clineMessages\n\t\t\t.slice()\n\t\t\t.reverse()\n\t\t\t.find((m) => !(m.ask === \"resume_task\" || m.ask === \"resume_completed_task\")) // could be multiple resume tasks\n\t\t// const lastClineMessage = this.clineMessages[lastClineMessageIndex]\n\t\t// could be a completion result with a command\n\t\t// const secondLastClineMessage = this.clineMessages\n\t\t// \t.slice()\n\t\t// \t.reverse()\n\t\t// \t.find(\n\t\t// \t\t(m, index) =>\n\t\t// \t\t\tindex !== lastClineMessageIndex && !(m.ask === \"resume_task\" || m.ask === \"resume_completed_task\")\n\t\t// \t)\n\t\t// (lastClineMessage?.ask === \"command\" && secondLastClineMessage?.ask === \"completion_result\")\n\n\t\tlet askType: ClineAsk\n\t\tif (lastClineMessage?.ask === \"completion_result\") {\n\t\t\taskType = \"resume_completed_task\"\n\t\t} else {\n\t\t\taskType = \"resume_task\"\n\t\t}\n\n\t\tconst { response, text, images } = await this.ask(askType) // calls poststatetowebview\n\t\tlet responseText: string | undefined\n\t\tlet responseImages: string[] | undefined\n\t\tif (response === \"messageResponse\") {\n\t\t\tawait this.say(\"user_feedback\", text, images)\n\t\t\tresponseText = text\n\t\t\tresponseImages = images\n\t\t}\n\n\t\t// need to make sure that the api conversation history can be resumed by the api, even if it goes out of sync with cline messages\n\n\t\tlet existingApiConversationHistory: Anthropic.Messages.MessageParam[] =\n\t\t\tawait this.getSavedApiConversationHistory()\n\n\t\t// v2.0 xml tags refactor caveat: since we don't use tools anymore, we need to replace all tool use blocks with a text block since the API disallows conversations with tool uses and no tool schema\n\t\tconst conversationWithoutToolBlocks = existingApiConversationHistory.map((message) => {\n\t\t\tif (Array.isArray(message.content)) {\n\t\t\t\tconst newContent = message.content.map((block) => {\n\t\t\t\t\tif (block.type === \"tool_use\") {\n\t\t\t\t\t\t// it's important we convert to the new tool schema format so the model doesn't get confused about how to invoke tools\n\t\t\t\t\t\tconst inputAsXml = Object.entries(block.input as Record<string, string>)\n\t\t\t\t\t\t\t.map(([key, value]) => `<${key}>\\n${value}\\n</${key}>`)\n\t\t\t\t\t\t\t.join(\"\\n\")\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\ttext: `<${block.name}>\\n${inputAsXml}\\n</${block.name}>`,\n\t\t\t\t\t\t} as Anthropic.Messages.TextBlockParam\n\t\t\t\t\t} else if (block.type === \"tool_result\") {\n\t\t\t\t\t\t// Convert block.content to text block array, removing images\n\t\t\t\t\t\tconst contentAsTextBlocks = Array.isArray(block.content)\n\t\t\t\t\t\t\t? block.content.filter((item) => item.type === \"text\")\n\t\t\t\t\t\t\t: [{ type: \"text\", text: block.content }]\n\t\t\t\t\t\tconst textContent = contentAsTextBlocks.map((item) => item.text).join(\"\\n\\n\")\n\t\t\t\t\t\tconst toolName = findToolName(block.tool_use_id, existingApiConversationHistory)\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\ttext: `[${toolName} Result]\\n\\n${textContent}`,\n\t\t\t\t\t\t} as Anthropic.Messages.TextBlockParam\n\t\t\t\t\t}\n\t\t\t\t\treturn block\n\t\t\t\t})\n\t\t\t\treturn { ...message, content: newContent }\n\t\t\t}\n\t\t\treturn message\n\t\t})\n\t\texistingApiConversationHistory = conversationWithoutToolBlocks\n\n\t\t// FIXME: remove tool use blocks altogether\n\n\t\t// if the last message is an assistant message, we need to check if there's tool use since every tool use has to have a tool response\n\t\t// if there's no tool use and only a text block, then we can just add a user message\n\t\t// (note this isn't relevant anymore since we use custom tool prompts instead of tool use blocks, but this is here for legacy purposes in case users resume old tasks)\n\n\t\t// if the last message is a user message, we can need to get the assistant message before it to see if it made tool calls, and if so, fill in the remaining tool responses with 'interrupted'\n\n\t\tlet modifiedOldUserContent: UserContent // either the last message if its user message, or the user message before the last (assistant) message\n\t\tlet modifiedApiConversationHistory: Anthropic.Messages.MessageParam[] // need to remove the last user message to replace with new modified user message\n\t\tif (existingApiConversationHistory.length > 0) {\n\t\t\tconst lastMessage = existingApiConversationHistory[existingApiConversationHistory.length - 1]\n\n\t\t\tif (lastMessage.role === \"assistant\") {\n\t\t\t\tconst content = Array.isArray(lastMessage.content)\n\t\t\t\t\t? lastMessage.content\n\t\t\t\t\t: [{ type: \"text\", text: lastMessage.content }]\n\t\t\t\tconst hasToolUse = content.some((block) => block.type === \"tool_use\")\n\n\t\t\t\tif (hasToolUse) {\n\t\t\t\t\tconst toolUseBlocks = content.filter(\n\t\t\t\t\t\t(block) => block.type === \"tool_use\",\n\t\t\t\t\t) as Anthropic.Messages.ToolUseBlock[]\n\t\t\t\t\tconst toolResponses: Anthropic.ToolResultBlockParam[] = toolUseBlocks.map((block) => ({\n\t\t\t\t\t\ttype: \"tool_result\",\n\t\t\t\t\t\ttool_use_id: block.id,\n\t\t\t\t\t\tcontent: \"Task was interrupted before this tool call could be completed.\",\n\t\t\t\t\t}))\n\t\t\t\t\tmodifiedApiConversationHistory = [...existingApiConversationHistory] // no changes\n\t\t\t\t\tmodifiedOldUserContent = [...toolResponses]\n\t\t\t\t} else {\n\t\t\t\t\tmodifiedApiConversationHistory = [...existingApiConversationHistory]\n\t\t\t\t\tmodifiedOldUserContent = []\n\t\t\t\t}\n\t\t\t} else if (lastMessage.role === \"user\") {\n\t\t\t\tconst previousAssistantMessage: Anthropic.Messages.MessageParam | undefined =\n\t\t\t\t\texistingApiConversationHistory[existingApiConversationHistory.length - 2]\n\n\t\t\t\tconst existingUserContent: UserContent = Array.isArray(lastMessage.content)\n\t\t\t\t\t? lastMessage.content\n\t\t\t\t\t: [{ type: \"text\", text: lastMessage.content }]\n\t\t\t\tif (previousAssistantMessage && previousAssistantMessage.role === \"assistant\") {\n\t\t\t\t\tconst assistantContent = Array.isArray(previousAssistantMessage.content)\n\t\t\t\t\t\t? previousAssistantMessage.content\n\t\t\t\t\t\t: [{ type: \"text\", text: previousAssistantMessage.content }]\n\n\t\t\t\t\tconst toolUseBlocks = assistantContent.filter(\n\t\t\t\t\t\t(block) => block.type === \"tool_use\",\n\t\t\t\t\t) as Anthropic.Messages.ToolUseBlock[]\n\n\t\t\t\t\tif (toolUseBlocks.length > 0) {\n\t\t\t\t\t\tconst existingToolResults = existingUserContent.filter(\n\t\t\t\t\t\t\t(block) => block.type === \"tool_result\",\n\t\t\t\t\t\t) as Anthropic.ToolResultBlockParam[]\n\n\t\t\t\t\t\tconst missingToolResponses: Anthropic.ToolResultBlockParam[] = toolUseBlocks\n\t\t\t\t\t\t\t.filter(\n\t\t\t\t\t\t\t\t(toolUse) => !existingToolResults.some((result) => result.tool_use_id === toolUse.id),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t.map((toolUse) => ({\n\t\t\t\t\t\t\t\ttype: \"tool_result\",\n\t\t\t\t\t\t\t\ttool_use_id: toolUse.id,\n\t\t\t\t\t\t\t\tcontent: \"Task was interrupted before this tool call could be completed.\",\n\t\t\t\t\t\t\t}))\n\n\t\t\t\t\t\tmodifiedApiConversationHistory = existingApiConversationHistory.slice(0, -1) // removes the last user message\n\t\t\t\t\t\tmodifiedOldUserContent = [...existingUserContent, ...missingToolResponses]\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmodifiedApiConversationHistory = existingApiConversationHistory.slice(0, -1)\n\t\t\t\t\t\tmodifiedOldUserContent = [...existingUserContent]\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tmodifiedApiConversationHistory = existingApiConversationHistory.slice(0, -1)\n\t\t\t\t\tmodifiedOldUserContent = [...existingUserContent]\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow new Error(\"Unexpected: Last message is not a user or assistant message\")\n\t\t\t}\n\t\t} else {\n\t\t\tthrow new Error(\"Unexpected: No existing API conversation history\")\n\t\t}\n\n\t\tlet newUserContent: UserContent = [...modifiedOldUserContent]\n\n\t\tconst agoText = (() => {\n\t\t\tconst timestamp = lastClineMessage?.ts ?? Date.now()\n\t\t\tconst now = Date.now()\n\t\t\tconst diff = now - timestamp\n\t\t\tconst minutes = Math.floor(diff / 60000)\n\t\t\tconst hours = Math.floor(minutes / 60)\n\t\t\tconst days = Math.floor(hours / 24)\n\n\t\t\tif (days > 0) {\n\t\t\t\treturn `${days} day${days > 1 ? \"s\" : \"\"} ago`\n\t\t\t}\n\t\t\tif (hours > 0) {\n\t\t\t\treturn `${hours} hour${hours > 1 ? \"s\" : \"\"} ago`\n\t\t\t}\n\t\t\tif (minutes > 0) {\n\t\t\t\treturn `${minutes} minute${minutes > 1 ? \"s\" : \"\"} ago`\n\t\t\t}\n\t\t\treturn \"just now\"\n\t\t})()\n\n\t\tconst wasRecent = lastClineMessage?.ts && Date.now() - lastClineMessage.ts < 30_000\n\n\t\tnewUserContent.push({\n\t\t\ttype: \"text\",\n\t\t\ttext:\n\t\t\t\t`[TASK RESUMPTION] This task was interrupted ${agoText}. It may or may not be complete, so please reassess the task context. Be aware that the project state may have changed since then. The current working directory is now '${cwd.toPosix()}'. If the task has not been completed, retry the last step before interruption and proceed with completing the task.\\n\\nNote: If you previously attempted a tool use that the user did not provide a result for, you should assume the tool use was not successful and assess whether you should retry. If the last tool was a browser_action, the browser has been closed and you must launch a new browser if needed.${\n\t\t\t\t\twasRecent\n\t\t\t\t\t\t? \"\\n\\nIMPORTANT: If the last tool use was a write_to_file that was interrupted, the file was reverted back to its original state before the interrupted edit, and you do NOT need to re-read the file as you already have its up-to-date contents.\"\n\t\t\t\t\t\t: \"\"\n\t\t\t\t}` +\n\t\t\t\t(responseText\n\t\t\t\t\t? `\\n\\nNew instructions for task continuation:\\n<user_message>\\n${responseText}\\n</user_message>`\n\t\t\t\t\t: \"\"),\n\t\t})\n\n\t\tif (responseImages && responseImages.length > 0) {\n\t\t\tnewUserContent.push(...formatResponse.imageBlocks(responseImages))\n\t\t}\n\n\t\tawait this.overwriteApiConversationHistory(modifiedApiConversationHistory)\n\t\tawait this.initiateTaskLoop(newUserContent)\n\t}\n\n\tprivate async initiateTaskLoop(userContent: UserContent): Promise<void> {\n\t\tlet nextUserContent = userContent\n\t\tlet includeFileDetails = true\n\t\twhile (!this.abort) {\n\t\t\tconst didEndLoop = await this.recursivelyMakeClineRequests(nextUserContent, includeFileDetails)\n\t\t\tincludeFileDetails = false // we only need file details the first time\n\n\t\t\t//  The way this agentic loop works is that cline will be given a task that he then calls tools to complete. unless there's an attempt_completion call, we keep responding back to him with his tool's responses until he either attempt_completion or does not use anymore tools. If he does not use anymore tools, we ask him to consider if he's completed the task and then call attempt_completion, otherwise proceed with completing the task.\n\t\t\t// There is a MAX_REQUESTS_PER_TASK limit to prevent infinite requests, but Cline is prompted to finish the task as efficiently as he can.\n\n\t\t\t//const totalCost = this.calculateApiCost(totalInputTokens, totalOutputTokens)\n\t\t\tif (didEndLoop) {\n\t\t\t\t// For now a task never 'completes'. This will only happen if the user hits max requests and denies resetting the count.\n\t\t\t\t//this.say(\"task_completed\", `Task completed. Total API usage cost: ${totalCost}`)\n\t\t\t\tbreak\n\t\t\t} else {\n\t\t\t\t// this.say(\n\t\t\t\t// \t\"tool\",\n\t\t\t\t// \t\"Cline responded with only text blocks but has not called attempt_completion yet. Forcing him to continue with task...\"\n\t\t\t\t// )\n\t\t\t\tnextUserContent = [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: formatResponse.noToolsUsed(),\n\t\t\t\t\t},\n\t\t\t\t]\n\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t}\n\t\t}\n\t}\n\n\tabortTask() {\n\t\tthis.abort = true // will stop any autonomously running promises\n\t\tthis.terminalManager.disposeAll()\n\t\tthis.urlContentFetcher.closeBrowser()\n\t\tthis.browserSession.closeBrowser()\n\t}\n\n\t// Tools\n\n\tasync executeCommandTool(command: string): Promise<[boolean, ToolResponse]> {\n\t\tconst terminalInfo = await this.terminalManager.getOrCreateTerminal(cwd)\n\t\tterminalInfo.terminal.show() // weird visual bug when creating new terminals (even manually) where there's an empty space at the top.\n\t\tconst process = this.terminalManager.runCommand(terminalInfo, command)\n\n\t\tlet userFeedback: { text?: string; images?: string[] } | undefined\n\t\tlet didContinue = false\n\t\tconst sendCommandOutput = async (line: string): Promise<void> => {\n\t\t\ttry {\n\t\t\t\tconst { response, text, images } = await this.ask(\"command_output\", line)\n\t\t\t\tif (response === \"yesButtonClicked\") {\n\t\t\t\t\t// proceed while running\n\t\t\t\t} else {\n\t\t\t\t\tuserFeedback = { text, images }\n\t\t\t\t}\n\t\t\t\tdidContinue = true\n\t\t\t\tprocess.continue() // continue past the await\n\t\t\t} catch {\n\t\t\t\t// This can only happen if this ask promise was ignored, so ignore this error\n\t\t\t}\n\t\t}\n\n\t\tlet result = \"\"\n\t\tprocess.on(\"line\", (line) => {\n\t\t\tresult += line + \"\\n\"\n\t\t\tif (!didContinue) {\n\t\t\t\tsendCommandOutput(line)\n\t\t\t} else {\n\t\t\t\tthis.say(\"command_output\", line)\n\t\t\t}\n\t\t})\n\n\t\tlet completed = false\n\t\tprocess.once(\"completed\", () => {\n\t\t\tcompleted = true\n\t\t})\n\n\t\tprocess.once(\"no_shell_integration\", async () => {\n\t\t\tawait this.say(\"shell_integration_warning\")\n\t\t})\n\n\t\tawait process\n\n\t\t// Wait for a short delay to ensure all messages are sent to the webview\n\t\t// This delay allows time for non-awaited promises to be created and\n\t\t// for their associated messages to be sent to the webview, maintaining\n\t\t// the correct order of messages (although the webview is smart about\n\t\t// grouping command_output messages despite any gaps anyways)\n\t\tawait delay(50)\n\n\t\tresult = result.trim()\n\n\t\tif (userFeedback) {\n\t\t\tawait this.say(\"user_feedback\", userFeedback.text, userFeedback.images)\n\t\t\treturn [\n\t\t\t\ttrue,\n\t\t\t\tformatResponse.toolResult(\n\t\t\t\t\t`Command is still running in the user's terminal.${\n\t\t\t\t\t\tresult.length > 0 ? `\\nHere's the output so far:\\n${result}` : \"\"\n\t\t\t\t\t}\\n\\nThe user provided the following feedback:\\n<feedback>\\n${userFeedback.text}\\n</feedback>`,\n\t\t\t\t\tuserFeedback.images,\n\t\t\t\t),\n\t\t\t]\n\t\t}\n\n\t\tif (completed) {\n\t\t\treturn [false, `Command executed.${result.length > 0 ? `\\nOutput:\\n${result}` : \"\"}`]\n\t\t} else {\n\t\t\treturn [\n\t\t\t\tfalse,\n\t\t\t\t`Command is still running in the user's terminal.${\n\t\t\t\t\tresult.length > 0 ? `\\nHere's the output so far:\\n${result}` : \"\"\n\t\t\t\t}\\n\\nYou will be updated on the terminal status and new output in the future.`,\n\t\t\t]\n\t\t}\n\t}\n\n\tasync *attemptApiRequest(previousApiReqIndex: number): ApiStream {\n\t\tlet systemPrompt = await SYSTEM_PROMPT(cwd, this.api.getModel().info.supportsComputerUse ?? false)\n\t\tif (this.customInstructions && this.customInstructions.trim()) {\n\t\t\t// altering the system prompt mid-task will break the prompt cache, but in the grand scheme this will not change often so it's better to not pollute user messages with it the way we have to with <potentially relevant details>\n\t\t\tsystemPrompt += addCustomInstructions(this.customInstructions)\n\t\t}\n\n\t\t// If the previous API request's total token usage is close to the context window, truncate the conversation history to free up space for the new request\n\t\tif (previousApiReqIndex >= 0) {\n\t\t\tconst previousRequest = this.clineMessages[previousApiReqIndex]\n\t\t\tif (previousRequest && previousRequest.text) {\n\t\t\t\tconst { tokensIn, tokensOut, cacheWrites, cacheReads }: ClineApiReqInfo = JSON.parse(\n\t\t\t\t\tpreviousRequest.text,\n\t\t\t\t)\n\t\t\t\tconst totalTokens = (tokensIn || 0) + (tokensOut || 0) + (cacheWrites || 0) + (cacheReads || 0)\n\t\t\t\tconst contextWindow = this.api.getModel().info.contextWindow || 128_000\n\t\t\t\tconst maxAllowedSize = Math.max(contextWindow - 40_000, contextWindow * 0.8)\n\t\t\t\tif (totalTokens >= maxAllowedSize) {\n\t\t\t\t\tconst truncatedMessages = truncateHalfConversation(this.apiConversationHistory)\n\t\t\t\t\tawait this.overwriteApiConversationHistory(truncatedMessages)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst stream = this.api.createMessage(systemPrompt, this.apiConversationHistory)\n\t\tconst iterator = stream[Symbol.asyncIterator]()\n\n\t\ttry {\n\t\t\t// awaiting first chunk to see if it will throw an error\n\t\t\tconst firstChunk = await iterator.next()\n\t\t\tyield firstChunk.value\n\t\t} catch (error) {\n\t\t\t// note that this api_req_failed ask is unique in that we only present this option if the api hasn't streamed any content yet (ie it fails on the first chunk due), as it would allow them to hit a retry button. However if the api failed mid-stream, it could be in any arbitrary state where some tools may have executed, so that error is handled differently and requires cancelling the task entirely.\n\t\t\tconst { response } = await this.ask(\n\t\t\t\t\"api_req_failed\",\n\t\t\t\terror.message ?? JSON.stringify(serializeError(error), null, 2),\n\t\t\t)\n\t\t\tif (response !== \"yesButtonClicked\") {\n\t\t\t\t// this will never happen since if noButtonClicked, we will clear current task, aborting this instance\n\t\t\t\tthrow new Error(\"API request failed\")\n\t\t\t}\n\t\t\tawait this.say(\"api_req_retried\")\n\t\t\t// delegate generator output from the recursive call\n\t\t\tyield* this.attemptApiRequest(previousApiReqIndex)\n\t\t\treturn\n\t\t}\n\n\t\t// no error, so we can continue to yield all remaining chunks\n\t\t// (needs to be placed outside of try/catch since it we want caller to handle errors not with api_req_failed as that is reserved for first chunk failures only)\n\t\t// this delegates to another generator or iterable object. In this case, it's saying \"yield all remaining values from this iterator\". This effectively passes along all subsequent chunks from the original stream.\n\t\tyield* iterator\n\t}\n\n\tasync presentAssistantMessage() {\n\t\tif (this.abort) {\n\t\t\tthrow new Error(\"Cline instance aborted\")\n\t\t}\n\n\t\tif (this.presentAssistantMessageLocked) {\n\t\t\tthis.presentAssistantMessageHasPendingUpdates = true\n\t\t\treturn\n\t\t}\n\t\tthis.presentAssistantMessageLocked = true\n\t\tthis.presentAssistantMessageHasPendingUpdates = false\n\n\t\tif (this.currentStreamingContentIndex >= this.assistantMessageContent.length) {\n\t\t\t// this may happen if the last content block was completed before streaming could finish. if streaming is finished, and we're out of bounds then this means we already presented/executed the last content block and are ready to continue to next request\n\t\t\tif (this.didCompleteReadingStream) {\n\t\t\t\tthis.userMessageContentReady = true\n\t\t\t}\n\t\t\t// console.log(\"no more content blocks to stream! this shouldn't happen?\")\n\t\t\tthis.presentAssistantMessageLocked = false\n\t\t\treturn\n\t\t\t//throw new Error(\"No more content blocks to stream! This shouldn't happen...\") // remove and just return after testing\n\t\t}\n\n\t\tconst block = cloneDeep(this.assistantMessageContent[this.currentStreamingContentIndex]) // need to create copy bc while stream is updating the array, it could be updating the reference block properties too\n\t\tswitch (block.type) {\n\t\t\tcase \"text\": {\n\t\t\t\tif (this.didRejectTool || this.didAlreadyUseTool) {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tlet content = block.content\n\t\t\t\tif (content) {\n\t\t\t\t\t// (have to do this for partial and complete since sending content in thinking tags to markdown renderer will automatically be removed)\n\t\t\t\t\t// Remove end substrings of <thinking or </thinking (below xml parsing is only for opening tags)\n\t\t\t\t\t// (this is done with the xml parsing below now, but keeping here for reference)\n\t\t\t\t\t// content = content.replace(/<\\/?t(?:h(?:i(?:n(?:k(?:i(?:n(?:g)?)?)?)?)?)?)?$/, \"\")\n\t\t\t\t\t// Remove all instances of <thinking> (with optional line break after) and </thinking> (with optional line break before)\n\t\t\t\t\t// - Needs to be separate since we dont want to remove the line break before the first tag\n\t\t\t\t\t// - Needs to happen before the xml parsing below\n\t\t\t\t\tcontent = content.replace(/<thinking>\\s?/g, \"\")\n\t\t\t\t\tcontent = content.replace(/\\s?<\\/thinking>/g, \"\")\n\n\t\t\t\t\t// Remove partial XML tag at the very end of the content (for tool use and thinking tags)\n\t\t\t\t\t// (prevents scrollview from jumping when tags are automatically removed)\n\t\t\t\t\tconst lastOpenBracketIndex = content.lastIndexOf(\"<\")\n\t\t\t\t\tif (lastOpenBracketIndex !== -1) {\n\t\t\t\t\t\tconst possibleTag = content.slice(lastOpenBracketIndex)\n\t\t\t\t\t\t// Check if there's a '>' after the last '<' (i.e., if the tag is complete) (complete thinking and tool tags will have been removed by now)\n\t\t\t\t\t\tconst hasCloseBracket = possibleTag.includes(\">\")\n\t\t\t\t\t\tif (!hasCloseBracket) {\n\t\t\t\t\t\t\t// Extract the potential tag name\n\t\t\t\t\t\t\tlet tagContent: string\n\t\t\t\t\t\t\tif (possibleTag.startsWith(\"</\")) {\n\t\t\t\t\t\t\t\ttagContent = possibleTag.slice(2).trim()\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\ttagContent = possibleTag.slice(1).trim()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Check if tagContent is likely an incomplete tag name (letters and underscores only)\n\t\t\t\t\t\t\tconst isLikelyTagName = /^[a-zA-Z_]+$/.test(tagContent)\n\t\t\t\t\t\t\t// Preemptively remove < or </ to keep from these artifacts showing up in chat (also handles closing thinking tags)\n\t\t\t\t\t\t\tconst isOpeningOrClosing = possibleTag === \"<\" || possibleTag === \"</\"\n\t\t\t\t\t\t\t// If the tag is incomplete and at the end, remove it from the content\n\t\t\t\t\t\t\tif (isOpeningOrClosing || isLikelyTagName) {\n\t\t\t\t\t\t\t\tcontent = content.slice(0, lastOpenBracketIndex).trim()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tawait this.say(\"text\", content, undefined, block.partial)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase \"tool_use\":\n\t\t\t\tconst toolDescription = () => {\n\t\t\t\t\tswitch (block.name) {\n\t\t\t\t\t\tcase \"execute_command\":\n\t\t\t\t\t\t\treturn `[${block.name} for '${block.params.command}']`\n\t\t\t\t\t\tcase \"read_file\":\n\t\t\t\t\t\t\treturn `[${block.name} for '${block.params.path}']`\n\t\t\t\t\t\tcase \"write_to_file\":\n\t\t\t\t\t\t\treturn `[${block.name} for '${block.params.path}']`\n\t\t\t\t\t\tcase \"search_files\":\n\t\t\t\t\t\t\treturn `[${block.name} for '${block.params.regex}'${\n\t\t\t\t\t\t\t\tblock.params.file_pattern ? ` in '${block.params.file_pattern}'` : \"\"\n\t\t\t\t\t\t\t}]`\n\t\t\t\t\t\tcase \"list_files\":\n\t\t\t\t\t\t\treturn `[${block.name} for '${block.params.path}']`\n\t\t\t\t\t\tcase \"list_code_definition_names\":\n\t\t\t\t\t\t\treturn `[${block.name} for '${block.params.path}']`\n\t\t\t\t\t\tcase \"browser_action\":\n\t\t\t\t\t\t\treturn `[${block.name} for '${block.params.action}']`\n\t\t\t\t\t\tcase \"ask_followup_question\":\n\t\t\t\t\t\t\treturn `[${block.name} for '${block.params.question}']`\n\t\t\t\t\t\tcase \"attempt_completion\":\n\t\t\t\t\t\t\treturn `[${block.name}]`\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (this.didRejectTool) {\n\t\t\t\t\t// ignore any tool content after user has rejected tool once\n\t\t\t\t\tif (!block.partial) {\n\t\t\t\t\t\tthis.userMessageContent.push({\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\ttext: `Skipping tool ${toolDescription()} due to user rejecting a previous tool.`,\n\t\t\t\t\t\t})\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// partial tool after user rejected a previous tool\n\t\t\t\t\t\tthis.userMessageContent.push({\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\ttext: `Tool ${toolDescription()} was interrupted and not executed due to user rejecting a previous tool.`,\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\t}\n\n\t\t\t\tif (this.didAlreadyUseTool) {\n\t\t\t\t\t// ignore any content after a tool has already been used\n\t\t\t\t\tthis.userMessageContent.push({\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: `Tool [${block.name}] was not executed because a tool has already been used in this message. Only one tool may be used per message. You must assess the first tool's result before proceeding to use the next tool.`,\n\t\t\t\t\t})\n\t\t\t\t\tbreak\n\t\t\t\t}\n\n\t\t\t\tconst pushToolResult = (content: ToolResponse) => {\n\t\t\t\t\tthis.userMessageContent.push({\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: `${toolDescription()} Result:`,\n\t\t\t\t\t})\n\t\t\t\t\tif (typeof content === \"string\") {\n\t\t\t\t\t\tthis.userMessageContent.push({\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\ttext: content || \"(tool did not return anything)\",\n\t\t\t\t\t\t})\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.userMessageContent.push(...content)\n\t\t\t\t\t}\n\t\t\t\t\t// once a tool result has been collected, ignore all other tool uses since we should only ever present one tool result per message\n\t\t\t\t\tthis.didAlreadyUseTool = true\n\t\t\t\t}\n\n\t\t\t\tconst askApproval = async (type: ClineAsk, partialMessage?: string) => {\n\t\t\t\t\tconst { response, text, images } = await this.ask(type, partialMessage, false)\n\t\t\t\t\tif (response !== \"yesButtonClicked\") {\n\t\t\t\t\t\tif (response === \"messageResponse\") {\n\t\t\t\t\t\t\tawait this.say(\"user_feedback\", text, images)\n\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\tformatResponse.toolResult(formatResponse.toolDeniedWithFeedback(text), images),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t// this.userMessageContent.push({\n\t\t\t\t\t\t\t// \ttype: \"text\",\n\t\t\t\t\t\t\t// \ttext: `${toolDescription()}`,\n\t\t\t\t\t\t\t// })\n\t\t\t\t\t\t\t// this.toolResults.push({\n\t\t\t\t\t\t\t// \ttype: \"tool_result\",\n\t\t\t\t\t\t\t// \ttool_use_id: toolUseId,\n\t\t\t\t\t\t\t// \tcontent: this.formatToolResponseWithImages(\n\t\t\t\t\t\t\t// \t\tawait this.formatToolDeniedFeedback(text),\n\t\t\t\t\t\t\t// \t\timages\n\t\t\t\t\t\t\t// \t),\n\t\t\t\t\t\t\t// })\n\t\t\t\t\t\t\tthis.didRejectTool = true\n\t\t\t\t\t\t\treturn false\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpushToolResult(formatResponse.toolDenied())\n\t\t\t\t\t\t// this.toolResults.push({\n\t\t\t\t\t\t// \ttype: \"tool_result\",\n\t\t\t\t\t\t// \ttool_use_id: toolUseId,\n\t\t\t\t\t\t// \tcontent: await this.formatToolDenied(),\n\t\t\t\t\t\t// })\n\t\t\t\t\t\tthis.didRejectTool = true\n\t\t\t\t\t\treturn false\n\t\t\t\t\t}\n\t\t\t\t\treturn true\n\t\t\t\t}\n\n\t\t\t\tconst handleError = async (action: string, error: Error) => {\n\t\t\t\t\tconst errorString = `Error ${action}: ${JSON.stringify(serializeError(error))}`\n\t\t\t\t\tawait this.say(\n\t\t\t\t\t\t\"error\",\n\t\t\t\t\t\t`Error ${action}:\\n${error.message ?? JSON.stringify(serializeError(error), null, 2)}`,\n\t\t\t\t\t)\n\t\t\t\t\t// this.toolResults.push({\n\t\t\t\t\t// \ttype: \"tool_result\",\n\t\t\t\t\t// \ttool_use_id: toolUseId,\n\t\t\t\t\t// \tcontent: await this.formatToolError(errorString),\n\t\t\t\t\t// })\n\t\t\t\t\tpushToolResult(formatResponse.toolError(errorString))\n\t\t\t\t}\n\n\t\t\t\t// If block is partial, remove partial closing tag so its not presented to user\n\t\t\t\tconst removeClosingTag = (tag: ToolParamName, text?: string) => {\n\t\t\t\t\tif (!block.partial) {\n\t\t\t\t\t\treturn text || \"\"\n\t\t\t\t\t}\n\t\t\t\t\tif (!text) {\n\t\t\t\t\t\treturn \"\"\n\t\t\t\t\t}\n\t\t\t\t\t// This regex dynamically constructs a pattern to match the closing tag:\n\t\t\t\t\t// - Optionally matches whitespace before the tag\n\t\t\t\t\t// - Matches '<' or '</' optionally followed by any subset of characters from the tag name\n\t\t\t\t\tconst tagRegex = new RegExp(\n\t\t\t\t\t\t`\\\\s?<\\/?${tag\n\t\t\t\t\t\t\t.split(\"\")\n\t\t\t\t\t\t\t.map((char) => `(?:${char})?`)\n\t\t\t\t\t\t\t.join(\"\")}$`,\n\t\t\t\t\t\t\"g\",\n\t\t\t\t\t)\n\t\t\t\t\treturn text.replace(tagRegex, \"\")\n\t\t\t\t}\n\n\t\t\t\tif (block.name !== \"browser_action\") {\n\t\t\t\t\tawait this.browserSession.closeBrowser()\n\t\t\t\t}\n\n\t\t\t\tswitch (block.name) {\n\t\t\t\t\tcase \"write_to_file\": {\n\t\t\t\t\t\tconst relPath: string | undefined = block.params.path\n\t\t\t\t\t\tlet newContent: string | undefined = block.params.content\n\t\t\t\t\t\tif (!relPath || !newContent) {\n\t\t\t\t\t\t\t// checking for newContent ensure relPath is complete\n\t\t\t\t\t\t\t// wait so we can determine if it's a new file or editing an existing file\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Check if file exists using cached map or fs.access\n\t\t\t\t\t\tlet fileExists: boolean\n\t\t\t\t\t\tif (this.diffViewProvider.editType !== undefined) {\n\t\t\t\t\t\t\tfileExists = this.diffViewProvider.editType === \"modify\"\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst absolutePath = path.resolve(cwd, relPath)\n\t\t\t\t\t\t\tfileExists = await fileExistsAtPath(absolutePath)\n\t\t\t\t\t\t\tthis.diffViewProvider.editType = fileExists ? \"modify\" : \"create\"\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// pre-processing newContent for cases where weaker models might add artifacts like markdown codeblock markers (deepseek/llama) or extra escape characters (gemini)\n\t\t\t\t\t\tif (newContent.startsWith(\"```\")) {\n\t\t\t\t\t\t\t// this handles cases where it includes language specifiers like ```python ```js\n\t\t\t\t\t\t\tnewContent = newContent.split(\"\\n\").slice(1).join(\"\\n\").trim()\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (newContent.endsWith(\"```\")) {\n\t\t\t\t\t\t\tnewContent = newContent.split(\"\\n\").slice(0, -1).join(\"\\n\").trim()\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!this.api.getModel().id.includes(\"claude\")) {\n\t\t\t\t\t\t\t// it seems not just llama models are doing this, but also gemini and potentially others\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\tnewContent.includes(\"&gt;\") ||\n\t\t\t\t\t\t\t\tnewContent.includes(\"&lt;\") ||\n\t\t\t\t\t\t\t\tnewContent.includes(\"&quot;\")\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\tnewContent = newContent\n\t\t\t\t\t\t\t\t\t.replace(/&gt;/g, \">\")\n\t\t\t\t\t\t\t\t\t.replace(/&lt;/g, \"<\")\n\t\t\t\t\t\t\t\t\t.replace(/&quot;/g, '\"')\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst sharedMessageProps: ClineSayTool = {\n\t\t\t\t\t\t\ttool: fileExists ? \"editedExistingFile\" : \"newFileCreated\",\n\t\t\t\t\t\t\tpath: getReadablePath(cwd, removeClosingTag(\"path\", relPath)),\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif (block.partial) {\n\t\t\t\t\t\t\t\t// update gui message\n\t\t\t\t\t\t\t\tconst partialMessage = JSON.stringify(sharedMessageProps)\n\t\t\t\t\t\t\t\tawait this.ask(\"tool\", partialMessage, block.partial).catch(() => {})\n\t\t\t\t\t\t\t\t// update editor\n\t\t\t\t\t\t\t\tif (!this.diffViewProvider.isEditing) {\n\t\t\t\t\t\t\t\t\t// open the editor and prepare to stream content in\n\t\t\t\t\t\t\t\t\tawait this.diffViewProvider.open(relPath)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t// editor is open, stream content in\n\t\t\t\t\t\t\t\tawait this.diffViewProvider.update(newContent, false)\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (!relPath) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(await this.sayAndCreateMissingParamError(\"write_to_file\", \"path\"))\n\t\t\t\t\t\t\t\t\tawait this.diffViewProvider.reset()\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (!newContent) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(await this.sayAndCreateMissingParamError(\"write_to_file\", \"content\"))\n\t\t\t\t\t\t\t\t\tawait this.diffViewProvider.reset()\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\n\t\t\t\t\t\t\t\t// if isEditingFile false, that means we have the full contents of the file already.\n\t\t\t\t\t\t\t\t// it's important to note how this function works, you can't make the assumption that the block.partial conditional will always be called since it may immediately get complete, non-partial data. So this part of the logic will always be called.\n\t\t\t\t\t\t\t\t// in other words, you must always repeat the block.partial logic here\n\t\t\t\t\t\t\t\tif (!this.diffViewProvider.isEditing) {\n\t\t\t\t\t\t\t\t\t// show gui message before showing edit animation\n\t\t\t\t\t\t\t\t\tconst partialMessage = JSON.stringify(sharedMessageProps)\n\t\t\t\t\t\t\t\t\tawait this.ask(\"tool\", partialMessage, true).catch(() => {}) // sending true for partial even though it's not a partial, this shows the edit row before the content is streamed into the editor\n\t\t\t\t\t\t\t\t\tawait this.diffViewProvider.open(relPath)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tawait this.diffViewProvider.update(newContent, true)\n\t\t\t\t\t\t\t\tawait delay(300) // wait for diff view to update\n\t\t\t\t\t\t\t\tthis.diffViewProvider.scrollToFirstDiff()\n\t\t\t\t\t\t\t\tshowOmissionWarning(this.diffViewProvider.originalContent || \"\", newContent)\n\n\t\t\t\t\t\t\t\tconst completeMessage = JSON.stringify({\n\t\t\t\t\t\t\t\t\t...sharedMessageProps,\n\t\t\t\t\t\t\t\t\tcontent: fileExists ? undefined : newContent,\n\t\t\t\t\t\t\t\t\tdiff: fileExists\n\t\t\t\t\t\t\t\t\t\t? formatResponse.createPrettyPatch(\n\t\t\t\t\t\t\t\t\t\t\t\trelPath,\n\t\t\t\t\t\t\t\t\t\t\t\tthis.diffViewProvider.originalContent,\n\t\t\t\t\t\t\t\t\t\t\t\tnewContent,\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\t\t\t} satisfies ClineSayTool)\n\t\t\t\t\t\t\t\tconst didApprove = await askApproval(\"tool\", completeMessage)\n\t\t\t\t\t\t\t\tif (!didApprove) {\n\t\t\t\t\t\t\t\t\tawait this.diffViewProvider.revertChanges()\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tconst { newProblemsMessage, userEdits, finalContent } =\n\t\t\t\t\t\t\t\t\tawait this.diffViewProvider.saveChanges()\n\t\t\t\t\t\t\t\tthis.didEditFile = true // used to determine if we should wait for busy terminal to update before sending api request\n\t\t\t\t\t\t\t\tif (userEdits) {\n\t\t\t\t\t\t\t\t\tawait this.say(\n\t\t\t\t\t\t\t\t\t\t\"user_feedback_diff\",\n\t\t\t\t\t\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\t\t\t\t\t\ttool: fileExists ? \"editedExistingFile\" : \"newFileCreated\",\n\t\t\t\t\t\t\t\t\t\t\tpath: getReadablePath(cwd, relPath),\n\t\t\t\t\t\t\t\t\t\t\tdiff: userEdits,\n\t\t\t\t\t\t\t\t\t\t} satisfies ClineSayTool),\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\t`The user made the following updates to your content:\\n\\n${userEdits}\\n\\n` +\n\t\t\t\t\t\t\t\t\t\t\t`The updated content, which includes both your original modifications and the user's edits, has been successfully saved to ${relPath.toPosix()}. Here is the full, updated content of the file:\\n\\n` +\n\t\t\t\t\t\t\t\t\t\t\t`<final_file_content path=\"${relPath.toPosix()}\">\\n${finalContent}\\n</final_file_content>\\n\\n` +\n\t\t\t\t\t\t\t\t\t\t\t`Please note:\\n` +\n\t\t\t\t\t\t\t\t\t\t\t`1. You do not need to re-write the file with these changes, as they have already been applied.\\n` +\n\t\t\t\t\t\t\t\t\t\t\t`2. Proceed with the task using this updated file content as the new baseline.\\n` +\n\t\t\t\t\t\t\t\t\t\t\t`3. If the user's edits have addressed part of the task or changed the requirements, adjust your approach accordingly.` +\n\t\t\t\t\t\t\t\t\t\t\t`${newProblemsMessage}`,\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\t`The content was successfully saved to ${relPath.toPosix()}.${newProblemsMessage}`,\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tawait this.diffViewProvider.reset()\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tawait handleError(\"writing file\", error)\n\t\t\t\t\t\t\tawait this.diffViewProvider.reset()\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcase \"read_file\": {\n\t\t\t\t\t\tconst relPath: string | undefined = block.params.path\n\t\t\t\t\t\tconst sharedMessageProps: ClineSayTool = {\n\t\t\t\t\t\t\ttool: \"readFile\",\n\t\t\t\t\t\t\tpath: getReadablePath(cwd, removeClosingTag(\"path\", relPath)),\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif (block.partial) {\n\t\t\t\t\t\t\t\tconst partialMessage = JSON.stringify({\n\t\t\t\t\t\t\t\t\t...sharedMessageProps,\n\t\t\t\t\t\t\t\t\tcontent: undefined,\n\t\t\t\t\t\t\t\t} satisfies ClineSayTool)\n\t\t\t\t\t\t\t\tif (this.alwaysAllowReadOnly) {\n\t\t\t\t\t\t\t\t\tawait this.say(\"tool\", partialMessage, undefined, block.partial)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tawait this.ask(\"tool\", partialMessage, block.partial).catch(() => {})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (!relPath) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(await this.sayAndCreateMissingParamError(\"read_file\", \"path\"))\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\t\t\t\t\t\t\t\tconst absolutePath = path.resolve(cwd, relPath)\n\t\t\t\t\t\t\t\tconst completeMessage = JSON.stringify({\n\t\t\t\t\t\t\t\t\t...sharedMessageProps,\n\t\t\t\t\t\t\t\t\tcontent: absolutePath,\n\t\t\t\t\t\t\t\t} satisfies ClineSayTool)\n\t\t\t\t\t\t\t\tif (this.alwaysAllowReadOnly) {\n\t\t\t\t\t\t\t\t\tawait this.say(\"tool\", completeMessage, undefined, false) // need to be sending partialValue bool, since undefined has its own purpose in that the message is treated neither as a partial or completion of a partial, but as a single complete message\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tconst didApprove = await askApproval(\"tool\", completeMessage)\n\t\t\t\t\t\t\t\t\tif (!didApprove) {\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t// now execute the tool like normal\n\t\t\t\t\t\t\t\tconst content = await extractTextFromFile(absolutePath)\n\t\t\t\t\t\t\t\tpushToolResult(content)\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tawait handleError(\"reading file\", error)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcase \"list_files\": {\n\t\t\t\t\t\tconst relDirPath: string | undefined = block.params.path\n\t\t\t\t\t\tconst recursiveRaw: string | undefined = block.params.recursive\n\t\t\t\t\t\tconst recursive = recursiveRaw?.toLowerCase() === \"true\"\n\t\t\t\t\t\tconst sharedMessageProps: ClineSayTool = {\n\t\t\t\t\t\t\ttool: !recursive ? \"listFilesTopLevel\" : \"listFilesRecursive\",\n\t\t\t\t\t\t\tpath: getReadablePath(cwd, removeClosingTag(\"path\", relDirPath)),\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif (block.partial) {\n\t\t\t\t\t\t\t\tconst partialMessage = JSON.stringify({\n\t\t\t\t\t\t\t\t\t...sharedMessageProps,\n\t\t\t\t\t\t\t\t\tcontent: \"\",\n\t\t\t\t\t\t\t\t} satisfies ClineSayTool)\n\t\t\t\t\t\t\t\tif (this.alwaysAllowReadOnly) {\n\t\t\t\t\t\t\t\t\tawait this.say(\"tool\", partialMessage, undefined, block.partial)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tawait this.ask(\"tool\", partialMessage, block.partial).catch(() => {})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (!relDirPath) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(await this.sayAndCreateMissingParamError(\"list_files\", \"path\"))\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\t\t\t\t\t\t\t\tconst absolutePath = path.resolve(cwd, relDirPath)\n\t\t\t\t\t\t\t\tconst [files, didHitLimit] = await listFiles(absolutePath, recursive, 200)\n\t\t\t\t\t\t\t\tconst result = formatResponse.formatFilesList(absolutePath, files, didHitLimit)\n\t\t\t\t\t\t\t\tconst completeMessage = JSON.stringify({\n\t\t\t\t\t\t\t\t\t...sharedMessageProps,\n\t\t\t\t\t\t\t\t\tcontent: result,\n\t\t\t\t\t\t\t\t} satisfies ClineSayTool)\n\t\t\t\t\t\t\t\tif (this.alwaysAllowReadOnly) {\n\t\t\t\t\t\t\t\t\tawait this.say(\"tool\", completeMessage, undefined, false)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tconst didApprove = await askApproval(\"tool\", completeMessage)\n\t\t\t\t\t\t\t\t\tif (!didApprove) {\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tpushToolResult(result)\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tawait handleError(\"listing files\", error)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcase \"list_code_definition_names\": {\n\t\t\t\t\t\tconst relDirPath: string | undefined = block.params.path\n\t\t\t\t\t\tconst sharedMessageProps: ClineSayTool = {\n\t\t\t\t\t\t\ttool: \"listCodeDefinitionNames\",\n\t\t\t\t\t\t\tpath: getReadablePath(cwd, removeClosingTag(\"path\", relDirPath)),\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif (block.partial) {\n\t\t\t\t\t\t\t\tconst partialMessage = JSON.stringify({\n\t\t\t\t\t\t\t\t\t...sharedMessageProps,\n\t\t\t\t\t\t\t\t\tcontent: \"\",\n\t\t\t\t\t\t\t\t} satisfies ClineSayTool)\n\t\t\t\t\t\t\t\tif (this.alwaysAllowReadOnly) {\n\t\t\t\t\t\t\t\t\tawait this.say(\"tool\", partialMessage, undefined, block.partial)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tawait this.ask(\"tool\", partialMessage, block.partial).catch(() => {})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (!relDirPath) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\tawait this.sayAndCreateMissingParamError(\"list_code_definition_names\", \"path\"),\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\t\t\t\t\t\t\t\tconst absolutePath = path.resolve(cwd, relDirPath)\n\t\t\t\t\t\t\t\tconst result = await parseSourceCodeForDefinitionsTopLevel(absolutePath)\n\t\t\t\t\t\t\t\tconst completeMessage = JSON.stringify({\n\t\t\t\t\t\t\t\t\t...sharedMessageProps,\n\t\t\t\t\t\t\t\t\tcontent: result,\n\t\t\t\t\t\t\t\t} satisfies ClineSayTool)\n\t\t\t\t\t\t\t\tif (this.alwaysAllowReadOnly) {\n\t\t\t\t\t\t\t\t\tawait this.say(\"tool\", completeMessage, undefined, false)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tconst didApprove = await askApproval(\"tool\", completeMessage)\n\t\t\t\t\t\t\t\t\tif (!didApprove) {\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tpushToolResult(result)\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tawait handleError(\"parsing source code definitions\", error)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcase \"search_files\": {\n\t\t\t\t\t\tconst relDirPath: string | undefined = block.params.path\n\t\t\t\t\t\tconst regex: string | undefined = block.params.regex\n\t\t\t\t\t\tconst filePattern: string | undefined = block.params.file_pattern\n\t\t\t\t\t\tconst sharedMessageProps: ClineSayTool = {\n\t\t\t\t\t\t\ttool: \"searchFiles\",\n\t\t\t\t\t\t\tpath: getReadablePath(cwd, removeClosingTag(\"path\", relDirPath)),\n\t\t\t\t\t\t\tregex: removeClosingTag(\"regex\", regex),\n\t\t\t\t\t\t\tfilePattern: removeClosingTag(\"file_pattern\", filePattern),\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif (block.partial) {\n\t\t\t\t\t\t\t\tconst partialMessage = JSON.stringify({\n\t\t\t\t\t\t\t\t\t...sharedMessageProps,\n\t\t\t\t\t\t\t\t\tcontent: \"\",\n\t\t\t\t\t\t\t\t} satisfies ClineSayTool)\n\t\t\t\t\t\t\t\tif (this.alwaysAllowReadOnly) {\n\t\t\t\t\t\t\t\t\tawait this.say(\"tool\", partialMessage, undefined, block.partial)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tawait this.ask(\"tool\", partialMessage, block.partial).catch(() => {})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (!relDirPath) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(await this.sayAndCreateMissingParamError(\"search_files\", \"path\"))\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (!regex) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(await this.sayAndCreateMissingParamError(\"search_files\", \"regex\"))\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\t\t\t\t\t\t\t\tconst absolutePath = path.resolve(cwd, relDirPath)\n\t\t\t\t\t\t\t\tconst results = await regexSearchFiles(cwd, absolutePath, regex, filePattern)\n\t\t\t\t\t\t\t\tconst completeMessage = JSON.stringify({\n\t\t\t\t\t\t\t\t\t...sharedMessageProps,\n\t\t\t\t\t\t\t\t\tcontent: results,\n\t\t\t\t\t\t\t\t} satisfies ClineSayTool)\n\t\t\t\t\t\t\t\tif (this.alwaysAllowReadOnly) {\n\t\t\t\t\t\t\t\t\tawait this.say(\"tool\", completeMessage, undefined, false)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tconst didApprove = await askApproval(\"tool\", completeMessage)\n\t\t\t\t\t\t\t\t\tif (!didApprove) {\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tpushToolResult(results)\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tawait handleError(\"searching files\", error)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcase \"browser_action\": {\n\t\t\t\t\t\tconst action: BrowserAction | undefined = block.params.action as BrowserAction\n\t\t\t\t\t\tconst url: string | undefined = block.params.url\n\t\t\t\t\t\tconst coordinate: string | undefined = block.params.coordinate\n\t\t\t\t\t\tconst text: string | undefined = block.params.text\n\t\t\t\t\t\tif (!action || !browserActions.includes(action)) {\n\t\t\t\t\t\t\t// checking for action to ensure it is complete and valid\n\t\t\t\t\t\t\tif (!block.partial) {\n\t\t\t\t\t\t\t\t// if the block is complete and we don't have a valid action this is a mistake\n\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\tpushToolResult(await this.sayAndCreateMissingParamError(\"browser_action\", \"action\"))\n\t\t\t\t\t\t\t\tawait this.browserSession.closeBrowser()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif (block.partial) {\n\t\t\t\t\t\t\t\tif (action === \"launch\") {\n\t\t\t\t\t\t\t\t\tawait this.ask(\n\t\t\t\t\t\t\t\t\t\t\"browser_action_launch\",\n\t\t\t\t\t\t\t\t\t\tremoveClosingTag(\"url\", url),\n\t\t\t\t\t\t\t\t\t\tblock.partial,\n\t\t\t\t\t\t\t\t\t).catch(() => {})\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tawait this.say(\n\t\t\t\t\t\t\t\t\t\t\"browser_action\",\n\t\t\t\t\t\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\t\t\t\t\t\taction: action as BrowserAction,\n\t\t\t\t\t\t\t\t\t\t\tcoordinate: removeClosingTag(\"coordinate\", coordinate),\n\t\t\t\t\t\t\t\t\t\t\ttext: removeClosingTag(\"text\", text),\n\t\t\t\t\t\t\t\t\t\t} satisfies ClineSayBrowserAction),\n\t\t\t\t\t\t\t\t\t\tundefined,\n\t\t\t\t\t\t\t\t\t\tblock.partial,\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlet browserActionResult: BrowserActionResult\n\t\t\t\t\t\t\t\tif (action === \"launch\") {\n\t\t\t\t\t\t\t\t\tif (!url) {\n\t\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\t\tawait this.sayAndCreateMissingParamError(\"browser_action\", \"url\"),\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\tawait this.browserSession.closeBrowser()\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\t\t\t\t\t\t\t\t\tconst didApprove = await askApproval(\"browser_action_launch\", url)\n\t\t\t\t\t\t\t\t\tif (!didApprove) {\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t// NOTE: it's okay that we call this message since the partial inspect_site is finished streaming. The only scenario we have to avoid is sending messages WHILE a partial message exists at the end of the messages array. For example the api_req_finished message would interfere with the partial message, so we needed to remove that.\n\t\t\t\t\t\t\t\t\t// await this.say(\"inspect_site_result\", \"\") // no result, starts the loading spinner waiting for result\n\t\t\t\t\t\t\t\t\tawait this.say(\"browser_action_result\", \"\") // starts loading spinner\n\n\t\t\t\t\t\t\t\t\tawait this.browserSession.launchBrowser()\n\t\t\t\t\t\t\t\t\tbrowserActionResult = await this.browserSession.navigateToUrl(url)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tif (action === \"click\") {\n\t\t\t\t\t\t\t\t\t\tif (!coordinate) {\n\t\t\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\t\t\tawait this.sayAndCreateMissingParamError(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"browser_action\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"coordinate\",\n\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\tawait this.browserSession.closeBrowser()\n\t\t\t\t\t\t\t\t\t\t\tbreak // can't be within an inner switch\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif (action === \"type\") {\n\t\t\t\t\t\t\t\t\t\tif (!text) {\n\t\t\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\t\t\tawait this.sayAndCreateMissingParamError(\"browser_action\", \"text\"),\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\tawait this.browserSession.closeBrowser()\n\t\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\t\t\t\t\t\t\t\t\tawait this.say(\n\t\t\t\t\t\t\t\t\t\t\"browser_action\",\n\t\t\t\t\t\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\t\t\t\t\t\taction: action as BrowserAction,\n\t\t\t\t\t\t\t\t\t\t\tcoordinate,\n\t\t\t\t\t\t\t\t\t\t\ttext,\n\t\t\t\t\t\t\t\t\t\t} satisfies ClineSayBrowserAction),\n\t\t\t\t\t\t\t\t\t\tundefined,\n\t\t\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\tswitch (action) {\n\t\t\t\t\t\t\t\t\t\tcase \"click\":\n\t\t\t\t\t\t\t\t\t\t\tbrowserActionResult = await this.browserSession.click(coordinate!)\n\t\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t\tcase \"type\":\n\t\t\t\t\t\t\t\t\t\t\tbrowserActionResult = await this.browserSession.type(text!)\n\t\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t\tcase \"scroll_down\":\n\t\t\t\t\t\t\t\t\t\t\tbrowserActionResult = await this.browserSession.scrollDown()\n\t\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t\tcase \"scroll_up\":\n\t\t\t\t\t\t\t\t\t\t\tbrowserActionResult = await this.browserSession.scrollUp()\n\t\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t\tcase \"close\":\n\t\t\t\t\t\t\t\t\t\t\tbrowserActionResult = await this.browserSession.closeBrowser()\n\t\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tswitch (action) {\n\t\t\t\t\t\t\t\t\tcase \"launch\":\n\t\t\t\t\t\t\t\t\tcase \"click\":\n\t\t\t\t\t\t\t\t\tcase \"type\":\n\t\t\t\t\t\t\t\t\tcase \"scroll_down\":\n\t\t\t\t\t\t\t\t\tcase \"scroll_up\":\n\t\t\t\t\t\t\t\t\t\tawait this.say(\"browser_action_result\", JSON.stringify(browserActionResult))\n\t\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\t\tformatResponse.toolResult(\n\t\t\t\t\t\t\t\t\t\t\t\t`The browser action has been executed. The console logs and screenshot have been captured for your analysis.\\n\\nConsole logs:\\n${\n\t\t\t\t\t\t\t\t\t\t\t\t\tbrowserActionResult.logs || \"(No new logs)\"\n\t\t\t\t\t\t\t\t\t\t\t\t}\\n\\n(REMEMBER: if you need to proceed to using non-\\`browser_action\\` tools or launch a new browser, you MUST first close this browser. For example, if after analyzing the logs and screenshot you need to edit a file, you must first close the browser before you can use the write_to_file tool.)`,\n\t\t\t\t\t\t\t\t\t\t\t\tbrowserActionResult.screenshot ? [browserActionResult.screenshot] : [],\n\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\tcase \"close\":\n\t\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\t\tformatResponse.toolResult(\n\t\t\t\t\t\t\t\t\t\t\t\t`The browser has been closed. You may now proceed to using other tools.`,\n\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tawait this.browserSession.closeBrowser() // if any error occurs, the browser session is terminated\n\t\t\t\t\t\t\tawait handleError(\"executing browser action\", error)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcase \"execute_command\": {\n\t\t\t\t\t\tconst command: string | undefined = block.params.command\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif (block.partial) {\n\t\t\t\t\t\t\t\tawait this.ask(\"command\", removeClosingTag(\"command\", command), block.partial).catch(\n\t\t\t\t\t\t\t\t\t() => {},\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (!command) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\tawait this.sayAndCreateMissingParamError(\"execute_command\", \"command\"),\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\t\t\t\t\t\t\t\tconst didApprove = await askApproval(\"command\", command)\n\t\t\t\t\t\t\t\tif (!didApprove) {\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tconst [userRejected, result] = await this.executeCommandTool(command)\n\t\t\t\t\t\t\t\tif (userRejected) {\n\t\t\t\t\t\t\t\t\tthis.didRejectTool = true\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tpushToolResult(result)\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tawait handleError(\"executing command\", error)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tcase \"ask_followup_question\": {\n\t\t\t\t\t\tconst question: string | undefined = block.params.question\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif (block.partial) {\n\t\t\t\t\t\t\t\tawait this.ask(\"followup\", removeClosingTag(\"question\", question), block.partial).catch(\n\t\t\t\t\t\t\t\t\t() => {},\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (!question) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\tawait this.sayAndCreateMissingParamError(\"ask_followup_question\", \"question\"),\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\t\t\t\t\t\t\t\tconst { text, images } = await this.ask(\"followup\", question, false)\n\t\t\t\t\t\t\t\tawait this.say(\"user_feedback\", text ?? \"\", images)\n\t\t\t\t\t\t\t\tpushToolResult(formatResponse.toolResult(`<answer>\\n${text}\\n</answer>`, images))\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tawait handleError(\"asking question\", error)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcase \"attempt_completion\": {\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\t\t\t\t\t\tlet resultToSend = result\n\t\t\t\t\t\tif (command) {\n\t\t\t\t\t\t\tawait this.say(\"completion_result\", resultToSend)\n\t\t\t\t\t\t\t// TODO: currently we don't handle if this command fails, it could be useful to let cline know and retry\n\t\t\t\t\t\t\tconst [didUserReject, commandResult] = await this.executeCommand(command, true)\n\t\t\t\t\t\t\t// if we received non-empty string, the command was rejected or failed\n\t\t\t\t\t\t\tif (commandResult) {\n\t\t\t\t\t\t\t\treturn [didUserReject, commandResult]\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresultToSend = \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst { response, text, images } = await this.ask(\"completion_result\", resultToSend) // this prompts webview to show 'new task' button, and enable text input (which would be the 'text' here)\n\t\t\t\t\t\tif (response === \"yesButtonClicked\") {\n\t\t\t\t\t\t\treturn [false, \"\"] // signals to recursive loop to stop (for now this never happens since yesButtonClicked will trigger a new task)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tawait this.say(\"user_feedback\", text ?? \"\", images)\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tconst result: string | undefined = block.params.result\n\t\t\t\t\t\tconst command: string | undefined = block.params.command\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst lastMessage = this.clineMessages.at(-1)\n\t\t\t\t\t\t\tif (block.partial) {\n\t\t\t\t\t\t\t\tif (command) {\n\t\t\t\t\t\t\t\t\t// the attempt_completion text is done, now we're getting command\n\t\t\t\t\t\t\t\t\t// remove the previous partial attempt_completion ask, replace with say, post state to webview, then stream command\n\n\t\t\t\t\t\t\t\t\t// const secondLastMessage = this.clineMessages.at(-2)\n\t\t\t\t\t\t\t\t\tif (lastMessage && lastMessage.ask === \"command\") {\n\t\t\t\t\t\t\t\t\t\t// update command\n\t\t\t\t\t\t\t\t\t\tawait this.ask(\n\t\t\t\t\t\t\t\t\t\t\t\"command\",\n\t\t\t\t\t\t\t\t\t\t\tremoveClosingTag(\"command\", command),\n\t\t\t\t\t\t\t\t\t\t\tblock.partial,\n\t\t\t\t\t\t\t\t\t\t).catch(() => {})\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t// last message is completion_result\n\t\t\t\t\t\t\t\t\t\t// we have command string, which means we have the result as well, so finish it (doesnt have to exist yet)\n\t\t\t\t\t\t\t\t\t\tawait this.say(\n\t\t\t\t\t\t\t\t\t\t\t\"completion_result\",\n\t\t\t\t\t\t\t\t\t\t\tremoveClosingTag(\"result\", result),\n\t\t\t\t\t\t\t\t\t\t\tundefined,\n\t\t\t\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\tawait this.ask(\n\t\t\t\t\t\t\t\t\t\t\t\"command\",\n\t\t\t\t\t\t\t\t\t\t\tremoveClosingTag(\"command\", command),\n\t\t\t\t\t\t\t\t\t\t\tblock.partial,\n\t\t\t\t\t\t\t\t\t\t).catch(() => {})\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t// no command, still outputting partial result\n\t\t\t\t\t\t\t\t\tawait this.say(\n\t\t\t\t\t\t\t\t\t\t\"completion_result\",\n\t\t\t\t\t\t\t\t\t\tremoveClosingTag(\"result\", result),\n\t\t\t\t\t\t\t\t\t\tundefined,\n\t\t\t\t\t\t\t\t\t\tblock.partial,\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (!result) {\n\t\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t\t\t\t\t\tpushToolResult(\n\t\t\t\t\t\t\t\t\t\tawait this.sayAndCreateMissingParamError(\"attempt_completion\", \"result\"),\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.consecutiveMistakeCount = 0\n\n\t\t\t\t\t\t\t\tlet commandResult: ToolResponse | undefined\n\t\t\t\t\t\t\t\tif (command) {\n\t\t\t\t\t\t\t\t\tif (lastMessage && lastMessage.ask !== \"command\") {\n\t\t\t\t\t\t\t\t\t\t// havent sent a command message yet so first send completion_result then command\n\t\t\t\t\t\t\t\t\t\tawait this.say(\"completion_result\", result, undefined, false)\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t// complete command message\n\t\t\t\t\t\t\t\t\tconst didApprove = await askApproval(\"command\", command)\n\t\t\t\t\t\t\t\t\tif (!didApprove) {\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tconst [userRejected, execCommandResult] = await this.executeCommandTool(command!)\n\t\t\t\t\t\t\t\t\tif (userRejected) {\n\t\t\t\t\t\t\t\t\t\tthis.didRejectTool = true\n\t\t\t\t\t\t\t\t\t\tpushToolResult(execCommandResult)\n\t\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t// user didn't reject, but the command may have output\n\t\t\t\t\t\t\t\t\tcommandResult = execCommandResult\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tawait this.say(\"completion_result\", result, undefined, false)\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// we already sent completion_result says, an empty string asks relinquishes control over button and field\n\t\t\t\t\t\t\t\tconst { response, text, images } = await this.ask(\"completion_result\", \"\", false)\n\t\t\t\t\t\t\t\tif (response === \"yesButtonClicked\") {\n\t\t\t\t\t\t\t\t\tpushToolResult(\"\") // signals to recursive loop to stop (for now this never happens since yesButtonClicked will trigger a new task)\n\t\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tawait this.say(\"user_feedback\", text ?? \"\", images)\n\n\t\t\t\t\t\t\t\tconst toolResults: (Anthropic.TextBlockParam | Anthropic.ImageBlockParam)[] = []\n\t\t\t\t\t\t\t\tif (commandResult) {\n\t\t\t\t\t\t\t\t\tif (typeof commandResult === \"string\") {\n\t\t\t\t\t\t\t\t\t\ttoolResults.push({ type: \"text\", text: commandResult })\n\t\t\t\t\t\t\t\t\t} else if (Array.isArray(commandResult)) {\n\t\t\t\t\t\t\t\t\t\ttoolResults.push(...commandResult)\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ttoolResults.push({\n\t\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\t\ttext: `The user has provided feedback on the results. Consider their input to continue the task, and then attempt completion again.\\n<feedback>\\n${text}\\n</feedback>`,\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\ttoolResults.push(...formatResponse.imageBlocks(images))\n\t\t\t\t\t\t\t\tthis.userMessageContent.push({\n\t\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\t\ttext: `${toolDescription()} Result:`,\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\tthis.userMessageContent.push(...toolResults)\n\n\t\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tawait handleError(\"inspecting site\", error)\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t}\n\n\t\t/*\n\t\tSeeing out of bounds is fine, it means that the next too call is being built up and ready to add to assistantMessageContent to present. \n\t\tWhen you see the UI inactive during this, it means that a tool is breaking without presenting any UI. For example the write_to_file tool was breaking when relpath was undefined, and for invalid relpath it never presented UI.\n\t\t*/\n\t\tthis.presentAssistantMessageLocked = false // this needs to be placed here, if not then calling this.presentAssistantMessage below would fail (sometimes) since it's locked\n\t\t// NOTE: when tool is rejected, iterator stream is interrupted and it waits for userMessageContentReady to be true. Future calls to present will skip execution since didRejectTool and iterate until contentIndex is set to message length and it sets userMessageContentReady to true itself (instead of preemptively doing it in iterator)\n\t\tif (!block.partial || this.didRejectTool || this.didAlreadyUseTool) {\n\t\t\t// block is finished streaming and executing\n\t\t\tif (this.currentStreamingContentIndex === this.assistantMessageContent.length - 1) {\n\t\t\t\t// its okay that we increment if !didCompleteReadingStream, it'll just return bc out of bounds and as streaming continues it will call presentAssitantMessage if a new block is ready. if streaming is finished then we set userMessageContentReady to true when out of bounds. This gracefully allows the stream to continue on and all potential content blocks be presented.\n\t\t\t\t// last block is complete and it is finished executing\n\t\t\t\tthis.userMessageContentReady = true // will allow pwaitfor to continue\n\t\t\t}\n\n\t\t\t// call next block if it exists (if not then read stream will call it when its ready)\n\t\t\tthis.currentStreamingContentIndex++ // need to increment regardless, so when read stream calls this function again it will be streaming the next block\n\n\t\t\tif (this.currentStreamingContentIndex < this.assistantMessageContent.length) {\n\t\t\t\t// there are already more content blocks to stream, so we'll call this function ourselves\n\t\t\t\t// await this.presentAssistantContent()\n\n\t\t\t\tthis.presentAssistantMessage()\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\t// block is partial, but the read stream may have finished\n\t\tif (this.presentAssistantMessageHasPendingUpdates) {\n\t\t\tthis.presentAssistantMessage()\n\t\t}\n\t}\n\n\tasync recursivelyMakeClineRequests(\n\t\tuserContent: UserContent,\n\t\tincludeFileDetails: boolean = false,\n\t): Promise<boolean> {\n\t\tif (this.abort) {\n\t\t\tthrow new Error(\"Cline instance aborted\")\n\t\t}\n\n\t\tif (this.consecutiveMistakeCount >= 3) {\n\t\t\tconst { response, text, images } = await this.ask(\n\t\t\t\t\"mistake_limit_reached\",\n\t\t\t\tthis.api.getModel().id.includes(\"claude\")\n\t\t\t\t\t? `This may indicate a failure in his thought process or inability to use a tool properly, which can be mitigated with some user guidance (e.g. \"Try breaking down the task into smaller steps\").`\n\t\t\t\t\t: \"Cline uses complex prompts and iterative task execution that may be challenging for less capable models. For best results, it's recommended to use Claude 3.5 Sonnet for its advanced agentic coding capabilities.\",\n\t\t\t)\n\t\t\tif (response === \"messageResponse\") {\n\t\t\t\tuserContent.push(\n\t\t\t\t\t...[\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\ttext: formatResponse.tooManyMistakes(text),\n\t\t\t\t\t\t} as Anthropic.Messages.TextBlockParam,\n\t\t\t\t\t\t...formatResponse.imageBlocks(images),\n\t\t\t\t\t],\n\t\t\t\t)\n\t\t\t}\n\t\t\tthis.consecutiveMistakeCount = 0\n\t\t}\n\n\t\t// get previous api req's index to check token usage and determine if we need to truncate conversation history\n\t\tconst previousApiReqIndex = findLastIndex(this.clineMessages, (m) => m.say === \"api_req_started\")\n\n\t\t// getting verbose details is an expensive operation, it uses globby to top-down build file structure of project which for large projects can take a few seconds\n\t\t// for the best UX we show a placeholder api_req_started message with a loading spinner as this happens\n\t\tawait this.say(\n\t\t\t\"api_req_started\",\n\t\t\tJSON.stringify({\n\t\t\t\trequest:\n\t\t\t\t\tuserContent.map((block) => formatContentBlockToMarkdown(block)).join(\"\\n\\n\") + \"\\n\\nLoading...\",\n\t\t\t}),\n\t\t)\n\n\t\tconst [parsedUserContent, environmentDetails] = await this.loadContext(userContent, includeFileDetails)\n\t\tuserContent = parsedUserContent\n\t\t// add environment details as its own text block, separate from tool results\n\t\tuserContent.push({ type: \"text\", text: environmentDetails })\n\n\t\tawait this.addToApiConversationHistory({ role: \"user\", content: userContent })\n\n\t\t// since we sent off a placeholder api_req_started message to update the webview while waiting to actually start the API request (to load potential details for example), we need to update the text of that message\n\t\tconst lastApiReqIndex = findLastIndex(this.clineMessages, (m) => m.say === \"api_req_started\")\n\t\tthis.clineMessages[lastApiReqIndex].text = JSON.stringify({\n\t\t\trequest: userContent.map((block) => formatContentBlockToMarkdown(block)).join(\"\\n\\n\"),\n\t\t} satisfies ClineApiReqInfo)\n\t\tawait this.saveClineMessages()\n\t\tawait this.providerRef.deref()?.postStateToWebview()\n\n\t\ttry {\n\t\t\tlet cacheWriteTokens = 0\n\t\t\tlet cacheReadTokens = 0\n\t\t\tlet inputTokens = 0\n\t\t\tlet outputTokens = 0\n\t\t\tlet totalCost: number | undefined\n\n\t\t\t// update api_req_started. we can't use api_req_finished anymore since it's a unique case where it could come after a streaming message (ie in the middle of being updated or executed)\n\t\t\t// fortunately api_req_finished was always parsed out for the gui anyways, so it remains solely for legacy purposes to keep track of prices in tasks from history\n\t\t\t// (it's worth removing a few months from now)\n\t\t\tconst updateApiReqMsg = (cancelReason?: ClineApiReqCancelReason, streamingFailedMessage?: string) => {\n\t\t\t\tthis.clineMessages[lastApiReqIndex].text = JSON.stringify({\n\t\t\t\t\t...JSON.parse(this.clineMessages[lastApiReqIndex].text || \"{}\"),\n\t\t\t\t\ttokensIn: inputTokens,\n\t\t\t\t\ttokensOut: outputTokens,\n\t\t\t\t\tcacheWrites: cacheWriteTokens,\n\t\t\t\t\tcacheReads: cacheReadTokens,\n\t\t\t\t\tcost:\n\t\t\t\t\t\ttotalCost ??\n\t\t\t\t\t\tcalculateApiCost(\n\t\t\t\t\t\t\tthis.api.getModel().info,\n\t\t\t\t\t\t\tinputTokens,\n\t\t\t\t\t\t\toutputTokens,\n\t\t\t\t\t\t\tcacheWriteTokens,\n\t\t\t\t\t\t\tcacheReadTokens,\n\t\t\t\t\t\t),\n\t\t\t\t\tcancelReason,\n\t\t\t\t\tstreamingFailedMessage,\n\t\t\t\t} satisfies ClineApiReqInfo)\n\t\t\t}\n\n\t\t\tconst abortStream = async (cancelReason: ClineApiReqCancelReason, streamingFailedMessage?: string) => {\n\t\t\t\tif (this.diffViewProvider.isEditing) {\n\t\t\t\t\tawait this.diffViewProvider.revertChanges() // closes diff view\n\t\t\t\t}\n\n\t\t\t\t// if last message is a partial we need to update and save it\n\t\t\t\tconst lastMessage = this.clineMessages.at(-1)\n\t\t\t\tif (lastMessage && lastMessage.partial) {\n\t\t\t\t\t// lastMessage.ts = Date.now() DO NOT update ts since it is used as a key for virtuoso list\n\t\t\t\t\tlastMessage.partial = false\n\t\t\t\t\t// instead of streaming partialMessage events, we do a save and post like normal to persist to disk\n\t\t\t\t\tconsole.log(\"updating partial message\", lastMessage)\n\t\t\t\t\t// await this.saveClineMessages()\n\t\t\t\t}\n\n\t\t\t\t// Let assistant know their response was interrupted for when task is resumed\n\t\t\t\tawait this.addToApiConversationHistory({\n\t\t\t\t\trole: \"assistant\",\n\t\t\t\t\tcontent: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\ttext:\n\t\t\t\t\t\t\t\tassistantMessage +\n\t\t\t\t\t\t\t\t`\\n\\n[${\n\t\t\t\t\t\t\t\t\tcancelReason === \"streaming_failed\"\n\t\t\t\t\t\t\t\t\t\t? \"Response interrupted by API Error\"\n\t\t\t\t\t\t\t\t\t\t: \"Response interrupted by user\"\n\t\t\t\t\t\t\t\t}]`,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t})\n\n\t\t\t\t// update api_req_started to have cancelled and cost, so that we can display the cost of the partial stream\n\t\t\t\tupdateApiReqMsg(cancelReason, streamingFailedMessage)\n\t\t\t\tawait this.saveClineMessages()\n\n\t\t\t\t// signals to provider that it can retrieve the saved messages from disk, as abortTask can not be awaited on in nature\n\t\t\t\tthis.didFinishAborting = true\n\t\t\t}\n\n\t\t\t// reset streaming state\n\t\t\tthis.currentStreamingContentIndex = 0\n\t\t\tthis.assistantMessageContent = []\n\t\t\tthis.didCompleteReadingStream = false\n\t\t\tthis.userMessageContent = []\n\t\t\tthis.userMessageContentReady = false\n\t\t\tthis.didRejectTool = false\n\t\t\tthis.didAlreadyUseTool = false\n\t\t\tthis.presentAssistantMessageLocked = false\n\t\t\tthis.presentAssistantMessageHasPendingUpdates = false\n\t\t\tawait this.diffViewProvider.reset()\n\n\t\t\tconst stream = this.attemptApiRequest(previousApiReqIndex) // yields only if the first chunk is successful, otherwise will allow the user to retry the request (most likely due to rate limit error, which gets thrown on the first chunk)\n\t\t\tlet assistantMessage = \"\"\n\t\t\ttry {\n\t\t\t\tfor await (const chunk of stream) {\n\t\t\t\t\tswitch (chunk.type) {\n\t\t\t\t\t\tcase \"usage\":\n\t\t\t\t\t\t\tinputTokens += chunk.inputTokens\n\t\t\t\t\t\t\toutputTokens += chunk.outputTokens\n\t\t\t\t\t\t\tcacheWriteTokens += chunk.cacheWriteTokens ?? 0\n\t\t\t\t\t\t\tcacheReadTokens += chunk.cacheReadTokens ?? 0\n\t\t\t\t\t\t\ttotalCost = chunk.totalCost\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"text\":\n\t\t\t\t\t\t\tassistantMessage += chunk.text\n\t\t\t\t\t\t\t// parse raw assistant message into content blocks\n\t\t\t\t\t\t\tconst prevLength = this.assistantMessageContent.length\n\t\t\t\t\t\t\tthis.assistantMessageContent = parseAssistantMessage(assistantMessage)\n\t\t\t\t\t\t\tif (this.assistantMessageContent.length > prevLength) {\n\t\t\t\t\t\t\t\tthis.userMessageContentReady = false // new content we need to present, reset to false in case previous content set this to true\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// present content to user\n\t\t\t\t\t\t\tthis.presentAssistantMessage()\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.abort) {\n\t\t\t\t\t\tconsole.log(\"aborting stream...\")\n\t\t\t\t\t\tif (!this.abandoned) {\n\t\t\t\t\t\t\t// only need to gracefully abort if this instance isn't abandoned (sometimes openrouter stream hangs, in which case this would affect future instances of cline)\n\t\t\t\t\t\t\tawait abortStream(\"user_cancelled\")\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak // aborts the stream\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.didRejectTool) {\n\t\t\t\t\t\t// userContent has a tool rejection, so interrupt the assistant's response to present the user's feedback\n\t\t\t\t\t\tassistantMessage += \"\\n\\n[Response interrupted by user feedback]\"\n\t\t\t\t\t\t// this.userMessageContentReady = true // instead of setting this premptively, we allow the present iterator to finish and set userMessageContentReady when its ready\n\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\n\t\t\t\t\t// PREV: we need to let the request finish for openrouter to get generation details\n\t\t\t\t\t// UPDATE: it's better UX to interrupt the request at the cost of the api cost not being retrieved\n\t\t\t\t\tif (this.didAlreadyUseTool) {\n\t\t\t\t\t\tassistantMessage +=\n\t\t\t\t\t\t\t\"\\n\\n[Response interrupted by a tool use result. Only one tool may be used at a time and should be placed at the end of the message.]\"\n\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\t// abandoned happens when extension is no longer waiting for the cline instance to finish aborting (error is thrown here when any function in the for loop throws due to this.abort)\n\t\t\t\tif (!this.abandoned) {\n\t\t\t\t\tthis.abortTask() // if the stream failed, there's various states the task could be in (i.e. could have streamed some tools the user may have executed), so we just resort to replicating a cancel task\n\t\t\t\t\tawait abortStream(\n\t\t\t\t\t\t\"streaming_failed\",\n\t\t\t\t\t\terror.message ?? JSON.stringify(serializeError(error), null, 2),\n\t\t\t\t\t)\n\t\t\t\t\tconst history = await this.providerRef.deref()?.getTaskWithId(this.taskId)\n\t\t\t\t\tif (history) {\n\t\t\t\t\t\tawait this.providerRef.deref()?.initClineWithHistoryItem(history.historyItem)\n\t\t\t\t\t\t// await this.providerRef.deref()?.postStateToWebview()\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// need to call here in case the stream was aborted\n\t\t\tif (this.abort) {\n\t\t\t\tthrow new Error(\"Cline instance aborted\")\n\t\t\t}\n\n\t\t\tthis.didCompleteReadingStream = true\n\n\t\t\t// set any blocks to be complete to allow presentAssistantMessage to finish and set userMessageContentReady to true\n\t\t\t// (could be a text block that had no subsequent tool uses, or a text block at the very end, or an invalid tool use, etc. whatever the case, presentAssistantMessage relies on these blocks either to be completed or the user to reject a block in order to proceed and eventually set userMessageContentReady to true)\n\t\t\tconst partialBlocks = this.assistantMessageContent.filter((block) => block.partial)\n\t\t\tpartialBlocks.forEach((block) => {\n\t\t\t\tblock.partial = false\n\t\t\t})\n\t\t\t// this.assistantMessageContent.forEach((e) => (e.partial = false)) // cant just do this bc a tool could be in the middle of executing ()\n\t\t\tif (partialBlocks.length > 0) {\n\t\t\t\tthis.presentAssistantMessage() // if there is content to update then it will complete and update this.userMessageContentReady to true, which we pwaitfor before making the next request. all this is really doing is presenting the last partial message that we just set to complete\n\t\t\t}\n\n\t\t\tupdateApiReqMsg()\n\t\t\tawait this.saveClineMessages()\n\t\t\tawait this.providerRef.deref()?.postStateToWebview()\n\n\t\t\t// now add to apiconversationhistory\n\t\t\t// need to save assistant responses to file before proceeding to tool use since user can exit at any moment and we wouldn't be able to save the assistant's response\n\t\t\tlet didEndLoop = false\n\t\t\tif (assistantMessage.length > 0) {\n\t\t\t\tawait this.addToApiConversationHistory({\n\t\t\t\t\trole: \"assistant\",\n\t\t\t\t\tcontent: [{ type: \"text\", text: assistantMessage }],\n\t\t\t\t})\n\n\t\t\t\t// NOTE: this comment is here for future reference - this was a workaround for userMessageContent not getting set to true. It was due to it not recursively calling for partial blocks when didRejectTool, so it would get stuck waiting for a partial block to complete before it could continue.\n\t\t\t\t// in case the content blocks finished\n\t\t\t\t// it may be the api stream finished after the last parsed content block was executed, so  we are able to detect out of bounds and set userMessageContentReady to true (note you should not call presentAssistantMessage since if the last block is completed it will be presented again)\n\t\t\t\t// const completeBlocks = this.assistantMessageContent.filter((block) => !block.partial) // if there are any partial blocks after the stream ended we can consider them invalid\n\t\t\t\t// if (this.currentStreamingContentIndex >= completeBlocks.length) {\n\t\t\t\t// \tthis.userMessageContentReady = true\n\t\t\t\t// }\n\n\t\t\t\tawait pWaitFor(() => this.userMessageContentReady)\n\n\t\t\t\t// if the model did not tool use, then we need to tell it to either use a tool or attempt_completion\n\t\t\t\tconst didToolUse = this.assistantMessageContent.some((block) => block.type === \"tool_use\")\n\t\t\t\tif (!didToolUse) {\n\t\t\t\t\tthis.userMessageContent.push({\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: formatResponse.noToolsUsed(),\n\t\t\t\t\t})\n\t\t\t\t\tthis.consecutiveMistakeCount++\n\t\t\t\t}\n\n\t\t\t\tconst recDidEndLoop = await this.recursivelyMakeClineRequests(this.userMessageContent)\n\t\t\t\tdidEndLoop = recDidEndLoop\n\t\t\t} else {\n\t\t\t\t// if there's no assistant_responses, that means we got no text or tool_use content blocks from API which we should assume is an error\n\t\t\t\tawait this.say(\n\t\t\t\t\t\"error\",\n\t\t\t\t\t\"Unexpected API Response: The language model did not provide any assistant messages. This may indicate an issue with the API or the model's output.\",\n\t\t\t\t)\n\t\t\t\tawait this.addToApiConversationHistory({\n\t\t\t\t\trole: \"assistant\",\n\t\t\t\t\tcontent: [{ type: \"text\", text: \"Failure: I did not provide a response.\" }],\n\t\t\t\t})\n\t\t\t}\n\n\t\t\treturn didEndLoop // will always be false for now\n\t\t} catch (error) {\n\t\t\t// this should never happen since the only thing that can throw an error is the attemptApiRequest, which is wrapped in a try catch that sends an ask where if noButtonClicked, will clear current task and destroy this instance. However to avoid unhandled promise rejection, we will end this loop which will end execution of this instance (see startTask)\n\t\t\treturn true // needs to be true so parent loop knows to end task\n\t\t}\n\t}\n\n\tasync loadContext(userContent: UserContent, includeFileDetails: boolean = false) {\n\t\treturn await Promise.all([\n\t\t\t// Process userContent array, which contains various block types:\n\t\t\t// TextBlockParam, ImageBlockParam, ToolUseBlockParam, and ToolResultBlockParam.\n\t\t\t// We need to apply parseMentions() to:\n\t\t\t// 1. All TextBlockParam's text (first user message with task)\n\t\t\t// 2. ToolResultBlockParam's content/context text arrays if it contains \"<feedback>\" (see formatToolDeniedFeedback, attemptCompletion, executeCommand, and consecutiveMistakeCount >= 3) or \"<answer>\" (see askFollowupQuestion), we place all user generated content in these tags so they can effectively be used as markers for when we should parse mentions)\n\t\t\tPromise.all(\n\t\t\t\tuserContent.map(async (block) => {\n\t\t\t\t\tif (block.type === \"text\") {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t...block,\n\t\t\t\t\t\t\ttext: await parseMentions(block.text, cwd, this.urlContentFetcher),\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (block.type === \"tool_result\") {\n\t\t\t\t\t\tconst isUserMessage = (text: string) => text.includes(\"<feedback>\") || text.includes(\"<answer>\")\n\t\t\t\t\t\tif (typeof block.content === \"string\" && isUserMessage(block.content)) {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t...block,\n\t\t\t\t\t\t\t\tcontent: await parseMentions(block.content, cwd, this.urlContentFetcher),\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (Array.isArray(block.content)) {\n\t\t\t\t\t\t\tconst parsedContent = await Promise.all(\n\t\t\t\t\t\t\t\tblock.content.map(async (contentBlock) => {\n\t\t\t\t\t\t\t\t\tif (contentBlock.type === \"text\" && isUserMessage(contentBlock.text)) {\n\t\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t\t...contentBlock,\n\t\t\t\t\t\t\t\t\t\t\ttext: await parseMentions(contentBlock.text, cwd, this.urlContentFetcher),\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn contentBlock\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t...block,\n\t\t\t\t\t\t\t\tcontent: parsedContent,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn block\n\t\t\t\t}),\n\t\t\t),\n\t\t\tthis.getEnvironmentDetails(includeFileDetails),\n\t\t])\n\t}\n\n\tasync getEnvironmentDetails(includeFileDetails: boolean = false) {\n\t\tlet details = \"\"\n\n\t\t// It could be useful for cline to know if the user went from one or no file to another between messages, so we always include this context\n\t\tdetails += \"\\n\\n# VSCode Visible Files\"\n\t\tconst visibleFiles = vscode.window.visibleTextEditors\n\t\t\t?.map((editor) => editor.document?.uri?.fsPath)\n\t\t\t.filter(Boolean)\n\t\t\t.map((absolutePath) => path.relative(cwd, absolutePath).toPosix())\n\t\t\t.join(\"\\n\")\n\t\tif (visibleFiles) {\n\t\t\tdetails += `\\n${visibleFiles}`\n\t\t} else {\n\t\t\tdetails += \"\\n(No visible files)\"\n\t\t}\n\n\t\tdetails += \"\\n\\n# VSCode Open Tabs\"\n\t\tconst openTabs = vscode.window.tabGroups.all\n\t\t\t.flatMap((group) => group.tabs)\n\t\t\t.map((tab) => (tab.input as vscode.TabInputText)?.uri?.fsPath)\n\t\t\t.filter(Boolean)\n\t\t\t.map((absolutePath) => path.relative(cwd, absolutePath).toPosix())\n\t\t\t.join(\"\\n\")\n\t\tif (openTabs) {\n\t\t\tdetails += `\\n${openTabs}`\n\t\t} else {\n\t\t\tdetails += \"\\n(No open tabs)\"\n\t\t}\n\n\t\tconst busyTerminals = this.terminalManager.getTerminals(true)\n\t\tconst inactiveTerminals = this.terminalManager.getTerminals(false)\n\t\t// const allTerminals = [...busyTerminals, ...inactiveTerminals]\n\n\t\tif (busyTerminals.length > 0 && this.didEditFile) {\n\t\t\t//  || this.didEditFile\n\t\t\tawait delay(300) // delay after saving file to let terminals catch up\n\t\t}\n\n\t\t// let terminalWasBusy = false\n\t\tif (busyTerminals.length > 0) {\n\t\t\t// wait for terminals to cool down\n\t\t\t// terminalWasBusy = allTerminals.some((t) => this.terminalManager.isProcessHot(t.id))\n\t\t\tawait pWaitFor(() => busyTerminals.every((t) => !this.terminalManager.isProcessHot(t.id)), {\n\t\t\t\tinterval: 100,\n\t\t\t\ttimeout: 15_000,\n\t\t\t}).catch(() => {})\n\t\t}\n\n\t\t// we want to get diagnostics AFTER terminal cools down for a few reasons: terminal could be scaffolding a project, dev servers (compilers like webpack) will first re-compile and then send diagnostics, etc\n\t\t/*\n\t\tlet diagnosticsDetails = \"\"\n\t\tconst diagnostics = await this.diagnosticsMonitor.getCurrentDiagnostics(this.didEditFile || terminalWasBusy) // if cline ran a command (ie npm install) or edited the workspace then wait a bit for updated diagnostics\n\t\tfor (const [uri, fileDiagnostics] of diagnostics) {\n\t\t\tconst problems = fileDiagnostics.filter((d) => d.severity === vscode.DiagnosticSeverity.Error)\n\t\t\tif (problems.length > 0) {\n\t\t\t\tdiagnosticsDetails += `\\n## ${path.relative(cwd, uri.fsPath)}`\n\t\t\t\tfor (const diagnostic of problems) {\n\t\t\t\t\t// let severity = diagnostic.severity === vscode.DiagnosticSeverity.Error ? \"Error\" : \"Warning\"\n\t\t\t\t\tconst line = diagnostic.range.start.line + 1 // VSCode lines are 0-indexed\n\t\t\t\t\tconst source = diagnostic.source ? `[${diagnostic.source}] ` : \"\"\n\t\t\t\t\tdiagnosticsDetails += `\\n- ${source}Line ${line}: ${diagnostic.message}`\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t*/\n\t\tthis.didEditFile = false // reset, this lets us know when to wait for saved files to update terminals\n\n\t\t// waiting for updated diagnostics lets terminal output be the most up-to-date possible\n\t\tlet terminalDetails = \"\"\n\t\tif (busyTerminals.length > 0) {\n\t\t\t// terminals are cool, let's retrieve their output\n\t\t\tterminalDetails += \"\\n\\n# Actively Running Terminals\"\n\t\t\tfor (const busyTerminal of busyTerminals) {\n\t\t\t\tterminalDetails += `\\n## Original command: \\`${busyTerminal.lastCommand}\\``\n\t\t\t\tconst newOutput = this.terminalManager.getUnretrievedOutput(busyTerminal.id)\n\t\t\t\tif (newOutput) {\n\t\t\t\t\tterminalDetails += `\\n### New Output\\n${newOutput}`\n\t\t\t\t} else {\n\t\t\t\t\t// details += `\\n(Still running, no new output)` // don't want to show this right after running the command\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// only show inactive terminals if there's output to show\n\t\tif (inactiveTerminals.length > 0) {\n\t\t\tconst inactiveTerminalOutputs = new Map<number, string>()\n\t\t\tfor (const inactiveTerminal of inactiveTerminals) {\n\t\t\t\tconst newOutput = this.terminalManager.getUnretrievedOutput(inactiveTerminal.id)\n\t\t\t\tif (newOutput) {\n\t\t\t\t\tinactiveTerminalOutputs.set(inactiveTerminal.id, newOutput)\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (inactiveTerminalOutputs.size > 0) {\n\t\t\t\tterminalDetails += \"\\n\\n# Inactive Terminals\"\n\t\t\t\tfor (const [terminalId, newOutput] of inactiveTerminalOutputs) {\n\t\t\t\t\tconst inactiveTerminal = inactiveTerminals.find((t) => t.id === terminalId)\n\t\t\t\t\tif (inactiveTerminal) {\n\t\t\t\t\t\tterminalDetails += `\\n## ${inactiveTerminal.lastCommand}`\n\t\t\t\t\t\tterminalDetails += `\\n### New Output\\n${newOutput}`\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// details += \"\\n\\n# VSCode Workspace Errors\"\n\t\t// if (diagnosticsDetails) {\n\t\t// \tdetails += diagnosticsDetails\n\t\t// } else {\n\t\t// \tdetails += \"\\n(No errors detected)\"\n\t\t// }\n\n\t\tif (terminalDetails) {\n\t\t\tdetails += terminalDetails\n\t\t}\n\n\t\tif (includeFileDetails) {\n\t\t\tdetails += `\\n\\n# Current Working Directory (${cwd.toPosix()}) Files\\n`\n\t\t\tconst isDesktop = arePathsEqual(cwd, path.join(os.homedir(), \"Desktop\"))\n\t\t\tif (isDesktop) {\n\t\t\t\t// don't want to immediately access desktop since it would show permission popup\n\t\t\t\tdetails += \"(Desktop files not shown automatically. Use list_files to explore if needed.)\"\n\t\t\t} else {\n\t\t\t\tconst [files, didHitLimit] = await listFiles(cwd, true, 200)\n\t\t\t\tconst result = formatResponse.formatFilesList(cwd, files, didHitLimit)\n\t\t\t\tdetails += result\n\t\t\t}\n\t\t}\n\n\t\treturn `<environment_details>\\n${details.trim()}\\n</environment_details>`\n\t}\n}\n", "tag": "", "tokens": 24938, "metadata": {}}], "modify_time": 1733144568.7200427}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/sliding-window/index.ts", "relative_path": "cline/src/core/sliding-window/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/sliding-window/index.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\n\n/*\nWe can't implement a dynamically updating sliding window as it would break prompt cache\nevery time. To maintain the benefits of caching, we need to keep conversation history\nstatic. This operation should be performed as infrequently as possible. If a user reaches\na 200k context, we can assume that the first half is likely irrelevant to their current task.\nTherefore, this function should only be called when absolutely necessary to fit within\ncontext limits, not as a continuous process.\n*/\nexport function truncateHalfConversation(\n\tmessages: Anthropic.Messages.MessageParam[],\n): Anthropic.Messages.MessageParam[] {\n\t// API expects messages to be in user-assistant order, and tool use messages must be followed by tool results. We need to maintain this structure while truncating.\n\n\t// Always keep the first Task message (this includes the project's file structure in environment_details)\n\tconst truncatedMessages = [messages[0]]\n\n\t// Remove half of user-assistant pairs\n\tconst messagesToRemove = Math.floor(messages.length / 4) * 2 // has to be even number\n\n\tconst remainingMessages = messages.slice(messagesToRemove + 1) // has to start with assistant message since tool result cannot follow assistant message with no tool use\n\ttruncatedMessages.push(...remainingMessages)\n\n\treturn truncatedMessages\n}\n", "tag": "", "tokens": 315, "metadata": {}}], "modify_time": 1733144568.7213047}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/webview/getNonce.ts", "relative_path": "cline/src/core/webview/getNonce.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/webview/getNonce.ts", "source_code": "/**\n * A helper function that returns a unique alphanumeric identifier called a nonce.\n *\n * @remarks This function is primarily used to help enforce content security\n * policies for resources/scripts being executed in a webview context.\n *\n * @returns A nonce\n */\nexport function getNonce() {\n\tlet text = \"\"\n\tconst possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\"\n\tfor (let i = 0; i < 32; i++) {\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length))\n\t}\n\treturn text\n}\n", "tag": "", "tokens": 165, "metadata": {}}], "modify_time": 1733144568.72188}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/webview/ClineProvider.ts", "relative_path": "cline/src/core/webview/ClineProvider.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/webview/ClineProvider.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport axios from \"axios\"\nimport fs from \"fs/promises\"\nimport pWaitFor from \"p-wait-for\"\nimport * as path from \"path\"\nimport * as vscode from \"vscode\"\nimport { buildApiHandler } from \"../../api\"\nimport { downloadTask } from \"../../integrations/misc/export-markdown\"\nimport { openFile, openImage } from \"../../integrations/misc/open-file\"\nimport { selectImages } from \"../../integrations/misc/process-images\"\nimport { getTheme } from \"../../integrations/theme/getTheme\"\nimport WorkspaceTracker from \"../../integrations/workspace/WorkspaceTracker\"\nimport { ApiProvider, ModelInfo } from \"../../shared/api\"\nimport { findLast } from \"../../shared/array\"\nimport { ExtensionMessage } from \"../../shared/ExtensionMessage\"\nimport { HistoryItem } from \"../../shared/HistoryItem\"\nimport { WebviewMessage } from \"../../shared/WebviewMessage\"\nimport { fileExistsAtPath } from \"../../utils/fs\"\nimport { Cline } from \"../Cline\"\nimport { openMention } from \"../mentions\"\nimport { getNonce } from \"./getNonce\"\nimport { getUri } from \"./getUri\"\n\n/*\nhttps://github.com/microsoft/vscode-webview-ui-toolkit-samples/blob/main/default/weather-webview/src/providers/WeatherViewProvider.ts\n\nhttps://github.com/KumarVariable/vscode-extension-sidebar-html/blob/master/src/customSidebarViewProvider.ts\n*/\n\ntype SecretKey =\n\t| \"apiKey\"\n\t| \"openRouterApiKey\"\n\t| \"awsAccessKey\"\n\t| \"awsSecretKey\"\n\t| \"awsSessionToken\"\n\t| \"openAiApiKey\"\n\t| \"geminiApiKey\"\n\t| \"openAiNativeApiKey\"\ntype GlobalStateKey =\n\t| \"apiProvider\"\n\t| \"apiModelId\"\n\t| \"awsRegion\"\n\t| \"awsUseCrossRegionInference\"\n\t| \"vertexProjectId\"\n\t| \"vertexRegion\"\n\t| \"lastShownAnnouncementId\"\n\t| \"customInstructions\"\n\t| \"alwaysAllowReadOnly\"\n\t| \"taskHistory\"\n\t| \"openAiBaseUrl\"\n\t| \"openAiModelId\"\n\t| \"ollamaModelId\"\n\t| \"ollamaBaseUrl\"\n\t| \"lmStudioModelId\"\n\t| \"lmStudioBaseUrl\"\n\t| \"anthropicBaseUrl\"\n\t| \"azureApiVersion\"\n\t| \"openRouterModelId\"\n\t| \"openRouterModelInfo\"\n\nexport const GlobalFileNames = {\n\tapiConversationHistory: \"api_conversation_history.json\",\n\tuiMessages: \"ui_messages.json\",\n\topenRouterModels: \"openrouter_models.json\",\n}\n\nexport class ClineProvider implements vscode.WebviewViewProvider {\n\tpublic static readonly sideBarId = \"claude-dev.SidebarProvider\" // used in package.json as the view's id. This value cannot be changed due to how vscode caches views based on their id, and updating the id would break existing instances of the extension.\n\tpublic static readonly tabPanelId = \"claude-dev.TabPanelProvider\"\n\tprivate static activeInstances: Set<ClineProvider> = new Set()\n\tprivate disposables: vscode.Disposable[] = []\n\tprivate view?: vscode.WebviewView | vscode.WebviewPanel\n\tprivate cline?: Cline\n\tprivate workspaceTracker?: WorkspaceTracker\n\tprivate latestAnnouncementId = \"oct-28-2024\" // update to some unique identifier when we add a new announcement\n\n\tconstructor(\n\t\treadonly context: vscode.ExtensionContext,\n\t\tprivate readonly outputChannel: vscode.OutputChannel,\n\t) {\n\t\tthis.outputChannel.appendLine(\"ClineProvider instantiated\")\n\t\tClineProvider.activeInstances.add(this)\n\t\tthis.workspaceTracker = new WorkspaceTracker(this)\n\t}\n\n\t/*\n\tVSCode extensions use the disposable pattern to clean up resources when the sidebar/editor tab is closed by the user or system. This applies to event listening, commands, interacting with the UI, etc.\n\t- https://vscode-docs.readthedocs.io/en/stable/extensions/patterns-and-principles/\n\t- https://github.com/microsoft/vscode-extension-samples/blob/main/webview-sample/src/extension.ts\n\t*/\n\tasync dispose() {\n\t\tthis.outputChannel.appendLine(\"Disposing ClineProvider...\")\n\t\tawait this.clearTask()\n\t\tthis.outputChannel.appendLine(\"Cleared task\")\n\t\tif (this.view && \"dispose\" in this.view) {\n\t\t\tthis.view.dispose()\n\t\t\tthis.outputChannel.appendLine(\"Disposed webview\")\n\t\t}\n\t\twhile (this.disposables.length) {\n\t\t\tconst x = this.disposables.pop()\n\t\t\tif (x) {\n\t\t\t\tx.dispose()\n\t\t\t}\n\t\t}\n\t\tthis.workspaceTracker?.dispose()\n\t\tthis.workspaceTracker = undefined\n\t\tthis.outputChannel.appendLine(\"Disposed all disposables\")\n\t\tClineProvider.activeInstances.delete(this)\n\t}\n\n\tpublic static getVisibleInstance(): ClineProvider | undefined {\n\t\treturn findLast(Array.from(this.activeInstances), (instance) => instance.view?.visible === true)\n\t}\n\n\tresolveWebviewView(\n\t\twebviewView: vscode.WebviewView | vscode.WebviewPanel,\n\t\t//context: vscode.WebviewViewResolveContext<unknown>, used to recreate a deallocated webview, but we don't need this since we use retainContextWhenHidden\n\t\t//token: vscode.CancellationToken\n\t): void | Thenable<void> {\n\t\tthis.outputChannel.appendLine(\"Resolving webview view\")\n\t\tthis.view = webviewView\n\n\t\twebviewView.webview.options = {\n\t\t\t// Allow scripts in the webview\n\t\t\tenableScripts: true,\n\t\t\tlocalResourceRoots: [this.context.extensionUri],\n\t\t}\n\t\twebviewView.webview.html = this.getHtmlContent(webviewView.webview)\n\n\t\t// Sets up an event listener to listen for messages passed from the webview view context\n\t\t// and executes code based on the message that is recieved\n\t\tthis.setWebviewMessageListener(webviewView.webview)\n\n\t\t// Logs show up in bottom panel > Debug Console\n\t\t//console.log(\"registering listener\")\n\n\t\t// Listen for when the panel becomes visible\n\t\t// https://github.com/microsoft/vscode-discussions/discussions/840\n\t\tif (\"onDidChangeViewState\" in webviewView) {\n\t\t\t// WebviewView and WebviewPanel have all the same properties except for this visibility listener\n\t\t\t// panel\n\t\t\twebviewView.onDidChangeViewState(\n\t\t\t\t() => {\n\t\t\t\t\tif (this.view?.visible) {\n\t\t\t\t\t\tthis.postMessageToWebview({ type: \"action\", action: \"didBecomeVisible\" })\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tnull,\n\t\t\t\tthis.disposables,\n\t\t\t)\n\t\t} else if (\"onDidChangeVisibility\" in webviewView) {\n\t\t\t// sidebar\n\t\t\twebviewView.onDidChangeVisibility(\n\t\t\t\t() => {\n\t\t\t\t\tif (this.view?.visible) {\n\t\t\t\t\t\tthis.postMessageToWebview({ type: \"action\", action: \"didBecomeVisible\" })\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tnull,\n\t\t\t\tthis.disposables,\n\t\t\t)\n\t\t}\n\n\t\t// Listen for when the view is disposed\n\t\t// This happens when the user closes the view or when the view is closed programmatically\n\t\twebviewView.onDidDispose(\n\t\t\tasync () => {\n\t\t\t\tawait this.dispose()\n\t\t\t},\n\t\t\tnull,\n\t\t\tthis.disposables,\n\t\t)\n\n\t\t// Listen for when color changes\n\t\tvscode.workspace.onDidChangeConfiguration(\n\t\t\tasync (e) => {\n\t\t\t\tif (e && e.affectsConfiguration(\"workbench.colorTheme\")) {\n\t\t\t\t\t// Sends latest theme name to webview\n\t\t\t\t\tawait this.postMessageToWebview({ type: \"theme\", text: JSON.stringify(await getTheme()) })\n\t\t\t\t}\n\t\t\t},\n\t\t\tnull,\n\t\t\tthis.disposables,\n\t\t)\n\n\t\t// if the extension is starting a new session, clear previous task state\n\t\tthis.clearTask()\n\n\t\tthis.outputChannel.appendLine(\"Webview view resolved\")\n\t}\n\n\tasync initClineWithTask(task?: string, images?: string[]) {\n\t\tawait this.clearTask() // ensures that an exising task doesn't exist before starting a new one, although this shouldn't be possible since user must clear task before starting a new one\n\t\tconst { apiConfiguration, customInstructions, alwaysAllowReadOnly } = await this.getState()\n\t\tthis.cline = new Cline(this, apiConfiguration, customInstructions, alwaysAllowReadOnly, task, images)\n\t}\n\n\tasync initClineWithHistoryItem(historyItem: HistoryItem) {\n\t\tawait this.clearTask()\n\t\tconst { apiConfiguration, customInstructions, alwaysAllowReadOnly } = await this.getState()\n\t\tthis.cline = new Cline(\n\t\t\tthis,\n\t\t\tapiConfiguration,\n\t\t\tcustomInstructions,\n\t\t\talwaysAllowReadOnly,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\thistoryItem,\n\t\t)\n\t}\n\n\t// Send any JSON serializable data to the react app\n\tasync postMessageToWebview(message: ExtensionMessage) {\n\t\tawait this.view?.webview.postMessage(message)\n\t}\n\n\t/**\n\t * Defines and returns the HTML that should be rendered within the webview panel.\n\t *\n\t * @remarks This is also the place where references to the React webview build files\n\t * are created and inserted into the webview HTML.\n\t *\n\t * @param webview A reference to the extension webview\n\t * @param extensionUri The URI of the directory containing the extension\n\t * @returns A template string literal containing the HTML that should be\n\t * rendered within the webview panel\n\t */\n\tprivate getHtmlContent(webview: vscode.Webview): string {\n\t\t// Get the local path to main script run in the webview,\n\t\t// then convert it to a uri we can use in the webview.\n\n\t\t// The CSS file from the React build output\n\t\tconst stylesUri = getUri(webview, this.context.extensionUri, [\n\t\t\t\"webview-ui\",\n\t\t\t\"build\",\n\t\t\t\"static\",\n\t\t\t\"css\",\n\t\t\t\"main.css\",\n\t\t])\n\t\t// The JS file from the React build output\n\t\tconst scriptUri = getUri(webview, this.context.extensionUri, [\"webview-ui\", \"build\", \"static\", \"js\", \"main.js\"])\n\n\t\t// The codicon font from the React build output\n\t\t// https://github.com/microsoft/vscode-extension-samples/blob/main/webview-codicons-sample/src/extension.ts\n\t\t// we installed this package in the extension so that we can access it how its intended from the extension (the font file is likely bundled in vscode), and we just import the css fileinto our react app we don't have access to it\n\t\t// don't forget to add font-src ${webview.cspSource};\n\t\tconst codiconsUri = getUri(webview, this.context.extensionUri, [\n\t\t\t\"node_modules\",\n\t\t\t\"@vscode\",\n\t\t\t\"codicons\",\n\t\t\t\"dist\",\n\t\t\t\"codicon.css\",\n\t\t])\n\n\t\t// const scriptUri = webview.asWebviewUri(vscode.Uri.joinPath(this._extensionUri, \"assets\", \"main.js\"))\n\n\t\t// const styleResetUri = webview.asWebviewUri(vscode.Uri.joinPath(this._extensionUri, \"assets\", \"reset.css\"))\n\t\t// const styleVSCodeUri = webview.asWebviewUri(vscode.Uri.joinPath(this._extensionUri, \"assets\", \"vscode.css\"))\n\n\t\t// // Same for stylesheet\n\t\t// const stylesheetUri = webview.asWebviewUri(vscode.Uri.joinPath(this._extensionUri, \"assets\", \"main.css\"))\n\n\t\t// Use a nonce to only allow a specific script to be run.\n\t\t/*\n        content security policy of your webview to only allow scripts that have a specific nonce\n        create a content security policy meta tag so that only loading scripts with a nonce is allowed\n        As your extension grows you will likely want to add custom styles, fonts, and/or images to your webview. If you do, you will need to update the content security policy meta tag to explicity allow for these resources. E.g.\n                <meta http-equiv=\"Content-Security-Policy\" content=\"default-src 'none'; style-src ${webview.cspSource}; font-src ${webview.cspSource}; img-src ${webview.cspSource} https:; script-src 'nonce-${nonce}';\">\n\t\t- 'unsafe-inline' is required for styles due to vscode-webview-toolkit's dynamic style injection\n\t\t- since we pass base64 images to the webview, we need to specify img-src ${webview.cspSource} data:;\n\n        in meta tag we add nonce attribute: A cryptographic nonce (only used once) to allow scripts. The server must generate a unique nonce value each time it transmits a policy. It is critical to provide a nonce that cannot be guessed as bypassing a resource's policy is otherwise trivial.\n        */\n\t\tconst nonce = getNonce()\n\n\t\t// Tip: Install the es6-string-html VS Code extension to enable code highlighting below\n\t\treturn /*html*/ `\n        <!DOCTYPE html>\n        <html lang=\"en\">\n          <head>\n            <meta charset=\"utf-8\">\n            <meta name=\"viewport\" content=\"width=device-width,initial-scale=1,shrink-to-fit=no\">\n            <meta name=\"theme-color\" content=\"#000000\">\n            <meta http-equiv=\"Content-Security-Policy\" content=\"default-src 'none'; font-src ${webview.cspSource}; style-src ${webview.cspSource} 'unsafe-inline'; img-src ${webview.cspSource} data:; script-src 'nonce-${nonce}';\">\n            <link rel=\"stylesheet\" type=\"text/css\" href=\"${stylesUri}\">\n\t\t\t<link href=\"${codiconsUri}\" rel=\"stylesheet\" />\n            <title>Cline</title>\n          </head>\n          <body>\n            <noscript>You need to enable JavaScript to run this app.</noscript>\n            <div id=\"root\"></div>\n            <script nonce=\"${nonce}\" src=\"${scriptUri}\"></script>\n          </body>\n        </html>\n      `\n\t}\n\n\t/**\n\t * Sets up an event listener to listen for messages passed from the webview context and\n\t * executes code based on the message that is recieved.\n\t *\n\t * @param webview A reference to the extension webview\n\t */\n\tprivate setWebviewMessageListener(webview: vscode.Webview) {\n\t\twebview.onDidReceiveMessage(\n\t\t\tasync (message: WebviewMessage) => {\n\t\t\t\tswitch (message.type) {\n\t\t\t\t\tcase \"webviewDidLaunch\":\n\t\t\t\t\t\tthis.postStateToWebview()\n\t\t\t\t\t\tthis.workspaceTracker?.initializeFilePaths() // don't await\n\t\t\t\t\t\tgetTheme().then((theme) =>\n\t\t\t\t\t\t\tthis.postMessageToWebview({ type: \"theme\", text: JSON.stringify(theme) }),\n\t\t\t\t\t\t)\n\t\t\t\t\t\t// post last cached models in case the call to endpoint fails\n\t\t\t\t\t\tthis.readOpenRouterModels().then((openRouterModels) => {\n\t\t\t\t\t\t\tif (openRouterModels) {\n\t\t\t\t\t\t\t\tthis.postMessageToWebview({ type: \"openRouterModels\", openRouterModels })\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t// gui relies on model info to be up-to-date to provide the most accurate pricing, so we need to fetch the latest details on launch.\n\t\t\t\t\t\t// we do this for all users since many users switch between api providers and if they were to switch back to openrouter it would be showing outdated model info if we hadn't retrieved the latest at this point\n\t\t\t\t\t\t// (see normalizeApiConfiguration > openrouter)\n\t\t\t\t\t\tthis.refreshOpenRouterModels().then(async (openRouterModels) => {\n\t\t\t\t\t\t\tif (openRouterModels) {\n\t\t\t\t\t\t\t\t// update model info in state (this needs to be done here since we don't want to update state while settings is open, and we may refresh models there)\n\t\t\t\t\t\t\t\tconst { apiConfiguration } = await this.getState()\n\t\t\t\t\t\t\t\tif (apiConfiguration.openRouterModelId) {\n\t\t\t\t\t\t\t\t\tawait this.updateGlobalState(\n\t\t\t\t\t\t\t\t\t\t\"openRouterModelInfo\",\n\t\t\t\t\t\t\t\t\t\topenRouterModels[apiConfiguration.openRouterModelId],\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\tawait this.postStateToWebview()\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"newTask\":\n\t\t\t\t\t\t// Code that should run in response to the hello message command\n\t\t\t\t\t\t//vscode.window.showInformationMessage(message.text!)\n\n\t\t\t\t\t\t// Send a message to our webview.\n\t\t\t\t\t\t// You can send any JSON serializable data.\n\t\t\t\t\t\t// Could also do this in extension .ts\n\t\t\t\t\t\t//this.postMessageToWebview({ type: \"text\", text: `Extension: ${Date.now()}` })\n\t\t\t\t\t\t// initializing new instance of Cline will make sure that any agentically running promises in old instance don't affect our new task. this essentially creates a fresh slate for the new task\n\t\t\t\t\t\tawait this.initClineWithTask(message.text, message.images)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"apiConfiguration\":\n\t\t\t\t\t\tif (message.apiConfiguration) {\n\t\t\t\t\t\t\tconst {\n\t\t\t\t\t\t\t\tapiProvider,\n\t\t\t\t\t\t\t\tapiModelId,\n\t\t\t\t\t\t\t\tapiKey,\n\t\t\t\t\t\t\t\topenRouterApiKey,\n\t\t\t\t\t\t\t\tawsAccessKey,\n\t\t\t\t\t\t\t\tawsSecretKey,\n\t\t\t\t\t\t\t\tawsSessionToken,\n\t\t\t\t\t\t\t\tawsRegion,\n\t\t\t\t\t\t\t\tawsUseCrossRegionInference,\n\t\t\t\t\t\t\t\tvertexProjectId,\n\t\t\t\t\t\t\t\tvertexRegion,\n\t\t\t\t\t\t\t\topenAiBaseUrl,\n\t\t\t\t\t\t\t\topenAiApiKey,\n\t\t\t\t\t\t\t\topenAiModelId,\n\t\t\t\t\t\t\t\tollamaModelId,\n\t\t\t\t\t\t\t\tollamaBaseUrl,\n\t\t\t\t\t\t\t\tlmStudioModelId,\n\t\t\t\t\t\t\t\tlmStudioBaseUrl,\n\t\t\t\t\t\t\t\tanthropicBaseUrl,\n\t\t\t\t\t\t\t\tgeminiApiKey,\n\t\t\t\t\t\t\t\topenAiNativeApiKey,\n\t\t\t\t\t\t\t\tazureApiVersion,\n\t\t\t\t\t\t\t\topenRouterModelId,\n\t\t\t\t\t\t\t\topenRouterModelInfo,\n\t\t\t\t\t\t\t} = message.apiConfiguration\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"apiProvider\", apiProvider)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"apiModelId\", apiModelId)\n\t\t\t\t\t\t\tawait this.storeSecret(\"apiKey\", apiKey)\n\t\t\t\t\t\t\tawait this.storeSecret(\"openRouterApiKey\", openRouterApiKey)\n\t\t\t\t\t\t\tawait this.storeSecret(\"awsAccessKey\", awsAccessKey)\n\t\t\t\t\t\t\tawait this.storeSecret(\"awsSecretKey\", awsSecretKey)\n\t\t\t\t\t\t\tawait this.storeSecret(\"awsSessionToken\", awsSessionToken)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"awsRegion\", awsRegion)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"awsUseCrossRegionInference\", awsUseCrossRegionInference)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"vertexProjectId\", vertexProjectId)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"vertexRegion\", vertexRegion)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"openAiBaseUrl\", openAiBaseUrl)\n\t\t\t\t\t\t\tawait this.storeSecret(\"openAiApiKey\", openAiApiKey)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"openAiModelId\", openAiModelId)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"ollamaModelId\", ollamaModelId)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"ollamaBaseUrl\", ollamaBaseUrl)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"lmStudioModelId\", lmStudioModelId)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"lmStudioBaseUrl\", lmStudioBaseUrl)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"anthropicBaseUrl\", anthropicBaseUrl)\n\t\t\t\t\t\t\tawait this.storeSecret(\"geminiApiKey\", geminiApiKey)\n\t\t\t\t\t\t\tawait this.storeSecret(\"openAiNativeApiKey\", openAiNativeApiKey)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"azureApiVersion\", azureApiVersion)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"openRouterModelId\", openRouterModelId)\n\t\t\t\t\t\t\tawait this.updateGlobalState(\"openRouterModelInfo\", openRouterModelInfo)\n\t\t\t\t\t\t\tif (this.cline) {\n\t\t\t\t\t\t\t\tthis.cline.api = buildApiHandler(message.apiConfiguration)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tawait this.postStateToWebview()\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"customInstructions\":\n\t\t\t\t\t\tawait this.updateCustomInstructions(message.text)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"alwaysAllowReadOnly\":\n\t\t\t\t\t\tawait this.updateGlobalState(\"alwaysAllowReadOnly\", message.bool ?? undefined)\n\t\t\t\t\t\tif (this.cline) {\n\t\t\t\t\t\t\tthis.cline.alwaysAllowReadOnly = message.bool ?? false\n\t\t\t\t\t\t}\n\t\t\t\t\t\tawait this.postStateToWebview()\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"askResponse\":\n\t\t\t\t\t\tthis.cline?.handleWebviewAskResponse(message.askResponse!, message.text, message.images)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"clearTask\":\n\t\t\t\t\t\t// newTask will start a new task with a given task text, while clear task resets the current session and allows for a new task to be started\n\t\t\t\t\t\tawait this.clearTask()\n\t\t\t\t\t\tawait this.postStateToWebview()\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"didShowAnnouncement\":\n\t\t\t\t\t\tawait this.updateGlobalState(\"lastShownAnnouncementId\", this.latestAnnouncementId)\n\t\t\t\t\t\tawait this.postStateToWebview()\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"selectImages\":\n\t\t\t\t\t\tconst images = await selectImages()\n\t\t\t\t\t\tawait this.postMessageToWebview({ type: \"selectedImages\", images })\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"exportCurrentTask\":\n\t\t\t\t\t\tconst currentTaskId = this.cline?.taskId\n\t\t\t\t\t\tif (currentTaskId) {\n\t\t\t\t\t\t\tthis.exportTaskWithId(currentTaskId)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"showTaskWithId\":\n\t\t\t\t\t\tthis.showTaskWithId(message.text!)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"deleteTaskWithId\":\n\t\t\t\t\t\tthis.deleteTaskWithId(message.text!)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"exportTaskWithId\":\n\t\t\t\t\t\tthis.exportTaskWithId(message.text!)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"resetState\":\n\t\t\t\t\t\tawait this.resetState()\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"requestOllamaModels\":\n\t\t\t\t\t\tconst ollamaModels = await this.getOllamaModels(message.text)\n\t\t\t\t\t\tthis.postMessageToWebview({ type: \"ollamaModels\", ollamaModels })\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"requestLmStudioModels\":\n\t\t\t\t\t\tconst lmStudioModels = await this.getLmStudioModels(message.text)\n\t\t\t\t\t\tthis.postMessageToWebview({ type: \"lmStudioModels\", lmStudioModels })\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"refreshOpenRouterModels\":\n\t\t\t\t\t\tawait this.refreshOpenRouterModels()\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"openImage\":\n\t\t\t\t\t\topenImage(message.text!)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"openFile\":\n\t\t\t\t\t\topenFile(message.text!)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"openMention\":\n\t\t\t\t\t\topenMention(message.text)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase \"cancelTask\":\n\t\t\t\t\t\tif (this.cline) {\n\t\t\t\t\t\t\tconst { historyItem } = await this.getTaskWithId(this.cline.taskId)\n\t\t\t\t\t\t\tthis.cline.abortTask()\n\t\t\t\t\t\t\tawait pWaitFor(() => this.cline === undefined || this.cline.didFinishAborting, {\n\t\t\t\t\t\t\t\ttimeout: 3_000,\n\t\t\t\t\t\t\t}).catch(() => {\n\t\t\t\t\t\t\t\tconsole.error(\"Failed to abort task\")\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\tif (this.cline) {\n\t\t\t\t\t\t\t\t// 'abandoned' will prevent this cline instance from affecting future cline instance gui. this may happen if its hanging on a streaming request\n\t\t\t\t\t\t\t\tthis.cline.abandoned = true\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tawait this.initClineWithHistoryItem(historyItem) // clears task again, so we need to abortTask manually above\n\t\t\t\t\t\t\t// await this.postStateToWebview() // new Cline instance will post state when it's ready. having this here sent an empty messages array to webview leading to virtuoso having to reload the entire list\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbreak\n\t\t\t\t\t// Add more switch case statements here as more webview message commands\n\t\t\t\t\t// are created within the webview context (i.e. inside media/main.js)\n\t\t\t\t}\n\t\t\t},\n\t\t\tnull,\n\t\t\tthis.disposables,\n\t\t)\n\t}\n\n\tasync updateCustomInstructions(instructions?: string) {\n\t\t// User may be clearing the field\n\t\tawait this.updateGlobalState(\"customInstructions\", instructions || undefined)\n\t\tif (this.cline) {\n\t\t\tthis.cline.customInstructions = instructions || undefined\n\t\t}\n\t\tawait this.postStateToWebview()\n\t}\n\n\t// Ollama\n\n\tasync getOllamaModels(baseUrl?: string) {\n\t\ttry {\n\t\t\tif (!baseUrl) {\n\t\t\t\tbaseUrl = \"http://localhost:11434\"\n\t\t\t}\n\t\t\tif (!URL.canParse(baseUrl)) {\n\t\t\t\treturn []\n\t\t\t}\n\t\t\tconst response = await axios.get(`${baseUrl}/api/tags`)\n\t\t\tconst modelsArray = response.data?.models?.map((model: any) => model.name) || []\n\t\t\tconst models = [...new Set<string>(modelsArray)]\n\t\t\treturn models\n\t\t} catch (error) {\n\t\t\treturn []\n\t\t}\n\t}\n\n\t// LM Studio\n\n\tasync getLmStudioModels(baseUrl?: string) {\n\t\ttry {\n\t\t\tif (!baseUrl) {\n\t\t\t\tbaseUrl = \"http://localhost:1234\"\n\t\t\t}\n\t\t\tif (!URL.canParse(baseUrl)) {\n\t\t\t\treturn []\n\t\t\t}\n\t\t\tconst response = await axios.get(`${baseUrl}/v1/models`)\n\t\t\tconst modelsArray = response.data?.data?.map((model: any) => model.id) || []\n\t\t\tconst models = [...new Set<string>(modelsArray)]\n\t\t\treturn models\n\t\t} catch (error) {\n\t\t\treturn []\n\t\t}\n\t}\n\n\t// OpenRouter\n\n\tasync handleOpenRouterCallback(code: string) {\n\t\tlet apiKey: string\n\t\ttry {\n\t\t\tconst response = await axios.post(\"https://openrouter.ai/api/v1/auth/keys\", { code })\n\t\t\tif (response.data && response.data.key) {\n\t\t\t\tapiKey = response.data.key\n\t\t\t} else {\n\t\t\t\tthrow new Error(\"Invalid response from OpenRouter API\")\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Error exchanging code for API key:\", error)\n\t\t\tthrow error\n\t\t}\n\n\t\tconst openrouter: ApiProvider = \"openrouter\"\n\t\tawait this.updateGlobalState(\"apiProvider\", openrouter)\n\t\tawait this.storeSecret(\"openRouterApiKey\", apiKey)\n\t\tawait this.postStateToWebview()\n\t\tif (this.cline) {\n\t\t\tthis.cline.api = buildApiHandler({ apiProvider: openrouter, openRouterApiKey: apiKey })\n\t\t}\n\t\t// await this.postMessageToWebview({ type: \"action\", action: \"settingsButtonClicked\" }) // bad ux if user is on welcome\n\t}\n\n\tprivate async ensureCacheDirectoryExists(): Promise<string> {\n\t\tconst cacheDir = path.join(this.context.globalStorageUri.fsPath, \"cache\")\n\t\tawait fs.mkdir(cacheDir, { recursive: true })\n\t\treturn cacheDir\n\t}\n\n\tasync readOpenRouterModels(): Promise<Record<string, ModelInfo> | undefined> {\n\t\tconst openRouterModelsFilePath = path.join(\n\t\t\tawait this.ensureCacheDirectoryExists(),\n\t\t\tGlobalFileNames.openRouterModels,\n\t\t)\n\t\tconst fileExists = await fileExistsAtPath(openRouterModelsFilePath)\n\t\tif (fileExists) {\n\t\t\tconst fileContents = await fs.readFile(openRouterModelsFilePath, \"utf8\")\n\t\t\treturn JSON.parse(fileContents)\n\t\t}\n\t\treturn undefined\n\t}\n\n\tasync refreshOpenRouterModels() {\n\t\tconst openRouterModelsFilePath = path.join(\n\t\t\tawait this.ensureCacheDirectoryExists(),\n\t\t\tGlobalFileNames.openRouterModels,\n\t\t)\n\n\t\tlet models: Record<string, ModelInfo> = {}\n\t\ttry {\n\t\t\tconst response = await axios.get(\"https://openrouter.ai/api/v1/models\")\n\t\t\t/*\n\t\t\t{\n\t\t\t\t\"id\": \"anthropic/claude-3.5-sonnet\",\n\t\t\t\t\"name\": \"Anthropic: Claude 3.5 Sonnet\",\n\t\t\t\t\"created\": 1718841600,\n\t\t\t\t\"description\": \"Claude 3.5 Sonnet delivers better-than-Opus capabilities, faster-than-Sonnet speeds, at the same Sonnet prices. Sonnet is particularly good at:\\n\\n- Coding: Autonomously writes, edits, and runs code with reasoning and troubleshooting\\n- Data science: Augments human data science expertise; navigates unstructured data while using multiple tools for insights\\n- Visual processing: excelling at interpreting charts, graphs, and images, accurately transcribing text to derive insights beyond just the text alone\\n- Agentic tasks: exceptional tool use, making it great at agentic tasks (i.e. complex, multi-step problem solving tasks that require engaging with other systems)\\n\\n#multimodal\",\n\t\t\t\t\"context_length\": 200000,\n\t\t\t\t\"architecture\": {\n\t\t\t\t\t\"modality\": \"text+image-\\u003Etext\",\n\t\t\t\t\t\"tokenizer\": \"Claude\",\n\t\t\t\t\t\"instruct_type\": null\n\t\t\t\t},\n\t\t\t\t\"pricing\": {\n\t\t\t\t\t\"prompt\": \"0.000003\",\n\t\t\t\t\t\"completion\": \"0.000015\",\n\t\t\t\t\t\"image\": \"0.0048\",\n\t\t\t\t\t\"request\": \"0\"\n\t\t\t\t},\n\t\t\t\t\"top_provider\": {\n\t\t\t\t\t\"context_length\": 200000,\n\t\t\t\t\t\"max_completion_tokens\": 8192,\n\t\t\t\t\t\"is_moderated\": true\n\t\t\t\t},\n\t\t\t\t\"per_request_limits\": null\n\t\t\t},\n\t\t\t*/\n\t\t\tif (response.data?.data) {\n\t\t\t\tconst rawModels = response.data.data\n\t\t\t\tconst parsePrice = (price: any) => {\n\t\t\t\t\tif (price) {\n\t\t\t\t\t\treturn parseFloat(price) * 1_000_000\n\t\t\t\t\t}\n\t\t\t\t\treturn undefined\n\t\t\t\t}\n\t\t\t\tfor (const rawModel of rawModels) {\n\t\t\t\t\tconst modelInfo: ModelInfo = {\n\t\t\t\t\t\tmaxTokens: rawModel.top_provider?.max_completion_tokens,\n\t\t\t\t\t\tcontextWindow: rawModel.context_length,\n\t\t\t\t\t\tsupportsImages: rawModel.architecture?.modality?.includes(\"image\"),\n\t\t\t\t\t\tsupportsPromptCache: false,\n\t\t\t\t\t\tinputPrice: parsePrice(rawModel.pricing?.prompt),\n\t\t\t\t\t\toutputPrice: parsePrice(rawModel.pricing?.completion),\n\t\t\t\t\t\tdescription: rawModel.description,\n\t\t\t\t\t}\n\n\t\t\t\t\tswitch (rawModel.id) {\n\t\t\t\t\t\tcase \"anthropic/claude-3.5-sonnet\":\n\t\t\t\t\t\tcase \"anthropic/claude-3.5-sonnet:beta\":\n\t\t\t\t\t\t\t// NOTE: this needs to be synced with api.ts/openrouter default model info\n\t\t\t\t\t\t\tmodelInfo.supportsComputerUse = true\n\t\t\t\t\t\t\tmodelInfo.supportsPromptCache = true\n\t\t\t\t\t\t\tmodelInfo.cacheWritesPrice = 3.75\n\t\t\t\t\t\t\tmodelInfo.cacheReadsPrice = 0.3\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"anthropic/claude-3.5-sonnet-20240620\":\n\t\t\t\t\t\tcase \"anthropic/claude-3.5-sonnet-20240620:beta\":\n\t\t\t\t\t\t\tmodelInfo.supportsPromptCache = true\n\t\t\t\t\t\t\tmodelInfo.cacheWritesPrice = 3.75\n\t\t\t\t\t\t\tmodelInfo.cacheReadsPrice = 0.3\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"anthropic/claude-3-5-haiku\":\n\t\t\t\t\t\tcase \"anthropic/claude-3-5-haiku:beta\":\n\t\t\t\t\t\tcase \"anthropic/claude-3-5-haiku-20241022\":\n\t\t\t\t\t\tcase \"anthropic/claude-3-5-haiku-20241022:beta\":\n\t\t\t\t\t\tcase \"anthropic/claude-3.5-haiku\":\n\t\t\t\t\t\tcase \"anthropic/claude-3.5-haiku:beta\":\n\t\t\t\t\t\tcase \"anthropic/claude-3.5-haiku-20241022\":\n\t\t\t\t\t\tcase \"anthropic/claude-3.5-haiku-20241022:beta\":\n\t\t\t\t\t\t\tmodelInfo.supportsPromptCache = true\n\t\t\t\t\t\t\tmodelInfo.cacheWritesPrice = 1.25\n\t\t\t\t\t\t\tmodelInfo.cacheReadsPrice = 0.1\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"anthropic/claude-3-opus\":\n\t\t\t\t\t\tcase \"anthropic/claude-3-opus:beta\":\n\t\t\t\t\t\t\tmodelInfo.supportsPromptCache = true\n\t\t\t\t\t\t\tmodelInfo.cacheWritesPrice = 18.75\n\t\t\t\t\t\t\tmodelInfo.cacheReadsPrice = 1.5\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase \"anthropic/claude-3-haiku\":\n\t\t\t\t\t\tcase \"anthropic/claude-3-haiku:beta\":\n\t\t\t\t\t\t\tmodelInfo.supportsPromptCache = true\n\t\t\t\t\t\t\tmodelInfo.cacheWritesPrice = 0.3\n\t\t\t\t\t\t\tmodelInfo.cacheReadsPrice = 0.03\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\n\t\t\t\t\tmodels[rawModel.id] = modelInfo\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.error(\"Invalid response from OpenRouter API\")\n\t\t\t}\n\t\t\tawait fs.writeFile(openRouterModelsFilePath, JSON.stringify(models))\n\t\t\tconsole.log(\"OpenRouter models fetched and saved\", models)\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Error fetching OpenRouter models:\", error)\n\t\t}\n\n\t\tawait this.postMessageToWebview({ type: \"openRouterModels\", openRouterModels: models })\n\t\treturn models\n\t}\n\n\t// Task history\n\n\tasync getTaskWithId(id: string): Promise<{\n\t\thistoryItem: HistoryItem\n\t\ttaskDirPath: string\n\t\tapiConversationHistoryFilePath: string\n\t\tuiMessagesFilePath: string\n\t\tapiConversationHistory: Anthropic.MessageParam[]\n\t}> {\n\t\tconst history = ((await this.getGlobalState(\"taskHistory\")) as HistoryItem[] | undefined) || []\n\t\tconst historyItem = history.find((item) => item.id === id)\n\t\tif (historyItem) {\n\t\t\tconst taskDirPath = path.join(this.context.globalStorageUri.fsPath, \"tasks\", id)\n\t\t\tconst apiConversationHistoryFilePath = path.join(taskDirPath, GlobalFileNames.apiConversationHistory)\n\t\t\tconst uiMessagesFilePath = path.join(taskDirPath, GlobalFileNames.uiMessages)\n\t\t\tconst fileExists = await fileExistsAtPath(apiConversationHistoryFilePath)\n\t\t\tif (fileExists) {\n\t\t\t\tconst apiConversationHistory = JSON.parse(await fs.readFile(apiConversationHistoryFilePath, \"utf8\"))\n\t\t\t\treturn {\n\t\t\t\t\thistoryItem,\n\t\t\t\t\ttaskDirPath,\n\t\t\t\t\tapiConversationHistoryFilePath,\n\t\t\t\t\tuiMessagesFilePath,\n\t\t\t\t\tapiConversationHistory,\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// if we tried to get a task that doesn't exist, remove it from state\n\t\t// FIXME: this seems to happen sometimes when the json file doesnt save to disk for some reason\n\t\tawait this.deleteTaskFromState(id)\n\t\tthrow new Error(\"Task not found\")\n\t}\n\n\tasync showTaskWithId(id: string) {\n\t\tif (id !== this.cline?.taskId) {\n\t\t\t// non-current task\n\t\t\tconst { historyItem } = await this.getTaskWithId(id)\n\t\t\tawait this.initClineWithHistoryItem(historyItem) // clears existing task\n\t\t}\n\t\tawait this.postMessageToWebview({ type: \"action\", action: \"chatButtonClicked\" })\n\t}\n\n\tasync exportTaskWithId(id: string) {\n\t\tconst { historyItem, apiConversationHistory } = await this.getTaskWithId(id)\n\t\tawait downloadTask(historyItem.ts, apiConversationHistory)\n\t}\n\n\tasync deleteTaskWithId(id: string) {\n\t\tif (id === this.cline?.taskId) {\n\t\t\tawait this.clearTask()\n\t\t}\n\n\t\tconst { taskDirPath, apiConversationHistoryFilePath, uiMessagesFilePath } = await this.getTaskWithId(id)\n\n\t\tawait this.deleteTaskFromState(id)\n\n\t\t// Delete the task files\n\t\tconst apiConversationHistoryFileExists = await fileExistsAtPath(apiConversationHistoryFilePath)\n\t\tif (apiConversationHistoryFileExists) {\n\t\t\tawait fs.unlink(apiConversationHistoryFilePath)\n\t\t}\n\t\tconst uiMessagesFileExists = await fileExistsAtPath(uiMessagesFilePath)\n\t\tif (uiMessagesFileExists) {\n\t\t\tawait fs.unlink(uiMessagesFilePath)\n\t\t}\n\t\tconst legacyMessagesFilePath = path.join(taskDirPath, \"claude_messages.json\")\n\t\tif (await fileExistsAtPath(legacyMessagesFilePath)) {\n\t\t\tawait fs.unlink(legacyMessagesFilePath)\n\t\t}\n\t\tawait fs.rmdir(taskDirPath) // succeeds if the dir is empty\n\t}\n\n\tasync deleteTaskFromState(id: string) {\n\t\t// Remove the task from history\n\t\tconst taskHistory = ((await this.getGlobalState(\"taskHistory\")) as HistoryItem[] | undefined) || []\n\t\tconst updatedTaskHistory = taskHistory.filter((task) => task.id !== id)\n\t\tawait this.updateGlobalState(\"taskHistory\", updatedTaskHistory)\n\n\t\t// Notify the webview that the task has been deleted\n\t\tawait this.postStateToWebview()\n\t}\n\n\tasync postStateToWebview() {\n\t\tconst state = await this.getStateToPostToWebview()\n\t\tthis.postMessageToWebview({ type: \"state\", state })\n\t}\n\n\tasync getStateToPostToWebview() {\n\t\tconst { apiConfiguration, lastShownAnnouncementId, customInstructions, alwaysAllowReadOnly, taskHistory } =\n\t\t\tawait this.getState()\n\t\treturn {\n\t\t\tversion: this.context.extension?.packageJSON?.version ?? \"\",\n\t\t\tapiConfiguration,\n\t\t\tcustomInstructions,\n\t\t\talwaysAllowReadOnly,\n\t\t\turiScheme: vscode.env.uriScheme,\n\t\t\tclineMessages: this.cline?.clineMessages || [],\n\t\t\ttaskHistory: (taskHistory || []).filter((item) => item.ts && item.task).sort((a, b) => b.ts - a.ts),\n\t\t\tshouldShowAnnouncement: lastShownAnnouncementId !== this.latestAnnouncementId,\n\t\t}\n\t}\n\n\tasync clearTask() {\n\t\tthis.cline?.abortTask()\n\t\tthis.cline = undefined // removes reference to it, so once promises end it will be garbage collected\n\t}\n\n\t// Caching mechanism to keep track of webview messages + API conversation history per provider instance\n\n\t/*\n\tNow that we use retainContextWhenHidden, we don't have to store a cache of cline messages in the user's state, but we could to reduce memory footprint in long conversations.\n\n\t- We have to be careful of what state is shared between ClineProvider instances since there could be multiple instances of the extension running at once. For example when we cached cline messages using the same key, two instances of the extension could end up using the same key and overwriting each other's messages.\n\t- Some state does need to be shared between the instances, i.e. the API key--however there doesn't seem to be a good way to notfy the other instances that the API key has changed.\n\n\tWe need to use a unique identifier for each ClineProvider instance's message cache since we could be running several instances of the extension outside of just the sidebar i.e. in editor panels.\n\n\t// conversation history to send in API requests\n\n\t/*\n\tIt seems that some API messages do not comply with vscode state requirements. Either the Anthropic library is manipulating these values somehow in the backend in a way thats creating cyclic references, or the API returns a function or a Symbol as part of the message content.\n\tVSCode docs about state: \"The value must be JSON-stringifyable ... value — A value. MUST not contain cyclic references.\"\n\tFor now we'll store the conversation history in memory, and if we need to store in state directly we'd need to do a manual conversion to ensure proper json stringification.\n\t*/\n\n\t// getApiConversationHistory(): Anthropic.MessageParam[] {\n\t// \t// const history = (await this.getGlobalState(\n\t// \t// \tthis.getApiConversationHistoryStateKey()\n\t// \t// )) as Anthropic.MessageParam[]\n\t// \t// return history || []\n\t// \treturn this.apiConversationHistory\n\t// }\n\n\t// setApiConversationHistory(history: Anthropic.MessageParam[] | undefined) {\n\t// \t// await this.updateGlobalState(this.getApiConversationHistoryStateKey(), history)\n\t// \tthis.apiConversationHistory = history || []\n\t// }\n\n\t// addMessageToApiConversationHistory(message: Anthropic.MessageParam): Anthropic.MessageParam[] {\n\t// \t// const history = await this.getApiConversationHistory()\n\t// \t// history.push(message)\n\t// \t// await this.setApiConversationHistory(history)\n\t// \t// return history\n\t// \tthis.apiConversationHistory.push(message)\n\t// \treturn this.apiConversationHistory\n\t// }\n\n\t/*\n\tStorage\n\thttps://dev.to/kompotkot/how-to-use-secretstorage-in-your-vscode-extensions-2hco\n\thttps://www.eliostruyf.com/devhack-code-extension-storage-options/\n\t*/\n\n\tasync getState() {\n\t\tconst [\n\t\t\tstoredApiProvider,\n\t\t\tapiModelId,\n\t\t\tapiKey,\n\t\t\topenRouterApiKey,\n\t\t\tawsAccessKey,\n\t\t\tawsSecretKey,\n\t\t\tawsSessionToken,\n\t\t\tawsRegion,\n\t\t\tawsUseCrossRegionInference,\n\t\t\tvertexProjectId,\n\t\t\tvertexRegion,\n\t\t\topenAiBaseUrl,\n\t\t\topenAiApiKey,\n\t\t\topenAiModelId,\n\t\t\tollamaModelId,\n\t\t\tollamaBaseUrl,\n\t\t\tlmStudioModelId,\n\t\t\tlmStudioBaseUrl,\n\t\t\tanthropicBaseUrl,\n\t\t\tgeminiApiKey,\n\t\t\topenAiNativeApiKey,\n\t\t\tazureApiVersion,\n\t\t\topenRouterModelId,\n\t\t\topenRouterModelInfo,\n\t\t\tlastShownAnnouncementId,\n\t\t\tcustomInstructions,\n\t\t\talwaysAllowReadOnly,\n\t\t\ttaskHistory,\n\t\t] = await Promise.all([\n\t\t\tthis.getGlobalState(\"apiProvider\") as Promise<ApiProvider | undefined>,\n\t\t\tthis.getGlobalState(\"apiModelId\") as Promise<string | undefined>,\n\t\t\tthis.getSecret(\"apiKey\") as Promise<string | undefined>,\n\t\t\tthis.getSecret(\"openRouterApiKey\") as Promise<string | undefined>,\n\t\t\tthis.getSecret(\"awsAccessKey\") as Promise<string | undefined>,\n\t\t\tthis.getSecret(\"awsSecretKey\") as Promise<string | undefined>,\n\t\t\tthis.getSecret(\"awsSessionToken\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"awsRegion\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"awsUseCrossRegionInference\") as Promise<boolean | undefined>,\n\t\t\tthis.getGlobalState(\"vertexProjectId\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"vertexRegion\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"openAiBaseUrl\") as Promise<string | undefined>,\n\t\t\tthis.getSecret(\"openAiApiKey\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"openAiModelId\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"ollamaModelId\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"ollamaBaseUrl\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"lmStudioModelId\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"lmStudioBaseUrl\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"anthropicBaseUrl\") as Promise<string | undefined>,\n\t\t\tthis.getSecret(\"geminiApiKey\") as Promise<string | undefined>,\n\t\t\tthis.getSecret(\"openAiNativeApiKey\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"azureApiVersion\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"openRouterModelId\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"openRouterModelInfo\") as Promise<ModelInfo | undefined>,\n\t\t\tthis.getGlobalState(\"lastShownAnnouncementId\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"customInstructions\") as Promise<string | undefined>,\n\t\t\tthis.getGlobalState(\"alwaysAllowReadOnly\") as Promise<boolean | undefined>,\n\t\t\tthis.getGlobalState(\"taskHistory\") as Promise<HistoryItem[] | undefined>,\n\t\t])\n\n\t\tlet apiProvider: ApiProvider\n\t\tif (storedApiProvider) {\n\t\t\tapiProvider = storedApiProvider\n\t\t} else {\n\t\t\t// Either new user or legacy user that doesn't have the apiProvider stored in state\n\t\t\t// (If they're using OpenRouter or Bedrock, then apiProvider state will exist)\n\t\t\tif (apiKey) {\n\t\t\t\tapiProvider = \"anthropic\"\n\t\t\t} else {\n\t\t\t\t// New users should default to openrouter\n\t\t\t\tapiProvider = \"openrouter\"\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tapiConfiguration: {\n\t\t\t\tapiProvider,\n\t\t\t\tapiModelId,\n\t\t\t\tapiKey,\n\t\t\t\topenRouterApiKey,\n\t\t\t\tawsAccessKey,\n\t\t\t\tawsSecretKey,\n\t\t\t\tawsSessionToken,\n\t\t\t\tawsRegion,\n\t\t\t\tawsUseCrossRegionInference,\n\t\t\t\tvertexProjectId,\n\t\t\t\tvertexRegion,\n\t\t\t\topenAiBaseUrl,\n\t\t\t\topenAiApiKey,\n\t\t\t\topenAiModelId,\n\t\t\t\tollamaModelId,\n\t\t\t\tollamaBaseUrl,\n\t\t\t\tlmStudioModelId,\n\t\t\t\tlmStudioBaseUrl,\n\t\t\t\tanthropicBaseUrl,\n\t\t\t\tgeminiApiKey,\n\t\t\t\topenAiNativeApiKey,\n\t\t\t\tazureApiVersion,\n\t\t\t\topenRouterModelId,\n\t\t\t\topenRouterModelInfo,\n\t\t\t},\n\t\t\tlastShownAnnouncementId,\n\t\t\tcustomInstructions,\n\t\t\talwaysAllowReadOnly: alwaysAllowReadOnly ?? false,\n\t\t\ttaskHistory,\n\t\t}\n\t}\n\n\tasync updateTaskHistory(item: HistoryItem): Promise<HistoryItem[]> {\n\t\tconst history = ((await this.getGlobalState(\"taskHistory\")) as HistoryItem[]) || []\n\t\tconst existingItemIndex = history.findIndex((h) => h.id === item.id)\n\t\tif (existingItemIndex !== -1) {\n\t\t\thistory[existingItemIndex] = item\n\t\t} else {\n\t\t\thistory.push(item)\n\t\t}\n\t\tawait this.updateGlobalState(\"taskHistory\", history)\n\t\treturn history\n\t}\n\n\t// global\n\n\tasync updateGlobalState(key: GlobalStateKey, value: any) {\n\t\tawait this.context.globalState.update(key, value)\n\t}\n\n\tasync getGlobalState(key: GlobalStateKey) {\n\t\treturn await this.context.globalState.get(key)\n\t}\n\n\t// workspace\n\n\tprivate async updateWorkspaceState(key: string, value: any) {\n\t\tawait this.context.workspaceState.update(key, value)\n\t}\n\n\tprivate async getWorkspaceState(key: string) {\n\t\treturn await this.context.workspaceState.get(key)\n\t}\n\n\t// private async clearState() {\n\t// \tthis.context.workspaceState.keys().forEach((key) => {\n\t// \t\tthis.context.workspaceState.update(key, undefined)\n\t// \t})\n\t// \tthis.context.globalState.keys().forEach((key) => {\n\t// \t\tthis.context.globalState.update(key, undefined)\n\t// \t})\n\t// \tthis.context.secrets.delete(\"apiKey\")\n\t// }\n\n\t// secrets\n\n\tprivate async storeSecret(key: SecretKey, value?: string) {\n\t\tif (value) {\n\t\t\tawait this.context.secrets.store(key, value)\n\t\t} else {\n\t\t\tawait this.context.secrets.delete(key)\n\t\t}\n\t}\n\n\tprivate async getSecret(key: SecretKey) {\n\t\treturn await this.context.secrets.get(key)\n\t}\n\n\t// dev\n\n\tasync resetState() {\n\t\tvscode.window.showInformationMessage(\"Resetting state...\")\n\t\tfor (const key of this.context.globalState.keys()) {\n\t\t\tawait this.context.globalState.update(key, undefined)\n\t\t}\n\t\tconst secretKeys: SecretKey[] = [\n\t\t\t\"apiKey\",\n\t\t\t\"openRouterApiKey\",\n\t\t\t\"awsAccessKey\",\n\t\t\t\"awsSecretKey\",\n\t\t\t\"awsSessionToken\",\n\t\t\t\"openAiApiKey\",\n\t\t\t\"geminiApiKey\",\n\t\t\t\"openAiNativeApiKey\",\n\t\t]\n\t\tfor (const key of secretKeys) {\n\t\t\tawait this.storeSecret(key, undefined)\n\t\t}\n\t\tif (this.cline) {\n\t\t\tthis.cline.abortTask()\n\t\t\tthis.cline = undefined\n\t\t}\n\t\tvscode.window.showInformationMessage(\"State reset\")\n\t\tawait this.postStateToWebview()\n\t\tawait this.postMessageToWebview({ type: \"action\", action: \"chatButtonClicked\" })\n\t}\n}\n", "tag": "", "tokens": 11647, "metadata": {}}], "modify_time": 1733144568.721686}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/webview/getUri.ts", "relative_path": "cline/src/core/webview/getUri.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/webview/getUri.ts", "source_code": "import { Uri, Webview } from \"vscode\"\n/**\n * A helper function which will get the webview URI of a given file or resource.\n *\n * @remarks This URI can be used within a webview's HTML as a link to the\n * given file/resource.\n *\n * @param webview A reference to the extension webview\n * @param extensionUri The URI of the directory containing the extension\n * @param pathList An array of strings representing the path to a file/resource\n * @returns A URI pointing to the file/resource\n */\nexport function getUri(webview: Webview, extensionUri: Uri, pathList: string[]) {\n\treturn webview.asWebviewUri(Uri.joinPath(extensionUri, ...pathList))\n}\n", "tag": "", "tokens": 180, "metadata": {}}], "modify_time": 1733144568.722084}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/assistant-message/index.ts", "relative_path": "cline/src/core/assistant-message/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/assistant-message/index.ts", "source_code": "export type AssistantMessageContent = TextContent | ToolUse\n\nexport { parseAssistantMessage } from \"./parse-assistant-message\"\n\nexport interface TextContent {\n\ttype: \"text\"\n\tcontent: string\n\tpartial: boolean\n}\n\nexport const toolUseNames = [\n\t\"execute_command\",\n\t\"read_file\",\n\t\"write_to_file\",\n\t\"search_files\",\n\t\"list_files\",\n\t\"list_code_definition_names\",\n\t\"browser_action\",\n\t\"ask_followup_question\",\n\t\"attempt_completion\",\n] as const\n\n// Converts array of tool call names into a union type (\"execute_command\" | \"read_file\" | ...)\nexport type ToolUseName = (typeof toolUseNames)[number]\n\nexport const toolParamNames = [\n\t\"command\",\n\t\"path\",\n\t\"content\",\n\t\"regex\",\n\t\"file_pattern\",\n\t\"recursive\",\n\t\"action\",\n\t\"url\",\n\t\"coordinate\",\n\t\"text\",\n\t\"question\",\n\t\"result\",\n] as const\n\nexport type ToolParamName = (typeof toolParamNames)[number]\n\nexport interface ToolUse {\n\ttype: \"tool_use\"\n\tname: ToolUseName\n\t// params is a partial record, allowing only some or none of the possible parameters to be used\n\tparams: Partial<Record<ToolParamName, string>>\n\tpartial: boolean\n}\n\nexport interface ExecuteCommandToolUse extends ToolUse {\n\tname: \"execute_command\"\n\t// Pick<Record<ToolParamName, string>, \"command\"> makes \"command\" required, but Partial<> makes it optional\n\tparams: Partial<Pick<Record<ToolParamName, string>, \"command\">>\n}\n\nexport interface ReadFileToolUse extends ToolUse {\n\tname: \"read_file\"\n\tparams: Partial<Pick<Record<ToolParamName, string>, \"path\">>\n}\n\nexport interface WriteToFileToolUse extends ToolUse {\n\tname: \"write_to_file\"\n\tparams: Partial<Pick<Record<ToolParamName, string>, \"path\" | \"content\">>\n}\n\nexport interface SearchFilesToolUse extends ToolUse {\n\tname: \"search_files\"\n\tparams: Partial<Pick<Record<ToolParamName, string>, \"path\" | \"regex\" | \"file_pattern\">>\n}\n\nexport interface ListFilesToolUse extends ToolUse {\n\tname: \"list_files\"\n\tparams: Partial<Pick<Record<ToolParamName, string>, \"path\" | \"recursive\">>\n}\n\nexport interface ListCodeDefinitionNamesToolUse extends ToolUse {\n\tname: \"list_code_definition_names\"\n\tparams: Partial<Pick<Record<ToolParamName, string>, \"path\">>\n}\n\nexport interface BrowserActionToolUse extends ToolUse {\n\tname: \"browser_action\"\n\tparams: Partial<Pick<Record<ToolParamName, string>, \"action\" | \"url\" | \"coordinate\" | \"text\">>\n}\n\nexport interface AskFollowupQuestionToolUse extends ToolUse {\n\tname: \"ask_followup_question\"\n\tparams: Partial<Pick<Record<ToolParamName, string>, \"question\">>\n}\n\nexport interface AttemptCompletionToolUse extends ToolUse {\n\tname: \"attempt_completion\"\n\tparams: Partial<Pick<Record<ToolParamName, string>, \"result\" | \"command\">>\n}\n", "tag": "", "tokens": 762, "metadata": {}}], "modify_time": 1733144568.7203135}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/assistant-message/parse-assistant-message.ts", "relative_path": "cline/src/core/assistant-message/parse-assistant-message.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/assistant-message/parse-assistant-message.ts", "source_code": "import {\n\tAssistantMessageContent,\n\tTextContent,\n\tToolUse,\n\tToolParamName,\n\ttoolParamNames,\n\ttoolUseNames,\n\tToolUseName,\n} from \".\"\n\nexport function parseAssistantMessage(assistantMessage: string) {\n\tlet contentBlocks: AssistantMessageContent[] = []\n\tlet currentTextContent: TextContent | undefined = undefined\n\tlet currentTextContentStartIndex = 0\n\tlet currentToolUse: ToolUse | undefined = undefined\n\tlet currentToolUseStartIndex = 0\n\tlet currentParamName: ToolParamName | undefined = undefined\n\tlet currentParamValueStartIndex = 0\n\tlet accumulator = \"\"\n\n\tfor (let i = 0; i < assistantMessage.length; i++) {\n\t\tconst char = assistantMessage[i]\n\t\taccumulator += char\n\n\t\t// there should not be a param without a tool use\n\t\tif (currentToolUse && currentParamName) {\n\t\t\tconst currentParamValue = accumulator.slice(currentParamValueStartIndex)\n\t\t\tconst paramClosingTag = `</${currentParamName}>`\n\t\t\tif (currentParamValue.endsWith(paramClosingTag)) {\n\t\t\t\t// end of param value\n\t\t\t\tcurrentToolUse.params[currentParamName] = currentParamValue.slice(0, -paramClosingTag.length).trim()\n\t\t\t\tcurrentParamName = undefined\n\t\t\t\tcontinue\n\t\t\t} else {\n\t\t\t\t// partial param value is accumulating\n\t\t\t\tcontinue\n\t\t\t}\n\t\t}\n\n\t\t// no currentParamName\n\n\t\tif (currentToolUse) {\n\t\t\tconst currentToolValue = accumulator.slice(currentToolUseStartIndex)\n\t\t\tconst toolUseClosingTag = `</${currentToolUse.name}>`\n\t\t\tif (currentToolValue.endsWith(toolUseClosingTag)) {\n\t\t\t\t// end of a tool use\n\t\t\t\tcurrentToolUse.partial = false\n\t\t\t\tcontentBlocks.push(currentToolUse)\n\t\t\t\tcurrentToolUse = undefined\n\t\t\t\tcontinue\n\t\t\t} else {\n\t\t\t\tconst possibleParamOpeningTags = toolParamNames.map((name) => `<${name}>`)\n\t\t\t\tfor (const paramOpeningTag of possibleParamOpeningTags) {\n\t\t\t\t\tif (accumulator.endsWith(paramOpeningTag)) {\n\t\t\t\t\t\t// start of a new parameter\n\t\t\t\t\t\tcurrentParamName = paramOpeningTag.slice(1, -1) as ToolParamName\n\t\t\t\t\t\tcurrentParamValueStartIndex = accumulator.length\n\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// there's no current param, and not starting a new param\n\n\t\t\t\t// special case for write_to_file where file contents could contain the closing tag, in which case the param would have closed and we end up with the rest of the file contents here. To work around this, we get the string between the starting content tag and the LAST content tag.\n\t\t\t\tconst contentParamName: ToolParamName = \"content\"\n\t\t\t\tif (currentToolUse.name === \"write_to_file\" && accumulator.endsWith(`</${contentParamName}>`)) {\n\t\t\t\t\tconst toolContent = accumulator.slice(currentToolUseStartIndex)\n\t\t\t\t\tconst contentStartTag = `<${contentParamName}>`\n\t\t\t\t\tconst contentEndTag = `</${contentParamName}>`\n\t\t\t\t\tconst contentStartIndex = toolContent.indexOf(contentStartTag) + contentStartTag.length\n\t\t\t\t\tconst contentEndIndex = toolContent.lastIndexOf(contentEndTag)\n\t\t\t\t\tif (contentStartIndex !== -1 && contentEndIndex !== -1 && contentEndIndex > contentStartIndex) {\n\t\t\t\t\t\tcurrentToolUse.params[contentParamName] = toolContent\n\t\t\t\t\t\t\t.slice(contentStartIndex, contentEndIndex)\n\t\t\t\t\t\t\t.trim()\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// partial tool value is accumulating\n\t\t\t\tcontinue\n\t\t\t}\n\t\t}\n\n\t\t// no currentToolUse\n\n\t\tlet didStartToolUse = false\n\t\tconst possibleToolUseOpeningTags = toolUseNames.map((name) => `<${name}>`)\n\t\tfor (const toolUseOpeningTag of possibleToolUseOpeningTags) {\n\t\t\tif (accumulator.endsWith(toolUseOpeningTag)) {\n\t\t\t\t// start of a new tool use\n\t\t\t\tcurrentToolUse = {\n\t\t\t\t\ttype: \"tool_use\",\n\t\t\t\t\tname: toolUseOpeningTag.slice(1, -1) as ToolUseName,\n\t\t\t\t\tparams: {},\n\t\t\t\t\tpartial: true,\n\t\t\t\t}\n\t\t\t\tcurrentToolUseStartIndex = accumulator.length\n\t\t\t\t// this also indicates the end of the current text content\n\t\t\t\tif (currentTextContent) {\n\t\t\t\t\tcurrentTextContent.partial = false\n\t\t\t\t\t// remove the partially accumulated tool use tag from the end of text (<tool)\n\t\t\t\t\tcurrentTextContent.content = currentTextContent.content\n\t\t\t\t\t\t.slice(0, -toolUseOpeningTag.slice(0, -1).length)\n\t\t\t\t\t\t.trim()\n\t\t\t\t\tcontentBlocks.push(currentTextContent)\n\t\t\t\t\tcurrentTextContent = undefined\n\t\t\t\t}\n\n\t\t\t\tdidStartToolUse = true\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\n\t\tif (!didStartToolUse) {\n\t\t\t// no tool use, so it must be text either at the beginning or between tools\n\t\t\tif (currentTextContent === undefined) {\n\t\t\t\tcurrentTextContentStartIndex = i\n\t\t\t}\n\t\t\tcurrentTextContent = {\n\t\t\t\ttype: \"text\",\n\t\t\t\tcontent: accumulator.slice(currentTextContentStartIndex).trim(),\n\t\t\t\tpartial: true,\n\t\t\t}\n\t\t}\n\t}\n\n\tif (currentToolUse) {\n\t\t// stream did not complete tool call, add it as partial\n\t\tif (currentParamName) {\n\t\t\t// tool call has a parameter that was not completed\n\t\t\tcurrentToolUse.params[currentParamName] = accumulator.slice(currentParamValueStartIndex).trim()\n\t\t}\n\t\tcontentBlocks.push(currentToolUse)\n\t}\n\n\t// Note: it doesnt matter if check for currentToolUse or currentTextContent, only one of them will be defined since only one can be partial at a time\n\tif (currentTextContent) {\n\t\t// stream did not complete text content, add it as partial\n\t\tcontentBlocks.push(currentTextContent)\n\t}\n\n\treturn contentBlocks\n}\n", "tag": "", "tokens": 1389, "metadata": {}}], "modify_time": 1733144568.7204661}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/mentions/index.ts", "relative_path": "cline/src/core/mentions/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/mentions/index.ts", "source_code": "import * as vscode from \"vscode\"\nimport * as path from \"path\"\nimport { openFile } from \"../../integrations/misc/open-file\"\nimport { UrlContentFetcher } from \"../../services/browser/UrlContentFetcher\"\nimport { mentionRegexGlobal } from \"../../shared/context-mentions\"\nimport fs from \"fs/promises\"\nimport { extractTextFromFile } from \"../../integrations/misc/extract-text\"\nimport { isBinaryFile } from \"isbinaryfile\"\nimport { diagnosticsToProblemsString } from \"../../integrations/diagnostics\"\n\nexport function openMention(mention?: string): void {\n\tif (!mention) {\n\t\treturn\n\t}\n\n\tif (mention.startsWith(\"/\")) {\n\t\tconst relPath = mention.slice(1)\n\t\tconst cwd = vscode.workspace.workspaceFolders?.map((folder) => folder.uri.fsPath).at(0)\n\t\tif (!cwd) {\n\t\t\treturn\n\t\t}\n\t\tconst absPath = path.resolve(cwd, relPath)\n\t\tif (mention.endsWith(\"/\")) {\n\t\t\tvscode.commands.executeCommand(\"revealInExplorer\", vscode.Uri.file(absPath))\n\t\t\t// vscode.commands.executeCommand(\"vscode.openFolder\", , { forceNewWindow: false }) opens in new window\n\t\t} else {\n\t\t\topenFile(absPath)\n\t\t}\n\t} else if (mention === \"problems\") {\n\t\tvscode.commands.executeCommand(\"workbench.actions.view.problems\")\n\t} else if (mention.startsWith(\"http\")) {\n\t\tvscode.env.openExternal(vscode.Uri.parse(mention))\n\t}\n}\n\nexport async function parseMentions(text: string, cwd: string, urlContentFetcher: UrlContentFetcher): Promise<string> {\n\tconst mentions: Set<string> = new Set()\n\tlet parsedText = text.replace(mentionRegexGlobal, (match, mention) => {\n\t\tmentions.add(mention)\n\t\tif (mention.startsWith(\"http\")) {\n\t\t\treturn `'${mention}' (see below for site content)`\n\t\t} else if (mention.startsWith(\"/\")) {\n\t\t\tconst mentionPath = mention.slice(1) // Remove the leading '/'\n\t\t\treturn mentionPath.endsWith(\"/\")\n\t\t\t\t? `'${mentionPath}' (see below for folder content)`\n\t\t\t\t: `'${mentionPath}' (see below for file content)`\n\t\t} else if (mention === \"problems\") {\n\t\t\treturn `Workspace Problems (see below for diagnostics)`\n\t\t}\n\t\treturn match\n\t})\n\n\tconst urlMention = Array.from(mentions).find((mention) => mention.startsWith(\"http\"))\n\tlet launchBrowserError: Error | undefined\n\tif (urlMention) {\n\t\ttry {\n\t\t\tawait urlContentFetcher.launchBrowser()\n\t\t} catch (error) {\n\t\t\tlaunchBrowserError = error\n\t\t\tvscode.window.showErrorMessage(`Error fetching content for ${urlMention}: ${error.message}`)\n\t\t}\n\t}\n\n\tfor (const mention of mentions) {\n\t\tif (mention.startsWith(\"http\")) {\n\t\t\tlet result: string\n\t\t\tif (launchBrowserError) {\n\t\t\t\tresult = `Error fetching content: ${launchBrowserError.message}`\n\t\t\t} else {\n\t\t\t\ttry {\n\t\t\t\t\tconst markdown = await urlContentFetcher.urlToMarkdown(mention)\n\t\t\t\t\tresult = markdown\n\t\t\t\t} catch (error) {\n\t\t\t\t\tvscode.window.showErrorMessage(`Error fetching content for ${mention}: ${error.message}`)\n\t\t\t\t\tresult = `Error fetching content: ${error.message}`\n\t\t\t\t}\n\t\t\t}\n\t\t\tparsedText += `\\n\\n<url_content url=\"${mention}\">\\n${result}\\n</url_content>`\n\t\t} else if (mention.startsWith(\"/\")) {\n\t\t\tconst mentionPath = mention.slice(1)\n\t\t\ttry {\n\t\t\t\tconst content = await getFileOrFolderContent(mentionPath, cwd)\n\t\t\t\tif (mention.endsWith(\"/\")) {\n\t\t\t\t\tparsedText += `\\n\\n<folder_content path=\"${mentionPath}\">\\n${content}\\n</folder_content>`\n\t\t\t\t} else {\n\t\t\t\t\tparsedText += `\\n\\n<file_content path=\"${mentionPath}\">\\n${content}\\n</file_content>`\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tif (mention.endsWith(\"/\")) {\n\t\t\t\t\tparsedText += `\\n\\n<folder_content path=\"${mentionPath}\">\\nError fetching content: ${error.message}\\n</folder_content>`\n\t\t\t\t} else {\n\t\t\t\t\tparsedText += `\\n\\n<file_content path=\"${mentionPath}\">\\nError fetching content: ${error.message}\\n</file_content>`\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (mention === \"problems\") {\n\t\t\ttry {\n\t\t\t\tconst problems = getWorkspaceProblems(cwd)\n\t\t\t\tparsedText += `\\n\\n<workspace_diagnostics>\\n${problems}\\n</workspace_diagnostics>`\n\t\t\t} catch (error) {\n\t\t\t\tparsedText += `\\n\\n<workspace_diagnostics>\\nError fetching diagnostics: ${error.message}\\n</workspace_diagnostics>`\n\t\t\t}\n\t\t}\n\t}\n\n\tif (urlMention) {\n\t\ttry {\n\t\t\tawait urlContentFetcher.closeBrowser()\n\t\t} catch (error) {\n\t\t\tconsole.error(`Error closing browser: ${error.message}`)\n\t\t}\n\t}\n\n\treturn parsedText\n}\n\nasync function getFileOrFolderContent(mentionPath: string, cwd: string): Promise<string> {\n\tconst absPath = path.resolve(cwd, mentionPath)\n\n\ttry {\n\t\tconst stats = await fs.stat(absPath)\n\n\t\tif (stats.isFile()) {\n\t\t\tconst isBinary = await isBinaryFile(absPath).catch(() => false)\n\t\t\tif (isBinary) {\n\t\t\t\treturn \"(Binary file, unable to display content)\"\n\t\t\t}\n\t\t\tconst content = await extractTextFromFile(absPath)\n\t\t\treturn content\n\t\t} else if (stats.isDirectory()) {\n\t\t\tconst entries = await fs.readdir(absPath, { withFileTypes: true })\n\t\t\tlet folderContent = \"\"\n\t\t\tconst fileContentPromises: Promise<string | undefined>[] = []\n\t\t\tentries.forEach((entry, index) => {\n\t\t\t\tconst isLast = index === entries.length - 1\n\t\t\t\tconst linePrefix = isLast ? \"└── \" : \"├── \"\n\t\t\t\tif (entry.isFile()) {\n\t\t\t\t\tfolderContent += `${linePrefix}${entry.name}\\n`\n\t\t\t\t\tconst filePath = path.join(mentionPath, entry.name)\n\t\t\t\t\tconst absoluteFilePath = path.resolve(absPath, entry.name)\n\t\t\t\t\t// const relativeFilePath = path.relative(cwd, absoluteFilePath);\n\t\t\t\t\tfileContentPromises.push(\n\t\t\t\t\t\t(async () => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst isBinary = await isBinaryFile(absoluteFilePath).catch(() => false)\n\t\t\t\t\t\t\t\tif (isBinary) {\n\t\t\t\t\t\t\t\t\treturn undefined\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tconst content = await extractTextFromFile(absoluteFilePath)\n\t\t\t\t\t\t\t\treturn `<file_content path=\"${filePath.toPosix()}\">\\n${content}\\n</file_content>`\n\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\treturn undefined\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})(),\n\t\t\t\t\t)\n\t\t\t\t} else if (entry.isDirectory()) {\n\t\t\t\t\tfolderContent += `${linePrefix}${entry.name}/\\n`\n\t\t\t\t\t// not recursively getting folder contents\n\t\t\t\t} else {\n\t\t\t\t\tfolderContent += `${linePrefix}${entry.name}\\n`\n\t\t\t\t}\n\t\t\t})\n\t\t\tconst fileContents = (await Promise.all(fileContentPromises)).filter((content) => content)\n\t\t\treturn `${folderContent}\\n${fileContents.join(\"\\n\\n\")}`.trim()\n\t\t} else {\n\t\t\treturn `(Failed to read contents of ${mentionPath})`\n\t\t}\n\t} catch (error) {\n\t\tthrow new Error(`Failed to access path \"${mentionPath}\": ${error.message}`)\n\t}\n}\n\nfunction getWorkspaceProblems(cwd: string): string {\n\tconst diagnostics = vscode.languages.getDiagnostics()\n\tconst result = diagnosticsToProblemsString(\n\t\tdiagnostics,\n\t\t[vscode.DiagnosticSeverity.Error, vscode.DiagnosticSeverity.Warning],\n\t\tcwd,\n\t)\n\tif (!result) {\n\t\treturn \"No errors or warnings detected.\"\n\t}\n\treturn result\n}\n", "tag": "", "tokens": 1924, "metadata": {}}], "modify_time": 1733144568.7206712}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/prompts/system.ts", "relative_path": "cline/src/core/prompts/system.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/prompts/system.ts", "source_code": "import osName from \"os-name\"\nimport defaultShell from \"default-shell\"\nimport os from \"os\"\n\nexport const SYSTEM_PROMPT = async (\n\tcwd: string,\n\tsupportsComputerUse: boolean,\n) => `You are Cline, a highly skilled software engineer with extensive knowledge in many programming languages, frameworks, design patterns, and best practices.\n\n====\n\nTOOL USE\n\nYou have access to a set of tools that are executed upon the user's approval. You can use one tool per message, and will receive the result of that tool use in the user's response. You use tools step-by-step to accomplish a given task, with each tool use informed by the result of the previous tool use.\n\n# Tool Use Formatting\n\nTool use is formatted using XML-style tags. The tool name is enclosed in opening and closing tags, and each parameter is similarly enclosed within its own set of tags. Here's the structure:\n\n<tool_name>\n<parameter1_name>value1</parameter1_name>\n<parameter2_name>value2</parameter2_name>\n...\n</tool_name>\n\nFor example:\n\n<read_file>\n<path>src/main.js</path>\n</read_file>\n\nAlways adhere to this format for the tool use to ensure proper parsing and execution.\n\n# Tools\n\n## execute_command\nDescription: Request to execute a CLI command on the system. Use this when you need to perform system operations or run specific commands to accomplish any step in the user's task. You must tailor your command to the user's system and provide a clear explanation of what the command does. Prefer to execute complex CLI commands over creating executable scripts, as they are more flexible and easier to run. Commands will be executed in the current working directory: ${cwd.toPosix()}\nParameters:\n- command: (required) The CLI command to execute. This should be valid for the current operating system. Ensure the command is properly formatted and does not contain any harmful instructions.\nUsage:\n<execute_command>\n<command>Your command here</command>\n</execute_command>\n\n## read_file\nDescription: Request to read the contents of a file at the specified path. Use this when you need to examine the contents of an existing file you do not know the contents of, for example to analyze code, review text files, or extract information from configuration files. Automatically extracts raw text from PDF and DOCX files. May not be suitable for other types of binary files, as it returns the raw content as a string.\nParameters:\n- path: (required) The path of the file to read (relative to the current working directory ${cwd.toPosix()})\nUsage:\n<read_file>\n<path>File path here</path>\n</read_file>\n\n## write_to_file\nDescription: Request to write content to a file at the specified path. If the file exists, it will be overwritten with the provided content. If the file doesn't exist, it will be created. This tool will automatically create any directories needed to write the file.\nParameters:\n- path: (required) The path of the file to write to (relative to the current working directory ${cwd.toPosix()})\n- content: (required) The content to write to the file. ALWAYS provide the COMPLETE intended content of the file, without any truncation or omissions. You MUST include ALL parts of the file, even if they haven't been modified.\nUsage:\n<write_to_file>\n<path>File path here</path>\n<content>\nYour file content here\n</content>\n</write_to_file>\n\n## search_files\nDescription: Request to perform a regex search across files in a specified directory, providing context-rich results. This tool searches for patterns or specific content across multiple files, displaying each match with encapsulating context.\nParameters:\n- path: (required) The path of the directory to search in (relative to the current working directory ${cwd.toPosix()}). This directory will be recursively searched.\n- regex: (required) The regular expression pattern to search for. Uses Rust regex syntax.\n- file_pattern: (optional) Glob pattern to filter files (e.g., '*.ts' for TypeScript files). If not provided, it will search all files (*).\nUsage:\n<search_files>\n<path>Directory path here</path>\n<regex>Your regex pattern here</regex>\n<file_pattern>file pattern here (optional)</file_pattern>\n</search_files>\n\n## list_files\nDescription: Request to list files and directories within the specified directory. If recursive is true, it will list all files and directories recursively. If recursive is false or not provided, it will only list the top-level contents. Do not use this tool to confirm the existence of files you may have created, as the user will let you know if the files were created successfully or not.\nParameters:\n- path: (required) The path of the directory to list contents for (relative to the current working directory ${cwd.toPosix()})\n- recursive: (optional) Whether to list files recursively. Use true for recursive listing, false or omit for top-level only.\nUsage:\n<list_files>\n<path>Directory path here</path>\n<recursive>true or false (optional)</recursive>\n</list_files>\n\n## list_code_definition_names\nDescription: Request to list definition names (classes, functions, methods, etc.) used in source code files at the top level of the specified directory. This tool provides insights into the codebase structure and important constructs, encapsulating high-level concepts and relationships that are crucial for understanding the overall architecture.\nParameters:\n- path: (required) The path of the directory (relative to the current working directory ${cwd.toPosix()}) to list top level source code definitions for.\nUsage:\n<list_code_definition_names>\n<path>Directory path here</path>\n</list_code_definition_names>${\n\tsupportsComputerUse\n\t\t? `\n\n## browser_action\nDescription: Request to interact with a Puppeteer-controlled browser. Every action, except \\`close\\`, will be responded to with a screenshot of the browser's current state, along with any new console logs. You may only perform one browser action per message, and wait for the user's response including a screenshot and logs to determine the next action.\n- The sequence of actions **must always start with** launching the browser at a URL, and **must always end with** closing the browser. If you need to visit a new URL that is not possible to navigate to from the current webpage, you must first close the browser, then launch again at the new URL.\n- While the browser is active, only the \\`browser_action\\` tool can be used. No other tools should be called during this time. You may proceed to use other tools only after closing the browser. For example if you run into an error and need to fix a file, you must close the browser, then use other tools to make the necessary changes, then re-launch the browser to verify the result.\n- The browser window has a resolution of **900x600** pixels. When performing any click actions, ensure the coordinates are within this resolution range.\n- Before clicking on any elements such as icons, links, or buttons, you must consult the provided screenshot of the page to determine the coordinates of the element. The click should be targeted at the **center of the element**, not on its edges.\nParameters:\n- action: (required) The action to perform. The available actions are:\n    * launch: Launch a new Puppeteer-controlled browser instance at the specified URL. This **must always be the first action**.\n        - Use with the \\`url\\` parameter to provide the URL.\n        - Ensure the URL is valid and includes the appropriate protocol (e.g. http://localhost:3000/page, file:///path/to/file.html, etc.)\n    * click: Click at a specific x,y coordinate.\n        - Use with the \\`coordinate\\` parameter to specify the location.\n        - Always click in the center of an element (icon, button, link, etc.) based on coordinates derived from a screenshot.\n    * type: Type a string of text on the keyboard. You might use this after clicking on a text field to input text.\n        - Use with the \\`text\\` parameter to provide the string to type.\n    * scroll_down: Scroll down the page by one page height.\n    * scroll_up: Scroll up the page by one page height.\n    * close: Close the Puppeteer-controlled browser instance. This **must always be the final browser action**.\n        - Example: \\`<action>close</action>\\`\n- url: (optional) Use this for providing the URL for the \\`launch\\` action.\n    * Example: <url>https://example.com</url>\n- coordinate: (optional) The X and Y coordinates for the \\`click\\` action. Coordinates should be within the **900x600** resolution.\n    * Example: <coordinate>450,300</coordinate>\n- text: (optional) Use this for providing the text for the \\`type\\` action.\n    * Example: <text>Hello, world!</text>\nUsage:\n<browser_action>\n<action>Action to perform (e.g., launch, click, type, scroll_down, scroll_up, close)</action>\n<url>URL to launch the browser at (optional)</url>\n<coordinate>x,y coordinates (optional)</coordinate>\n<text>Text to type (optional)</text>\n</browser_action>`\n\t\t: \"\"\n}\n\n## ask_followup_question\nDescription: Ask the user a question to gather additional information needed to complete the task. This tool should be used when you encounter ambiguities, need clarification, or require more details to proceed effectively. It allows for interactive problem-solving by enabling direct communication with the user. Use this tool judiciously to maintain a balance between gathering necessary information and avoiding excessive back-and-forth.\nParameters:\n- question: (required) The question to ask the user. This should be a clear, specific question that addresses the information you need.\nUsage:\n<ask_followup_question>\n<question>Your question here</question>\n</ask_followup_question>\n\n## attempt_completion\nDescription: After each tool use, the user will respond with the result of that tool use, i.e. if it succeeded or failed, along with any reasons for failure. Once you've received the results of tool uses and can confirm that the task is complete, use this tool to present the result of your work to the user. Optionally you may provide a CLI command to showcase the result of your work. The user may respond with feedback if they are not satisfied with the result, which you can use to make improvements and try again.\nIMPORTANT NOTE: This tool CANNOT be used until you've confirmed from the user that any previous tool uses were successful. Failure to do so will result in code corruption and system failure. Before using this tool, you must ask yourself in <thinking></thinking> tags if you've confirmed from the user that any previous tool uses were successful. If not, then DO NOT use this tool.\nParameters:\n- result: (required) The result of the task. Formulate this result in a way that is final and does not require further input from the user. Don't end your result with questions or offers for further assistance.\n- command: (optional) A CLI command to execute to show a live demo of the result to the user. For example, use \\`open index.html\\` to display a created html website, or \\`open localhost:3000\\` to display a locally running development server. But DO NOT use commands like \\`echo\\` or \\`cat\\` that merely print text. This command should be valid for the current operating system. Ensure the command is properly formatted and does not contain any harmful instructions.\nUsage:\n<attempt_completion>\n<result>\nYour final result description here\n</result>\n<command>Command to demonstrate result (optional)</command>\n</attempt_completion>\n\n# Tool Use Examples\n\n## Example 1: Requesting to execute a command\n\n<execute_command>\n<command>npm run dev</command>\n</execute_command>\n\n## Example 2: Requesting to write to a file\n\n<write_to_file>\n<path>frontend-config.json</path>\n<content>\n{\n  \"apiEndpoint\": \"https://api.example.com\",\n  \"theme\": {\n    \"primaryColor\": \"#007bff\",\n    \"secondaryColor\": \"#6c757d\",\n    \"fontFamily\": \"Arial, sans-serif\"\n  },\n  \"features\": {\n    \"darkMode\": true,\n    \"notifications\": true,\n    \"analytics\": false\n  },\n  \"version\": \"1.0.0\"\n}\n</content>\n</write_to_file>\n\n# Tool Use Guidelines\n\n1. In <thinking> tags, assess what information you already have and what information you need to proceed with the task.\n2. Choose the most appropriate tool based on the task and the tool descriptions provided. Assess if you need additional information to proceed, and which of the available tools would be most effective for gathering this information. For example using the list_files tool is more effective than running a command like \\`ls\\` in the terminal. It's critical that you think about each available tool and use the one that best fits the current step in the task.\n3. If multiple actions are needed, use one tool at a time per message to accomplish the task iteratively, with each tool use being informed by the result of the previous tool use. Do not assume the outcome of any tool use. Each step must be informed by the previous step's result.\n4. Formulate your tool use using the XML format specified for each tool.\n5. After each tool use, the user will respond with the result of that tool use. This result will provide you with the necessary information to continue your task or make further decisions. This response may include:\n  - Information about whether the tool succeeded or failed, along with any reasons for failure.\n  - Linter errors that may have arisen due to the changes you made, which you'll need to address.\n  - New terminal output in reaction to the changes, which you may need to consider or act upon.\n  - Any other relevant feedback or information related to the tool use.\n6. ALWAYS wait for user confirmation after each tool use before proceeding. Never assume the success of a tool use without explicit confirmation of the result from the user.\n\nIt is crucial to proceed step-by-step, waiting for the user's message after each tool use before moving forward with the task. This approach allows you to:\n1. Confirm the success of each step before proceeding.\n2. Address any issues or errors that arise immediately.\n3. Adapt your approach based on new information or unexpected results.\n4. Ensure that each action builds correctly on the previous ones.\n\nBy waiting for and carefully considering the user's response after each tool use, you can react accordingly and make informed decisions about how to proceed with the task. This iterative process helps ensure the overall success and accuracy of your work.\n\n====\n \nCAPABILITIES\n\n- You have access to tools that let you execute CLI commands on the user's computer, list files, view source code definitions, regex search${\n\tsupportsComputerUse ? \", use the browser\" : \"\"\n}, read and write files, and ask follow-up questions. These tools help you effectively accomplish a wide range of tasks, such as writing code, making edits or improvements to existing files, understanding the current state of a project, performing system operations, and much more.\n- When the user initially gives you a task, a recursive list of all filepaths in the current working directory ('${cwd.toPosix()}') will be included in environment_details. This provides an overview of the project's file structure, offering key insights into the project from directory/file names (how developers conceptualize and organize their code) and file extensions (the language used). This can also guide decision-making on which files to explore further. If you need to further explore directories such as outside the current working directory, you can use the list_files tool. If you pass 'true' for the recursive parameter, it will list files recursively. Otherwise, it will list files at the top level, which is better suited for generic directories where you don't necessarily need the nested structure, like the Desktop.\n- You can use search_files to perform regex searches across files in a specified directory, outputting context-rich results that include surrounding lines. This is particularly useful for understanding code patterns, finding specific implementations, or identifying areas that need refactoring.\n- You can use the list_code_definition_names tool to get an overview of source code definitions for all files at the top level of a specified directory. This can be particularly useful when you need to understand the broader context and relationships between certain parts of the code. You may need to call this tool multiple times to understand various parts of the codebase related to the task.\n\t- For example, when asked to make edits or improvements you might analyze the file structure in the initial environment_details to get an overview of the project, then use list_code_definition_names to get further insight using source code definitions for files located in relevant directories, then read_file to examine the contents of relevant files, analyze the code and suggest improvements or make necessary edits, then use the write_to_file tool to implement changes. If you refactored code that could affect other parts of the codebase, you could use search_files to ensure you update other files as needed.\n- You can use the execute_command tool to run commands on the user's computer whenever you feel it can help accomplish the user's task. When you need to execute a CLI command, you must provide a clear explanation of what the command does. Prefer to execute complex CLI commands over creating executable scripts, since they are more flexible and easier to run. Interactive and long-running commands are allowed, since the commands are run in the user's VSCode terminal. The user may keep commands running in the background and you will be kept updated on their status along the way. Each command you execute is run in a new terminal instance.${\n\tsupportsComputerUse\n\t\t? \"\\n- You can use the browser_action tool to interact with websites (including html files and locally running development servers) through a Puppeteer-controlled browser when you feel it is necessary in accomplishing the user's task. This tool is particularly useful for web development tasks as it allows you to launch a browser, navigate to pages, interact with elements through clicks and keyboard input, and capture the results through screenshots and console logs. This tool may be useful at key stages of web development tasks-such as after implementing new features, making substantial changes, when troubleshooting issues, or to verify the result of your work. You can analyze the provided screenshots to ensure correct rendering or identify errors, and review console logs for runtime issues.\\n\t- For example, if asked to add a component to a react website, you might create the necessary files, use execute_command to run the site locally, then use browser_action to launch the browser, navigate to the local server, and verify the component renders & functions correctly before closing the browser.\"\n\t\t: \"\"\n}\n\n====\n\nRULES\n\n- Your current working directory is: ${cwd.toPosix()}\n- You cannot \\`cd\\` into a different directory to complete a task. You are stuck operating from '${cwd.toPosix()}', so be sure to pass in the correct 'path' parameter when using tools that require a path.\n- Do not use the ~ character or $HOME to refer to the home directory.\n- Before using the execute_command tool, you must first think about the SYSTEM INFORMATION context provided to understand the user's environment and tailor your commands to ensure they are compatible with their system. You must also consider if the command you need to run should be executed in a specific directory outside of the current working directory '${cwd.toPosix()}', and if so prepend with \\`cd\\`'ing into that directory && then executing the command (as one command since you are stuck operating from '${cwd.toPosix()}'). For example, if you needed to run \\`npm install\\` in a project outside of '${cwd.toPosix()}', you would need to prepend with a \\`cd\\` i.e. pseudocode for this would be \\`cd (path to project) && (command, in this case npm install)\\`.\n- When using the search_files tool, craft your regex patterns carefully to balance specificity and flexibility. Based on the user's task you may use it to find code patterns, TODO comments, function definitions, or any text-based information across the project. The results include context, so analyze the surrounding code to better understand the matches. Leverage the search_files tool in combination with other tools for more comprehensive analysis. For example, use it to find specific code patterns, then use read_file to examine the full context of interesting matches before using write_to_file to make informed changes.\n- When creating a new project (such as an app, website, or any software project), organize all new files within a dedicated project directory unless the user specifies otherwise. Use appropriate file paths when writing files, as the write_to_file tool will automatically create any necessary directories. Structure the project logically, adhering to best practices for the specific type of project being created. Unless otherwise specified, new projects should be easily run without additional setup, for example most projects can be built in HTML, CSS, and JavaScript - which you can open in a browser.\n- Be sure to consider the type of project (e.g. Python, JavaScript, web application) when determining the appropriate structure and files to include. Also consider what files may be most relevant to accomplishing the task, for example looking at a project's manifest file would help you understand the project's dependencies, which you could incorporate into any code you write.\n- When making changes to code, always consider the context in which the code is being used. Ensure that your changes are compatible with the existing codebase and that they follow the project's coding standards and best practices.\n- When you want to modify a file, use the write_to_file tool directly with the desired content. You do not need to display the content before using the tool.\n- Do not ask for more information than necessary. Use the tools provided to accomplish the user's request efficiently and effectively. When you've completed your task, you must use the attempt_completion tool to present the result to the user. The user may provide feedback, which you can use to make improvements and try again.\n- You are only allowed to ask the user questions using the ask_followup_question tool. Use this tool only when you need additional details to complete a task, and be sure to use a clear and concise question that will help you move forward with the task. However if you can use the available tools to avoid having to ask the user questions, you should do so. For example, if the user mentions a file that may be in an outside directory like the Desktop, you should use the list_files tool to list the files in the Desktop and check if the file they are talking about is there, rather than asking the user to provide the file path themselves.\n- When executing commands, if you don't see the expected output, assume the terminal executed the command successfully and proceed with the task. The user's terminal may be unable to stream the output back properly. If you absolutely need to see the actual terminal output, use the ask_followup_question tool to request the user to copy and paste it back to you.\n- The user may provide a file's contents directly in their message, in which case you shouldn't use the read_file tool to get the file contents again since you already have it.\n- Your goal is to try to accomplish the user's task, NOT engage in a back and forth conversation.${\n\tsupportsComputerUse\n\t\t? '\\n- The user may ask generic non-development tasks, such as \"what\\'s the latest news\" or \"look up the weather in San Diego\", in which case you might use the browser_action tool to complete the task if it makes sense to do so, rather than trying to create a website or using curl to answer the question.'\n\t\t: \"\"\n}\n- NEVER end attempt_completion result with a question or request to engage in further conversation! Formulate the end of your result in a way that is final and does not require further input from the user.\n- You are STRICTLY FORBIDDEN from starting your messages with \"Great\", \"Certainly\", \"Okay\", \"Sure\". You should NOT be conversational in your responses, but rather direct and to the point. For example you should NOT say \"Great, I've updated the CSS\" but instead something like \"I've updated the CSS\". It is important you be clear and technical in your messages.\n- When presented with images, utilize your vision capabilities to thoroughly examine them and extract meaningful information. Incorporate these insights into your thought process as you accomplish the user's task.\n- At the end of each user message, you will automatically receive environment_details. This information is not written by the user themselves, but is auto-generated to provide potentially relevant context about the project structure and environment. While this information can be valuable for understanding the project context, do not treat it as a direct part of the user's request or response. Use it to inform your actions and decisions, but don't assume the user is explicitly asking about or referring to this information unless they clearly do so in their message. When using environment_details, explain your actions clearly to ensure the user understands, as they may not be aware of these details.\n- Before executing commands, check the \"Actively Running Terminals\" section in environment_details. If present, consider how these active processes might impact your task. For example, if a local development server is already running, you wouldn't need to start it again. If no active terminals are listed, proceed with command execution as normal.\n- When using the write_to_file tool, ALWAYS provide the COMPLETE file content in your response. This is NON-NEGOTIABLE. Partial updates or placeholders like '// rest of code unchanged' are STRICTLY FORBIDDEN. You MUST include ALL parts of the file, even if they haven't been modified. Failure to do so will result in incomplete or broken code, severely impacting the user's project.\n- It is critical you wait for the user's response after each tool use, in order to confirm the success of the tool use. For example, if asked to make a todo app, you would create a file, wait for the user's response it was created successfully, then create another file if needed, wait for the user's response it was created successfully, etc.${\n\tsupportsComputerUse\n\t\t? \" Then if you want to test your work, you might use browser_action to launch the site, wait for the user's response confirming the site was launched along with a screenshot, then perhaps e.g., click a button to test functionality if needed, wait for the user's response confirming the button was clicked along with a screenshot of the new state, before finally closing the browser.\"\n\t\t: \"\"\n}\n\n====\n\nSYSTEM INFORMATION\n\nOperating System: ${osName()}\nDefault Shell: ${defaultShell}\nHome Directory: ${os.homedir().toPosix()}\nCurrent Working Directory: ${cwd.toPosix()}\n\n====\n\nOBJECTIVE\n\nYou accomplish a given task iteratively, breaking it down into clear steps and working through them methodically.\n\n1. Analyze the user's task and set clear, achievable goals to accomplish it. Prioritize these goals in a logical order.\n2. Work through these goals sequentially, utilizing available tools one at a time as necessary. Each goal should correspond to a distinct step in your problem-solving process. You will be informed on the work completed and what's remaining as you go.\n3. Remember, you have extensive capabilities with access to a wide range of tools that can be used in powerful and clever ways as necessary to accomplish each goal. Before calling a tool, do some analysis within <thinking></thinking> tags. First, analyze the file structure provided in environment_details to gain context and insights for proceeding effectively. Then, think about which of the provided tools is the most relevant tool to accomplish the user's task. Next, go through each of the required parameters of the relevant tool and determine if the user has directly provided or given enough information to infer a value. When deciding if the parameter can be inferred, carefully consider all the context to see if it supports a specific value. If all of the required parameters are present or can be reasonably inferred, close the thinking tag and proceed with the tool use. BUT, if one of the values for a required parameter is missing, DO NOT invoke the tool (not even with fillers for the missing params) and instead, ask the user to provide the missing parameters using the ask_followup_question tool. DO NOT ask for more information on optional parameters if it is not provided.\n4. Once you've completed the user's task, you must use the attempt_completion tool to present the result of the task to the user. You may also provide a CLI command to showcase the result of your task; this can be particularly useful for web development tasks, where you can run e.g. \\`open index.html\\` to show the website you've built.\n5. The user may provide feedback, which you can use to make improvements and try again. But DO NOT continue in pointless back and forth conversations, i.e. don't end your responses with questions or offers for further assistance.`\n\nexport function addCustomInstructions(customInstructions: string): string {\n\treturn `\n====\n\nUSER'S CUSTOM INSTRUCTIONS\n\nThe following additional instructions are provided by the user, and should be followed to the best of your ability without interfering with the TOOL USE guidelines.\n\n${customInstructions.trim()}`\n}\n", "tag": "", "tokens": 6609, "metadata": {}}], "modify_time": 1733144568.7211063}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/prompts/responses.ts", "relative_path": "cline/src/core/prompts/responses.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/core/prompts/responses.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport * as path from \"path\"\nimport * as diff from \"diff\"\n\nexport const formatResponse = {\n\ttoolDenied: () => `The user denied this operation.`,\n\n\ttoolDeniedWithFeedback: (feedback?: string) =>\n\t\t`The user denied this operation and provided the following feedback:\\n<feedback>\\n${feedback}\\n</feedback>`,\n\n\ttoolError: (error?: string) => `The tool execution failed with the following error:\\n<error>\\n${error}\\n</error>`,\n\n\tnoToolsUsed: () =>\n\t\t`[ERROR] You did not use a tool in your previous response! Please retry with a tool use.\n\n${toolUseInstructionsReminder}\n\n# Next Steps\n\nIf you have completed the user's task, use the attempt_completion tool. \nIf you require additional information from the user, use the ask_followup_question tool. \nOtherwise, if you have not completed the task and do not need additional information, then proceed with the next step of the task. \n(This is an automated message, so do not respond to it conversationally.)`,\n\n\ttooManyMistakes: (feedback?: string) =>\n\t\t`You seem to be having trouble proceeding. The user has provided the following feedback to help guide you:\\n<feedback>\\n${feedback}\\n</feedback>`,\n\n\tmissingToolParameterError: (paramName: string) =>\n\t\t`Missing value for required parameter '${paramName}'. Please retry with complete response.\\n\\n${toolUseInstructionsReminder}`,\n\n\ttoolResult: (\n\t\ttext: string,\n\t\timages?: string[],\n\t): string | Array<Anthropic.TextBlockParam | Anthropic.ImageBlockParam> => {\n\t\tif (images && images.length > 0) {\n\t\t\tconst textBlock: Anthropic.TextBlockParam = { type: \"text\", text }\n\t\t\tconst imageBlocks: Anthropic.ImageBlockParam[] = formatImagesIntoBlocks(images)\n\t\t\t// Placing images after text leads to better results\n\t\t\treturn [textBlock, ...imageBlocks]\n\t\t} else {\n\t\t\treturn text\n\t\t}\n\t},\n\n\timageBlocks: (images?: string[]): Anthropic.ImageBlockParam[] => {\n\t\treturn formatImagesIntoBlocks(images)\n\t},\n\n\tformatFilesList: (absolutePath: string, files: string[], didHitLimit: boolean): string => {\n\t\tconst sorted = files\n\t\t\t.map((file) => {\n\t\t\t\t// convert absolute path to relative path\n\t\t\t\tconst relativePath = path.relative(absolutePath, file).toPosix()\n\t\t\t\treturn file.endsWith(\"/\") ? relativePath + \"/\" : relativePath\n\t\t\t})\n\t\t\t// Sort so files are listed under their respective directories to make it clear what files are children of what directories. Since we build file list top down, even if file list is truncated it will show directories that cline can then explore further.\n\t\t\t.sort((a, b) => {\n\t\t\t\tconst aParts = a.split(\"/\") // only works if we use toPosix first\n\t\t\t\tconst bParts = b.split(\"/\")\n\t\t\t\tfor (let i = 0; i < Math.min(aParts.length, bParts.length); i++) {\n\t\t\t\t\tif (aParts[i] !== bParts[i]) {\n\t\t\t\t\t\t// If one is a directory and the other isn't at this level, sort the directory first\n\t\t\t\t\t\tif (i + 1 === aParts.length && i + 1 < bParts.length) {\n\t\t\t\t\t\t\treturn -1\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (i + 1 === bParts.length && i + 1 < aParts.length) {\n\t\t\t\t\t\t\treturn 1\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Otherwise, sort alphabetically\n\t\t\t\t\t\treturn aParts[i].localeCompare(bParts[i], undefined, { numeric: true, sensitivity: \"base\" })\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// If all parts are the same up to the length of the shorter path,\n\t\t\t\t// the shorter one comes first\n\t\t\t\treturn aParts.length - bParts.length\n\t\t\t})\n\t\tif (didHitLimit) {\n\t\t\treturn `${sorted.join(\n\t\t\t\t\"\\n\",\n\t\t\t)}\\n\\n(File list truncated. Use list_files on specific subdirectories if you need to explore further.)`\n\t\t} else if (sorted.length === 0 || (sorted.length === 1 && sorted[0] === \"\")) {\n\t\t\treturn \"No files found.\"\n\t\t} else {\n\t\t\treturn sorted.join(\"\\n\")\n\t\t}\n\t},\n\n\tcreatePrettyPatch: (filename = \"file\", oldStr?: string, newStr?: string) => {\n\t\t// strings cannot be undefined or diff throws exception\n\t\tconst patch = diff.createPatch(filename.toPosix(), oldStr || \"\", newStr || \"\")\n\t\tconst lines = patch.split(\"\\n\")\n\t\tconst prettyPatchLines = lines.slice(4)\n\t\treturn prettyPatchLines.join(\"\\n\")\n\t},\n}\n\n// to avoid circular dependency\nconst formatImagesIntoBlocks = (images?: string[]): Anthropic.ImageBlockParam[] => {\n\treturn images\n\t\t? images.map((dataUrl) => {\n\t\t\t\t// data:image/png;base64,base64string\n\t\t\t\tconst [rest, base64] = dataUrl.split(\",\")\n\t\t\t\tconst mimeType = rest.split(\":\")[1].split(\";\")[0]\n\t\t\t\treturn {\n\t\t\t\t\ttype: \"image\",\n\t\t\t\t\tsource: { type: \"base64\", media_type: mimeType, data: base64 },\n\t\t\t\t} as Anthropic.ImageBlockParam\n\t\t\t})\n\t\t: []\n}\n\nconst toolUseInstructionsReminder = `# Reminder: Instructions for Tool Use\n\nTool uses are formatted using XML-style tags. The tool name is enclosed in opening and closing tags, and each parameter is similarly enclosed within its own set of tags. Here's the structure:\n\n<tool_name>\n<parameter1_name>value1</parameter1_name>\n<parameter2_name>value2</parameter2_name>\n...\n</tool_name>\n\nFor example:\n\n<attempt_completion>\n<result>\nI have completed the task...\n</result>\n</attempt_completion>\n\nAlways adhere to this format for all tool uses to ensure proper parsing and execution.`\n", "tag": "", "tokens": 1458, "metadata": {}}], "modify_time": 1733144568.7208679}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/test/extension.test.ts", "relative_path": "cline/src/test/extension.test.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/test/extension.test.ts", "source_code": "import * as assert from \"assert\"\n\n// You can import and use all API from the 'vscode' module\n// as well as import your extension to test it\nimport * as vscode from \"vscode\"\n// import * as myExtension from '../../extension';\n\nsuite(\"Extension Test Suite\", () => {\n\tvscode.window.showInformationMessage(\"Start all tests.\")\n\n\ttest(\"Sample test\", () => {\n\t\tassert.strictEqual(-1, [1, 2, 3].indexOf(5))\n\t\tassert.strictEqual(-1, [1, 2, 3].indexOf(0))\n\t})\n})\n", "tag": "", "tokens": 148, "metadata": {}}], "modify_time": 1733144568.7308888}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/utils/path.ts", "relative_path": "cline/src/utils/path.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/utils/path.ts", "source_code": "import * as path from \"path\"\nimport os from \"os\"\n\n/*\nThe Node.js 'path' module resolves and normalizes paths differently depending on the platform:\n- On Windows, it uses backslashes (\\) as the default path separator.\n- On POSIX-compliant systems (Linux, macOS), it uses forward slashes (/) as the default path separator.\n\nWhile modules like 'upath' can be used to normalize paths to use forward slashes consistently,\nthis can create inconsistencies when interfacing with other modules (like vscode.fs) that use\nbackslashes on Windows.\n\nOur approach:\n1. We present paths with forward slashes to the AI and user for consistency.\n2. We use the 'arePathsEqual' function for safe path comparisons.\n3. Internally, Node.js gracefully handles both backslashes and forward slashes.\n\nThis strategy ensures consistent path presentation while leveraging Node.js's built-in\npath handling capabilities across different platforms.\n\nNote: When interacting with the file system or VS Code APIs, we still use the native path module\nto ensure correct behavior on all platforms. The toPosixPath and arePathsEqual functions are\nprimarily used for presentation and comparison purposes, not for actual file system operations.\n\nObservations:\n- Macos isn't so flexible with mixed separators, whereas windows can handle both. (\"Node.js does automatically handle path separators on Windows, converting forward slashes to backslashes as needed. However, on macOS and other Unix-like systems, the path separator is always a forward slash (/), and backslashes are treated as regular characters.\")\n*/\n\nfunction toPosixPath(p: string) {\n\t// Extended-Length Paths in Windows start with \"\\\\?\\\" to allow longer paths and bypass usual parsing. If detected, we return the path unmodified to maintain functionality, as altering these paths could break their special syntax.\n\tconst isExtendedLengthPath = p.startsWith(\"\\\\\\\\?\\\\\")\n\n\tif (isExtendedLengthPath) {\n\t\treturn p\n\t}\n\n\treturn p.replace(/\\\\/g, \"/\")\n}\n\n// Declaration merging allows us to add a new method to the String type\n// You must import this file in your entry point (extension.ts) to have access at runtime\ndeclare global {\n\tinterface String {\n\t\ttoPosix(): string\n\t}\n}\n\nString.prototype.toPosix = function (this: string): string {\n\treturn toPosixPath(this)\n}\n\n// Safe path comparison that works across different platforms\nexport function arePathsEqual(path1?: string, path2?: string): boolean {\n\tif (!path1 && !path2) {\n\t\treturn true\n\t}\n\tif (!path1 || !path2) {\n\t\treturn false\n\t}\n\n\tpath1 = normalizePath(path1)\n\tpath2 = normalizePath(path2)\n\n\tif (process.platform === \"win32\") {\n\t\treturn path1.toLowerCase() === path2.toLowerCase()\n\t}\n\treturn path1 === path2\n}\n\nfunction normalizePath(p: string): string {\n\t// normalize resolve ./.. segments, removes duplicate slashes, and standardizes path separators\n\tlet normalized = path.normalize(p)\n\t// however it doesn't remove trailing slashes\n\t// remove trailing slash, except for root paths\n\tif (normalized.length > 1 && (normalized.endsWith(\"/\") || normalized.endsWith(\"\\\\\"))) {\n\t\tnormalized = normalized.slice(0, -1)\n\t}\n\treturn normalized\n}\n\nexport function getReadablePath(cwd: string, relPath?: string): string {\n\trelPath = relPath || \"\"\n\t// path.resolve is flexible in that it will resolve relative paths like '../../' to the cwd and even ignore the cwd if the relPath is actually an absolute path\n\tconst absolutePath = path.resolve(cwd, relPath)\n\tif (arePathsEqual(cwd, path.join(os.homedir(), \"Desktop\"))) {\n\t\t// User opened vscode without a workspace, so cwd is the Desktop. Show the full absolute path to keep the user aware of where files are being created\n\t\treturn absolutePath.toPosix()\n\t}\n\tif (arePathsEqual(path.normalize(absolutePath), path.normalize(cwd))) {\n\t\treturn path.basename(absolutePath).toPosix()\n\t} else {\n\t\t// show the relative path to the cwd\n\t\tconst normalizedRelPath = path.relative(cwd, absolutePath)\n\t\tif (absolutePath.includes(cwd)) {\n\t\t\treturn normalizedRelPath.toPosix()\n\t\t} else {\n\t\t\t// we are outside the cwd, so show the absolute path (useful for when cline passes in '../../' for example)\n\t\t\treturn absolutePath.toPosix()\n\t\t}\n\t}\n}\n", "tag": "", "tokens": 1074, "metadata": {}}], "modify_time": 1733144568.7312734}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/utils/cost.ts", "relative_path": "cline/src/utils/cost.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/utils/cost.ts", "source_code": "import { ModelInfo } from \"../shared/api\"\n\nexport function calculateApiCost(\n\tmodelInfo: ModelInfo,\n\tinputTokens: number,\n\toutputTokens: number,\n\tcacheCreationInputTokens?: number,\n\tcacheReadInputTokens?: number,\n): number {\n\tconst modelCacheWritesPrice = modelInfo.cacheWritesPrice\n\tlet cacheWritesCost = 0\n\tif (cacheCreationInputTokens && modelCacheWritesPrice) {\n\t\tcacheWritesCost = (modelCacheWritesPrice / 1_000_000) * cacheCreationInputTokens\n\t}\n\tconst modelCacheReadsPrice = modelInfo.cacheReadsPrice\n\tlet cacheReadsCost = 0\n\tif (cacheReadInputTokens && modelCacheReadsPrice) {\n\t\tcacheReadsCost = (modelCacheReadsPrice / 1_000_000) * cacheReadInputTokens\n\t}\n\tconst baseInputCost = ((modelInfo.inputPrice || 0) / 1_000_000) * inputTokens\n\tconst outputCost = ((modelInfo.outputPrice || 0) / 1_000_000) * outputTokens\n\tconst totalCost = cacheWritesCost + cacheReadsCost + baseInputCost + outputCost\n\treturn totalCost\n}\n", "tag": "", "tokens": 302, "metadata": {}}], "modify_time": 1733144568.7310562}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/utils/fs.ts", "relative_path": "cline/src/utils/fs.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/utils/fs.ts", "source_code": "import fs from \"fs/promises\"\nimport * as path from \"path\"\n\n/**\n * Asynchronously creates all non-existing subdirectories for a given file path\n * and collects them in an array for later deletion.\n *\n * @param filePath - The full path to a file.\n * @returns A promise that resolves to an array of newly created directories.\n */\nexport async function createDirectoriesForFile(filePath: string): Promise<string[]> {\n\tconst newDirectories: string[] = []\n\tconst normalizedFilePath = path.normalize(filePath) // Normalize path for cross-platform compatibility\n\tconst directoryPath = path.dirname(normalizedFilePath)\n\n\tlet currentPath = directoryPath\n\tconst dirsToCreate: string[] = []\n\n\t// Traverse up the directory tree and collect missing directories\n\twhile (!(await fileExistsAtPath(currentPath))) {\n\t\tdirsToCreate.push(currentPath)\n\t\tcurrentPath = path.dirname(currentPath)\n\t}\n\n\t// Create directories from the topmost missing one down to the target directory\n\tfor (let i = dirsToCreate.length - 1; i >= 0; i--) {\n\t\tawait fs.mkdir(dirsToCreate[i])\n\t\tnewDirectories.push(dirsToCreate[i])\n\t}\n\n\treturn newDirectories\n}\n\n/**\n * Helper function to check if a path exists.\n *\n * @param path - The path to check.\n * @returns A promise that resolves to true if the path exists, false otherwise.\n */\nexport async function fileExistsAtPath(filePath: string): Promise<boolean> {\n\ttry {\n\t\tawait fs.access(filePath)\n\t\treturn true\n\t} catch {\n\t\treturn false\n\t}\n}\n", "tag": "", "tokens": 389, "metadata": {}}], "modify_time": 1733144568.7311616}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/WebviewMessage.ts", "relative_path": "cline/src/shared/WebviewMessage.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/WebviewMessage.ts", "source_code": "import { ApiConfiguration, ApiProvider } from \"./api\"\n\nexport interface WebviewMessage {\n\ttype:\n\t\t| \"apiConfiguration\"\n\t\t| \"customInstructions\"\n\t\t| \"alwaysAllowReadOnly\"\n\t\t| \"webviewDidLaunch\"\n\t\t| \"newTask\"\n\t\t| \"askResponse\"\n\t\t| \"clearTask\"\n\t\t| \"didShowAnnouncement\"\n\t\t| \"selectImages\"\n\t\t| \"exportCurrentTask\"\n\t\t| \"showTaskWithId\"\n\t\t| \"deleteTaskWithId\"\n\t\t| \"exportTaskWithId\"\n\t\t| \"resetState\"\n\t\t| \"requestOllamaModels\"\n\t\t| \"requestLmStudioModels\"\n\t\t| \"openImage\"\n\t\t| \"openFile\"\n\t\t| \"openMention\"\n\t\t| \"cancelTask\"\n\t\t| \"refreshOpenRouterModels\"\n\ttext?: string\n\taskResponse?: ClineAskResponse\n\tapiConfiguration?: ApiConfiguration\n\timages?: string[]\n\tbool?: boolean\n}\n\nexport type ClineAskResponse = \"yesButtonClicked\" | \"noButtonClicked\" | \"messageResponse\"\n", "tag": "", "tokens": 257, "metadata": {}}], "modify_time": 1733144568.729847}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/ExtensionMessage.ts", "relative_path": "cline/src/shared/ExtensionMessage.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/ExtensionMessage.ts", "source_code": "// type that represents json data that is sent from extension to webview, called ExtensionMessage and has 'type' enum which can be 'plusButtonClicked' or 'settingsButtonClicked' or 'hello'\n\nimport { ApiConfiguration, ModelInfo } from \"./api\"\nimport { HistoryItem } from \"./HistoryItem\"\n\n// webview will hold state\nexport interface ExtensionMessage {\n\ttype:\n\t\t| \"action\"\n\t\t| \"state\"\n\t\t| \"selectedImages\"\n\t\t| \"ollamaModels\"\n\t\t| \"lmStudioModels\"\n\t\t| \"theme\"\n\t\t| \"workspaceUpdated\"\n\t\t| \"invoke\"\n\t\t| \"partialMessage\"\n\t\t| \"openRouterModels\"\n\ttext?: string\n\taction?: \"chatButtonClicked\" | \"settingsButtonClicked\" | \"historyButtonClicked\" | \"didBecomeVisible\"\n\tinvoke?: \"sendMessage\" | \"primaryButtonClick\" | \"secondaryButtonClick\"\n\tstate?: ExtensionState\n\timages?: string[]\n\tollamaModels?: string[]\n\tlmStudioModels?: string[]\n\tfilePaths?: string[]\n\tpartialMessage?: ClineMessage\n\topenRouterModels?: Record<string, ModelInfo>\n}\n\nexport interface ExtensionState {\n\tversion: string\n\tapiConfiguration?: ApiConfiguration\n\tcustomInstructions?: string\n\talwaysAllowReadOnly?: boolean\n\turiScheme?: string\n\tclineMessages: ClineMessage[]\n\ttaskHistory: HistoryItem[]\n\tshouldShowAnnouncement: boolean\n}\n\nexport interface ClineMessage {\n\tts: number\n\ttype: \"ask\" | \"say\"\n\task?: ClineAsk\n\tsay?: ClineSay\n\ttext?: string\n\timages?: string[]\n\tpartial?: boolean\n}\n\nexport type ClineAsk =\n\t| \"followup\"\n\t| \"command\"\n\t| \"command_output\"\n\t| \"completion_result\"\n\t| \"tool\"\n\t| \"api_req_failed\"\n\t| \"resume_task\"\n\t| \"resume_completed_task\"\n\t| \"mistake_limit_reached\"\n\t| \"browser_action_launch\"\n\nexport type ClineSay =\n\t| \"task\"\n\t| \"error\"\n\t| \"api_req_started\"\n\t| \"api_req_finished\"\n\t| \"text\"\n\t| \"completion_result\"\n\t| \"user_feedback\"\n\t| \"user_feedback_diff\"\n\t| \"api_req_retried\"\n\t| \"command_output\"\n\t| \"tool\"\n\t| \"shell_integration_warning\"\n\t| \"browser_action\"\n\t| \"browser_action_result\"\n\nexport interface ClineSayTool {\n\ttool:\n\t\t| \"editedExistingFile\"\n\t\t| \"newFileCreated\"\n\t\t| \"readFile\"\n\t\t| \"listFilesTopLevel\"\n\t\t| \"listFilesRecursive\"\n\t\t| \"listCodeDefinitionNames\"\n\t\t| \"searchFiles\"\n\tpath?: string\n\tdiff?: string\n\tcontent?: string\n\tregex?: string\n\tfilePattern?: string\n}\n\n// must keep in sync with system prompt\nexport const browserActions = [\"launch\", \"click\", \"type\", \"scroll_down\", \"scroll_up\", \"close\"] as const\nexport type BrowserAction = (typeof browserActions)[number]\n\nexport interface ClineSayBrowserAction {\n\taction: BrowserAction\n\tcoordinate?: string\n\ttext?: string\n}\n\nexport type BrowserActionResult = {\n\tscreenshot?: string\n\tlogs?: string\n\tcurrentUrl?: string\n\tcurrentMousePosition?: string\n}\n\nexport interface ClineApiReqInfo {\n\trequest?: string\n\ttokensIn?: number\n\ttokensOut?: number\n\tcacheWrites?: number\n\tcacheReads?: number\n\tcost?: number\n\tcancelReason?: ClineApiReqCancelReason\n\tstreamingFailedMessage?: string\n}\n\nexport type ClineApiReqCancelReason = \"streaming_failed\" | \"user_cancelled\"\n", "tag": "", "tokens": 878, "metadata": {}}], "modify_time": 1733144568.7295854}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/array.ts", "relative_path": "cline/src/shared/array.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/array.ts", "source_code": "/**\n * Returns the index of the last element in the array where predicate is true, and -1\n * otherwise.\n * @param array The source array to search in\n * @param predicate find calls predicate once for each element of the array, in descending\n * order, until it finds one where predicate returns true. If such an element is found,\n * findLastIndex immediately returns that element index. Otherwise, findLastIndex returns -1.\n */\nexport function findLastIndex<T>(array: Array<T>, predicate: (value: T, index: number, obj: T[]) => boolean): number {\n\tlet l = array.length\n\twhile (l--) {\n\t\tif (predicate(array[l], l, array)) {\n\t\t\treturn l\n\t\t}\n\t}\n\treturn -1\n}\n\nexport function findLast<T>(array: Array<T>, predicate: (value: T, index: number, obj: T[]) => boolean): T | undefined {\n\tconst index = findLastIndex(array, predicate)\n\treturn index === -1 ? undefined : array[index]\n}\n", "tag": "", "tokens": 247, "metadata": {}}], "modify_time": 1733144568.7301152}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/getApiMetrics.ts", "relative_path": "cline/src/shared/getApiMetrics.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/getApiMetrics.ts", "source_code": "import { ClineMessage } from \"./ExtensionMessage\"\n\ninterface ApiMetrics {\n\ttotalTokensIn: number\n\ttotalTokensOut: number\n\ttotalCacheWrites?: number\n\ttotalCacheReads?: number\n\ttotalCost: number\n}\n\n/**\n * Calculates API metrics from an array of ClineMessages.\n *\n * This function processes 'api_req_started' messages that have been combined with their\n * corresponding 'api_req_finished' messages by the combineApiRequests function.\n * It extracts and sums up the tokensIn, tokensOut, cacheWrites, cacheReads, and cost from these messages.\n *\n * @param messages - An array of ClineMessage objects to process.\n * @returns An ApiMetrics object containing totalTokensIn, totalTokensOut, totalCacheWrites, totalCacheReads, and totalCost.\n *\n * @example\n * const messages = [\n *   { type: \"say\", say: \"api_req_started\", text: '{\"request\":\"GET /api/data\",\"tokensIn\":10,\"tokensOut\":20,\"cost\":0.005}', ts: 1000 }\n * ];\n * const { totalTokensIn, totalTokensOut, totalCost } = getApiMetrics(messages);\n * // Result: { totalTokensIn: 10, totalTokensOut: 20, totalCost: 0.005 }\n */\nexport function getApiMetrics(messages: ClineMessage[]): ApiMetrics {\n\tconst result: ApiMetrics = {\n\t\ttotalTokensIn: 0,\n\t\ttotalTokensOut: 0,\n\t\ttotalCacheWrites: undefined,\n\t\ttotalCacheReads: undefined,\n\t\ttotalCost: 0,\n\t}\n\n\tmessages.forEach((message) => {\n\t\tif (message.type === \"say\" && message.say === \"api_req_started\" && message.text) {\n\t\t\ttry {\n\t\t\t\tconst parsedData = JSON.parse(message.text)\n\t\t\t\tconst { tokensIn, tokensOut, cacheWrites, cacheReads, cost } = parsedData\n\n\t\t\t\tif (typeof tokensIn === \"number\") {\n\t\t\t\t\tresult.totalTokensIn += tokensIn\n\t\t\t\t}\n\t\t\t\tif (typeof tokensOut === \"number\") {\n\t\t\t\t\tresult.totalTokensOut += tokensOut\n\t\t\t\t}\n\t\t\t\tif (typeof cacheWrites === \"number\") {\n\t\t\t\t\tresult.totalCacheWrites = (result.totalCacheWrites ?? 0) + cacheWrites\n\t\t\t\t}\n\t\t\t\tif (typeof cacheReads === \"number\") {\n\t\t\t\t\tresult.totalCacheReads = (result.totalCacheReads ?? 0) + cacheReads\n\t\t\t\t}\n\t\t\t\tif (typeof cost === \"number\") {\n\t\t\t\t\tresult.totalCost += cost\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\"Error parsing JSON:\", error)\n\t\t\t}\n\t\t}\n\t})\n\n\treturn result\n}\n", "tag": "", "tokens": 670, "metadata": {}}], "modify_time": 1733144568.7307434}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/HistoryItem.ts", "relative_path": "cline/src/shared/HistoryItem.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/HistoryItem.ts", "source_code": "export type HistoryItem = {\n\tid: string\n\tts: number\n\ttask: string\n\ttokensIn: number\n\ttokensOut: number\n\tcacheWrites?: number\n\tcacheReads?: number\n\ttotalCost: number\n}\n", "tag": "", "tokens": 65, "metadata": {}}], "modify_time": 1733144568.7296827}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/api.ts", "relative_path": "cline/src/shared/api.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/api.ts", "source_code": "export type ApiProvider =\n\t| \"anthropic\"\n\t| \"openrouter\"\n\t| \"bedrock\"\n\t| \"vertex\"\n\t| \"openai\"\n\t| \"ollama\"\n\t| \"lmstudio\"\n\t| \"gemini\"\n\t| \"openai-native\"\n\nexport interface ApiHandlerOptions {\n\tapiModelId?: string\n\tapiKey?: string // anthropic\n\tanthropicBaseUrl?: string\n\topenRouterApiKey?: string\n\topenRouterModelId?: string\n\topenRouterModelInfo?: ModelInfo\n\tawsAccessKey?: string\n\tawsSecretKey?: string\n\tawsSessionToken?: string\n\tawsRegion?: string\n\tawsUseCrossRegionInference?: boolean\n\tvertexProjectId?: string\n\tvertexRegion?: string\n\topenAiBaseUrl?: string\n\topenAiApiKey?: string\n\topenAiModelId?: string\n\tollamaModelId?: string\n\tollamaBaseUrl?: string\n\tlmStudioModelId?: string\n\tlmStudioBaseUrl?: string\n\tgeminiApiKey?: string\n\topenAiNativeApiKey?: string\n\tazureApiVersion?: string\n}\n\nexport type ApiConfiguration = ApiHandlerOptions & {\n\tapiProvider?: ApiProvider\n}\n\n// Models\n\nexport interface ModelInfo {\n\tmaxTokens?: number\n\tcontextWindow?: number\n\tsupportsImages?: boolean\n\tsupportsComputerUse?: boolean\n\tsupportsPromptCache: boolean // this value is hardcoded for now\n\tinputPrice?: number\n\toutputPrice?: number\n\tcacheWritesPrice?: number\n\tcacheReadsPrice?: number\n\tdescription?: string\n}\n\n// Anthropic\n// https://docs.anthropic.com/en/docs/about-claude/models\nexport type AnthropicModelId = keyof typeof anthropicModels\nexport const anthropicDefaultModelId: AnthropicModelId = \"claude-3-5-sonnet-20241022\"\nexport const anthropicModels = {\n\t\"claude-3-5-sonnet-20241022\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsComputerUse: true,\n\t\tsupportsPromptCache: true,\n\t\tinputPrice: 3.0, // $3 per million input tokens\n\t\toutputPrice: 15.0, // $15 per million output tokens\n\t\tcacheWritesPrice: 3.75, // $3.75 per million tokens\n\t\tcacheReadsPrice: 0.3, // $0.30 per million tokens\n\t},\n\t\"claude-3-5-haiku-20241022\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: false,\n\t\tsupportsPromptCache: true,\n\t\tinputPrice: 1.0,\n\t\toutputPrice: 5.0,\n\t\tcacheWritesPrice: 1.25,\n\t\tcacheReadsPrice: 0.1,\n\t},\n\t\"claude-3-opus-20240229\": {\n\t\tmaxTokens: 4096,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: true,\n\t\tinputPrice: 15.0,\n\t\toutputPrice: 75.0,\n\t\tcacheWritesPrice: 18.75,\n\t\tcacheReadsPrice: 1.5,\n\t},\n\t\"claude-3-haiku-20240307\": {\n\t\tmaxTokens: 4096,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: true,\n\t\tinputPrice: 0.25,\n\t\toutputPrice: 1.25,\n\t\tcacheWritesPrice: 0.3,\n\t\tcacheReadsPrice: 0.03,\n\t},\n} as const satisfies Record<string, ModelInfo> // as const assertion makes the object deeply readonly\n\n// AWS Bedrock\n// https://docs.aws.amazon.com/bedrock/latest/userguide/conversation-inference.html\nexport type BedrockModelId = keyof typeof bedrockModels\nexport const bedrockDefaultModelId: BedrockModelId = \"anthropic.claude-3-5-sonnet-20241022-v2:0\"\nexport const bedrockModels = {\n\t\"anthropic.claude-3-5-sonnet-20241022-v2:0\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsComputerUse: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 3.0,\n\t\toutputPrice: 15.0,\n\t},\n\t\"anthropic.claude-3-5-haiku-20241022-v1:0\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: false,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 1.0,\n\t\toutputPrice: 5.0,\n\t},\n\t\"anthropic.claude-3-5-sonnet-20240620-v1:0\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 3.0,\n\t\toutputPrice: 15.0,\n\t},\n\t\"anthropic.claude-3-opus-20240229-v1:0\": {\n\t\tmaxTokens: 4096,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 15.0,\n\t\toutputPrice: 75.0,\n\t},\n\t\"anthropic.claude-3-sonnet-20240229-v1:0\": {\n\t\tmaxTokens: 4096,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 3.0,\n\t\toutputPrice: 15.0,\n\t},\n\t\"anthropic.claude-3-haiku-20240307-v1:0\": {\n\t\tmaxTokens: 4096,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 0.25,\n\t\toutputPrice: 1.25,\n\t},\n} as const satisfies Record<string, ModelInfo>\n\n// OpenRouter\n// https://openrouter.ai/models?order=newest&supported_parameters=tools\nexport const openRouterDefaultModelId = \"anthropic/claude-3.5-sonnet:beta\" // will always exist in openRouterModels\nexport const openRouterDefaultModelInfo: ModelInfo = {\n\tmaxTokens: 8192,\n\tcontextWindow: 200_000,\n\tsupportsImages: true,\n\tsupportsComputerUse: true,\n\tsupportsPromptCache: true,\n\tinputPrice: 3.0,\n\toutputPrice: 15.0,\n\tcacheWritesPrice: 3.75,\n\tcacheReadsPrice: 0.3,\n\tdescription:\n\t\t\"The new Claude 3.5 Sonnet delivers better-than-Opus capabilities, faster-than-Sonnet speeds, at the same Sonnet prices. Sonnet is particularly good at:\\n\\n- Coding: New Sonnet scores ~49% on SWE-Bench Verified, higher than the last best score, and without any fancy prompt scaffolding\\n- Data science: Augments human data science expertise; navigates unstructured data while using multiple tools for insights\\n- Visual processing: excelling at interpreting charts, graphs, and images, accurately transcribing text to derive insights beyond just the text alone\\n- Agentic tasks: exceptional tool use, making it great at agentic tasks (i.e. complex, multi-step problem solving tasks that require engaging with other systems)\\n\\n#multimodal\\n\\n_This is a faster endpoint, made available in collaboration with Anthropic, that is self-moderated: response moderation happens on the provider's side instead of OpenRouter's. For requests that pass moderation, it's identical to the [Standard](/anthropic/claude-3.5-sonnet) variant._\",\n}\n\n// Vertex AI\n// https://cloud.google.com/vertex-ai/generative-ai/docs/partner-models/use-claude\nexport type VertexModelId = keyof typeof vertexModels\nexport const vertexDefaultModelId: VertexModelId = \"claude-3-5-sonnet-v2@20241022\"\nexport const vertexModels = {\n\t\"claude-3-5-sonnet-v2@20241022\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsComputerUse: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 3.0,\n\t\toutputPrice: 15.0,\n\t},\n\t\"claude-3-5-sonnet@20240620\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 3.0,\n\t\toutputPrice: 15.0,\n\t},\n\t\"claude-3-5-haiku@20241022\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: false,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 1.0,\n\t\toutputPrice: 5.0,\n\t},\n\t\"claude-3-opus@20240229\": {\n\t\tmaxTokens: 4096,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 15.0,\n\t\toutputPrice: 75.0,\n\t},\n\t\"claude-3-haiku@20240307\": {\n\t\tmaxTokens: 4096,\n\t\tcontextWindow: 200_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 0.25,\n\t\toutputPrice: 1.25,\n\t},\n} as const satisfies Record<string, ModelInfo>\n\nexport const openAiModelInfoSaneDefaults: ModelInfo = {\n\tmaxTokens: -1,\n\tcontextWindow: 128_000,\n\tsupportsImages: true,\n\tsupportsPromptCache: false,\n\tinputPrice: 0,\n\toutputPrice: 0,\n}\n\n// Gemini\n// https://ai.google.dev/gemini-api/docs/models/gemini\nexport type GeminiModelId = keyof typeof geminiModels\nexport const geminiDefaultModelId: GeminiModelId = \"gemini-1.5-flash-002\"\nexport const geminiModels = {\n\t\"gemini-1.5-flash-002\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 1_048_576,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 0,\n\t\toutputPrice: 0,\n\t},\n\t\"gemini-1.5-flash-exp-0827\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 1_048_576,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 0,\n\t\toutputPrice: 0,\n\t},\n\t\"gemini-1.5-flash-8b-exp-0827\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 1_048_576,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 0,\n\t\toutputPrice: 0,\n\t},\n\t\"gemini-1.5-pro-002\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 2_097_152,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 0,\n\t\toutputPrice: 0,\n\t},\n\t\"gemini-1.5-pro-exp-0827\": {\n\t\tmaxTokens: 8192,\n\t\tcontextWindow: 2_097_152,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 0,\n\t\toutputPrice: 0,\n\t},\n} as const satisfies Record<string, ModelInfo>\n\n// OpenAI Native\n// https://openai.com/api/pricing/\nexport type OpenAiNativeModelId = keyof typeof openAiNativeModels\nexport const openAiNativeDefaultModelId: OpenAiNativeModelId = \"gpt-4o\"\nexport const openAiNativeModels = {\n\t// don't support tool use yet\n\t\"o1-preview\": {\n\t\tmaxTokens: 32_768,\n\t\tcontextWindow: 128_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 15,\n\t\toutputPrice: 60,\n\t},\n\t\"o1-mini\": {\n\t\tmaxTokens: 65_536,\n\t\tcontextWindow: 128_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 3,\n\t\toutputPrice: 12,\n\t},\n\t\"gpt-4o\": {\n\t\tmaxTokens: 4_096,\n\t\tcontextWindow: 128_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 5,\n\t\toutputPrice: 15,\n\t},\n\t\"gpt-4o-mini\": {\n\t\tmaxTokens: 16_384,\n\t\tcontextWindow: 128_000,\n\t\tsupportsImages: true,\n\t\tsupportsPromptCache: false,\n\t\tinputPrice: 0.15,\n\t\toutputPrice: 0.6,\n\t},\n} as const satisfies Record<string, ModelInfo>\n\n// Azure OpenAI\n// https://learn.microsoft.com/en-us/azure/ai-services/openai/api-version-deprecation\n// https://learn.microsoft.com/en-us/azure/ai-services/openai/reference#api-specs\nexport const azureOpenAiDefaultApiVersion = \"2024-08-01-preview\"\n", "tag": "", "tokens": 3641, "metadata": {}}], "modify_time": 1733144568.7300165}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/context-mentions.ts", "relative_path": "cline/src/shared/context-mentions.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/context-mentions.ts", "source_code": "/*\nMention regex:\n- **Purpose**: \n  - To identify and highlight specific mentions in text that start with '@'. \n  - These mentions can be file paths, URLs, or the exact word 'problems'.\n  - Ensures that trailing punctuation marks (like commas, periods, etc.) are not included in the match, allowing punctuation to follow the mention without being part of it.\n\n- **Regex Breakdown**:\n  - `/@`: \n    - **@**: The mention must start with the '@' symbol.\n  \n  - `((?:\\/|\\w+:\\/\\/)[^\\s]+?|problems\\b)`:\n    - **Capturing Group (`(...)`)**: Captures the part of the string that matches one of the specified patterns.\n    - `(?:\\/|\\w+:\\/\\/)`: \n      - **Non-Capturing Group (`(?:...)`)**: Groups the alternatives without capturing them for back-referencing.\n      - `\\/`: \n        - **Slash (`/`)**: Indicates that the mention is a file or folder path starting with a '/'.\n      - `|`: Logical OR.\n      - `\\w+:\\/\\/`: \n        - **Protocol (`\\w+://`)**: Matches URLs that start with a word character sequence followed by '://', such as 'http://', 'https://', 'ftp://', etc.\n    - `[^\\s]+?`: \n      - **Non-Whitespace Characters (`[^\\s]+`)**: Matches one or more characters that are not whitespace.\n      - **Non-Greedy (`+?`)**: Ensures the smallest possible match, preventing the inclusion of trailing punctuation.\n    - `|`: Logical OR.\n    - `problems\\b`: \n      - **Exact Word ('problems')**: Matches the exact word 'problems'.\n      - **Word Boundary (`\\b`)**: Ensures that 'problems' is matched as a whole word and not as part of another word (e.g., 'problematic').\n\n  - `(?=[.,;:!?]?(?=[\\s\\r\\n]|$))`:\n    - **Positive Lookahead (`(?=...)`)**: Ensures that the match is followed by specific patterns without including them in the match.\n    - `[.,;:!?]?`: \n      - **Optional Punctuation (`[.,;:!?]?`)**: Matches zero or one of the specified punctuation marks.\n    - `(?=[\\s\\r\\n]|$)`: \n      - **Nested Positive Lookahead (`(?=[\\s\\r\\n]|$)`)**: Ensures that the punctuation (if present) is followed by a whitespace character, a line break, or the end of the string.\n  \n- **Summary**:\n  - The regex effectively matches:\n    - Mentions that are file or folder paths starting with '/' and containing any non-whitespace characters (including periods within the path).\n    - URLs that start with a protocol (like 'http://') followed by any non-whitespace characters (including query parameters).\n    - The exact word 'problems'.\n  - It ensures that any trailing punctuation marks (such as ',', '.', '!', etc.) are not included in the matched mention, allowing the punctuation to follow the mention naturally in the text.\n\n- **Global Regex**:\n  - `mentionRegexGlobal`: Creates a global version of the `mentionRegex` to find all matches within a given string.\n\n*/\nexport const mentionRegex = /@((?:\\/|\\w+:\\/\\/)[^\\s]+?|problems\\b)(?=[.,;:!?]?(?=[\\s\\r\\n]|$))/\nexport const mentionRegexGlobal = new RegExp(mentionRegex.source, \"g\")\n", "tag": "", "tokens": 837, "metadata": {}}], "modify_time": 1733144568.7305913}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/combineApiRequests.ts", "relative_path": "cline/src/shared/combineApiRequests.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/combineApiRequests.ts", "source_code": "import { ClineMessage } from \"./ExtensionMessage\"\n\n/**\n * Combines API request start and finish messages in an array of ClineMessages.\n *\n * This function looks for pairs of 'api_req_started' and 'api_req_finished' messages.\n * When it finds a pair, it combines them into a single 'api_req_combined' message.\n * The JSON data in the text fields of both messages are merged.\n *\n * @param messages - An array of ClineMessage objects to process.\n * @returns A new array of ClineMessage objects with API requests combined.\n *\n * @example\n * const messages = [\n *   { type: \"say\", say: \"api_req_started\", text: '{\"request\":\"GET /api/data\"}', ts: 1000 },\n *   { type: \"say\", say: \"api_req_finished\", text: '{\"cost\":0.005}', ts: 1001 }\n * ];\n * const result = combineApiRequests(messages);\n * // Result: [{ type: \"say\", say: \"api_req_started\", text: '{\"request\":\"GET /api/data\",\"cost\":0.005}', ts: 1000 }]\n */\nexport function combineApiRequests(messages: ClineMessage[]): ClineMessage[] {\n\tconst combinedApiRequests: ClineMessage[] = []\n\n\tfor (let i = 0; i < messages.length; i++) {\n\t\tif (messages[i].type === \"say\" && messages[i].say === \"api_req_started\") {\n\t\t\tlet startedRequest = JSON.parse(messages[i].text || \"{}\")\n\t\t\tlet j = i + 1\n\n\t\t\twhile (j < messages.length) {\n\t\t\t\tif (messages[j].type === \"say\" && messages[j].say === \"api_req_finished\") {\n\t\t\t\t\tlet finishedRequest = JSON.parse(messages[j].text || \"{}\")\n\t\t\t\t\tlet combinedRequest = { ...startedRequest, ...finishedRequest }\n\n\t\t\t\t\tcombinedApiRequests.push({\n\t\t\t\t\t\t...messages[i],\n\t\t\t\t\t\ttext: JSON.stringify(combinedRequest),\n\t\t\t\t\t})\n\n\t\t\t\t\ti = j // Skip to the api_req_finished message\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tj++\n\t\t\t}\n\n\t\t\tif (j === messages.length) {\n\t\t\t\t// If no matching api_req_finished found, keep the original api_req_started\n\t\t\t\tcombinedApiRequests.push(messages[i])\n\t\t\t}\n\t\t}\n\t}\n\n\t// Replace original api_req_started and remove api_req_finished\n\treturn messages\n\t\t.filter((msg) => !(msg.type === \"say\" && msg.say === \"api_req_finished\"))\n\t\t.map((msg) => {\n\t\t\tif (msg.type === \"say\" && msg.say === \"api_req_started\") {\n\t\t\t\tconst combinedRequest = combinedApiRequests.find((req) => req.ts === msg.ts)\n\t\t\t\treturn combinedRequest || msg\n\t\t\t}\n\t\t\treturn msg\n\t\t})\n}\n", "tag": "", "tokens": 711, "metadata": {}}], "modify_time": 1733144568.7302217}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/combineCommandSequences.ts", "relative_path": "cline/src/shared/combineCommandSequences.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/shared/combineCommandSequences.ts", "source_code": "import { ClineMessage } from \"./ExtensionMessage\"\n\n/**\n * Combines sequences of command and command_output messages in an array of ClineMessages.\n *\n * This function processes an array of ClineMessages objects, looking for sequences\n * where a 'command' message is followed by one or more 'command_output' messages.\n * When such a sequence is found, it combines them into a single message, merging\n * their text contents.\n *\n * @param messages - An array of ClineMessage objects to process.\n * @returns A new array of ClineMessage objects with command sequences combined.\n *\n * @example\n * const messages: ClineMessage[] = [\n *   { type: 'ask', ask: 'command', text: 'ls', ts: 1625097600000 },\n *   { type: 'ask', ask: 'command_output', text: 'file1.txt', ts: 1625097601000 },\n *   { type: 'ask', ask: 'command_output', text: 'file2.txt', ts: 1625097602000 }\n * ];\n * const result = simpleCombineCommandSequences(messages);\n * // Result: [{ type: 'ask', ask: 'command', text: 'ls\\nfile1.txt\\nfile2.txt', ts: 1625097600000 }]\n */\nexport function combineCommandSequences(messages: ClineMessage[]): ClineMessage[] {\n\tconst combinedCommands: ClineMessage[] = []\n\n\t// First pass: combine commands with their outputs\n\tfor (let i = 0; i < messages.length; i++) {\n\t\tif (messages[i].type === \"ask\" && messages[i].ask === \"command\") {\n\t\t\tlet combinedText = messages[i].text || \"\"\n\t\t\tlet didAddOutput = false\n\t\t\tlet j = i + 1\n\n\t\t\twhile (j < messages.length) {\n\t\t\t\tif (messages[j].type === \"ask\" && messages[j].ask === \"command\") {\n\t\t\t\t\t// Stop if we encounter the next command\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tif (messages[j].ask === \"command_output\" || messages[j].say === \"command_output\") {\n\t\t\t\t\tif (!didAddOutput) {\n\t\t\t\t\t\t// Add a newline before the first output\n\t\t\t\t\t\tcombinedText += `\\n${COMMAND_OUTPUT_STRING}`\n\t\t\t\t\t\tdidAddOutput = true\n\t\t\t\t\t}\n\t\t\t\t\t// handle cases where we receive empty command_output (ie when extension is relinquishing control over exit command button)\n\t\t\t\t\tconst output = messages[j].text || \"\"\n\t\t\t\t\tif (output.length > 0) {\n\t\t\t\t\t\tcombinedText += \"\\n\" + output\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tj++\n\t\t\t}\n\n\t\t\tcombinedCommands.push({\n\t\t\t\t...messages[i],\n\t\t\t\ttext: combinedText,\n\t\t\t})\n\n\t\t\ti = j - 1 // Move to the index just before the next command or end of array\n\t\t}\n\t}\n\n\t// Second pass: remove command_outputs and replace original commands with combined ones\n\treturn messages\n\t\t.filter((msg) => !(msg.ask === \"command_output\" || msg.say === \"command_output\"))\n\t\t.map((msg) => {\n\t\t\tif (msg.type === \"ask\" && msg.ask === \"command\") {\n\t\t\t\tconst combinedCommand = combinedCommands.find((cmd) => cmd.ts === msg.ts)\n\t\t\t\treturn combinedCommand || msg\n\t\t\t}\n\t\t\treturn msg\n\t\t})\n}\nexport const COMMAND_OUTPUT_STRING = \"Output:\"\n", "tag": "", "tokens": 841, "metadata": {}}], "modify_time": 1733144568.7303853}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/exports/cline.d.ts", "relative_path": "cline/src/exports/cline.d.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/exports/cline.d.ts", "source_code": "export interface ClineAPI {\n\t/**\n\t * Sets the custom instructions in the global storage.\n\t * @param value The custom instructions to be saved.\n\t */\n\tsetCustomInstructions(value: string): Promise<void>\n\n\t/**\n\t * Retrieves the custom instructions from the global storage.\n\t * @returns The saved custom instructions, or undefined if not set.\n\t */\n\tgetCustomInstructions(): Promise<string | undefined>\n\n\t/**\n\t * Starts a new task with an optional initial message and images.\n\t * @param task Optional initial task message.\n\t * @param images Optional array of image data URIs (e.g., \"data:image/webp;base64,...\").\n\t */\n\tstartNewTask(task?: string, images?: string[]): Promise<void>\n\n\t/**\n\t * Sends a message to the current task.\n\t * @param message Optional message to send.\n\t * @param images Optional array of image data URIs (e.g., \"data:image/webp;base64,...\").\n\t */\n\tsendMessage(message?: string, images?: string[]): Promise<void>\n\n\t/**\n\t * Simulates pressing the primary button in the chat interface.\n\t */\n\tpressPrimaryButton(): Promise<void>\n\n\t/**\n\t * Simulates pressing the secondary button in the chat interface.\n\t */\n\tpressSecondaryButton(): Promise<void>\n}\n", "tag": "", "tokens": 327, "metadata": {}}], "modify_time": 1733144568.7224243}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/exports/index.ts", "relative_path": "cline/src/exports/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/exports/index.ts", "source_code": "import * as vscode from \"vscode\"\nimport { ClineProvider } from \"../core/webview/ClineProvider\"\nimport { ClineAPI } from \"./cline\"\n\nexport function createClineAPI(outputChannel: vscode.OutputChannel, sidebarProvider: ClineProvider): ClineAPI {\n\tconst api: ClineAPI = {\n\t\tsetCustomInstructions: async (value: string) => {\n\t\t\tawait sidebarProvider.updateCustomInstructions(value)\n\t\t\toutputChannel.appendLine(\"Custom instructions set\")\n\t\t},\n\n\t\tgetCustomInstructions: async () => {\n\t\t\treturn (await sidebarProvider.getGlobalState(\"customInstructions\")) as string | undefined\n\t\t},\n\n\t\tstartNewTask: async (task?: string, images?: string[]) => {\n\t\t\toutputChannel.appendLine(\"Starting new task\")\n\t\t\tawait sidebarProvider.clearTask()\n\t\t\tawait sidebarProvider.postStateToWebview()\n\t\t\tawait sidebarProvider.postMessageToWebview({ type: \"action\", action: \"chatButtonClicked\" })\n\t\t\tawait sidebarProvider.postMessageToWebview({\n\t\t\t\ttype: \"invoke\",\n\t\t\t\tinvoke: \"sendMessage\",\n\t\t\t\ttext: task,\n\t\t\t\timages: images,\n\t\t\t})\n\t\t\toutputChannel.appendLine(\n\t\t\t\t`Task started with message: ${task ? `\"${task}\"` : \"undefined\"} and ${images?.length || 0} image(s)`,\n\t\t\t)\n\t\t},\n\n\t\tsendMessage: async (message?: string, images?: string[]) => {\n\t\t\toutputChannel.appendLine(\n\t\t\t\t`Sending message: ${message ? `\"${message}\"` : \"undefined\"} with ${images?.length || 0} image(s)`,\n\t\t\t)\n\t\t\tawait sidebarProvider.postMessageToWebview({\n\t\t\t\ttype: \"invoke\",\n\t\t\t\tinvoke: \"sendMessage\",\n\t\t\t\ttext: message,\n\t\t\t\timages: images,\n\t\t\t})\n\t\t},\n\n\t\tpressPrimaryButton: async () => {\n\t\t\toutputChannel.appendLine(\"Pressing primary button\")\n\t\t\tawait sidebarProvider.postMessageToWebview({\n\t\t\t\ttype: \"invoke\",\n\t\t\t\tinvoke: \"primaryButtonClick\",\n\t\t\t})\n\t\t},\n\n\t\tpressSecondaryButton: async () => {\n\t\t\toutputChannel.appendLine(\"Pressing secondary button\")\n\t\t\tawait sidebarProvider.postMessageToWebview({\n\t\t\t\ttype: \"invoke\",\n\t\t\t\tinvoke: \"secondaryButtonClick\",\n\t\t\t})\n\t\t},\n\t}\n\n\treturn api\n}\n", "tag": "", "tokens": 578, "metadata": {}}], "modify_time": 1733144568.7225327}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/misc/extract-text.ts", "relative_path": "cline/src/integrations/misc/extract-text.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/misc/extract-text.ts", "source_code": "import * as path from \"path\"\n// @ts-ignore-next-line\nimport pdf from \"pdf-parse/lib/pdf-parse\"\nimport mammoth from \"mammoth\"\nimport fs from \"fs/promises\"\nimport { isBinaryFile } from \"isbinaryfile\"\n\nexport async function extractTextFromFile(filePath: string): Promise<string> {\n\ttry {\n\t\tawait fs.access(filePath)\n\t} catch (error) {\n\t\tthrow new Error(`File not found: ${filePath}`)\n\t}\n\tconst fileExtension = path.extname(filePath).toLowerCase()\n\tswitch (fileExtension) {\n\t\tcase \".pdf\":\n\t\t\treturn extractTextFromPDF(filePath)\n\t\tcase \".docx\":\n\t\t\treturn extractTextFromDOCX(filePath)\n\t\tcase \".ipynb\":\n\t\t\treturn extractTextFromIPYNB(filePath)\n\t\tdefault:\n\t\t\tconst isBinary = await isBinaryFile(filePath).catch(() => false)\n\t\t\tif (!isBinary) {\n\t\t\t\treturn await fs.readFile(filePath, \"utf8\")\n\t\t\t} else {\n\t\t\t\tthrow new Error(`Cannot read text for file type: ${fileExtension}`)\n\t\t\t}\n\t}\n}\n\nasync function extractTextFromPDF(filePath: string): Promise<string> {\n\tconst dataBuffer = await fs.readFile(filePath)\n\tconst data = await pdf(dataBuffer)\n\treturn data.text\n}\n\nasync function extractTextFromDOCX(filePath: string): Promise<string> {\n\tconst result = await mammoth.extractRawText({ path: filePath })\n\treturn result.value\n}\n\nasync function extractTextFromIPYNB(filePath: string): Promise<string> {\n\tconst data = await fs.readFile(filePath, \"utf8\")\n\tconst notebook = JSON.parse(data)\n\tlet extractedText = \"\"\n\n\tfor (const cell of notebook.cells) {\n\t\tif ((cell.cell_type === \"markdown\" || cell.cell_type === \"code\") && cell.source) {\n\t\t\textractedText += cell.source.join(\"\\n\") + \"\\n\"\n\t\t}\n\t}\n\n\treturn extractedText\n}\n", "tag": "", "tokens": 493, "metadata": {}}], "modify_time": 1733144568.7238293}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/misc/process-images.ts", "relative_path": "cline/src/integrations/misc/process-images.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/misc/process-images.ts", "source_code": "import * as vscode from \"vscode\"\nimport fs from \"fs/promises\"\nimport * as path from \"path\"\n\nexport async function selectImages(): Promise<string[]> {\n\tconst options: vscode.OpenDialogOptions = {\n\t\tcanSelectMany: true,\n\t\topenLabel: \"Select\",\n\t\tfilters: {\n\t\t\tImages: [\"png\", \"jpg\", \"jpeg\", \"webp\"], // supported by anthropic and openrouter\n\t\t},\n\t}\n\n\tconst fileUris = await vscode.window.showOpenDialog(options)\n\n\tif (!fileUris || fileUris.length === 0) {\n\t\treturn []\n\t}\n\n\treturn await Promise.all(\n\t\tfileUris.map(async (uri) => {\n\t\t\tconst imagePath = uri.fsPath\n\t\t\tconst buffer = await fs.readFile(imagePath)\n\t\t\tconst base64 = buffer.toString(\"base64\")\n\t\t\tconst mimeType = getMimeType(imagePath)\n\t\t\tconst dataUrl = `data:${mimeType};base64,${base64}`\n\t\t\treturn dataUrl\n\t\t}),\n\t)\n}\n\nfunction getMimeType(filePath: string): string {\n\tconst ext = path.extname(filePath).toLowerCase()\n\tswitch (ext) {\n\t\tcase \".png\":\n\t\t\treturn \"image/png\"\n\t\tcase \".jpeg\":\n\t\tcase \".jpg\":\n\t\t\treturn \"image/jpeg\"\n\t\tcase \".webp\":\n\t\t\treturn \"image/webp\"\n\t\tdefault:\n\t\t\tthrow new Error(`Unsupported file type: ${ext}`)\n\t}\n}\n", "tag": "", "tokens": 374, "metadata": {}}], "modify_time": 1733144568.724058}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/misc/open-file.ts", "relative_path": "cline/src/integrations/misc/open-file.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/misc/open-file.ts", "source_code": "import * as path from \"path\"\nimport * as os from \"os\"\nimport * as vscode from \"vscode\"\nimport { arePathsEqual } from \"../../utils/path\"\n\nexport async function openImage(dataUri: string) {\n\tconst matches = dataUri.match(/^data:image\\/([a-zA-Z]+);base64,(.+)$/)\n\tif (!matches) {\n\t\tvscode.window.showErrorMessage(\"Invalid data URI format\")\n\t\treturn\n\t}\n\tconst [, format, base64Data] = matches\n\tconst imageBuffer = Buffer.from(base64Data, \"base64\")\n\tconst tempFilePath = path.join(os.tmpdir(), `temp_image_${Date.now()}.${format}`)\n\ttry {\n\t\tawait vscode.workspace.fs.writeFile(vscode.Uri.file(tempFilePath), imageBuffer)\n\t\tawait vscode.commands.executeCommand(\"vscode.open\", vscode.Uri.file(tempFilePath))\n\t} catch (error) {\n\t\tvscode.window.showErrorMessage(`Error opening image: ${error}`)\n\t}\n}\n\nexport async function openFile(absolutePath: string) {\n\ttry {\n\t\tconst uri = vscode.Uri.file(absolutePath)\n\n\t\t// Check if the document is already open in a tab group that's not in the active editor's column. If it is, then close it (if not dirty) so that we don't duplicate tabs\n\t\ttry {\n\t\t\tfor (const group of vscode.window.tabGroups.all) {\n\t\t\t\tconst existingTab = group.tabs.find(\n\t\t\t\t\t(tab) =>\n\t\t\t\t\t\ttab.input instanceof vscode.TabInputText && arePathsEqual(tab.input.uri.fsPath, uri.fsPath),\n\t\t\t\t)\n\t\t\t\tif (existingTab) {\n\t\t\t\t\tconst activeColumn = vscode.window.activeTextEditor?.viewColumn\n\t\t\t\t\tconst tabColumn = vscode.window.tabGroups.all.find((group) =>\n\t\t\t\t\t\tgroup.tabs.includes(existingTab),\n\t\t\t\t\t)?.viewColumn\n\t\t\t\t\tif (activeColumn && activeColumn !== tabColumn && !existingTab.isDirty) {\n\t\t\t\t\t\tawait vscode.window.tabGroups.close(existingTab)\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {} // not essential, sometimes tab operations fail\n\n\t\tconst document = await vscode.workspace.openTextDocument(uri)\n\t\tawait vscode.window.showTextDocument(document, { preview: false })\n\t} catch (error) {\n\t\tvscode.window.showErrorMessage(`Could not open file!`)\n\t}\n}\n", "tag": "", "tokens": 613, "metadata": {}}], "modify_time": 1733144568.7239487}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/misc/export-markdown.ts", "relative_path": "cline/src/integrations/misc/export-markdown.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/misc/export-markdown.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport os from \"os\"\nimport * as path from \"path\"\nimport * as vscode from \"vscode\"\n\nexport async function downloadTask(dateTs: number, conversationHistory: Anthropic.MessageParam[]) {\n\t// File name\n\tconst date = new Date(dateTs)\n\tconst month = date.toLocaleString(\"en-US\", { month: \"short\" }).toLowerCase()\n\tconst day = date.getDate()\n\tconst year = date.getFullYear()\n\tlet hours = date.getHours()\n\tconst minutes = date.getMinutes().toString().padStart(2, \"0\")\n\tconst seconds = date.getSeconds().toString().padStart(2, \"0\")\n\tconst ampm = hours >= 12 ? \"pm\" : \"am\"\n\thours = hours % 12\n\thours = hours ? hours : 12 // the hour '0' should be '12'\n\tconst fileName = `cline_task_${month}-${day}-${year}_${hours}-${minutes}-${seconds}-${ampm}.md`\n\n\t// Generate markdown\n\tconst markdownContent = conversationHistory\n\t\t.map((message) => {\n\t\t\tconst role = message.role === \"user\" ? \"**User:**\" : \"**Assistant:**\"\n\t\t\tconst content = Array.isArray(message.content)\n\t\t\t\t? message.content.map((block) => formatContentBlockToMarkdown(block)).join(\"\\n\")\n\t\t\t\t: message.content\n\t\t\treturn `${role}\\n\\n${content}\\n\\n`\n\t\t})\n\t\t.join(\"---\\n\\n\")\n\n\t// Prompt user for save location\n\tconst saveUri = await vscode.window.showSaveDialog({\n\t\tfilters: { Markdown: [\"md\"] },\n\t\tdefaultUri: vscode.Uri.file(path.join(os.homedir(), \"Downloads\", fileName)),\n\t})\n\n\tif (saveUri) {\n\t\t// Write content to the selected location\n\t\tawait vscode.workspace.fs.writeFile(saveUri, Buffer.from(markdownContent))\n\t\tvscode.window.showTextDocument(saveUri, { preview: true })\n\t}\n}\n\nexport function formatContentBlockToMarkdown(\n\tblock:\n\t\t| Anthropic.TextBlockParam\n\t\t| Anthropic.ImageBlockParam\n\t\t| Anthropic.ToolUseBlockParam\n\t\t| Anthropic.ToolResultBlockParam,\n\t// messages: Anthropic.MessageParam[]\n): string {\n\tswitch (block.type) {\n\t\tcase \"text\":\n\t\t\treturn block.text\n\t\tcase \"image\":\n\t\t\treturn `[Image]`\n\t\tcase \"tool_use\":\n\t\t\tlet input: string\n\t\t\tif (typeof block.input === \"object\" && block.input !== null) {\n\t\t\t\tinput = Object.entries(block.input)\n\t\t\t\t\t.map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`)\n\t\t\t\t\t.join(\"\\n\")\n\t\t\t} else {\n\t\t\t\tinput = String(block.input)\n\t\t\t}\n\t\t\treturn `[Tool Use: ${block.name}]\\n${input}`\n\t\tcase \"tool_result\":\n\t\t\t// For now we're not doing tool name lookup since we don't use tools anymore\n\t\t\t// const toolName = findToolName(block.tool_use_id, messages)\n\t\t\tconst toolName = \"Tool\"\n\t\t\tif (typeof block.content === \"string\") {\n\t\t\t\treturn `[${toolName}${block.is_error ? \" (Error)\" : \"\"}]\\n${block.content}`\n\t\t\t} else if (Array.isArray(block.content)) {\n\t\t\t\treturn `[${toolName}${block.is_error ? \" (Error)\" : \"\"}]\\n${block.content\n\t\t\t\t\t.map((contentBlock) => formatContentBlockToMarkdown(contentBlock))\n\t\t\t\t\t.join(\"\\n\")}`\n\t\t\t} else {\n\t\t\t\treturn `[${toolName}${block.is_error ? \" (Error)\" : \"\"}]`\n\t\t\t}\n\t\tdefault:\n\t\t\treturn \"[Unexpected content type]\"\n\t}\n}\n\nexport function findToolName(toolCallId: string, messages: Anthropic.MessageParam[]): string {\n\tfor (const message of messages) {\n\t\tif (Array.isArray(message.content)) {\n\t\t\tfor (const block of message.content) {\n\t\t\t\tif (block.type === \"tool_use\" && block.id === toolCallId) {\n\t\t\t\t\treturn block.name\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn \"Unknown Tool\"\n}\n", "tag": "", "tokens": 1050, "metadata": {}}], "modify_time": 1733144568.7236998}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/workspace/get-python-env.ts", "relative_path": "cline/src/integrations/workspace/get-python-env.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/workspace/get-python-env.ts", "source_code": "import * as vscode from \"vscode\"\n\n/*\nUsed to get user's current python environment (unnecessary now that we use the IDE's terminal)\n${await (async () => {\n\t\ttry {\n\t\t\tconst pythonEnvPath = await getPythonEnvPath()\n\t\t\tif (pythonEnvPath) {\n\t\t\t\treturn `\\nPython Environment: ${pythonEnvPath}`\n\t\t\t}\n\t\t} catch {}\n\t\treturn \"\"\n\t})()}\n*/\nexport async function getPythonEnvPath(): Promise<string | undefined> {\n\tconst pythonExtension = vscode.extensions.getExtension(\"ms-python.python\")\n\n\tif (!pythonExtension) {\n\t\treturn undefined\n\t}\n\n\t// Ensure the Python extension is activated\n\tif (!pythonExtension.isActive) {\n\t\t// if the python extension is not active, we can assume the project is not a python project\n\t\treturn undefined\n\t}\n\n\t// Access the Python extension API\n\tconst pythonApi = pythonExtension.exports\n\t// Get the active environment path for the current workspace\n\tconst workspaceFolder = vscode.workspace.workspaceFolders?.[0]\n\tif (!workspaceFolder) {\n\t\treturn undefined\n\t}\n\t// Get the active python environment path for the current workspace\n\tconst pythonEnv = await pythonApi?.environments?.getActiveEnvironmentPath(workspaceFolder.uri)\n\tif (pythonEnv && pythonEnv.path) {\n\t\treturn pythonEnv.path\n\t} else {\n\t\treturn undefined\n\t}\n}\n", "tag": "", "tokens": 326, "metadata": {}}], "modify_time": 1733144568.7264183}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/workspace/WorkspaceTracker.ts", "relative_path": "cline/src/integrations/workspace/WorkspaceTracker.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/workspace/WorkspaceTracker.ts", "source_code": "import * as vscode from \"vscode\"\nimport * as path from \"path\"\nimport { listFiles } from \"../../services/glob/list-files\"\nimport { ClineProvider } from \"../../core/webview/ClineProvider\"\n\nconst cwd = vscode.workspace.workspaceFolders?.map((folder) => folder.uri.fsPath).at(0)\n\n// Note: this is not a drop-in replacement for listFiles at the start of tasks, since that will be done for Desktops when there is no workspace selected\nclass WorkspaceTracker {\n\tprivate providerRef: WeakRef<ClineProvider>\n\tprivate disposables: vscode.Disposable[] = []\n\tprivate filePaths: Set<string> = new Set()\n\n\tconstructor(provider: ClineProvider) {\n\t\tthis.providerRef = new WeakRef(provider)\n\t\tthis.registerListeners()\n\t}\n\n\tasync initializeFilePaths() {\n\t\t// should not auto get filepaths for desktop since it would immediately show permission popup before cline ever creates a file\n\t\tif (!cwd) {\n\t\t\treturn\n\t\t}\n\t\tconst [files, _] = await listFiles(cwd, true, 1_000)\n\t\tfiles.forEach((file) => this.filePaths.add(this.normalizeFilePath(file)))\n\t\tthis.workspaceDidUpdate()\n\t}\n\n\tprivate registerListeners() {\n\t\t// Listen for file creation\n\t\t// .bind(this) ensures the callback refers to class instance when using this, not necessary when using arrow function\n\t\tthis.disposables.push(vscode.workspace.onDidCreateFiles(this.onFilesCreated.bind(this)))\n\n\t\t// Listen for file deletion\n\t\tthis.disposables.push(vscode.workspace.onDidDeleteFiles(this.onFilesDeleted.bind(this)))\n\n\t\t// Listen for file renaming\n\t\tthis.disposables.push(vscode.workspace.onDidRenameFiles(this.onFilesRenamed.bind(this)))\n\n\t\t/*\n\t\t An event that is emitted when a workspace folder is added or removed.\n\t\t **Note:** this event will not fire if the first workspace folder is added, removed or changed,\n\t\t because in that case the currently executing extensions (including the one that listens to this\n\t\t event) will be terminated and restarted so that the (deprecated) `rootPath` property is updated\n\t\t to point to the first workspace folder.\n\t\t */\n\t\t// In other words, we don't have to worry about the root workspace folder ([0]) changing since the extension will be restarted and our cwd will be updated to reflect the new workspace folder. (We don't care about non root workspace folders, since cline will only be working within the root folder cwd)\n\t\t// this.disposables.push(vscode.workspace.onDidChangeWorkspaceFolders(this.onWorkspaceFoldersChanged.bind(this)))\n\t}\n\n\tprivate async onFilesCreated(event: vscode.FileCreateEvent) {\n\t\tawait Promise.all(\n\t\t\tevent.files.map(async (file) => {\n\t\t\t\tawait this.addFilePath(file.fsPath)\n\t\t\t}),\n\t\t)\n\t\tthis.workspaceDidUpdate()\n\t}\n\n\tprivate async onFilesDeleted(event: vscode.FileDeleteEvent) {\n\t\tlet updated = false\n\t\tawait Promise.all(\n\t\t\tevent.files.map(async (file) => {\n\t\t\t\tif (await this.removeFilePath(file.fsPath)) {\n\t\t\t\t\tupdated = true\n\t\t\t\t}\n\t\t\t}),\n\t\t)\n\t\tif (updated) {\n\t\t\tthis.workspaceDidUpdate()\n\t\t}\n\t}\n\n\tprivate async onFilesRenamed(event: vscode.FileRenameEvent) {\n\t\tawait Promise.all(\n\t\t\tevent.files.map(async (file) => {\n\t\t\t\tawait this.removeFilePath(file.oldUri.fsPath)\n\t\t\t\tawait this.addFilePath(file.newUri.fsPath)\n\t\t\t}),\n\t\t)\n\t\tthis.workspaceDidUpdate()\n\t}\n\n\tprivate workspaceDidUpdate() {\n\t\tif (!cwd) {\n\t\t\treturn\n\t\t}\n\t\tthis.providerRef.deref()?.postMessageToWebview({\n\t\t\ttype: \"workspaceUpdated\",\n\t\t\tfilePaths: Array.from(this.filePaths).map((file) => {\n\t\t\t\tconst relativePath = path.relative(cwd, file).toPosix()\n\t\t\t\treturn file.endsWith(\"/\") ? relativePath + \"/\" : relativePath\n\t\t\t}),\n\t\t})\n\t}\n\n\tprivate normalizeFilePath(filePath: string): string {\n\t\tconst resolvedPath = cwd ? path.resolve(cwd, filePath) : path.resolve(filePath)\n\t\treturn filePath.endsWith(\"/\") ? resolvedPath + \"/\" : resolvedPath\n\t}\n\n\tprivate async addFilePath(filePath: string): Promise<string> {\n\t\tconst normalizedPath = this.normalizeFilePath(filePath)\n\t\ttry {\n\t\t\tconst stat = await vscode.workspace.fs.stat(vscode.Uri.file(normalizedPath))\n\t\t\tconst isDirectory = (stat.type & vscode.FileType.Directory) !== 0\n\t\t\tconst pathWithSlash = isDirectory && !normalizedPath.endsWith(\"/\") ? normalizedPath + \"/\" : normalizedPath\n\t\t\tthis.filePaths.add(pathWithSlash)\n\t\t\treturn pathWithSlash\n\t\t} catch {\n\t\t\t// If stat fails, assume it's a file (this can happen for newly created files)\n\t\t\tthis.filePaths.add(normalizedPath)\n\t\t\treturn normalizedPath\n\t\t}\n\t}\n\n\tprivate async removeFilePath(filePath: string): Promise<boolean> {\n\t\tconst normalizedPath = this.normalizeFilePath(filePath)\n\t\treturn this.filePaths.delete(normalizedPath) || this.filePaths.delete(normalizedPath + \"/\")\n\t}\n\n\tpublic dispose() {\n\t\tthis.disposables.forEach((d) => d.dispose())\n\t}\n}\n\nexport default WorkspaceTracker\n", "tag": "", "tokens": 1345, "metadata": {}}], "modify_time": 1733144568.7263076}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/terminal/TerminalRegistry.ts", "relative_path": "cline/src/integrations/terminal/TerminalRegistry.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/terminal/TerminalRegistry.ts", "source_code": "import * as vscode from \"vscode\"\n\nexport interface TerminalInfo {\n\tterminal: vscode.Terminal\n\tbusy: boolean\n\tlastCommand: string\n\tid: number\n}\n\n// Although vscode.window.terminals provides a list of all open terminals, there's no way to know whether they're busy or not (exitStatus does not provide useful information for most commands). In order to prevent creating too many terminals, we need to keep track of terminals through the life of the extension, as well as session specific terminals for the life of a task (to get latest unretrieved output).\n// Since we have promises keeping track of terminal processes, we get the added benefit of keep track of busy terminals even after a task is closed.\nexport class TerminalRegistry {\n\tprivate static terminals: TerminalInfo[] = []\n\tprivate static nextTerminalId = 1\n\n\tstatic createTerminal(cwd?: string | vscode.Uri | undefined): TerminalInfo {\n\t\tconst terminal = vscode.window.createTerminal({\n\t\t\tcwd,\n\t\t\tname: \"Cline\",\n\t\t\ticonPath: new vscode.ThemeIcon(\"robot\"),\n\t\t})\n\t\tconst newInfo: TerminalInfo = {\n\t\t\tterminal,\n\t\t\tbusy: false,\n\t\t\tlastCommand: \"\",\n\t\t\tid: this.nextTerminalId++,\n\t\t}\n\t\tthis.terminals.push(newInfo)\n\t\treturn newInfo\n\t}\n\n\tstatic getTerminal(id: number): TerminalInfo | undefined {\n\t\tconst terminalInfo = this.terminals.find((t) => t.id === id)\n\t\tif (terminalInfo && this.isTerminalClosed(terminalInfo.terminal)) {\n\t\t\tthis.removeTerminal(id)\n\t\t\treturn undefined\n\t\t}\n\t\treturn terminalInfo\n\t}\n\n\tstatic updateTerminal(id: number, updates: Partial<TerminalInfo>) {\n\t\tconst terminal = this.getTerminal(id)\n\t\tif (terminal) {\n\t\t\tObject.assign(terminal, updates)\n\t\t}\n\t}\n\n\tstatic removeTerminal(id: number) {\n\t\tthis.terminals = this.terminals.filter((t) => t.id !== id)\n\t}\n\n\tstatic getAllTerminals(): TerminalInfo[] {\n\t\tthis.terminals = this.terminals.filter((t) => !this.isTerminalClosed(t.terminal))\n\t\treturn this.terminals\n\t}\n\n\t// The exit status of the terminal will be undefined while the terminal is active. (This value is set when onDidCloseTerminal is fired.)\n\tprivate static isTerminalClosed(terminal: vscode.Terminal): boolean {\n\t\treturn terminal.exitStatus !== undefined\n\t}\n}\n", "tag": "", "tokens": 595, "metadata": {}}], "modify_time": 1733144568.724604}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/terminal/TerminalProcess.ts", "relative_path": "cline/src/integrations/terminal/TerminalProcess.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/terminal/TerminalProcess.ts", "source_code": "import { EventEmitter } from \"events\"\nimport stripAnsi from \"strip-ansi\"\nimport * as vscode from \"vscode\"\n\nexport interface TerminalProcessEvents {\n\tline: [line: string]\n\tcontinue: []\n\tcompleted: []\n\terror: [error: Error]\n\tno_shell_integration: []\n}\n\n// how long to wait after a process outputs anything before we consider it \"cool\" again\nconst PROCESS_HOT_TIMEOUT_NORMAL = 2_000\nconst PROCESS_HOT_TIMEOUT_COMPILING = 15_000\n\nexport class TerminalProcess extends EventEmitter<TerminalProcessEvents> {\n\twaitForShellIntegration: boolean = true\n\tprivate isListening: boolean = true\n\tprivate buffer: string = \"\"\n\tprivate fullOutput: string = \"\"\n\tprivate lastRetrievedIndex: number = 0\n\tisHot: boolean = false\n\tprivate hotTimer: NodeJS.Timeout | null = null\n\n\t// constructor() {\n\t// \tsuper()\n\n\tasync run(terminal: vscode.Terminal, command: string) {\n\t\tif (terminal.shellIntegration && terminal.shellIntegration.executeCommand) {\n\t\t\tconst execution = terminal.shellIntegration.executeCommand(command)\n\t\t\tconst stream = execution.read()\n\t\t\t// todo: need to handle errors\n\t\t\tlet isFirstChunk = true\n\t\t\tlet didOutputNonCommand = false\n\t\t\tlet didEmitEmptyLine = false\n\t\t\tfor await (let data of stream) {\n\t\t\t\t// 1. Process chunk and remove artifacts\n\t\t\t\tif (isFirstChunk) {\n\t\t\t\t\t/*\n\t\t\t\t\tThe first chunk we get from this stream needs to be processed to be more human readable, ie remove vscode's custom escape sequences and identifiers, removing duplicate first char bug, etc.\n\t\t\t\t\t*/\n\n\t\t\t\t\t// bug where sometimes the command output makes its way into vscode shell integration metadata\n\t\t\t\t\t/*\n\t\t\t\t\t]633 is a custom sequence number used by VSCode shell integration:\n\t\t\t\t\t- OSC 633 ; A ST - Mark prompt start\n\t\t\t\t\t- OSC 633 ; B ST - Mark prompt end\n\t\t\t\t\t- OSC 633 ; C ST - Mark pre-execution (start of command output)\n\t\t\t\t\t- OSC 633 ; D [; <exitcode>] ST - Mark execution finished with optional exit code\n\t\t\t\t\t- OSC 633 ; E ; <commandline> [; <nonce>] ST - Explicitly set command line with optional nonce\n\t\t\t\t\t*/\n\t\t\t\t\t// if you print this data you might see something like \"eecho hello worldo hello world;5ba85d14-e92a-40c4-b2fd-71525581eeb0]633;C\" but this is actually just a bunch of escape sequences, ignore up to the first ;C\n\t\t\t\t\t/* ddateb15026-6a64-40db-b21f-2a621a9830f0]633;CTue Sep 17 06:37:04 EDT 2024 % ]633;D;0]633;P;Cwd=/Users/saoud/Repositories/test */\n\t\t\t\t\t// Gets output between ]633;C (command start) and ]633;D (command end)\n\t\t\t\t\tconst outputBetweenSequences = this.removeLastLineArtifacts(\n\t\t\t\t\t\tdata.match(/\\]633;C([\\s\\S]*?)\\]633;D/)?.[1] || \"\",\n\t\t\t\t\t).trim()\n\n\t\t\t\t\t// Once we've retrieved any potential output between sequences, we can remove everything up to end of the last sequence\n\t\t\t\t\t// https://code.visualstudio.com/docs/terminal/shell-integration#_vs-code-custom-sequences-osc-633-st\n\t\t\t\t\tconst vscodeSequenceRegex = /\\x1b\\]633;.[^\\x07]*\\x07/g\n\t\t\t\t\tconst lastMatch = [...data.matchAll(vscodeSequenceRegex)].pop()\n\t\t\t\t\tif (lastMatch && lastMatch.index !== undefined) {\n\t\t\t\t\t\tdata = data.slice(lastMatch.index + lastMatch[0].length)\n\t\t\t\t\t}\n\t\t\t\t\t// Place output back after removing vscode sequences\n\t\t\t\t\tif (outputBetweenSequences) {\n\t\t\t\t\t\tdata = outputBetweenSequences + \"\\n\" + data\n\t\t\t\t\t}\n\t\t\t\t\t// remove ansi\n\t\t\t\t\tdata = stripAnsi(data)\n\t\t\t\t\t// Split data by newlines\n\t\t\t\t\tlet lines = data ? data.split(\"\\n\") : []\n\t\t\t\t\t// Remove non-human readable characters from the first line\n\t\t\t\t\tif (lines.length > 0) {\n\t\t\t\t\t\tlines[0] = lines[0].replace(/[^\\x20-\\x7E]/g, \"\")\n\t\t\t\t\t}\n\t\t\t\t\t// Check if first two characters are the same, if so remove the first character\n\t\t\t\t\tif (lines.length > 0 && lines[0].length >= 2 && lines[0][0] === lines[0][1]) {\n\t\t\t\t\t\tlines[0] = lines[0].slice(1)\n\t\t\t\t\t}\n\t\t\t\t\t// Remove everything up to the first alphanumeric character for first two lines\n\t\t\t\t\tif (lines.length > 0) {\n\t\t\t\t\t\tlines[0] = lines[0].replace(/^[^a-zA-Z0-9]*/, \"\")\n\t\t\t\t\t}\n\t\t\t\t\tif (lines.length > 1) {\n\t\t\t\t\t\tlines[1] = lines[1].replace(/^[^a-zA-Z0-9]*/, \"\")\n\t\t\t\t\t}\n\t\t\t\t\t// Join lines back\n\t\t\t\t\tdata = lines.join(\"\\n\")\n\t\t\t\t\tisFirstChunk = false\n\t\t\t\t} else {\n\t\t\t\t\tdata = stripAnsi(data)\n\t\t\t\t}\n\n\t\t\t\t// first few chunks could be the command being echoed back, so we must ignore\n\t\t\t\t// note this means that 'echo' commands wont work\n\t\t\t\tif (!didOutputNonCommand) {\n\t\t\t\t\tconst lines = data.split(\"\\n\")\n\t\t\t\t\tfor (let i = 0; i < lines.length; i++) {\n\t\t\t\t\t\tif (command.includes(lines[i].trim())) {\n\t\t\t\t\t\t\tlines.splice(i, 1)\n\t\t\t\t\t\t\ti-- // Adjust index after removal\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tdidOutputNonCommand = true\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tdata = lines.join(\"\\n\")\n\t\t\t\t}\n\n\t\t\t\t// FIXME: right now it seems that data chunks returned to us from the shell integration stream contains random commas, which from what I can tell is not the expected behavior. There has to be a better solution here than just removing all commas.\n\t\t\t\tdata = data.replace(/,/g, \"\")\n\n\t\t\t\t// 2. Set isHot depending on the command\n\t\t\t\t// Set to hot to stall API requests until terminal is cool again\n\t\t\t\tthis.isHot = true\n\t\t\t\tif (this.hotTimer) {\n\t\t\t\t\tclearTimeout(this.hotTimer)\n\t\t\t\t}\n\t\t\t\t// these markers indicate the command is some kind of local dev server recompiling the app, which we want to wait for output of before sending request to cline\n\t\t\t\tconst compilingMarkers = [\"compiling\", \"building\", \"bundling\", \"transpiling\", \"generating\", \"starting\"]\n\t\t\t\tconst markerNullifiers = [\n\t\t\t\t\t\"compiled\",\n\t\t\t\t\t\"success\",\n\t\t\t\t\t\"finish\",\n\t\t\t\t\t\"complete\",\n\t\t\t\t\t\"succeed\",\n\t\t\t\t\t\"done\",\n\t\t\t\t\t\"end\",\n\t\t\t\t\t\"stop\",\n\t\t\t\t\t\"exit\",\n\t\t\t\t\t\"terminate\",\n\t\t\t\t\t\"error\",\n\t\t\t\t\t\"fail\",\n\t\t\t\t]\n\t\t\t\tconst isCompiling =\n\t\t\t\t\tcompilingMarkers.some((marker) => data.toLowerCase().includes(marker.toLowerCase())) &&\n\t\t\t\t\t!markerNullifiers.some((nullifier) => data.toLowerCase().includes(nullifier.toLowerCase()))\n\t\t\t\tthis.hotTimer = setTimeout(\n\t\t\t\t\t() => {\n\t\t\t\t\t\tthis.isHot = false\n\t\t\t\t\t},\n\t\t\t\t\tisCompiling ? PROCESS_HOT_TIMEOUT_COMPILING : PROCESS_HOT_TIMEOUT_NORMAL,\n\t\t\t\t)\n\n\t\t\t\t// For non-immediately returning commands we want to show loading spinner right away but this wouldnt happen until it emits a line break, so as soon as we get any output we emit \"\" to let webview know to show spinner\n\t\t\t\tif (!didEmitEmptyLine && !this.fullOutput && data) {\n\t\t\t\t\tthis.emit(\"line\", \"\") // empty line to indicate start of command output stream\n\t\t\t\t\tdidEmitEmptyLine = true\n\t\t\t\t}\n\n\t\t\t\tthis.fullOutput += data\n\t\t\t\tif (this.isListening) {\n\t\t\t\t\tthis.emitIfEol(data)\n\t\t\t\t\tthis.lastRetrievedIndex = this.fullOutput.length - this.buffer.length\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.emitRemainingBufferIfListening()\n\n\t\t\t// for now we don't want this delaying requests since we don't send diagnostics automatically anymore (previous: \"even though the command is finished, we still want to consider it 'hot' in case so that api request stalls to let diagnostics catch up\")\n\t\t\tif (this.hotTimer) {\n\t\t\t\tclearTimeout(this.hotTimer)\n\t\t\t}\n\t\t\tthis.isHot = false\n\n\t\t\tthis.emit(\"completed\")\n\t\t\tthis.emit(\"continue\")\n\t\t} else {\n\t\t\tterminal.sendText(command, true)\n\t\t\t// For terminals without shell integration, we can't know when the command completes\n\t\t\t// So we'll just emit the continue event after a delay\n\t\t\tthis.emit(\"completed\")\n\t\t\tthis.emit(\"continue\")\n\t\t\tthis.emit(\"no_shell_integration\")\n\t\t\t// setTimeout(() => {\n\t\t\t// \tconsole.log(`Emitting continue after delay for terminal`)\n\t\t\t// \t// can't emit completed since we don't if the command actually completed, it could still be running server\n\t\t\t// }, 500) // Adjust this delay as needed\n\t\t}\n\t}\n\n\t// Inspired by https://github.com/sindresorhus/execa/blob/main/lib/transform/split.js\n\tprivate emitIfEol(chunk: string) {\n\t\tthis.buffer += chunk\n\t\tlet lineEndIndex: number\n\t\twhile ((lineEndIndex = this.buffer.indexOf(\"\\n\")) !== -1) {\n\t\t\tlet line = this.buffer.slice(0, lineEndIndex).trimEnd() // removes trailing \\r\n\t\t\t// Remove \\r if present (for Windows-style line endings)\n\t\t\t// if (line.endsWith(\"\\r\")) {\n\t\t\t// \tline = line.slice(0, -1)\n\t\t\t// }\n\t\t\tthis.emit(\"line\", line)\n\t\t\tthis.buffer = this.buffer.slice(lineEndIndex + 1)\n\t\t}\n\t}\n\n\tprivate emitRemainingBufferIfListening() {\n\t\tif (this.buffer && this.isListening) {\n\t\t\tconst remainingBuffer = this.removeLastLineArtifacts(this.buffer)\n\t\t\tif (remainingBuffer) {\n\t\t\t\tthis.emit(\"line\", remainingBuffer)\n\t\t\t}\n\t\t\tthis.buffer = \"\"\n\t\t\tthis.lastRetrievedIndex = this.fullOutput.length\n\t\t}\n\t}\n\n\tcontinue() {\n\t\tthis.emitRemainingBufferIfListening()\n\t\tthis.isListening = false\n\t\tthis.removeAllListeners(\"line\")\n\t\tthis.emit(\"continue\")\n\t}\n\n\tgetUnretrievedOutput(): string {\n\t\tconst unretrieved = this.fullOutput.slice(this.lastRetrievedIndex)\n\t\tthis.lastRetrievedIndex = this.fullOutput.length\n\t\treturn this.removeLastLineArtifacts(unretrieved)\n\t}\n\n\t// some processing to remove artifacts like '%' at the end of the buffer (it seems that since vsode uses % at the beginning of newlines in terminal, it makes its way into the stream)\n\t// This modification will remove '%', '$', '#', or '>' followed by optional whitespace\n\tremoveLastLineArtifacts(output: string) {\n\t\tconst lines = output.trimEnd().split(\"\\n\")\n\t\tif (lines.length > 0) {\n\t\t\tconst lastLine = lines[lines.length - 1]\n\t\t\t// Remove prompt characters and trailing whitespace from the last line\n\t\t\tlines[lines.length - 1] = lastLine.replace(/[%$#>]\\s*$/, \"\")\n\t\t}\n\t\treturn lines.join(\"\\n\").trimEnd()\n\t}\n}\n\nexport type TerminalProcessResultPromise = TerminalProcess & Promise<void>\n\n// Similar to execa's ResultPromise, this lets us create a mixin of both a TerminalProcess and a Promise: https://github.com/sindresorhus/execa/blob/main/lib/methods/promise.js\nexport function mergePromise(process: TerminalProcess, promise: Promise<void>): TerminalProcessResultPromise {\n\tconst nativePromisePrototype = (async () => {})().constructor.prototype\n\tconst descriptors = [\"then\", \"catch\", \"finally\"].map(\n\t\t(property) => [property, Reflect.getOwnPropertyDescriptor(nativePromisePrototype, property)] as const,\n\t)\n\tfor (const [property, descriptor] of descriptors) {\n\t\tif (descriptor) {\n\t\t\tconst value = descriptor.value.bind(promise)\n\t\t\tReflect.defineProperty(process, property, { ...descriptor, value })\n\t\t}\n\t}\n\treturn process as TerminalProcessResultPromise\n}\n", "tag": "", "tokens": 3004, "metadata": {}}], "modify_time": 1733144568.7244444}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/terminal/TerminalManager.ts", "relative_path": "cline/src/integrations/terminal/TerminalManager.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/terminal/TerminalManager.ts", "source_code": "import pWaitFor from \"p-wait-for\"\nimport * as vscode from \"vscode\"\nimport { arePathsEqual } from \"../../utils/path\"\nimport { mergePromise, TerminalProcess, TerminalProcessResultPromise } from \"./TerminalProcess\"\nimport { TerminalInfo, TerminalRegistry } from \"./TerminalRegistry\"\n\n/*\nTerminalManager:\n- Creates/reuses terminals\n- Runs commands via runCommand(), returning a TerminalProcess\n- Handles shell integration events\n\nTerminalProcess extends EventEmitter and implements Promise:\n- Emits 'line' events with output while promise is pending\n- process.continue() resolves promise and stops event emission\n- Allows real-time output handling or background execution\n\ngetUnretrievedOutput() fetches latest output for ongoing commands\n\nEnables flexible command execution:\n- Await for completion\n- Listen to real-time events\n- Continue execution in background\n- Retrieve missed output later\n\nNotes:\n- it turns out some shellIntegration APIs are available on cursor, although not on older versions of vscode\n- \"By default, the shell integration script should automatically activate on supported shells launched from VS Code.\"\nSupported shells:\nLinux/macOS: bash, fish, pwsh, zsh\nWindows: pwsh\n\n\nExample:\n\nconst terminalManager = new TerminalManager(context);\n\n// Run a command\nconst process = terminalManager.runCommand('npm install', '/path/to/project');\n\nprocess.on('line', (line) => {\n    console.log(line);\n});\n\n// To wait for the process to complete naturally:\nawait process;\n\n// Or to continue execution even if the command is still running:\nprocess.continue();\n\n// Later, if you need to get the unretrieved output:\nconst unretrievedOutput = terminalManager.getUnretrievedOutput(terminalId);\nconsole.log('Unretrieved output:', unretrievedOutput);\n\nResources:\n- https://github.com/microsoft/vscode/issues/226655\n- https://code.visualstudio.com/updates/v1_93#_terminal-shell-integration-api\n- https://code.visualstudio.com/docs/terminal/shell-integration\n- https://code.visualstudio.com/api/references/vscode-api#Terminal\n- https://github.com/microsoft/vscode-extension-samples/blob/main/terminal-sample/src/extension.ts\n- https://github.com/microsoft/vscode-extension-samples/blob/main/shell-integration-sample/src/extension.ts\n*/\n\n/*\nThe new shellIntegration API gives us access to terminal command execution output handling.\nHowever, we don't update our VSCode type definitions or engine requirements to maintain compatibility\nwith older VSCode versions. Users on older versions will automatically fall back to using sendText\nfor terminal command execution.\nInterestingly, some environments like Cursor enable these APIs even without the latest VSCode engine.\nThis approach allows us to leverage advanced features when available while ensuring broad compatibility.\n*/\ndeclare module \"vscode\" {\n\t// https://github.com/microsoft/vscode/blob/f0417069c62e20f3667506f4b7e53ca0004b4e3e/src/vscode-dts/vscode.d.ts#L7442\n\tinterface Terminal {\n\t\tshellIntegration?: {\n\t\t\tcwd?: vscode.Uri\n\t\t\texecuteCommand?: (command: string) => {\n\t\t\t\tread: () => AsyncIterable<string>\n\t\t\t}\n\t\t}\n\t}\n\t// https://github.com/microsoft/vscode/blob/f0417069c62e20f3667506f4b7e53ca0004b4e3e/src/vscode-dts/vscode.d.ts#L10794\n\tinterface Window {\n\t\tonDidStartTerminalShellExecution?: (\n\t\t\tlistener: (e: any) => any,\n\t\t\tthisArgs?: any,\n\t\t\tdisposables?: vscode.Disposable[],\n\t\t) => vscode.Disposable\n\t}\n}\n\nexport class TerminalManager {\n\tprivate terminalIds: Set<number> = new Set()\n\tprivate processes: Map<number, TerminalProcess> = new Map()\n\tprivate disposables: vscode.Disposable[] = []\n\n\tconstructor() {\n\t\tlet disposable: vscode.Disposable | undefined\n\t\ttry {\n\t\t\tdisposable = (vscode.window as vscode.Window).onDidStartTerminalShellExecution?.(async (e) => {\n\t\t\t\t// Creating a read stream here results in a more consistent output. This is most obvious when running the `date` command.\n\t\t\t\te?.execution?.read()\n\t\t\t})\n\t\t} catch (error) {\n\t\t\t// console.error(\"Error setting up onDidEndTerminalShellExecution\", error)\n\t\t}\n\t\tif (disposable) {\n\t\t\tthis.disposables.push(disposable)\n\t\t}\n\t}\n\n\trunCommand(terminalInfo: TerminalInfo, command: string): TerminalProcessResultPromise {\n\t\tterminalInfo.busy = true\n\t\tterminalInfo.lastCommand = command\n\t\tconst process = new TerminalProcess()\n\t\tthis.processes.set(terminalInfo.id, process)\n\n\t\tprocess.once(\"completed\", () => {\n\t\t\tterminalInfo.busy = false\n\t\t})\n\n\t\t// if shell integration is not available, remove terminal so it does not get reused as it may be running a long-running process\n\t\tprocess.once(\"no_shell_integration\", () => {\n\t\t\tconsole.log(`no_shell_integration received for terminal ${terminalInfo.id}`)\n\t\t\t// Remove the terminal so we can't reuse it (in case it's running a long-running process)\n\t\t\tTerminalRegistry.removeTerminal(terminalInfo.id)\n\t\t\tthis.terminalIds.delete(terminalInfo.id)\n\t\t\tthis.processes.delete(terminalInfo.id)\n\t\t})\n\n\t\tconst promise = new Promise<void>((resolve, reject) => {\n\t\t\tprocess.once(\"continue\", () => {\n\t\t\t\tresolve()\n\t\t\t})\n\t\t\tprocess.once(\"error\", (error) => {\n\t\t\t\tconsole.error(`Error in terminal ${terminalInfo.id}:`, error)\n\t\t\t\treject(error)\n\t\t\t})\n\t\t})\n\n\t\t// if shell integration is already active, run the command immediately\n\t\tif (terminalInfo.terminal.shellIntegration) {\n\t\t\tprocess.waitForShellIntegration = false\n\t\t\tprocess.run(terminalInfo.terminal, command)\n\t\t} else {\n\t\t\t// docs recommend waiting 3s for shell integration to activate\n\t\t\tpWaitFor(() => terminalInfo.terminal.shellIntegration !== undefined, { timeout: 4000 }).finally(() => {\n\t\t\t\tconst existingProcess = this.processes.get(terminalInfo.id)\n\t\t\t\tif (existingProcess && existingProcess.waitForShellIntegration) {\n\t\t\t\t\texistingProcess.waitForShellIntegration = false\n\t\t\t\t\texistingProcess.run(terminalInfo.terminal, command)\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\n\t\treturn mergePromise(process, promise)\n\t}\n\n\tasync getOrCreateTerminal(cwd: string): Promise<TerminalInfo> {\n\t\t// Find available terminal from our pool first (created for this task)\n\t\tconst availableTerminal = TerminalRegistry.getAllTerminals().find((t) => {\n\t\t\tif (t.busy) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t\tconst terminalCwd = t.terminal.shellIntegration?.cwd // one of cline's commands could have changed the cwd of the terminal\n\t\t\tif (!terminalCwd) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn arePathsEqual(vscode.Uri.file(cwd).fsPath, terminalCwd.fsPath)\n\t\t})\n\t\tif (availableTerminal) {\n\t\t\tthis.terminalIds.add(availableTerminal.id)\n\t\t\treturn availableTerminal\n\t\t}\n\n\t\tconst newTerminalInfo = TerminalRegistry.createTerminal(cwd)\n\t\tthis.terminalIds.add(newTerminalInfo.id)\n\t\treturn newTerminalInfo\n\t}\n\n\tgetTerminals(busy: boolean): { id: number; lastCommand: string }[] {\n\t\treturn Array.from(this.terminalIds)\n\t\t\t.map((id) => TerminalRegistry.getTerminal(id))\n\t\t\t.filter((t): t is TerminalInfo => t !== undefined && t.busy === busy)\n\t\t\t.map((t) => ({ id: t.id, lastCommand: t.lastCommand }))\n\t}\n\n\tgetUnretrievedOutput(terminalId: number): string {\n\t\tif (!this.terminalIds.has(terminalId)) {\n\t\t\treturn \"\"\n\t\t}\n\t\tconst process = this.processes.get(terminalId)\n\t\treturn process ? process.getUnretrievedOutput() : \"\"\n\t}\n\n\tisProcessHot(terminalId: number): boolean {\n\t\tconst process = this.processes.get(terminalId)\n\t\treturn process ? process.isHot : false\n\t}\n\n\tdisposeAll() {\n\t\t// for (const info of this.terminals) {\n\t\t// \t//info.terminal.dispose() // dont want to dispose terminals when task is aborted\n\t\t// }\n\t\tthis.terminalIds.clear()\n\t\tthis.processes.clear()\n\t\tthis.disposables.forEach((disposable) => disposable.dispose())\n\t\tthis.disposables = []\n\t}\n}\n", "tag": "", "tokens": 2151, "metadata": {}}], "modify_time": 1733144568.7242396}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/theme/getTheme.ts", "relative_path": "cline/src/integrations/theme/getTheme.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/theme/getTheme.ts", "source_code": "import * as vscode from \"vscode\"\nimport * as path from \"path\"\nimport * as fs from \"fs/promises\"\nimport { convertTheme } from \"monaco-vscode-textmate-theme-converter/lib/cjs\"\n\nconst defaultThemes: Record<string, string> = {\n\t\"Default Dark Modern\": \"dark_modern\",\n\t\"Dark+\": \"dark_plus\",\n\t\"Default Dark+\": \"dark_plus\",\n\t\"Dark (Visual Studio)\": \"dark_vs\",\n\t\"Visual Studio Dark\": \"dark_vs\",\n\t\"Dark High Contrast\": \"hc_black\",\n\t\"Default High Contrast\": \"hc_black\",\n\t\"Light High Contrast\": \"hc_light\",\n\t\"Default High Contrast Light\": \"hc_light\",\n\t\"Default Light Modern\": \"light_modern\",\n\t\"Light+\": \"light_plus\",\n\t\"Default Light+\": \"light_plus\",\n\t\"Light (Visual Studio)\": \"light_vs\",\n\t\"Visual Studio Light\": \"light_vs\",\n}\n\nfunction parseThemeString(themeString: string | undefined): any {\n\tthemeString = themeString\n\t\t?.split(\"\\n\")\n\t\t.filter((line) => {\n\t\t\treturn !line.trim().startsWith(\"//\")\n\t\t})\n\t\t.join(\"\\n\")\n\treturn JSON.parse(themeString ?? \"{}\")\n}\n\nexport async function getTheme() {\n\tlet currentTheme = undefined\n\tconst colorTheme = vscode.workspace.getConfiguration(\"workbench\").get<string>(\"colorTheme\") || \"Default Dark Modern\"\n\n\ttry {\n\t\tfor (let i = vscode.extensions.all.length - 1; i >= 0; i--) {\n\t\t\tif (currentTheme) {\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tconst extension = vscode.extensions.all[i]\n\t\t\tif (extension.packageJSON?.contributes?.themes?.length > 0) {\n\t\t\t\tfor (const theme of extension.packageJSON.contributes.themes) {\n\t\t\t\t\tif (theme.label === colorTheme) {\n\t\t\t\t\t\tconst themePath = path.join(extension.extensionPath, theme.path)\n\t\t\t\t\t\tcurrentTheme = await fs.readFile(themePath, \"utf-8\")\n\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (currentTheme === undefined && defaultThemes[colorTheme]) {\n\t\t\tconst filename = `${defaultThemes[colorTheme]}.json`\n\t\t\tcurrentTheme = await fs.readFile(\n\t\t\t\tpath.join(getExtensionUri().fsPath, \"src\", \"integrations\", \"theme\", \"default-themes\", filename),\n\t\t\t\t\"utf-8\",\n\t\t\t)\n\t\t}\n\n\t\t// Strip comments from theme\n\t\tlet parsed = parseThemeString(currentTheme)\n\n\t\tif (parsed.include) {\n\t\t\tconst includeThemeString = await fs.readFile(\n\t\t\t\tpath.join(getExtensionUri().fsPath, \"src\", \"integrations\", \"theme\", \"default-themes\", parsed.include),\n\t\t\t\t\"utf-8\",\n\t\t\t)\n\t\t\tconst includeTheme = parseThemeString(includeThemeString)\n\t\t\tparsed = mergeJson(parsed, includeTheme)\n\t\t}\n\n\t\tconst converted = convertTheme(parsed)\n\n\t\tconverted.base = (\n\t\t\t[\"vs\", \"hc-black\"].includes(converted.base)\n\t\t\t\t? converted.base\n\t\t\t\t: colorTheme.includes(\"Light\")\n\t\t\t\t\t? \"vs\"\n\t\t\t\t\t: \"vs-dark\"\n\t\t) as any\n\n\t\treturn converted\n\t} catch (e) {\n\t\tconsole.log(\"Error loading color theme: \", e)\n\t}\n\treturn undefined\n}\n\ntype JsonObject = { [key: string]: any }\nexport function mergeJson(\n\tfirst: JsonObject,\n\tsecond: JsonObject,\n\tmergeBehavior?: \"merge\" | \"overwrite\",\n\tmergeKeys?: { [key: string]: (a: any, b: any) => boolean },\n): any {\n\tconst copyOfFirst = JSON.parse(JSON.stringify(first))\n\n\ttry {\n\t\tfor (const key in second) {\n\t\t\tconst secondValue = second[key]\n\n\t\t\tif (!(key in copyOfFirst) || mergeBehavior === \"overwrite\") {\n\t\t\t\t// New value\n\t\t\t\tcopyOfFirst[key] = secondValue\n\t\t\t\tcontinue\n\t\t\t}\n\n\t\t\tconst firstValue = copyOfFirst[key]\n\t\t\tif (Array.isArray(secondValue) && Array.isArray(firstValue)) {\n\t\t\t\t// Array\n\t\t\t\tif (mergeKeys?.[key]) {\n\t\t\t\t\t// Merge keys are used to determine whether an item form the second object should override one from the first\n\t\t\t\t\tconst keptFromFirst: any[] = []\n\t\t\t\t\tfirstValue.forEach((item: any) => {\n\t\t\t\t\t\tif (!secondValue.some((item2: any) => mergeKeys[key](item, item2))) {\n\t\t\t\t\t\t\tkeptFromFirst.push(item)\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\tcopyOfFirst[key] = [...keptFromFirst, ...secondValue]\n\t\t\t\t} else {\n\t\t\t\t\tcopyOfFirst[key] = [...firstValue, ...secondValue]\n\t\t\t\t}\n\t\t\t} else if (typeof secondValue === \"object\" && typeof firstValue === \"object\") {\n\t\t\t\t// Object\n\t\t\t\tcopyOfFirst[key] = mergeJson(firstValue, secondValue, mergeBehavior)\n\t\t\t} else {\n\t\t\t\t// Other (boolean, number, string)\n\t\t\t\tcopyOfFirst[key] = secondValue\n\t\t\t}\n\t\t}\n\t\treturn copyOfFirst\n\t} catch (e) {\n\t\tconsole.error(\"Error merging JSON\", e, copyOfFirst, second)\n\t\treturn {\n\t\t\t...copyOfFirst,\n\t\t\t...second,\n\t\t}\n\t}\n}\n\nfunction getExtensionUri(): vscode.Uri {\n\treturn vscode.extensions.getExtension(\"saoudrizwan.claude-dev\")!.extensionUri\n}\n", "tag": "", "tokens": 1345, "metadata": {}}], "modify_time": 1733144568.7261295}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/diagnostics/DiagnosticsMonitor.ts", "relative_path": "cline/src/integrations/diagnostics/DiagnosticsMonitor.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/diagnostics/DiagnosticsMonitor.ts", "source_code": "/*\nimport * as vscode from \"vscode\"\nimport deepEqual from \"fast-deep-equal\"\n\ntype FileDiagnostics = [vscode.Uri, vscode.Diagnostic[]][]\n\n\nAbout Diagnostics:\nThe Problems tab shows diagnostics that have been reported for your project. These diagnostics are categorized into:\nErrors: Critical issues that usually prevent your code from compiling or running correctly.\nWarnings: Potential problems in the code that may not prevent it from running but could cause issues (e.g., bad practices, unused variables).\nInformation: Non-critical suggestions or tips (e.g., formatting issues or notes from linters).\nThe Problems tab displays diagnostics from various sources:\n1. Language Servers:\n   - TypeScript: Type errors, missing imports, syntax issues\n   - Python: Syntax errors, invalid type hints, undefined variables\n   - JavaScript/Node.js: Parsing and execution errors\n2. Linters:\n   - ESLint: Code style, best practices, potential bugs\n   - Pylint: Unused imports, naming conventions\n   - TSLint: Style and correctness issues in TypeScript\n3. Build Tools:\n   - Webpack: Module resolution failures, build errors\n   - Gulp: Build errors during task execution\n4. Custom Validators:\n   - Extensions can generate custom diagnostics for specific languages or tools\nEach problem typically indicates its source (e.g., language server, linter, build tool).\nDiagnostics update in real-time as you edit code, helping identify issues quickly. For example, if you introduce a syntax error in a TypeScript file, the Problems tab will immediately display the new error.\n\nNotes on diagnostics:\n- linter diagnostics are only captured for open editors\n- this works great for us since when cline edits/creates files its through vscode's textedit api's and we get those diagnostics for free\n- some tools might require you to save the file or manually refresh to clear the problem from the list.\n\nSystem Prompt\n- You will automatically receive workspace error diagnostics in environment_details. Be mindful that this may include issues beyond the scope of your task or the user's request. Only address errors relevant to your work, and avoid fixing pre-existing or unrelated issues unless the user specifically instructs you to do so.\n- If you are unable to resolve errors provided in environment_details after two attempts, consider using ask_followup_question to ask the user for additional information, such as the latest documentation related to a problematic framework, to help you make progress on the task. If the error remains unresolved after this step, proceed with your task while disregarding the error.\n\nclass DiagnosticsMonitor {\n\tprivate diagnosticsChangeEmitter: vscode.EventEmitter<void> = new vscode.EventEmitter<void>()\n\tprivate disposables: vscode.Disposable[] = []\n\tprivate lastDiagnostics: FileDiagnostics = []\n\n\tconstructor() {\n\t\tthis.disposables.push(\n\t\t\tvscode.languages.onDidChangeDiagnostics(() => {\n\t\t\t\tthis.diagnosticsChangeEmitter.fire()\n\t\t\t})\n\t\t)\n\t}\n\n\tpublic async getCurrentDiagnostics(shouldWaitForChanges: boolean): Promise<FileDiagnostics> {\n\t\tconst currentDiagnostics = this.getDiagnostics()\n\t\tif (!shouldWaitForChanges) {\n\t\t\tthis.lastDiagnostics = currentDiagnostics\n\t\t\treturn currentDiagnostics\n\t\t}\n\n\t\tif (!deepEqual(this.lastDiagnostics, currentDiagnostics)) {\n\t\t\tthis.lastDiagnostics = currentDiagnostics\n\t\t\treturn currentDiagnostics\n\t\t}\n\n\t\tlet timeout = 300 // only way this happens is if theres no errors\n\n\t\t// if diagnostics contain existing errors (since the check above didn't trigger) then it's likely cline just did something that should have fixed the error, so we'll give a longer grace period for diagnostics to catch up\n\t\tconst hasErrors = currentDiagnostics.some(([_, diagnostics]) =>\n\t\t\tdiagnostics.some((d) => d.severity === vscode.DiagnosticSeverity.Error)\n\t\t)\n\t\tif (hasErrors) {\n\t\t\tconsole.log(\"Existing errors detected, extending timeout\", currentDiagnostics)\n\t\t\ttimeout = 10_000\n\t\t}\n\n\t\treturn this.waitForUpdatedDiagnostics(timeout)\n\t}\n\n\tprivate async waitForUpdatedDiagnostics(timeout: number): Promise<FileDiagnostics> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst timer = setTimeout(() => {\n\t\t\t\tcleanup()\n\t\t\t\tconst finalDiagnostics = this.getDiagnostics()\n\t\t\t\tthis.lastDiagnostics = finalDiagnostics\n\t\t\t\tresolve(finalDiagnostics)\n\t\t\t}, timeout)\n\n\t\t\tconst disposable = this.diagnosticsChangeEmitter.event(() => {\n\t\t\t\tconst updatedDiagnostics = this.getDiagnostics() // I thought this would only trigger when diagnostics changed, but that's not the case.\n\t\t\t\tif (deepEqual(this.lastDiagnostics, updatedDiagnostics)) {\n\t\t\t\t\t// diagnostics have not changed, ignoring...\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tcleanup()\n\t\t\t\tthis.lastDiagnostics = updatedDiagnostics\n\t\t\t\tresolve(updatedDiagnostics)\n\t\t\t})\n\n\t\t\tconst cleanup = () => {\n\t\t\t\tclearTimeout(timer)\n\t\t\t\tdisposable.dispose()\n\t\t\t}\n\t\t})\n\t}\n\n\tprivate getDiagnostics(): FileDiagnostics {\n\t\tconst allDiagnostics = vscode.languages.getDiagnostics()\n\t\treturn allDiagnostics\n\t\t\t.filter(([_, diagnostics]) => diagnostics.some((d) => d.severity === vscode.DiagnosticSeverity.Error))\n\t\t\t.map(([uri, diagnostics]) => [\n\t\t\t\turi,\n\t\t\t\tdiagnostics.filter((d) => d.severity === vscode.DiagnosticSeverity.Error),\n\t\t\t])\n\t}\n\n\tpublic dispose() {\n\t\tthis.disposables.forEach((d) => d.dispose())\n\t\tthis.disposables = []\n\t\tthis.diagnosticsChangeEmitter.dispose()\n\t}\n}\n\nexport default DiagnosticsMonitor\n*/\n", "tag": "", "tokens": 1311, "metadata": {}}], "modify_time": 1733144568.722919}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/diagnostics/index.ts", "relative_path": "cline/src/integrations/diagnostics/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/diagnostics/index.ts", "source_code": "import * as vscode from \"vscode\"\nimport * as path from \"path\"\nimport deepEqual from \"fast-deep-equal\"\n\nexport function getNewDiagnostics(\n\toldDiagnostics: [vscode.Uri, vscode.Diagnostic[]][],\n\tnewDiagnostics: [vscode.Uri, vscode.Diagnostic[]][],\n): [vscode.Uri, vscode.Diagnostic[]][] {\n\tconst newProblems: [vscode.Uri, vscode.Diagnostic[]][] = []\n\tconst oldMap = new Map(oldDiagnostics)\n\n\tfor (const [uri, newDiags] of newDiagnostics) {\n\t\tconst oldDiags = oldMap.get(uri) || []\n\t\tconst newProblemsForUri = newDiags.filter((newDiag) => !oldDiags.some((oldDiag) => deepEqual(oldDiag, newDiag)))\n\n\t\tif (newProblemsForUri.length > 0) {\n\t\t\tnewProblems.push([uri, newProblemsForUri])\n\t\t}\n\t}\n\n\treturn newProblems\n}\n\n// Usage:\n// const oldDiagnostics = // ... your old diagnostics array\n// const newDiagnostics = // ... your new diagnostics array\n// const newProblems = getNewDiagnostics(oldDiagnostics, newDiagnostics);\n\n// Example usage with mocks:\n//\n// // Mock old diagnostics\n// const oldDiagnostics: [vscode.Uri, vscode.Diagnostic[]][] = [\n//     [vscode.Uri.file(\"/path/to/file1.ts\"), [\n//         new vscode.Diagnostic(new vscode.Range(0, 0, 0, 10), \"Old error in file1\", vscode.DiagnosticSeverity.Error)\n//     ]],\n//     [vscode.Uri.file(\"/path/to/file2.ts\"), [\n//         new vscode.Diagnostic(new vscode.Range(5, 5, 5, 15), \"Old warning in file2\", vscode.DiagnosticSeverity.Warning)\n//     ]]\n// ];\n//\n// // Mock new diagnostics\n// const newDiagnostics: [vscode.Uri, vscode.Diagnostic[]][] = [\n//     [vscode.Uri.file(\"/path/to/file1.ts\"), [\n//         new vscode.Diagnostic(new vscode.Range(0, 0, 0, 10), \"Old error in file1\", vscode.DiagnosticSeverity.Error),\n//         new vscode.Diagnostic(new vscode.Range(2, 2, 2, 12), \"New error in file1\", vscode.DiagnosticSeverity.Error)\n//     ]],\n//     [vscode.Uri.file(\"/path/to/file2.ts\"), [\n//         new vscode.Diagnostic(new vscode.Range(5, 5, 5, 15), \"Old warning in file2\", vscode.DiagnosticSeverity.Warning)\n//     ]],\n//     [vscode.Uri.file(\"/path/to/file3.ts\"), [\n//         new vscode.Diagnostic(new vscode.Range(1, 1, 1, 11), \"New error in file3\", vscode.DiagnosticSeverity.Error)\n//     ]]\n// ];\n//\n// const newProblems = getNewProblems(oldDiagnostics, newDiagnostics);\n//\n// console.log(\"New problems:\");\n// for (const [uri, diagnostics] of newProblems) {\n//     console.log(`File: ${uri.fsPath}`);\n//     for (const diagnostic of diagnostics) {\n//         console.log(`- ${diagnostic.message} (${diagnostic.range.start.line}:${diagnostic.range.start.character})`);\n//     }\n// }\n//\n// // Expected output:\n// // New problems:\n// // File: /path/to/file1.ts\n// // - New error in file1 (2:2)\n// // File: /path/to/file3.ts\n// // - New error in file3 (1:1)\n\n// will return empty string if no problems with the given severity are found\nexport function diagnosticsToProblemsString(\n\tdiagnostics: [vscode.Uri, vscode.Diagnostic[]][],\n\tseverities: vscode.DiagnosticSeverity[],\n\tcwd: string,\n): string {\n\tlet result = \"\"\n\tfor (const [uri, fileDiagnostics] of diagnostics) {\n\t\tconst problems = fileDiagnostics.filter((d) => severities.includes(d.severity))\n\t\tif (problems.length > 0) {\n\t\t\tresult += `\\n\\n${path.relative(cwd, uri.fsPath).toPosix()}`\n\t\t\tfor (const diagnostic of problems) {\n\t\t\t\tlet label: string\n\t\t\t\tswitch (diagnostic.severity) {\n\t\t\t\t\tcase vscode.DiagnosticSeverity.Error:\n\t\t\t\t\t\tlabel = \"Error\"\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase vscode.DiagnosticSeverity.Warning:\n\t\t\t\t\t\tlabel = \"Warning\"\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase vscode.DiagnosticSeverity.Information:\n\t\t\t\t\t\tlabel = \"Information\"\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase vscode.DiagnosticSeverity.Hint:\n\t\t\t\t\t\tlabel = \"Hint\"\n\t\t\t\t\t\tbreak\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tlabel = \"Diagnostic\"\n\t\t\t\t}\n\t\t\t\tconst line = diagnostic.range.start.line + 1 // VSCode lines are 0-indexed\n\t\t\t\tconst source = diagnostic.source ? `${diagnostic.source} ` : \"\"\n\t\t\t\tresult += `\\n- [${source}${label}] Line ${line}: ${diagnostic.message}`\n\t\t\t}\n\t\t}\n\t}\n\treturn result.trim()\n}\n", "tag": "", "tokens": 1286, "metadata": {}}], "modify_time": 1733144568.723043}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/editor/detect-omission.ts", "relative_path": "cline/src/integrations/editor/detect-omission.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/editor/detect-omission.ts", "source_code": "import * as vscode from \"vscode\"\n\n/**\n * Detects potential AI-generated code omissions in the given file content.\n * @param originalFileContent The original content of the file.\n * @param newFileContent The new content of the file to check.\n * @returns True if a potential omission is detected, false otherwise.\n */\nfunction detectCodeOmission(originalFileContent: string, newFileContent: string): boolean {\n\tconst originalLines = originalFileContent.split(\"\\n\")\n\tconst newLines = newFileContent.split(\"\\n\")\n\tconst omissionKeywords = [\"remain\", \"remains\", \"unchanged\", \"rest\", \"previous\", \"existing\", \"...\"]\n\n\tconst commentPatterns = [\n\t\t/^\\s*\\/\\//, // Single-line comment for most languages\n\t\t/^\\s*#/, // Single-line comment for Python, Ruby, etc.\n\t\t/^\\s*\\/\\*/, // Multi-line comment opening\n\t\t/^\\s*{\\s*\\/\\*/, // JSX comment opening\n\t\t/^\\s*<!--/, // HTML comment opening\n\t]\n\n\tfor (const line of newLines) {\n\t\tif (commentPatterns.some((pattern) => pattern.test(line))) {\n\t\t\tconst words = line.toLowerCase().split(/\\s+/)\n\t\t\tif (omissionKeywords.some((keyword) => words.includes(keyword))) {\n\t\t\t\tif (!originalLines.includes(line)) {\n\t\t\t\t\treturn true\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn false\n}\n\n/**\n * Shows a warning in VSCode if a potential code omission is detected.\n * @param originalFileContent The original content of the file.\n * @param newFileContent The new content of the file to check.\n */\nexport function showOmissionWarning(originalFileContent: string, newFileContent: string): void {\n\tif (detectCodeOmission(originalFileContent, newFileContent)) {\n\t\tvscode.window\n\t\t\t.showWarningMessage(\n\t\t\t\t\"Potential code truncation detected. This happens when the AI reaches its max output limit.\",\n\t\t\t\t\"Follow this guide to fix the issue\",\n\t\t\t)\n\t\t\t.then((selection) => {\n\t\t\t\tif (selection === \"Follow this guide to fix the issue\") {\n\t\t\t\t\tvscode.env.openExternal(\n\t\t\t\t\t\tvscode.Uri.parse(\n\t\t\t\t\t\t\t\"https://github.com/cline/cline/wiki/Troubleshooting-%E2%80%90-Cline-Deleting-Code-with-%22Rest-of-Code-Here%22-Comments\",\n\t\t\t\t\t\t),\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t})\n\t}\n}\n", "tag": "", "tokens": 597, "metadata": {}}], "modify_time": 1733144568.723512}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/editor/DiffViewProvider.ts", "relative_path": "cline/src/integrations/editor/DiffViewProvider.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/editor/DiffViewProvider.ts", "source_code": "import * as vscode from \"vscode\"\nimport * as path from \"path\"\nimport * as fs from \"fs/promises\"\nimport { createDirectoriesForFile } from \"../../utils/fs\"\nimport { arePathsEqual } from \"../../utils/path\"\nimport { formatResponse } from \"../../core/prompts/responses\"\nimport { DecorationController } from \"./DecorationController\"\nimport * as diff from \"diff\"\nimport { diagnosticsToProblemsString, getNewDiagnostics } from \"../diagnostics\"\n\nexport const DIFF_VIEW_URI_SCHEME = \"cline-diff\"\n\nexport class DiffViewProvider {\n\teditType?: \"create\" | \"modify\"\n\tisEditing = false\n\toriginalContent: string | undefined\n\tprivate createdDirs: string[] = []\n\tprivate documentWasOpen = false\n\tprivate relPath?: string\n\tprivate newContent?: string\n\tprivate activeDiffEditor?: vscode.TextEditor\n\tprivate fadedOverlayController?: DecorationController\n\tprivate activeLineController?: DecorationController\n\tprivate streamedLines: string[] = []\n\tprivate preDiagnostics: [vscode.Uri, vscode.Diagnostic[]][] = []\n\n\tconstructor(private cwd: string) {}\n\n\tasync open(relPath: string): Promise<void> {\n\t\tthis.relPath = relPath\n\t\tconst fileExists = this.editType === \"modify\"\n\t\tconst absolutePath = path.resolve(this.cwd, relPath)\n\t\tthis.isEditing = true\n\t\t// if the file is already open, ensure it's not dirty before getting its contents\n\t\tif (fileExists) {\n\t\t\tconst existingDocument = vscode.workspace.textDocuments.find((doc) =>\n\t\t\t\tarePathsEqual(doc.uri.fsPath, absolutePath),\n\t\t\t)\n\t\t\tif (existingDocument && existingDocument.isDirty) {\n\t\t\t\tawait existingDocument.save()\n\t\t\t}\n\t\t}\n\n\t\t// get diagnostics before editing the file, we'll compare to diagnostics after editing to see if cline needs to fix anything\n\t\tthis.preDiagnostics = vscode.languages.getDiagnostics()\n\n\t\tif (fileExists) {\n\t\t\tthis.originalContent = await fs.readFile(absolutePath, \"utf-8\")\n\t\t} else {\n\t\t\tthis.originalContent = \"\"\n\t\t}\n\t\t// for new files, create any necessary directories and keep track of new directories to delete if the user denies the operation\n\t\tthis.createdDirs = await createDirectoriesForFile(absolutePath)\n\t\t// make sure the file exists before we open it\n\t\tif (!fileExists) {\n\t\t\tawait fs.writeFile(absolutePath, \"\")\n\t\t}\n\t\t// if the file was already open, close it (must happen after showing the diff view since if it's the only tab the column will close)\n\t\tthis.documentWasOpen = false\n\t\t// close the tab if it's open (it's already saved above)\n\t\tconst tabs = vscode.window.tabGroups.all\n\t\t\t.map((tg) => tg.tabs)\n\t\t\t.flat()\n\t\t\t.filter(\n\t\t\t\t(tab) => tab.input instanceof vscode.TabInputText && arePathsEqual(tab.input.uri.fsPath, absolutePath),\n\t\t\t)\n\t\tfor (const tab of tabs) {\n\t\t\tif (!tab.isDirty) {\n\t\t\t\tawait vscode.window.tabGroups.close(tab)\n\t\t\t}\n\t\t\tthis.documentWasOpen = true\n\t\t}\n\t\tthis.activeDiffEditor = await this.openDiffEditor()\n\t\tthis.fadedOverlayController = new DecorationController(\"fadedOverlay\", this.activeDiffEditor)\n\t\tthis.activeLineController = new DecorationController(\"activeLine\", this.activeDiffEditor)\n\t\t// Apply faded overlay to all lines initially\n\t\tthis.fadedOverlayController.addLines(0, this.activeDiffEditor.document.lineCount)\n\t\tthis.scrollEditorToLine(0) // will this crash for new files?\n\t\tthis.streamedLines = []\n\t}\n\n\tasync update(accumulatedContent: string, isFinal: boolean) {\n\t\tif (!this.relPath || !this.activeLineController || !this.fadedOverlayController) {\n\t\t\tthrow new Error(\"Required values not set\")\n\t\t}\n\t\tthis.newContent = accumulatedContent\n\t\tconst accumulatedLines = accumulatedContent.split(\"\\n\")\n\t\tif (!isFinal) {\n\t\t\taccumulatedLines.pop() // remove the last partial line only if it's not the final update\n\t\t}\n\t\tconst diffLines = accumulatedLines.slice(this.streamedLines.length)\n\n\t\tconst diffEditor = this.activeDiffEditor\n\t\tconst document = diffEditor?.document\n\t\tif (!diffEditor || !document) {\n\t\t\tthrow new Error(\"User closed text editor, unable to edit file...\")\n\t\t}\n\n\t\t// Place cursor at the beginning of the diff editor to keep it out of the way of the stream animation\n\t\tconst beginningOfDocument = new vscode.Position(0, 0)\n\t\tdiffEditor.selection = new vscode.Selection(beginningOfDocument, beginningOfDocument)\n\n\t\tfor (let i = 0; i < diffLines.length; i++) {\n\t\t\tconst currentLine = this.streamedLines.length + i\n\t\t\t// Replace all content up to the current line with accumulated lines\n\t\t\t// This is necessary (as compared to inserting one line at a time) to handle cases where html tags on previous lines are auto closed for example\n\t\t\tconst edit = new vscode.WorkspaceEdit()\n\t\t\tconst rangeToReplace = new vscode.Range(0, 0, currentLine + 1, 0)\n\t\t\tconst contentToReplace = accumulatedLines.slice(0, currentLine + 1).join(\"\\n\") + \"\\n\"\n\t\t\tedit.replace(document.uri, rangeToReplace, contentToReplace)\n\t\t\tawait vscode.workspace.applyEdit(edit)\n\t\t\t// Update decorations\n\t\t\tthis.activeLineController.setActiveLine(currentLine)\n\t\t\tthis.fadedOverlayController.updateOverlayAfterLine(currentLine, document.lineCount)\n\t\t\t// Scroll to the current line\n\t\t\tthis.scrollEditorToLine(currentLine)\n\t\t}\n\t\t// Update the streamedLines with the new accumulated content\n\t\tthis.streamedLines = accumulatedLines\n\t\tif (isFinal) {\n\t\t\t// Handle any remaining lines if the new content is shorter than the original\n\t\t\tif (this.streamedLines.length < document.lineCount) {\n\t\t\t\tconst edit = new vscode.WorkspaceEdit()\n\t\t\t\tedit.delete(document.uri, new vscode.Range(this.streamedLines.length, 0, document.lineCount, 0))\n\t\t\t\tawait vscode.workspace.applyEdit(edit)\n\t\t\t}\n\t\t\t// Add empty last line if original content had one\n\t\t\tconst hasEmptyLastLine = this.originalContent?.endsWith(\"\\n\")\n\t\t\tif (hasEmptyLastLine) {\n\t\t\t\tconst accumulatedLines = accumulatedContent.split(\"\\n\")\n\t\t\t\tif (accumulatedLines[accumulatedLines.length - 1] !== \"\") {\n\t\t\t\t\taccumulatedContent += \"\\n\"\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Clear all decorations at the end (before applying final edit)\n\t\t\tthis.fadedOverlayController.clear()\n\t\t\tthis.activeLineController.clear()\n\t\t}\n\t}\n\n\tasync saveChanges(): Promise<{\n\t\tnewProblemsMessage: string | undefined\n\t\tuserEdits: string | undefined\n\t\tfinalContent: string | undefined\n\t}> {\n\t\tif (!this.relPath || !this.newContent || !this.activeDiffEditor) {\n\t\t\treturn { newProblemsMessage: undefined, userEdits: undefined, finalContent: undefined }\n\t\t}\n\t\tconst absolutePath = path.resolve(this.cwd, this.relPath)\n\t\tconst updatedDocument = this.activeDiffEditor.document\n\t\tconst editedContent = updatedDocument.getText()\n\t\tif (updatedDocument.isDirty) {\n\t\t\tawait updatedDocument.save()\n\t\t}\n\n\t\tawait vscode.window.showTextDocument(vscode.Uri.file(absolutePath), { preview: false })\n\t\tawait this.closeAllDiffViews()\n\n\t\t/*\n\t\tGetting diagnostics before and after the file edit is a better approach than\n\t\tautomatically tracking problems in real-time. This method ensures we only\n\t\treport new problems that are a direct result of this specific edit.\n\t\tSince these are new problems resulting from Cline's edit, we know they're\n\t\tdirectly related to the work he's doing. This eliminates the risk of Cline\n\t\tgoing off-task or getting distracted by unrelated issues, which was a problem\n\t\twith the previous auto-debug approach. Some users' machines may be slow to\n\t\tupdate diagnostics, so this approach provides a good balance between automation\n\t\tand avoiding potential issues where Cline might get stuck in loops due to\n\t\toutdated problem information. If no new problems show up by the time the user\n\t\taccepts the changes, they can always debug later using the '@problems' mention.\n\t\tThis way, Cline only becomes aware of new problems resulting from his edits\n\t\tand can address them accordingly. If problems don't change immediately after\n\t\tapplying a fix, Cline won't be notified, which is generally fine since the\n\t\tinitial fix is usually correct and it may just take time for linters to catch up.\n\t\t*/\n\t\tconst postDiagnostics = vscode.languages.getDiagnostics()\n\t\tconst newProblems = diagnosticsToProblemsString(\n\t\t\tgetNewDiagnostics(this.preDiagnostics, postDiagnostics),\n\t\t\t[\n\t\t\t\tvscode.DiagnosticSeverity.Error, // only including errors since warnings can be distracting (if user wants to fix warnings they can use the @problems mention)\n\t\t\t],\n\t\t\tthis.cwd,\n\t\t) // will be empty string if no errors\n\t\tconst newProblemsMessage =\n\t\t\tnewProblems.length > 0 ? `\\n\\nNew problems detected after saving the file:\\n${newProblems}` : \"\"\n\n\t\t// If the edited content has different EOL characters, we don't want to show a diff with all the EOL differences.\n\t\tconst newContentEOL = this.newContent.includes(\"\\r\\n\") ? \"\\r\\n\" : \"\\n\"\n\t\tconst normalizedEditedContent = editedContent.replace(/\\r\\n|\\n/g, newContentEOL).trimEnd() + newContentEOL // trimEnd to fix issue where editor adds in extra new line automatically\n\t\t// just in case the new content has a mix of varying EOL characters\n\t\tconst normalizedNewContent = this.newContent.replace(/\\r\\n|\\n/g, newContentEOL).trimEnd() + newContentEOL\n\t\tif (normalizedEditedContent !== normalizedNewContent) {\n\t\t\t// user made changes before approving edit\n\t\t\tconst userEdits = formatResponse.createPrettyPatch(\n\t\t\t\tthis.relPath.toPosix(),\n\t\t\t\tnormalizedNewContent,\n\t\t\t\tnormalizedEditedContent,\n\t\t\t)\n\t\t\treturn { newProblemsMessage, userEdits, finalContent: normalizedEditedContent }\n\t\t} else {\n\t\t\t// no changes to cline's edits\n\t\t\treturn { newProblemsMessage, userEdits: undefined, finalContent: normalizedEditedContent }\n\t\t}\n\t}\n\n\tasync revertChanges(): Promise<void> {\n\t\tif (!this.relPath || !this.activeDiffEditor) {\n\t\t\treturn\n\t\t}\n\t\tconst fileExists = this.editType === \"modify\"\n\t\tconst updatedDocument = this.activeDiffEditor.document\n\t\tconst absolutePath = path.resolve(this.cwd, this.relPath)\n\t\tif (!fileExists) {\n\t\t\tif (updatedDocument.isDirty) {\n\t\t\t\tawait updatedDocument.save()\n\t\t\t}\n\t\t\tawait this.closeAllDiffViews()\n\t\t\tawait fs.unlink(absolutePath)\n\t\t\t// Remove only the directories we created, in reverse order\n\t\t\tfor (let i = this.createdDirs.length - 1; i >= 0; i--) {\n\t\t\t\tawait fs.rmdir(this.createdDirs[i])\n\t\t\t\tconsole.log(`Directory ${this.createdDirs[i]} has been deleted.`)\n\t\t\t}\n\t\t\tconsole.log(`File ${absolutePath} has been deleted.`)\n\t\t} else {\n\t\t\t// revert document\n\t\t\tconst edit = new vscode.WorkspaceEdit()\n\t\t\tconst fullRange = new vscode.Range(\n\t\t\t\tupdatedDocument.positionAt(0),\n\t\t\t\tupdatedDocument.positionAt(updatedDocument.getText().length),\n\t\t\t)\n\t\t\tedit.replace(updatedDocument.uri, fullRange, this.originalContent ?? \"\")\n\t\t\t// Apply the edit and save, since contents shouldnt have changed this wont show in local history unless of course the user made changes and saved during the edit\n\t\t\tawait vscode.workspace.applyEdit(edit)\n\t\t\tawait updatedDocument.save()\n\t\t\tconsole.log(`File ${absolutePath} has been reverted to its original content.`)\n\t\t\tif (this.documentWasOpen) {\n\t\t\t\tawait vscode.window.showTextDocument(vscode.Uri.file(absolutePath), {\n\t\t\t\t\tpreview: false,\n\t\t\t\t})\n\t\t\t}\n\t\t\tawait this.closeAllDiffViews()\n\t\t}\n\n\t\t// edit is done\n\t\tawait this.reset()\n\t}\n\n\tprivate async closeAllDiffViews() {\n\t\tconst tabs = vscode.window.tabGroups.all\n\t\t\t.flatMap((tg) => tg.tabs)\n\t\t\t.filter(\n\t\t\t\t(tab) =>\n\t\t\t\t\ttab.input instanceof vscode.TabInputTextDiff &&\n\t\t\t\t\ttab.input?.original?.scheme === DIFF_VIEW_URI_SCHEME,\n\t\t\t)\n\t\tfor (const tab of tabs) {\n\t\t\t// trying to close dirty views results in save popup\n\t\t\tif (!tab.isDirty) {\n\t\t\t\tawait vscode.window.tabGroups.close(tab)\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async openDiffEditor(): Promise<vscode.TextEditor> {\n\t\tif (!this.relPath) {\n\t\t\tthrow new Error(\"No file path set\")\n\t\t}\n\t\tconst uri = vscode.Uri.file(path.resolve(this.cwd, this.relPath))\n\t\t// If this diff editor is already open (ie if a previous write file was interrupted) then we should activate that instead of opening a new diff\n\t\tconst diffTab = vscode.window.tabGroups.all\n\t\t\t.flatMap((group) => group.tabs)\n\t\t\t.find(\n\t\t\t\t(tab) =>\n\t\t\t\t\ttab.input instanceof vscode.TabInputTextDiff &&\n\t\t\t\t\ttab.input?.original?.scheme === DIFF_VIEW_URI_SCHEME &&\n\t\t\t\t\tarePathsEqual(tab.input.modified.fsPath, uri.fsPath),\n\t\t\t)\n\t\tif (diffTab && diffTab.input instanceof vscode.TabInputTextDiff) {\n\t\t\tconst editor = await vscode.window.showTextDocument(diffTab.input.modified)\n\t\t\treturn editor\n\t\t}\n\t\t// Open new diff editor\n\t\treturn new Promise<vscode.TextEditor>((resolve, reject) => {\n\t\t\tconst fileName = path.basename(uri.fsPath)\n\t\t\tconst fileExists = this.editType === \"modify\"\n\t\t\tconst disposable = vscode.window.onDidChangeActiveTextEditor((editor) => {\n\t\t\t\tif (editor && arePathsEqual(editor.document.uri.fsPath, uri.fsPath)) {\n\t\t\t\t\tdisposable.dispose()\n\t\t\t\t\tresolve(editor)\n\t\t\t\t}\n\t\t\t})\n\t\t\tvscode.commands.executeCommand(\n\t\t\t\t\"vscode.diff\",\n\t\t\t\tvscode.Uri.parse(`${DIFF_VIEW_URI_SCHEME}:${fileName}`).with({\n\t\t\t\t\tquery: Buffer.from(this.originalContent ?? \"\").toString(\"base64\"),\n\t\t\t\t}),\n\t\t\t\turi,\n\t\t\t\t`${fileName}: ${fileExists ? \"Original ↔ Cline's Changes\" : \"New File\"} (Editable)`,\n\t\t\t)\n\t\t\t// This may happen on very slow machines ie project idx\n\t\t\tsetTimeout(() => {\n\t\t\t\tdisposable.dispose()\n\t\t\t\treject(new Error(\"Failed to open diff editor, please try again...\"))\n\t\t\t}, 10_000)\n\t\t})\n\t}\n\n\tprivate scrollEditorToLine(line: number) {\n\t\tif (this.activeDiffEditor) {\n\t\t\tconst scrollLine = line + 4\n\t\t\tthis.activeDiffEditor.revealRange(\n\t\t\t\tnew vscode.Range(scrollLine, 0, scrollLine, 0),\n\t\t\t\tvscode.TextEditorRevealType.InCenter,\n\t\t\t)\n\t\t}\n\t}\n\n\tscrollToFirstDiff() {\n\t\tif (!this.activeDiffEditor) {\n\t\t\treturn\n\t\t}\n\t\tconst currentContent = this.activeDiffEditor.document.getText()\n\t\tconst diffs = diff.diffLines(this.originalContent || \"\", currentContent)\n\t\tlet lineCount = 0\n\t\tfor (const part of diffs) {\n\t\t\tif (part.added || part.removed) {\n\t\t\t\t// Found the first diff, scroll to it\n\t\t\t\tthis.activeDiffEditor.revealRange(\n\t\t\t\t\tnew vscode.Range(lineCount, 0, lineCount, 0),\n\t\t\t\t\tvscode.TextEditorRevealType.InCenter,\n\t\t\t\t)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif (!part.removed) {\n\t\t\t\tlineCount += part.count || 0\n\t\t\t}\n\t\t}\n\t}\n\n\t// close editor if open?\n\tasync reset() {\n\t\tthis.editType = undefined\n\t\tthis.isEditing = false\n\t\tthis.originalContent = undefined\n\t\tthis.createdDirs = []\n\t\tthis.documentWasOpen = false\n\t\tthis.activeDiffEditor = undefined\n\t\tthis.fadedOverlayController = undefined\n\t\tthis.activeLineController = undefined\n\t\tthis.streamedLines = []\n\t\tthis.preDiagnostics = []\n\t}\n}\n", "tag": "", "tokens": 4076, "metadata": {}}], "modify_time": 1733144568.7233915}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/editor/DecorationController.ts", "relative_path": "cline/src/integrations/editor/DecorationController.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/integrations/editor/DecorationController.ts", "source_code": "import * as vscode from \"vscode\"\n\nconst fadedOverlayDecorationType = vscode.window.createTextEditorDecorationType({\n\tbackgroundColor: \"rgba(255, 255, 0, 0.1)\",\n\topacity: \"0.4\",\n\tisWholeLine: true,\n})\n\nconst activeLineDecorationType = vscode.window.createTextEditorDecorationType({\n\tbackgroundColor: \"rgba(255, 255, 0, 0.3)\",\n\topacity: \"1\",\n\tisWholeLine: true,\n\tborder: \"1px solid rgba(255, 255, 0, 0.5)\",\n})\n\ntype DecorationType = \"fadedOverlay\" | \"activeLine\"\n\nexport class DecorationController {\n\tprivate decorationType: DecorationType\n\tprivate editor: vscode.TextEditor\n\tprivate ranges: vscode.Range[] = []\n\n\tconstructor(decorationType: DecorationType, editor: vscode.TextEditor) {\n\t\tthis.decorationType = decorationType\n\t\tthis.editor = editor\n\t}\n\n\tgetDecoration() {\n\t\tswitch (this.decorationType) {\n\t\t\tcase \"fadedOverlay\":\n\t\t\t\treturn fadedOverlayDecorationType\n\t\t\tcase \"activeLine\":\n\t\t\t\treturn activeLineDecorationType\n\t\t}\n\t}\n\n\taddLines(startIndex: number, numLines: number) {\n\t\t// Guard against invalid inputs\n\t\tif (startIndex < 0 || numLines <= 0) {\n\t\t\treturn\n\t\t}\n\n\t\tconst lastRange = this.ranges[this.ranges.length - 1]\n\t\tif (lastRange && lastRange.end.line === startIndex - 1) {\n\t\t\tthis.ranges[this.ranges.length - 1] = lastRange.with(undefined, lastRange.end.translate(numLines))\n\t\t} else {\n\t\t\tconst endLine = startIndex + numLines - 1\n\t\t\tthis.ranges.push(new vscode.Range(startIndex, 0, endLine, Number.MAX_SAFE_INTEGER))\n\t\t}\n\n\t\tthis.editor.setDecorations(this.getDecoration(), this.ranges)\n\t}\n\n\tclear() {\n\t\tthis.ranges = []\n\t\tthis.editor.setDecorations(this.getDecoration(), this.ranges)\n\t}\n\n\tupdateOverlayAfterLine(line: number, totalLines: number) {\n\t\t// Remove any existing ranges that start at or after the current line\n\t\tthis.ranges = this.ranges.filter((range) => range.end.line < line)\n\n\t\t// Add a new range for all lines after the current line\n\t\tif (line < totalLines - 1) {\n\t\t\tthis.ranges.push(\n\t\t\t\tnew vscode.Range(\n\t\t\t\t\tnew vscode.Position(line + 1, 0),\n\t\t\t\t\tnew vscode.Position(totalLines - 1, Number.MAX_SAFE_INTEGER),\n\t\t\t\t),\n\t\t\t)\n\t\t}\n\n\t\t// Apply the updated decorations\n\t\tthis.editor.setDecorations(this.getDecoration(), this.ranges)\n\t}\n\n\tsetActiveLine(line: number) {\n\t\tthis.ranges = [new vscode.Range(line, 0, line, Number.MAX_SAFE_INTEGER)]\n\t\tthis.editor.setDecorations(this.getDecoration(), this.ranges)\n\t}\n}\n", "tag": "", "tokens": 769, "metadata": {}}], "modify_time": 1733144568.7232215}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/index.ts", "relative_path": "cline/src/api/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/index.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport { ApiConfiguration, ModelInfo } from \"../shared/api\"\nimport { AnthropicHandler } from \"./providers/anthropic\"\nimport { AwsBedrockHandler } from \"./providers/bedrock\"\nimport { OpenRouterHandler } from \"./providers/openrouter\"\nimport { VertexHandler } from \"./providers/vertex\"\nimport { OpenAiHandler } from \"./providers/openai\"\nimport { OllamaHandler } from \"./providers/ollama\"\nimport { LmStudioHandler } from \"./providers/lmstudio\"\nimport { GeminiHandler } from \"./providers/gemini\"\nimport { OpenAiNativeHandler } from \"./providers/openai-native\"\nimport { ApiStream } from \"./transform/stream\"\n\nexport interface ApiHandler {\n\tcreateMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream\n\tgetModel(): { id: string; info: ModelInfo }\n}\n\nexport function buildApiHandler(configuration: ApiConfiguration): ApiHandler {\n\tconst { apiProvider, ...options } = configuration\n\tswitch (apiProvider) {\n\t\tcase \"anthropic\":\n\t\t\treturn new AnthropicHandler(options)\n\t\tcase \"openrouter\":\n\t\t\treturn new OpenRouterHandler(options)\n\t\tcase \"bedrock\":\n\t\t\treturn new AwsBedrockHandler(options)\n\t\tcase \"vertex\":\n\t\t\treturn new VertexHandler(options)\n\t\tcase \"openai\":\n\t\t\treturn new OpenAiHandler(options)\n\t\tcase \"ollama\":\n\t\t\treturn new OllamaHandler(options)\n\t\tcase \"lmstudio\":\n\t\t\treturn new LmStudioHandler(options)\n\t\tcase \"gemini\":\n\t\t\treturn new GeminiHandler(options)\n\t\tcase \"openai-native\":\n\t\t\treturn new OpenAiNativeHandler(options)\n\t\tdefault:\n\t\t\treturn new AnthropicHandler(options)\n\t}\n}\n", "tag": "", "tokens": 431, "metadata": {}}], "modify_time": 1733144568.7174754}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/bedrock.ts", "relative_path": "cline/src/api/providers/bedrock.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/bedrock.ts", "source_code": "import AnthropicBedrock from \"@anthropic-ai/bedrock-sdk\"\nimport { Anthropic } from \"@anthropic-ai/sdk\"\nimport { ApiHandler } from \"../\"\nimport { ApiHandlerOptions, bedrockDefaultModelId, BedrockModelId, bedrockModels, ModelInfo } from \"../../shared/api\"\nimport { ApiStream } from \"../transform/stream\"\n\n// https://docs.anthropic.com/en/api/claude-on-amazon-bedrock\nexport class AwsBedrockHandler implements ApiHandler {\n\tprivate options: ApiHandlerOptions\n\tprivate client: AnthropicBedrock\n\n\tconstructor(options: ApiHandlerOptions) {\n\t\tthis.options = options\n\t\tthis.client = new AnthropicBedrock({\n\t\t\t// Authenticate by either providing the keys below or use the default AWS credential providers, such as\n\t\t\t// using ~/.aws/credentials or the \"AWS_SECRET_ACCESS_KEY\" and \"AWS_ACCESS_KEY_ID\" environment variables.\n\t\t\t...(this.options.awsAccessKey ? { awsAccessKey: this.options.awsAccessKey } : {}),\n\t\t\t...(this.options.awsSecretKey ? { awsSecretKey: this.options.awsSecretKey } : {}),\n\t\t\t...(this.options.awsSessionToken ? { awsSessionToken: this.options.awsSessionToken } : {}),\n\n\t\t\t// awsRegion changes the aws region to which the request is made. By default, we read AWS_REGION,\n\t\t\t// and if that's not present, we default to us-east-1. Note that we do not read ~/.aws/config for the region.\n\t\t\tawsRegion: this.options.awsRegion,\n\t\t})\n\t}\n\n\tasync *createMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream {\n\t\t// cross region inference requires prefixing the model id with the region\n\t\tlet modelId: string\n\t\tif (this.options.awsUseCrossRegionInference) {\n\t\t\tlet regionPrefix = (this.options.awsRegion || \"\").slice(0, 3)\n\t\t\tswitch (regionPrefix) {\n\t\t\t\tcase \"us-\":\n\t\t\t\t\tmodelId = `us.${this.getModel().id}`\n\t\t\t\t\tbreak\n\t\t\t\tcase \"eu-\":\n\t\t\t\t\tmodelId = `eu.${this.getModel().id}`\n\t\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\t// cross region inference is not supported in this region, falling back to default model\n\t\t\t\t\tmodelId = this.getModel().id\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t} else {\n\t\t\tmodelId = this.getModel().id\n\t\t}\n\n\t\tconst stream = await this.client.messages.create({\n\t\t\tmodel: modelId,\n\t\t\tmax_tokens: this.getModel().info.maxTokens || 8192,\n\t\t\ttemperature: 0,\n\t\t\tsystem: systemPrompt,\n\t\t\tmessages,\n\t\t\tstream: true,\n\t\t})\n\t\tfor await (const chunk of stream) {\n\t\t\tswitch (chunk.type) {\n\t\t\t\tcase \"message_start\":\n\t\t\t\t\tconst usage = chunk.message.usage\n\t\t\t\t\tyield {\n\t\t\t\t\t\ttype: \"usage\",\n\t\t\t\t\t\tinputTokens: usage.input_tokens || 0,\n\t\t\t\t\t\toutputTokens: usage.output_tokens || 0,\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"message_delta\":\n\t\t\t\t\tyield {\n\t\t\t\t\t\ttype: \"usage\",\n\t\t\t\t\t\tinputTokens: 0,\n\t\t\t\t\t\toutputTokens: chunk.usage.output_tokens || 0,\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\n\t\t\t\tcase \"content_block_start\":\n\t\t\t\t\tswitch (chunk.content_block.type) {\n\t\t\t\t\t\tcase \"text\":\n\t\t\t\t\t\t\tif (chunk.index > 0) {\n\t\t\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\t\ttext: \"\\n\",\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\ttext: chunk.content_block.text,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"content_block_delta\":\n\t\t\t\t\tswitch (chunk.delta.type) {\n\t\t\t\t\t\tcase \"text_delta\":\n\t\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\ttext: chunk.delta.text,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tgetModel(): { id: BedrockModelId; info: ModelInfo } {\n\t\tconst modelId = this.options.apiModelId\n\t\tif (modelId && modelId in bedrockModels) {\n\t\t\tconst id = modelId as BedrockModelId\n\t\t\treturn { id, info: bedrockModels[id] }\n\t\t}\n\t\treturn { id: bedrockDefaultModelId, info: bedrockModels[bedrockDefaultModelId] }\n\t}\n}\n", "tag": "", "tokens": 1090, "metadata": {}}], "modify_time": 1733144568.7178593}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/ollama.ts", "relative_path": "cline/src/api/providers/ollama.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/ollama.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport OpenAI from \"openai\"\nimport { ApiHandler } from \"../\"\nimport { ApiHandlerOptions, ModelInfo, openAiModelInfoSaneDefaults } from \"../../shared/api\"\nimport { convertToOpenAiMessages } from \"../transform/openai-format\"\nimport { ApiStream } from \"../transform/stream\"\n\nexport class OllamaHandler implements ApiHandler {\n\tprivate options: ApiHandlerOptions\n\tprivate client: OpenAI\n\n\tconstructor(options: ApiHandlerOptions) {\n\t\tthis.options = options\n\t\tthis.client = new OpenAI({\n\t\t\tbaseURL: (this.options.ollamaBaseUrl || \"http://localhost:11434\") + \"/v1\",\n\t\t\tapiKey: \"ollama\",\n\t\t})\n\t}\n\n\tasync *createMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream {\n\t\tconst openAiMessages: OpenAI.Chat.ChatCompletionMessageParam[] = [\n\t\t\t{ role: \"system\", content: systemPrompt },\n\t\t\t...convertToOpenAiMessages(messages),\n\t\t]\n\n\t\tconst stream = await this.client.chat.completions.create({\n\t\t\tmodel: this.getModel().id,\n\t\t\tmessages: openAiMessages,\n\t\t\ttemperature: 0,\n\t\t\tstream: true,\n\t\t})\n\t\tfor await (const chunk of stream) {\n\t\t\tconst delta = chunk.choices[0]?.delta\n\t\t\tif (delta?.content) {\n\t\t\t\tyield {\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: delta.content,\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tgetModel(): { id: string; info: ModelInfo } {\n\t\treturn {\n\t\t\tid: this.options.ollamaModelId || \"\",\n\t\t\tinfo: openAiModelInfoSaneDefaults,\n\t\t}\n\t}\n}\n", "tag": "", "tokens": 443, "metadata": {}}], "modify_time": 1733144568.718275}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/openai-native.ts", "relative_path": "cline/src/api/providers/openai-native.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/openai-native.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport OpenAI from \"openai\"\nimport { ApiHandler } from \"../\"\nimport {\n\tApiHandlerOptions,\n\tModelInfo,\n\topenAiNativeDefaultModelId,\n\tOpenAiNativeModelId,\n\topenAiNativeModels,\n} from \"../../shared/api\"\nimport { convertToOpenAiMessages } from \"../transform/openai-format\"\nimport { ApiStream } from \"../transform/stream\"\n\nexport class OpenAiNativeHandler implements ApiHandler {\n\tprivate options: ApiHandlerOptions\n\tprivate client: OpenAI\n\n\tconstructor(options: ApiHandlerOptions) {\n\t\tthis.options = options\n\t\tthis.client = new OpenAI({\n\t\t\tapiKey: this.options.openAiNativeApiKey,\n\t\t})\n\t}\n\n\tasync *createMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream {\n\t\tswitch (this.getModel().id) {\n\t\t\tcase \"o1-preview\":\n\t\t\tcase \"o1-mini\": {\n\t\t\t\t// o1 doesnt support streaming, non-1 temp, or system prompt\n\t\t\t\tconst response = await this.client.chat.completions.create({\n\t\t\t\t\tmodel: this.getModel().id,\n\t\t\t\t\tmessages: [{ role: \"user\", content: systemPrompt }, ...convertToOpenAiMessages(messages)],\n\t\t\t\t})\n\t\t\t\tyield {\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: response.choices[0]?.message.content || \"\",\n\t\t\t\t}\n\t\t\t\tyield {\n\t\t\t\t\ttype: \"usage\",\n\t\t\t\t\tinputTokens: response.usage?.prompt_tokens || 0,\n\t\t\t\t\toutputTokens: response.usage?.completion_tokens || 0,\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\tconst stream = await this.client.chat.completions.create({\n\t\t\t\t\tmodel: this.getModel().id,\n\t\t\t\t\t// max_completion_tokens: this.getModel().info.maxTokens,\n\t\t\t\t\ttemperature: 0,\n\t\t\t\t\tmessages: [{ role: \"system\", content: systemPrompt }, ...convertToOpenAiMessages(messages)],\n\t\t\t\t\tstream: true,\n\t\t\t\t\tstream_options: { include_usage: true },\n\t\t\t\t})\n\n\t\t\t\tfor await (const chunk of stream) {\n\t\t\t\t\tconst delta = chunk.choices[0]?.delta\n\t\t\t\t\tif (delta?.content) {\n\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\ttext: delta.content,\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// contains a null value except for the last chunk which contains the token usage statistics for the entire request\n\t\t\t\t\tif (chunk.usage) {\n\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\ttype: \"usage\",\n\t\t\t\t\t\t\tinputTokens: chunk.usage.prompt_tokens || 0,\n\t\t\t\t\t\t\toutputTokens: chunk.usage.completion_tokens || 0,\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tgetModel(): { id: OpenAiNativeModelId; info: ModelInfo } {\n\t\tconst modelId = this.options.apiModelId\n\t\tif (modelId && modelId in openAiNativeModels) {\n\t\t\tconst id = modelId as OpenAiNativeModelId\n\t\t\treturn { id, info: openAiNativeModels[id] }\n\t\t}\n\t\treturn { id: openAiNativeDefaultModelId, info: openAiNativeModels[openAiNativeDefaultModelId] }\n\t}\n}\n", "tag": "", "tokens": 784, "metadata": {}}], "modify_time": 1733144568.7184236}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/anthropic.ts", "relative_path": "cline/src/api/providers/anthropic.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/anthropic.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport { Stream as AnthropicStream } from \"@anthropic-ai/sdk/streaming\"\nimport {\n\tanthropicDefaultModelId,\n\tAnthropicModelId,\n\tanthropicModels,\n\tApiHandlerOptions,\n\tModelInfo,\n} from \"../../shared/api\"\nimport { ApiHandler } from \"../index\"\nimport { ApiStream } from \"../transform/stream\"\n\nexport class AnthropicHandler implements ApiHandler {\n\tprivate options: ApiHandlerOptions\n\tprivate client: Anthropic\n\n\tconstructor(options: ApiHandlerOptions) {\n\t\tthis.options = options\n\t\tthis.client = new Anthropic({\n\t\t\tapiKey: this.options.apiKey,\n\t\t\tbaseURL: this.options.anthropicBaseUrl || undefined,\n\t\t})\n\t}\n\n\tasync *createMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream {\n\t\tlet stream: AnthropicStream<Anthropic.Beta.PromptCaching.Messages.RawPromptCachingBetaMessageStreamEvent>\n\t\tconst modelId = this.getModel().id\n\t\tswitch (modelId) {\n\t\t\t// 'latest' alias does not support cache_control\n\t\t\tcase \"claude-3-5-sonnet-20241022\":\n\t\t\tcase \"claude-3-5-haiku-20241022\":\n\t\t\tcase \"claude-3-opus-20240229\":\n\t\t\tcase \"claude-3-haiku-20240307\": {\n\t\t\t\t/*\n\t\t\t\tThe latest message will be the new user message, one before will be the assistant message from a previous request, and the user message before that will be a previously cached user message. So we need to mark the latest user message as ephemeral to cache it for the next request, and mark the second to last user message as ephemeral to let the server know the last message to retrieve from the cache for the current request..\n\t\t\t\t*/\n\t\t\t\tconst userMsgIndices = messages.reduce(\n\t\t\t\t\t(acc, msg, index) => (msg.role === \"user\" ? [...acc, index] : acc),\n\t\t\t\t\t[] as number[],\n\t\t\t\t)\n\t\t\t\tconst lastUserMsgIndex = userMsgIndices[userMsgIndices.length - 1] ?? -1\n\t\t\t\tconst secondLastMsgUserIndex = userMsgIndices[userMsgIndices.length - 2] ?? -1\n\t\t\t\tstream = await this.client.beta.promptCaching.messages.create(\n\t\t\t\t\t{\n\t\t\t\t\t\tmodel: modelId,\n\t\t\t\t\t\tmax_tokens: this.getModel().info.maxTokens || 8192,\n\t\t\t\t\t\ttemperature: 0,\n\t\t\t\t\t\tsystem: [{ text: systemPrompt, type: \"text\", cache_control: { type: \"ephemeral\" } }], // setting cache breakpoint for system prompt so new tasks can reuse it\n\t\t\t\t\t\tmessages: messages.map((message, index) => {\n\t\t\t\t\t\t\tif (index === lastUserMsgIndex || index === secondLastMsgUserIndex) {\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...message,\n\t\t\t\t\t\t\t\t\tcontent:\n\t\t\t\t\t\t\t\t\t\ttypeof message.content === \"string\"\n\t\t\t\t\t\t\t\t\t\t\t? [\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttext: message.content,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcache_control: { type: \"ephemeral\" },\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t\t\t\t\t: message.content.map((content, contentIndex) =>\n\t\t\t\t\t\t\t\t\t\t\t\t\tcontentIndex === message.content.length - 1\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? { ...content, cache_control: { type: \"ephemeral\" } }\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: content,\n\t\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn message\n\t\t\t\t\t\t}),\n\t\t\t\t\t\t// tools, // cache breakpoints go from tools > system > messages, and since tools dont change, we can just set the breakpoint at the end of system (this avoids having to set a breakpoint at the end of tools which by itself does not meet min requirements for haiku caching)\n\t\t\t\t\t\t// tool_choice: { type: \"auto\" },\n\t\t\t\t\t\t// tools: tools,\n\t\t\t\t\t\tstream: true,\n\t\t\t\t\t},\n\t\t\t\t\t(() => {\n\t\t\t\t\t\t// prompt caching: https://x.com/alexalbert__/status/1823751995901272068\n\t\t\t\t\t\t// https://github.com/anthropics/anthropic-sdk-typescript?tab=readme-ov-file#default-headers\n\t\t\t\t\t\t// https://github.com/anthropics/anthropic-sdk-typescript/commit/c920b77fc67bd839bfeb6716ceab9d7c9bbe7393\n\t\t\t\t\t\tswitch (modelId) {\n\t\t\t\t\t\t\tcase \"claude-3-5-sonnet-20241022\":\n\t\t\t\t\t\t\tcase \"claude-3-5-haiku-20241022\":\n\t\t\t\t\t\t\tcase \"claude-3-opus-20240229\":\n\t\t\t\t\t\t\tcase \"claude-3-haiku-20240307\":\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\theaders: { \"anthropic-beta\": \"prompt-caching-2024-07-31\" },\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\treturn undefined\n\t\t\t\t\t\t}\n\t\t\t\t\t})(),\n\t\t\t\t)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\tstream = (await this.client.messages.create({\n\t\t\t\t\tmodel: modelId,\n\t\t\t\t\tmax_tokens: this.getModel().info.maxTokens || 8192,\n\t\t\t\t\ttemperature: 0,\n\t\t\t\t\tsystem: [{ text: systemPrompt, type: \"text\" }],\n\t\t\t\t\tmessages,\n\t\t\t\t\t// tools,\n\t\t\t\t\t// tool_choice: { type: \"auto\" },\n\t\t\t\t\tstream: true,\n\t\t\t\t})) as any\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\n\t\tfor await (const chunk of stream) {\n\t\t\tswitch (chunk.type) {\n\t\t\t\tcase \"message_start\":\n\t\t\t\t\t// tells us cache reads/writes/input/output\n\t\t\t\t\tconst usage = chunk.message.usage\n\t\t\t\t\tyield {\n\t\t\t\t\t\ttype: \"usage\",\n\t\t\t\t\t\tinputTokens: usage.input_tokens || 0,\n\t\t\t\t\t\toutputTokens: usage.output_tokens || 0,\n\t\t\t\t\t\tcacheWriteTokens: usage.cache_creation_input_tokens || undefined,\n\t\t\t\t\t\tcacheReadTokens: usage.cache_read_input_tokens || undefined,\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"message_delta\":\n\t\t\t\t\t// tells us stop_reason, stop_sequence, and output tokens along the way and at the end of the message\n\n\t\t\t\t\tyield {\n\t\t\t\t\t\ttype: \"usage\",\n\t\t\t\t\t\tinputTokens: 0,\n\t\t\t\t\t\toutputTokens: chunk.usage.output_tokens || 0,\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"message_stop\":\n\t\t\t\t\t// no usage data, just an indicator that the message is done\n\t\t\t\t\tbreak\n\t\t\t\tcase \"content_block_start\":\n\t\t\t\t\tswitch (chunk.content_block.type) {\n\t\t\t\t\t\tcase \"text\":\n\t\t\t\t\t\t\t// we may receive multiple text blocks, in which case just insert a line break between them\n\t\t\t\t\t\t\tif (chunk.index > 0) {\n\t\t\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\t\ttext: \"\\n\",\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\ttext: chunk.content_block.text,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"content_block_delta\":\n\t\t\t\t\tswitch (chunk.delta.type) {\n\t\t\t\t\t\tcase \"text_delta\":\n\t\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\ttext: chunk.delta.text,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"content_block_stop\":\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tgetModel(): { id: AnthropicModelId; info: ModelInfo } {\n\t\tconst modelId = this.options.apiModelId\n\t\tif (modelId && modelId in anthropicModels) {\n\t\t\tconst id = modelId as AnthropicModelId\n\t\t\treturn { id, info: anthropicModels[id] }\n\t\t}\n\t\treturn { id: anthropicDefaultModelId, info: anthropicModels[anthropicDefaultModelId] }\n\t}\n}\n", "tag": "", "tokens": 1911, "metadata": {}}], "modify_time": 1733144568.7176754}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/openai.ts", "relative_path": "cline/src/api/providers/openai.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/openai.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport OpenAI, { AzureOpenAI } from \"openai\"\nimport {\n\tApiHandlerOptions,\n\tazureOpenAiDefaultApiVersion,\n\tModelInfo,\n\topenAiModelInfoSaneDefaults,\n} from \"../../shared/api\"\nimport { ApiHandler } from \"../index\"\nimport { convertToOpenAiMessages } from \"../transform/openai-format\"\nimport { ApiStream } from \"../transform/stream\"\n\nexport class OpenAiHandler implements ApiHandler {\n\tprivate options: ApiHandlerOptions\n\tprivate client: OpenAI\n\n\tconstructor(options: ApiHandlerOptions) {\n\t\tthis.options = options\n\t\t// Azure API shape slightly differs from the core API shape: https://github.com/openai/openai-node?tab=readme-ov-file#microsoft-azure-openai\n\t\tif (this.options.openAiBaseUrl?.toLowerCase().includes(\"azure.com\")) {\n\t\t\tthis.client = new AzureOpenAI({\n\t\t\t\tbaseURL: this.options.openAiBaseUrl,\n\t\t\t\tapiKey: this.options.openAiApiKey,\n\t\t\t\tapiVersion: this.options.azureApiVersion || azureOpenAiDefaultApiVersion,\n\t\t\t})\n\t\t} else {\n\t\t\tthis.client = new OpenAI({\n\t\t\t\tbaseURL: this.options.openAiBaseUrl,\n\t\t\t\tapiKey: this.options.openAiApiKey,\n\t\t\t})\n\t\t}\n\t}\n\n\tasync *createMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream {\n\t\tconst openAiMessages: OpenAI.Chat.ChatCompletionMessageParam[] = [\n\t\t\t{ role: \"system\", content: systemPrompt },\n\t\t\t...convertToOpenAiMessages(messages),\n\t\t]\n\t\tconst stream = await this.client.chat.completions.create({\n\t\t\tmodel: this.options.openAiModelId ?? \"\",\n\t\t\tmessages: openAiMessages,\n\t\t\ttemperature: 0,\n\t\t\tstream: true,\n\t\t\tstream_options: { include_usage: true },\n\t\t})\n\t\tfor await (const chunk of stream) {\n\t\t\tconst delta = chunk.choices[0]?.delta\n\t\t\tif (delta?.content) {\n\t\t\t\tyield {\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: delta.content,\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (chunk.usage) {\n\t\t\t\tyield {\n\t\t\t\t\ttype: \"usage\",\n\t\t\t\t\tinputTokens: chunk.usage.prompt_tokens || 0,\n\t\t\t\t\toutputTokens: chunk.usage.completion_tokens || 0,\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tgetModel(): { id: string; info: ModelInfo } {\n\t\treturn {\n\t\t\tid: this.options.openAiModelId ?? \"\",\n\t\t\tinfo: openAiModelInfoSaneDefaults,\n\t\t}\n\t}\n}\n", "tag": "", "tokens": 667, "metadata": {}}], "modify_time": 1733144568.71853}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/vertex.ts", "relative_path": "cline/src/api/providers/vertex.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/vertex.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport { AnthropicVertex } from \"@anthropic-ai/vertex-sdk\"\nimport { ApiHandler } from \"../\"\nimport { ApiHandlerOptions, ModelInfo, vertexDefaultModelId, VertexModelId, vertexModels } from \"../../shared/api\"\nimport { ApiStream } from \"../transform/stream\"\n\n// https://docs.anthropic.com/en/api/claude-on-vertex-ai\nexport class VertexHandler implements ApiHandler {\n\tprivate options: ApiHandlerOptions\n\tprivate client: AnthropicVertex\n\n\tconstructor(options: ApiHandlerOptions) {\n\t\tthis.options = options\n\t\tthis.client = new AnthropicVertex({\n\t\t\tprojectId: this.options.vertexProjectId,\n\t\t\t// https://cloud.google.com/vertex-ai/generative-ai/docs/partner-models/use-claude#regions\n\t\t\tregion: this.options.vertexRegion,\n\t\t})\n\t}\n\n\tasync *createMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream {\n\t\tconst stream = await this.client.messages.create({\n\t\t\tmodel: this.getModel().id,\n\t\t\tmax_tokens: this.getModel().info.maxTokens || 8192,\n\t\t\ttemperature: 0,\n\t\t\tsystem: systemPrompt,\n\t\t\tmessages,\n\t\t\tstream: true,\n\t\t})\n\t\tfor await (const chunk of stream) {\n\t\t\tswitch (chunk.type) {\n\t\t\t\tcase \"message_start\":\n\t\t\t\t\tconst usage = chunk.message.usage\n\t\t\t\t\tyield {\n\t\t\t\t\t\ttype: \"usage\",\n\t\t\t\t\t\tinputTokens: usage.input_tokens || 0,\n\t\t\t\t\t\toutputTokens: usage.output_tokens || 0,\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"message_delta\":\n\t\t\t\t\tyield {\n\t\t\t\t\t\ttype: \"usage\",\n\t\t\t\t\t\tinputTokens: 0,\n\t\t\t\t\t\toutputTokens: chunk.usage.output_tokens || 0,\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\n\t\t\t\tcase \"content_block_start\":\n\t\t\t\t\tswitch (chunk.content_block.type) {\n\t\t\t\t\t\tcase \"text\":\n\t\t\t\t\t\t\tif (chunk.index > 0) {\n\t\t\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\t\ttext: \"\\n\",\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\ttext: chunk.content_block.text,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase \"content_block_delta\":\n\t\t\t\t\tswitch (chunk.delta.type) {\n\t\t\t\t\t\tcase \"text_delta\":\n\t\t\t\t\t\t\tyield {\n\t\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\t\ttext: chunk.delta.text,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tgetModel(): { id: VertexModelId; info: ModelInfo } {\n\t\tconst modelId = this.options.apiModelId\n\t\tif (modelId && modelId in vertexModels) {\n\t\t\tconst id = modelId as VertexModelId\n\t\t\treturn { id, info: vertexModels[id] }\n\t\t}\n\t\treturn { id: vertexDefaultModelId, info: vertexModels[vertexDefaultModelId] }\n\t}\n}\n", "tag": "", "tokens": 745, "metadata": {}}], "modify_time": 1733144568.7187674}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/gemini.ts", "relative_path": "cline/src/api/providers/gemini.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/gemini.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport { GoogleGenerativeAI } from \"@google/generative-ai\"\nimport { ApiHandler } from \"../\"\nimport { ApiHandlerOptions, geminiDefaultModelId, GeminiModelId, geminiModels, ModelInfo } from \"../../shared/api\"\nimport { convertAnthropicMessageToGemini } from \"../transform/gemini-format\"\nimport { ApiStream } from \"../transform/stream\"\n\nexport class GeminiHandler implements ApiHandler {\n\tprivate options: ApiHandlerOptions\n\tprivate client: GoogleGenerativeAI\n\n\tconstructor(options: ApiHandlerOptions) {\n\t\tif (!options.geminiApiKey) {\n\t\t\tthrow new Error(\"API key is required for Google Gemini\")\n\t\t}\n\t\tthis.options = options\n\t\tthis.client = new GoogleGenerativeAI(options.geminiApiKey)\n\t}\n\n\tasync *createMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream {\n\t\tconst model = this.client.getGenerativeModel({\n\t\t\tmodel: this.getModel().id,\n\t\t\tsystemInstruction: systemPrompt,\n\t\t})\n\t\tconst result = await model.generateContentStream({\n\t\t\tcontents: messages.map(convertAnthropicMessageToGemini),\n\t\t\tgenerationConfig: {\n\t\t\t\t// maxOutputTokens: this.getModel().info.maxTokens,\n\t\t\t\ttemperature: 0,\n\t\t\t},\n\t\t})\n\n\t\tfor await (const chunk of result.stream) {\n\t\t\tyield {\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: chunk.text(),\n\t\t\t}\n\t\t}\n\n\t\tconst response = await result.response\n\t\tyield {\n\t\t\ttype: \"usage\",\n\t\t\tinputTokens: response.usageMetadata?.promptTokenCount ?? 0,\n\t\t\toutputTokens: response.usageMetadata?.candidatesTokenCount ?? 0,\n\t\t}\n\t}\n\n\tgetModel(): { id: GeminiModelId; info: ModelInfo } {\n\t\tconst modelId = this.options.apiModelId\n\t\tif (modelId && modelId in geminiModels) {\n\t\t\tconst id = modelId as GeminiModelId\n\t\t\treturn { id, info: geminiModels[id] }\n\t\t}\n\t\treturn { id: geminiDefaultModelId, info: geminiModels[geminiDefaultModelId] }\n\t}\n}\n", "tag": "", "tokens": 543, "metadata": {}}], "modify_time": 1733144568.7180037}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/openrouter.ts", "relative_path": "cline/src/api/providers/openrouter.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/openrouter.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport axios from \"axios\"\nimport OpenAI from \"openai\"\nimport { ApiHandler } from \"../\"\nimport { ApiHandlerOptions, ModelInfo, openRouterDefaultModelId, openRouterDefaultModelInfo } from \"../../shared/api\"\nimport { convertToOpenAiMessages } from \"../transform/openai-format\"\nimport { ApiStream } from \"../transform/stream\"\nimport delay from \"delay\"\n\nexport class OpenRouterHandler implements ApiHandler {\n\tprivate options: ApiHandlerOptions\n\tprivate client: OpenAI\n\n\tconstructor(options: ApiHandlerOptions) {\n\t\tthis.options = options\n\t\tthis.client = new OpenAI({\n\t\t\tbaseURL: \"https://openrouter.ai/api/v1\",\n\t\t\tapiKey: this.options.openRouterApiKey,\n\t\t\tdefaultHeaders: {\n\t\t\t\t\"HTTP-Referer\": \"https://cline.bot\", // Optional, for including your app on openrouter.ai rankings.\n\t\t\t\t\"X-Title\": \"Cline\", // Optional. Shows in rankings on openrouter.ai.\n\t\t\t},\n\t\t})\n\t}\n\n\tasync *createMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream {\n\t\t// Convert Anthropic messages to OpenAI format\n\t\tconst openAiMessages: OpenAI.Chat.ChatCompletionMessageParam[] = [\n\t\t\t{ role: \"system\", content: systemPrompt },\n\t\t\t...convertToOpenAiMessages(messages),\n\t\t]\n\n\t\t// prompt caching: https://openrouter.ai/docs/prompt-caching\n\t\t// this is specifically for claude models (some models may 'support prompt caching' automatically without this)\n\t\tswitch (this.getModel().id) {\n\t\t\tcase \"anthropic/claude-3.5-sonnet\":\n\t\t\tcase \"anthropic/claude-3.5-sonnet:beta\":\n\t\t\tcase \"anthropic/claude-3.5-sonnet-20240620\":\n\t\t\tcase \"anthropic/claude-3.5-sonnet-20240620:beta\":\n\t\t\tcase \"anthropic/claude-3-5-haiku\":\n\t\t\tcase \"anthropic/claude-3-5-haiku:beta\":\n\t\t\tcase \"anthropic/claude-3-5-haiku-20241022\":\n\t\t\tcase \"anthropic/claude-3-5-haiku-20241022:beta\":\n\t\t\tcase \"anthropic/claude-3-haiku\":\n\t\t\tcase \"anthropic/claude-3-haiku:beta\":\n\t\t\tcase \"anthropic/claude-3-opus\":\n\t\t\tcase \"anthropic/claude-3-opus:beta\":\n\t\t\t\topenAiMessages[0] = {\n\t\t\t\t\trole: \"system\",\n\t\t\t\t\tcontent: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\ttext: systemPrompt,\n\t\t\t\t\t\t\t// @ts-ignore-next-line\n\t\t\t\t\t\t\tcache_control: { type: \"ephemeral\" },\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t}\n\t\t\t\t// Add cache_control to the last two user messages\n\t\t\t\t// (note: this works because we only ever add one user message at a time, but if we added multiple we'd need to mark the user message before the last assistant message)\n\t\t\t\tconst lastTwoUserMessages = openAiMessages.filter((msg) => msg.role === \"user\").slice(-2)\n\t\t\t\tlastTwoUserMessages.forEach((msg) => {\n\t\t\t\t\tif (typeof msg.content === \"string\") {\n\t\t\t\t\t\tmsg.content = [{ type: \"text\", text: msg.content }]\n\t\t\t\t\t}\n\t\t\t\t\tif (Array.isArray(msg.content)) {\n\t\t\t\t\t\t// NOTE: this is fine since env details will always be added at the end. but if it weren't there, and the user added a image_url type message, it would pop a text part before it and then move it after to the end.\n\t\t\t\t\t\tlet lastTextPart = msg.content.filter((part) => part.type === \"text\").pop()\n\n\t\t\t\t\t\tif (!lastTextPart) {\n\t\t\t\t\t\t\tlastTextPart = { type: \"text\", text: \"...\" }\n\t\t\t\t\t\t\tmsg.content.push(lastTextPart)\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// @ts-ignore-next-line\n\t\t\t\t\t\tlastTextPart[\"cache_control\"] = { type: \"ephemeral\" }\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tbreak\n\t\t}\n\n\t\t// Not sure how openrouter defaults max tokens when no value is provided, but the anthropic api requires this value and since they offer both 4096 and 8192 variants, we should ensure 8192.\n\t\t// (models usually default to max tokens allowed)\n\t\tlet maxTokens: number | undefined\n\t\tswitch (this.getModel().id) {\n\t\t\tcase \"anthropic/claude-3.5-sonnet\":\n\t\t\tcase \"anthropic/claude-3.5-sonnet:beta\":\n\t\t\tcase \"anthropic/claude-3.5-sonnet-20240620\":\n\t\t\tcase \"anthropic/claude-3.5-sonnet-20240620:beta\":\n\t\t\tcase \"anthropic/claude-3-5-haiku\":\n\t\t\tcase \"anthropic/claude-3-5-haiku:beta\":\n\t\t\tcase \"anthropic/claude-3-5-haiku-20241022\":\n\t\t\tcase \"anthropic/claude-3-5-haiku-20241022:beta\":\n\t\t\t\tmaxTokens = 8_192\n\t\t\t\tbreak\n\t\t}\n\t\tconst stream = await this.client.chat.completions.create({\n\t\t\tmodel: this.getModel().id,\n\t\t\tmax_tokens: maxTokens,\n\t\t\ttemperature: 0,\n\t\t\tmessages: openAiMessages,\n\t\t\tstream: true,\n\t\t})\n\n\t\tlet genId: string | undefined\n\n\t\tfor await (const chunk of stream) {\n\t\t\t// openrouter returns an error object instead of the openai sdk throwing an error\n\t\t\tif (\"error\" in chunk) {\n\t\t\t\tconst error = chunk.error as { message?: string; code?: number }\n\t\t\t\tconsole.error(`OpenRouter API Error: ${error?.code} - ${error?.message}`)\n\t\t\t\tthrow new Error(`OpenRouter API Error ${error?.code}: ${error?.message}`)\n\t\t\t}\n\n\t\t\tif (!genId && chunk.id) {\n\t\t\t\tgenId = chunk.id\n\t\t\t}\n\n\t\t\tconst delta = chunk.choices[0]?.delta\n\t\t\tif (delta?.content) {\n\t\t\t\tyield {\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: delta.content,\n\t\t\t\t}\n\t\t\t}\n\t\t\t// if (chunk.usage) {\n\t\t\t// \tyield {\n\t\t\t// \t\ttype: \"usage\",\n\t\t\t// \t\tinputTokens: chunk.usage.prompt_tokens || 0,\n\t\t\t// \t\toutputTokens: chunk.usage.completion_tokens || 0,\n\t\t\t// \t}\n\t\t\t// }\n\t\t}\n\n\t\tawait delay(500) // FIXME: necessary delay to ensure generation endpoint is ready\n\n\t\ttry {\n\t\t\tconst response = await axios.get(`https://openrouter.ai/api/v1/generation?id=${genId}`, {\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${this.options.openRouterApiKey}`,\n\t\t\t\t},\n\t\t\t\ttimeout: 5_000, // this request hangs sometimes\n\t\t\t})\n\n\t\t\tconst generation = response.data?.data\n\t\t\tconsole.log(\"OpenRouter generation details:\", response.data)\n\t\t\tyield {\n\t\t\t\ttype: \"usage\",\n\t\t\t\t// cacheWriteTokens: 0,\n\t\t\t\t// cacheReadTokens: 0,\n\t\t\t\t// openrouter generation endpoint fails often\n\t\t\t\tinputTokens: generation?.native_tokens_prompt || 0,\n\t\t\t\toutputTokens: generation?.native_tokens_completion || 0,\n\t\t\t\ttotalCost: generation?.total_cost || 0,\n\t\t\t}\n\t\t} catch (error) {\n\t\t\t// ignore if fails\n\t\t\tconsole.error(\"Error fetching OpenRouter generation details:\", error)\n\t\t}\n\t}\n\n\tgetModel(): { id: string; info: ModelInfo } {\n\t\tconst modelId = this.options.openRouterModelId\n\t\tconst modelInfo = this.options.openRouterModelInfo\n\t\tif (modelId && modelInfo) {\n\t\t\treturn { id: modelId, info: modelInfo }\n\t\t}\n\t\treturn { id: openRouterDefaultModelId, info: openRouterDefaultModelInfo }\n\t}\n}\n", "tag": "", "tokens": 2032, "metadata": {}}], "modify_time": 1733144568.7186623}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/lmstudio.ts", "relative_path": "cline/src/api/providers/lmstudio.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/providers/lmstudio.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport OpenAI from \"openai\"\nimport { ApiHandler } from \"../\"\nimport { ApiHandlerOptions, ModelInfo, openAiModelInfoSaneDefaults } from \"../../shared/api\"\nimport { convertToOpenAiMessages } from \"../transform/openai-format\"\nimport { ApiStream } from \"../transform/stream\"\n\nexport class LmStudioHandler implements ApiHandler {\n\tprivate options: ApiHandlerOptions\n\tprivate client: OpenAI\n\n\tconstructor(options: ApiHandlerOptions) {\n\t\tthis.options = options\n\t\tthis.client = new OpenAI({\n\t\t\tbaseURL: (this.options.lmStudioBaseUrl || \"http://localhost:1234\") + \"/v1\",\n\t\t\tapiKey: \"noop\",\n\t\t})\n\t}\n\n\tasync *createMessage(systemPrompt: string, messages: Anthropic.Messages.MessageParam[]): ApiStream {\n\t\tconst openAiMessages: OpenAI.Chat.ChatCompletionMessageParam[] = [\n\t\t\t{ role: \"system\", content: systemPrompt },\n\t\t\t...convertToOpenAiMessages(messages),\n\t\t]\n\n\t\ttry {\n\t\t\tconst stream = await this.client.chat.completions.create({\n\t\t\t\tmodel: this.getModel().id,\n\t\t\t\tmessages: openAiMessages,\n\t\t\t\ttemperature: 0,\n\t\t\t\tstream: true,\n\t\t\t})\n\t\t\tfor await (const chunk of stream) {\n\t\t\t\tconst delta = chunk.choices[0]?.delta\n\t\t\t\tif (delta?.content) {\n\t\t\t\t\tyield {\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: delta.content,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\t// LM Studio doesn't return an error code/body for now\n\t\t\tthrow new Error(\n\t\t\t\t\"Please check the LM Studio developer logs to debug what went wrong. You may need to load the model with a larger context length to work with Cline's prompts.\",\n\t\t\t)\n\t\t}\n\t}\n\n\tgetModel(): { id: string; info: ModelInfo } {\n\t\treturn {\n\t\t\tid: this.options.lmStudioModelId || \"\",\n\t\t\tinfo: openAiModelInfoSaneDefaults,\n\t\t}\n\t}\n}\n", "tag": "", "tokens": 519, "metadata": {}}], "modify_time": 1733144568.7181284}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/transform/gemini-format.ts", "relative_path": "cline/src/api/transform/gemini-format.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/transform/gemini-format.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport {\n\tContent,\n\tEnhancedGenerateContentResponse,\n\tFunctionCallPart,\n\tFunctionDeclaration,\n\tFunctionResponsePart,\n\tInlineDataPart,\n\tPart,\n\tSchemaType,\n\tTextPart,\n} from \"@google/generative-ai\"\n\nexport function convertAnthropicContentToGemini(\n\tcontent:\n\t\t| string\n\t\t| Array<\n\t\t\t\t| Anthropic.Messages.TextBlockParam\n\t\t\t\t| Anthropic.Messages.ImageBlockParam\n\t\t\t\t| Anthropic.Messages.ToolUseBlockParam\n\t\t\t\t| Anthropic.Messages.ToolResultBlockParam\n\t\t  >,\n): Part[] {\n\tif (typeof content === \"string\") {\n\t\treturn [{ text: content } as TextPart]\n\t}\n\treturn content.flatMap((block) => {\n\t\tswitch (block.type) {\n\t\t\tcase \"text\":\n\t\t\t\treturn { text: block.text } as TextPart\n\t\t\tcase \"image\":\n\t\t\t\tif (block.source.type !== \"base64\") {\n\t\t\t\t\tthrow new Error(\"Unsupported image source type\")\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\tinlineData: {\n\t\t\t\t\t\tdata: block.source.data,\n\t\t\t\t\t\tmimeType: block.source.media_type,\n\t\t\t\t\t},\n\t\t\t\t} as InlineDataPart\n\t\t\tcase \"tool_use\":\n\t\t\t\treturn {\n\t\t\t\t\tfunctionCall: {\n\t\t\t\t\t\tname: block.name,\n\t\t\t\t\t\targs: block.input,\n\t\t\t\t\t},\n\t\t\t\t} as FunctionCallPart\n\t\t\tcase \"tool_result\":\n\t\t\t\tconst name = block.tool_use_id.split(\"-\")[0]\n\t\t\t\tif (!block.content) {\n\t\t\t\t\treturn []\n\t\t\t\t}\n\t\t\t\tif (typeof block.content === \"string\") {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tfunctionResponse: {\n\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\tresponse: {\n\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\tcontent: block.content,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t} as FunctionResponsePart\n\t\t\t\t} else {\n\t\t\t\t\t// The only case when tool_result could be array is when the tool failed and we're providing ie user feedback potentially with images\n\t\t\t\t\tconst textParts = block.content.filter((part) => part.type === \"text\")\n\t\t\t\t\tconst imageParts = block.content.filter((part) => part.type === \"image\")\n\t\t\t\t\tconst text = textParts.length > 0 ? textParts.map((part) => part.text).join(\"\\n\\n\") : \"\"\n\t\t\t\t\tconst imageText = imageParts.length > 0 ? \"\\n\\n(See next part for image)\" : \"\"\n\t\t\t\t\treturn [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfunctionResponse: {\n\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\tresponse: {\n\t\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\t\tcontent: text + imageText,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t} as FunctionResponsePart,\n\t\t\t\t\t\t...imageParts.map(\n\t\t\t\t\t\t\t(part) =>\n\t\t\t\t\t\t\t\t({\n\t\t\t\t\t\t\t\t\tinlineData: {\n\t\t\t\t\t\t\t\t\t\tdata: part.source.data,\n\t\t\t\t\t\t\t\t\t\tmimeType: part.source.media_type,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t}) as InlineDataPart,\n\t\t\t\t\t\t),\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Unsupported content block type: ${(block as any).type}`)\n\t\t}\n\t})\n}\n\nexport function convertAnthropicMessageToGemini(message: Anthropic.Messages.MessageParam): Content {\n\treturn {\n\t\trole: message.role === \"assistant\" ? \"model\" : \"user\",\n\t\tparts: convertAnthropicContentToGemini(message.content),\n\t}\n}\n\nexport function convertAnthropicToolToGemini(tool: Anthropic.Messages.Tool): FunctionDeclaration {\n\treturn {\n\t\tname: tool.name,\n\t\tdescription: tool.description || \"\",\n\t\tparameters: {\n\t\t\ttype: SchemaType.OBJECT,\n\t\t\tproperties: Object.fromEntries(\n\t\t\t\tObject.entries(tool.input_schema.properties || {}).map(([key, value]) => [\n\t\t\t\t\tkey,\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: (value as any).type.toUpperCase(),\n\t\t\t\t\t\tdescription: (value as any).description || \"\",\n\t\t\t\t\t},\n\t\t\t\t]),\n\t\t\t),\n\t\t\trequired: (tool.input_schema.required as string[]) || [],\n\t\t},\n\t}\n}\n\n/*\nIt looks like gemini likes to double escape certain characters when writing file contents: https://discuss.ai.google.dev/t/function-call-string-property-is-double-escaped/37867\n*/\nexport function unescapeGeminiContent(content: string) {\n\treturn content\n\t\t.replace(/\\\\n/g, \"\\n\")\n\t\t.replace(/\\\\'/g, \"'\")\n\t\t.replace(/\\\\\"/g, '\"')\n\t\t.replace(/\\\\r/g, \"\\r\")\n\t\t.replace(/\\\\t/g, \"\\t\")\n}\n\nexport function convertGeminiResponseToAnthropic(\n\tresponse: EnhancedGenerateContentResponse,\n): Anthropic.Messages.Message {\n\tconst content: Anthropic.Messages.ContentBlock[] = []\n\n\t// Add the main text response\n\tconst text = response.text()\n\tif (text) {\n\t\tcontent.push({ type: \"text\", text })\n\t}\n\n\t// Add function calls as tool_use blocks\n\tconst functionCalls = response.functionCalls()\n\tif (functionCalls) {\n\t\tfunctionCalls.forEach((call, index) => {\n\t\t\tif (\"content\" in call.args && typeof call.args.content === \"string\") {\n\t\t\t\tcall.args.content = unescapeGeminiContent(call.args.content)\n\t\t\t}\n\t\t\tcontent.push({\n\t\t\t\ttype: \"tool_use\",\n\t\t\t\tid: `${call.name}-${index}-${Date.now()}`,\n\t\t\t\tname: call.name,\n\t\t\t\tinput: call.args,\n\t\t\t})\n\t\t})\n\t}\n\n\t// Determine stop reason\n\tlet stop_reason: Anthropic.Messages.Message[\"stop_reason\"] = null\n\tconst finishReason = response.candidates?.[0]?.finishReason\n\tif (finishReason) {\n\t\tswitch (finishReason) {\n\t\t\tcase \"STOP\":\n\t\t\t\tstop_reason = \"end_turn\"\n\t\t\t\tbreak\n\t\t\tcase \"MAX_TOKENS\":\n\t\t\t\tstop_reason = \"max_tokens\"\n\t\t\t\tbreak\n\t\t\tcase \"SAFETY\":\n\t\t\tcase \"RECITATION\":\n\t\t\tcase \"OTHER\":\n\t\t\t\tstop_reason = \"stop_sequence\"\n\t\t\t\tbreak\n\t\t\t// Add more cases if needed\n\t\t}\n\t}\n\n\treturn {\n\t\tid: `msg_${Date.now()}`, // Generate a unique ID\n\t\ttype: \"message\",\n\t\trole: \"assistant\",\n\t\tcontent,\n\t\tmodel: \"\",\n\t\tstop_reason,\n\t\tstop_sequence: null, // Gemini doesn't provide this information\n\t\tusage: {\n\t\t\tinput_tokens: response.usageMetadata?.promptTokenCount ?? 0,\n\t\t\toutput_tokens: response.usageMetadata?.candidatesTokenCount ?? 0,\n\t\t},\n\t}\n}\n", "tag": "", "tokens": 1612, "metadata": {}}], "modify_time": 1733144568.718961}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/transform/openai-format.ts", "relative_path": "cline/src/api/transform/openai-format.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/transform/openai-format.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport OpenAI from \"openai\"\n\nexport function convertToOpenAiMessages(\n\tanthropicMessages: Anthropic.Messages.MessageParam[],\n): OpenAI.Chat.ChatCompletionMessageParam[] {\n\tconst openAiMessages: OpenAI.Chat.ChatCompletionMessageParam[] = []\n\n\tfor (const anthropicMessage of anthropicMessages) {\n\t\tif (typeof anthropicMessage.content === \"string\") {\n\t\t\topenAiMessages.push({ role: anthropicMessage.role, content: anthropicMessage.content })\n\t\t} else {\n\t\t\t// image_url.url is base64 encoded image data\n\t\t\t// ensure it contains the content-type of the image: data:image/png;base64,\n\t\t\t/*\n        { role: \"user\", content: \"\" | { type: \"text\", text: string } | { type: \"image_url\", image_url: { url: string } } },\n         // content required unless tool_calls is present\n        { role: \"assistant\", content?: \"\" | null, tool_calls?: [{ id: \"\", function: { name: \"\", arguments: \"\" }, type: \"function\" }] },\n        { role: \"tool\", tool_call_id: \"\", content: \"\"}\n         */\n\t\t\tif (anthropicMessage.role === \"user\") {\n\t\t\t\tconst { nonToolMessages, toolMessages } = anthropicMessage.content.reduce<{\n\t\t\t\t\tnonToolMessages: (Anthropic.TextBlockParam | Anthropic.ImageBlockParam)[]\n\t\t\t\t\ttoolMessages: Anthropic.ToolResultBlockParam[]\n\t\t\t\t}>(\n\t\t\t\t\t(acc, part) => {\n\t\t\t\t\t\tif (part.type === \"tool_result\") {\n\t\t\t\t\t\t\tacc.toolMessages.push(part)\n\t\t\t\t\t\t} else if (part.type === \"text\" || part.type === \"image\") {\n\t\t\t\t\t\t\tacc.nonToolMessages.push(part)\n\t\t\t\t\t\t} // user cannot send tool_use messages\n\t\t\t\t\t\treturn acc\n\t\t\t\t\t},\n\t\t\t\t\t{ nonToolMessages: [], toolMessages: [] },\n\t\t\t\t)\n\n\t\t\t\t// Process tool result messages FIRST since they must follow the tool use messages\n\t\t\t\tlet toolResultImages: Anthropic.Messages.ImageBlockParam[] = []\n\t\t\t\ttoolMessages.forEach((toolMessage) => {\n\t\t\t\t\t// The Anthropic SDK allows tool results to be a string or an array of text and image blocks, enabling rich and structured content. In contrast, the OpenAI SDK only supports tool results as a single string, so we map the Anthropic tool result parts into one concatenated string to maintain compatibility.\n\t\t\t\t\tlet content: string\n\n\t\t\t\t\tif (typeof toolMessage.content === \"string\") {\n\t\t\t\t\t\tcontent = toolMessage.content\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcontent =\n\t\t\t\t\t\t\ttoolMessage.content\n\t\t\t\t\t\t\t\t?.map((part) => {\n\t\t\t\t\t\t\t\t\tif (part.type === \"image\") {\n\t\t\t\t\t\t\t\t\t\ttoolResultImages.push(part)\n\t\t\t\t\t\t\t\t\t\treturn \"(see following user message for image)\"\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn part.text\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.join(\"\\n\") ?? \"\"\n\t\t\t\t\t}\n\t\t\t\t\topenAiMessages.push({\n\t\t\t\t\t\trole: \"tool\",\n\t\t\t\t\t\ttool_call_id: toolMessage.tool_use_id,\n\t\t\t\t\t\tcontent: content,\n\t\t\t\t\t})\n\t\t\t\t})\n\n\t\t\t\t// If tool results contain images, send as a separate user message\n\t\t\t\t// I ran into an issue where if I gave feedback for one of many tool uses, the request would fail.\n\t\t\t\t// \"Messages following `tool_use` blocks must begin with a matching number of `tool_result` blocks.\"\n\t\t\t\t// Therefore we need to send these images after the tool result messages\n\t\t\t\t// NOTE: it's actually okay to have multiple user messages in a row, the model will treat them as a continuation of the same input (this way works better than combining them into one message, since the tool result specifically mentions (see following user message for image)\n\t\t\t\t// UPDATE v2.0: we don't use tools anymore, but if we did it's important to note that the openrouter prompt caching mechanism requires one user message at a time, so we would need to add these images to the user content array instead.\n\t\t\t\t// if (toolResultImages.length > 0) {\n\t\t\t\t// \topenAiMessages.push({\n\t\t\t\t// \t\trole: \"user\",\n\t\t\t\t// \t\tcontent: toolResultImages.map((part) => ({\n\t\t\t\t// \t\t\ttype: \"image_url\",\n\t\t\t\t// \t\t\timage_url: { url: `data:${part.source.media_type};base64,${part.source.data}` },\n\t\t\t\t// \t\t})),\n\t\t\t\t// \t})\n\t\t\t\t// }\n\n\t\t\t\t// Process non-tool messages\n\t\t\t\tif (nonToolMessages.length > 0) {\n\t\t\t\t\topenAiMessages.push({\n\t\t\t\t\t\trole: \"user\",\n\t\t\t\t\t\tcontent: nonToolMessages.map((part) => {\n\t\t\t\t\t\t\tif (part.type === \"image\") {\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\ttype: \"image_url\",\n\t\t\t\t\t\t\t\t\timage_url: { url: `data:${part.source.media_type};base64,${part.source.data}` },\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn { type: \"text\", text: part.text }\n\t\t\t\t\t\t}),\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t} else if (anthropicMessage.role === \"assistant\") {\n\t\t\t\tconst { nonToolMessages, toolMessages } = anthropicMessage.content.reduce<{\n\t\t\t\t\tnonToolMessages: (Anthropic.TextBlockParam | Anthropic.ImageBlockParam)[]\n\t\t\t\t\ttoolMessages: Anthropic.ToolUseBlockParam[]\n\t\t\t\t}>(\n\t\t\t\t\t(acc, part) => {\n\t\t\t\t\t\tif (part.type === \"tool_use\") {\n\t\t\t\t\t\t\tacc.toolMessages.push(part)\n\t\t\t\t\t\t} else if (part.type === \"text\" || part.type === \"image\") {\n\t\t\t\t\t\t\tacc.nonToolMessages.push(part)\n\t\t\t\t\t\t} // assistant cannot send tool_result messages\n\t\t\t\t\t\treturn acc\n\t\t\t\t\t},\n\t\t\t\t\t{ nonToolMessages: [], toolMessages: [] },\n\t\t\t\t)\n\n\t\t\t\t// Process non-tool messages\n\t\t\t\tlet content: string | undefined\n\t\t\t\tif (nonToolMessages.length > 0) {\n\t\t\t\t\tcontent = nonToolMessages\n\t\t\t\t\t\t.map((part) => {\n\t\t\t\t\t\t\tif (part.type === \"image\") {\n\t\t\t\t\t\t\t\treturn \"\" // impossible as the assistant cannot send images\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn part.text\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.join(\"\\n\")\n\t\t\t\t}\n\n\t\t\t\t// Process tool use messages\n\t\t\t\tlet tool_calls: OpenAI.Chat.ChatCompletionMessageToolCall[] = toolMessages.map((toolMessage) => ({\n\t\t\t\t\tid: toolMessage.id,\n\t\t\t\t\ttype: \"function\",\n\t\t\t\t\tfunction: {\n\t\t\t\t\t\tname: toolMessage.name,\n\t\t\t\t\t\t// json string\n\t\t\t\t\t\targuments: JSON.stringify(toolMessage.input),\n\t\t\t\t\t},\n\t\t\t\t}))\n\n\t\t\t\topenAiMessages.push({\n\t\t\t\t\trole: \"assistant\",\n\t\t\t\t\tcontent,\n\t\t\t\t\t// Cannot be an empty array. API expects an array with minimum length 1, and will respond with an error if it's empty\n\t\t\t\t\ttool_calls: tool_calls.length > 0 ? tool_calls : undefined,\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t}\n\n\treturn openAiMessages\n}\n\n// Convert OpenAI response to Anthropic format\nexport function convertToAnthropicMessage(\n\tcompletion: OpenAI.Chat.Completions.ChatCompletion,\n): Anthropic.Messages.Message {\n\tconst openAiMessage = completion.choices[0].message\n\tconst anthropicMessage: Anthropic.Messages.Message = {\n\t\tid: completion.id,\n\t\ttype: \"message\",\n\t\trole: openAiMessage.role, // always \"assistant\"\n\t\tcontent: [\n\t\t\t{\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: openAiMessage.content || \"\",\n\t\t\t},\n\t\t],\n\t\tmodel: completion.model,\n\t\tstop_reason: (() => {\n\t\t\tswitch (completion.choices[0].finish_reason) {\n\t\t\t\tcase \"stop\":\n\t\t\t\t\treturn \"end_turn\"\n\t\t\t\tcase \"length\":\n\t\t\t\t\treturn \"max_tokens\"\n\t\t\t\tcase \"tool_calls\":\n\t\t\t\t\treturn \"tool_use\"\n\t\t\t\tcase \"content_filter\": // Anthropic doesn't have an exact equivalent\n\t\t\t\tdefault:\n\t\t\t\t\treturn null\n\t\t\t}\n\t\t})(),\n\t\tstop_sequence: null, // which custom stop_sequence was generated, if any (not applicable if you don't use stop_sequence)\n\t\tusage: {\n\t\t\tinput_tokens: completion.usage?.prompt_tokens || 0,\n\t\t\toutput_tokens: completion.usage?.completion_tokens || 0,\n\t\t},\n\t}\n\n\tif (openAiMessage.tool_calls && openAiMessage.tool_calls.length > 0) {\n\t\tanthropicMessage.content.push(\n\t\t\t...openAiMessage.tool_calls.map((toolCall): Anthropic.ToolUseBlock => {\n\t\t\t\tlet parsedInput = {}\n\t\t\t\ttry {\n\t\t\t\t\tparsedInput = JSON.parse(toolCall.function.arguments || \"{}\")\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error(\"Failed to parse tool arguments:\", error)\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\ttype: \"tool_use\",\n\t\t\t\t\tid: toolCall.id,\n\t\t\t\t\tname: toolCall.function.name,\n\t\t\t\t\tinput: parsedInput,\n\t\t\t\t}\n\t\t\t}),\n\t\t)\n\t}\n\treturn anthropicMessage\n}\n", "tag": "", "tokens": 2176, "metadata": {}}], "modify_time": 1733144568.7192943}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/transform/o1-format.ts", "relative_path": "cline/src/api/transform/o1-format.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/transform/o1-format.ts", "source_code": "import { Anthropic } from \"@anthropic-ai/sdk\"\nimport OpenAI from \"openai\"\n\nconst o1SystemPrompt = (systemPrompt: string) => `\n# System Prompt\n\n${systemPrompt}\n\n# Instructions for Formulating Your Response\n\nYou must respond to the user's request by using at least one tool call. When formulating your response, follow these guidelines:\n\n1. Begin your response with normal text, explaining your thoughts, analysis, or plan of action.\n2. If you need to use any tools, place ALL tool calls at the END of your message, after your normal text explanation.\n3. You can use multiple tool calls if needed, but they should all be grouped together at the end of your message.\n4. After placing the tool calls, do not add any additional normal text. The tool calls should be the final content in your message.\n\nHere's the general structure your responses should follow:\n\n\\`\\`\\`\n[Your normal text response explaining your thoughts and actions]\n\n[Tool Call 1]\n[Tool Call 2 if needed]\n[Tool Call 3 if needed]\n...\n\\`\\`\\`\n\nRemember:\n- Choose the most appropriate tool(s) based on the task and the tool descriptions provided.\n- Formulate your tool calls using the XML format specified for each tool.\n- Provide clear explanations in your normal text about what actions you're taking and why you're using particular tools.\n- Act as if the tool calls will be executed immediately after your message, and your next response will have access to their results.\n\n# Tool Descriptions and XML Formats\n\n1. execute_command:\n<execute_command>\n<command>Your command here</command>\n</execute_command>\nDescription: Execute a CLI command on the system. Use this when you need to perform system operations or run specific commands to accomplish any step in the user's task. You must tailor your command to the user's system and provide a clear explanation of what the command does. Prefer to execute complex CLI commands over creating executable scripts, as they are more flexible and easier to run. Commands will be executed in the current working directory.\n\n2. list_files:\n<list_files>\n<path>Directory path here</path>\n<recursive>true or false (optional)</recursive>\n</list_files>\nDescription: List files and directories within the specified directory. If recursive is true, it will list all files and directories recursively. If recursive is false or not provided, it will only list the top-level contents.\n\n3. list_code_definition_names:\n<list_code_definition_names>\n<path>Directory path here</path>\n</list_code_definition_names>\nDescription: Lists definition names (classes, functions, methods, etc.) used in source code files at the top level of the specified directory. This tool provides insights into the codebase structure and important constructs, encapsulating high-level concepts and relationships that are crucial for understanding the overall architecture.\n\n4. search_files:\n<search_files>\n<path>Directory path here</path>\n<regex>Your regex pattern here</regex>\n<filePattern>Optional file pattern here</filePattern>\n</search_files>\nDescription: Perform a regex search across files in a specified directory, providing context-rich results. This tool searches for patterns or specific content across multiple files, displaying each match with encapsulating context.\n\n5. read_file:\n<read_file>\n<path>File path here</path>\n</read_file>\nDescription: Read the contents of a file at the specified path. Use this when you need to examine the contents of an existing file, for example to analyze code, review text files, or extract information from configuration files. Automatically extracts raw text from PDF and DOCX files. May not be suitable for other types of binary files, as it returns the raw content as a string.\n\n6. write_to_file:\n<write_to_file>\n<path>File path here</path>\n<content>\nYour file content here\n</content>\n</write_to_file>\nDescription: Write content to a file at the specified path. If the file exists, it will be overwritten with the provided content. If the file doesn't exist, it will be created. Always provide the full intended content of the file, without any truncation. This tool will automatically create any directories needed to write the file.\n\n7. ask_followup_question:\n<ask_followup_question>\n<question>Your question here</question>\n</ask_followup_question>\nDescription: Ask the user a question to gather additional information needed to complete the task. This tool should be used when you encounter ambiguities, need clarification, or require more details to proceed effectively. It allows for interactive problem-solving by enabling direct communication with the user. Use this tool judiciously to maintain a balance between gathering necessary information and avoiding excessive back-and-forth.\n\n8. attempt_completion:\n<attempt_completion>\n<command>Optional command to demonstrate result</command>\n<result>\nYour final result description here\n</result>\n</attempt_completion>\nDescription: Once you've completed the task, use this tool to present the result to the user. They may respond with feedback if they are not satisfied with the result, which you can use to make improvements and try again.\n\n# Examples\n\nHere are some examples of how to structure your responses with tool calls:\n\nExample 1: Using a single tool\n\nLet's run the test suite for our project. This will help us ensure that all our components are functioning correctly.\n\n<execute_command>\n<command>npm test</command>\n</execute_command>\n\nExample 2: Using multiple tools\n\nLet's create two new configuration files for the web application: one for the frontend and one for the backend.\n\n<write_to_file>\n<path>./frontend-config.json</path>\n<content>\n{\n  \"apiEndpoint\": \"https://api.example.com\",\n  \"theme\": {\n    \"primaryColor\": \"#007bff\",\n    \"secondaryColor\": \"#6c757d\",\n    \"fontFamily\": \"Arial, sans-serif\"\n  },\n  \"features\": {\n    \"darkMode\": true,\n    \"notifications\": true,\n    \"analytics\": false\n  },\n  \"version\": \"1.0.0\"\n}\n</content>\n</write_to_file>\n\n<write_to_file>\n<path>./backend-config.yaml</path>\n<content>\ndatabase:\n  host: localhost\n  port: 5432\n  name: myapp_db\n  user: admin\n\nserver:\n  port: 3000\n  environment: development\n  logLevel: debug\n\nsecurity:\n  jwtSecret: your-secret-key-here\n  passwordSaltRounds: 10\n\ncaching:\n  enabled: true\n  provider: redis\n  ttl: 3600\n\nexternalServices:\n  emailProvider: sendgrid\n  storageProvider: aws-s3\n</content>\n</write_to_file>\n\nExample 3: Asking a follow-up question\n\nI've analyzed the project structure, but I need more information to proceed. Let me ask the user for clarification.\n\n<ask_followup_question>\n<question>Which specific feature would you like me to implement in the example.py file?</question>\n</ask_followup_question>\n`\n\nexport function convertToO1Messages(\n\topenAiMessages: OpenAI.Chat.ChatCompletionMessageParam[],\n\tsystemPrompt: string,\n): OpenAI.Chat.ChatCompletionMessageParam[] {\n\tconst toolsReplaced = openAiMessages.reduce((acc, message) => {\n\t\tif (message.role === \"tool\") {\n\t\t\t// Convert tool messages to user messages\n\t\t\tacc.push({\n\t\t\t\trole: \"user\",\n\t\t\t\tcontent: message.content || \"\",\n\t\t\t})\n\t\t} else if (message.role === \"assistant\" && message.tool_calls) {\n\t\t\t// Convert tool calls to content and remove tool_calls\n\t\t\tlet content = message.content || \"\"\n\t\t\tmessage.tool_calls.forEach((toolCall) => {\n\t\t\t\tif (toolCall.type === \"function\") {\n\t\t\t\t\tcontent += `\\nTool Call: ${toolCall.function.name}\\nArguments: ${toolCall.function.arguments}`\n\t\t\t\t}\n\t\t\t})\n\t\t\tacc.push({\n\t\t\t\trole: \"assistant\",\n\t\t\t\tcontent: content,\n\t\t\t\ttool_calls: undefined,\n\t\t\t})\n\t\t} else {\n\t\t\t// Keep other messages as they are\n\t\t\tacc.push(message)\n\t\t}\n\t\treturn acc\n\t}, [] as OpenAI.Chat.ChatCompletionMessageParam[])\n\n\t// Find the index of the last assistant message\n\t// const lastAssistantIndex = findLastIndex(toolsReplaced, (message) => message.role === \"assistant\")\n\n\t// Create a new array to hold the modified messages\n\tconst messagesWithSystemPrompt = [\n\t\t{\n\t\t\trole: \"user\",\n\t\t\tcontent: o1SystemPrompt(systemPrompt),\n\t\t} as OpenAI.Chat.ChatCompletionUserMessageParam,\n\t\t...toolsReplaced,\n\t]\n\n\t// If there's an assistant message, insert the system prompt after it\n\t// if (lastAssistantIndex !== -1) {\n\t// \tconst insertIndex = lastAssistantIndex + 1\n\t// \tif (insertIndex < messagesWithSystemPrompt.length && messagesWithSystemPrompt[insertIndex].role === \"user\") {\n\t// \t\tmessagesWithSystemPrompt.splice(insertIndex, 0, {\n\t// \t\t\trole: \"user\",\n\t// \t\t\tcontent: o1SystemPrompt(systemPrompt),\n\t// \t\t})\n\t// \t}\n\t// } else {\n\t// \t// If there were no assistant messages, prepend the system prompt\n\t// \tmessagesWithSystemPrompt.unshift({\n\t// \t\trole: \"user\",\n\t// \t\tcontent: o1SystemPrompt(systemPrompt),\n\t// \t})\n\t// }\n\n\treturn messagesWithSystemPrompt\n}\n\ninterface ToolCall {\n\ttool: string\n\ttool_input: Record<string, string>\n}\n\nconst toolNames = [\n\t\"execute_command\",\n\t\"list_files\",\n\t\"list_code_definition_names\",\n\t\"search_files\",\n\t\"read_file\",\n\t\"write_to_file\",\n\t\"ask_followup_question\",\n\t\"attempt_completion\",\n]\n\nfunction parseAIResponse(response: string): { normalText: string; toolCalls: ToolCall[] } {\n\t// Create a regex pattern to match any tool call opening tag\n\tconst toolCallPattern = new RegExp(`<(${toolNames.join(\"|\")})`, \"i\")\n\tconst match = response.match(toolCallPattern)\n\n\tif (!match) {\n\t\t// No tool calls found\n\t\treturn { normalText: response.trim(), toolCalls: [] }\n\t}\n\n\tconst toolCallStart = match.index!\n\tconst normalText = response.slice(0, toolCallStart).trim()\n\tconst toolCallsText = response.slice(toolCallStart)\n\n\tconst toolCalls = parseToolCalls(toolCallsText)\n\n\treturn { normalText, toolCalls }\n}\n\nfunction parseToolCalls(toolCallsText: string): ToolCall[] {\n\tconst toolCalls: ToolCall[] = []\n\n\tlet remainingText = toolCallsText\n\n\twhile (remainingText.length > 0) {\n\t\tconst toolMatch = toolNames.find((tool) => new RegExp(`<${tool}`, \"i\").test(remainingText))\n\n\t\tif (!toolMatch) {\n\t\t\tbreak // No more tool calls found\n\t\t}\n\n\t\tconst startTag = `<${toolMatch}`\n\t\tconst endTag = `</${toolMatch}>`\n\t\tconst startIndex = remainingText.indexOf(startTag)\n\t\tconst endIndex = remainingText.indexOf(endTag, startIndex)\n\n\t\tif (endIndex === -1) {\n\t\t\tbreak // Malformed XML, no closing tag found\n\t\t}\n\n\t\tconst toolCallContent = remainingText.slice(startIndex, endIndex + endTag.length)\n\t\tremainingText = remainingText.slice(endIndex + endTag.length).trim()\n\n\t\tconst toolCall = parseToolCall(toolMatch, toolCallContent)\n\t\tif (toolCall) {\n\t\t\ttoolCalls.push(toolCall)\n\t\t}\n\t}\n\n\treturn toolCalls\n}\n\nfunction parseToolCall(toolName: string, content: string): ToolCall | null {\n\tconst tool_input: Record<string, string> = {}\n\n\t// Remove the outer tool tags\n\tconst innerContent = content.replace(new RegExp(`^<${toolName}>|</${toolName}>$`, \"g\"), \"\").trim()\n\n\t// Parse nested XML elements\n\tconst paramRegex = /<(\\w+)>([\\s\\S]*?)<\\/\\1>/gs\n\tlet match\n\n\twhile ((match = paramRegex.exec(innerContent)) !== null) {\n\t\tconst [, paramName, paramValue] = match\n\t\t// Preserve newlines and trim only leading/trailing whitespace\n\t\ttool_input[paramName] = paramValue.replace(/^\\s+|\\s+$/g, \"\")\n\t}\n\n\t// Validate required parameters\n\tif (!validateToolInput(toolName, tool_input)) {\n\t\tconsole.error(`Invalid tool call for ${toolName}:`, content)\n\t\treturn null\n\t}\n\n\treturn { tool: toolName, tool_input }\n}\n\nfunction validateToolInput(toolName: string, tool_input: Record<string, string>): boolean {\n\tswitch (toolName) {\n\t\tcase \"execute_command\":\n\t\t\treturn \"command\" in tool_input\n\t\tcase \"read_file\":\n\t\tcase \"list_code_definition_names\":\n\t\tcase \"list_files\":\n\t\t\treturn \"path\" in tool_input\n\t\tcase \"search_files\":\n\t\t\treturn \"path\" in tool_input && \"regex\" in tool_input\n\t\tcase \"write_to_file\":\n\t\t\treturn \"path\" in tool_input && \"content\" in tool_input\n\t\tcase \"ask_followup_question\":\n\t\t\treturn \"question\" in tool_input\n\t\tcase \"attempt_completion\":\n\t\t\treturn \"result\" in tool_input\n\t\tdefault:\n\t\t\treturn false\n\t}\n}\n\n// Example usage:\n// const aiResponse = `Here's my analysis of the situation...\n\n// <execute_command>\n//   <command>ls -la</command>\n// </execute_command>\n\n// <write_to_file>\n//   <path>./example.txt</path>\n//   <content>Hello, World!</content>\n// </write_to_file>`;\n//\n// const { normalText, toolCalls } = parseAIResponse(aiResponse);\n// console.log(normalText);\n// console.log(toolCalls);\n\n// Convert OpenAI response to Anthropic format\nexport function convertO1ResponseToAnthropicMessage(\n\tcompletion: OpenAI.Chat.Completions.ChatCompletion,\n): Anthropic.Messages.Message {\n\tconst openAiMessage = completion.choices[0].message\n\tconst { normalText, toolCalls } = parseAIResponse(openAiMessage.content || \"\")\n\n\tconst anthropicMessage: Anthropic.Messages.Message = {\n\t\tid: completion.id,\n\t\ttype: \"message\",\n\t\trole: openAiMessage.role, // always \"assistant\"\n\t\tcontent: [\n\t\t\t{\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: normalText,\n\t\t\t},\n\t\t],\n\t\tmodel: completion.model,\n\t\tstop_reason: (() => {\n\t\t\tswitch (completion.choices[0].finish_reason) {\n\t\t\t\tcase \"stop\":\n\t\t\t\t\treturn \"end_turn\"\n\t\t\t\tcase \"length\":\n\t\t\t\t\treturn \"max_tokens\"\n\t\t\t\tcase \"tool_calls\":\n\t\t\t\t\treturn \"tool_use\"\n\t\t\t\tcase \"content_filter\": // Anthropic doesn't have an exact equivalent\n\t\t\t\tdefault:\n\t\t\t\t\treturn null\n\t\t\t}\n\t\t})(),\n\t\tstop_sequence: null, // which custom stop_sequence was generated, if any (not applicable if you don't use stop_sequence)\n\t\tusage: {\n\t\t\tinput_tokens: completion.usage?.prompt_tokens || 0,\n\t\t\toutput_tokens: completion.usage?.completion_tokens || 0,\n\t\t},\n\t}\n\n\tif (toolCalls.length > 0) {\n\t\tanthropicMessage.content.push(\n\t\t\t...toolCalls.map((toolCall: ToolCall, index: number): Anthropic.ToolUseBlock => {\n\t\t\t\treturn {\n\t\t\t\t\ttype: \"tool_use\",\n\t\t\t\t\tid: `call_${index}_${Date.now()}`, // Generate a unique ID for each tool call\n\t\t\t\t\tname: toolCall.tool,\n\t\t\t\t\tinput: toolCall.tool_input,\n\t\t\t\t}\n\t\t\t}),\n\t\t)\n\t}\n\n\treturn anthropicMessage\n}\n\n// Example usage:\n// const openAICompletion = {\n//     id: \"cmpl-123\",\n//     choices: [{\n//         message: {\n//             role: \"assistant\",\n//             content: \"Here's my analysis...\\n\\n<execute_command>\\n  <command>ls -la</command>\\n</execute_command>\"\n//         },\n//         finish_reason: \"stop\"\n//     }],\n//     model: \"gpt-3.5-turbo\",\n//     usage: { prompt_tokens: 50, completion_tokens: 100 }\n// };\n// const anthropicMessage = convertO1ResponseToAnthropicMessage(openAICompletion);\n// console.log(anthropicMessage);\n", "tag": "", "tokens": 4054, "metadata": {}}], "modify_time": 1733144568.719156}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/transform/stream.ts", "relative_path": "cline/src/api/transform/stream.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/api/transform/stream.ts", "source_code": "export type ApiStream = AsyncGenerator<ApiStreamChunk>\nexport type ApiStreamChunk = ApiStreamTextChunk | ApiStreamUsageChunk\n\nexport interface ApiStreamTextChunk {\n\ttype: \"text\"\n\ttext: string\n}\n\nexport interface ApiStreamUsageChunk {\n\ttype: \"usage\"\n\tinputTokens: number\n\toutputTokens: number\n\tcacheWriteTokens?: number\n\tcacheReadTokens?: number\n\ttotalCost?: number // openrouter\n}\n", "tag": "", "tokens": 108, "metadata": {}}], "modify_time": 1733144568.7194211}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/languageParser.ts", "relative_path": "cline/src/services/tree-sitter/languageParser.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/languageParser.ts", "source_code": "import * as path from \"path\"\nimport Parser from \"web-tree-sitter\"\nimport {\n\tjavascriptQuery,\n\ttypescriptQuery,\n\tpythonQuery,\n\trustQuery,\n\tgoQuery,\n\tcppQuery,\n\tcQuery,\n\tcsharpQuery,\n\trubyQuery,\n\tjavaQuery,\n\tphpQuery,\n\tswiftQuery,\n} from \"./queries\"\n\nexport interface LanguageParser {\n\t[key: string]: {\n\t\tparser: Parser\n\t\tquery: Parser.Query\n\t}\n}\n\nasync function loadLanguage(langName: string) {\n\treturn await Parser.Language.load(path.join(__dirname, `tree-sitter-${langName}.wasm`))\n}\n\nlet isParserInitialized = false\n\nasync function initializeParser() {\n\tif (!isParserInitialized) {\n\t\tawait Parser.init()\n\t\tisParserInitialized = true\n\t}\n}\n\n/*\nUsing node bindings for tree-sitter is problematic in vscode extensions \nbecause of incompatibility with electron. Going the .wasm route has the \nadvantage of not having to build for multiple architectures.\n\nWe use web-tree-sitter and tree-sitter-wasms which provides auto-updating prebuilt WASM binaries for tree-sitter's language parsers.\n\nThis function loads WASM modules for relevant language parsers based on input files:\n1. Extracts unique file extensions\n2. Maps extensions to language names\n3. Loads corresponding WASM files (containing grammar rules)\n4. Uses WASM modules to initialize tree-sitter parsers\n\nThis approach optimizes performance by loading only necessary parsers once for all relevant files.\n\nSources:\n- https://github.com/tree-sitter/node-tree-sitter/issues/169\n- https://github.com/tree-sitter/node-tree-sitter/issues/168\n- https://github.com/Gregoor/tree-sitter-wasms/blob/main/README.md\n- https://github.com/tree-sitter/tree-sitter/blob/master/lib/binding_web/README.md\n- https://github.com/tree-sitter/tree-sitter/blob/master/lib/binding_web/test/query-test.js\n*/\nexport async function loadRequiredLanguageParsers(filesToParse: string[]): Promise<LanguageParser> {\n\tawait initializeParser()\n\tconst extensionsToLoad = new Set(filesToParse.map((file) => path.extname(file).toLowerCase().slice(1)))\n\tconst parsers: LanguageParser = {}\n\tfor (const ext of extensionsToLoad) {\n\t\tlet language: Parser.Language\n\t\tlet query: Parser.Query\n\t\tswitch (ext) {\n\t\t\tcase \"js\":\n\t\t\tcase \"jsx\":\n\t\t\t\tlanguage = await loadLanguage(\"javascript\")\n\t\t\t\tquery = language.query(javascriptQuery)\n\t\t\t\tbreak\n\t\t\tcase \"ts\":\n\t\t\t\tlanguage = await loadLanguage(\"typescript\")\n\t\t\t\tquery = language.query(typescriptQuery)\n\t\t\t\tbreak\n\t\t\tcase \"tsx\":\n\t\t\t\tlanguage = await loadLanguage(\"tsx\")\n\t\t\t\tquery = language.query(typescriptQuery)\n\t\t\t\tbreak\n\t\t\tcase \"py\":\n\t\t\t\tlanguage = await loadLanguage(\"python\")\n\t\t\t\tquery = language.query(pythonQuery)\n\t\t\t\tbreak\n\t\t\tcase \"rs\":\n\t\t\t\tlanguage = await loadLanguage(\"rust\")\n\t\t\t\tquery = language.query(rustQuery)\n\t\t\t\tbreak\n\t\t\tcase \"go\":\n\t\t\t\tlanguage = await loadLanguage(\"go\")\n\t\t\t\tquery = language.query(goQuery)\n\t\t\t\tbreak\n\t\t\tcase \"cpp\":\n\t\t\tcase \"hpp\":\n\t\t\t\tlanguage = await loadLanguage(\"cpp\")\n\t\t\t\tquery = language.query(cppQuery)\n\t\t\t\tbreak\n\t\t\tcase \"c\":\n\t\t\tcase \"h\":\n\t\t\t\tlanguage = await loadLanguage(\"c\")\n\t\t\t\tquery = language.query(cQuery)\n\t\t\t\tbreak\n\t\t\tcase \"cs\":\n\t\t\t\tlanguage = await loadLanguage(\"c_sharp\")\n\t\t\t\tquery = language.query(csharpQuery)\n\t\t\t\tbreak\n\t\t\tcase \"rb\":\n\t\t\t\tlanguage = await loadLanguage(\"ruby\")\n\t\t\t\tquery = language.query(rubyQuery)\n\t\t\t\tbreak\n\t\t\tcase \"java\":\n\t\t\t\tlanguage = await loadLanguage(\"java\")\n\t\t\t\tquery = language.query(javaQuery)\n\t\t\t\tbreak\n\t\t\tcase \"php\":\n\t\t\t\tlanguage = await loadLanguage(\"php\")\n\t\t\t\tquery = language.query(phpQuery)\n\t\t\t\tbreak\n\t\t\tcase \"swift\":\n\t\t\t\tlanguage = await loadLanguage(\"swift\")\n\t\t\t\tquery = language.query(swiftQuery)\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Unsupported language: ${ext}`)\n\t\t}\n\t\tconst parser = new Parser()\n\t\tparser.setLanguage(language)\n\t\tparsers[ext] = { parser, query }\n\t}\n\treturn parsers\n}\n", "tag": "", "tokens": 1138, "metadata": {}}], "modify_time": 1733144568.727775}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/index.ts", "relative_path": "cline/src/services/tree-sitter/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/index.ts", "source_code": "import * as fs from \"fs/promises\"\nimport * as path from \"path\"\nimport { listFiles } from \"../glob/list-files\"\nimport { LanguageParser, loadRequiredLanguageParsers } from \"./languageParser\"\nimport { fileExistsAtPath } from \"../../utils/fs\"\n\n// TODO: implement caching behavior to avoid having to keep analyzing project for new tasks.\nexport async function parseSourceCodeForDefinitionsTopLevel(dirPath: string): Promise<string> {\n\t// check if the path exists\n\tconst dirExists = await fileExistsAtPath(path.resolve(dirPath))\n\tif (!dirExists) {\n\t\treturn \"This directory does not exist or you do not have permission to access it.\"\n\t}\n\n\t// Get all files at top level (not gitignored)\n\tconst [allFiles, _] = await listFiles(dirPath, false, 200)\n\n\tlet result = \"\"\n\n\t// Separate files to parse and remaining files\n\tconst { filesToParse, remainingFiles } = separateFiles(allFiles)\n\n\tconst languageParsers = await loadRequiredLanguageParsers(filesToParse)\n\n\t// Parse specific files we have language parsers for\n\t// const filesWithoutDefinitions: string[] = []\n\tfor (const file of filesToParse) {\n\t\tconst definitions = await parseFile(file, languageParsers)\n\t\tif (definitions) {\n\t\t\tresult += `${path.relative(dirPath, file).toPosix()}\\n${definitions}\\n`\n\t\t}\n\t\t// else {\n\t\t// \tfilesWithoutDefinitions.push(file)\n\t\t// }\n\t}\n\n\t// List remaining files' paths\n\t// let didFindUnparsedFiles = false\n\t// filesWithoutDefinitions\n\t// \t.concat(remainingFiles)\n\t// \t.sort()\n\t// \t.forEach((file) => {\n\t// \t\tif (!didFindUnparsedFiles) {\n\t// \t\t\tresult += \"# Unparsed Files\\n\\n\"\n\t// \t\t\tdidFindUnparsedFiles = true\n\t// \t\t}\n\t// \t\tresult += `${path.relative(dirPath, file)}\\n`\n\t// \t})\n\n\treturn result ? result : \"No source code definitions found.\"\n}\n\nfunction separateFiles(allFiles: string[]): { filesToParse: string[]; remainingFiles: string[] } {\n\tconst extensions = [\n\t\t\"js\",\n\t\t\"jsx\",\n\t\t\"ts\",\n\t\t\"tsx\",\n\t\t\"py\",\n\t\t// Rust\n\t\t\"rs\",\n\t\t\"go\",\n\t\t// C\n\t\t\"c\",\n\t\t\"h\",\n\t\t// C++\n\t\t\"cpp\",\n\t\t\"hpp\",\n\t\t// C#\n\t\t\"cs\",\n\t\t// Ruby\n\t\t\"rb\",\n\t\t\"java\",\n\t\t\"php\",\n\t\t\"swift\",\n\t].map((e) => `.${e}`)\n\tconst filesToParse = allFiles.filter((file) => extensions.includes(path.extname(file))).slice(0, 50) // 50 files max\n\tconst remainingFiles = allFiles.filter((file) => !filesToParse.includes(file))\n\treturn { filesToParse, remainingFiles }\n}\n\n/*\nParsing files using tree-sitter\n\n1. Parse the file content into an AST (Abstract Syntax Tree) using the appropriate language grammar (set of rules that define how the components of a language like keywords, expressions, and statements can be combined to create valid programs).\n2. Create a query using a language-specific query string, and run it against the AST's root node to capture specific syntax elements.\n    - We use tag queries to identify named entities in a program, and then use a syntax capture to label the entity and its name. A notable example of this is GitHub's search-based code navigation.\n\t- Our custom tag queries are based on tree-sitter's default tag queries, but modified to only capture definitions.\n3. Sort the captures by their position in the file, output the name of the definition, and format by i.e. adding \"|----\\n\" for gaps between captured sections.\n\nThis approach allows us to focus on the most relevant parts of the code (defined by our language-specific queries) and provides a concise yet informative view of the file's structure and key elements.\n\n- https://github.com/tree-sitter/node-tree-sitter/blob/master/test/query_test.js\n- https://github.com/tree-sitter/tree-sitter/blob/master/lib/binding_web/test/query-test.js\n- https://github.com/tree-sitter/tree-sitter/blob/master/lib/binding_web/test/helper.js\n- https://tree-sitter.github.io/tree-sitter/code-navigation-systems\n*/\nasync function parseFile(filePath: string, languageParsers: LanguageParser): Promise<string | undefined> {\n\tconst fileContent = await fs.readFile(filePath, \"utf8\")\n\tconst ext = path.extname(filePath).toLowerCase().slice(1)\n\n\tconst { parser, query } = languageParsers[ext] || {}\n\tif (!parser || !query) {\n\t\treturn `Unsupported file type: ${filePath}`\n\t}\n\n\tlet formattedOutput = \"\"\n\n\ttry {\n\t\t// Parse the file content into an Abstract Syntax Tree (AST), a tree-like representation of the code\n\t\tconst tree = parser.parse(fileContent)\n\n\t\t// Apply the query to the AST and get the captures\n\t\t// Captures are specific parts of the AST that match our query patterns, each capture represents a node in the AST that we're interested in.\n\t\tconst captures = query.captures(tree.rootNode)\n\n\t\t// Sort captures by their start position\n\t\tcaptures.sort((a, b) => a.node.startPosition.row - b.node.startPosition.row)\n\n\t\t// Split the file content into individual lines\n\t\tconst lines = fileContent.split(\"\\n\")\n\n\t\t// Keep track of the last line we've processed\n\t\tlet lastLine = -1\n\n\t\tcaptures.forEach((capture) => {\n\t\t\tconst { node, name } = capture\n\t\t\t// Get the start and end lines of the current AST node\n\t\t\tconst startLine = node.startPosition.row\n\t\t\tconst endLine = node.endPosition.row\n\t\t\t// Once we've retrieved the nodes we care about through the language query, we filter for lines with definition names only.\n\t\t\t// name.startsWith(\"name.reference.\") > refs can be used for ranking purposes, but we don't need them for the output\n\t\t\t// previously we did `name.startsWith(\"name.definition.\")` but this was too strict and excluded some relevant definitions\n\n\t\t\t// Add separator if there's a gap between captures\n\t\t\tif (lastLine !== -1 && startLine > lastLine + 1) {\n\t\t\t\tformattedOutput += \"|----\\n\"\n\t\t\t}\n\t\t\t// Only add the first line of the definition\n\t\t\t// query captures includes the definition name and the definition implementation, but we only want the name (I found discrepencies in the naming structure for various languages, i.e. javascript names would be 'name' and typescript names would be 'name.definition)\n\t\t\tif (name.includes(\"name\") && lines[startLine]) {\n\t\t\t\tformattedOutput += `│${lines[startLine]}\\n`\n\t\t\t}\n\t\t\t// Adds all the captured lines\n\t\t\t// for (let i = startLine; i <= endLine; i++) {\n\t\t\t// \tformattedOutput += `│${lines[i]}\\n`\n\t\t\t// }\n\t\t\t//}\n\n\t\t\tlastLine = endLine\n\t\t})\n\t} catch (error) {\n\t\tconsole.log(`Error parsing file: ${error}\\n`)\n\t}\n\n\tif (formattedOutput.length > 0) {\n\t\treturn `|----\\n${formattedOutput}|----\\n`\n\t}\n\treturn undefined\n}\n", "tag": "", "tokens": 1786, "metadata": {}}], "modify_time": 1733144568.727597}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/rust.ts", "relative_path": "cline/src/services/tree-sitter/queries/rust.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/rust.ts", "source_code": "/*\n- struct definitions\n- method definitions\n- function definitions\n*/\nexport default `\n(struct_item\n    name: (type_identifier) @name.definition.class) @definition.class\n\n(declaration_list\n    (function_item\n        name: (identifier) @name.definition.method)) @definition.method\n\n(function_item\n    name: (identifier) @name.definition.function) @definition.function\n`\n", "tag": "", "tokens": 109, "metadata": {}}], "modify_time": 1733144568.7290957}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/c-sharp.ts", "relative_path": "cline/src/services/tree-sitter/queries/c-sharp.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/c-sharp.ts", "source_code": "/*\n- class declarations\n- interface declarations\n- method declarations\n- namespace declarations\n*/\nexport default `\n(class_declaration\n name: (identifier) @name.definition.class\n) @definition.class\n\n(interface_declaration\n name: (identifier) @name.definition.interface\n) @definition.interface\n\n(method_declaration\n name: (identifier) @name.definition.method\n) @definition.method\n\n(namespace_declaration\n name: (identifier) @name.definition.module\n) @definition.module\n`\n", "tag": "", "tokens": 129, "metadata": {}}], "modify_time": 1733144568.727985}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/javascript.ts", "relative_path": "cline/src/services/tree-sitter/queries/javascript.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/javascript.ts", "source_code": "/*\n- class definitions\n- method definitions\n- named function declarations\n- arrow functions and function expressions assigned to variables\n*/\nexport default `\n(\n  (comment)* @doc\n  .\n  (method_definition\n    name: (property_identifier) @name) @definition.method\n  (#not-eq? @name \"constructor\")\n  (#strip! @doc \"^[\\\\s\\\\*/]+|^[\\\\s\\\\*/]$\")\n  (#select-adjacent! @doc @definition.method)\n)\n\n(\n  (comment)* @doc\n  .\n  [\n    (class\n      name: (_) @name)\n    (class_declaration\n      name: (_) @name)\n  ] @definition.class\n  (#strip! @doc \"^[\\\\s\\\\*/]+|^[\\\\s\\\\*/]$\")\n  (#select-adjacent! @doc @definition.class)\n)\n\n(\n  (comment)* @doc\n  .\n  [\n    (function_declaration\n      name: (identifier) @name)\n    (generator_function_declaration\n      name: (identifier) @name)\n  ] @definition.function\n  (#strip! @doc \"^[\\\\s\\\\*/]+|^[\\\\s\\\\*/]$\")\n  (#select-adjacent! @doc @definition.function)\n)\n\n(\n  (comment)* @doc\n  .\n  (lexical_declaration\n    (variable_declarator\n      name: (identifier) @name\n      value: [(arrow_function) (function_expression)]) @definition.function)\n  (#strip! @doc \"^[\\\\s\\\\*/]+|^[\\\\s\\\\*/]$\")\n  (#select-adjacent! @doc @definition.function)\n)\n\n(\n  (comment)* @doc\n  .\n  (variable_declaration\n    (variable_declarator\n      name: (identifier) @name\n      value: [(arrow_function) (function_expression)]) @definition.function)\n  (#strip! @doc \"^[\\\\s\\\\*/]+|^[\\\\s\\\\*/]$\")\n  (#select-adjacent! @doc @definition.function)\n)\n`\n", "tag": "", "tokens": 494, "metadata": {}}], "modify_time": 1733144568.728674}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/php.ts", "relative_path": "cline/src/services/tree-sitter/queries/php.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/php.ts", "source_code": "/*\n- class declarations\n- function definitions\n- method declarations\n*/\nexport default `\n(class_declaration\n  name: (name) @name.definition.class) @definition.class\n\n(function_definition\n  name: (name) @name.definition.function) @definition.function\n\n(method_declaration\n  name: (name) @name.definition.function) @definition.function\n`\n", "tag": "", "tokens": 101, "metadata": {}}], "modify_time": 1733144568.7287698}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/python.ts", "relative_path": "cline/src/services/tree-sitter/queries/python.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/python.ts", "source_code": "/*\n- class definitions\n- function definitions\n*/\nexport default `\n(class_definition\n  name: (identifier) @name.definition.class) @definition.class\n\n(function_definition\n  name: (identifier) @name.definition.function) @definition.function\n`\n", "tag": "", "tokens": 73, "metadata": {}}], "modify_time": 1733144568.7288735}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/go.ts", "relative_path": "cline/src/services/tree-sitter/queries/go.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/go.ts", "source_code": "/*\n- function declarations (with associated comments)\n- method declarations (with associated comments)\n- type specifications\n*/\nexport default `\n(\n  (comment)* @doc\n  .\n  (function_declaration\n    name: (identifier) @name.definition.function) @definition.function\n  (#strip! @doc \"^//\\\\s*\")\n  (#set-adjacent! @doc @definition.function)\n)\n\n(\n  (comment)* @doc\n  .\n  (method_declaration\n    name: (field_identifier) @name.definition.method) @definition.method\n  (#strip! @doc \"^//\\\\s*\")\n  (#set-adjacent! @doc @definition.method)\n)\n\n(type_spec\n  name: (type_identifier) @name.definition.type) @definition.type\n`\n", "tag": "", "tokens": 199, "metadata": {}}], "modify_time": 1733144568.7282708}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/swift.ts", "relative_path": "cline/src/services/tree-sitter/queries/swift.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/swift.ts", "source_code": "/*\n- class declarations\n- method declarations (including initializers and deinitializers)\n- property declarations\n- function declarations\n*/\nexport default `\n(class_declaration\n  name: (type_identifier) @name) @definition.class\n\n(protocol_declaration\n  name: (type_identifier) @name) @definition.interface\n\n(class_declaration\n    (class_body\n        [\n            (function_declaration\n                name: (simple_identifier) @name\n            )\n            (subscript_declaration\n                (parameter (simple_identifier) @name)\n            )\n            (init_declaration \"init\" @name)\n            (deinit_declaration \"deinit\" @name)\n        ]\n    )\n) @definition.method\n\n(class_declaration\n    (class_body\n        [\n            (property_declaration\n                (pattern (simple_identifier) @name)\n            )\n        ]\n    )\n) @definition.property\n\n(property_declaration\n    (pattern (simple_identifier) @name)\n) @definition.property\n\n(function_declaration\n    name: (simple_identifier) @name) @definition.function\n`\n", "tag": "", "tokens": 274, "metadata": {}}], "modify_time": 1733144568.729203}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/c.ts", "relative_path": "cline/src/services/tree-sitter/queries/c.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/c.ts", "source_code": "/*\n- struct declarations\n- union declarations\n- function declarations\n- typedef declarations\n*/\nexport default `\n(struct_specifier name: (type_identifier) @name.definition.class body:(_)) @definition.class\n\n(declaration type: (union_specifier name: (type_identifier) @name.definition.class)) @definition.class\n\n(function_declarator declarator: (identifier) @name.definition.function) @definition.function\n\n(type_definition declarator: (type_identifier) @name.definition.type) @definition.type\n`\n", "tag": "", "tokens": 139, "metadata": {}}], "modify_time": 1733144568.7280915}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/cpp.ts", "relative_path": "cline/src/services/tree-sitter/queries/cpp.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/cpp.ts", "source_code": "/*\n- struct declarations\n- union declarations\n- function declarations\n- method declarations (with namespace scope)\n- typedef declarations\n- class declarations\n*/\nexport default `\n(struct_specifier name: (type_identifier) @name.definition.class body:(_)) @definition.class\n\n(declaration type: (union_specifier name: (type_identifier) @name.definition.class)) @definition.class\n\n(function_declarator declarator: (identifier) @name.definition.function) @definition.function\n\n(function_declarator declarator: (field_identifier) @name.definition.function) @definition.function\n\n(function_declarator declarator: (qualified_identifier scope: (namespace_identifier) @scope name: (identifier) @name.definition.method)) @definition.method\n\n(type_definition declarator: (type_identifier) @name.definition.type) @definition.type\n\n(class_specifier name: (type_identifier) @name.definition.class) @definition.class\n`\n", "tag": "", "tokens": 242, "metadata": {}}], "modify_time": 1733144568.728179}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/ruby.ts", "relative_path": "cline/src/services/tree-sitter/queries/ruby.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/ruby.ts", "source_code": "/*\n- method definitions (including singleton methods and aliases, with associated comments)\n- class definitions (including singleton classes, with associated comments)\n- module definitions\n*/\nexport default `\n(\n  (comment)* @doc\n  .\n  [\n    (method\n      name: (_) @name.definition.method) @definition.method\n    (singleton_method\n      name: (_) @name.definition.method) @definition.method\n  ]\n  (#strip! @doc \"^#\\\\s*\")\n  (#select-adjacent! @doc @definition.method)\n)\n\n(alias\n  name: (_) @name.definition.method) @definition.method\n\n(\n  (comment)* @doc\n  .\n  [\n    (class\n      name: [\n        (constant) @name.definition.class\n        (scope_resolution\n          name: (_) @name.definition.class)\n      ]) @definition.class\n    (singleton_class\n      value: [\n        (constant) @name.definition.class\n        (scope_resolution\n          name: (_) @name.definition.class)\n      ]) @definition.class\n  ]\n  (#strip! @doc \"^#\\\\s*\")\n  (#select-adjacent! @doc @definition.class)\n)\n\n(\n  (module\n    name: [\n      (constant) @name.definition.module\n      (scope_resolution\n        name: (_) @name.definition.module)\n    ]) @definition.module\n)\n`\n", "tag": "", "tokens": 355, "metadata": {}}], "modify_time": 1733144568.729003}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/typescript.ts", "relative_path": "cline/src/services/tree-sitter/queries/typescript.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/typescript.ts", "source_code": "/*\n- function signatures and declarations\n- method signatures and definitions\n- abstract method signatures\n- class declarations (including abstract classes)\n- module declarations\n*/\nexport default `\n(function_signature\n  name: (identifier) @name.definition.function) @definition.function\n\n(method_signature\n  name: (property_identifier) @name.definition.method) @definition.method\n\n(abstract_method_signature\n  name: (property_identifier) @name.definition.method) @definition.method\n\n(abstract_class_declaration\n  name: (type_identifier) @name.definition.class) @definition.class\n\n(module\n  name: (identifier) @name.definition.module) @definition.module\n\n(function_declaration\n  name: (identifier) @name.definition.function) @definition.function\n\n(method_definition\n  name: (property_identifier) @name.definition.method) @definition.method\n\n(class_declaration\n  name: (type_identifier) @name.definition.class) @definition.class\n`\n", "tag": "", "tokens": 251, "metadata": {}}], "modify_time": 1733144568.729298}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/index.ts", "relative_path": "cline/src/services/tree-sitter/queries/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/index.ts", "source_code": "export { default as phpQuery } from \"./php\"\nexport { default as typescriptQuery } from \"./typescript\"\nexport { default as pythonQuery } from \"./python\"\nexport { default as javascriptQuery } from \"./javascript\"\nexport { default as javaQuery } from \"./java\"\nexport { default as rustQuery } from \"./rust\"\nexport { default as rubyQuery } from \"./ruby\"\nexport { default as cppQuery } from \"./cpp\"\nexport { default as cQuery } from \"./c\"\nexport { default as csharpQuery } from \"./c-sharp\"\nexport { default as goQuery } from \"./go\"\nexport { default as swiftQuery } from \"./swift\"\n", "tag": "", "tokens": 158, "metadata": {}}], "modify_time": 1733144568.7283843}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/java.ts", "relative_path": "cline/src/services/tree-sitter/queries/java.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/tree-sitter/queries/java.ts", "source_code": "/*\n- class declarations\n- method declarations\n- interface declarations\n*/\nexport default `\n(class_declaration\n  name: (identifier) @name.definition.class) @definition.class\n\n(method_declaration\n  name: (identifier) @name.definition.method) @definition.method\n\n(interface_declaration\n  name: (identifier) @name.definition.interface) @definition.interface\n`\n", "tag": "", "tokens": 101, "metadata": {}}], "modify_time": 1733144568.7285516}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/browser/BrowserSession.ts", "relative_path": "cline/src/services/browser/BrowserSession.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/browser/BrowserSession.ts", "source_code": "import * as vscode from \"vscode\"\nimport * as fs from \"fs/promises\"\nimport * as path from \"path\"\nimport { Browser, Page, ScreenshotOptions, TimeoutError, launch } from \"puppeteer-core\"\n// @ts-ignore\nimport PCR from \"puppeteer-chromium-resolver\"\nimport pWaitFor from \"p-wait-for\"\nimport delay from \"delay\"\nimport { fileExistsAtPath } from \"../../utils/fs\"\nimport { BrowserActionResult } from \"../../shared/ExtensionMessage\"\n\ninterface PCRStats {\n\tpuppeteer: { launch: typeof launch }\n\texecutablePath: string\n}\n\nexport class BrowserSession {\n\tprivate context: vscode.ExtensionContext\n\tprivate browser?: Browser\n\tprivate page?: Page\n\tprivate currentMousePosition?: string\n\n\tconstructor(context: vscode.ExtensionContext) {\n\t\tthis.context = context\n\t}\n\n\tprivate async ensureChromiumExists(): Promise<PCRStats> {\n\t\tconst globalStoragePath = this.context?.globalStorageUri?.fsPath\n\t\tif (!globalStoragePath) {\n\t\t\tthrow new Error(\"Global storage uri is invalid\")\n\t\t}\n\n\t\tconst puppeteerDir = path.join(globalStoragePath, \"puppeteer\")\n\t\tconst dirExists = await fileExistsAtPath(puppeteerDir)\n\t\tif (!dirExists) {\n\t\t\tawait fs.mkdir(puppeteerDir, { recursive: true })\n\t\t}\n\n\t\t// if chromium doesn't exist, this will download it to path.join(puppeteerDir, \".chromium-browser-snapshots\")\n\t\t// if it does exist it will return the path to existing chromium\n\t\tconst stats: PCRStats = await PCR({\n\t\t\tdownloadPath: puppeteerDir,\n\t\t})\n\n\t\treturn stats\n\t}\n\n\tasync launchBrowser() {\n\t\tconsole.log(\"launch browser called\")\n\t\tif (this.browser) {\n\t\t\t// throw new Error(\"Browser already launched\")\n\t\t\tawait this.closeBrowser() // this may happen when the model launches a browser again after having used it already before\n\t\t}\n\n\t\tconst stats = await this.ensureChromiumExists()\n\t\tthis.browser = await stats.puppeteer.launch({\n\t\t\targs: [\n\t\t\t\t\"--user-agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36\",\n\t\t\t],\n\t\t\texecutablePath: stats.executablePath,\n\t\t\tdefaultViewport: {\n\t\t\t\twidth: 900,\n\t\t\t\theight: 600,\n\t\t\t},\n\t\t\t// headless: false,\n\t\t})\n\t\t// (latest version of puppeteer does not add headless to user agent)\n\t\tthis.page = await this.browser?.newPage()\n\t}\n\n\tasync closeBrowser(): Promise<BrowserActionResult> {\n\t\tif (this.browser || this.page) {\n\t\t\tconsole.log(\"closing browser...\")\n\t\t\tawait this.browser?.close().catch(() => {})\n\t\t\tthis.browser = undefined\n\t\t\tthis.page = undefined\n\t\t\tthis.currentMousePosition = undefined\n\t\t}\n\t\treturn {}\n\t}\n\n\tasync doAction(action: (page: Page) => Promise<void>): Promise<BrowserActionResult> {\n\t\tif (!this.page) {\n\t\t\tthrow new Error(\n\t\t\t\t\"Browser is not launched. This may occur if the browser was automatically closed by a non-`browser_action` tool.\",\n\t\t\t)\n\t\t}\n\n\t\tconst logs: string[] = []\n\t\tlet lastLogTs = Date.now()\n\n\t\tconst consoleListener = (msg: any) => {\n\t\t\tif (msg.type() === \"log\") {\n\t\t\t\tlogs.push(msg.text())\n\t\t\t} else {\n\t\t\t\tlogs.push(`[${msg.type()}] ${msg.text()}`)\n\t\t\t}\n\t\t\tlastLogTs = Date.now()\n\t\t}\n\n\t\tconst errorListener = (err: Error) => {\n\t\t\tlogs.push(`[Page Error] ${err.toString()}`)\n\t\t\tlastLogTs = Date.now()\n\t\t}\n\n\t\t// Add the listeners\n\t\tthis.page.on(\"console\", consoleListener)\n\t\tthis.page.on(\"pageerror\", errorListener)\n\n\t\ttry {\n\t\t\tawait action(this.page)\n\t\t} catch (err) {\n\t\t\tif (!(err instanceof TimeoutError)) {\n\t\t\t\tlogs.push(`[Error] ${err.toString()}`)\n\t\t\t}\n\t\t}\n\n\t\t// Wait for console inactivity, with a timeout\n\t\tawait pWaitFor(() => Date.now() - lastLogTs >= 500, {\n\t\t\ttimeout: 3_000,\n\t\t\tinterval: 100,\n\t\t}).catch(() => {})\n\n\t\tlet options: ScreenshotOptions = {\n\t\t\tencoding: \"base64\",\n\n\t\t\t// clip: {\n\t\t\t// \tx: 0,\n\t\t\t// \ty: 0,\n\t\t\t// \twidth: 900,\n\t\t\t// \theight: 600,\n\t\t\t// },\n\t\t}\n\n\t\tlet screenshotBase64 = await this.page.screenshot({\n\t\t\t...options,\n\t\t\ttype: \"webp\",\n\t\t})\n\t\tlet screenshot = `data:image/webp;base64,${screenshotBase64}`\n\n\t\tif (!screenshotBase64) {\n\t\t\tconsole.log(\"webp screenshot failed, trying png\")\n\t\t\tscreenshotBase64 = await this.page.screenshot({\n\t\t\t\t...options,\n\t\t\t\ttype: \"png\",\n\t\t\t})\n\t\t\tscreenshot = `data:image/png;base64,${screenshotBase64}`\n\t\t}\n\n\t\tif (!screenshotBase64) {\n\t\t\tthrow new Error(\"Failed to take screenshot.\")\n\t\t}\n\n\t\t// this.page.removeAllListeners() <- causes the page to crash!\n\t\tthis.page.off(\"console\", consoleListener)\n\t\tthis.page.off(\"pageerror\", errorListener)\n\n\t\treturn {\n\t\t\tscreenshot,\n\t\t\tlogs: logs.join(\"\\n\"),\n\t\t\tcurrentUrl: this.page.url(),\n\t\t\tcurrentMousePosition: this.currentMousePosition,\n\t\t}\n\t}\n\n\tasync navigateToUrl(url: string): Promise<BrowserActionResult> {\n\t\treturn this.doAction(async (page) => {\n\t\t\t// networkidle2 isn't good enough since page may take some time to load. we can assume locally running dev sites will reach networkidle0 in a reasonable amount of time\n\t\t\tawait page.goto(url, { timeout: 7_000, waitUntil: [\"domcontentloaded\", \"networkidle2\"] })\n\t\t\t// await page.goto(url, { timeout: 10_000, waitUntil: \"load\" })\n\t\t\tawait this.waitTillHTMLStable(page) // in case the page is loading more resources\n\t\t})\n\t}\n\n\t// page.goto { waitUntil: \"networkidle0\" } may not ever resolve, and not waiting could return page content too early before js has loaded\n\t// https://stackoverflow.com/questions/52497252/puppeteer-wait-until-page-is-completely-loaded/61304202#61304202\n\tprivate async waitTillHTMLStable(page: Page, timeout = 5_000) {\n\t\tconst checkDurationMsecs = 500 // 1000\n\t\tconst maxChecks = timeout / checkDurationMsecs\n\t\tlet lastHTMLSize = 0\n\t\tlet checkCounts = 1\n\t\tlet countStableSizeIterations = 0\n\t\tconst minStableSizeIterations = 3\n\n\t\twhile (checkCounts++ <= maxChecks) {\n\t\t\tlet html = await page.content()\n\t\t\tlet currentHTMLSize = html.length\n\n\t\t\t// let bodyHTMLSize = await page.evaluate(() => document.body.innerHTML.length)\n\t\t\tconsole.log(\"last: \", lastHTMLSize, \" <> curr: \", currentHTMLSize)\n\n\t\t\tif (lastHTMLSize !== 0 && currentHTMLSize === lastHTMLSize) {\n\t\t\t\tcountStableSizeIterations++\n\t\t\t} else {\n\t\t\t\tcountStableSizeIterations = 0 //reset the counter\n\t\t\t}\n\n\t\t\tif (countStableSizeIterations >= minStableSizeIterations) {\n\t\t\t\tconsole.log(\"Page rendered fully...\")\n\t\t\t\tbreak\n\t\t\t}\n\n\t\t\tlastHTMLSize = currentHTMLSize\n\t\t\tawait delay(checkDurationMsecs)\n\t\t}\n\t}\n\n\tasync click(coordinate: string): Promise<BrowserActionResult> {\n\t\tconst [x, y] = coordinate.split(\",\").map(Number)\n\t\treturn this.doAction(async (page) => {\n\t\t\t// Set up network request monitoring\n\t\t\tlet hasNetworkActivity = false\n\t\t\tconst requestListener = () => {\n\t\t\t\thasNetworkActivity = true\n\t\t\t}\n\t\t\tpage.on(\"request\", requestListener)\n\n\t\t\t// Perform the click\n\t\t\tawait page.mouse.click(x, y)\n\t\t\tthis.currentMousePosition = coordinate\n\n\t\t\t// Small delay to check if click triggered any network activity\n\t\t\tawait delay(100)\n\n\t\t\tif (hasNetworkActivity) {\n\t\t\t\t// If we detected network activity, wait for navigation/loading\n\t\t\t\tawait page\n\t\t\t\t\t.waitForNavigation({\n\t\t\t\t\t\twaitUntil: [\"domcontentloaded\", \"networkidle2\"],\n\t\t\t\t\t\ttimeout: 7000,\n\t\t\t\t\t})\n\t\t\t\t\t.catch(() => {})\n\t\t\t\tawait this.waitTillHTMLStable(page)\n\t\t\t}\n\n\t\t\t// Clean up listener\n\t\t\tpage.off(\"request\", requestListener)\n\t\t})\n\t}\n\n\tasync type(text: string): Promise<BrowserActionResult> {\n\t\treturn this.doAction(async (page) => {\n\t\t\tawait page.keyboard.type(text)\n\t\t})\n\t}\n\n\tasync scrollDown(): Promise<BrowserActionResult> {\n\t\treturn this.doAction(async (page) => {\n\t\t\tawait page.evaluate(() => {\n\t\t\t\twindow.scrollBy({\n\t\t\t\t\ttop: 600,\n\t\t\t\t\tbehavior: \"auto\",\n\t\t\t\t})\n\t\t\t})\n\t\t\tawait delay(300)\n\t\t})\n\t}\n\n\tasync scrollUp(): Promise<BrowserActionResult> {\n\t\treturn this.doAction(async (page) => {\n\t\t\tawait page.evaluate(() => {\n\t\t\t\twindow.scrollBy({\n\t\t\t\t\ttop: -600,\n\t\t\t\t\tbehavior: \"auto\",\n\t\t\t\t})\n\t\t\t})\n\t\t\tawait delay(300)\n\t\t})\n\t}\n}\n", "tag": "", "tokens": 2466, "metadata": {}}], "modify_time": 1733144568.7267435}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/browser/UrlContentFetcher.ts", "relative_path": "cline/src/services/browser/UrlContentFetcher.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/browser/UrlContentFetcher.ts", "source_code": "import * as vscode from \"vscode\"\nimport * as fs from \"fs/promises\"\nimport * as path from \"path\"\nimport { Browser, Page, launch } from \"puppeteer-core\"\nimport * as cheerio from \"cheerio\"\nimport TurndownService from \"turndown\"\n// @ts-ignore\nimport PCR from \"puppeteer-chromium-resolver\"\nimport { fileExistsAtPath } from \"../../utils/fs\"\n\ninterface PCRStats {\n\tpuppeteer: { launch: typeof launch }\n\texecutablePath: string\n}\n\nexport class UrlContentFetcher {\n\tprivate context: vscode.ExtensionContext\n\tprivate browser?: Browser\n\tprivate page?: Page\n\n\tconstructor(context: vscode.ExtensionContext) {\n\t\tthis.context = context\n\t}\n\n\tprivate async ensureChromiumExists(): Promise<PCRStats> {\n\t\tconst globalStoragePath = this.context?.globalStorageUri?.fsPath\n\t\tif (!globalStoragePath) {\n\t\t\tthrow new Error(\"Global storage uri is invalid\")\n\t\t}\n\t\tconst puppeteerDir = path.join(globalStoragePath, \"puppeteer\")\n\t\tconst dirExists = await fileExistsAtPath(puppeteerDir)\n\t\tif (!dirExists) {\n\t\t\tawait fs.mkdir(puppeteerDir, { recursive: true })\n\t\t}\n\t\t// if chromium doesn't exist, this will download it to path.join(puppeteerDir, \".chromium-browser-snapshots\")\n\t\t// if it does exist it will return the path to existing chromium\n\t\tconst stats: PCRStats = await PCR({\n\t\t\tdownloadPath: puppeteerDir,\n\t\t})\n\t\treturn stats\n\t}\n\n\tasync launchBrowser(): Promise<void> {\n\t\tif (this.browser) {\n\t\t\treturn\n\t\t}\n\t\tconst stats = await this.ensureChromiumExists()\n\t\tthis.browser = await stats.puppeteer.launch({\n\t\t\targs: [\n\t\t\t\t\"--user-agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36\",\n\t\t\t],\n\t\t\texecutablePath: stats.executablePath,\n\t\t})\n\t\t// (latest version of puppeteer does not add headless to user agent)\n\t\tthis.page = await this.browser?.newPage()\n\t}\n\n\tasync closeBrowser(): Promise<void> {\n\t\tawait this.browser?.close()\n\t\tthis.browser = undefined\n\t\tthis.page = undefined\n\t}\n\n\t// must make sure to call launchBrowser before and closeBrowser after using this\n\tasync urlToMarkdown(url: string): Promise<string> {\n\t\tif (!this.browser || !this.page) {\n\t\t\tthrow new Error(\"Browser not initialized\")\n\t\t}\n\t\t/*\n\t\t- networkidle2 is equivalent to playwright's networkidle where it waits until there are no more than 2 network connections for at least 500 ms.\n\t\t- domcontentloaded is when the basic DOM is loaded\n\t\tthis should be sufficient for most doc sites\n\t\t*/\n\t\tawait this.page.goto(url, { timeout: 10_000, waitUntil: [\"domcontentloaded\", \"networkidle2\"] })\n\t\tconst content = await this.page.content()\n\n\t\t// use cheerio to parse and clean up the HTML\n\t\tconst $ = cheerio.load(content)\n\t\t$(\"script, style, nav, footer, header\").remove()\n\n\t\t// convert cleaned HTML to markdown\n\t\tconst turndownService = new TurndownService()\n\t\tconst markdown = turndownService.turndown($.html())\n\n\t\treturn markdown\n\t}\n}\n", "tag": "", "tokens": 868, "metadata": {}}], "modify_time": 1733144568.7268968}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/glob/list-files.ts", "relative_path": "cline/src/services/glob/list-files.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/glob/list-files.ts", "source_code": "import { globby, Options } from \"globby\"\nimport os from \"os\"\nimport * as path from \"path\"\nimport { arePathsEqual } from \"../../utils/path\"\n\nexport async function listFiles(dirPath: string, recursive: boolean, limit: number): Promise<[string[], boolean]> {\n\tconst absolutePath = path.resolve(dirPath)\n\t// Do not allow listing files in root or home directory, which cline tends to want to do when the user's prompt is vague.\n\tconst root = process.platform === \"win32\" ? path.parse(absolutePath).root : \"/\"\n\tconst isRoot = arePathsEqual(absolutePath, root)\n\tif (isRoot) {\n\t\treturn [[root], false]\n\t}\n\tconst homeDir = os.homedir()\n\tconst isHomeDir = arePathsEqual(absolutePath, homeDir)\n\tif (isHomeDir) {\n\t\treturn [[homeDir], false]\n\t}\n\n\tconst dirsToIgnore = [\n\t\t\"node_modules\",\n\t\t\"__pycache__\",\n\t\t\"env\",\n\t\t\"venv\",\n\t\t\"target/dependency\",\n\t\t\"build/dependencies\",\n\t\t\"dist\",\n\t\t\"out\",\n\t\t\"bundle\",\n\t\t\"vendor\",\n\t\t\"tmp\",\n\t\t\"temp\",\n\t\t\"deps\",\n\t\t\"pkg\",\n\t\t\"Pods\",\n\t\t\".*\", // '!**/.*' excludes hidden directories, while '!**/.*/**' excludes only their contents. This way we are at least aware of the existence of hidden directories.\n\t].map((dir) => `**/${dir}/**`)\n\n\tconst options = {\n\t\tcwd: dirPath,\n\t\tdot: true, // do not ignore hidden files/directories\n\t\tabsolute: true,\n\t\tmarkDirectories: true, // Append a / on any directories matched (/ is used on windows as well, so dont use path.sep)\n\t\tgitignore: recursive, // globby ignores any files that are gitignored\n\t\tignore: recursive ? dirsToIgnore : undefined, // just in case there is no gitignore, we ignore sensible defaults\n\t\tonlyFiles: false, // true by default, false means it will list directories on their own too\n\t}\n\t// * globs all files in one dir, ** globs files in nested directories\n\tconst files = recursive ? await globbyLevelByLevel(limit, options) : (await globby(\"*\", options)).slice(0, limit)\n\treturn [files, files.length >= limit]\n}\n\n/*\nBreadth-first traversal of directory structure level by level up to a limit:\n   - Queue-based approach ensures proper breadth-first traversal\n   - Processes directory patterns level by level\n   - Captures a representative sample of the directory structure up to the limit\n   - Minimizes risk of missing deeply nested files\n\n- Notes:\n   - Relies on globby to mark directories with /\n   - Potential for loops if symbolic links reference back to parent (we could use followSymlinks: false but that may not be ideal for some projects and it's pointless if they're not using symlinks wrong)\n   - Timeout mechanism prevents infinite loops\n*/\nasync function globbyLevelByLevel(limit: number, options?: Options) {\n\tlet results: Set<string> = new Set()\n\tlet queue: string[] = [\"*\"]\n\n\tconst globbingProcess = async () => {\n\t\twhile (queue.length > 0 && results.size < limit) {\n\t\t\tconst pattern = queue.shift()!\n\t\t\tconst filesAtLevel = await globby(pattern, options)\n\n\t\t\tfor (const file of filesAtLevel) {\n\t\t\t\tif (results.size >= limit) {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tresults.add(file)\n\t\t\t\tif (file.endsWith(\"/\")) {\n\t\t\t\t\tqueue.push(`${file}*`)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn Array.from(results).slice(0, limit)\n\t}\n\n\t// Timeout after 10 seconds and return partial results\n\tconst timeoutPromise = new Promise<string[]>((_, reject) => {\n\t\tsetTimeout(() => reject(new Error(\"Globbing timeout\")), 10_000)\n\t})\n\ttry {\n\t\treturn await Promise.race([globbingProcess(), timeoutPromise])\n\t} catch (error) {\n\t\tconsole.warn(\"Globbing timed out, returning partial results\")\n\t\treturn Array.from(results)\n\t}\n}\n", "tag": "", "tokens": 1005, "metadata": {}}], "modify_time": 1733144568.7270849}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/ripgrep/index.ts", "relative_path": "cline/src/services/ripgrep/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/cline/src/services/ripgrep/index.ts", "source_code": "import * as vscode from \"vscode\"\nimport * as childProcess from \"child_process\"\nimport * as path from \"path\"\nimport * as fs from \"fs\"\nimport * as readline from \"readline\"\n\n/*\nThis file provides functionality to perform regex searches on files using ripgrep.\nInspired by: https://github.com/DiscreteTom/vscode-ripgrep-utils\n\nKey components:\n1. getBinPath: Locates the ripgrep binary within the VSCode installation.\n2. execRipgrep: Executes the ripgrep command and returns the output.\n3. regexSearchFiles: The main function that performs regex searches on files.\n   - Parameters:\n     * cwd: The current working directory (for relative path calculation)\n     * directoryPath: The directory to search in\n     * regex: The regular expression to search for (Rust regex syntax)\n     * filePattern: Optional glob pattern to filter files (default: '*')\n   - Returns: A formatted string containing search results with context\n\nThe search results include:\n- Relative file paths\n- 2 lines of context before and after each match\n- Matches formatted with pipe characters for easy reading\n\nUsage example:\nconst results = await regexSearchFiles('/path/to/cwd', '/path/to/search', 'TODO:', '*.ts');\n\nrel/path/to/app.ts\n│----\n│function processData(data: any) {\n│  // Some processing logic here\n│  // TODO: Implement error handling\n│  return processedData;\n│}\n│----\n\nrel/path/to/helper.ts\n│----\n│  let result = 0;\n│  for (let i = 0; i < input; i++) {\n│    // TODO: Optimize this function for performance\n│    result += Math.pow(i, 2);\n│  }\n│----\n*/\n\nconst isWindows = /^win/.test(process.platform)\nconst binName = isWindows ? \"rg.exe\" : \"rg\"\n\ninterface SearchResult {\n\tfile: string\n\tline: number\n\tcolumn: number\n\tmatch: string\n\tbeforeContext: string[]\n\tafterContext: string[]\n}\n\nconst MAX_RESULTS = 300\n\nasync function getBinPath(vscodeAppRoot: string): Promise<string | undefined> {\n\tconst checkPath = async (pkgFolder: string) => {\n\t\tconst fullPath = path.join(vscodeAppRoot, pkgFolder, binName)\n\t\treturn (await pathExists(fullPath)) ? fullPath : undefined\n\t}\n\n\treturn (\n\t\t(await checkPath(\"node_modules/@vscode/ripgrep/bin/\")) ||\n\t\t(await checkPath(\"node_modules/vscode-ripgrep/bin\")) ||\n\t\t(await checkPath(\"node_modules.asar.unpacked/vscode-ripgrep/bin/\")) ||\n\t\t(await checkPath(\"node_modules.asar.unpacked/@vscode/ripgrep/bin/\"))\n\t)\n}\n\nasync function pathExists(path: string): Promise<boolean> {\n\treturn new Promise((resolve) => {\n\t\tfs.access(path, (err) => {\n\t\t\tresolve(err === null)\n\t\t})\n\t})\n}\n\nasync function execRipgrep(bin: string, args: string[]): Promise<string> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst rgProcess = childProcess.spawn(bin, args)\n\t\t// cross-platform alternative to head, which is ripgrep author's recommendation for limiting output.\n\t\tconst rl = readline.createInterface({\n\t\t\tinput: rgProcess.stdout,\n\t\t\tcrlfDelay: Infinity, // treat \\r\\n as a single line break even if it's split across chunks. This ensures consistent behavior across different operating systems.\n\t\t})\n\n\t\tlet output = \"\"\n\t\tlet lineCount = 0\n\t\tconst maxLines = MAX_RESULTS * 5 // limiting ripgrep output with max lines since there's no other way to limit results. it's okay that we're outputting as json, since we're parsing it line by line and ignore anything that's not part of a match. This assumes each result is at most 5 lines.\n\n\t\trl.on(\"line\", (line) => {\n\t\t\tif (lineCount < maxLines) {\n\t\t\t\toutput += line + \"\\n\"\n\t\t\t\tlineCount++\n\t\t\t} else {\n\t\t\t\trl.close()\n\t\t\t\trgProcess.kill()\n\t\t\t}\n\t\t})\n\n\t\tlet errorOutput = \"\"\n\t\trgProcess.stderr.on(\"data\", (data) => {\n\t\t\terrorOutput += data.toString()\n\t\t})\n\t\trl.on(\"close\", () => {\n\t\t\tif (errorOutput) {\n\t\t\t\treject(new Error(`ripgrep process error: ${errorOutput}`))\n\t\t\t} else {\n\t\t\t\tresolve(output)\n\t\t\t}\n\t\t})\n\t\trgProcess.on(\"error\", (error) => {\n\t\t\treject(new Error(`ripgrep process error: ${error.message}`))\n\t\t})\n\t})\n}\n\nexport async function regexSearchFiles(\n\tcwd: string,\n\tdirectoryPath: string,\n\tregex: string,\n\tfilePattern?: string,\n): Promise<string> {\n\tconst vscodeAppRoot = vscode.env.appRoot\n\tconst rgPath = await getBinPath(vscodeAppRoot)\n\n\tif (!rgPath) {\n\t\tthrow new Error(\"Could not find ripgrep binary\")\n\t}\n\n\tconst args = [\"--json\", \"-e\", regex, \"--glob\", filePattern || \"*\", \"--context\", \"1\", directoryPath]\n\n\tlet output: string\n\ttry {\n\t\toutput = await execRipgrep(rgPath, args)\n\t} catch {\n\t\treturn \"No results found\"\n\t}\n\tconst results: SearchResult[] = []\n\tlet currentResult: Partial<SearchResult> | null = null\n\n\toutput.split(\"\\n\").forEach((line) => {\n\t\tif (line) {\n\t\t\ttry {\n\t\t\t\tconst parsed = JSON.parse(line)\n\t\t\t\tif (parsed.type === \"match\") {\n\t\t\t\t\tif (currentResult) {\n\t\t\t\t\t\tresults.push(currentResult as SearchResult)\n\t\t\t\t\t}\n\t\t\t\t\tcurrentResult = {\n\t\t\t\t\t\tfile: parsed.data.path.text,\n\t\t\t\t\t\tline: parsed.data.line_number,\n\t\t\t\t\t\tcolumn: parsed.data.submatches[0].start,\n\t\t\t\t\t\tmatch: parsed.data.lines.text,\n\t\t\t\t\t\tbeforeContext: [],\n\t\t\t\t\t\tafterContext: [],\n\t\t\t\t\t}\n\t\t\t\t} else if (parsed.type === \"context\" && currentResult) {\n\t\t\t\t\tif (parsed.data.line_number < currentResult.line!) {\n\t\t\t\t\t\tcurrentResult.beforeContext!.push(parsed.data.lines.text)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcurrentResult.afterContext!.push(parsed.data.lines.text)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\"Error parsing ripgrep output:\", error)\n\t\t\t}\n\t\t}\n\t})\n\n\tif (currentResult) {\n\t\tresults.push(currentResult as SearchResult)\n\t}\n\n\treturn formatResults(results, cwd)\n}\n\nfunction formatResults(results: SearchResult[], cwd: string): string {\n\tconst groupedResults: { [key: string]: SearchResult[] } = {}\n\n\tlet output = \"\"\n\tif (results.length >= MAX_RESULTS) {\n\t\toutput += `Showing first ${MAX_RESULTS} of ${MAX_RESULTS}+ results. Use a more specific search if necessary.\\n\\n`\n\t} else {\n\t\toutput += `Found ${results.length === 1 ? \"1 result\" : `${results.length.toLocaleString()} results`}.\\n\\n`\n\t}\n\n\t// Group results by file name\n\tresults.slice(0, MAX_RESULTS).forEach((result) => {\n\t\tconst relativeFilePath = path.relative(cwd, result.file)\n\t\tif (!groupedResults[relativeFilePath]) {\n\t\t\tgroupedResults[relativeFilePath] = []\n\t\t}\n\t\tgroupedResults[relativeFilePath].push(result)\n\t})\n\n\tfor (const [filePath, fileResults] of Object.entries(groupedResults)) {\n\t\toutput += `${filePath.toPosix()}\\n│----\\n`\n\n\t\tfileResults.forEach((result, index) => {\n\t\t\tconst allLines = [...result.beforeContext, result.match, ...result.afterContext]\n\t\t\tallLines.forEach((line) => {\n\t\t\t\toutput += `│${line?.trimEnd() ?? \"\"}\\n`\n\t\t\t})\n\n\t\t\tif (index < fileResults.length - 1) {\n\t\t\t\toutput += \"│----\\n\"\n\t\t\t}\n\t\t})\n\n\t\toutput += \"│----\\n\\n\"\n\t}\n\n\treturn output.trim()\n}\n", "tag": "", "tokens": 2034, "metadata": {}}], "modify_time": 1733144568.7273965}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/load-context.ts", "relative_path": "bolt.new/load-context.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/load-context.ts", "source_code": "import { type PlatformProxy } from 'wrangler';\n\ntype Cloudflare = Omit<PlatformProxy<Env>, 'dispose'>;\n\ndeclare module '@remix-run/cloudflare' {\n  interface AppLoadContext {\n    cloudflare: Cloudflare;\n  }\n}\n", "tag": "", "tokens": 71, "metadata": {}}], "modify_time": 1733125234.6337461}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/uno.config.ts", "relative_path": "bolt.new/uno.config.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/uno.config.ts", "source_code": "import { globSync } from 'fast-glob';\nimport fs from 'node:fs/promises';\nimport { basename } from 'node:path';\nimport { defineConfig, presetIcons, presetUno, transformerDirectives } from 'unocss';\n\nconst iconPaths = globSync('./icons/*.svg');\n\nconst collectionName = 'bolt';\n\nconst customIconCollection = iconPaths.reduce(\n  (acc, iconPath) => {\n    const [iconName] = basename(iconPath).split('.');\n\n    acc[collectionName] ??= {};\n    acc[collectionName][iconName] = async () => fs.readFile(iconPath, 'utf8');\n\n    return acc;\n  },\n  {} as Record<string, Record<string, () => Promise<string>>>,\n);\n\nconst BASE_COLORS = {\n  white: '#FFFFFF',\n  gray: {\n    50: '#FAFAFA',\n    100: '#F5F5F5',\n    200: '#E5E5E5',\n    300: '#D4D4D4',\n    400: '#A3A3A3',\n    500: '#737373',\n    600: '#525252',\n    700: '#404040',\n    800: '#262626',\n    900: '#171717',\n    950: '#0A0A0A',\n  },\n  accent: {\n    50: '#EEF9FF',\n    100: '#D8F1FF',\n    200: '#BAE7FF',\n    300: '#8ADAFF',\n    400: '#53C4FF',\n    500: '#2BA6FF',\n    600: '#1488FC',\n    700: '#0D6FE8',\n    800: '#1259BB',\n    900: '#154E93',\n    950: '#122F59',\n  },\n  green: {\n    50: '#F0FDF4',\n    100: '#DCFCE7',\n    200: '#BBF7D0',\n    300: '#86EFAC',\n    400: '#4ADE80',\n    500: '#22C55E',\n    600: '#16A34A',\n    700: '#15803D',\n    800: '#166534',\n    900: '#14532D',\n    950: '#052E16',\n  },\n  orange: {\n    50: '#FFFAEB',\n    100: '#FEEFC7',\n    200: '#FEDF89',\n    300: '#FEC84B',\n    400: '#FDB022',\n    500: '#F79009',\n    600: '#DC6803',\n    700: '#B54708',\n    800: '#93370D',\n    900: '#792E0D',\n  },\n  red: {\n    50: '#FEF2F2',\n    100: '#FEE2E2',\n    200: '#FECACA',\n    300: '#FCA5A5',\n    400: '#F87171',\n    500: '#EF4444',\n    600: '#DC2626',\n    700: '#B91C1C',\n    800: '#991B1B',\n    900: '#7F1D1D',\n    950: '#450A0A',\n  },\n};\n\nconst COLOR_PRIMITIVES = {\n  ...BASE_COLORS,\n  alpha: {\n    white: generateAlphaPalette(BASE_COLORS.white),\n    gray: generateAlphaPalette(BASE_COLORS.gray[900]),\n    red: generateAlphaPalette(BASE_COLORS.red[500]),\n    accent: generateAlphaPalette(BASE_COLORS.accent[500]),\n  },\n};\n\nexport default defineConfig({\n  shortcuts: {\n    'bolt-ease-cubic-bezier': 'ease-[cubic-bezier(0.4,0,0.2,1)]',\n    'transition-theme': 'transition-[background-color,border-color,color] duration-150 bolt-ease-cubic-bezier',\n    kdb: 'bg-bolt-elements-code-background text-bolt-elements-code-text py-1 px-1.5 rounded-md',\n    'max-w-chat': 'max-w-[var(--chat-max-width)]',\n  },\n  rules: [\n    /**\n     * This shorthand doesn't exist in Tailwind and we overwrite it to avoid\n     * any conflicts with minified CSS classes.\n     */\n    ['b', {}],\n  ],\n  theme: {\n    colors: {\n      ...COLOR_PRIMITIVES,\n      bolt: {\n        elements: {\n          borderColor: 'var(--bolt-elements-borderColor)',\n          borderColorActive: 'var(--bolt-elements-borderColorActive)',\n          background: {\n            depth: {\n              1: 'var(--bolt-elements-bg-depth-1)',\n              2: 'var(--bolt-elements-bg-depth-2)',\n              3: 'var(--bolt-elements-bg-depth-3)',\n              4: 'var(--bolt-elements-bg-depth-4)',\n            },\n          },\n          textPrimary: 'var(--bolt-elements-textPrimary)',\n          textSecondary: 'var(--bolt-elements-textSecondary)',\n          textTertiary: 'var(--bolt-elements-textTertiary)',\n          code: {\n            background: 'var(--bolt-elements-code-background)',\n            text: 'var(--bolt-elements-code-text)',\n          },\n          button: {\n            primary: {\n              background: 'var(--bolt-elements-button-primary-background)',\n              backgroundHover: 'var(--bolt-elements-button-primary-backgroundHover)',\n              text: 'var(--bolt-elements-button-primary-text)',\n            },\n            secondary: {\n              background: 'var(--bolt-elements-button-secondary-background)',\n              backgroundHover: 'var(--bolt-elements-button-secondary-backgroundHover)',\n              text: 'var(--bolt-elements-button-secondary-text)',\n            },\n            danger: {\n              background: 'var(--bolt-elements-button-danger-background)',\n              backgroundHover: 'var(--bolt-elements-button-danger-backgroundHover)',\n              text: 'var(--bolt-elements-button-danger-text)',\n            },\n          },\n          item: {\n            contentDefault: 'var(--bolt-elements-item-contentDefault)',\n            contentActive: 'var(--bolt-elements-item-contentActive)',\n            contentAccent: 'var(--bolt-elements-item-contentAccent)',\n            contentDanger: 'var(--bolt-elements-item-contentDanger)',\n            backgroundDefault: 'var(--bolt-elements-item-backgroundDefault)',\n            backgroundActive: 'var(--bolt-elements-item-backgroundActive)',\n            backgroundAccent: 'var(--bolt-elements-item-backgroundAccent)',\n            backgroundDanger: 'var(--bolt-elements-item-backgroundDanger)',\n          },\n          actions: {\n            background: 'var(--bolt-elements-actions-background)',\n            code: {\n              background: 'var(--bolt-elements-actions-code-background)',\n            },\n          },\n          artifacts: {\n            background: 'var(--bolt-elements-artifacts-background)',\n            backgroundHover: 'var(--bolt-elements-artifacts-backgroundHover)',\n            borderColor: 'var(--bolt-elements-artifacts-borderColor)',\n            inlineCode: {\n              background: 'var(--bolt-elements-artifacts-inlineCode-background)',\n              text: 'var(--bolt-elements-artifacts-inlineCode-text)',\n            },\n          },\n          messages: {\n            background: 'var(--bolt-elements-messages-background)',\n            linkColor: 'var(--bolt-elements-messages-linkColor)',\n            code: {\n              background: 'var(--bolt-elements-messages-code-background)',\n            },\n            inlineCode: {\n              background: 'var(--bolt-elements-messages-inlineCode-background)',\n              text: 'var(--bolt-elements-messages-inlineCode-text)',\n            },\n          },\n          icon: {\n            success: 'var(--bolt-elements-icon-success)',\n            error: 'var(--bolt-elements-icon-error)',\n            primary: 'var(--bolt-elements-icon-primary)',\n            secondary: 'var(--bolt-elements-icon-secondary)',\n            tertiary: 'var(--bolt-elements-icon-tertiary)',\n          },\n          preview: {\n            addressBar: {\n              background: 'var(--bolt-elements-preview-addressBar-background)',\n              backgroundHover: 'var(--bolt-elements-preview-addressBar-backgroundHover)',\n              backgroundActive: 'var(--bolt-elements-preview-addressBar-backgroundActive)',\n              text: 'var(--bolt-elements-preview-addressBar-text)',\n              textActive: 'var(--bolt-elements-preview-addressBar-textActive)',\n            },\n          },\n          terminals: {\n            background: 'var(--bolt-elements-terminals-background)',\n            buttonBackground: 'var(--bolt-elements-terminals-buttonBackground)',\n          },\n          dividerColor: 'var(--bolt-elements-dividerColor)',\n          loader: {\n            background: 'var(--bolt-elements-loader-background)',\n            progress: 'var(--bolt-elements-loader-progress)',\n          },\n          prompt: {\n            background: 'var(--bolt-elements-prompt-background)',\n          },\n          sidebar: {\n            dropdownShadow: 'var(--bolt-elements-sidebar-dropdownShadow)',\n            buttonBackgroundDefault: 'var(--bolt-elements-sidebar-buttonBackgroundDefault)',\n            buttonBackgroundHover: 'var(--bolt-elements-sidebar-buttonBackgroundHover)',\n            buttonText: 'var(--bolt-elements-sidebar-buttonText)',\n          },\n          cta: {\n            background: 'var(--bolt-elements-cta-background)',\n            text: 'var(--bolt-elements-cta-text)',\n          },\n        },\n      },\n    },\n  },\n  transformers: [transformerDirectives()],\n  presets: [\n    presetUno({\n      dark: {\n        light: '[data-theme=\"light\"]',\n        dark: '[data-theme=\"dark\"]',\n      },\n    }),\n    presetIcons({\n      warn: true,\n      collections: {\n        ...customIconCollection,\n      },\n    }),\n  ],\n});\n\n/**\n * Generates an alpha palette for a given hex color.\n *\n * @param hex - The hex color code (without alpha) to generate the palette from.\n * @returns An object where keys are opacity percentages and values are hex colors with alpha.\n *\n * Example:\n *\n * ```\n * {\n *   '1': '#FFFFFF03',\n *   '2': '#FFFFFF05',\n *   '3': '#FFFFFF08',\n * }\n * ```\n */\nfunction generateAlphaPalette(hex: string) {\n  return [1, 2, 3, 4, 5, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100].reduce(\n    (acc, opacity) => {\n      const alpha = Math.round((opacity / 100) * 255)\n        .toString(16)\n        .padStart(2, '0');\n\n      acc[opacity] = `${hex}${alpha}`;\n\n      return acc;\n    },\n    {} as Record<number, string>,\n  );\n}\n", "tag": "", "tokens": 2899, "metadata": {}}], "modify_time": 1733125234.6432521}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/vite.config.ts", "relative_path": "bolt.new/vite.config.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/vite.config.ts", "source_code": "import { cloudflareDevProxyVitePlugin as remixCloudflareDevProxy, vitePlugin as remixVitePlugin } from '@remix-run/dev';\nimport UnoCSS from 'unocss/vite';\nimport { defineConfig, type ViteDevServer } from 'vite';\nimport { nodePolyfills } from 'vite-plugin-node-polyfills';\nimport { optimizeCssModules } from 'vite-plugin-optimize-css-modules';\nimport tsconfigPaths from 'vite-tsconfig-paths';\n\nexport default defineConfig((config) => {\n  return {\n    build: {\n      target: 'esnext',\n    },\n    plugins: [\n      nodePolyfills({\n        include: ['path', 'buffer'],\n      }),\n      config.mode !== 'test' && remixCloudflareDevProxy(),\n      remixVitePlugin({\n        future: {\n          v3_fetcherPersist: true,\n          v3_relativeSplatPath: true,\n          v3_throwAbortReason: true,\n        },\n      }),\n      UnoCSS(),\n      tsconfigPaths(),\n      chrome129IssuePlugin(),\n      config.mode === 'production' && optimizeCssModules({ apply: 'build' }),\n    ],\n  };\n});\n\nfunction chrome129IssuePlugin() {\n  return {\n    name: 'chrome129IssuePlugin',\n    configureServer(server: ViteDevServer) {\n      server.middlewares.use((req, res, next) => {\n        const raw = req.headers['user-agent']?.match(/Chrom(e|ium)\\/([0-9]+)\\./);\n\n        if (raw) {\n          const version = parseInt(raw[2], 10);\n\n          if (version === 129) {\n            res.setHeader('content-type', 'text/html');\n            res.end(\n              '<body><h1>Please use Chrome Canary for testing.</h1><p>Chrome 129 has an issue with JavaScript modules & Vite local development, see <a href=\"https://github.com/stackblitz/bolt.new/issues/86#issuecomment-2395519258\">for more information.</a></p><p><b>Note:</b> This only impacts <u>local development</u>. `pnpm run build` and `pnpm run start` will work fine in this browser.</p></body>',\n            );\n\n            return;\n          }\n        }\n\n        next();\n      });\n    },\n  };\n}\n", "tag": "", "tokens": 603, "metadata": {}}], "modify_time": 1733125234.643458}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/worker-configuration.d.ts", "relative_path": "bolt.new/worker-configuration.d.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/worker-configuration.d.ts", "source_code": "interface Env {\n  ANTHROPIC_API_KEY: string;\n}\n", "tag": "", "tokens": 27, "metadata": {}}], "modify_time": 1733125234.6436057}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/types/istextorbinary.d.ts", "relative_path": "bolt.new/types/istextorbinary.d.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/types/istextorbinary.d.ts", "source_code": "/**\n * @note For some reason the types aren't picked up from node_modules so I declared the module here\n * with only the function that we use.\n */\ndeclare module 'istextorbinary' {\n  export interface EncodingOpts {\n    /** Defaults to 24 */\n    chunkLength?: number;\n\n    /** If not provided, will check the start, beginning, and end */\n    chunkBegin?: number;\n  }\n\n  export function getEncoding(buffer: Buffer | null, opts?: EncodingOpts): 'utf8' | 'binary' | null;\n}\n", "tag": "", "tokens": 139, "metadata": {}}], "modify_time": 1733125234.6430392}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/entry.server.tsx", "relative_path": "bolt.new/app/entry.server.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/entry.server.tsx", "source_code": "import type { AppLoadContext, EntryContext } from '@remix-run/cloudflare';\nimport { RemixServer } from '@remix-run/react';\nimport { isbot } from 'isbot';\nimport { renderToReadableStream } from 'react-dom/server';\nimport { renderHeadToString } from 'remix-island';\nimport { Head } from './root';\nimport { themeStore } from '~/lib/stores/theme';\n\nexport default async function handleRequest(\n  request: Request,\n  responseStatusCode: number,\n  responseHeaders: Headers,\n  remixContext: EntryContext,\n  _loadContext: AppLoadContext,\n) {\n  const readable = await renderToReadableStream(<RemixServer context={remixContext} url={request.url} />, {\n    signal: request.signal,\n    onError(error: unknown) {\n      console.error(error);\n      responseStatusCode = 500;\n    },\n  });\n\n  const body = new ReadableStream({\n    start(controller) {\n      const head = renderHeadToString({ request, remixContext, Head });\n\n      controller.enqueue(\n        new Uint8Array(\n          new TextEncoder().encode(\n            `<!DOCTYPE html><html lang=\"en\" data-theme=\"${themeStore.value}\"><head>${head}</head><body><div id=\"root\" class=\"w-full h-full\">`,\n          ),\n        ),\n      );\n\n      const reader = readable.getReader();\n\n      function read() {\n        reader\n          .read()\n          .then(({ done, value }) => {\n            if (done) {\n              controller.enqueue(new Uint8Array(new TextEncoder().encode(`</div></body></html>`)));\n              controller.close();\n\n              return;\n            }\n\n            controller.enqueue(value);\n            read();\n          })\n          .catch((error) => {\n            controller.error(error);\n            readable.cancel();\n          });\n      }\n      read();\n    },\n\n    cancel() {\n      readable.cancel();\n    },\n  });\n\n  if (isbot(request.headers.get('user-agent') || '')) {\n    await readable.allReady;\n  }\n\n  responseHeaders.set('Content-Type', 'text/html');\n\n  responseHeaders.set('Cross-Origin-Embedder-Policy', 'require-corp');\n  responseHeaders.set('Cross-Origin-Opener-Policy', 'same-origin');\n\n  return new Response(body, {\n    headers: responseHeaders,\n    status: responseStatusCode,\n  });\n}\n", "tag": "", "tokens": 615, "metadata": {}}], "modify_time": 1733125234.6240454}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/entry.client.tsx", "relative_path": "bolt.new/app/entry.client.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/entry.client.tsx", "source_code": "import { RemixBrowser } from '@remix-run/react';\nimport { startTransition } from 'react';\nimport { hydrateRoot } from 'react-dom/client';\n\nstartTransition(() => {\n  hydrateRoot(document.getElementById('root')!, <RemixBrowser />);\n});\n", "tag": "", "tokens": 76, "metadata": {}}], "modify_time": 1733125234.6239314}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/root.tsx", "relative_path": "bolt.new/app/root.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/root.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport type { LinksFunction } from '@remix-run/cloudflare';\nimport { Links, Meta, Outlet, Scripts, ScrollRestoration } from '@remix-run/react';\nimport tailwindReset from '@unocss/reset/tailwind-compat.css?url';\nimport { themeStore } from './lib/stores/theme';\nimport { stripIndents } from './utils/stripIndent';\nimport { createHead } from 'remix-island';\nimport { useEffect } from 'react';\n\nimport reactToastifyStyles from 'react-toastify/dist/ReactToastify.css?url';\nimport globalStyles from './styles/index.scss?url';\nimport xtermStyles from '@xterm/xterm/css/xterm.css?url';\n\nimport 'virtual:uno.css';\n\nexport const links: LinksFunction = () => [\n  {\n    rel: 'icon',\n    href: '/favicon.svg',\n    type: 'image/svg+xml',\n  },\n  { rel: 'stylesheet', href: reactToastifyStyles },\n  { rel: 'stylesheet', href: tailwindReset },\n  { rel: 'stylesheet', href: globalStyles },\n  { rel: 'stylesheet', href: xtermStyles },\n  {\n    rel: 'preconnect',\n    href: 'https://fonts.googleapis.com',\n  },\n  {\n    rel: 'preconnect',\n    href: 'https://fonts.gstatic.com',\n    crossOrigin: 'anonymous',\n  },\n  {\n    rel: 'stylesheet',\n    href: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap',\n  },\n];\n\nconst inlineThemeCode = stripIndents`\n  setTutorialKitTheme();\n\n  function setTutorialKitTheme() {\n    let theme = localStorage.getItem('bolt_theme');\n\n    if (!theme) {\n      theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';\n    }\n\n    document.querySelector('html')?.setAttribute('data-theme', theme);\n  }\n`;\n\nexport const Head = createHead(() => (\n  <>\n    <meta charSet=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <Meta />\n    <Links />\n    <script dangerouslySetInnerHTML={{ __html: inlineThemeCode }} />\n  </>\n));\n\nexport function Layout({ children }: { children: React.ReactNode }) {\n  const theme = useStore(themeStore);\n\n  useEffect(() => {\n    document.querySelector('html')?.setAttribute('data-theme', theme);\n  }, [theme]);\n\n  return (\n    <>\n      {children}\n      <ScrollRestoration />\n      <Scripts />\n    </>\n  );\n}\n\nexport default function App() {\n  return <Outlet />;\n}\n", "tag": "", "tokens": 727, "metadata": {}}], "modify_time": 1733125234.6284778}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/types/actions.ts", "relative_path": "bolt.new/app/types/actions.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/types/actions.ts", "source_code": "export type ActionType = 'file' | 'shell';\n\nexport interface BaseAction {\n  content: string;\n}\n\nexport interface FileAction extends BaseAction {\n  type: 'file';\n  filePath: string;\n}\n\nexport interface ShellAction extends BaseAction {\n  type: 'shell';\n}\n\nexport type BoltAction = FileAction | ShellAction;\n\nexport type BoltActionData = BoltAction | BaseAction;\n", "tag": "", "tokens": 107, "metadata": {}}], "modify_time": 1733125234.6303787}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/types/terminal.ts", "relative_path": "bolt.new/app/types/terminal.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/types/terminal.ts", "source_code": "export interface ITerminal {\n  readonly cols?: number;\n  readonly rows?: number;\n\n  reset: () => void;\n  write: (data: string) => void;\n  onData: (cb: (data: string) => void) => void;\n}\n", "tag": "", "tokens": 71, "metadata": {}}], "modify_time": 1733125234.6305933}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/types/theme.ts", "relative_path": "bolt.new/app/types/theme.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/types/theme.ts", "source_code": "export type Theme = 'dark' | 'light';\n", "tag": "", "tokens": 20, "metadata": {}}], "modify_time": 1733125234.630694}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/types/artifact.ts", "relative_path": "bolt.new/app/types/artifact.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/types/artifact.ts", "source_code": "export interface BoltArtifactData {\n  id: string;\n  title: string;\n}\n", "tag": "", "tokens": 29, "metadata": {}}], "modify_time": 1733125234.6304874}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/easings.ts", "relative_path": "bolt.new/app/utils/easings.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/easings.ts", "source_code": "import { cubicBezier } from 'framer-motion';\n\nexport const cubicEasingFn = cubicBezier(0.4, 0, 0.2, 1);\n", "tag": "", "tokens": 50, "metadata": {}}], "modify_time": 1733125234.6314373}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/debounce.ts", "relative_path": "bolt.new/app/utils/debounce.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/debounce.ts", "source_code": "export function debounce<Args extends any[]>(fn: (...args: Args) => void, delay = 100) {\n  if (delay === 0) {\n    return fn;\n  }\n\n  let timer: number | undefined;\n\n  return function <U>(this: U, ...args: Args) {\n    const context = this;\n\n    clearTimeout(timer);\n\n    timer = window.setTimeout(() => {\n      fn.apply(context, args);\n    }, delay);\n  };\n}\n", "tag": "", "tokens": 130, "metadata": {}}], "modify_time": 1733125234.6312082}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/diff.ts", "relative_path": "bolt.new/app/utils/diff.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/diff.ts", "source_code": "import { createTwoFilesPatch } from 'diff';\nimport type { FileMap } from '~/lib/stores/files';\nimport { MODIFICATIONS_TAG_NAME } from './constants';\n\nexport const modificationsRegex = new RegExp(\n  `^<${MODIFICATIONS_TAG_NAME}>[\\\\s\\\\S]*?<\\\\/${MODIFICATIONS_TAG_NAME}>\\\\s+`,\n  'g',\n);\n\ninterface ModifiedFile {\n  type: 'diff' | 'file';\n  content: string;\n}\n\ntype FileModifications = Record<string, ModifiedFile>;\n\nexport function computeFileModifications(files: FileMap, modifiedFiles: Map<string, string>) {\n  const modifications: FileModifications = {};\n\n  let hasModifiedFiles = false;\n\n  for (const [filePath, originalContent] of modifiedFiles) {\n    const file = files[filePath];\n\n    if (file?.type !== 'file') {\n      continue;\n    }\n\n    const unifiedDiff = diffFiles(filePath, originalContent, file.content);\n\n    if (!unifiedDiff) {\n      // files are identical\n      continue;\n    }\n\n    hasModifiedFiles = true;\n\n    if (unifiedDiff.length > file.content.length) {\n      // if there are lots of changes we simply grab the current file content since it's smaller than the diff\n      modifications[filePath] = { type: 'file', content: file.content };\n    } else {\n      // otherwise we use the diff since it's smaller\n      modifications[filePath] = { type: 'diff', content: unifiedDiff };\n    }\n  }\n\n  if (!hasModifiedFiles) {\n    return undefined;\n  }\n\n  return modifications;\n}\n\n/**\n * Computes a diff in the unified format. The only difference is that the header is omitted\n * because it will always assume that you're comparing two versions of the same file and\n * it allows us to avoid the extra characters we send back to the llm.\n *\n * @see https://www.gnu.org/software/diffutils/manual/html_node/Unified-Format.html\n */\nexport function diffFiles(fileName: string, oldFileContent: string, newFileContent: string) {\n  let unifiedDiff = createTwoFilesPatch(fileName, fileName, oldFileContent, newFileContent);\n\n  const patchHeaderEnd = `--- ${fileName}\\n+++ ${fileName}\\n`;\n  const headerEndIndex = unifiedDiff.indexOf(patchHeaderEnd);\n\n  if (headerEndIndex >= 0) {\n    unifiedDiff = unifiedDiff.slice(headerEndIndex + patchHeaderEnd.length);\n  }\n\n  if (unifiedDiff === '') {\n    return undefined;\n  }\n\n  return unifiedDiff;\n}\n\n/**\n * Converts the unified diff to HTML.\n *\n * Example:\n *\n * ```html\n * <bolt_file_modifications>\n * <diff path=\"/home/project/index.js\">\n * - console.log('Hello, World!');\n * + console.log('Hello, Bolt!');\n * </diff>\n * </bolt_file_modifications>\n * ```\n */\nexport function fileModificationsToHTML(modifications: FileModifications) {\n  const entries = Object.entries(modifications);\n\n  if (entries.length === 0) {\n    return undefined;\n  }\n\n  const result: string[] = [`<${MODIFICATIONS_TAG_NAME}>`];\n\n  for (const [filePath, { type, content }] of entries) {\n    result.push(`<${type} path=${JSON.stringify(filePath)}>`, content, `</${type}>`);\n  }\n\n  result.push(`</${MODIFICATIONS_TAG_NAME}>`);\n\n  return result.join('\\n');\n}\n", "tag": "", "tokens": 893, "metadata": {}}], "modify_time": 1733125234.631333}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/buffer.ts", "relative_path": "bolt.new/app/utils/buffer.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/buffer.ts", "source_code": "export function bufferWatchEvents<T extends unknown[]>(timeInMs: number, cb: (events: T[]) => unknown) {\n  let timeoutId: number | undefined;\n  let events: T[] = [];\n\n  // keep track of the processing of the previous batch so we can wait for it\n  let processing: Promise<unknown> = Promise.resolve();\n\n  const scheduleBufferTick = () => {\n    timeoutId = self.setTimeout(async () => {\n      // we wait until the previous batch is entirely processed so events are processed in order\n      await processing;\n\n      if (events.length > 0) {\n        processing = Promise.resolve(cb(events));\n      }\n\n      timeoutId = undefined;\n      events = [];\n    }, timeInMs);\n  };\n\n  return (...args: T) => {\n    events.push(args);\n\n    if (!timeoutId) {\n      scheduleBufferTick();\n    }\n  };\n}\n", "tag": "", "tokens": 230, "metadata": {}}], "modify_time": 1733125234.6308568}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/markdown.ts", "relative_path": "bolt.new/app/utils/markdown.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/markdown.ts", "source_code": "import rehypeRaw from 'rehype-raw';\nimport remarkGfm from 'remark-gfm';\nimport type { PluggableList, Plugin } from 'unified';\nimport rehypeSanitize, { defaultSchema, type Options as RehypeSanitizeOptions } from 'rehype-sanitize';\nimport { SKIP, visit } from 'unist-util-visit';\nimport type { UnistNode, UnistParent } from 'node_modules/unist-util-visit/lib';\n\nexport const allowedHTMLElements = [\n  'a',\n  'b',\n  'blockquote',\n  'br',\n  'code',\n  'dd',\n  'del',\n  'details',\n  'div',\n  'dl',\n  'dt',\n  'em',\n  'h1',\n  'h2',\n  'h3',\n  'h4',\n  'h5',\n  'h6',\n  'hr',\n  'i',\n  'ins',\n  'kbd',\n  'li',\n  'ol',\n  'p',\n  'pre',\n  'q',\n  'rp',\n  'rt',\n  'ruby',\n  's',\n  'samp',\n  'source',\n  'span',\n  'strike',\n  'strong',\n  'sub',\n  'summary',\n  'sup',\n  'table',\n  'tbody',\n  'td',\n  'tfoot',\n  'th',\n  'thead',\n  'tr',\n  'ul',\n  'var',\n];\n\nconst rehypeSanitizeOptions: RehypeSanitizeOptions = {\n  ...defaultSchema,\n  tagNames: allowedHTMLElements,\n  attributes: {\n    ...defaultSchema.attributes,\n    div: [...(defaultSchema.attributes?.div ?? []), 'data*', ['className', '__boltArtifact__']],\n  },\n  strip: [],\n};\n\nexport function remarkPlugins(limitedMarkdown: boolean) {\n  const plugins: PluggableList = [remarkGfm];\n\n  if (limitedMarkdown) {\n    plugins.unshift(limitedMarkdownPlugin);\n  }\n\n  return plugins;\n}\n\nexport function rehypePlugins(html: boolean) {\n  const plugins: PluggableList = [];\n\n  if (html) {\n    plugins.push(rehypeRaw, [rehypeSanitize, rehypeSanitizeOptions]);\n  }\n\n  return plugins;\n}\n\nconst limitedMarkdownPlugin: Plugin = () => {\n  return (tree, file) => {\n    const contents = file.toString();\n\n    visit(tree, (node: UnistNode, index, parent: UnistParent) => {\n      if (\n        index == null ||\n        ['paragraph', 'text', 'inlineCode', 'code', 'strong', 'emphasis'].includes(node.type) ||\n        !node.position\n      ) {\n        return true;\n      }\n\n      let value = contents.slice(node.position.start.offset, node.position.end.offset);\n\n      if (node.type === 'heading') {\n        value = `\\n${value}`;\n      }\n\n      parent.children[index] = {\n        type: 'text',\n        value,\n      } as any;\n\n      return [SKIP, index] as const;\n    });\n  };\n};\n", "tag": "", "tokens": 811, "metadata": {}}], "modify_time": 1733125234.6316774}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/logger.ts", "relative_path": "bolt.new/app/utils/logger.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/logger.ts", "source_code": "export type DebugLevel = 'trace' | 'debug' | 'info' | 'warn' | 'error';\n\ntype LoggerFunction = (...messages: any[]) => void;\n\ninterface Logger {\n  trace: LoggerFunction;\n  debug: LoggerFunction;\n  info: LoggerFunction;\n  warn: LoggerFunction;\n  error: LoggerFunction;\n  setLevel: (level: DebugLevel) => void;\n}\n\nlet currentLevel: DebugLevel = import.meta.env.VITE_LOG_LEVEL ?? import.meta.env.DEV ? 'debug' : 'info';\n\nconst isWorker = 'HTMLRewriter' in globalThis;\nconst supportsColor = !isWorker;\n\nexport const logger: Logger = {\n  trace: (...messages: any[]) => log('trace', undefined, messages),\n  debug: (...messages: any[]) => log('debug', undefined, messages),\n  info: (...messages: any[]) => log('info', undefined, messages),\n  warn: (...messages: any[]) => log('warn', undefined, messages),\n  error: (...messages: any[]) => log('error', undefined, messages),\n  setLevel,\n};\n\nexport function createScopedLogger(scope: string): Logger {\n  return {\n    trace: (...messages: any[]) => log('trace', scope, messages),\n    debug: (...messages: any[]) => log('debug', scope, messages),\n    info: (...messages: any[]) => log('info', scope, messages),\n    warn: (...messages: any[]) => log('warn', scope, messages),\n    error: (...messages: any[]) => log('error', scope, messages),\n    setLevel,\n  };\n}\n\nfunction setLevel(level: DebugLevel) {\n  if ((level === 'trace' || level === 'debug') && import.meta.env.PROD) {\n    return;\n  }\n\n  currentLevel = level;\n}\n\nfunction log(level: DebugLevel, scope: string | undefined, messages: any[]) {\n  const levelOrder: DebugLevel[] = ['trace', 'debug', 'info', 'warn', 'error'];\n\n  if (levelOrder.indexOf(level) < levelOrder.indexOf(currentLevel)) {\n    return;\n  }\n\n  const allMessages = messages.reduce((acc, current) => {\n    if (acc.endsWith('\\n')) {\n      return acc + current;\n    }\n\n    if (!acc) {\n      return current;\n    }\n\n    return `${acc} ${current}`;\n  }, '');\n\n  if (!supportsColor) {\n    console.log(`[${level.toUpperCase()}]`, allMessages);\n\n    return;\n  }\n\n  const labelBackgroundColor = getColorForLevel(level);\n  const labelTextColor = level === 'warn' ? 'black' : 'white';\n\n  const labelStyles = getLabelStyles(labelBackgroundColor, labelTextColor);\n  const scopeStyles = getLabelStyles('#77828D', 'white');\n\n  const styles = [labelStyles];\n\n  if (typeof scope === 'string') {\n    styles.push('', scopeStyles);\n  }\n\n  console.log(`%c${level.toUpperCase()}${scope ? `%c %c${scope}` : ''}`, ...styles, allMessages);\n}\n\nfunction getLabelStyles(color: string, textColor: string) {\n  return `background-color: ${color}; color: white; border: 4px solid ${color}; color: ${textColor};`;\n}\n\nfunction getColorForLevel(level: DebugLevel): string {\n  switch (level) {\n    case 'trace':\n    case 'debug': {\n      return '#77828D';\n    }\n    case 'info': {\n      return '#1389FD';\n    }\n    case 'warn': {\n      return '#FFDB6C';\n    }\n    case 'error': {\n      return '#EE4744';\n    }\n    default: {\n      return 'black';\n    }\n  }\n}\n\nexport const renderLogger = createScopedLogger('Render');\n", "tag": "", "tokens": 965, "metadata": {}}], "modify_time": 1733125234.631552}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/promises.ts", "relative_path": "bolt.new/app/utils/promises.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/promises.ts", "source_code": "export function withResolvers<T>(): PromiseWithResolvers<T> {\n  if (typeof Promise.withResolvers === 'function') {\n    return Promise.withResolvers();\n  }\n\n  let resolve!: (value: T | PromiseLike<T>) => void;\n  let reject!: (reason?: any) => void;\n\n  const promise = new Promise<T>((_resolve, _reject) => {\n    resolve = _resolve;\n    reject = _reject;\n  });\n\n  return {\n    resolve,\n    reject,\n    promise,\n  };\n}\n", "tag": "", "tokens": 144, "metadata": {}}], "modify_time": 1733125234.6318936}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/shell.ts", "relative_path": "bolt.new/app/utils/shell.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/shell.ts", "source_code": "import type { WebContainer } from '@webcontainer/api';\nimport type { ITerminal } from '~/types/terminal';\nimport { withResolvers } from './promises';\n\nexport async function newShellProcess(webcontainer: WebContainer, terminal: ITerminal) {\n  const args: string[] = [];\n\n  // we spawn a JSH process with a fallback cols and rows in case the process is not attached yet to a visible terminal\n  const process = await webcontainer.spawn('/bin/jsh', ['--osc', ...args], {\n    terminal: {\n      cols: terminal.cols ?? 80,\n      rows: terminal.rows ?? 15,\n    },\n  });\n\n  const input = process.input.getWriter();\n  const output = process.output;\n\n  const jshReady = withResolvers<void>();\n\n  let isInteractive = false;\n\n  output.pipeTo(\n    new WritableStream({\n      write(data) {\n        if (!isInteractive) {\n          const [, osc] = data.match(/\\x1b\\]654;([^\\x07]+)\\x07/) || [];\n\n          if (osc === 'interactive') {\n            // wait until we see the interactive OSC\n            isInteractive = true;\n\n            jshReady.resolve();\n          }\n        }\n\n        terminal.write(data);\n      },\n    }),\n  );\n\n  terminal.onData((data) => {\n    if (isInteractive) {\n      input.write(data);\n    }\n  });\n\n  await jshReady.promise;\n\n  return process;\n}\n", "tag": "", "tokens": 389, "metadata": {}}], "modify_time": 1733125234.632261}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/constants.ts", "relative_path": "bolt.new/app/utils/constants.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/constants.ts", "source_code": "export const WORK_DIR_NAME = 'project';\nexport const WORK_DIR = `/home/${WORK_DIR_NAME}`;\nexport const MODIFICATIONS_TAG_NAME = 'bolt_file_modifications';\n", "tag": "", "tokens": 56, "metadata": {}}], "modify_time": 1733125234.6311002}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/mobile.ts", "relative_path": "bolt.new/app/utils/mobile.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/mobile.ts", "source_code": "export function isMobile() {\n  // we use sm: as the breakpoint for mobile. It's currently set to 640px\n  return globalThis.innerWidth < 640;\n}\n", "tag": "", "tokens": 56, "metadata": {}}], "modify_time": 1733125234.6317878}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/classNames.ts", "relative_path": "bolt.new/app/utils/classNames.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/classNames.ts", "source_code": "/**\n * Copyright (c) 2018 Jed Watson.\n * Licensed under the MIT License (MIT), see:\n *\n * @link http://jedwatson.github.io/classnames\n */\n\ntype ClassNamesArg = undefined | string | Record<string, boolean> | ClassNamesArg[];\n\n/**\n * A simple JavaScript utility for conditionally joining classNames together.\n *\n * @param args A series of classes or object with key that are class and values\n * that are interpreted as boolean to decide whether or not the class\n * should be included in the final class.\n */\nexport function classNames(...args: ClassNamesArg[]): string {\n  let classes = '';\n\n  for (const arg of args) {\n    classes = appendClass(classes, parseValue(arg));\n  }\n\n  return classes;\n}\n\nfunction parseValue(arg: ClassNamesArg) {\n  if (typeof arg === 'string' || typeof arg === 'number') {\n    return arg;\n  }\n\n  if (typeof arg !== 'object') {\n    return '';\n  }\n\n  if (Array.isArray(arg)) {\n    return classNames(...arg);\n  }\n\n  let classes = '';\n\n  for (const key in arg) {\n    if (arg[key]) {\n      classes = appendClass(classes, key);\n    }\n  }\n\n  return classes;\n}\n\nfunction appendClass(value: string, newClass: string | undefined) {\n  if (!newClass) {\n    return value;\n  }\n\n  if (value) {\n    return value + ' ' + newClass;\n  }\n\n  return value + newClass;\n}\n", "tag": "", "tokens": 399, "metadata": {}}], "modify_time": 1733125234.630982}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/terminal.ts", "relative_path": "bolt.new/app/utils/terminal.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/terminal.ts", "source_code": "const reset = '\\x1b[0m';\n\nexport const escapeCodes = {\n  reset,\n  clear: '\\x1b[g',\n  red: '\\x1b[1;31m',\n};\n\nexport const coloredText = {\n  red: (text: string) => `${escapeCodes.red}${text}${reset}`,\n};\n", "tag": "", "tokens": 91, "metadata": {}}], "modify_time": 1733125234.6325176}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/stripIndent.ts", "relative_path": "bolt.new/app/utils/stripIndent.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/stripIndent.ts", "source_code": "export function stripIndents(value: string): string;\nexport function stripIndents(strings: TemplateStringsArray, ...values: any[]): string;\nexport function stripIndents(arg0: string | TemplateStringsArray, ...values: any[]) {\n  if (typeof arg0 !== 'string') {\n    const processedString = arg0.reduce((acc, curr, i) => {\n      acc += curr + (values[i] ?? '');\n      return acc;\n    }, '');\n\n    return _stripIndents(processedString);\n  }\n\n  return _stripIndents(arg0);\n}\n\nfunction _stripIndents(value: string) {\n  return value\n    .split('\\n')\n    .map((line) => line.trim())\n    .join('\\n')\n    .trimStart()\n    .replace(/[\\r\\n]$/, '');\n}\n", "tag": "", "tokens": 209, "metadata": {}}], "modify_time": 1733125234.6323962}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/unreachable.ts", "relative_path": "bolt.new/app/utils/unreachable.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/unreachable.ts", "source_code": "export function unreachable(message: string): never {\n  throw new Error(`Unreachable: ${message}`);\n}\n", "tag": "", "tokens": 33, "metadata": {}}], "modify_time": 1733125234.632625}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/react.ts", "relative_path": "bolt.new/app/utils/react.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/utils/react.ts", "source_code": "import { memo } from 'react';\n\nexport const genericMemo: <T extends keyof JSX.IntrinsicElements | React.JSXElementConstructor<any>>(\n  component: T,\n  propsAreEqual?: (prevProps: React.ComponentProps<T>, nextProps: React.ComponentProps<T>) => boolean,\n) => T & { displayName?: string } = memo;\n", "tag": "", "tokens": 95, "metadata": {}}], "modify_time": 1733125234.6320868}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/variables.scss", "relative_path": "bolt.new/app/styles/variables.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/variables.scss", "source_code": "/* Color Tokens Light Theme */\n:root,\n:root[data-theme='light'] {\n  --bolt-elements-borderColor: theme('colors.alpha.gray.10');\n  --bolt-elements-borderColorActive: theme('colors.accent.600');\n\n  --bolt-elements-bg-depth-1: theme('colors.white');\n  --bolt-elements-bg-depth-2: theme('colors.gray.50');\n  --bolt-elements-bg-depth-3: theme('colors.gray.200');\n  --bolt-elements-bg-depth-4: theme('colors.alpha.gray.5');\n\n  --bolt-elements-textPrimary: theme('colors.gray.950');\n  --bolt-elements-textSecondary: theme('colors.gray.600');\n  --bolt-elements-textTertiary: theme('colors.gray.500');\n\n  --bolt-elements-code-background: theme('colors.gray.100');\n  --bolt-elements-code-text: theme('colors.gray.950');\n\n  --bolt-elements-button-primary-background: theme('colors.alpha.accent.10');\n  --bolt-elements-button-primary-backgroundHover: theme('colors.alpha.accent.20');\n  --bolt-elements-button-primary-text: theme('colors.accent.500');\n\n  --bolt-elements-button-secondary-background: theme('colors.alpha.gray.5');\n  --bolt-elements-button-secondary-backgroundHover: theme('colors.alpha.gray.10');\n  --bolt-elements-button-secondary-text: theme('colors.gray.950');\n\n  --bolt-elements-button-danger-background: theme('colors.alpha.red.10');\n  --bolt-elements-button-danger-backgroundHover: theme('colors.alpha.red.20');\n  --bolt-elements-button-danger-text: theme('colors.red.500');\n\n  --bolt-elements-item-contentDefault: theme('colors.alpha.gray.50');\n  --bolt-elements-item-contentActive: theme('colors.gray.950');\n  --bolt-elements-item-contentAccent: theme('colors.accent.700');\n  --bolt-elements-item-contentDanger: theme('colors.red.500');\n  --bolt-elements-item-backgroundDefault: rgba(0, 0, 0, 0);\n  --bolt-elements-item-backgroundActive: theme('colors.alpha.gray.5');\n  --bolt-elements-item-backgroundAccent: theme('colors.alpha.accent.10');\n  --bolt-elements-item-backgroundDanger: theme('colors.alpha.red.10');\n\n  --bolt-elements-loader-background: theme('colors.alpha.gray.10');\n  --bolt-elements-loader-progress: theme('colors.accent.500');\n\n  --bolt-elements-artifacts-background: theme('colors.white');\n  --bolt-elements-artifacts-backgroundHover: theme('colors.alpha.gray.2');\n  --bolt-elements-artifacts-borderColor: var(--bolt-elements-borderColor);\n  --bolt-elements-artifacts-inlineCode-background: theme('colors.gray.100');\n  --bolt-elements-artifacts-inlineCode-text: var(--bolt-elements-textPrimary);\n\n  --bolt-elements-actions-background: theme('colors.white');\n  --bolt-elements-actions-code-background: theme('colors.gray.800');\n\n  --bolt-elements-messages-background: theme('colors.gray.100');\n  --bolt-elements-messages-linkColor: theme('colors.accent.500');\n  --bolt-elements-messages-code-background: theme('colors.gray.800');\n  --bolt-elements-messages-inlineCode-background: theme('colors.gray.200');\n  --bolt-elements-messages-inlineCode-text: theme('colors.gray.800');\n\n  --bolt-elements-icon-success: theme('colors.green.500');\n  --bolt-elements-icon-error: theme('colors.red.500');\n  --bolt-elements-icon-primary: theme('colors.gray.950');\n  --bolt-elements-icon-secondary: theme('colors.gray.600');\n  --bolt-elements-icon-tertiary: theme('colors.gray.500');\n\n  --bolt-elements-dividerColor: theme('colors.gray.100');\n\n  --bolt-elements-prompt-background: theme('colors.alpha.white.80');\n\n  --bolt-elements-sidebar-dropdownShadow: theme('colors.alpha.gray.10');\n  --bolt-elements-sidebar-buttonBackgroundDefault: theme('colors.alpha.accent.10');\n  --bolt-elements-sidebar-buttonBackgroundHover: theme('colors.alpha.accent.20');\n  --bolt-elements-sidebar-buttonText: theme('colors.accent.700');\n\n  --bolt-elements-preview-addressBar-background: theme('colors.gray.100');\n  --bolt-elements-preview-addressBar-backgroundHover: theme('colors.alpha.gray.5');\n  --bolt-elements-preview-addressBar-backgroundActive: theme('colors.white');\n  --bolt-elements-preview-addressBar-text: var(--bolt-elements-textSecondary);\n  --bolt-elements-preview-addressBar-textActive: var(--bolt-elements-textPrimary);\n\n  --bolt-elements-terminals-background: theme('colors.white');\n  --bolt-elements-terminals-buttonBackground: var(--bolt-elements-bg-depth-4);\n\n  --bolt-elements-cta-background: theme('colors.gray.100');\n  --bolt-elements-cta-text: theme('colors.gray.950');\n\n  /* Terminal Colors */\n  --bolt-terminal-background: var(--bolt-elements-terminals-background);\n  --bolt-terminal-foreground: #333333;\n  --bolt-terminal-selection-background: #00000040;\n  --bolt-terminal-black: #000000;\n  --bolt-terminal-red: #cd3131;\n  --bolt-terminal-green: #00bc00;\n  --bolt-terminal-yellow: #949800;\n  --bolt-terminal-blue: #0451a5;\n  --bolt-terminal-magenta: #bc05bc;\n  --bolt-terminal-cyan: #0598bc;\n  --bolt-terminal-white: #555555;\n  --bolt-terminal-brightBlack: #686868;\n  --bolt-terminal-brightRed: #cd3131;\n  --bolt-terminal-brightGreen: #00bc00;\n  --bolt-terminal-brightYellow: #949800;\n  --bolt-terminal-brightBlue: #0451a5;\n  --bolt-terminal-brightMagenta: #bc05bc;\n  --bolt-terminal-brightCyan: #0598bc;\n  --bolt-terminal-brightWhite: #a5a5a5;\n}\n\n/* Color Tokens Dark Theme */\n:root,\n:root[data-theme='dark'] {\n  --bolt-elements-borderColor: theme('colors.alpha.white.10');\n  --bolt-elements-borderColorActive: theme('colors.accent.500');\n\n  --bolt-elements-bg-depth-1: theme('colors.gray.950');\n  --bolt-elements-bg-depth-2: theme('colors.gray.900');\n  --bolt-elements-bg-depth-3: theme('colors.gray.800');\n  --bolt-elements-bg-depth-4: theme('colors.alpha.white.5');\n\n  --bolt-elements-textPrimary: theme('colors.white');\n  --bolt-elements-textSecondary: theme('colors.gray.400');\n  --bolt-elements-textTertiary: theme('colors.gray.500');\n\n  --bolt-elements-code-background: theme('colors.gray.800');\n  --bolt-elements-code-text: theme('colors.white');\n\n  --bolt-elements-button-primary-background: theme('colors.alpha.accent.10');\n  --bolt-elements-button-primary-backgroundHover: theme('colors.alpha.accent.20');\n  --bolt-elements-button-primary-text: theme('colors.accent.500');\n\n  --bolt-elements-button-secondary-background: theme('colors.alpha.white.5');\n  --bolt-elements-button-secondary-backgroundHover: theme('colors.alpha.white.10');\n  --bolt-elements-button-secondary-text: theme('colors.white');\n\n  --bolt-elements-button-danger-background: theme('colors.alpha.red.10');\n  --bolt-elements-button-danger-backgroundHover: theme('colors.alpha.red.20');\n  --bolt-elements-button-danger-text: theme('colors.red.500');\n\n  --bolt-elements-item-contentDefault: theme('colors.alpha.white.50');\n  --bolt-elements-item-contentActive: theme('colors.white');\n  --bolt-elements-item-contentAccent: theme('colors.accent.500');\n  --bolt-elements-item-contentDanger: theme('colors.red.500');\n  --bolt-elements-item-backgroundDefault: rgba(255, 255, 255, 0);\n  --bolt-elements-item-backgroundActive: theme('colors.alpha.white.10');\n  --bolt-elements-item-backgroundAccent: theme('colors.alpha.accent.10');\n  --bolt-elements-item-backgroundDanger: theme('colors.alpha.red.10');\n\n  --bolt-elements-loader-background: theme('colors.alpha.gray.10');\n  --bolt-elements-loader-progress: theme('colors.accent.500');\n\n  --bolt-elements-artifacts-background: theme('colors.gray.900');\n  --bolt-elements-artifacts-backgroundHover: theme('colors.alpha.white.5');\n  --bolt-elements-artifacts-borderColor: var(--bolt-elements-borderColor);\n  --bolt-elements-artifacts-inlineCode-background: theme('colors.gray.800');\n  --bolt-elements-artifacts-inlineCode-text: theme('colors.white');\n\n  --bolt-elements-actions-background: theme('colors.gray.900');\n  --bolt-elements-actions-code-background: theme('colors.gray.800');\n\n  --bolt-elements-messages-background: theme('colors.gray.800');\n  --bolt-elements-messages-linkColor: theme('colors.accent.500');\n  --bolt-elements-messages-code-background: theme('colors.gray.900');\n  --bolt-elements-messages-inlineCode-background: theme('colors.gray.700');\n  --bolt-elements-messages-inlineCode-text: var(--bolt-elements-textPrimary);\n\n  --bolt-elements-icon-success: theme('colors.green.400');\n  --bolt-elements-icon-error: theme('colors.red.400');\n  --bolt-elements-icon-primary: theme('colors.gray.950');\n  --bolt-elements-icon-secondary: theme('colors.gray.600');\n  --bolt-elements-icon-tertiary: theme('colors.gray.500');\n\n  --bolt-elements-dividerColor: theme('colors.gray.100');\n\n  --bolt-elements-prompt-background: theme('colors.alpha.gray.80');\n\n  --bolt-elements-sidebar-dropdownShadow: theme('colors.alpha.gray.30');\n  --bolt-elements-sidebar-buttonBackgroundDefault: theme('colors.alpha.accent.10');\n  --bolt-elements-sidebar-buttonBackgroundHover: theme('colors.alpha.accent.20');\n  --bolt-elements-sidebar-buttonText: theme('colors.accent.500');\n\n  --bolt-elements-preview-addressBar-background: var(--bolt-elements-bg-depth-1);\n  --bolt-elements-preview-addressBar-backgroundHover: theme('colors.alpha.white.5');\n  --bolt-elements-preview-addressBar-backgroundActive: var(--bolt-elements-bg-depth-1);\n  --bolt-elements-preview-addressBar-text: var(--bolt-elements-textSecondary);\n  --bolt-elements-preview-addressBar-textActive: var(--bolt-elements-textPrimary);\n\n  --bolt-elements-terminals-background: var(--bolt-elements-bg-depth-1);\n  --bolt-elements-terminals-buttonBackground: var(--bolt-elements-bg-depth-3);\n\n  --bolt-elements-cta-background: theme('colors.alpha.white.10');\n  --bolt-elements-cta-text: theme('colors.white');\n\n  /* Terminal Colors */\n  --bolt-terminal-background: var(--bolt-elements-terminals-background);\n  --bolt-terminal-foreground: #eff0eb;\n  --bolt-terminal-selection-background: #97979b33;\n  --bolt-terminal-black: #000000;\n  --bolt-terminal-red: #ff5c57;\n  --bolt-terminal-green: #5af78e;\n  --bolt-terminal-yellow: #f3f99d;\n  --bolt-terminal-blue: #57c7ff;\n  --bolt-terminal-magenta: #ff6ac1;\n  --bolt-terminal-cyan: #9aedfe;\n  --bolt-terminal-white: #f1f1f0;\n  --bolt-terminal-brightBlack: #686868;\n  --bolt-terminal-brightRed: #ff5c57;\n  --bolt-terminal-brightGreen: #5af78e;\n  --bolt-terminal-brightYellow: #f3f99d;\n  --bolt-terminal-brightBlue: #57c7ff;\n  --bolt-terminal-brightMagenta: #ff6ac1;\n  --bolt-terminal-brightCyan: #9aedfe;\n  --bolt-terminal-brightWhite: #f1f1f0;\n}\n\n/*\n * Element Tokens\n *\n * Hierarchy: Element Token -> (Element Token | Color Tokens) -> Primitives\n */\n:root {\n  --header-height: 54px;\n  --chat-max-width: 37rem;\n  --chat-min-width: 640px;\n  --workbench-width: min(calc(100% - var(--chat-min-width)), 1536px);\n  --workbench-inner-width: var(--workbench-width);\n  --workbench-left: calc(100% - var(--workbench-width));\n\n  /* Toasts */\n  --toastify-color-progress-success: var(--bolt-elements-icon-success);\n  --toastify-color-progress-error: var(--bolt-elements-icon-error);\n\n  /* Terminal */\n  --bolt-elements-terminal-backgroundColor: var(--bolt-terminal-background);\n  --bolt-elements-terminal-textColor: var(--bolt-terminal-foreground);\n  --bolt-elements-terminal-cursorColor: var(--bolt-terminal-foreground);\n  --bolt-elements-terminal-selection-backgroundColor: var(--bolt-terminal-selection-background);\n  --bolt-elements-terminal-color-black: var(--bolt-terminal-black);\n  --bolt-elements-terminal-color-red: var(--bolt-terminal-red);\n  --bolt-elements-terminal-color-green: var(--bolt-terminal-green);\n  --bolt-elements-terminal-color-yellow: var(--bolt-terminal-yellow);\n  --bolt-elements-terminal-color-blue: var(--bolt-terminal-blue);\n  --bolt-elements-terminal-color-magenta: var(--bolt-terminal-magenta);\n  --bolt-elements-terminal-color-cyan: var(--bolt-terminal-cyan);\n  --bolt-elements-terminal-color-white: var(--bolt-terminal-white);\n  --bolt-elements-terminal-color-brightBlack: var(--bolt-terminal-brightBlack);\n  --bolt-elements-terminal-color-brightRed: var(--bolt-terminal-brightRed);\n  --bolt-elements-terminal-color-brightGreen: var(--bolt-terminal-brightGreen);\n  --bolt-elements-terminal-color-brightYellow: var(--bolt-terminal-brightYellow);\n  --bolt-elements-terminal-color-brightBlue: var(--bolt-terminal-brightBlue);\n  --bolt-elements-terminal-color-brightMagenta: var(--bolt-terminal-brightMagenta);\n  --bolt-elements-terminal-color-brightCyan: var(--bolt-terminal-brightCyan);\n  --bolt-elements-terminal-color-brightWhite: var(--bolt-terminal-brightWhite);\n}\n", "tag": "", "tokens": 4188, "metadata": {}}], "modify_time": 1733125234.630098}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/index.scss", "relative_path": "bolt.new/app/styles/index.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/index.scss", "source_code": "@import './variables.scss';\n@import './z-index.scss';\n@import './animations.scss';\n@import './components/terminal.scss';\n@import './components/resize-handle.scss';\n@import './components/code.scss';\n@import './components/editor.scss';\n@import './components/toast.scss';\n\nhtml,\nbody {\n  height: 100%;\n  width: 100%;\n}\n", "tag": "", "tokens": 114, "metadata": {}}], "modify_time": 1733125234.629965}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/z-index.scss", "relative_path": "bolt.new/app/styles/z-index.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/z-index.scss", "source_code": "$zIndexMax: 999;\n\n.z-logo {\n  z-index: $zIndexMax - 1;\n}\n\n.z-sidebar {\n  z-index: $zIndexMax - 2;\n}\n\n.z-port-dropdown {\n  z-index: $zIndexMax - 3;\n}\n\n.z-iframe-overlay {\n  z-index: $zIndexMax - 4;\n}\n\n.z-prompt {\n  z-index: 2;\n}\n\n.z-workbench {\n  z-index: 3;\n}\n\n.z-file-tree-breadcrumb {\n  z-index: $zIndexMax - 1;\n}\n\n.z-max {\n  z-index: $zIndexMax;\n}\n", "tag": "", "tokens": 198, "metadata": {}}], "modify_time": 1733125234.6302164}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/animations.scss", "relative_path": "bolt.new/app/styles/animations.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/animations.scss", "source_code": ".animated {\n  animation-fill-mode: both;\n  animation-duration: var(--animate-duration, 0.2s);\n  animation-timing-function: cubic-bezier(0, 0, 0.2, 1);\n\n  &.fadeInRight {\n    animation-name: fadeInRight;\n  }\n\n  &.fadeOutRight {\n    animation-name: fadeOutRight;\n  }\n}\n\n@keyframes fadeInRight {\n  from {\n    opacity: 0;\n    transform: translate3d(100%, 0, 0);\n  }\n\n  to {\n    opacity: 1;\n    transform: translate3d(0, 0, 0);\n  }\n}\n\n@keyframes fadeOutRight {\n  from {\n    opacity: 1;\n  }\n\n  to {\n    opacity: 0;\n    transform: translate3d(100%, 0, 0);\n  }\n}\n\n.dropdown-animation {\n  opacity: 0;\n  animation: fadeMoveDown 0.15s forwards;\n  animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n@keyframes fadeMoveDown {\n  to {\n    opacity: 1;\n    transform: translateY(6px);\n  }\n}\n", "tag": "", "tokens": 332, "metadata": {}}], "modify_time": 1733125234.6292005}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/terminal.scss", "relative_path": "bolt.new/app/styles/components/terminal.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/terminal.scss", "source_code": ".xterm {\n  padding: 1rem;\n}\n", "tag": "", "tokens": 23, "metadata": {}}], "modify_time": 1733125234.62975}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/editor.scss", "relative_path": "bolt.new/app/styles/components/editor.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/editor.scss", "source_code": ":root {\n  --cm-backgroundColor: var(--bolt-elements-editor-backgroundColor, var(--bolt-elements-bg-depth-1));\n  --cm-textColor: var(--bolt-elements-editor-textColor, var(--bolt-elements-textPrimary));\n\n  /* Gutter */\n\n  --cm-gutter-backgroundColor: var(--bolt-elements-editor-gutter-backgroundColor, var(--cm-backgroundColor));\n  --cm-gutter-textColor: var(--bolt-elements-editor-gutter-textColor, var(--bolt-elements-textSecondary));\n  --cm-gutter-activeLineTextColor: var(--bolt-elements-editor-gutter-activeLineTextColor, var(--cm-gutter-textColor));\n\n  /* Fold Gutter */\n\n  --cm-foldGutter-textColor: var(--bolt-elements-editor-foldGutter-textColor, var(--cm-gutter-textColor));\n  --cm-foldGutter-textColorHover: var(--bolt-elements-editor-foldGutter-textColorHover, var(--cm-gutter-textColor));\n\n  /* Active Line */\n\n  --cm-activeLineBackgroundColor: var(--bolt-elements-editor-activeLineBackgroundColor, rgb(224 231 235 / 30%));\n\n  /* Cursor */\n\n  --cm-cursor-width: 2px;\n  --cm-cursor-backgroundColor: var(--bolt-elements-editor-cursorColor, var(--bolt-elements-textSecondary));\n\n  /* Matching Brackets */\n\n  --cm-matching-bracket: var(--bolt-elements-editor-matchingBracketBackgroundColor, rgb(50 140 130 / 0.3));\n\n  /* Selection */\n\n  --cm-selection-backgroundColorFocused: var(--bolt-elements-editor-selection-backgroundColor, #42b4ff);\n  --cm-selection-backgroundOpacityFocused: var(--bolt-elements-editor-selection-backgroundOpacity, 0.3);\n  --cm-selection-backgroundColorBlured: var(--bolt-elements-editor-selection-inactiveBackgroundColor, #c9e9ff);\n  --cm-selection-backgroundOpacityBlured: var(--bolt-elements-editor-selection-inactiveBackgroundOpacity, 0.3);\n\n  /* Panels */\n\n  --cm-panels-borderColor: var(--bolt-elements-editor-panels-borderColor, var(--bolt-elements-borderColor));\n\n  /* Search */\n\n  --cm-search-backgroundColor: var(--bolt-elements-editor-search-backgroundColor, var(--cm-backgroundColor));\n  --cm-search-textColor: var(--bolt-elements-editor-search-textColor, var(--bolt-elements-textSecondary));\n  --cm-search-closeButton-backgroundColor: var(--bolt-elements-editor-search-closeButton-backgroundColor, transparent);\n\n  --cm-search-closeButton-backgroundColorHover: var(\n    --bolt-elements-editor-search-closeButton-backgroundColorHover,\n    var(--bolt-elements-item-backgroundActive)\n  );\n\n  --cm-search-closeButton-textColor: var(\n    --bolt-elements-editor-search-closeButton-textColor,\n    var(--bolt-elements-item-contentDefault)\n  );\n\n  --cm-search-closeButton-textColorHover: var(\n    --bolt-elements-editor-search-closeButton-textColorHover,\n    var(--bolt-elements-item-contentActive)\n  );\n\n  --cm-search-button-backgroundColor: var(\n    --bolt-elements-editor-search-button-backgroundColor,\n    var(--bolt-elements-item-backgroundDefault)\n  );\n\n  --cm-search-button-backgroundColorHover: var(\n    --bolt-elements-editor-search-button-backgroundColorHover,\n    var(--bolt-elements-item-backgroundActive)\n  );\n\n  --cm-search-button-textColor: var(--bolt-elements-editor-search-button-textColor, var(--bolt-elements-textSecondary));\n\n  --cm-search-button-textColorHover: var(\n    --bolt-elements-editor-search-button-textColorHover,\n    var(--bolt-elements-textPrimary)\n  );\n\n  --cm-search-button-borderColor: var(--bolt-elements-editor-search-button-borderColor, transparent);\n  --cm-search-button-borderColorHover: var(--bolt-elements-editor-search-button-borderColorHover, transparent);\n\n  --cm-search-button-borderColorFocused: var(\n    --bolt-elements-editor-search-button-borderColorFocused,\n    var(--bolt-elements-borderColorActive)\n  );\n\n  --cm-search-input-backgroundColor: var(--bolt-elements-editor-search-input-backgroundColor, transparent);\n  --cm-search-input-textColor: var(--bolt-elements-editor-search-input-textColor, var(--bolt-elements-textPrimary));\n  --cm-search-input-borderColor: var(--bolt-elements-editor-search-input-borderColor, var(--bolt-elements-borderColor));\n\n  --cm-search-input-borderColorFocused: var(\n    --bolt-elements-editor-search-input-borderColorFocused,\n    var(--bolt-elements-borderColorActive)\n  );\n\n  /* Tooltip */\n\n  --cm-tooltip-backgroundColor: var(--bolt-elements-editor-tooltip-backgroundColor, var(--cm-backgroundColor));\n  --cm-tooltip-textColor: var(--bolt-elements-editor-tooltip-textColor, var(--bolt-elements-textPrimary));\n\n  --cm-tooltip-backgroundColorSelected: var(\n    --bolt-elements-editor-tooltip-backgroundColorSelected,\n    theme('colors.alpha.accent.30')\n  );\n\n  --cm-tooltip-textColorSelected: var(\n    --bolt-elements-editor-tooltip-textColorSelected,\n    var(--bolt-elements-textPrimary)\n  );\n\n  --cm-tooltip-borderColor: var(--bolt-elements-editor-tooltip-borderColor, var(--bolt-elements-borderColor));\n\n  --cm-searchMatch-backgroundColor: var(--bolt-elements-editor-searchMatch-backgroundColor, rgba(234, 92, 0, 0.33));\n}\n\nhtml[data-theme='light'] {\n  --bolt-elements-editor-gutter-textColor: #237893;\n  --bolt-elements-editor-gutter-activeLineTextColor: var(--bolt-elements-textPrimary);\n  --bolt-elements-editor-foldGutter-textColorHover: var(--bolt-elements-textPrimary);\n  --bolt-elements-editor-activeLineBackgroundColor: rgb(50 53 63 / 5%);\n  --bolt-elements-editor-tooltip-backgroundColorSelected: theme('colors.alpha.accent.20');\n  --bolt-elements-editor-search-button-backgroundColor: theme('colors.gray.100');\n  --bolt-elements-editor-search-button-backgroundColorHover: theme('colors.alpha.gray.10');\n}\n\nhtml[data-theme='dark'] {\n  --cm-backgroundColor: var(--bolt-elements-bg-depth-2);\n  --bolt-elements-editor-gutter-textColor: var(--bolt-elements-textTertiary);\n  --bolt-elements-editor-gutter-activeLineTextColor: var(--bolt-elements-textSecondary);\n  --bolt-elements-editor-selection-inactiveBackgroundOpacity: 0.3;\n  --bolt-elements-editor-activeLineBackgroundColor: rgb(50 53 63 / 50%);\n  --bolt-elements-editor-foldGutter-textColorHover: var(--bolt-elements-textPrimary);\n  --bolt-elements-editor-matchingBracketBackgroundColor: rgba(66, 180, 255, 0.3);\n  --bolt-elements-editor-search-button-backgroundColor: theme('colors.gray.800');\n  --bolt-elements-editor-search-button-backgroundColorHover: theme('colors.alpha.white.10');\n}\n", "tag": "", "tokens": 1888, "metadata": {}}], "modify_time": 1733125234.6295183}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/resize-handle.scss", "relative_path": "bolt.new/app/styles/components/resize-handle.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/resize-handle.scss", "source_code": "[data-resize-handle] {\n  position: relative;\n\n  &[data-panel-group-direction='horizontal']:after {\n    content: '';\n    position: absolute;\n    top: 0;\n    bottom: 0;\n    left: -6px;\n    right: -5px;\n    z-index: $zIndexMax;\n  }\n\n  &[data-panel-group-direction='vertical']:after {\n    content: '';\n    position: absolute;\n    left: 0;\n    right: 0;\n    top: -5px;\n    bottom: -6px;\n    z-index: $zIndexMax;\n  }\n\n  &[data-resize-handle-state='hover']:after,\n  &[data-resize-handle-state='drag']:after {\n    background-color: #8882;\n  }\n}\n", "tag": "", "tokens": 217, "metadata": {}}], "modify_time": 1733125234.6296377}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/toast.scss", "relative_path": "bolt.new/app/styles/components/toast.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/toast.scss", "source_code": ".Toastify__toast {\n  --at-apply: shadow-md;\n\n  background-color: var(--bolt-elements-bg-depth-2);\n  color: var(--bolt-elements-textPrimary);\n  border: 1px solid var(--bolt-elements-borderColor);\n}\n\n.Toastify__close-button {\n  color: var(--bolt-elements-item-contentDefault);\n  opacity: 1;\n  transition: none;\n\n  &:hover {\n    color: var(--bolt-elements-item-contentActive);\n  }\n}\n", "tag": "", "tokens": 142, "metadata": {}}], "modify_time": 1733125234.6298594}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/code.scss", "relative_path": "bolt.new/app/styles/components/code.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/styles/components/code.scss", "source_code": ".actions .shiki {\n  background-color: var(--bolt-elements-actions-code-background) !important;\n}\n\n.shiki {\n  &:not(:has(.actions), .actions *) {\n    background-color: var(--bolt-elements-messages-code-background) !important;\n  }\n}\n", "tag": "", "tokens": 84, "metadata": {}}], "modify_time": 1733125234.6293736}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/sidebar/date-binning.ts", "relative_path": "bolt.new/app/components/sidebar/date-binning.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/sidebar/date-binning.ts", "source_code": "import { format, isAfter, isThisWeek, isThisYear, isToday, isYesterday, subDays } from 'date-fns';\nimport type { ChatHistoryItem } from '~/lib/persistence';\n\ntype Bin = { category: string; items: ChatHistoryItem[] };\n\nexport function binDates(_list: ChatHistoryItem[]) {\n  const list = _list.toSorted((a, b) => Date.parse(b.timestamp) - Date.parse(a.timestamp));\n\n  const binLookup: Record<string, Bin> = {};\n  const bins: Array<Bin> = [];\n\n  list.forEach((item) => {\n    const category = dateCategory(new Date(item.timestamp));\n\n    if (!(category in binLookup)) {\n      const bin = {\n        category,\n        items: [item],\n      };\n\n      binLookup[category] = bin;\n\n      bins.push(bin);\n    } else {\n      binLookup[category].items.push(item);\n    }\n  });\n\n  return bins;\n}\n\nfunction dateCategory(date: Date) {\n  if (isToday(date)) {\n    return 'Today';\n  }\n\n  if (isYesterday(date)) {\n    return 'Yesterday';\n  }\n\n  if (isThisWeek(date)) {\n    // e.g., \"Monday\"\n    return format(date, 'eeee');\n  }\n\n  const thirtyDaysAgo = subDays(new Date(), 30);\n\n  if (isAfter(date, thirtyDaysAgo)) {\n    return 'Last 30 Days';\n  }\n\n  if (isThisYear(date)) {\n    // e.g., \"July\"\n    return format(date, 'MMMM');\n  }\n\n  // e.g., \"July 2023\"\n  return format(date, 'MMMM yyyy');\n}\n", "tag": "", "tokens": 452, "metadata": {}}], "modify_time": 1733125234.621729}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/sidebar/HistoryItem.tsx", "relative_path": "bolt.new/app/components/sidebar/HistoryItem.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/sidebar/HistoryItem.tsx", "source_code": "import * as Dialog from '@radix-ui/react-dialog';\nimport { useEffect, useRef, useState } from 'react';\nimport { type ChatHistoryItem } from '~/lib/persistence';\n\ninterface HistoryItemProps {\n  item: ChatHistoryItem;\n  onDelete?: (event: React.UIEvent) => void;\n}\n\nexport function HistoryItem({ item, onDelete }: HistoryItemProps) {\n  const [hovering, setHovering] = useState(false);\n  const hoverRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    let timeout: NodeJS.Timeout | undefined;\n\n    function mouseEnter() {\n      setHovering(true);\n\n      if (timeout) {\n        clearTimeout(timeout);\n      }\n    }\n\n    function mouseLeave() {\n      setHovering(false);\n    }\n\n    hoverRef.current?.addEventListener('mouseenter', mouseEnter);\n    hoverRef.current?.addEventListener('mouseleave', mouseLeave);\n\n    return () => {\n      hoverRef.current?.removeEventListener('mouseenter', mouseEnter);\n      hoverRef.current?.removeEventListener('mouseleave', mouseLeave);\n    };\n  }, []);\n\n  return (\n    <div\n      ref={hoverRef}\n      className=\"group rounded-md text-bolt-elements-textSecondary hover:text-bolt-elements-textPrimary hover:bg-bolt-elements-background-depth-3 overflow-hidden flex justify-between items-center px-2 py-1\"\n    >\n      <a href={`/chat/${item.urlId}`} className=\"flex w-full relative truncate block\">\n        {item.description}\n        <div className=\"absolute right-0 z-1 top-0 bottom-0 bg-gradient-to-l from-bolt-elements-background-depth-2 group-hover:from-bolt-elements-background-depth-3 to-transparent w-10 flex justify-end group-hover:w-15 group-hover:from-45%\">\n          {hovering && (\n            <div className=\"flex items-center p-1 text-bolt-elements-textSecondary hover:text-bolt-elements-item-contentDanger\">\n              <Dialog.Trigger asChild>\n                <button\n                  className=\"i-ph:trash scale-110\"\n                  onClick={(event) => {\n                    // we prevent the default so we don't trigger the anchor above\n                    event.preventDefault();\n                    onDelete?.(event);\n                  }}\n                />\n              </Dialog.Trigger>\n            </div>\n          )}\n        </div>\n      </a>\n    </div>\n  );\n}\n", "tag": "", "tokens": 624, "metadata": {}}], "modify_time": 1733125234.621474}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/sidebar/Menu.client.tsx", "relative_path": "bolt.new/app/components/sidebar/Menu.client.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/sidebar/Menu.client.tsx", "source_code": "import { motion, type Variants } from 'framer-motion';\nimport { useCallback, useEffect, useRef, useState } from 'react';\nimport { toast } from 'react-toastify';\nimport { Dialog, DialogButton, DialogDescription, DialogRoot, DialogTitle } from '~/components/ui/Dialog';\nimport { IconButton } from '~/components/ui/IconButton';\nimport { ThemeSwitch } from '~/components/ui/ThemeSwitch';\nimport { db, deleteById, getAll, chatId, type ChatHistoryItem } from '~/lib/persistence';\nimport { cubicEasingFn } from '~/utils/easings';\nimport { logger } from '~/utils/logger';\nimport { HistoryItem } from './HistoryItem';\nimport { binDates } from './date-binning';\n\nconst menuVariants = {\n  closed: {\n    opacity: 0,\n    visibility: 'hidden',\n    left: '-150px',\n    transition: {\n      duration: 0.2,\n      ease: cubicEasingFn,\n    },\n  },\n  open: {\n    opacity: 1,\n    visibility: 'initial',\n    left: 0,\n    transition: {\n      duration: 0.2,\n      ease: cubicEasingFn,\n    },\n  },\n} satisfies Variants;\n\ntype DialogContent = { type: 'delete'; item: ChatHistoryItem } | null;\n\nexport function Menu() {\n  const menuRef = useRef<HTMLDivElement>(null);\n  const [list, setList] = useState<ChatHistoryItem[]>([]);\n  const [open, setOpen] = useState(false);\n  const [dialogContent, setDialogContent] = useState<DialogContent>(null);\n\n  const loadEntries = useCallback(() => {\n    if (db) {\n      getAll(db)\n        .then((list) => list.filter((item) => item.urlId && item.description))\n        .then(setList)\n        .catch((error) => toast.error(error.message));\n    }\n  }, []);\n\n  const deleteItem = useCallback((event: React.UIEvent, item: ChatHistoryItem) => {\n    event.preventDefault();\n\n    if (db) {\n      deleteById(db, item.id)\n        .then(() => {\n          loadEntries();\n\n          if (chatId.get() === item.id) {\n            // hard page navigation to clear the stores\n            window.location.pathname = '/';\n          }\n        })\n        .catch((error) => {\n          toast.error('Failed to delete conversation');\n          logger.error(error);\n        });\n    }\n  }, []);\n\n  const closeDialog = () => {\n    setDialogContent(null);\n  };\n\n  useEffect(() => {\n    if (open) {\n      loadEntries();\n    }\n  }, [open]);\n\n  useEffect(() => {\n    const enterThreshold = 40;\n    const exitThreshold = 40;\n\n    function onMouseMove(event: MouseEvent) {\n      if (event.pageX < enterThreshold) {\n        setOpen(true);\n      }\n\n      if (menuRef.current && event.clientX > menuRef.current.getBoundingClientRect().right + exitThreshold) {\n        setOpen(false);\n      }\n    }\n\n    window.addEventListener('mousemove', onMouseMove);\n\n    return () => {\n      window.removeEventListener('mousemove', onMouseMove);\n    };\n  }, []);\n\n  return (\n    <motion.div\n      ref={menuRef}\n      initial=\"closed\"\n      animate={open ? 'open' : 'closed'}\n      variants={menuVariants}\n      className=\"flex flex-col side-menu fixed top-0 w-[350px] h-full bg-bolt-elements-background-depth-2 border-r rounded-r-3xl border-bolt-elements-borderColor z-sidebar shadow-xl shadow-bolt-elements-sidebar-dropdownShadow text-sm\"\n    >\n      <div className=\"flex items-center h-[var(--header-height)]\">{/* Placeholder */}</div>\n      <div className=\"flex-1 flex flex-col h-full w-full overflow-hidden\">\n        <div className=\"p-4\">\n          <a\n            href=\"/\"\n            className=\"flex gap-2 items-center bg-bolt-elements-sidebar-buttonBackgroundDefault text-bolt-elements-sidebar-buttonText hover:bg-bolt-elements-sidebar-buttonBackgroundHover rounded-md p-2 transition-theme\"\n          >\n            <span className=\"inline-block i-bolt:chat scale-110\" />\n            Start new chat\n          </a>\n        </div>\n        <div className=\"text-bolt-elements-textPrimary font-medium pl-6 pr-5 my-2\">Your Chats</div>\n        <div className=\"flex-1 overflow-scroll pl-4 pr-5 pb-5\">\n          {list.length === 0 && <div className=\"pl-2 text-bolt-elements-textTertiary\">No previous conversations</div>}\n          <DialogRoot open={dialogContent !== null}>\n            {binDates(list).map(({ category, items }) => (\n              <div key={category} className=\"mt-4 first:mt-0 space-y-1\">\n                <div className=\"text-bolt-elements-textTertiary sticky top-0 z-1 bg-bolt-elements-background-depth-2 pl-2 pt-2 pb-1\">\n                  {category}\n                </div>\n                {items.map((item) => (\n                  <HistoryItem key={item.id} item={item} onDelete={() => setDialogContent({ type: 'delete', item })} />\n                ))}\n              </div>\n            ))}\n            <Dialog onBackdrop={closeDialog} onClose={closeDialog}>\n              {dialogContent?.type === 'delete' && (\n                <>\n                  <DialogTitle>Delete Chat?</DialogTitle>\n                  <DialogDescription asChild>\n                    <div>\n                      <p>\n                        You are about to delete <strong>{dialogContent.item.description}</strong>.\n                      </p>\n                      <p className=\"mt-1\">Are you sure you want to delete this chat?</p>\n                    </div>\n                  </DialogDescription>\n                  <div className=\"px-5 pb-4 bg-bolt-elements-background-depth-2 flex gap-2 justify-end\">\n                    <DialogButton type=\"secondary\" onClick={closeDialog}>\n                      Cancel\n                    </DialogButton>\n                    <DialogButton\n                      type=\"danger\"\n                      onClick={(event) => {\n                        deleteItem(event, dialogContent.item);\n                        closeDialog();\n                      }}\n                    >\n                      Delete\n                    </DialogButton>\n                  </div>\n                </>\n              )}\n            </Dialog>\n          </DialogRoot>\n        </div>\n        <div className=\"flex items-center border-t border-bolt-elements-borderColor p-4\">\n          <ThemeSwitch className=\"ml-auto\" />\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n", "tag": "", "tokens": 1680, "metadata": {}}], "modify_time": 1733125234.6216154}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/LoadingDots.tsx", "relative_path": "bolt.new/app/components/ui/LoadingDots.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/LoadingDots.tsx", "source_code": "import { memo, useEffect, useState } from 'react';\n\ninterface LoadingDotsProps {\n  text: string;\n}\n\nexport const LoadingDots = memo(({ text }: LoadingDotsProps) => {\n  const [dotCount, setDotCount] = useState(0);\n\n  useEffect(() => {\n    const interval = setInterval(() => {\n      setDotCount((prevDotCount) => (prevDotCount + 1) % 4);\n    }, 500);\n\n    return () => clearInterval(interval);\n  }, []);\n\n  return (\n    <div className=\"flex justify-center items-center h-full\">\n      <div className=\"relative\">\n        <span>{text}</span>\n        <span className=\"absolute left-[calc(100%-12px)]\">{'.'.repeat(dotCount)}</span>\n        <span className=\"invisible\">...</span>\n      </div>\n    </div>\n  );\n});\n", "tag": "", "tokens": 235, "metadata": {}}], "modify_time": 1733125234.6221514}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/Slider.tsx", "relative_path": "bolt.new/app/components/ui/Slider.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/Slider.tsx", "source_code": "import { motion } from 'framer-motion';\nimport { memo } from 'react';\nimport { classNames } from '~/utils/classNames';\nimport { cubicEasingFn } from '~/utils/easings';\nimport { genericMemo } from '~/utils/react';\n\ninterface SliderOption<T> {\n  value: T;\n  text: string;\n}\n\nexport interface SliderOptions<T> {\n  left: SliderOption<T>;\n  right: SliderOption<T>;\n}\n\ninterface SliderProps<T> {\n  selected: T;\n  options: SliderOptions<T>;\n  setSelected?: (selected: T) => void;\n}\n\nexport const Slider = genericMemo(<T,>({ selected, options, setSelected }: SliderProps<T>) => {\n  const isLeftSelected = selected === options.left.value;\n\n  return (\n    <div className=\"flex items-center flex-wrap shrink-0 gap-1 bg-bolt-elements-background-depth-1 overflow-hidden rounded-full p-1\">\n      <SliderButton selected={isLeftSelected} setSelected={() => setSelected?.(options.left.value)}>\n        {options.left.text}\n      </SliderButton>\n      <SliderButton selected={!isLeftSelected} setSelected={() => setSelected?.(options.right.value)}>\n        {options.right.text}\n      </SliderButton>\n    </div>\n  );\n});\n\ninterface SliderButtonProps {\n  selected: boolean;\n  children: string | JSX.Element | Array<JSX.Element | string>;\n  setSelected: () => void;\n}\n\nconst SliderButton = memo(({ selected, children, setSelected }: SliderButtonProps) => {\n  return (\n    <button\n      onClick={setSelected}\n      className={classNames(\n        'bg-transparent text-sm px-2.5 py-0.5 rounded-full relative',\n        selected\n          ? 'text-bolt-elements-item-contentAccent'\n          : 'text-bolt-elements-item-contentDefault hover:text-bolt-elements-item-contentActive',\n      )}\n    >\n      <span className=\"relative z-10\">{children}</span>\n      {selected && (\n        <motion.span\n          layoutId=\"pill-tab\"\n          transition={{ duration: 0.2, ease: cubicEasingFn }}\n          className=\"absolute inset-0 z-0 bg-bolt-elements-item-backgroundAccent rounded-full\"\n        ></motion.span>\n      )}\n    </button>\n  );\n});\n", "tag": "", "tokens": 626, "metadata": {}}], "modify_time": 1733125234.6224983}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/PanelHeader.tsx", "relative_path": "bolt.new/app/components/ui/PanelHeader.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/PanelHeader.tsx", "source_code": "import { memo } from 'react';\nimport { classNames } from '~/utils/classNames';\n\ninterface PanelHeaderProps {\n  className?: string;\n  children: React.ReactNode;\n}\n\nexport const PanelHeader = memo(({ className, children }: PanelHeaderProps) => {\n  return (\n    <div\n      className={classNames(\n        'flex items-center gap-2 bg-bolt-elements-background-depth-2 text-bolt-elements-textSecondary border-b border-bolt-elements-borderColor px-4 py-1 min-h-[34px] text-sm',\n        className,\n      )}\n    >\n      {children}\n    </div>\n  );\n});\n", "tag": "", "tokens": 174, "metadata": {}}], "modify_time": 1733125234.622263}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/Dialog.tsx", "relative_path": "bolt.new/app/components/ui/Dialog.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/Dialog.tsx", "source_code": "import * as RadixDialog from '@radix-ui/react-dialog';\nimport { motion, type Variants } from 'framer-motion';\nimport React, { memo, type ReactNode } from 'react';\nimport { classNames } from '~/utils/classNames';\nimport { cubicEasingFn } from '~/utils/easings';\nimport { IconButton } from './IconButton';\n\nexport { Close as DialogClose, Root as DialogRoot } from '@radix-ui/react-dialog';\n\nconst transition = {\n  duration: 0.15,\n  ease: cubicEasingFn,\n};\n\nexport const dialogBackdropVariants = {\n  closed: {\n    opacity: 0,\n    transition,\n  },\n  open: {\n    opacity: 1,\n    transition,\n  },\n} satisfies Variants;\n\nexport const dialogVariants = {\n  closed: {\n    x: '-50%',\n    y: '-40%',\n    scale: 0.96,\n    opacity: 0,\n    transition,\n  },\n  open: {\n    x: '-50%',\n    y: '-50%',\n    scale: 1,\n    opacity: 1,\n    transition,\n  },\n} satisfies Variants;\n\ninterface DialogButtonProps {\n  type: 'primary' | 'secondary' | 'danger';\n  children: ReactNode;\n  onClick?: (event: React.UIEvent) => void;\n}\n\nexport const DialogButton = memo(({ type, children, onClick }: DialogButtonProps) => {\n  return (\n    <button\n      className={classNames(\n        'inline-flex h-[35px] items-center justify-center rounded-lg px-4 text-sm leading-none focus:outline-none',\n        {\n          'bg-bolt-elements-button-primary-background text-bolt-elements-button-primary-text hover:bg-bolt-elements-button-primary-backgroundHover':\n            type === 'primary',\n          'bg-bolt-elements-button-secondary-background text-bolt-elements-button-secondary-text hover:bg-bolt-elements-button-secondary-backgroundHover':\n            type === 'secondary',\n          'bg-bolt-elements-button-danger-background text-bolt-elements-button-danger-text hover:bg-bolt-elements-button-danger-backgroundHover':\n            type === 'danger',\n        },\n      )}\n      onClick={onClick}\n    >\n      {children}\n    </button>\n  );\n});\n\nexport const DialogTitle = memo(({ className, children, ...props }: RadixDialog.DialogTitleProps) => {\n  return (\n    <RadixDialog.Title\n      className={classNames(\n        'px-5 py-4 flex items-center justify-between border-b border-bolt-elements-borderColor text-lg font-semibold leading-6 text-bolt-elements-textPrimary',\n        className,\n      )}\n      {...props}\n    >\n      {children}\n    </RadixDialog.Title>\n  );\n});\n\nexport const DialogDescription = memo(({ className, children, ...props }: RadixDialog.DialogDescriptionProps) => {\n  return (\n    <RadixDialog.Description\n      className={classNames('px-5 py-4 text-bolt-elements-textPrimary text-md', className)}\n      {...props}\n    >\n      {children}\n    </RadixDialog.Description>\n  );\n});\n\ninterface DialogProps {\n  children: ReactNode | ReactNode[];\n  className?: string;\n  onBackdrop?: (event: React.UIEvent) => void;\n  onClose?: (event: React.UIEvent) => void;\n}\n\nexport const Dialog = memo(({ className, children, onBackdrop, onClose }: DialogProps) => {\n  return (\n    <RadixDialog.Portal>\n      <RadixDialog.Overlay onClick={onBackdrop} asChild>\n        <motion.div\n          className=\"bg-black/50 fixed inset-0 z-max\"\n          initial=\"closed\"\n          animate=\"open\"\n          exit=\"closed\"\n          variants={dialogBackdropVariants}\n        />\n      </RadixDialog.Overlay>\n      <RadixDialog.Content asChild>\n        <motion.div\n          className={classNames(\n            'fixed top-[50%] left-[50%] z-max max-h-[85vh] w-[90vw] max-w-[450px] translate-x-[-50%] translate-y-[-50%] border border-bolt-elements-borderColor rounded-lg bg-bolt-elements-background-depth-2 shadow-lg focus:outline-none overflow-hidden',\n            className,\n          )}\n          initial=\"closed\"\n          animate=\"open\"\n          exit=\"closed\"\n          variants={dialogVariants}\n        >\n          {children}\n          <RadixDialog.Close asChild onClick={onClose}>\n            <IconButton icon=\"i-ph:x\" className=\"absolute top-[10px] right-[10px]\" />\n          </RadixDialog.Close>\n        </motion.div>\n      </RadixDialog.Content>\n    </RadixDialog.Portal>\n  );\n});\n", "tag": "", "tokens": 1247, "metadata": {}}], "modify_time": 1733125234.6219187}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/IconButton.tsx", "relative_path": "bolt.new/app/components/ui/IconButton.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/IconButton.tsx", "source_code": "import { memo } from 'react';\nimport { classNames } from '~/utils/classNames';\n\ntype IconSize = 'sm' | 'md' | 'lg' | 'xl' | 'xxl';\n\ninterface BaseIconButtonProps {\n  size?: IconSize;\n  className?: string;\n  iconClassName?: string;\n  disabledClassName?: string;\n  title?: string;\n  disabled?: boolean;\n  onClick?: (event: React.MouseEvent<HTMLButtonElement, MouseEvent>) => void;\n}\n\ntype IconButtonWithoutChildrenProps = {\n  icon: string;\n  children?: undefined;\n} & BaseIconButtonProps;\n\ntype IconButtonWithChildrenProps = {\n  icon?: undefined;\n  children: string | JSX.Element | JSX.Element[];\n} & BaseIconButtonProps;\n\ntype IconButtonProps = IconButtonWithoutChildrenProps | IconButtonWithChildrenProps;\n\nexport const IconButton = memo(\n  ({\n    icon,\n    size = 'xl',\n    className,\n    iconClassName,\n    disabledClassName,\n    disabled = false,\n    title,\n    onClick,\n    children,\n  }: IconButtonProps) => {\n    return (\n      <button\n        className={classNames(\n          'flex items-center text-bolt-elements-item-contentDefault bg-transparent enabled:hover:text-bolt-elements-item-contentActive rounded-md p-1 enabled:hover:bg-bolt-elements-item-backgroundActive disabled:cursor-not-allowed',\n          {\n            [classNames('opacity-30', disabledClassName)]: disabled,\n          },\n          className,\n        )}\n        title={title}\n        disabled={disabled}\n        onClick={(event) => {\n          if (disabled) {\n            return;\n          }\n\n          onClick?.(event);\n        }}\n      >\n        {children ? children : <div className={classNames(icon, getIconSize(size), iconClassName)}></div>}\n      </button>\n    );\n  },\n);\n\nfunction getIconSize(size: IconSize) {\n  if (size === 'sm') {\n    return 'text-sm';\n  } else if (size === 'md') {\n    return 'text-md';\n  } else if (size === 'lg') {\n    return 'text-lg';\n  } else if (size === 'xl') {\n    return 'text-xl';\n  } else {\n    return 'text-2xl';\n  }\n}\n", "tag": "", "tokens": 587, "metadata": {}}], "modify_time": 1733125234.6220403}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/PanelHeaderButton.tsx", "relative_path": "bolt.new/app/components/ui/PanelHeaderButton.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/PanelHeaderButton.tsx", "source_code": "import { memo } from 'react';\nimport { classNames } from '~/utils/classNames';\n\ninterface PanelHeaderButtonProps {\n  className?: string;\n  disabledClassName?: string;\n  disabled?: boolean;\n  children: string | JSX.Element | Array<JSX.Element | string>;\n  onClick?: (event: React.MouseEvent<HTMLButtonElement, MouseEvent>) => void;\n}\n\nexport const PanelHeaderButton = memo(\n  ({ className, disabledClassName, disabled = false, children, onClick }: PanelHeaderButtonProps) => {\n    return (\n      <button\n        className={classNames(\n          'flex items-center shrink-0 gap-1.5 px-1.5 rounded-md py-0.5 text-bolt-elements-item-contentDefault bg-transparent enabled:hover:text-bolt-elements-item-contentActive enabled:hover:bg-bolt-elements-item-backgroundActive disabled:cursor-not-allowed',\n          {\n            [classNames('opacity-30', disabledClassName)]: disabled,\n          },\n          className,\n        )}\n        disabled={disabled}\n        onClick={(event) => {\n          if (disabled) {\n            return;\n          }\n\n          onClick?.(event);\n        }}\n      >\n        {children}\n      </button>\n    );\n  },\n);\n", "tag": "", "tokens": 317, "metadata": {}}], "modify_time": 1733125234.6223807}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/ThemeSwitch.tsx", "relative_path": "bolt.new/app/components/ui/ThemeSwitch.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/ui/ThemeSwitch.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport { memo, useEffect, useState } from 'react';\nimport { themeStore, toggleTheme } from '~/lib/stores/theme';\nimport { IconButton } from './IconButton';\n\ninterface ThemeSwitchProps {\n  className?: string;\n}\n\nexport const ThemeSwitch = memo(({ className }: ThemeSwitchProps) => {\n  const theme = useStore(themeStore);\n  const [domLoaded, setDomLoaded] = useState(false);\n\n  useEffect(() => {\n    setDomLoaded(true);\n  }, []);\n\n  return (\n    domLoaded && (\n      <IconButton\n        className={className}\n        icon={theme === 'dark' ? 'i-ph-sun-dim-duotone' : 'i-ph-moon-stars-duotone'}\n        size=\"xl\"\n        title=\"Toggle Theme\"\n        onClick={toggleTheme}\n      />\n    )\n  );\n});\n", "tag": "", "tokens": 236, "metadata": {}}], "modify_time": 1733125234.622612}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/AssistantMessage.tsx", "relative_path": "bolt.new/app/components/chat/AssistantMessage.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/AssistantMessage.tsx", "source_code": "import { memo } from 'react';\nimport { Markdown } from './Markdown';\n\ninterface AssistantMessageProps {\n  content: string;\n}\n\nexport const AssistantMessage = memo(({ content }: AssistantMessageProps) => {\n  return (\n    <div className=\"overflow-hidden w-full\">\n      <Markdown html>{content}</Markdown>\n    </div>\n  );\n});\n", "tag": "", "tokens": 101, "metadata": {}}], "modify_time": 1733125234.6186817}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/CodeBlock.module.scss", "relative_path": "bolt.new/app/components/chat/CodeBlock.module.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/CodeBlock.module.scss", "source_code": ".CopyButtonContainer {\n  button:before {\n    content: 'Copied';\n    font-size: 12px;\n    position: absolute;\n    left: -53px;\n    padding: 2px 6px;\n    height: 30px;\n  }\n}\n", "tag": "", "tokens": 79, "metadata": {}}], "modify_time": 1733125234.619241}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Chat.client.tsx", "relative_path": "bolt.new/app/components/chat/Chat.client.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Chat.client.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport type { Message } from 'ai';\nimport { useChat } from 'ai/react';\nimport { useAnimate } from 'framer-motion';\nimport { memo, useEffect, useRef, useState } from 'react';\nimport { cssTransition, toast, ToastContainer } from 'react-toastify';\nimport { useMessageParser, usePromptEnhancer, useShortcuts, useSnapScroll } from '~/lib/hooks';\nimport { useChatHistory } from '~/lib/persistence';\nimport { chatStore } from '~/lib/stores/chat';\nimport { workbenchStore } from '~/lib/stores/workbench';\nimport { fileModificationsToHTML } from '~/utils/diff';\nimport { cubicEasingFn } from '~/utils/easings';\nimport { createScopedLogger, renderLogger } from '~/utils/logger';\nimport { BaseChat } from './BaseChat';\n\nconst toastAnimation = cssTransition({\n  enter: 'animated fadeInRight',\n  exit: 'animated fadeOutRight',\n});\n\nconst logger = createScopedLogger('Chat');\n\nexport function Chat() {\n  renderLogger.trace('Chat');\n\n  const { ready, initialMessages, storeMessageHistory } = useChatHistory();\n\n  return (\n    <>\n      {ready && <ChatImpl initialMessages={initialMessages} storeMessageHistory={storeMessageHistory} />}\n      <ToastContainer\n        closeButton={({ closeToast }) => {\n          return (\n            <button className=\"Toastify__close-button\" onClick={closeToast}>\n              <div className=\"i-ph:x text-lg\" />\n            </button>\n          );\n        }}\n        icon={({ type }) => {\n          /**\n           * @todo Handle more types if we need them. This may require extra color palettes.\n           */\n          switch (type) {\n            case 'success': {\n              return <div className=\"i-ph:check-bold text-bolt-elements-icon-success text-2xl\" />;\n            }\n            case 'error': {\n              return <div className=\"i-ph:warning-circle-bold text-bolt-elements-icon-error text-2xl\" />;\n            }\n          }\n\n          return undefined;\n        }}\n        position=\"bottom-right\"\n        pauseOnFocusLoss\n        transition={toastAnimation}\n      />\n    </>\n  );\n}\n\ninterface ChatProps {\n  initialMessages: Message[];\n  storeMessageHistory: (messages: Message[]) => Promise<void>;\n}\n\nexport const ChatImpl = memo(({ initialMessages, storeMessageHistory }: ChatProps) => {\n  useShortcuts();\n\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const [chatStarted, setChatStarted] = useState(initialMessages.length > 0);\n\n  const { showChat } = useStore(chatStore);\n\n  const [animationScope, animate] = useAnimate();\n\n  const { messages, isLoading, input, handleInputChange, setInput, stop, append } = useChat({\n    api: '/api/chat',\n    onError: (error) => {\n      logger.error('Request failed\\n\\n', error);\n      toast.error('There was an error processing your request');\n    },\n    onFinish: () => {\n      logger.debug('Finished streaming');\n    },\n    initialMessages,\n  });\n\n  const { enhancingPrompt, promptEnhanced, enhancePrompt, resetEnhancer } = usePromptEnhancer();\n  const { parsedMessages, parseMessages } = useMessageParser();\n\n  const TEXTAREA_MAX_HEIGHT = chatStarted ? 400 : 200;\n\n  useEffect(() => {\n    chatStore.setKey('started', initialMessages.length > 0);\n  }, []);\n\n  useEffect(() => {\n    parseMessages(messages, isLoading);\n\n    if (messages.length > initialMessages.length) {\n      storeMessageHistory(messages).catch((error) => toast.error(error.message));\n    }\n  }, [messages, isLoading, parseMessages]);\n\n  const scrollTextArea = () => {\n    const textarea = textareaRef.current;\n\n    if (textarea) {\n      textarea.scrollTop = textarea.scrollHeight;\n    }\n  };\n\n  const abort = () => {\n    stop();\n    chatStore.setKey('aborted', true);\n    workbenchStore.abortAllActions();\n  };\n\n  useEffect(() => {\n    const textarea = textareaRef.current;\n\n    if (textarea) {\n      textarea.style.height = 'auto';\n\n      const scrollHeight = textarea.scrollHeight;\n\n      textarea.style.height = `${Math.min(scrollHeight, TEXTAREA_MAX_HEIGHT)}px`;\n      textarea.style.overflowY = scrollHeight > TEXTAREA_MAX_HEIGHT ? 'auto' : 'hidden';\n    }\n  }, [input, textareaRef]);\n\n  const runAnimation = async () => {\n    if (chatStarted) {\n      return;\n    }\n\n    await Promise.all([\n      animate('#examples', { opacity: 0, display: 'none' }, { duration: 0.1 }),\n      animate('#intro', { opacity: 0, flex: 1 }, { duration: 0.2, ease: cubicEasingFn }),\n    ]);\n\n    chatStore.setKey('started', true);\n\n    setChatStarted(true);\n  };\n\n  const sendMessage = async (_event: React.UIEvent, messageInput?: string) => {\n    const _input = messageInput || input;\n\n    if (_input.length === 0 || isLoading) {\n      return;\n    }\n\n    /**\n     * @note (delm) Usually saving files shouldn't take long but it may take longer if there\n     * many unsaved files. In that case we need to block user input and show an indicator\n     * of some kind so the user is aware that something is happening. But I consider the\n     * happy case to be no unsaved files and I would expect users to save their changes\n     * before they send another message.\n     */\n    await workbenchStore.saveAllFiles();\n\n    const fileModifications = workbenchStore.getFileModifcations();\n\n    chatStore.setKey('aborted', false);\n\n    runAnimation();\n\n    if (fileModifications !== undefined) {\n      const diff = fileModificationsToHTML(fileModifications);\n\n      /**\n       * If we have file modifications we append a new user message manually since we have to prefix\n       * the user input with the file modifications and we don't want the new user input to appear\n       * in the prompt. Using `append` is almost the same as `handleSubmit` except that we have to\n       * manually reset the input and we'd have to manually pass in file attachments. However, those\n       * aren't relevant here.\n       */\n      append({ role: 'user', content: `${diff}\\n\\n${_input}` });\n\n      /**\n       * After sending a new message we reset all modifications since the model\n       * should now be aware of all the changes.\n       */\n      workbenchStore.resetAllFileModifications();\n    } else {\n      append({ role: 'user', content: _input });\n    }\n\n    setInput('');\n\n    resetEnhancer();\n\n    textareaRef.current?.blur();\n  };\n\n  const [messageRef, scrollRef] = useSnapScroll();\n\n  return (\n    <BaseChat\n      ref={animationScope}\n      textareaRef={textareaRef}\n      input={input}\n      showChat={showChat}\n      chatStarted={chatStarted}\n      isStreaming={isLoading}\n      enhancingPrompt={enhancingPrompt}\n      promptEnhanced={promptEnhanced}\n      sendMessage={sendMessage}\n      messageRef={messageRef}\n      scrollRef={scrollRef}\n      handleInputChange={handleInputChange}\n      handleStop={abort}\n      messages={messages.map((message, i) => {\n        if (message.role === 'user') {\n          return message;\n        }\n\n        return {\n          ...message,\n          content: parsedMessages[i] || '',\n        };\n      })}\n      enhancePrompt={() => {\n        enhancePrompt(input, (input) => {\n          setInput(input);\n          scrollTextArea();\n        });\n      }}\n    />\n  );\n});\n", "tag": "", "tokens": 1990, "metadata": {}}], "modify_time": 1733125234.6191137}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Markdown.tsx", "relative_path": "bolt.new/app/components/chat/Markdown.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Markdown.tsx", "source_code": "import { memo, useMemo } from 'react';\nimport ReactMarkdown, { type Components } from 'react-markdown';\nimport type { BundledLanguage } from 'shiki';\nimport { createScopedLogger } from '~/utils/logger';\nimport { rehypePlugins, remarkPlugins, allowedHTMLElements } from '~/utils/markdown';\nimport { Artifact } from './Artifact';\nimport { CodeBlock } from './CodeBlock';\n\nimport styles from './Markdown.module.scss';\n\nconst logger = createScopedLogger('MarkdownComponent');\n\ninterface MarkdownProps {\n  children: string;\n  html?: boolean;\n  limitedMarkdown?: boolean;\n}\n\nexport const Markdown = memo(({ children, html = false, limitedMarkdown = false }: MarkdownProps) => {\n  logger.trace('Render');\n\n  const components = useMemo(() => {\n    return {\n      div: ({ className, children, node, ...props }) => {\n        if (className?.includes('__boltArtifact__')) {\n          const messageId = node?.properties.dataMessageId as string;\n\n          if (!messageId) {\n            logger.error(`Invalid message id ${messageId}`);\n          }\n\n          return <Artifact messageId={messageId} />;\n        }\n\n        return (\n          <div className={className} {...props}>\n            {children}\n          </div>\n        );\n      },\n      pre: (props) => {\n        const { children, node, ...rest } = props;\n\n        const [firstChild] = node?.children ?? [];\n\n        if (\n          firstChild &&\n          firstChild.type === 'element' &&\n          firstChild.tagName === 'code' &&\n          firstChild.children[0].type === 'text'\n        ) {\n          const { className, ...rest } = firstChild.properties;\n          const [, language = 'plaintext'] = /language-(\\w+)/.exec(String(className) || '') ?? [];\n\n          return <CodeBlock code={firstChild.children[0].value} language={language as BundledLanguage} {...rest} />;\n        }\n\n        return <pre {...rest}>{children}</pre>;\n      },\n    } satisfies Components;\n  }, []);\n\n  return (\n    <ReactMarkdown\n      allowedElements={allowedHTMLElements}\n      className={styles.MarkdownContent}\n      components={components}\n      remarkPlugins={remarkPlugins(limitedMarkdown)}\n      rehypePlugins={rehypePlugins(html)}\n    >\n      {children}\n    </ReactMarkdown>\n  );\n});\n", "tag": "", "tokens": 607, "metadata": {}}], "modify_time": 1733125234.6196227}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/BaseChat.tsx", "relative_path": "bolt.new/app/components/chat/BaseChat.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/BaseChat.tsx", "source_code": "import type { Message } from 'ai';\nimport React, { type RefCallback } from 'react';\nimport { ClientOnly } from 'remix-utils/client-only';\nimport { Menu } from '~/components/sidebar/Menu.client';\nimport { IconButton } from '~/components/ui/IconButton';\nimport { Workbench } from '~/components/workbench/Workbench.client';\nimport { classNames } from '~/utils/classNames';\nimport { Messages } from './Messages.client';\nimport { SendButton } from './SendButton.client';\n\nimport styles from './BaseChat.module.scss';\n\ninterface BaseChatProps {\n  textareaRef?: React.RefObject<HTMLTextAreaElement> | undefined;\n  messageRef?: RefCallback<HTMLDivElement> | undefined;\n  scrollRef?: RefCallback<HTMLDivElement> | undefined;\n  showChat?: boolean;\n  chatStarted?: boolean;\n  isStreaming?: boolean;\n  messages?: Message[];\n  enhancingPrompt?: boolean;\n  promptEnhanced?: boolean;\n  input?: string;\n  handleStop?: () => void;\n  sendMessage?: (event: React.UIEvent, messageInput?: string) => void;\n  handleInputChange?: (event: React.ChangeEvent<HTMLTextAreaElement>) => void;\n  enhancePrompt?: () => void;\n}\n\nconst EXAMPLE_PROMPTS = [\n  { text: 'Build a todo app in React using Tailwind' },\n  { text: 'Build a simple blog using Astro' },\n  { text: 'Create a cookie consent form using Material UI' },\n  { text: 'Make a space invaders game' },\n  { text: 'How do I center a div?' },\n];\n\nconst TEXTAREA_MIN_HEIGHT = 76;\n\nexport const BaseChat = React.forwardRef<HTMLDivElement, BaseChatProps>(\n  (\n    {\n      textareaRef,\n      messageRef,\n      scrollRef,\n      showChat = true,\n      chatStarted = false,\n      isStreaming = false,\n      enhancingPrompt = false,\n      promptEnhanced = false,\n      messages,\n      input = '',\n      sendMessage,\n      handleInputChange,\n      enhancePrompt,\n      handleStop,\n    },\n    ref,\n  ) => {\n    const TEXTAREA_MAX_HEIGHT = chatStarted ? 400 : 200;\n\n    return (\n      <div\n        ref={ref}\n        className={classNames(\n          styles.BaseChat,\n          'relative flex h-full w-full overflow-hidden bg-bolt-elements-background-depth-1',\n        )}\n        data-chat-visible={showChat}\n      >\n        <ClientOnly>{() => <Menu />}</ClientOnly>\n        <div ref={scrollRef} className=\"flex overflow-y-auto w-full h-full\">\n          <div className={classNames(styles.Chat, 'flex flex-col flex-grow min-w-[var(--chat-min-width)] h-full')}>\n            {!chatStarted && (\n              <div id=\"intro\" className=\"mt-[26vh] max-w-chat mx-auto\">\n                <h1 className=\"text-5xl text-center font-bold text-bolt-elements-textPrimary mb-2\">\n                  Where ideas begin\n                </h1>\n                <p className=\"mb-4 text-center text-bolt-elements-textSecondary\">\n                  Bring ideas to life in seconds or get help on existing projects.\n                </p>\n              </div>\n            )}\n            <div\n              className={classNames('pt-6 px-6', {\n                'h-full flex flex-col': chatStarted,\n              })}\n            >\n              <ClientOnly>\n                {() => {\n                  return chatStarted ? (\n                    <Messages\n                      ref={messageRef}\n                      className=\"flex flex-col w-full flex-1 max-w-chat px-4 pb-6 mx-auto z-1\"\n                      messages={messages}\n                      isStreaming={isStreaming}\n                    />\n                  ) : null;\n                }}\n              </ClientOnly>\n              <div\n                className={classNames('relative w-full max-w-chat mx-auto z-prompt', {\n                  'sticky bottom-0': chatStarted,\n                })}\n              >\n                <div\n                  className={classNames(\n                    'shadow-sm border border-bolt-elements-borderColor bg-bolt-elements-prompt-background backdrop-filter backdrop-blur-[8px] rounded-lg overflow-hidden',\n                  )}\n                >\n                  <textarea\n                    ref={textareaRef}\n                    className={`w-full pl-4 pt-4 pr-16 focus:outline-none resize-none text-md text-bolt-elements-textPrimary placeholder-bolt-elements-textTertiary bg-transparent`}\n                    onKeyDown={(event) => {\n                      if (event.key === 'Enter') {\n                        if (event.shiftKey) {\n                          return;\n                        }\n\n                        event.preventDefault();\n\n                        sendMessage?.(event);\n                      }\n                    }}\n                    value={input}\n                    onChange={(event) => {\n                      handleInputChange?.(event);\n                    }}\n                    style={{\n                      minHeight: TEXTAREA_MIN_HEIGHT,\n                      maxHeight: TEXTAREA_MAX_HEIGHT,\n                    }}\n                    placeholder=\"How can Bolt help you today?\"\n                    translate=\"no\"\n                  />\n                  <ClientOnly>\n                    {() => (\n                      <SendButton\n                        show={input.length > 0 || isStreaming}\n                        isStreaming={isStreaming}\n                        onClick={(event) => {\n                          if (isStreaming) {\n                            handleStop?.();\n                            return;\n                          }\n\n                          sendMessage?.(event);\n                        }}\n                      />\n                    )}\n                  </ClientOnly>\n                  <div className=\"flex justify-between text-sm p-4 pt-2\">\n                    <div className=\"flex gap-1 items-center\">\n                      <IconButton\n                        title=\"Enhance prompt\"\n                        disabled={input.length === 0 || enhancingPrompt}\n                        className={classNames({\n                          'opacity-100!': enhancingPrompt,\n                          'text-bolt-elements-item-contentAccent! pr-1.5 enabled:hover:bg-bolt-elements-item-backgroundAccent!':\n                            promptEnhanced,\n                        })}\n                        onClick={() => enhancePrompt?.()}\n                      >\n                        {enhancingPrompt ? (\n                          <>\n                            <div className=\"i-svg-spinners:90-ring-with-bg text-bolt-elements-loader-progress text-xl\"></div>\n                            <div className=\"ml-1.5\">Enhancing prompt...</div>\n                          </>\n                        ) : (\n                          <>\n                            <div className=\"i-bolt:stars text-xl\"></div>\n                            {promptEnhanced && <div className=\"ml-1.5\">Prompt enhanced</div>}\n                          </>\n                        )}\n                      </IconButton>\n                    </div>\n                    {input.length > 3 ? (\n                      <div className=\"text-xs text-bolt-elements-textTertiary\">\n                        Use <kbd className=\"kdb\">Shift</kbd> + <kbd className=\"kdb\">Return</kbd> for a new line\n                      </div>\n                    ) : null}\n                  </div>\n                </div>\n                <div className=\"bg-bolt-elements-background-depth-1 pb-6\">{/* Ghost Element */}</div>\n              </div>\n            </div>\n            {!chatStarted && (\n              <div id=\"examples\" className=\"relative w-full max-w-xl mx-auto mt-8 flex justify-center\">\n                <div className=\"flex flex-col space-y-2 [mask-image:linear-gradient(to_bottom,black_0%,transparent_180%)] hover:[mask-image:none]\">\n                  {EXAMPLE_PROMPTS.map((examplePrompt, index) => {\n                    return (\n                      <button\n                        key={index}\n                        onClick={(event) => {\n                          sendMessage?.(event, examplePrompt.text);\n                        }}\n                        className=\"group flex items-center w-full gap-2 justify-center bg-transparent text-bolt-elements-textTertiary hover:text-bolt-elements-textPrimary transition-theme\"\n                      >\n                        {examplePrompt.text}\n                        <div className=\"i-ph:arrow-bend-down-left\" />\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n          <ClientOnly>{() => <Workbench chatStarted={chatStarted} isStreaming={isStreaming} />}</ClientOnly>\n        </div>\n      </div>\n    );\n  },\n);\n", "tag": "", "tokens": 2054, "metadata": {}}], "modify_time": 1733125234.6189623}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/UserMessage.tsx", "relative_path": "bolt.new/app/components/chat/UserMessage.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/UserMessage.tsx", "source_code": "import { modificationsRegex } from '~/utils/diff';\nimport { Markdown } from './Markdown';\n\ninterface UserMessageProps {\n  content: string;\n}\n\nexport function UserMessage({ content }: UserMessageProps) {\n  return (\n    <div className=\"overflow-hidden pt-[4px]\">\n      <Markdown limitedMarkdown>{sanitizeUserMessage(content)}</Markdown>\n    </div>\n  );\n}\n\nfunction sanitizeUserMessage(content: string) {\n  return content.replace(modificationsRegex, '').trim();\n}\n", "tag": "", "tokens": 141, "metadata": {}}], "modify_time": 1733125234.6201303}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/BaseChat.module.scss", "relative_path": "bolt.new/app/components/chat/BaseChat.module.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/BaseChat.module.scss", "source_code": ".BaseChat {\n  &[data-chat-visible='false'] {\n    --workbench-inner-width: 100%;\n    --workbench-left: 0;\n\n    .Chat {\n      --at-apply: bolt-ease-cubic-bezier;\n      transition-property: transform, opacity;\n      transition-duration: 0.3s;\n      will-change: transform, opacity;\n      transform: translateX(-50%);\n      opacity: 0;\n    }\n  }\n}\n\n.Chat {\n  opacity: 1;\n}\n", "tag": "", "tokens": 141, "metadata": {}}], "modify_time": 1733125234.6188042}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Artifact.tsx", "relative_path": "bolt.new/app/components/chat/Artifact.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Artifact.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport { AnimatePresence, motion } from 'framer-motion';\nimport { computed } from 'nanostores';\nimport { memo, useEffect, useRef, useState } from 'react';\nimport { createHighlighter, type BundledLanguage, type BundledTheme, type HighlighterGeneric } from 'shiki';\nimport type { ActionState } from '~/lib/runtime/action-runner';\nimport { workbenchStore } from '~/lib/stores/workbench';\nimport { classNames } from '~/utils/classNames';\nimport { cubicEasingFn } from '~/utils/easings';\n\nconst highlighterOptions = {\n  langs: ['shell'],\n  themes: ['light-plus', 'dark-plus'],\n};\n\nconst shellHighlighter: HighlighterGeneric<BundledLanguage, BundledTheme> =\n  import.meta.hot?.data.shellHighlighter ?? (await createHighlighter(highlighterOptions));\n\nif (import.meta.hot) {\n  import.meta.hot.data.shellHighlighter = shellHighlighter;\n}\n\ninterface ArtifactProps {\n  messageId: string;\n}\n\nexport const Artifact = memo(({ messageId }: ArtifactProps) => {\n  const userToggledActions = useRef(false);\n  const [showActions, setShowActions] = useState(false);\n\n  const artifacts = useStore(workbenchStore.artifacts);\n  const artifact = artifacts[messageId];\n\n  const actions = useStore(\n    computed(artifact.runner.actions, (actions) => {\n      return Object.values(actions);\n    }),\n  );\n\n  const toggleActions = () => {\n    userToggledActions.current = true;\n    setShowActions(!showActions);\n  };\n\n  useEffect(() => {\n    if (actions.length && !showActions && !userToggledActions.current) {\n      setShowActions(true);\n    }\n  }, [actions]);\n\n  return (\n    <div className=\"artifact border border-bolt-elements-borderColor flex flex-col overflow-hidden rounded-lg w-full transition-border duration-150\">\n      <div className=\"flex\">\n        <button\n          className=\"flex items-stretch bg-bolt-elements-artifacts-background hover:bg-bolt-elements-artifacts-backgroundHover w-full overflow-hidden\"\n          onClick={() => {\n            const showWorkbench = workbenchStore.showWorkbench.get();\n            workbenchStore.showWorkbench.set(!showWorkbench);\n          }}\n        >\n          <div className=\"px-5 p-3.5 w-full text-left\">\n            <div className=\"w-full text-bolt-elements-textPrimary font-medium leading-5 text-sm\">{artifact?.title}</div>\n            <div className=\"w-full w-full text-bolt-elements-textSecondary text-xs mt-0.5\">Click to open Workbench</div>\n          </div>\n        </button>\n        <div className=\"bg-bolt-elements-artifacts-borderColor w-[1px]\" />\n        <AnimatePresence>\n          {actions.length && (\n            <motion.button\n              initial={{ width: 0 }}\n              animate={{ width: 'auto' }}\n              exit={{ width: 0 }}\n              transition={{ duration: 0.15, ease: cubicEasingFn }}\n              className=\"bg-bolt-elements-artifacts-background hover:bg-bolt-elements-artifacts-backgroundHover\"\n              onClick={toggleActions}\n            >\n              <div className=\"p-4\">\n                <div className={showActions ? 'i-ph:caret-up-bold' : 'i-ph:caret-down-bold'}></div>\n              </div>\n            </motion.button>\n          )}\n        </AnimatePresence>\n      </div>\n      <AnimatePresence>\n        {showActions && actions.length > 0 && (\n          <motion.div\n            className=\"actions\"\n            initial={{ height: 0 }}\n            animate={{ height: 'auto' }}\n            exit={{ height: '0px' }}\n            transition={{ duration: 0.15 }}\n          >\n            <div className=\"bg-bolt-elements-artifacts-borderColor h-[1px]\" />\n            <div className=\"p-5 text-left bg-bolt-elements-actions-background\">\n              <ActionList actions={actions} />\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n});\n\ninterface ShellCodeBlockProps {\n  classsName?: string;\n  code: string;\n}\n\nfunction ShellCodeBlock({ classsName, code }: ShellCodeBlockProps) {\n  return (\n    <div\n      className={classNames('text-xs', classsName)}\n      dangerouslySetInnerHTML={{\n        __html: shellHighlighter.codeToHtml(code, {\n          lang: 'shell',\n          theme: 'dark-plus',\n        }),\n      }}\n    ></div>\n  );\n}\n\ninterface ActionListProps {\n  actions: ActionState[];\n}\n\nconst actionVariants = {\n  hidden: { opacity: 0, y: 20 },\n  visible: { opacity: 1, y: 0 },\n};\n\nconst ActionList = memo(({ actions }: ActionListProps) => {\n  return (\n    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} transition={{ duration: 0.15 }}>\n      <ul className=\"list-none space-y-2.5\">\n        {actions.map((action, index) => {\n          const { status, type, content } = action;\n          const isLast = index === actions.length - 1;\n\n          return (\n            <motion.li\n              key={index}\n              variants={actionVariants}\n              initial=\"hidden\"\n              animate=\"visible\"\n              transition={{\n                duration: 0.2,\n                ease: cubicEasingFn,\n              }}\n            >\n              <div className=\"flex items-center gap-1.5 text-sm\">\n                <div className={classNames('text-lg', getIconColor(action.status))}>\n                  {status === 'running' ? (\n                    <div className=\"i-svg-spinners:90-ring-with-bg\"></div>\n                  ) : status === 'pending' ? (\n                    <div className=\"i-ph:circle-duotone\"></div>\n                  ) : status === 'complete' ? (\n                    <div className=\"i-ph:check\"></div>\n                  ) : status === 'failed' || status === 'aborted' ? (\n                    <div className=\"i-ph:x\"></div>\n                  ) : null}\n                </div>\n                {type === 'file' ? (\n                  <div>\n                    Create{' '}\n                    <code className=\"bg-bolt-elements-artifacts-inlineCode-background text-bolt-elements-artifacts-inlineCode-text px-1.5 py-1 rounded-md\">\n                      {action.filePath}\n                    </code>\n                  </div>\n                ) : type === 'shell' ? (\n                  <div className=\"flex items-center w-full min-h-[28px]\">\n                    <span className=\"flex-1\">Run command</span>\n                  </div>\n                ) : null}\n              </div>\n              {type === 'shell' && (\n                <ShellCodeBlock\n                  classsName={classNames('mt-1', {\n                    'mb-3.5': !isLast,\n                  })}\n                  code={content}\n                />\n              )}\n            </motion.li>\n          );\n        })}\n      </ul>\n    </motion.div>\n  );\n});\n\nfunction getIconColor(status: ActionState['status']) {\n  switch (status) {\n    case 'pending': {\n      return 'text-bolt-elements-textTertiary';\n    }\n    case 'running': {\n      return 'text-bolt-elements-loader-progress';\n    }\n    case 'complete': {\n      return 'text-bolt-elements-icon-success';\n    }\n    case 'aborted': {\n      return 'text-bolt-elements-textSecondary';\n    }\n    case 'failed': {\n      return 'text-bolt-elements-icon-error';\n    }\n    default: {\n      return undefined;\n    }\n  }\n}\n", "tag": "", "tokens": 2013, "metadata": {}}], "modify_time": 1733125234.6185563}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Messages.client.tsx", "relative_path": "bolt.new/app/components/chat/Messages.client.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Messages.client.tsx", "source_code": "import type { Message } from 'ai';\nimport React from 'react';\nimport { classNames } from '~/utils/classNames';\nimport { AssistantMessage } from './AssistantMessage';\nimport { UserMessage } from './UserMessage';\n\ninterface MessagesProps {\n  id?: string;\n  className?: string;\n  isStreaming?: boolean;\n  messages?: Message[];\n}\n\nexport const Messages = React.forwardRef<HTMLDivElement, MessagesProps>((props: MessagesProps, ref) => {\n  const { id, isStreaming = false, messages = [] } = props;\n\n  return (\n    <div id={id} ref={ref} className={props.className}>\n      {messages.length > 0\n        ? messages.map((message, index) => {\n            const { role, content } = message;\n            const isUserMessage = role === 'user';\n            const isFirst = index === 0;\n            const isLast = index === messages.length - 1;\n\n            return (\n              <div\n                key={index}\n                className={classNames('flex gap-4 p-6 w-full rounded-[calc(0.75rem-1px)]', {\n                  'bg-bolt-elements-messages-background': isUserMessage || !isStreaming || (isStreaming && !isLast),\n                  'bg-gradient-to-b from-bolt-elements-messages-background from-30% to-transparent':\n                    isStreaming && isLast,\n                  'mt-4': !isFirst,\n                })}\n              >\n                {isUserMessage && (\n                  <div className=\"flex items-center justify-center w-[34px] h-[34px] overflow-hidden bg-white text-gray-600 rounded-full shrink-0 self-start\">\n                    <div className=\"i-ph:user-fill text-xl\"></div>\n                  </div>\n                )}\n                <div className=\"grid grid-col-1 w-full\">\n                  {isUserMessage ? <UserMessage content={content} /> : <AssistantMessage content={content} />}\n                </div>\n              </div>\n            );\n          })\n        : null}\n      {isStreaming && (\n        <div className=\"text-center w-full text-bolt-elements-textSecondary i-svg-spinners:3-dots-fade text-4xl mt-4\"></div>\n      )}\n    </div>\n  );\n});\n", "tag": "", "tokens": 571, "metadata": {}}], "modify_time": 1733125234.619817}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/SendButton.client.tsx", "relative_path": "bolt.new/app/components/chat/SendButton.client.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/SendButton.client.tsx", "source_code": "import { AnimatePresence, cubicBezier, motion } from 'framer-motion';\n\ninterface SendButtonProps {\n  show: boolean;\n  isStreaming?: boolean;\n  onClick?: (event: React.MouseEvent<HTMLButtonElement, MouseEvent>) => void;\n}\n\nconst customEasingFn = cubicBezier(0.4, 0, 0.2, 1);\n\nexport function SendButton({ show, isStreaming, onClick }: SendButtonProps) {\n  return (\n    <AnimatePresence>\n      {show ? (\n        <motion.button\n          className=\"absolute flex justify-center items-center top-[18px] right-[22px] p-1 bg-accent-500 hover:brightness-94 color-white rounded-md w-[34px] h-[34px] transition-theme\"\n          transition={{ ease: customEasingFn, duration: 0.17 }}\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          exit={{ opacity: 0, y: 10 }}\n          onClick={(event) => {\n            event.preventDefault();\n            onClick?.(event);\n          }}\n        >\n          <div className=\"text-lg\">\n            {!isStreaming ? <div className=\"i-ph:arrow-right\"></div> : <div className=\"i-ph:stop-circle-bold\"></div>}\n          </div>\n        </motion.button>\n      ) : null}\n    </AnimatePresence>\n  );\n}\n", "tag": "", "tokens": 373, "metadata": {}}], "modify_time": 1733125234.619998}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Markdown.module.scss", "relative_path": "bolt.new/app/components/chat/Markdown.module.scss", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/Markdown.module.scss", "source_code": "$font-mono: ui-monospace, 'Fira Code', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;\n$code-font-size: 13px;\n\n@mixin not-inside-actions {\n  &:not(:has(:global(.actions)), :global(.actions *)) {\n    @content;\n  }\n}\n\n.MarkdownContent {\n  line-height: 1.6;\n  color: var(--bolt-elements-textPrimary);\n\n  > *:not(:last-child) {\n    margin-block-end: 16px;\n  }\n\n  :global(.artifact) {\n    margin: 1.5em 0;\n  }\n\n  :is(h1, h2, h3, h4, h5, h6) {\n    @include not-inside-actions {\n      margin-block-start: 24px;\n      margin-block-end: 16px;\n      font-weight: 600;\n      line-height: 1.25;\n      color: var(--bolt-elements-textPrimary);\n    }\n  }\n\n  h1 {\n    font-size: 2em;\n    border-bottom: 1px solid var(--bolt-elements-borderColor);\n    padding-bottom: 0.3em;\n  }\n\n  h2 {\n    font-size: 1.5em;\n    border-bottom: 1px solid var(--bolt-elements-borderColor);\n    padding-bottom: 0.3em;\n  }\n\n  h3 {\n    font-size: 1.25em;\n  }\n\n  h4 {\n    font-size: 1em;\n  }\n\n  h5 {\n    font-size: 0.875em;\n  }\n\n  h6 {\n    font-size: 0.85em;\n    color: #6a737d;\n  }\n\n  p {\n    white-space: pre-wrap;\n\n    &:not(:last-of-type) {\n      margin-block-start: 0;\n      margin-block-end: 16px;\n    }\n  }\n\n  a {\n    color: var(--bolt-elements-messages-linkColor);\n    text-decoration: none;\n    cursor: pointer;\n\n    &:hover {\n      text-decoration: underline;\n    }\n  }\n\n  :not(pre) > code {\n    font-family: $font-mono;\n    font-size: $code-font-size;\n\n    @include not-inside-actions {\n      border-radius: 6px;\n      padding: 0.2em 0.4em;\n      background-color: var(--bolt-elements-messages-inlineCode-background);\n      color: var(--bolt-elements-messages-inlineCode-text);\n    }\n  }\n\n  pre {\n    padding: 20px 16px;\n    border-radius: 6px;\n  }\n\n  pre:has(> code) {\n    font-family: $font-mono;\n    font-size: $code-font-size;\n    background: transparent;\n    overflow-x: auto;\n    min-width: 0;\n  }\n\n  blockquote {\n    margin: 0;\n    padding: 0 1em;\n    color: var(--bolt-elements-textTertiary);\n    border-left: 0.25em solid var(--bolt-elements-borderColor);\n  }\n\n  :is(ul, ol) {\n    @include not-inside-actions {\n      padding-left: 2em;\n      margin-block-start: 0;\n      margin-block-end: 16px;\n    }\n  }\n\n  ul {\n    @include not-inside-actions {\n      list-style-type: disc;\n    }\n  }\n\n  ol {\n    @include not-inside-actions {\n      list-style-type: decimal;\n    }\n  }\n\n  li {\n    @include not-inside-actions {\n      & + li {\n        margin-block-start: 8px;\n      }\n\n      > *:not(:last-child) {\n        margin-block-end: 16px;\n      }\n    }\n  }\n\n  img {\n    max-width: 100%;\n    box-sizing: border-box;\n  }\n\n  hr {\n    height: 0.25em;\n    padding: 0;\n    margin: 24px 0;\n    background-color: var(--bolt-elements-borderColor);\n    border: 0;\n  }\n\n  table {\n    border-collapse: collapse;\n    width: 100%;\n    margin-block-end: 16px;\n\n    :is(th, td) {\n      padding: 6px 13px;\n      border: 1px solid #dfe2e5;\n    }\n\n    tr:nth-child(2n) {\n      background-color: #f6f8fa;\n    }\n  }\n}\n", "tag": "", "tokens": 1256, "metadata": {}}], "modify_time": 1733125234.6195014}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/CodeBlock.tsx", "relative_path": "bolt.new/app/components/chat/CodeBlock.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/chat/CodeBlock.tsx", "source_code": "import { memo, useEffect, useState } from 'react';\nimport { bundledLanguages, codeToHtml, isSpecialLang, type BundledLanguage, type SpecialLanguage } from 'shiki';\nimport { classNames } from '~/utils/classNames';\nimport { createScopedLogger } from '~/utils/logger';\n\nimport styles from './CodeBlock.module.scss';\n\nconst logger = createScopedLogger('CodeBlock');\n\ninterface CodeBlockProps {\n  className?: string;\n  code: string;\n  language?: BundledLanguage | SpecialLanguage;\n  theme?: 'light-plus' | 'dark-plus';\n  disableCopy?: boolean;\n}\n\nexport const CodeBlock = memo(\n  ({ className, code, language = 'plaintext', theme = 'dark-plus', disableCopy = false }: CodeBlockProps) => {\n    const [html, setHTML] = useState<string | undefined>(undefined);\n    const [copied, setCopied] = useState(false);\n\n    const copyToClipboard = () => {\n      if (copied) {\n        return;\n      }\n\n      navigator.clipboard.writeText(code);\n\n      setCopied(true);\n\n      setTimeout(() => {\n        setCopied(false);\n      }, 2000);\n    };\n\n    useEffect(() => {\n      if (language && !isSpecialLang(language) && !(language in bundledLanguages)) {\n        logger.warn(`Unsupported language '${language}'`);\n      }\n\n      logger.trace(`Language = ${language}`);\n\n      const processCode = async () => {\n        setHTML(await codeToHtml(code, { lang: language, theme }));\n      };\n\n      processCode();\n    }, [code]);\n\n    return (\n      <div className={classNames('relative group text-left', className)}>\n        <div\n          className={classNames(\n            styles.CopyButtonContainer,\n            'bg-white absolute top-[10px] right-[10px] rounded-md z-10 text-lg flex items-center justify-center opacity-0 group-hover:opacity-100',\n            {\n              'rounded-l-0 opacity-100': copied,\n            },\n          )}\n        >\n          {!disableCopy && (\n            <button\n              className={classNames(\n                'flex items-center bg-transparent p-[6px] justify-center before:bg-white before:rounded-l-md before:text-gray-500 before:border-r before:border-gray-300',\n                {\n                  'before:opacity-0': !copied,\n                  'before:opacity-100': copied,\n                },\n              )}\n              title=\"Copy Code\"\n              onClick={() => copyToClipboard()}\n            >\n              <div className=\"i-ph:clipboard-text-duotone\"></div>\n            </button>\n          )}\n        </div>\n        <div dangerouslySetInnerHTML={{ __html: html ?? '' }}></div>\n      </div>\n    );\n  },\n);\n", "tag": "", "tokens": 719, "metadata": {}}], "modify_time": 1733125234.6193726}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/Workbench.client.tsx", "relative_path": "bolt.new/app/components/workbench/Workbench.client.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/Workbench.client.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport { motion, type HTMLMotionProps, type Variants } from 'framer-motion';\nimport { computed } from 'nanostores';\nimport { memo, useCallback, useEffect } from 'react';\nimport { toast } from 'react-toastify';\nimport {\n  type OnChangeCallback as OnEditorChange,\n  type OnScrollCallback as OnEditorScroll,\n} from '~/components/editor/codemirror/CodeMirrorEditor';\nimport { IconButton } from '~/components/ui/IconButton';\nimport { PanelHeaderButton } from '~/components/ui/PanelHeaderButton';\nimport { Slider, type SliderOptions } from '~/components/ui/Slider';\nimport { workbenchStore, type WorkbenchViewType } from '~/lib/stores/workbench';\nimport { classNames } from '~/utils/classNames';\nimport { cubicEasingFn } from '~/utils/easings';\nimport { renderLogger } from '~/utils/logger';\nimport { EditorPanel } from './EditorPanel';\nimport { Preview } from './Preview';\n\ninterface WorkspaceProps {\n  chatStarted?: boolean;\n  isStreaming?: boolean;\n}\n\nconst viewTransition = { ease: cubicEasingFn };\n\nconst sliderOptions: SliderOptions<WorkbenchViewType> = {\n  left: {\n    value: 'code',\n    text: 'Code',\n  },\n  right: {\n    value: 'preview',\n    text: 'Preview',\n  },\n};\n\nconst workbenchVariants = {\n  closed: {\n    width: 0,\n    transition: {\n      duration: 0.2,\n      ease: cubicEasingFn,\n    },\n  },\n  open: {\n    width: 'var(--workbench-width)',\n    transition: {\n      duration: 0.2,\n      ease: cubicEasingFn,\n    },\n  },\n} satisfies Variants;\n\nexport const Workbench = memo(({ chatStarted, isStreaming }: WorkspaceProps) => {\n  renderLogger.trace('Workbench');\n\n  const hasPreview = useStore(computed(workbenchStore.previews, (previews) => previews.length > 0));\n  const showWorkbench = useStore(workbenchStore.showWorkbench);\n  const selectedFile = useStore(workbenchStore.selectedFile);\n  const currentDocument = useStore(workbenchStore.currentDocument);\n  const unsavedFiles = useStore(workbenchStore.unsavedFiles);\n  const files = useStore(workbenchStore.files);\n  const selectedView = useStore(workbenchStore.currentView);\n\n  const setSelectedView = (view: WorkbenchViewType) => {\n    workbenchStore.currentView.set(view);\n  };\n\n  useEffect(() => {\n    if (hasPreview) {\n      setSelectedView('preview');\n    }\n  }, [hasPreview]);\n\n  useEffect(() => {\n    workbenchStore.setDocuments(files);\n  }, [files]);\n\n  const onEditorChange = useCallback<OnEditorChange>((update) => {\n    workbenchStore.setCurrentDocumentContent(update.content);\n  }, []);\n\n  const onEditorScroll = useCallback<OnEditorScroll>((position) => {\n    workbenchStore.setCurrentDocumentScrollPosition(position);\n  }, []);\n\n  const onFileSelect = useCallback((filePath: string | undefined) => {\n    workbenchStore.setSelectedFile(filePath);\n  }, []);\n\n  const onFileSave = useCallback(() => {\n    workbenchStore.saveCurrentDocument().catch(() => {\n      toast.error('Failed to update file content');\n    });\n  }, []);\n\n  const onFileReset = useCallback(() => {\n    workbenchStore.resetCurrentDocument();\n  }, []);\n\n  return (\n    chatStarted && (\n      <motion.div\n        initial=\"closed\"\n        animate={showWorkbench ? 'open' : 'closed'}\n        variants={workbenchVariants}\n        className=\"z-workbench\"\n      >\n        <div\n          className={classNames(\n            'fixed top-[calc(var(--header-height)+1.5rem)] bottom-6 w-[var(--workbench-inner-width)] mr-4 z-0 transition-[left,width] duration-200 bolt-ease-cubic-bezier',\n            {\n              'left-[var(--workbench-left)]': showWorkbench,\n              'left-[100%]': !showWorkbench,\n            },\n          )}\n        >\n          <div className=\"absolute inset-0 px-6\">\n            <div className=\"h-full flex flex-col bg-bolt-elements-background-depth-2 border border-bolt-elements-borderColor shadow-sm rounded-lg overflow-hidden\">\n              <div className=\"flex items-center px-3 py-2 border-b border-bolt-elements-borderColor\">\n                <Slider selected={selectedView} options={sliderOptions} setSelected={setSelectedView} />\n                <div className=\"ml-auto\" />\n                {selectedView === 'code' && (\n                  <PanelHeaderButton\n                    className=\"mr-1 text-sm\"\n                    onClick={() => {\n                      workbenchStore.toggleTerminal(!workbenchStore.showTerminal.get());\n                    }}\n                  >\n                    <div className=\"i-ph:terminal\" />\n                    Toggle Terminal\n                  </PanelHeaderButton>\n                )}\n                <IconButton\n                  icon=\"i-ph:x-circle\"\n                  className=\"-mr-1\"\n                  size=\"xl\"\n                  onClick={() => {\n                    workbenchStore.showWorkbench.set(false);\n                  }}\n                />\n              </div>\n              <div className=\"relative flex-1 overflow-hidden\">\n                <View\n                  initial={{ x: selectedView === 'code' ? 0 : '-100%' }}\n                  animate={{ x: selectedView === 'code' ? 0 : '-100%' }}\n                >\n                  <EditorPanel\n                    editorDocument={currentDocument}\n                    isStreaming={isStreaming}\n                    selectedFile={selectedFile}\n                    files={files}\n                    unsavedFiles={unsavedFiles}\n                    onFileSelect={onFileSelect}\n                    onEditorScroll={onEditorScroll}\n                    onEditorChange={onEditorChange}\n                    onFileSave={onFileSave}\n                    onFileReset={onFileReset}\n                  />\n                </View>\n                <View\n                  initial={{ x: selectedView === 'preview' ? 0 : '100%' }}\n                  animate={{ x: selectedView === 'preview' ? 0 : '100%' }}\n                >\n                  <Preview />\n                </View>\n              </div>\n            </div>\n          </div>\n        </div>\n      </motion.div>\n    )\n  );\n});\n\ninterface ViewProps extends HTMLMotionProps<'div'> {\n  children: JSX.Element;\n}\n\nconst View = memo(({ children, ...props }: ViewProps) => {\n  return (\n    <motion.div className=\"absolute inset-0\" transition={viewTransition} {...props}>\n      {children}\n    </motion.div>\n  );\n});\n", "tag": "", "tokens": 1678, "metadata": {}}], "modify_time": 1733125234.6235123}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/Preview.tsx", "relative_path": "bolt.new/app/components/workbench/Preview.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/Preview.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport { memo, useCallback, useEffect, useRef, useState } from 'react';\nimport { IconButton } from '~/components/ui/IconButton';\nimport { workbenchStore } from '~/lib/stores/workbench';\nimport { PortDropdown } from './PortDropdown';\n\nexport const Preview = memo(() => {\n  const iframeRef = useRef<HTMLIFrameElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const [activePreviewIndex, setActivePreviewIndex] = useState(0);\n  const [isPortDropdownOpen, setIsPortDropdownOpen] = useState(false);\n  const hasSelectedPreview = useRef(false);\n  const previews = useStore(workbenchStore.previews);\n  const activePreview = previews[activePreviewIndex];\n\n  const [url, setUrl] = useState('');\n  const [iframeUrl, setIframeUrl] = useState<string | undefined>();\n\n  useEffect(() => {\n    if (!activePreview) {\n      setUrl('');\n      setIframeUrl(undefined);\n\n      return;\n    }\n\n    const { baseUrl } = activePreview;\n\n    setUrl(baseUrl);\n    setIframeUrl(baseUrl);\n  }, [activePreview, iframeUrl]);\n\n  const validateUrl = useCallback(\n    (value: string) => {\n      if (!activePreview) {\n        return false;\n      }\n\n      const { baseUrl } = activePreview;\n\n      if (value === baseUrl) {\n        return true;\n      } else if (value.startsWith(baseUrl)) {\n        return ['/', '?', '#'].includes(value.charAt(baseUrl.length));\n      }\n\n      return false;\n    },\n    [activePreview],\n  );\n\n  const findMinPortIndex = useCallback(\n    (minIndex: number, preview: { port: number }, index: number, array: { port: number }[]) => {\n      return preview.port < array[minIndex].port ? index : minIndex;\n    },\n    [],\n  );\n\n  // when previews change, display the lowest port if user hasn't selected a preview\n  useEffect(() => {\n    if (previews.length > 1 && !hasSelectedPreview.current) {\n      const minPortIndex = previews.reduce(findMinPortIndex, 0);\n\n      setActivePreviewIndex(minPortIndex);\n    }\n  }, [previews]);\n\n  const reloadPreview = () => {\n    if (iframeRef.current) {\n      iframeRef.current.src = iframeRef.current.src;\n    }\n  };\n\n  return (\n    <div className=\"w-full h-full flex flex-col\">\n      {isPortDropdownOpen && (\n        <div className=\"z-iframe-overlay w-full h-full absolute\" onClick={() => setIsPortDropdownOpen(false)} />\n      )}\n      <div className=\"bg-bolt-elements-background-depth-2 p-2 flex items-center gap-1.5\">\n        <IconButton icon=\"i-ph:arrow-clockwise\" onClick={reloadPreview} />\n        <div\n          className=\"flex items-center gap-1 flex-grow bg-bolt-elements-preview-addressBar-background border border-bolt-elements-borderColor text-bolt-elements-preview-addressBar-text rounded-full px-3 py-1 text-sm hover:bg-bolt-elements-preview-addressBar-backgroundHover hover:focus-within:bg-bolt-elements-preview-addressBar-backgroundActive focus-within:bg-bolt-elements-preview-addressBar-backgroundActive\n        focus-within-border-bolt-elements-borderColorActive focus-within:text-bolt-elements-preview-addressBar-textActive\"\n        >\n          <input\n            ref={inputRef}\n            className=\"w-full bg-transparent outline-none\"\n            type=\"text\"\n            value={url}\n            onChange={(event) => {\n              setUrl(event.target.value);\n            }}\n            onKeyDown={(event) => {\n              if (event.key === 'Enter' && validateUrl(url)) {\n                setIframeUrl(url);\n\n                if (inputRef.current) {\n                  inputRef.current.blur();\n                }\n              }\n            }}\n          />\n        </div>\n        {previews.length > 1 && (\n          <PortDropdown\n            activePreviewIndex={activePreviewIndex}\n            setActivePreviewIndex={setActivePreviewIndex}\n            isDropdownOpen={isPortDropdownOpen}\n            setHasSelectedPreview={(value) => (hasSelectedPreview.current = value)}\n            setIsDropdownOpen={setIsPortDropdownOpen}\n            previews={previews}\n          />\n        )}\n      </div>\n      <div className=\"flex-1 border-t border-bolt-elements-borderColor\">\n        {activePreview ? (\n          <iframe ref={iframeRef} className=\"border-none w-full h-full bg-white\" src={iframeUrl} />\n        ) : (\n          <div className=\"flex w-full h-full justify-center items-center bg-white\">No preview available</div>\n        )}\n      </div>\n    </div>\n  );\n});\n", "tag": "", "tokens": 1235, "metadata": {}}], "modify_time": 1733125234.6233783}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/FileTree.tsx", "relative_path": "bolt.new/app/components/workbench/FileTree.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/FileTree.tsx", "source_code": "import { memo, useEffect, useMemo, useState, type ReactNode } from 'react';\nimport type { FileMap } from '~/lib/stores/files';\nimport { classNames } from '~/utils/classNames';\nimport { createScopedLogger, renderLogger } from '~/utils/logger';\n\nconst logger = createScopedLogger('FileTree');\n\nconst NODE_PADDING_LEFT = 8;\nconst DEFAULT_HIDDEN_FILES = [/\\/node_modules\\//, /\\/\\.next/, /\\/\\.astro/];\n\ninterface Props {\n  files?: FileMap;\n  selectedFile?: string;\n  onFileSelect?: (filePath: string) => void;\n  rootFolder?: string;\n  hideRoot?: boolean;\n  collapsed?: boolean;\n  allowFolderSelection?: boolean;\n  hiddenFiles?: Array<string | RegExp>;\n  unsavedFiles?: Set<string>;\n  className?: string;\n}\n\nexport const FileTree = memo(\n  ({\n    files = {},\n    onFileSelect,\n    selectedFile,\n    rootFolder,\n    hideRoot = false,\n    collapsed = false,\n    allowFolderSelection = false,\n    hiddenFiles,\n    className,\n    unsavedFiles,\n  }: Props) => {\n    renderLogger.trace('FileTree');\n\n    const computedHiddenFiles = useMemo(() => [...DEFAULT_HIDDEN_FILES, ...(hiddenFiles ?? [])], [hiddenFiles]);\n\n    const fileList = useMemo(() => {\n      return buildFileList(files, rootFolder, hideRoot, computedHiddenFiles);\n    }, [files, rootFolder, hideRoot, computedHiddenFiles]);\n\n    const [collapsedFolders, setCollapsedFolders] = useState(() => {\n      return collapsed\n        ? new Set(fileList.filter((item) => item.kind === 'folder').map((item) => item.fullPath))\n        : new Set<string>();\n    });\n\n    useEffect(() => {\n      if (collapsed) {\n        setCollapsedFolders(new Set(fileList.filter((item) => item.kind === 'folder').map((item) => item.fullPath)));\n        return;\n      }\n\n      setCollapsedFolders((prevCollapsed) => {\n        const newCollapsed = new Set<string>();\n\n        for (const folder of fileList) {\n          if (folder.kind === 'folder' && prevCollapsed.has(folder.fullPath)) {\n            newCollapsed.add(folder.fullPath);\n          }\n        }\n\n        return newCollapsed;\n      });\n    }, [fileList, collapsed]);\n\n    const filteredFileList = useMemo(() => {\n      const list = [];\n\n      let lastDepth = Number.MAX_SAFE_INTEGER;\n\n      for (const fileOrFolder of fileList) {\n        const depth = fileOrFolder.depth;\n\n        // if the depth is equal we reached the end of the collaped group\n        if (lastDepth === depth) {\n          lastDepth = Number.MAX_SAFE_INTEGER;\n        }\n\n        // ignore collapsed folders\n        if (collapsedFolders.has(fileOrFolder.fullPath)) {\n          lastDepth = Math.min(lastDepth, depth);\n        }\n\n        // ignore files and folders below the last collapsed folder\n        if (lastDepth < depth) {\n          continue;\n        }\n\n        list.push(fileOrFolder);\n      }\n\n      return list;\n    }, [fileList, collapsedFolders]);\n\n    const toggleCollapseState = (fullPath: string) => {\n      setCollapsedFolders((prevSet) => {\n        const newSet = new Set(prevSet);\n\n        if (newSet.has(fullPath)) {\n          newSet.delete(fullPath);\n        } else {\n          newSet.add(fullPath);\n        }\n\n        return newSet;\n      });\n    };\n\n    return (\n      <div className={classNames('text-sm', className)}>\n        {filteredFileList.map((fileOrFolder) => {\n          switch (fileOrFolder.kind) {\n            case 'file': {\n              return (\n                <File\n                  key={fileOrFolder.id}\n                  selected={selectedFile === fileOrFolder.fullPath}\n                  file={fileOrFolder}\n                  unsavedChanges={unsavedFiles?.has(fileOrFolder.fullPath)}\n                  onClick={() => {\n                    onFileSelect?.(fileOrFolder.fullPath);\n                  }}\n                />\n              );\n            }\n            case 'folder': {\n              return (\n                <Folder\n                  key={fileOrFolder.id}\n                  folder={fileOrFolder}\n                  selected={allowFolderSelection && selectedFile === fileOrFolder.fullPath}\n                  collapsed={collapsedFolders.has(fileOrFolder.fullPath)}\n                  onClick={() => {\n                    toggleCollapseState(fileOrFolder.fullPath);\n                  }}\n                />\n              );\n            }\n            default: {\n              return undefined;\n            }\n          }\n        })}\n      </div>\n    );\n  },\n);\n\nexport default FileTree;\n\ninterface FolderProps {\n  folder: FolderNode;\n  collapsed: boolean;\n  selected?: boolean;\n  onClick: () => void;\n}\n\nfunction Folder({ folder: { depth, name }, collapsed, selected = false, onClick }: FolderProps) {\n  return (\n    <NodeButton\n      className={classNames('group', {\n        'bg-transparent text-bolt-elements-item-contentDefault hover:text-bolt-elements-item-contentActive hover:bg-bolt-elements-item-backgroundActive':\n          !selected,\n        'bg-bolt-elements-item-backgroundAccent text-bolt-elements-item-contentAccent': selected,\n      })}\n      depth={depth}\n      iconClasses={classNames({\n        'i-ph:caret-right scale-98': collapsed,\n        'i-ph:caret-down scale-98': !collapsed,\n      })}\n      onClick={onClick}\n    >\n      {name}\n    </NodeButton>\n  );\n}\n\ninterface FileProps {\n  file: FileNode;\n  selected: boolean;\n  unsavedChanges?: boolean;\n  onClick: () => void;\n}\n\nfunction File({ file: { depth, name }, onClick, selected, unsavedChanges = false }: FileProps) {\n  return (\n    <NodeButton\n      className={classNames('group', {\n        'bg-transparent hover:bg-bolt-elements-item-backgroundActive text-bolt-elements-item-contentDefault': !selected,\n        'bg-bolt-elements-item-backgroundAccent text-bolt-elements-item-contentAccent': selected,\n      })}\n      depth={depth}\n      iconClasses={classNames('i-ph:file-duotone scale-98', {\n        'group-hover:text-bolt-elements-item-contentActive': !selected,\n      })}\n      onClick={onClick}\n    >\n      <div\n        className={classNames('flex items-center', {\n          'group-hover:text-bolt-elements-item-contentActive': !selected,\n        })}\n      >\n        <div className=\"flex-1 truncate pr-2\">{name}</div>\n        {unsavedChanges && <span className=\"i-ph:circle-fill scale-68 shrink-0 text-orange-500\" />}\n      </div>\n    </NodeButton>\n  );\n}\n\ninterface ButtonProps {\n  depth: number;\n  iconClasses: string;\n  children: ReactNode;\n  className?: string;\n  onClick?: () => void;\n}\n\nfunction NodeButton({ depth, iconClasses, onClick, className, children }: ButtonProps) {\n  return (\n    <button\n      className={classNames(\n        'flex items-center gap-1.5 w-full pr-2 border-2 border-transparent text-faded py-0.5',\n        className,\n      )}\n      style={{ paddingLeft: `${6 + depth * NODE_PADDING_LEFT}px` }}\n      onClick={() => onClick?.()}\n    >\n      <div className={classNames('scale-120 shrink-0', iconClasses)}></div>\n      <div className=\"truncate w-full text-left\">{children}</div>\n    </button>\n  );\n}\n\ntype Node = FileNode | FolderNode;\n\ninterface BaseNode {\n  id: number;\n  depth: number;\n  name: string;\n  fullPath: string;\n}\n\ninterface FileNode extends BaseNode {\n  kind: 'file';\n}\n\ninterface FolderNode extends BaseNode {\n  kind: 'folder';\n}\n\nfunction buildFileList(\n  files: FileMap,\n  rootFolder = '/',\n  hideRoot: boolean,\n  hiddenFiles: Array<string | RegExp>,\n): Node[] {\n  const folderPaths = new Set<string>();\n  const fileList: Node[] = [];\n\n  let defaultDepth = 0;\n\n  if (rootFolder === '/' && !hideRoot) {\n    defaultDepth = 1;\n    fileList.push({ kind: 'folder', name: '/', depth: 0, id: 0, fullPath: '/' });\n  }\n\n  for (const [filePath, dirent] of Object.entries(files)) {\n    const segments = filePath.split('/').filter((segment) => segment);\n    const fileName = segments.at(-1);\n\n    if (!fileName || isHiddenFile(filePath, fileName, hiddenFiles)) {\n      continue;\n    }\n\n    let currentPath = '';\n\n    let i = 0;\n    let depth = 0;\n\n    while (i < segments.length) {\n      const name = segments[i];\n      const fullPath = (currentPath += `/${name}`);\n\n      if (!fullPath.startsWith(rootFolder) || (hideRoot && fullPath === rootFolder)) {\n        i++;\n        continue;\n      }\n\n      if (i === segments.length - 1 && dirent?.type === 'file') {\n        fileList.push({\n          kind: 'file',\n          id: fileList.length,\n          name,\n          fullPath,\n          depth: depth + defaultDepth,\n        });\n      } else if (!folderPaths.has(fullPath)) {\n        folderPaths.add(fullPath);\n\n        fileList.push({\n          kind: 'folder',\n          id: fileList.length,\n          name,\n          fullPath,\n          depth: depth + defaultDepth,\n        });\n      }\n\n      i++;\n      depth++;\n    }\n  }\n\n  return sortFileList(rootFolder, fileList, hideRoot);\n}\n\nfunction isHiddenFile(filePath: string, fileName: string, hiddenFiles: Array<string | RegExp>) {\n  return hiddenFiles.some((pathOrRegex) => {\n    if (typeof pathOrRegex === 'string') {\n      return fileName === pathOrRegex;\n    }\n\n    return pathOrRegex.test(filePath);\n  });\n}\n\n/**\n * Sorts the given list of nodes into a tree structure (still a flat list).\n *\n * This function organizes the nodes into a hierarchical structure based on their paths,\n * with folders appearing before files and all items sorted alphabetically within their level.\n *\n * @note This function mutates the given `nodeList` array for performance reasons.\n *\n * @param rootFolder - The path of the root folder to start the sorting from.\n * @param nodeList - The list of nodes to be sorted.\n *\n * @returns A new array of nodes sorted in depth-first order.\n */\nfunction sortFileList(rootFolder: string, nodeList: Node[], hideRoot: boolean): Node[] {\n  logger.trace('sortFileList');\n\n  const nodeMap = new Map<string, Node>();\n  const childrenMap = new Map<string, Node[]>();\n\n  // pre-sort nodes by name and type\n  nodeList.sort((a, b) => compareNodes(a, b));\n\n  for (const node of nodeList) {\n    nodeMap.set(node.fullPath, node);\n\n    const parentPath = node.fullPath.slice(0, node.fullPath.lastIndexOf('/'));\n\n    if (parentPath !== rootFolder.slice(0, rootFolder.lastIndexOf('/'))) {\n      if (!childrenMap.has(parentPath)) {\n        childrenMap.set(parentPath, []);\n      }\n\n      childrenMap.get(parentPath)?.push(node);\n    }\n  }\n\n  const sortedList: Node[] = [];\n\n  const depthFirstTraversal = (path: string): void => {\n    const node = nodeMap.get(path);\n\n    if (node) {\n      sortedList.push(node);\n    }\n\n    const children = childrenMap.get(path);\n\n    if (children) {\n      for (const child of children) {\n        if (child.kind === 'folder') {\n          depthFirstTraversal(child.fullPath);\n        } else {\n          sortedList.push(child);\n        }\n      }\n    }\n  };\n\n  if (hideRoot) {\n    // if root is hidden, start traversal from its immediate children\n    const rootChildren = childrenMap.get(rootFolder) || [];\n\n    for (const child of rootChildren) {\n      depthFirstTraversal(child.fullPath);\n    }\n  } else {\n    depthFirstTraversal(rootFolder);\n  }\n\n  return sortedList;\n}\n\nfunction compareNodes(a: Node, b: Node): number {\n  if (a.kind !== b.kind) {\n    return a.kind === 'folder' ? -1 : 1;\n  }\n\n  return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });\n}\n", "tag": "", "tokens": 3262, "metadata": {}}], "modify_time": 1733125234.623131}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/EditorPanel.tsx", "relative_path": "bolt.new/app/components/workbench/EditorPanel.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/EditorPanel.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport { memo, useEffect, useMemo, useRef, useState } from 'react';\nimport { Panel, PanelGroup, PanelResizeHandle, type ImperativePanelHandle } from 'react-resizable-panels';\nimport {\n  CodeMirrorEditor,\n  type EditorDocument,\n  type EditorSettings,\n  type OnChangeCallback as OnEditorChange,\n  type OnSaveCallback as OnEditorSave,\n  type OnScrollCallback as OnEditorScroll,\n} from '~/components/editor/codemirror/CodeMirrorEditor';\nimport { IconButton } from '~/components/ui/IconButton';\nimport { PanelHeader } from '~/components/ui/PanelHeader';\nimport { PanelHeaderButton } from '~/components/ui/PanelHeaderButton';\nimport { shortcutEventEmitter } from '~/lib/hooks';\nimport type { FileMap } from '~/lib/stores/files';\nimport { themeStore } from '~/lib/stores/theme';\nimport { workbenchStore } from '~/lib/stores/workbench';\nimport { classNames } from '~/utils/classNames';\nimport { WORK_DIR } from '~/utils/constants';\nimport { renderLogger } from '~/utils/logger';\nimport { isMobile } from '~/utils/mobile';\nimport { FileBreadcrumb } from './FileBreadcrumb';\nimport { FileTree } from './FileTree';\nimport { Terminal, type TerminalRef } from './terminal/Terminal';\n\ninterface EditorPanelProps {\n  files?: FileMap;\n  unsavedFiles?: Set<string>;\n  editorDocument?: EditorDocument;\n  selectedFile?: string | undefined;\n  isStreaming?: boolean;\n  onEditorChange?: OnEditorChange;\n  onEditorScroll?: OnEditorScroll;\n  onFileSelect?: (value?: string) => void;\n  onFileSave?: OnEditorSave;\n  onFileReset?: () => void;\n}\n\nconst MAX_TERMINALS = 3;\nconst DEFAULT_TERMINAL_SIZE = 25;\nconst DEFAULT_EDITOR_SIZE = 100 - DEFAULT_TERMINAL_SIZE;\n\nconst editorSettings: EditorSettings = { tabSize: 2 };\n\nexport const EditorPanel = memo(\n  ({\n    files,\n    unsavedFiles,\n    editorDocument,\n    selectedFile,\n    isStreaming,\n    onFileSelect,\n    onEditorChange,\n    onEditorScroll,\n    onFileSave,\n    onFileReset,\n  }: EditorPanelProps) => {\n    renderLogger.trace('EditorPanel');\n\n    const theme = useStore(themeStore);\n    const showTerminal = useStore(workbenchStore.showTerminal);\n\n    const terminalRefs = useRef<Array<TerminalRef | null>>([]);\n    const terminalPanelRef = useRef<ImperativePanelHandle>(null);\n    const terminalToggledByShortcut = useRef(false);\n\n    const [activeTerminal, setActiveTerminal] = useState(0);\n    const [terminalCount, setTerminalCount] = useState(1);\n\n    const activeFileSegments = useMemo(() => {\n      if (!editorDocument) {\n        return undefined;\n      }\n\n      return editorDocument.filePath.split('/');\n    }, [editorDocument]);\n\n    const activeFileUnsaved = useMemo(() => {\n      return editorDocument !== undefined && unsavedFiles?.has(editorDocument.filePath);\n    }, [editorDocument, unsavedFiles]);\n\n    useEffect(() => {\n      const unsubscribeFromEventEmitter = shortcutEventEmitter.on('toggleTerminal', () => {\n        terminalToggledByShortcut.current = true;\n      });\n\n      const unsubscribeFromThemeStore = themeStore.subscribe(() => {\n        for (const ref of Object.values(terminalRefs.current)) {\n          ref?.reloadStyles();\n        }\n      });\n\n      return () => {\n        unsubscribeFromEventEmitter();\n        unsubscribeFromThemeStore();\n      };\n    }, []);\n\n    useEffect(() => {\n      const { current: terminal } = terminalPanelRef;\n\n      if (!terminal) {\n        return;\n      }\n\n      const isCollapsed = terminal.isCollapsed();\n\n      if (!showTerminal && !isCollapsed) {\n        terminal.collapse();\n      } else if (showTerminal && isCollapsed) {\n        terminal.resize(DEFAULT_TERMINAL_SIZE);\n      }\n\n      terminalToggledByShortcut.current = false;\n    }, [showTerminal]);\n\n    const addTerminal = () => {\n      if (terminalCount < MAX_TERMINALS) {\n        setTerminalCount(terminalCount + 1);\n        setActiveTerminal(terminalCount);\n      }\n    };\n\n    return (\n      <PanelGroup direction=\"vertical\">\n        <Panel defaultSize={showTerminal ? DEFAULT_EDITOR_SIZE : 100} minSize={20}>\n          <PanelGroup direction=\"horizontal\">\n            <Panel defaultSize={20} minSize={10} collapsible>\n              <div className=\"flex flex-col border-r border-bolt-elements-borderColor h-full\">\n                <PanelHeader>\n                  <div className=\"i-ph:tree-structure-duotone shrink-0\" />\n                  Files\n                </PanelHeader>\n                <FileTree\n                  className=\"h-full\"\n                  files={files}\n                  hideRoot\n                  unsavedFiles={unsavedFiles}\n                  rootFolder={WORK_DIR}\n                  selectedFile={selectedFile}\n                  onFileSelect={onFileSelect}\n                />\n              </div>\n            </Panel>\n            <PanelResizeHandle />\n            <Panel className=\"flex flex-col\" defaultSize={80} minSize={20}>\n              <PanelHeader className=\"overflow-x-auto\">\n                {activeFileSegments?.length && (\n                  <div className=\"flex items-center flex-1 text-sm\">\n                    <FileBreadcrumb pathSegments={activeFileSegments} files={files} onFileSelect={onFileSelect} />\n                    {activeFileUnsaved && (\n                      <div className=\"flex gap-1 ml-auto -mr-1.5\">\n                        <PanelHeaderButton onClick={onFileSave}>\n                          <div className=\"i-ph:floppy-disk-duotone\" />\n                          Save\n                        </PanelHeaderButton>\n                        <PanelHeaderButton onClick={onFileReset}>\n                          <div className=\"i-ph:clock-counter-clockwise-duotone\" />\n                          Reset\n                        </PanelHeaderButton>\n                      </div>\n                    )}\n                  </div>\n                )}\n              </PanelHeader>\n              <div className=\"h-full flex-1 overflow-hidden\">\n                <CodeMirrorEditor\n                  theme={theme}\n                  editable={!isStreaming && editorDocument !== undefined}\n                  settings={editorSettings}\n                  doc={editorDocument}\n                  autoFocusOnDocumentChange={!isMobile()}\n                  onScroll={onEditorScroll}\n                  onChange={onEditorChange}\n                  onSave={onFileSave}\n                />\n              </div>\n            </Panel>\n          </PanelGroup>\n        </Panel>\n        <PanelResizeHandle />\n        <Panel\n          ref={terminalPanelRef}\n          defaultSize={showTerminal ? DEFAULT_TERMINAL_SIZE : 0}\n          minSize={10}\n          collapsible\n          onExpand={() => {\n            if (!terminalToggledByShortcut.current) {\n              workbenchStore.toggleTerminal(true);\n            }\n          }}\n          onCollapse={() => {\n            if (!terminalToggledByShortcut.current) {\n              workbenchStore.toggleTerminal(false);\n            }\n          }}\n        >\n          <div className=\"h-full\">\n            <div className=\"bg-bolt-elements-terminals-background h-full flex flex-col\">\n              <div className=\"flex items-center bg-bolt-elements-background-depth-2 border-y border-bolt-elements-borderColor gap-1.5 min-h-[34px] p-2\">\n                {Array.from({ length: terminalCount }, (_, index) => {\n                  const isActive = activeTerminal === index;\n\n                  return (\n                    <button\n                      key={index}\n                      className={classNames(\n                        'flex items-center text-sm cursor-pointer gap-1.5 px-3 py-2 h-full whitespace-nowrap rounded-full',\n                        {\n                          'bg-bolt-elements-terminals-buttonBackground text-bolt-elements-textPrimary': isActive,\n                          'bg-bolt-elements-background-depth-2 text-bolt-elements-textSecondary hover:bg-bolt-elements-terminals-buttonBackground':\n                            !isActive,\n                        },\n                      )}\n                      onClick={() => setActiveTerminal(index)}\n                    >\n                      <div className=\"i-ph:terminal-window-duotone text-lg\" />\n                      Terminal {terminalCount > 1 && index + 1}\n                    </button>\n                  );\n                })}\n                {terminalCount < MAX_TERMINALS && <IconButton icon=\"i-ph:plus\" size=\"md\" onClick={addTerminal} />}\n                <IconButton\n                  className=\"ml-auto\"\n                  icon=\"i-ph:caret-down\"\n                  title=\"Close\"\n                  size=\"md\"\n                  onClick={() => workbenchStore.toggleTerminal(false)}\n                />\n              </div>\n              {Array.from({ length: terminalCount }, (_, index) => {\n                const isActive = activeTerminal === index;\n\n                return (\n                  <Terminal\n                    key={index}\n                    className={classNames('h-full overflow-hidden', {\n                      hidden: !isActive,\n                    })}\n                    ref={(ref) => {\n                      terminalRefs.current.push(ref);\n                    }}\n                    onTerminalReady={(terminal) => workbenchStore.attachTerminal(terminal)}\n                    onTerminalResize={(cols, rows) => workbenchStore.onTerminalResize(cols, rows)}\n                    theme={theme}\n                  />\n                );\n              })}\n            </div>\n          </div>\n        </Panel>\n      </PanelGroup>\n    );\n  },\n);\n", "tag": "", "tokens": 2361, "metadata": {}}], "modify_time": 1733125234.6228192}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/FileBreadcrumb.tsx", "relative_path": "bolt.new/app/components/workbench/FileBreadcrumb.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/FileBreadcrumb.tsx", "source_code": "import * as DropdownMenu from '@radix-ui/react-dropdown-menu';\nimport { AnimatePresence, motion, type Variants } from 'framer-motion';\nimport { memo, useEffect, useRef, useState } from 'react';\nimport type { FileMap } from '~/lib/stores/files';\nimport { classNames } from '~/utils/classNames';\nimport { WORK_DIR } from '~/utils/constants';\nimport { cubicEasingFn } from '~/utils/easings';\nimport { renderLogger } from '~/utils/logger';\nimport FileTree from './FileTree';\n\nconst WORK_DIR_REGEX = new RegExp(`^${WORK_DIR.split('/').slice(0, -1).join('/').replaceAll('/', '\\\\/')}/`);\n\ninterface FileBreadcrumbProps {\n  files?: FileMap;\n  pathSegments?: string[];\n  onFileSelect?: (filePath: string) => void;\n}\n\nconst contextMenuVariants = {\n  open: {\n    y: 0,\n    opacity: 1,\n    transition: {\n      duration: 0.15,\n      ease: cubicEasingFn,\n    },\n  },\n  close: {\n    y: 6,\n    opacity: 0,\n    transition: {\n      duration: 0.15,\n      ease: cubicEasingFn,\n    },\n  },\n} satisfies Variants;\n\nexport const FileBreadcrumb = memo<FileBreadcrumbProps>(({ files, pathSegments = [], onFileSelect }) => {\n  renderLogger.trace('FileBreadcrumb');\n\n  const [activeIndex, setActiveIndex] = useState<number | null>(null);\n\n  const contextMenuRef = useRef<HTMLDivElement | null>(null);\n  const segmentRefs = useRef<(HTMLSpanElement | null)[]>([]);\n\n  const handleSegmentClick = (index: number) => {\n    setActiveIndex((prevIndex) => (prevIndex === index ? null : index));\n  };\n\n  useEffect(() => {\n    const handleOutsideClick = (event: MouseEvent) => {\n      if (\n        activeIndex !== null &&\n        !contextMenuRef.current?.contains(event.target as Node) &&\n        !segmentRefs.current.some((ref) => ref?.contains(event.target as Node))\n      ) {\n        setActiveIndex(null);\n      }\n    };\n\n    document.addEventListener('mousedown', handleOutsideClick);\n\n    return () => {\n      document.removeEventListener('mousedown', handleOutsideClick);\n    };\n  }, [activeIndex]);\n\n  if (files === undefined || pathSegments.length === 0) {\n    return null;\n  }\n\n  return (\n    <div className=\"flex\">\n      {pathSegments.map((segment, index) => {\n        const isLast = index === pathSegments.length - 1;\n\n        const path = pathSegments.slice(0, index).join('/');\n\n        if (!WORK_DIR_REGEX.test(path)) {\n          return null;\n        }\n\n        const isActive = activeIndex === index;\n\n        return (\n          <div key={index} className=\"relative flex items-center\">\n            <DropdownMenu.Root open={isActive} modal={false}>\n              <DropdownMenu.Trigger asChild>\n                <span\n                  ref={(ref) => (segmentRefs.current[index] = ref)}\n                  className={classNames('flex items-center gap-1.5 cursor-pointer shrink-0', {\n                    'text-bolt-elements-textTertiary hover:text-bolt-elements-textPrimary': !isActive,\n                    'text-bolt-elements-textPrimary underline': isActive,\n                    'pr-4': isLast,\n                  })}\n                  onClick={() => handleSegmentClick(index)}\n                >\n                  {isLast && <div className=\"i-ph:file-duotone\" />}\n                  {segment}\n                </span>\n              </DropdownMenu.Trigger>\n              {index > 0 && !isLast && <span className=\"i-ph:caret-right inline-block mx-1\" />}\n              <AnimatePresence>\n                {isActive && (\n                  <DropdownMenu.Portal>\n                    <DropdownMenu.Content\n                      className=\"z-file-tree-breadcrumb\"\n                      asChild\n                      align=\"start\"\n                      side=\"bottom\"\n                      avoidCollisions={false}\n                    >\n                      <motion.div\n                        ref={contextMenuRef}\n                        initial=\"close\"\n                        animate=\"open\"\n                        exit=\"close\"\n                        variants={contextMenuVariants}\n                      >\n                        <div className=\"rounded-lg overflow-hidden\">\n                          <div className=\"max-h-[50vh] min-w-[300px] overflow-scroll bg-bolt-elements-background-depth-1 border border-bolt-elements-borderColor shadow-sm rounded-lg\">\n                            <FileTree\n                              files={files}\n                              hideRoot\n                              rootFolder={path}\n                              collapsed\n                              allowFolderSelection\n                              selectedFile={`${path}/${segment}`}\n                              onFileSelect={(filePath) => {\n                                setActiveIndex(null);\n                                onFileSelect?.(filePath);\n                              }}\n                            />\n                          </div>\n                        </div>\n                        <DropdownMenu.Arrow className=\"fill-bolt-elements-borderColor\" />\n                      </motion.div>\n                    </DropdownMenu.Content>\n                  </DropdownMenu.Portal>\n                )}\n              </AnimatePresence>\n            </DropdownMenu.Root>\n          </div>\n        );\n      })}\n    </div>\n  );\n});\n", "tag": "", "tokens": 1322, "metadata": {}}], "modify_time": 1733125234.6229734}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/PortDropdown.tsx", "relative_path": "bolt.new/app/components/workbench/PortDropdown.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/PortDropdown.tsx", "source_code": "import { memo, useEffect, useRef } from 'react';\nimport { IconButton } from '~/components/ui/IconButton';\nimport type { PreviewInfo } from '~/lib/stores/previews';\n\ninterface PortDropdownProps {\n  activePreviewIndex: number;\n  setActivePreviewIndex: (index: number) => void;\n  isDropdownOpen: boolean;\n  setIsDropdownOpen: (value: boolean) => void;\n  setHasSelectedPreview: (value: boolean) => void;\n  previews: PreviewInfo[];\n}\n\nexport const PortDropdown = memo(\n  ({\n    activePreviewIndex,\n    setActivePreviewIndex,\n    isDropdownOpen,\n    setIsDropdownOpen,\n    setHasSelectedPreview,\n    previews,\n  }: PortDropdownProps) => {\n    const dropdownRef = useRef<HTMLDivElement>(null);\n\n    // sort previews, preserving original index\n    const sortedPreviews = previews\n      .map((previewInfo, index) => ({ ...previewInfo, index }))\n      .sort((a, b) => a.port - b.port);\n\n    // close dropdown if user clicks outside\n    useEffect(() => {\n      const handleClickOutside = (event: MouseEvent) => {\n        if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\n          setIsDropdownOpen(false);\n        }\n      };\n\n      if (isDropdownOpen) {\n        window.addEventListener('mousedown', handleClickOutside);\n      } else {\n        window.removeEventListener('mousedown', handleClickOutside);\n      }\n\n      return () => {\n        window.removeEventListener('mousedown', handleClickOutside);\n      };\n    }, [isDropdownOpen]);\n\n    return (\n      <div className=\"relative z-port-dropdown\" ref={dropdownRef}>\n        <IconButton icon=\"i-ph:plug\" onClick={() => setIsDropdownOpen(!isDropdownOpen)} />\n        {isDropdownOpen && (\n          <div className=\"absolute right-0 mt-2 bg-bolt-elements-background-depth-2 border border-bolt-elements-borderColor rounded shadow-sm min-w-[140px] dropdown-animation\">\n            <div className=\"px-4 py-2 border-b border-bolt-elements-borderColor text-sm font-semibold text-bolt-elements-textPrimary\">\n              Ports\n            </div>\n            {sortedPreviews.map((preview) => (\n              <div\n                key={preview.port}\n                className=\"flex items-center px-4 py-2 cursor-pointer hover:bg-bolt-elements-item-backgroundActive\"\n                onClick={() => {\n                  setActivePreviewIndex(preview.index);\n                  setIsDropdownOpen(false);\n                  setHasSelectedPreview(true);\n                }}\n              >\n                <span\n                  className={\n                    activePreviewIndex === preview.index\n                      ? 'text-bolt-elements-item-contentAccent'\n                      : 'text-bolt-elements-item-contentDefault group-hover:text-bolt-elements-item-contentActive'\n                  }\n                >\n                  {preview.port}\n                </span>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    );\n  },\n);\n", "tag": "", "tokens": 770, "metadata": {}}], "modify_time": 1733125234.62325}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/terminal/Terminal.tsx", "relative_path": "bolt.new/app/components/workbench/terminal/Terminal.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/terminal/Terminal.tsx", "source_code": "import { FitAddon } from '@xterm/addon-fit';\nimport { WebLinksAddon } from '@xterm/addon-web-links';\nimport { Terminal as XTerm } from '@xterm/xterm';\nimport { forwardRef, memo, useEffect, useImperativeHandle, useRef } from 'react';\nimport type { Theme } from '~/lib/stores/theme';\nimport { createScopedLogger } from '~/utils/logger';\nimport { getTerminalTheme } from './theme';\n\nconst logger = createScopedLogger('Terminal');\n\nexport interface TerminalRef {\n  reloadStyles: () => void;\n}\n\nexport interface TerminalProps {\n  className?: string;\n  theme: Theme;\n  readonly?: boolean;\n  onTerminalReady?: (terminal: XTerm) => void;\n  onTerminalResize?: (cols: number, rows: number) => void;\n}\n\nexport const Terminal = memo(\n  forwardRef<TerminalRef, TerminalProps>(({ className, theme, readonly, onTerminalReady, onTerminalResize }, ref) => {\n    const terminalElementRef = useRef<HTMLDivElement>(null);\n    const terminalRef = useRef<XTerm>();\n\n    useEffect(() => {\n      const element = terminalElementRef.current!;\n\n      const fitAddon = new FitAddon();\n      const webLinksAddon = new WebLinksAddon();\n\n      const terminal = new XTerm({\n        cursorBlink: true,\n        convertEol: true,\n        disableStdin: readonly,\n        theme: getTerminalTheme(readonly ? { cursor: '#00000000' } : {}),\n        fontSize: 12,\n        fontFamily: 'Menlo, courier-new, courier, monospace',\n      });\n\n      terminalRef.current = terminal;\n\n      terminal.loadAddon(fitAddon);\n      terminal.loadAddon(webLinksAddon);\n      terminal.open(element);\n\n      const resizeObserver = new ResizeObserver(() => {\n        fitAddon.fit();\n        onTerminalResize?.(terminal.cols, terminal.rows);\n      });\n\n      resizeObserver.observe(element);\n\n      logger.info('Attach terminal');\n\n      onTerminalReady?.(terminal);\n\n      return () => {\n        resizeObserver.disconnect();\n        terminal.dispose();\n      };\n    }, []);\n\n    useEffect(() => {\n      const terminal = terminalRef.current!;\n\n      // we render a transparent cursor in case the terminal is readonly\n      terminal.options.theme = getTerminalTheme(readonly ? { cursor: '#00000000' } : {});\n\n      terminal.options.disableStdin = readonly;\n    }, [theme, readonly]);\n\n    useImperativeHandle(ref, () => {\n      return {\n        reloadStyles: () => {\n          const terminal = terminalRef.current!;\n          terminal.options.theme = getTerminalTheme(readonly ? { cursor: '#00000000' } : {});\n        },\n      };\n    }, []);\n\n    return <div className={className} ref={terminalElementRef} />;\n  }),\n);\n", "tag": "", "tokens": 741, "metadata": {}}], "modify_time": 1733125234.6236947}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/terminal/theme.ts", "relative_path": "bolt.new/app/components/workbench/terminal/theme.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/workbench/terminal/theme.ts", "source_code": "import type { ITheme } from '@xterm/xterm';\n\nconst style = getComputedStyle(document.documentElement);\nconst cssVar = (token: string) => style.getPropertyValue(token) || undefined;\n\nexport function getTerminalTheme(overrides?: ITheme): ITheme {\n  return {\n    cursor: cssVar('--bolt-elements-terminal-cursorColor'),\n    cursorAccent: cssVar('--bolt-elements-terminal-cursorColorAccent'),\n    foreground: cssVar('--bolt-elements-terminal-textColor'),\n    background: cssVar('--bolt-elements-terminal-backgroundColor'),\n    selectionBackground: cssVar('--bolt-elements-terminal-selection-backgroundColor'),\n    selectionForeground: cssVar('--bolt-elements-terminal-selection-textColor'),\n    selectionInactiveBackground: cssVar('--bolt-elements-terminal-selection-backgroundColorInactive'),\n\n    // ansi escape code colors\n    black: cssVar('--bolt-elements-terminal-color-black'),\n    red: cssVar('--bolt-elements-terminal-color-red'),\n    green: cssVar('--bolt-elements-terminal-color-green'),\n    yellow: cssVar('--bolt-elements-terminal-color-yellow'),\n    blue: cssVar('--bolt-elements-terminal-color-blue'),\n    magenta: cssVar('--bolt-elements-terminal-color-magenta'),\n    cyan: cssVar('--bolt-elements-terminal-color-cyan'),\n    white: cssVar('--bolt-elements-terminal-color-white'),\n    brightBlack: cssVar('--bolt-elements-terminal-color-brightBlack'),\n    brightRed: cssVar('--bolt-elements-terminal-color-brightRed'),\n    brightGreen: cssVar('--bolt-elements-terminal-color-brightGreen'),\n    brightYellow: cssVar('--bolt-elements-terminal-color-brightYellow'),\n    brightBlue: cssVar('--bolt-elements-terminal-color-brightBlue'),\n    brightMagenta: cssVar('--bolt-elements-terminal-color-brightMagenta'),\n    brightCyan: cssVar('--bolt-elements-terminal-color-brightCyan'),\n    brightWhite: cssVar('--bolt-elements-terminal-color-brightWhite'),\n\n    ...overrides,\n  };\n}\n", "tag": "", "tokens": 514, "metadata": {}}], "modify_time": 1733125234.623815}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/header/HeaderActionButtons.client.tsx", "relative_path": "bolt.new/app/components/header/HeaderActionButtons.client.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/header/HeaderActionButtons.client.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport { chatStore } from '~/lib/stores/chat';\nimport { workbenchStore } from '~/lib/stores/workbench';\nimport { classNames } from '~/utils/classNames';\n\ninterface HeaderActionButtonsProps {}\n\nexport function HeaderActionButtons({}: HeaderActionButtonsProps) {\n  const showWorkbench = useStore(workbenchStore.showWorkbench);\n  const { showChat } = useStore(chatStore);\n\n  const canHideChat = showWorkbench || !showChat;\n\n  return (\n    <div className=\"flex\">\n      <div className=\"flex border border-bolt-elements-borderColor rounded-md overflow-hidden\">\n        <Button\n          active={showChat}\n          disabled={!canHideChat}\n          onClick={() => {\n            if (canHideChat) {\n              chatStore.setKey('showChat', !showChat);\n            }\n          }}\n        >\n          <div className=\"i-bolt:chat text-sm\" />\n        </Button>\n        <div className=\"w-[1px] bg-bolt-elements-borderColor\" />\n        <Button\n          active={showWorkbench}\n          onClick={() => {\n            if (showWorkbench && !showChat) {\n              chatStore.setKey('showChat', true);\n            }\n\n            workbenchStore.showWorkbench.set(!showWorkbench);\n          }}\n        >\n          <div className=\"i-ph:code-bold\" />\n        </Button>\n      </div>\n    </div>\n  );\n}\n\ninterface ButtonProps {\n  active?: boolean;\n  disabled?: boolean;\n  children?: any;\n  onClick?: VoidFunction;\n}\n\nfunction Button({ active = false, disabled = false, children, onClick }: ButtonProps) {\n  return (\n    <button\n      className={classNames('flex items-center p-1.5', {\n        'bg-bolt-elements-item-backgroundDefault hover:bg-bolt-elements-item-backgroundActive text-bolt-elements-textTertiary hover:text-bolt-elements-textPrimary':\n          !active,\n        'bg-bolt-elements-item-backgroundAccent text-bolt-elements-item-contentAccent': active && !disabled,\n        'bg-bolt-elements-item-backgroundDefault text-alpha-gray-20 dark:text-alpha-white-20 cursor-not-allowed':\n          disabled,\n      })}\n      onClick={onClick}\n    >\n      {children}\n    </button>\n  );\n}\n", "tag": "", "tokens": 612, "metadata": {}}], "modify_time": 1733125234.6212912}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/header/Header.tsx", "relative_path": "bolt.new/app/components/header/Header.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/header/Header.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport { ClientOnly } from 'remix-utils/client-only';\nimport { chatStore } from '~/lib/stores/chat';\nimport { classNames } from '~/utils/classNames';\nimport { HeaderActionButtons } from './HeaderActionButtons.client';\nimport { ChatDescription } from '~/lib/persistence/ChatDescription.client';\n\nexport function Header() {\n  const chat = useStore(chatStore);\n\n  return (\n    <header\n      className={classNames(\n        'flex items-center bg-bolt-elements-background-depth-1 p-5 border-b h-[var(--header-height)]',\n        {\n          'border-transparent': !chat.started,\n          'border-bolt-elements-borderColor': chat.started,\n        },\n      )}\n    >\n      <div className=\"flex items-center gap-2 z-logo text-bolt-elements-textPrimary cursor-pointer\">\n        <div className=\"i-ph:sidebar-simple-duotone text-xl\" />\n        <a href=\"/\" className=\"text-2xl font-semibold text-accent flex items-center\">\n          <span className=\"i-bolt:logo-text?mask w-[46px] inline-block\" />\n        </a>\n      </div>\n      <span className=\"flex-1 px-4 truncate text-center text-bolt-elements-textPrimary\">\n        <ClientOnly>{() => <ChatDescription />}</ClientOnly>\n      </span>\n      {chat.started && (\n        <ClientOnly>\n          {() => (\n            <div className=\"mr-1\">\n              <HeaderActionButtons />\n            </div>\n          )}\n        </ClientOnly>\n      )}\n    </header>\n  );\n}\n", "tag": "", "tokens": 430, "metadata": {}}], "modify_time": 1733125234.6211464}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/languages.ts", "relative_path": "bolt.new/app/components/editor/codemirror/languages.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/languages.ts", "source_code": "import { LanguageDescription } from '@codemirror/language';\n\nexport const supportedLanguages = [\n  LanguageDescription.of({\n    name: 'TS',\n    extensions: ['ts'],\n    async load() {\n      return import('@codemirror/lang-javascript').then((module) => module.javascript({ typescript: true }));\n    },\n  }),\n  LanguageDescription.of({\n    name: 'JS',\n    extensions: ['js', 'mjs', 'cjs'],\n    async load() {\n      return import('@codemirror/lang-javascript').then((module) => module.javascript());\n    },\n  }),\n  LanguageDescription.of({\n    name: 'TSX',\n    extensions: ['tsx'],\n    async load() {\n      return import('@codemirror/lang-javascript').then((module) => module.javascript({ jsx: true, typescript: true }));\n    },\n  }),\n  LanguageDescription.of({\n    name: 'JSX',\n    extensions: ['jsx'],\n    async load() {\n      return import('@codemirror/lang-javascript').then((module) => module.javascript({ jsx: true }));\n    },\n  }),\n  LanguageDescription.of({\n    name: 'HTML',\n    extensions: ['html'],\n    async load() {\n      return import('@codemirror/lang-html').then((module) => module.html());\n    },\n  }),\n  LanguageDescription.of({\n    name: 'CSS',\n    extensions: ['css'],\n    async load() {\n      return import('@codemirror/lang-css').then((module) => module.css());\n    },\n  }),\n  LanguageDescription.of({\n    name: 'SASS',\n    extensions: ['sass'],\n    async load() {\n      return import('@codemirror/lang-sass').then((module) => module.sass({ indented: true }));\n    },\n  }),\n  LanguageDescription.of({\n    name: 'SCSS',\n    extensions: ['scss'],\n    async load() {\n      return import('@codemirror/lang-sass').then((module) => module.sass({ indented: false }));\n    },\n  }),\n  LanguageDescription.of({\n    name: 'JSON',\n    extensions: ['json'],\n    async load() {\n      return import('@codemirror/lang-json').then((module) => module.json());\n    },\n  }),\n  LanguageDescription.of({\n    name: 'Markdown',\n    extensions: ['md'],\n    async load() {\n      return import('@codemirror/lang-markdown').then((module) => module.markdown());\n    },\n  }),\n  LanguageDescription.of({\n    name: 'Wasm',\n    extensions: ['wat'],\n    async load() {\n      return import('@codemirror/lang-wast').then((module) => module.wast());\n    },\n  }),\n  LanguageDescription.of({\n    name: 'Python',\n    extensions: ['py'],\n    async load() {\n      return import('@codemirror/lang-python').then((module) => module.python());\n    },\n  }),\n  LanguageDescription.of({\n    name: 'C++',\n    extensions: ['cpp'],\n    async load() {\n      return import('@codemirror/lang-cpp').then((module) => module.cpp());\n    },\n  }),\n];\n\nexport async function getLanguage(fileName: string) {\n  const languageDescription = LanguageDescription.matchFilename(supportedLanguages, fileName);\n\n  if (languageDescription) {\n    return await languageDescription.load();\n  }\n\n  return undefined;\n}\n", "tag": "", "tokens": 863, "metadata": {}}], "modify_time": 1733125234.620967}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/BinaryContent.tsx", "relative_path": "bolt.new/app/components/editor/codemirror/BinaryContent.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/BinaryContent.tsx", "source_code": "export function BinaryContent() {\n  return (\n    <div className=\"flex items-center justify-center absolute inset-0 z-10 text-sm bg-tk-elements-app-backgroundColor text-tk-elements-app-textColor\">\n      File format cannot be displayed.\n    </div>\n  );\n}\n", "tag": "", "tokens": 80, "metadata": {}}], "modify_time": 1733125234.620394}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/indent.ts", "relative_path": "bolt.new/app/components/editor/codemirror/indent.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/indent.ts", "source_code": "import { indentLess } from '@codemirror/commands';\nimport { indentUnit } from '@codemirror/language';\nimport { EditorSelection, EditorState, Line, type ChangeSpec } from '@codemirror/state';\nimport { EditorView, type KeyBinding } from '@codemirror/view';\n\nexport const indentKeyBinding: KeyBinding = {\n  key: 'Tab',\n  run: indentMore,\n  shift: indentLess,\n};\n\nfunction indentMore({ state, dispatch }: EditorView) {\n  if (state.readOnly) {\n    return false;\n  }\n\n  dispatch(\n    state.update(\n      changeBySelectedLine(state, (from, to, changes) => {\n        changes.push({ from, to, insert: state.facet(indentUnit) });\n      }),\n      { userEvent: 'input.indent' },\n    ),\n  );\n\n  return true;\n}\n\nfunction changeBySelectedLine(\n  state: EditorState,\n  cb: (from: number, to: number | undefined, changes: ChangeSpec[], line: Line) => void,\n) {\n  return state.changeByRange((range) => {\n    const changes: ChangeSpec[] = [];\n\n    const line = state.doc.lineAt(range.from);\n\n    // just insert single indent unit at the current cursor position\n    if (range.from === range.to) {\n      cb(range.from, undefined, changes, line);\n    }\n    // handle the case when multiple characters are selected in a single line\n    else if (range.from < range.to && range.to <= line.to) {\n      cb(range.from, range.to, changes, line);\n    } else {\n      let atLine = -1;\n\n      // handle the case when selection spans multiple lines\n      for (let pos = range.from; pos <= range.to; ) {\n        const line = state.doc.lineAt(pos);\n\n        if (line.number > atLine && (range.empty || range.to > line.from)) {\n          cb(line.from, undefined, changes, line);\n          atLine = line.number;\n        }\n\n        pos = line.to + 1;\n      }\n    }\n\n    const changeSet = state.changes(changes);\n\n    return {\n      changes,\n      range: EditorSelection.range(changeSet.mapPos(range.anchor, 1), changeSet.mapPos(range.head, 1)),\n    };\n  });\n}\n", "tag": "", "tokens": 599, "metadata": {}}], "modify_time": 1733125234.620848}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/CodeMirrorEditor.tsx", "relative_path": "bolt.new/app/components/editor/codemirror/CodeMirrorEditor.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/CodeMirrorEditor.tsx", "source_code": "import { acceptCompletion, autocompletion, closeBrackets } from '@codemirror/autocomplete';\nimport { defaultKeymap, history, historyKeymap } from '@codemirror/commands';\nimport { bracketMatching, foldGutter, indentOnInput, indentUnit } from '@codemirror/language';\nimport { searchKeymap } from '@codemirror/search';\nimport { Compartment, EditorSelection, EditorState, StateEffect, StateField, type Extension } from '@codemirror/state';\nimport {\n  drawSelection,\n  dropCursor,\n  EditorView,\n  highlightActiveLine,\n  highlightActiveLineGutter,\n  keymap,\n  lineNumbers,\n  scrollPastEnd,\n  showTooltip,\n  tooltips,\n  type Tooltip,\n} from '@codemirror/view';\nimport { memo, useEffect, useRef, useState, type MutableRefObject } from 'react';\nimport type { Theme } from '~/types/theme';\nimport { classNames } from '~/utils/classNames';\nimport { debounce } from '~/utils/debounce';\nimport { createScopedLogger, renderLogger } from '~/utils/logger';\nimport { BinaryContent } from './BinaryContent';\nimport { getTheme, reconfigureTheme } from './cm-theme';\nimport { indentKeyBinding } from './indent';\nimport { getLanguage } from './languages';\n\nconst logger = createScopedLogger('CodeMirrorEditor');\n\nexport interface EditorDocument {\n  value: string;\n  isBinary: boolean;\n  filePath: string;\n  scroll?: ScrollPosition;\n}\n\nexport interface EditorSettings {\n  fontSize?: string;\n  gutterFontSize?: string;\n  tabSize?: number;\n}\n\ntype TextEditorDocument = EditorDocument & {\n  value: string;\n};\n\nexport interface ScrollPosition {\n  top: number;\n  left: number;\n}\n\nexport interface EditorUpdate {\n  selection: EditorSelection;\n  content: string;\n}\n\nexport type OnChangeCallback = (update: EditorUpdate) => void;\nexport type OnScrollCallback = (position: ScrollPosition) => void;\nexport type OnSaveCallback = () => void;\n\ninterface Props {\n  theme: Theme;\n  id?: unknown;\n  doc?: EditorDocument;\n  editable?: boolean;\n  debounceChange?: number;\n  debounceScroll?: number;\n  autoFocusOnDocumentChange?: boolean;\n  onChange?: OnChangeCallback;\n  onScroll?: OnScrollCallback;\n  onSave?: OnSaveCallback;\n  className?: string;\n  settings?: EditorSettings;\n}\n\ntype EditorStates = Map<string, EditorState>;\n\nconst readOnlyTooltipStateEffect = StateEffect.define<boolean>();\n\nconst editableTooltipField = StateField.define<readonly Tooltip[]>({\n  create: () => [],\n  update(_tooltips, transaction) {\n    if (!transaction.state.readOnly) {\n      return [];\n    }\n\n    for (const effect of transaction.effects) {\n      if (effect.is(readOnlyTooltipStateEffect) && effect.value) {\n        return getReadOnlyTooltip(transaction.state);\n      }\n    }\n\n    return [];\n  },\n  provide: (field) => {\n    return showTooltip.computeN([field], (state) => state.field(field));\n  },\n});\n\nconst editableStateEffect = StateEffect.define<boolean>();\n\nconst editableStateField = StateField.define<boolean>({\n  create() {\n    return true;\n  },\n  update(value, transaction) {\n    for (const effect of transaction.effects) {\n      if (effect.is(editableStateEffect)) {\n        return effect.value;\n      }\n    }\n\n    return value;\n  },\n});\n\nexport const CodeMirrorEditor = memo(\n  ({\n    id,\n    doc,\n    debounceScroll = 100,\n    debounceChange = 150,\n    autoFocusOnDocumentChange = false,\n    editable = true,\n    onScroll,\n    onChange,\n    onSave,\n    theme,\n    settings,\n    className = '',\n  }: Props) => {\n    renderLogger.trace('CodeMirrorEditor');\n\n    const [languageCompartment] = useState(new Compartment());\n\n    const containerRef = useRef<HTMLDivElement | null>(null);\n    const viewRef = useRef<EditorView>();\n    const themeRef = useRef<Theme>();\n    const docRef = useRef<EditorDocument>();\n    const editorStatesRef = useRef<EditorStates>();\n    const onScrollRef = useRef(onScroll);\n    const onChangeRef = useRef(onChange);\n    const onSaveRef = useRef(onSave);\n\n    /**\n     * This effect is used to avoid side effects directly in the render function\n     * and instead the refs are updated after each render.\n     */\n    useEffect(() => {\n      onScrollRef.current = onScroll;\n      onChangeRef.current = onChange;\n      onSaveRef.current = onSave;\n      docRef.current = doc;\n      themeRef.current = theme;\n    });\n\n    useEffect(() => {\n      const onUpdate = debounce((update: EditorUpdate) => {\n        onChangeRef.current?.(update);\n      }, debounceChange);\n\n      const view = new EditorView({\n        parent: containerRef.current!,\n        dispatchTransactions(transactions) {\n          const previousSelection = view.state.selection;\n\n          view.update(transactions);\n\n          const newSelection = view.state.selection;\n\n          const selectionChanged =\n            newSelection !== previousSelection &&\n            (newSelection === undefined || previousSelection === undefined || !newSelection.eq(previousSelection));\n\n          if (docRef.current && (transactions.some((transaction) => transaction.docChanged) || selectionChanged)) {\n            onUpdate({\n              selection: view.state.selection,\n              content: view.state.doc.toString(),\n            });\n\n            editorStatesRef.current!.set(docRef.current.filePath, view.state);\n          }\n        },\n      });\n\n      viewRef.current = view;\n\n      return () => {\n        viewRef.current?.destroy();\n        viewRef.current = undefined;\n      };\n    }, []);\n\n    useEffect(() => {\n      if (!viewRef.current) {\n        return;\n      }\n\n      viewRef.current.dispatch({\n        effects: [reconfigureTheme(theme)],\n      });\n    }, [theme]);\n\n    useEffect(() => {\n      editorStatesRef.current = new Map<string, EditorState>();\n    }, [id]);\n\n    useEffect(() => {\n      const editorStates = editorStatesRef.current!;\n      const view = viewRef.current!;\n      const theme = themeRef.current!;\n\n      if (!doc) {\n        const state = newEditorState('', theme, settings, onScrollRef, debounceScroll, onSaveRef, [\n          languageCompartment.of([]),\n        ]);\n\n        view.setState(state);\n\n        setNoDocument(view);\n\n        return;\n      }\n\n      if (doc.isBinary) {\n        return;\n      }\n\n      if (doc.filePath === '') {\n        logger.warn('File path should not be empty');\n      }\n\n      let state = editorStates.get(doc.filePath);\n\n      if (!state) {\n        state = newEditorState(doc.value, theme, settings, onScrollRef, debounceScroll, onSaveRef, [\n          languageCompartment.of([]),\n        ]);\n\n        editorStates.set(doc.filePath, state);\n      }\n\n      view.setState(state);\n\n      setEditorDocument(\n        view,\n        theme,\n        editable,\n        languageCompartment,\n        autoFocusOnDocumentChange,\n        doc as TextEditorDocument,\n      );\n    }, [doc?.value, editable, doc?.filePath, autoFocusOnDocumentChange]);\n\n    return (\n      <div className={classNames('relative h-full', className)}>\n        {doc?.isBinary && <BinaryContent />}\n        <div className=\"h-full overflow-hidden\" ref={containerRef} />\n      </div>\n    );\n  },\n);\n\nexport default CodeMirrorEditor;\n\nCodeMirrorEditor.displayName = 'CodeMirrorEditor';\n\nfunction newEditorState(\n  content: string,\n  theme: Theme,\n  settings: EditorSettings | undefined,\n  onScrollRef: MutableRefObject<OnScrollCallback | undefined>,\n  debounceScroll: number,\n  onFileSaveRef: MutableRefObject<OnSaveCallback | undefined>,\n  extensions: Extension[],\n) {\n  return EditorState.create({\n    doc: content,\n    extensions: [\n      EditorView.domEventHandlers({\n        scroll: debounce((event, view) => {\n          if (event.target !== view.scrollDOM) {\n            return;\n          }\n\n          onScrollRef.current?.({ left: view.scrollDOM.scrollLeft, top: view.scrollDOM.scrollTop });\n        }, debounceScroll),\n        keydown: (event, view) => {\n          if (view.state.readOnly) {\n            view.dispatch({\n              effects: [readOnlyTooltipStateEffect.of(event.key !== 'Escape')],\n            });\n\n            return true;\n          }\n\n          return false;\n        },\n      }),\n      getTheme(theme, settings),\n      history(),\n      keymap.of([\n        ...defaultKeymap,\n        ...historyKeymap,\n        ...searchKeymap,\n        { key: 'Tab', run: acceptCompletion },\n        {\n          key: 'Mod-s',\n          preventDefault: true,\n          run: () => {\n            onFileSaveRef.current?.();\n            return true;\n          },\n        },\n        indentKeyBinding,\n      ]),\n      indentUnit.of('\\t'),\n      autocompletion({\n        closeOnBlur: false,\n      }),\n      tooltips({\n        position: 'absolute',\n        parent: document.body,\n        tooltipSpace: (view) => {\n          const rect = view.dom.getBoundingClientRect();\n\n          return {\n            top: rect.top - 50,\n            left: rect.left,\n            bottom: rect.bottom,\n            right: rect.right + 10,\n          };\n        },\n      }),\n      closeBrackets(),\n      lineNumbers(),\n      scrollPastEnd(),\n      dropCursor(),\n      drawSelection(),\n      bracketMatching(),\n      EditorState.tabSize.of(settings?.tabSize ?? 2),\n      indentOnInput(),\n      editableTooltipField,\n      editableStateField,\n      EditorState.readOnly.from(editableStateField, (editable) => !editable),\n      highlightActiveLineGutter(),\n      highlightActiveLine(),\n      foldGutter({\n        markerDOM: (open) => {\n          const icon = document.createElement('div');\n\n          icon.className = `fold-icon ${open ? 'i-ph-caret-down-bold' : 'i-ph-caret-right-bold'}`;\n\n          return icon;\n        },\n      }),\n      ...extensions,\n    ],\n  });\n}\n\nfunction setNoDocument(view: EditorView) {\n  view.dispatch({\n    selection: { anchor: 0 },\n    changes: {\n      from: 0,\n      to: view.state.doc.length,\n      insert: '',\n    },\n  });\n\n  view.scrollDOM.scrollTo(0, 0);\n}\n\nfunction setEditorDocument(\n  view: EditorView,\n  theme: Theme,\n  editable: boolean,\n  languageCompartment: Compartment,\n  autoFocus: boolean,\n  doc: TextEditorDocument,\n) {\n  if (doc.value !== view.state.doc.toString()) {\n    view.dispatch({\n      selection: { anchor: 0 },\n      changes: {\n        from: 0,\n        to: view.state.doc.length,\n        insert: doc.value,\n      },\n    });\n  }\n\n  view.dispatch({\n    effects: [editableStateEffect.of(editable && !doc.isBinary)],\n  });\n\n  getLanguage(doc.filePath).then((languageSupport) => {\n    if (!languageSupport) {\n      return;\n    }\n\n    view.dispatch({\n      effects: [languageCompartment.reconfigure([languageSupport]), reconfigureTheme(theme)],\n    });\n\n    requestAnimationFrame(() => {\n      const currentLeft = view.scrollDOM.scrollLeft;\n      const currentTop = view.scrollDOM.scrollTop;\n      const newLeft = doc.scroll?.left ?? 0;\n      const newTop = doc.scroll?.top ?? 0;\n\n      const needsScrolling = currentLeft !== newLeft || currentTop !== newTop;\n\n      if (autoFocus && editable) {\n        if (needsScrolling) {\n          // we have to wait until the scroll position was changed before we can set the focus\n          view.scrollDOM.addEventListener(\n            'scroll',\n            () => {\n              view.focus();\n            },\n            { once: true },\n          );\n        } else {\n          // if the scroll position is still the same we can focus immediately\n          view.focus();\n        }\n      }\n\n      view.scrollDOM.scrollTo(newLeft, newTop);\n    });\n  });\n}\n\nfunction getReadOnlyTooltip(state: EditorState) {\n  if (!state.readOnly) {\n    return [];\n  }\n\n  return state.selection.ranges\n    .filter((range) => {\n      return range.empty;\n    })\n    .map((range) => {\n      return {\n        pos: range.head,\n        above: true,\n        strictSide: true,\n        arrow: true,\n        create: () => {\n          const divElement = document.createElement('div');\n          divElement.className = 'cm-readonly-tooltip';\n          divElement.textContent = 'Cannot edit file while AI response is being generated';\n\n          return { dom: divElement };\n        },\n      };\n    });\n}\n", "tag": "", "tokens": 3338, "metadata": {}}], "modify_time": 1733125234.6205757}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/cm-theme.ts", "relative_path": "bolt.new/app/components/editor/codemirror/cm-theme.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/components/editor/codemirror/cm-theme.ts", "source_code": "import { Compartment, type Extension } from '@codemirror/state';\nimport { EditorView } from '@codemirror/view';\nimport { vscodeDark, vscodeLight } from '@uiw/codemirror-theme-vscode';\nimport type { Theme } from '~/types/theme.js';\nimport type { EditorSettings } from './CodeMirrorEditor.js';\n\nexport const darkTheme = EditorView.theme({}, { dark: true });\nexport const themeSelection = new Compartment();\n\nexport function getTheme(theme: Theme, settings: EditorSettings = {}): Extension {\n  return [\n    getEditorTheme(settings),\n    theme === 'dark' ? themeSelection.of([getDarkTheme()]) : themeSelection.of([getLightTheme()]),\n  ];\n}\n\nexport function reconfigureTheme(theme: Theme) {\n  return themeSelection.reconfigure(theme === 'dark' ? getDarkTheme() : getLightTheme());\n}\n\nfunction getEditorTheme(settings: EditorSettings) {\n  return EditorView.theme({\n    '&': {\n      fontSize: settings.fontSize ?? '12px',\n    },\n    '&.cm-editor': {\n      height: '100%',\n      background: 'var(--cm-backgroundColor)',\n      color: 'var(--cm-textColor)',\n    },\n    '.cm-cursor': {\n      borderLeft: 'var(--cm-cursor-width) solid var(--cm-cursor-backgroundColor)',\n    },\n    '.cm-scroller': {\n      lineHeight: '1.5',\n      '&:focus-visible': {\n        outline: 'none',\n      },\n    },\n    '.cm-line': {\n      padding: '0 0 0 4px',\n    },\n    '&.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground': {\n      backgroundColor: 'var(--cm-selection-backgroundColorFocused) !important',\n      opacity: 'var(--cm-selection-backgroundOpacityFocused, 0.3)',\n    },\n    '&:not(.cm-focused) > .cm-scroller > .cm-selectionLayer .cm-selectionBackground': {\n      backgroundColor: 'var(--cm-selection-backgroundColorBlured)',\n      opacity: 'var(--cm-selection-backgroundOpacityBlured, 0.3)',\n    },\n    '&.cm-focused > .cm-scroller .cm-matchingBracket': {\n      backgroundColor: 'var(--cm-matching-bracket)',\n    },\n    '.cm-activeLine': {\n      background: 'var(--cm-activeLineBackgroundColor)',\n    },\n    '.cm-gutters': {\n      background: 'var(--cm-gutter-backgroundColor)',\n      borderRight: 0,\n      color: 'var(--cm-gutter-textColor)',\n    },\n    '.cm-gutter': {\n      '&.cm-lineNumbers': {\n        fontFamily: 'Roboto Mono, monospace',\n        fontSize: settings.gutterFontSize ?? settings.fontSize ?? '12px',\n        minWidth: '40px',\n      },\n      '& .cm-activeLineGutter': {\n        background: 'transparent',\n        color: 'var(--cm-gutter-activeLineTextColor)',\n      },\n      '&.cm-foldGutter .cm-gutterElement > .fold-icon': {\n        cursor: 'pointer',\n        color: 'var(--cm-foldGutter-textColor)',\n        transform: 'translateY(2px)',\n        '&:hover': {\n          color: 'var(--cm-foldGutter-textColorHover)',\n        },\n      },\n    },\n    '.cm-foldGutter .cm-gutterElement': {\n      padding: '0 4px',\n    },\n    '.cm-tooltip-autocomplete > ul > li': {\n      minHeight: '18px',\n    },\n    '.cm-panel.cm-search label': {\n      marginLeft: '2px',\n      fontSize: '12px',\n    },\n    '.cm-panel.cm-search .cm-button': {\n      fontSize: '12px',\n    },\n    '.cm-panel.cm-search .cm-textfield': {\n      fontSize: '12px',\n    },\n    '.cm-panel.cm-search input[type=checkbox]': {\n      position: 'relative',\n      transform: 'translateY(2px)',\n      marginRight: '4px',\n    },\n    '.cm-panels': {\n      borderColor: 'var(--cm-panels-borderColor)',\n    },\n    '.cm-panels-bottom': {\n      borderTop: '1px solid var(--cm-panels-borderColor)',\n      backgroundColor: 'transparent',\n    },\n    '.cm-panel.cm-search': {\n      background: 'var(--cm-search-backgroundColor)',\n      color: 'var(--cm-search-textColor)',\n      padding: '8px',\n    },\n    '.cm-search .cm-button': {\n      background: 'var(--cm-search-button-backgroundColor)',\n      borderColor: 'var(--cm-search-button-borderColor)',\n      color: 'var(--cm-search-button-textColor)',\n      borderRadius: '4px',\n      '&:hover': {\n        color: 'var(--cm-search-button-textColorHover)',\n      },\n      '&:focus-visible': {\n        outline: 'none',\n        borderColor: 'var(--cm-search-button-borderColorFocused)',\n      },\n      '&:hover:not(:focus-visible)': {\n        background: 'var(--cm-search-button-backgroundColorHover)',\n        borderColor: 'var(--cm-search-button-borderColorHover)',\n      },\n      '&:hover:focus-visible': {\n        background: 'var(--cm-search-button-backgroundColorHover)',\n        borderColor: 'var(--cm-search-button-borderColorFocused)',\n      },\n    },\n    '.cm-panel.cm-search [name=close]': {\n      top: '6px',\n      right: '6px',\n      padding: '0 6px',\n      fontSize: '1rem',\n      backgroundColor: 'var(--cm-search-closeButton-backgroundColor)',\n      color: 'var(--cm-search-closeButton-textColor)',\n      '&:hover': {\n        'border-radius': '6px',\n        color: 'var(--cm-search-closeButton-textColorHover)',\n        backgroundColor: 'var(--cm-search-closeButton-backgroundColorHover)',\n      },\n    },\n    '.cm-search input': {\n      background: 'var(--cm-search-input-backgroundColor)',\n      borderColor: 'var(--cm-search-input-borderColor)',\n      color: 'var(--cm-search-input-textColor)',\n      outline: 'none',\n      borderRadius: '4px',\n      '&:focus-visible': {\n        borderColor: 'var(--cm-search-input-borderColorFocused)',\n      },\n    },\n    '.cm-tooltip': {\n      background: 'var(--cm-tooltip-backgroundColor)',\n      border: '1px solid transparent',\n      borderColor: 'var(--cm-tooltip-borderColor)',\n      color: 'var(--cm-tooltip-textColor)',\n    },\n    '.cm-tooltip.cm-tooltip-autocomplete ul li[aria-selected]': {\n      background: 'var(--cm-tooltip-backgroundColorSelected)',\n      color: 'var(--cm-tooltip-textColorSelected)',\n    },\n    '.cm-searchMatch': {\n      backgroundColor: 'var(--cm-searchMatch-backgroundColor)',\n    },\n    '.cm-tooltip.cm-readonly-tooltip': {\n      padding: '4px',\n      whiteSpace: 'nowrap',\n      backgroundColor: 'var(--bolt-elements-bg-depth-2)',\n      borderColor: 'var(--bolt-elements-borderColorActive)',\n      '& .cm-tooltip-arrow:before': {\n        borderTopColor: 'var(--bolt-elements-borderColorActive)',\n      },\n      '& .cm-tooltip-arrow:after': {\n        borderTopColor: 'transparent',\n      },\n    },\n  });\n}\n\nfunction getLightTheme() {\n  return vscodeLight;\n}\n\nfunction getDarkTheme() {\n  return vscodeDark;\n}\n", "tag": "", "tokens": 1953, "metadata": {}}], "modify_time": 1733125234.6207168}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/crypto.ts", "relative_path": "bolt.new/app/lib/crypto.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/crypto.ts", "source_code": "const encoder = new TextEncoder();\nconst decoder = new TextDecoder();\nconst IV_LENGTH = 16;\n\nexport async function encrypt(key: string, data: string) {\n  const iv = crypto.getRandomValues(new Uint8Array(IV_LENGTH));\n  const cryptoKey = await getKey(key);\n\n  const ciphertext = await crypto.subtle.encrypt(\n    {\n      name: 'AES-CBC',\n      iv,\n    },\n    cryptoKey,\n    encoder.encode(data),\n  );\n\n  const bundle = new Uint8Array(IV_LENGTH + ciphertext.byteLength);\n\n  bundle.set(new Uint8Array(ciphertext));\n  bundle.set(iv, ciphertext.byteLength);\n\n  return decodeBase64(bundle);\n}\n\nexport async function decrypt(key: string, payload: string) {\n  const bundle = encodeBase64(payload);\n\n  const iv = new Uint8Array(bundle.buffer, bundle.byteLength - IV_LENGTH);\n  const ciphertext = new Uint8Array(bundle.buffer, 0, bundle.byteLength - IV_LENGTH);\n\n  const cryptoKey = await getKey(key);\n\n  const plaintext = await crypto.subtle.decrypt(\n    {\n      name: 'AES-CBC',\n      iv,\n    },\n    cryptoKey,\n    ciphertext,\n  );\n\n  return decoder.decode(plaintext);\n}\n\nasync function getKey(key: string) {\n  return await crypto.subtle.importKey('raw', encodeBase64(key), { name: 'AES-CBC' }, false, ['encrypt', 'decrypt']);\n}\n\nfunction decodeBase64(encoded: Uint8Array) {\n  const byteChars = Array.from(encoded, (byte) => String.fromCodePoint(byte));\n\n  return btoa(byteChars.join(''));\n}\n\nfunction encodeBase64(data: string) {\n  return Uint8Array.from(atob(data), (ch) => ch.codePointAt(0)!);\n}\n", "tag": "", "tokens": 493, "metadata": {}}], "modify_time": 1733125234.6251323}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/fetch.ts", "relative_path": "bolt.new/app/lib/fetch.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/fetch.ts", "source_code": "type CommonRequest = Omit<RequestInit, 'body'> & { body?: URLSearchParams };\n\nexport async function request(url: string, init?: CommonRequest) {\n  if (import.meta.env.DEV) {\n    const nodeFetch = await import('node-fetch');\n    const https = await import('node:https');\n\n    const agent = url.startsWith('https') ? new https.Agent({ rejectUnauthorized: false }) : undefined;\n\n    return nodeFetch.default(url, { ...init, agent });\n  }\n\n  return fetch(url, init);\n}\n", "tag": "", "tokens": 144, "metadata": {}}], "modify_time": 1733125234.6252396}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/runtime/message-parser.spec.ts", "relative_path": "bolt.new/app/lib/runtime/message-parser.spec.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/runtime/message-parser.spec.ts", "source_code": "import { describe, expect, it, vi } from 'vitest';\nimport { StreamingMessageParser, type ActionCallback, type ArtifactCallback } from './message-parser';\n\ninterface ExpectedResult {\n  output: string;\n  callbacks?: {\n    onArtifactOpen?: number;\n    onArtifactClose?: number;\n    onActionOpen?: number;\n    onActionClose?: number;\n  };\n}\n\ndescribe('StreamingMessageParser', () => {\n  it('should pass through normal text', () => {\n    const parser = new StreamingMessageParser();\n    expect(parser.parse('test_id', 'Hello, world!')).toBe('Hello, world!');\n  });\n\n  it('should allow normal HTML tags', () => {\n    const parser = new StreamingMessageParser();\n    expect(parser.parse('test_id', 'Hello <strong>world</strong>!')).toBe('Hello <strong>world</strong>!');\n  });\n\n  describe('no artifacts', () => {\n    it.each<[string | string[], ExpectedResult | string]>([\n      ['Foo bar', 'Foo bar'],\n      ['Foo bar <', 'Foo bar '],\n      ['Foo bar <p', 'Foo bar <p'],\n      [['Foo bar <', 's', 'p', 'an>some text</span>'], 'Foo bar <span>some text</span>'],\n    ])('should correctly parse chunks and strip out bolt artifacts (%#)', (input, expected) => {\n      runTest(input, expected);\n    });\n  });\n\n  describe('invalid or incomplete artifacts', () => {\n    it.each<[string | string[], ExpectedResult | string]>([\n      ['Foo bar <b', 'Foo bar '],\n      ['Foo bar <ba', 'Foo bar <ba'],\n      ['Foo bar <bol', 'Foo bar '],\n      ['Foo bar <bolt', 'Foo bar '],\n      ['Foo bar <bolta', 'Foo bar <bolta'],\n      ['Foo bar <boltA', 'Foo bar '],\n      ['Foo bar <boltArtifacs></boltArtifact>', 'Foo bar <boltArtifacs></boltArtifact>'],\n      ['Before <oltArtfiact>foo</boltArtifact> After', 'Before <oltArtfiact>foo</boltArtifact> After'],\n      ['Before <boltArtifactt>foo</boltArtifact> After', 'Before <boltArtifactt>foo</boltArtifact> After'],\n    ])('should correctly parse chunks and strip out bolt artifacts (%#)', (input, expected) => {\n      runTest(input, expected);\n    });\n  });\n\n  describe('valid artifacts without actions', () => {\n    it.each<[string | string[], ExpectedResult | string]>([\n      [\n        'Some text before <boltArtifact title=\"Some title\" id=\"artifact_1\">foo bar</boltArtifact> Some more text',\n        {\n          output: 'Some text before  Some more text',\n          callbacks: { onArtifactOpen: 1, onArtifactClose: 1, onActionOpen: 0, onActionClose: 0 },\n        },\n      ],\n      [\n        ['Some text before <boltArti', 'fact', ' title=\"Some title\" id=\"artifact_1\">foo</boltArtifact> Some more text'],\n        {\n          output: 'Some text before  Some more text',\n          callbacks: { onArtifactOpen: 1, onArtifactClose: 1, onActionOpen: 0, onActionClose: 0 },\n        },\n      ],\n      [\n        [\n          'Some text before <boltArti',\n          'fac',\n          't title=\"Some title\" id=\"artifact_1\"',\n          ' ',\n          '>',\n          'foo</boltArtifact> Some more text',\n        ],\n        {\n          output: 'Some text before  Some more text',\n          callbacks: { onArtifactOpen: 1, onArtifactClose: 1, onActionOpen: 0, onActionClose: 0 },\n        },\n      ],\n      [\n        [\n          'Some text before <boltArti',\n          'fact',\n          ' title=\"Some title\" id=\"artifact_1\"',\n          ' >fo',\n          'o</boltArtifact> Some more text',\n        ],\n        {\n          output: 'Some text before  Some more text',\n          callbacks: { onArtifactOpen: 1, onArtifactClose: 1, onActionOpen: 0, onActionClose: 0 },\n        },\n      ],\n      [\n        [\n          'Some text before <boltArti',\n          'fact tit',\n          'le=\"Some ',\n          'title\" id=\"artifact_1\">fo',\n          'o',\n          '<',\n          '/boltArtifact> Some more text',\n        ],\n        {\n          output: 'Some text before  Some more text',\n          callbacks: { onArtifactOpen: 1, onArtifactClose: 1, onActionOpen: 0, onActionClose: 0 },\n        },\n      ],\n      [\n        [\n          'Some text before <boltArti',\n          'fact title=\"Some title\" id=\"artif',\n          'act_1\">fo',\n          'o<',\n          '/boltArtifact> Some more text',\n        ],\n        {\n          output: 'Some text before  Some more text',\n          callbacks: { onArtifactOpen: 1, onArtifactClose: 1, onActionOpen: 0, onActionClose: 0 },\n        },\n      ],\n      [\n        'Before <boltArtifact title=\"Some title\" id=\"artifact_1\">foo</boltArtifact> After',\n        {\n          output: 'Before  After',\n          callbacks: { onArtifactOpen: 1, onArtifactClose: 1, onActionOpen: 0, onActionClose: 0 },\n        },\n      ],\n    ])('should correctly parse chunks and strip out bolt artifacts (%#)', (input, expected) => {\n      runTest(input, expected);\n    });\n  });\n\n  describe('valid artifacts with actions', () => {\n    it.each<[string | string[], ExpectedResult | string]>([\n      [\n        'Before <boltArtifact title=\"Some title\" id=\"artifact_1\"><boltAction type=\"shell\">npm install</boltAction></boltArtifact> After',\n        {\n          output: 'Before  After',\n          callbacks: { onArtifactOpen: 1, onArtifactClose: 1, onActionOpen: 1, onActionClose: 1 },\n        },\n      ],\n      [\n        'Before <boltArtifact title=\"Some title\" id=\"artifact_1\"><boltAction type=\"shell\">npm install</boltAction><boltAction type=\"file\" filePath=\"index.js\">some content</boltAction></boltArtifact> After',\n        {\n          output: 'Before  After',\n          callbacks: { onArtifactOpen: 1, onArtifactClose: 1, onActionOpen: 2, onActionClose: 2 },\n        },\n      ],\n    ])('should correctly parse chunks and strip out bolt artifacts (%#)', (input, expected) => {\n      runTest(input, expected);\n    });\n  });\n});\n\nfunction runTest(input: string | string[], outputOrExpectedResult: string | ExpectedResult) {\n  let expected: ExpectedResult;\n\n  if (typeof outputOrExpectedResult === 'string') {\n    expected = { output: outputOrExpectedResult };\n  } else {\n    expected = outputOrExpectedResult;\n  }\n\n  const callbacks = {\n    onArtifactOpen: vi.fn<ArtifactCallback>((data) => {\n      expect(data).toMatchSnapshot('onArtifactOpen');\n    }),\n    onArtifactClose: vi.fn<ArtifactCallback>((data) => {\n      expect(data).toMatchSnapshot('onArtifactClose');\n    }),\n    onActionOpen: vi.fn<ActionCallback>((data) => {\n      expect(data).toMatchSnapshot('onActionOpen');\n    }),\n    onActionClose: vi.fn<ActionCallback>((data) => {\n      expect(data).toMatchSnapshot('onActionClose');\n    }),\n  };\n\n  const parser = new StreamingMessageParser({\n    artifactElement: () => '',\n    callbacks,\n  });\n\n  let message = '';\n\n  let result = '';\n\n  const chunks = Array.isArray(input) ? input : input.split('');\n\n  for (const chunk of chunks) {\n    message += chunk;\n\n    result += parser.parse('message_1', message);\n  }\n\n  for (const name in expected.callbacks) {\n    const callbackName = name;\n\n    expect(callbacks[callbackName as keyof typeof callbacks]).toHaveBeenCalledTimes(\n      expected.callbacks[callbackName as keyof typeof expected.callbacks] ?? 0,\n    );\n  }\n\n  expect(result).toEqual(expected.output);\n}\n", "tag": "", "tokens": 2057, "metadata": {}}], "modify_time": 1733125234.626889}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/runtime/message-parser.ts", "relative_path": "bolt.new/app/lib/runtime/message-parser.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/runtime/message-parser.ts", "source_code": "import type { ActionType, BoltAction, BoltActionData, FileAction, ShellAction } from '~/types/actions';\nimport type { BoltArtifactData } from '~/types/artifact';\nimport { createScopedLogger } from '~/utils/logger';\nimport { unreachable } from '~/utils/unreachable';\n\nconst ARTIFACT_TAG_OPEN = '<boltArtifact';\nconst ARTIFACT_TAG_CLOSE = '</boltArtifact>';\nconst ARTIFACT_ACTION_TAG_OPEN = '<boltAction';\nconst ARTIFACT_ACTION_TAG_CLOSE = '</boltAction>';\n\nconst logger = createScopedLogger('MessageParser');\n\nexport interface ArtifactCallbackData extends BoltArtifactData {\n  messageId: string;\n}\n\nexport interface ActionCallbackData {\n  artifactId: string;\n  messageId: string;\n  actionId: string;\n  action: BoltAction;\n}\n\nexport type ArtifactCallback = (data: ArtifactCallbackData) => void;\nexport type ActionCallback = (data: ActionCallbackData) => void;\n\nexport interface ParserCallbacks {\n  onArtifactOpen?: ArtifactCallback;\n  onArtifactClose?: ArtifactCallback;\n  onActionOpen?: ActionCallback;\n  onActionClose?: ActionCallback;\n}\n\ninterface ElementFactoryProps {\n  messageId: string;\n}\n\ntype ElementFactory = (props: ElementFactoryProps) => string;\n\nexport interface StreamingMessageParserOptions {\n  callbacks?: ParserCallbacks;\n  artifactElement?: ElementFactory;\n}\n\ninterface MessageState {\n  position: number;\n  insideArtifact: boolean;\n  insideAction: boolean;\n  currentArtifact?: BoltArtifactData;\n  currentAction: BoltActionData;\n  actionId: number;\n}\n\nexport class StreamingMessageParser {\n  #messages = new Map<string, MessageState>();\n\n  constructor(private _options: StreamingMessageParserOptions = {}) {}\n\n  parse(messageId: string, input: string) {\n    let state = this.#messages.get(messageId);\n\n    if (!state) {\n      state = {\n        position: 0,\n        insideAction: false,\n        insideArtifact: false,\n        currentAction: { content: '' },\n        actionId: 0,\n      };\n\n      this.#messages.set(messageId, state);\n    }\n\n    let output = '';\n    let i = state.position;\n    let earlyBreak = false;\n\n    while (i < input.length) {\n      if (state.insideArtifact) {\n        const currentArtifact = state.currentArtifact;\n\n        if (currentArtifact === undefined) {\n          unreachable('Artifact not initialized');\n        }\n\n        if (state.insideAction) {\n          const closeIndex = input.indexOf(ARTIFACT_ACTION_TAG_CLOSE, i);\n\n          const currentAction = state.currentAction;\n\n          if (closeIndex !== -1) {\n            currentAction.content += input.slice(i, closeIndex);\n\n            let content = currentAction.content.trim();\n\n            if ('type' in currentAction && currentAction.type === 'file') {\n              content += '\\n';\n            }\n\n            currentAction.content = content;\n\n            this._options.callbacks?.onActionClose?.({\n              artifactId: currentArtifact.id,\n              messageId,\n\n              /**\n               * We decrement the id because it's been incremented already\n               * when `onActionOpen` was emitted to make sure the ids are\n               * the same.\n               */\n              actionId: String(state.actionId - 1),\n\n              action: currentAction as BoltAction,\n            });\n\n            state.insideAction = false;\n            state.currentAction = { content: '' };\n\n            i = closeIndex + ARTIFACT_ACTION_TAG_CLOSE.length;\n          } else {\n            break;\n          }\n        } else {\n          const actionOpenIndex = input.indexOf(ARTIFACT_ACTION_TAG_OPEN, i);\n          const artifactCloseIndex = input.indexOf(ARTIFACT_TAG_CLOSE, i);\n\n          if (actionOpenIndex !== -1 && (artifactCloseIndex === -1 || actionOpenIndex < artifactCloseIndex)) {\n            const actionEndIndex = input.indexOf('>', actionOpenIndex);\n\n            if (actionEndIndex !== -1) {\n              state.insideAction = true;\n\n              state.currentAction = this.#parseActionTag(input, actionOpenIndex, actionEndIndex);\n\n              this._options.callbacks?.onActionOpen?.({\n                artifactId: currentArtifact.id,\n                messageId,\n                actionId: String(state.actionId++),\n                action: state.currentAction as BoltAction,\n              });\n\n              i = actionEndIndex + 1;\n            } else {\n              break;\n            }\n          } else if (artifactCloseIndex !== -1) {\n            this._options.callbacks?.onArtifactClose?.({ messageId, ...currentArtifact });\n\n            state.insideArtifact = false;\n            state.currentArtifact = undefined;\n\n            i = artifactCloseIndex + ARTIFACT_TAG_CLOSE.length;\n          } else {\n            break;\n          }\n        }\n      } else if (input[i] === '<' && input[i + 1] !== '/') {\n        let j = i;\n        let potentialTag = '';\n\n        while (j < input.length && potentialTag.length < ARTIFACT_TAG_OPEN.length) {\n          potentialTag += input[j];\n\n          if (potentialTag === ARTIFACT_TAG_OPEN) {\n            const nextChar = input[j + 1];\n\n            if (nextChar && nextChar !== '>' && nextChar !== ' ') {\n              output += input.slice(i, j + 1);\n              i = j + 1;\n              break;\n            }\n\n            const openTagEnd = input.indexOf('>', j);\n\n            if (openTagEnd !== -1) {\n              const artifactTag = input.slice(i, openTagEnd + 1);\n\n              const artifactTitle = this.#extractAttribute(artifactTag, 'title') as string;\n              const artifactId = this.#extractAttribute(artifactTag, 'id') as string;\n\n              if (!artifactTitle) {\n                logger.warn('Artifact title missing');\n              }\n\n              if (!artifactId) {\n                logger.warn('Artifact id missing');\n              }\n\n              state.insideArtifact = true;\n\n              const currentArtifact = {\n                id: artifactId,\n                title: artifactTitle,\n              } satisfies BoltArtifactData;\n\n              state.currentArtifact = currentArtifact;\n\n              this._options.callbacks?.onArtifactOpen?.({ messageId, ...currentArtifact });\n\n              const artifactFactory = this._options.artifactElement ?? createArtifactElement;\n\n              output += artifactFactory({ messageId });\n\n              i = openTagEnd + 1;\n            } else {\n              earlyBreak = true;\n            }\n\n            break;\n          } else if (!ARTIFACT_TAG_OPEN.startsWith(potentialTag)) {\n            output += input.slice(i, j + 1);\n            i = j + 1;\n            break;\n          }\n\n          j++;\n        }\n\n        if (j === input.length && ARTIFACT_TAG_OPEN.startsWith(potentialTag)) {\n          break;\n        }\n      } else {\n        output += input[i];\n        i++;\n      }\n\n      if (earlyBreak) {\n        break;\n      }\n    }\n\n    state.position = i;\n\n    return output;\n  }\n\n  reset() {\n    this.#messages.clear();\n  }\n\n  #parseActionTag(input: string, actionOpenIndex: number, actionEndIndex: number) {\n    const actionTag = input.slice(actionOpenIndex, actionEndIndex + 1);\n\n    const actionType = this.#extractAttribute(actionTag, 'type') as ActionType;\n\n    const actionAttributes = {\n      type: actionType,\n      content: '',\n    };\n\n    if (actionType === 'file') {\n      const filePath = this.#extractAttribute(actionTag, 'filePath') as string;\n\n      if (!filePath) {\n        logger.debug('File path not specified');\n      }\n\n      (actionAttributes as FileAction).filePath = filePath;\n    } else if (actionType !== 'shell') {\n      logger.warn(`Unknown action type '${actionType}'`);\n    }\n\n    return actionAttributes as FileAction | ShellAction;\n  }\n\n  #extractAttribute(tag: string, attributeName: string): string | undefined {\n    const match = tag.match(new RegExp(`${attributeName}=\"([^\"]*)\"`, 'i'));\n    return match ? match[1] : undefined;\n  }\n}\n\nconst createArtifactElement: ElementFactory = (props) => {\n  const elementProps = [\n    'class=\"__boltArtifact__\"',\n    ...Object.entries(props).map(([key, value]) => {\n      return `data-${camelToDashCase(key)}=${JSON.stringify(value)}`;\n    }),\n  ];\n\n  return `<div ${elementProps.join(' ')}></div>`;\n};\n\nfunction camelToDashCase(input: string) {\n  return input.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();\n}\n", "tag": "", "tokens": 2199, "metadata": {}}], "modify_time": 1733125234.6270306}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/runtime/action-runner.ts", "relative_path": "bolt.new/app/lib/runtime/action-runner.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/runtime/action-runner.ts", "source_code": "import { WebContainer } from '@webcontainer/api';\nimport { map, type MapStore } from 'nanostores';\nimport * as nodePath from 'node:path';\nimport type { BoltAction } from '~/types/actions';\nimport { createScopedLogger } from '~/utils/logger';\nimport { unreachable } from '~/utils/unreachable';\nimport type { ActionCallbackData } from './message-parser';\n\nconst logger = createScopedLogger('ActionRunner');\n\nexport type ActionStatus = 'pending' | 'running' | 'complete' | 'aborted' | 'failed';\n\nexport type BaseActionState = BoltAction & {\n  status: Exclude<ActionStatus, 'failed'>;\n  abort: () => void;\n  executed: boolean;\n  abortSignal: AbortSignal;\n};\n\nexport type FailedActionState = BoltAction &\n  Omit<BaseActionState, 'status'> & {\n    status: Extract<ActionStatus, 'failed'>;\n    error: string;\n  };\n\nexport type ActionState = BaseActionState | FailedActionState;\n\ntype BaseActionUpdate = Partial<Pick<BaseActionState, 'status' | 'abort' | 'executed'>>;\n\nexport type ActionStateUpdate =\n  | BaseActionUpdate\n  | (Omit<BaseActionUpdate, 'status'> & { status: 'failed'; error: string });\n\ntype ActionsMap = MapStore<Record<string, ActionState>>;\n\nexport class ActionRunner {\n  #webcontainer: Promise<WebContainer>;\n  #currentExecutionPromise: Promise<void> = Promise.resolve();\n\n  actions: ActionsMap = map({});\n\n  constructor(webcontainerPromise: Promise<WebContainer>) {\n    this.#webcontainer = webcontainerPromise;\n  }\n\n  addAction(data: ActionCallbackData) {\n    const { actionId } = data;\n\n    const actions = this.actions.get();\n    const action = actions[actionId];\n\n    if (action) {\n      // action already added\n      return;\n    }\n\n    const abortController = new AbortController();\n\n    this.actions.setKey(actionId, {\n      ...data.action,\n      status: 'pending',\n      executed: false,\n      abort: () => {\n        abortController.abort();\n        this.#updateAction(actionId, { status: 'aborted' });\n      },\n      abortSignal: abortController.signal,\n    });\n\n    this.#currentExecutionPromise.then(() => {\n      this.#updateAction(actionId, { status: 'running' });\n    });\n  }\n\n  async runAction(data: ActionCallbackData) {\n    const { actionId } = data;\n    const action = this.actions.get()[actionId];\n\n    if (!action) {\n      unreachable(`Action ${actionId} not found`);\n    }\n\n    if (action.executed) {\n      return;\n    }\n\n    this.#updateAction(actionId, { ...action, ...data.action, executed: true });\n\n    this.#currentExecutionPromise = this.#currentExecutionPromise\n      .then(() => {\n        return this.#executeAction(actionId);\n      })\n      .catch((error) => {\n        console.error('Action failed:', error);\n      });\n  }\n\n  async #executeAction(actionId: string) {\n    const action = this.actions.get()[actionId];\n\n    this.#updateAction(actionId, { status: 'running' });\n\n    try {\n      switch (action.type) {\n        case 'shell': {\n          await this.#runShellAction(action);\n          break;\n        }\n        case 'file': {\n          await this.#runFileAction(action);\n          break;\n        }\n      }\n\n      this.#updateAction(actionId, { status: action.abortSignal.aborted ? 'aborted' : 'complete' });\n    } catch (error) {\n      this.#updateAction(actionId, { status: 'failed', error: 'Action failed' });\n\n      // re-throw the error to be caught in the promise chain\n      throw error;\n    }\n  }\n\n  async #runShellAction(action: ActionState) {\n    if (action.type !== 'shell') {\n      unreachable('Expected shell action');\n    }\n\n    const webcontainer = await this.#webcontainer;\n\n    const process = await webcontainer.spawn('jsh', ['-c', action.content], {\n      env: { npm_config_yes: true },\n    });\n\n    action.abortSignal.addEventListener('abort', () => {\n      process.kill();\n    });\n\n    process.output.pipeTo(\n      new WritableStream({\n        write(data) {\n          console.log(data);\n        },\n      }),\n    );\n\n    const exitCode = await process.exit;\n\n    logger.debug(`Process terminated with code ${exitCode}`);\n  }\n\n  async #runFileAction(action: ActionState) {\n    if (action.type !== 'file') {\n      unreachable('Expected file action');\n    }\n\n    const webcontainer = await this.#webcontainer;\n\n    let folder = nodePath.dirname(action.filePath);\n\n    // remove trailing slashes\n    folder = folder.replace(/\\/+$/g, '');\n\n    if (folder !== '.') {\n      try {\n        await webcontainer.fs.mkdir(folder, { recursive: true });\n        logger.debug('Created folder', folder);\n      } catch (error) {\n        logger.error('Failed to create folder\\n\\n', error);\n      }\n    }\n\n    try {\n      await webcontainer.fs.writeFile(action.filePath, action.content);\n      logger.debug(`File written ${action.filePath}`);\n    } catch (error) {\n      logger.error('Failed to write file\\n\\n', error);\n    }\n  }\n\n  #updateAction(id: string, newState: ActionStateUpdate) {\n    const actions = this.actions.get();\n\n    this.actions.setKey(id, { ...actions[id], ...newState });\n  }\n}\n", "tag": "", "tokens": 1445, "metadata": {}}], "modify_time": 1733125234.6267598}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/editor.ts", "relative_path": "bolt.new/app/lib/stores/editor.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/editor.ts", "source_code": "import { atom, computed, map, type MapStore, type WritableAtom } from 'nanostores';\nimport type { EditorDocument, ScrollPosition } from '~/components/editor/codemirror/CodeMirrorEditor';\nimport type { FileMap, FilesStore } from './files';\n\nexport type EditorDocuments = Record<string, EditorDocument>;\n\ntype SelectedFile = WritableAtom<string | undefined>;\n\nexport class EditorStore {\n  #filesStore: FilesStore;\n\n  selectedFile: SelectedFile = import.meta.hot?.data.selectedFile ?? atom<string | undefined>();\n  documents: MapStore<EditorDocuments> = import.meta.hot?.data.documents ?? map({});\n\n  currentDocument = computed([this.documents, this.selectedFile], (documents, selectedFile) => {\n    if (!selectedFile) {\n      return undefined;\n    }\n\n    return documents[selectedFile];\n  });\n\n  constructor(filesStore: FilesStore) {\n    this.#filesStore = filesStore;\n\n    if (import.meta.hot) {\n      import.meta.hot.data.documents = this.documents;\n      import.meta.hot.data.selectedFile = this.selectedFile;\n    }\n  }\n\n  setDocuments(files: FileMap) {\n    const previousDocuments = this.documents.value;\n\n    this.documents.set(\n      Object.fromEntries<EditorDocument>(\n        Object.entries(files)\n          .map(([filePath, dirent]) => {\n            if (dirent === undefined || dirent.type === 'folder') {\n              return undefined;\n            }\n\n            const previousDocument = previousDocuments?.[filePath];\n\n            return [\n              filePath,\n              {\n                value: dirent.content,\n                filePath,\n                scroll: previousDocument?.scroll,\n              },\n            ] as [string, EditorDocument];\n          })\n          .filter(Boolean) as Array<[string, EditorDocument]>,\n      ),\n    );\n  }\n\n  setSelectedFile(filePath: string | undefined) {\n    this.selectedFile.set(filePath);\n  }\n\n  updateScrollPosition(filePath: string, position: ScrollPosition) {\n    const documents = this.documents.get();\n    const documentState = documents[filePath];\n\n    if (!documentState) {\n      return;\n    }\n\n    this.documents.setKey(filePath, {\n      ...documentState,\n      scroll: position,\n    });\n  }\n\n  updateFile(filePath: string, newContent: string) {\n    const documents = this.documents.get();\n    const documentState = documents[filePath];\n\n    if (!documentState) {\n      return;\n    }\n\n    const currentContent = documentState.value;\n    const contentChanged = currentContent !== newContent;\n\n    if (contentChanged) {\n      this.documents.setKey(filePath, {\n        ...documentState,\n        value: newContent,\n      });\n    }\n  }\n}\n", "tag": "", "tokens": 707, "metadata": {}}], "modify_time": 1733125234.6273365}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/settings.ts", "relative_path": "bolt.new/app/lib/stores/settings.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/settings.ts", "source_code": "import { map } from 'nanostores';\nimport { workbenchStore } from './workbench';\n\nexport interface Shortcut {\n  key: string;\n  ctrlKey?: boolean;\n  shiftKey?: boolean;\n  altKey?: boolean;\n  metaKey?: boolean;\n  ctrlOrMetaKey?: boolean;\n  action: () => void;\n}\n\nexport interface Shortcuts {\n  toggleTerminal: Shortcut;\n}\n\nexport interface Settings {\n  shortcuts: Shortcuts;\n}\n\nexport const shortcutsStore = map<Shortcuts>({\n  toggleTerminal: {\n    key: 'j',\n    ctrlOrMetaKey: true,\n    action: () => workbenchStore.toggleTerminal(),\n  },\n});\n\nexport const settingsStore = map<Settings>({\n  shortcuts: shortcutsStore.get(),\n});\n\nshortcutsStore.subscribe((shortcuts) => {\n  settingsStore.set({\n    ...settingsStore.get(),\n    shortcuts,\n  });\n});\n", "tag": "", "tokens": 231, "metadata": {}}], "modify_time": 1733125234.627699}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/chat.ts", "relative_path": "bolt.new/app/lib/stores/chat.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/chat.ts", "source_code": "import { map } from 'nanostores';\n\nexport const chatStore = map({\n  started: false,\n  aborted: false,\n  showChat: true,\n});\n", "tag": "", "tokens": 49, "metadata": {}}], "modify_time": 1733125234.627214}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/workbench.ts", "relative_path": "bolt.new/app/lib/stores/workbench.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/workbench.ts", "source_code": "import { atom, map, type MapStore, type ReadableAtom, type WritableAtom } from 'nanostores';\nimport type { EditorDocument, ScrollPosition } from '~/components/editor/codemirror/CodeMirrorEditor';\nimport { ActionRunner } from '~/lib/runtime/action-runner';\nimport type { ActionCallbackData, ArtifactCallbackData } from '~/lib/runtime/message-parser';\nimport { webcontainer } from '~/lib/webcontainer';\nimport type { ITerminal } from '~/types/terminal';\nimport { unreachable } from '~/utils/unreachable';\nimport { EditorStore } from './editor';\nimport { FilesStore, type FileMap } from './files';\nimport { PreviewsStore } from './previews';\nimport { TerminalStore } from './terminal';\n\nexport interface ArtifactState {\n  id: string;\n  title: string;\n  closed: boolean;\n  runner: ActionRunner;\n}\n\nexport type ArtifactUpdateState = Pick<ArtifactState, 'title' | 'closed'>;\n\ntype Artifacts = MapStore<Record<string, ArtifactState>>;\n\nexport type WorkbenchViewType = 'code' | 'preview';\n\nexport class WorkbenchStore {\n  #previewsStore = new PreviewsStore(webcontainer);\n  #filesStore = new FilesStore(webcontainer);\n  #editorStore = new EditorStore(this.#filesStore);\n  #terminalStore = new TerminalStore(webcontainer);\n\n  artifacts: Artifacts = import.meta.hot?.data.artifacts ?? map({});\n\n  showWorkbench: WritableAtom<boolean> = import.meta.hot?.data.showWorkbench ?? atom(false);\n  currentView: WritableAtom<WorkbenchViewType> = import.meta.hot?.data.currentView ?? atom('code');\n  unsavedFiles: WritableAtom<Set<string>> = import.meta.hot?.data.unsavedFiles ?? atom(new Set<string>());\n  modifiedFiles = new Set<string>();\n  artifactIdList: string[] = [];\n\n  constructor() {\n    if (import.meta.hot) {\n      import.meta.hot.data.artifacts = this.artifacts;\n      import.meta.hot.data.unsavedFiles = this.unsavedFiles;\n      import.meta.hot.data.showWorkbench = this.showWorkbench;\n      import.meta.hot.data.currentView = this.currentView;\n    }\n  }\n\n  get previews() {\n    return this.#previewsStore.previews;\n  }\n\n  get files() {\n    return this.#filesStore.files;\n  }\n\n  get currentDocument(): ReadableAtom<EditorDocument | undefined> {\n    return this.#editorStore.currentDocument;\n  }\n\n  get selectedFile(): ReadableAtom<string | undefined> {\n    return this.#editorStore.selectedFile;\n  }\n\n  get firstArtifact(): ArtifactState | undefined {\n    return this.#getArtifact(this.artifactIdList[0]);\n  }\n\n  get filesCount(): number {\n    return this.#filesStore.filesCount;\n  }\n\n  get showTerminal() {\n    return this.#terminalStore.showTerminal;\n  }\n\n  toggleTerminal(value?: boolean) {\n    this.#terminalStore.toggleTerminal(value);\n  }\n\n  attachTerminal(terminal: ITerminal) {\n    this.#terminalStore.attachTerminal(terminal);\n  }\n\n  onTerminalResize(cols: number, rows: number) {\n    this.#terminalStore.onTerminalResize(cols, rows);\n  }\n\n  setDocuments(files: FileMap) {\n    this.#editorStore.setDocuments(files);\n\n    if (this.#filesStore.filesCount > 0 && this.currentDocument.get() === undefined) {\n      // we find the first file and select it\n      for (const [filePath, dirent] of Object.entries(files)) {\n        if (dirent?.type === 'file') {\n          this.setSelectedFile(filePath);\n          break;\n        }\n      }\n    }\n  }\n\n  setShowWorkbench(show: boolean) {\n    this.showWorkbench.set(show);\n  }\n\n  setCurrentDocumentContent(newContent: string) {\n    const filePath = this.currentDocument.get()?.filePath;\n\n    if (!filePath) {\n      return;\n    }\n\n    const originalContent = this.#filesStore.getFile(filePath)?.content;\n    const unsavedChanges = originalContent !== undefined && originalContent !== newContent;\n\n    this.#editorStore.updateFile(filePath, newContent);\n\n    const currentDocument = this.currentDocument.get();\n\n    if (currentDocument) {\n      const previousUnsavedFiles = this.unsavedFiles.get();\n\n      if (unsavedChanges && previousUnsavedFiles.has(currentDocument.filePath)) {\n        return;\n      }\n\n      const newUnsavedFiles = new Set(previousUnsavedFiles);\n\n      if (unsavedChanges) {\n        newUnsavedFiles.add(currentDocument.filePath);\n      } else {\n        newUnsavedFiles.delete(currentDocument.filePath);\n      }\n\n      this.unsavedFiles.set(newUnsavedFiles);\n    }\n  }\n\n  setCurrentDocumentScrollPosition(position: ScrollPosition) {\n    const editorDocument = this.currentDocument.get();\n\n    if (!editorDocument) {\n      return;\n    }\n\n    const { filePath } = editorDocument;\n\n    this.#editorStore.updateScrollPosition(filePath, position);\n  }\n\n  setSelectedFile(filePath: string | undefined) {\n    this.#editorStore.setSelectedFile(filePath);\n  }\n\n  async saveFile(filePath: string) {\n    const documents = this.#editorStore.documents.get();\n    const document = documents[filePath];\n\n    if (document === undefined) {\n      return;\n    }\n\n    await this.#filesStore.saveFile(filePath, document.value);\n\n    const newUnsavedFiles = new Set(this.unsavedFiles.get());\n    newUnsavedFiles.delete(filePath);\n\n    this.unsavedFiles.set(newUnsavedFiles);\n  }\n\n  async saveCurrentDocument() {\n    const currentDocument = this.currentDocument.get();\n\n    if (currentDocument === undefined) {\n      return;\n    }\n\n    await this.saveFile(currentDocument.filePath);\n  }\n\n  resetCurrentDocument() {\n    const currentDocument = this.currentDocument.get();\n\n    if (currentDocument === undefined) {\n      return;\n    }\n\n    const { filePath } = currentDocument;\n    const file = this.#filesStore.getFile(filePath);\n\n    if (!file) {\n      return;\n    }\n\n    this.setCurrentDocumentContent(file.content);\n  }\n\n  async saveAllFiles() {\n    for (const filePath of this.unsavedFiles.get()) {\n      await this.saveFile(filePath);\n    }\n  }\n\n  getFileModifcations() {\n    return this.#filesStore.getFileModifications();\n  }\n\n  resetAllFileModifications() {\n    this.#filesStore.resetFileModifications();\n  }\n\n  abortAllActions() {\n    // TODO: what do we wanna do and how do we wanna recover from this?\n  }\n\n  addArtifact({ messageId, title, id }: ArtifactCallbackData) {\n    const artifact = this.#getArtifact(messageId);\n\n    if (artifact) {\n      return;\n    }\n\n    if (!this.artifactIdList.includes(messageId)) {\n      this.artifactIdList.push(messageId);\n    }\n\n    this.artifacts.setKey(messageId, {\n      id,\n      title,\n      closed: false,\n      runner: new ActionRunner(webcontainer),\n    });\n  }\n\n  updateArtifact({ messageId }: ArtifactCallbackData, state: Partial<ArtifactUpdateState>) {\n    const artifact = this.#getArtifact(messageId);\n\n    if (!artifact) {\n      return;\n    }\n\n    this.artifacts.setKey(messageId, { ...artifact, ...state });\n  }\n\n  async addAction(data: ActionCallbackData) {\n    const { messageId } = data;\n\n    const artifact = this.#getArtifact(messageId);\n\n    if (!artifact) {\n      unreachable('Artifact not found');\n    }\n\n    artifact.runner.addAction(data);\n  }\n\n  async runAction(data: ActionCallbackData) {\n    const { messageId } = data;\n\n    const artifact = this.#getArtifact(messageId);\n\n    if (!artifact) {\n      unreachable('Artifact not found');\n    }\n\n    artifact.runner.runAction(data);\n  }\n\n  #getArtifact(id: string) {\n    const artifacts = this.artifacts.get();\n    return artifacts[id];\n  }\n}\n\nexport const workbenchStore = new WorkbenchStore();\n", "tag": "", "tokens": 2130, "metadata": {}}], "modify_time": 1733125234.6280684}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/previews.ts", "relative_path": "bolt.new/app/lib/stores/previews.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/previews.ts", "source_code": "import type { WebContainer } from '@webcontainer/api';\nimport { atom } from 'nanostores';\n\nexport interface PreviewInfo {\n  port: number;\n  ready: boolean;\n  baseUrl: string;\n}\n\nexport class PreviewsStore {\n  #availablePreviews = new Map<number, PreviewInfo>();\n  #webcontainer: Promise<WebContainer>;\n\n  previews = atom<PreviewInfo[]>([]);\n\n  constructor(webcontainerPromise: Promise<WebContainer>) {\n    this.#webcontainer = webcontainerPromise;\n\n    this.#init();\n  }\n\n  async #init() {\n    const webcontainer = await this.#webcontainer;\n\n    webcontainer.on('port', (port, type, url) => {\n      let previewInfo = this.#availablePreviews.get(port);\n\n      if (type === 'close' && previewInfo) {\n        this.#availablePreviews.delete(port);\n        this.previews.set(this.previews.get().filter((preview) => preview.port !== port));\n\n        return;\n      }\n\n      const previews = this.previews.get();\n\n      if (!previewInfo) {\n        previewInfo = { port, ready: type === 'open', baseUrl: url };\n        this.#availablePreviews.set(port, previewInfo);\n        previews.push(previewInfo);\n      }\n\n      previewInfo.ready = type === 'open';\n      previewInfo.baseUrl = url;\n\n      this.previews.set([...previews]);\n    });\n  }\n}\n", "tag": "", "tokens": 374, "metadata": {}}], "modify_time": 1733125234.6275842}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/terminal.ts", "relative_path": "bolt.new/app/lib/stores/terminal.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/terminal.ts", "source_code": "import type { WebContainer, WebContainerProcess } from '@webcontainer/api';\nimport { atom, type WritableAtom } from 'nanostores';\nimport type { ITerminal } from '~/types/terminal';\nimport { newShellProcess } from '~/utils/shell';\nimport { coloredText } from '~/utils/terminal';\n\nexport class TerminalStore {\n  #webcontainer: Promise<WebContainer>;\n  #terminals: Array<{ terminal: ITerminal; process: WebContainerProcess }> = [];\n\n  showTerminal: WritableAtom<boolean> = import.meta.hot?.data.showTerminal ?? atom(false);\n\n  constructor(webcontainerPromise: Promise<WebContainer>) {\n    this.#webcontainer = webcontainerPromise;\n\n    if (import.meta.hot) {\n      import.meta.hot.data.showTerminal = this.showTerminal;\n    }\n  }\n\n  toggleTerminal(value?: boolean) {\n    this.showTerminal.set(value !== undefined ? value : !this.showTerminal.get());\n  }\n\n  async attachTerminal(terminal: ITerminal) {\n    try {\n      const shellProcess = await newShellProcess(await this.#webcontainer, terminal);\n      this.#terminals.push({ terminal, process: shellProcess });\n    } catch (error: any) {\n      terminal.write(coloredText.red('Failed to spawn shell\\n\\n') + error.message);\n      return;\n    }\n  }\n\n  onTerminalResize(cols: number, rows: number) {\n    for (const { process } of this.#terminals) {\n      process.resize({ cols, rows });\n    }\n  }\n}\n", "tag": "", "tokens": 400, "metadata": {}}], "modify_time": 1733125234.6278179}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/theme.ts", "relative_path": "bolt.new/app/lib/stores/theme.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/theme.ts", "source_code": "import { atom } from 'nanostores';\n\nexport type Theme = 'dark' | 'light';\n\nexport const kTheme = 'bolt_theme';\n\nexport function themeIsDark() {\n  return themeStore.get() === 'dark';\n}\n\nexport const DEFAULT_THEME = 'light';\n\nexport const themeStore = atom<Theme>(initStore());\n\nfunction initStore() {\n  if (!import.meta.env.SSR) {\n    const persistedTheme = localStorage.getItem(kTheme) as Theme | undefined;\n    const themeAttribute = document.querySelector('html')?.getAttribute('data-theme');\n\n    return persistedTheme ?? (themeAttribute as Theme) ?? DEFAULT_THEME;\n  }\n\n  return DEFAULT_THEME;\n}\n\nexport function toggleTheme() {\n  const currentTheme = themeStore.get();\n  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';\n\n  themeStore.set(newTheme);\n\n  localStorage.setItem(kTheme, newTheme);\n\n  document.querySelector('html')?.setAttribute('data-theme', newTheme);\n}\n", "tag": "", "tokens": 268, "metadata": {}}], "modify_time": 1733125234.6279297}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/files.ts", "relative_path": "bolt.new/app/lib/stores/files.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/stores/files.ts", "source_code": "import type { PathWatcherEvent, WebContainer } from '@webcontainer/api';\nimport { getEncoding } from 'istextorbinary';\nimport { map, type MapStore } from 'nanostores';\nimport { Buffer } from 'node:buffer';\nimport * as nodePath from 'node:path';\nimport { bufferWatchEvents } from '~/utils/buffer';\nimport { WORK_DIR } from '~/utils/constants';\nimport { computeFileModifications } from '~/utils/diff';\nimport { createScopedLogger } from '~/utils/logger';\nimport { unreachable } from '~/utils/unreachable';\n\nconst logger = createScopedLogger('FilesStore');\n\nconst utf8TextDecoder = new TextDecoder('utf8', { fatal: true });\n\nexport interface File {\n  type: 'file';\n  content: string;\n  isBinary: boolean;\n}\n\nexport interface Folder {\n  type: 'folder';\n}\n\ntype Dirent = File | Folder;\n\nexport type FileMap = Record<string, Dirent | undefined>;\n\nexport class FilesStore {\n  #webcontainer: Promise<WebContainer>;\n\n  /**\n   * Tracks the number of files without folders.\n   */\n  #size = 0;\n\n  /**\n   * @note Keeps track all modified files with their original content since the last user message.\n   * Needs to be reset when the user sends another message and all changes have to be submitted\n   * for the model to be aware of the changes.\n   */\n  #modifiedFiles: Map<string, string> = import.meta.hot?.data.modifiedFiles ?? new Map();\n\n  /**\n   * Map of files that matches the state of WebContainer.\n   */\n  files: MapStore<FileMap> = import.meta.hot?.data.files ?? map({});\n\n  get filesCount() {\n    return this.#size;\n  }\n\n  constructor(webcontainerPromise: Promise<WebContainer>) {\n    this.#webcontainer = webcontainerPromise;\n\n    if (import.meta.hot) {\n      import.meta.hot.data.files = this.files;\n      import.meta.hot.data.modifiedFiles = this.#modifiedFiles;\n    }\n\n    this.#init();\n  }\n\n  getFile(filePath: string) {\n    const dirent = this.files.get()[filePath];\n\n    if (dirent?.type !== 'file') {\n      return undefined;\n    }\n\n    return dirent;\n  }\n\n  getFileModifications() {\n    return computeFileModifications(this.files.get(), this.#modifiedFiles);\n  }\n\n  resetFileModifications() {\n    this.#modifiedFiles.clear();\n  }\n\n  async saveFile(filePath: string, content: string) {\n    const webcontainer = await this.#webcontainer;\n\n    try {\n      const relativePath = nodePath.relative(webcontainer.workdir, filePath);\n\n      if (!relativePath) {\n        throw new Error(`EINVAL: invalid file path, write '${relativePath}'`);\n      }\n\n      const oldContent = this.getFile(filePath)?.content;\n\n      if (!oldContent) {\n        unreachable('Expected content to be defined');\n      }\n\n      await webcontainer.fs.writeFile(relativePath, content);\n\n      if (!this.#modifiedFiles.has(filePath)) {\n        this.#modifiedFiles.set(filePath, oldContent);\n      }\n\n      // we immediately update the file and don't rely on the `change` event coming from the watcher\n      this.files.setKey(filePath, { type: 'file', content, isBinary: false });\n\n      logger.info('File updated');\n    } catch (error) {\n      logger.error('Failed to update file content\\n\\n', error);\n\n      throw error;\n    }\n  }\n\n  async #init() {\n    const webcontainer = await this.#webcontainer;\n\n    webcontainer.internal.watchPaths(\n      { include: [`${WORK_DIR}/**`], exclude: ['**/node_modules', '.git'], includeContent: true },\n      bufferWatchEvents(100, this.#processEventBuffer.bind(this)),\n    );\n  }\n\n  #processEventBuffer(events: Array<[events: PathWatcherEvent[]]>) {\n    const watchEvents = events.flat(2);\n\n    for (const { type, path, buffer } of watchEvents) {\n      // remove any trailing slashes\n      const sanitizedPath = path.replace(/\\/+$/g, '');\n\n      switch (type) {\n        case 'add_dir': {\n          // we intentionally add a trailing slash so we can distinguish files from folders in the file tree\n          this.files.setKey(sanitizedPath, { type: 'folder' });\n          break;\n        }\n        case 'remove_dir': {\n          this.files.setKey(sanitizedPath, undefined);\n\n          for (const [direntPath] of Object.entries(this.files)) {\n            if (direntPath.startsWith(sanitizedPath)) {\n              this.files.setKey(direntPath, undefined);\n            }\n          }\n\n          break;\n        }\n        case 'add_file':\n        case 'change': {\n          if (type === 'add_file') {\n            this.#size++;\n          }\n\n          let content = '';\n\n          /**\n           * @note This check is purely for the editor. The way we detect this is not\n           * bullet-proof and it's a best guess so there might be false-positives.\n           * The reason we do this is because we don't want to display binary files\n           * in the editor nor allow to edit them.\n           */\n          const isBinary = isBinaryFile(buffer);\n\n          if (!isBinary) {\n            content = this.#decodeFileContent(buffer);\n          }\n\n          this.files.setKey(sanitizedPath, { type: 'file', content, isBinary });\n\n          break;\n        }\n        case 'remove_file': {\n          this.#size--;\n          this.files.setKey(sanitizedPath, undefined);\n          break;\n        }\n        case 'update_directory': {\n          // we don't care about these events\n          break;\n        }\n      }\n    }\n  }\n\n  #decodeFileContent(buffer?: Uint8Array) {\n    if (!buffer || buffer.byteLength === 0) {\n      return '';\n    }\n\n    try {\n      return utf8TextDecoder.decode(buffer);\n    } catch (error) {\n      console.log(error);\n      return '';\n    }\n  }\n}\n\nfunction isBinaryFile(buffer: Uint8Array | undefined) {\n  if (buffer === undefined) {\n    return false;\n  }\n\n  return getEncoding(convertToBuffer(buffer), { chunkLength: 100 }) === 'binary';\n}\n\n/**\n * Converts a `Uint8Array` into a Node.js `Buffer` by copying the prototype.\n * The goal is to  avoid expensive copies. It does create a new typed array\n * but that's generally cheap as long as it uses the same underlying\n * array buffer.\n */\nfunction convertToBuffer(view: Uint8Array): Buffer {\n  const buffer = new Uint8Array(view.buffer, view.byteOffset, view.byteLength);\n\n  Object.setPrototypeOf(buffer, Buffer.prototype);\n\n  return buffer as Buffer;\n}\n", "tag": "", "tokens": 1767, "metadata": {}}], "modify_time": 1733125234.6274674}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/usePromptEnhancer.ts", "relative_path": "bolt.new/app/lib/hooks/usePromptEnhancer.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/usePromptEnhancer.ts", "source_code": "import { useState } from 'react';\nimport { createScopedLogger } from '~/utils/logger';\n\nconst logger = createScopedLogger('usePromptEnhancement');\n\nexport function usePromptEnhancer() {\n  const [enhancingPrompt, setEnhancingPrompt] = useState(false);\n  const [promptEnhanced, setPromptEnhanced] = useState(false);\n\n  const resetEnhancer = () => {\n    setEnhancingPrompt(false);\n    setPromptEnhanced(false);\n  };\n\n  const enhancePrompt = async (input: string, setInput: (value: string) => void) => {\n    setEnhancingPrompt(true);\n    setPromptEnhanced(false);\n\n    const response = await fetch('/api/enhancer', {\n      method: 'POST',\n      body: JSON.stringify({\n        message: input,\n      }),\n    });\n\n    const reader = response.body?.getReader();\n\n    const originalInput = input;\n\n    if (reader) {\n      const decoder = new TextDecoder();\n\n      let _input = '';\n      let _error;\n\n      try {\n        setInput('');\n\n        while (true) {\n          const { value, done } = await reader.read();\n\n          if (done) {\n            break;\n          }\n\n          _input += decoder.decode(value);\n\n          logger.trace('Set input', _input);\n\n          setInput(_input);\n        }\n      } catch (error) {\n        _error = error;\n        setInput(originalInput);\n      } finally {\n        if (_error) {\n          logger.error(_error);\n        }\n\n        setEnhancingPrompt(false);\n        setPromptEnhanced(true);\n\n        setTimeout(() => {\n          setInput(_input);\n        });\n      }\n    }\n  };\n\n  return { enhancingPrompt, promptEnhanced, enhancePrompt, resetEnhancer };\n}\n", "tag": "", "tokens": 458, "metadata": {}}], "modify_time": 1733125234.6256487}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/useShortcuts.ts", "relative_path": "bolt.new/app/lib/hooks/useShortcuts.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/useShortcuts.ts", "source_code": "import { useStore } from '@nanostores/react';\nimport { useEffect } from 'react';\nimport { shortcutsStore, type Shortcuts } from '~/lib/stores/settings';\n\nclass ShortcutEventEmitter {\n  #emitter = new EventTarget();\n\n  dispatch(type: keyof Shortcuts) {\n    this.#emitter.dispatchEvent(new Event(type));\n  }\n\n  on(type: keyof Shortcuts, cb: VoidFunction) {\n    this.#emitter.addEventListener(type, cb);\n\n    return () => {\n      this.#emitter.removeEventListener(type, cb);\n    };\n  }\n}\n\nexport const shortcutEventEmitter = new ShortcutEventEmitter();\n\nexport function useShortcuts(): void {\n  const shortcuts = useStore(shortcutsStore);\n\n  useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent): void => {\n      const { key, ctrlKey, shiftKey, altKey, metaKey } = event;\n\n      for (const name in shortcuts) {\n        const shortcut = shortcuts[name as keyof Shortcuts];\n\n        if (\n          shortcut.key.toLowerCase() === key.toLowerCase() &&\n          (shortcut.ctrlOrMetaKey\n            ? ctrlKey || metaKey\n            : (shortcut.ctrlKey === undefined || shortcut.ctrlKey === ctrlKey) &&\n              (shortcut.metaKey === undefined || shortcut.metaKey === metaKey)) &&\n          (shortcut.shiftKey === undefined || shortcut.shiftKey === shiftKey) &&\n          (shortcut.altKey === undefined || shortcut.altKey === altKey)\n        ) {\n          shortcutEventEmitter.dispatch(name as keyof Shortcuts);\n          event.preventDefault();\n          event.stopPropagation();\n\n          shortcut.action();\n\n          break;\n        }\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n\n    return () => {\n      window.removeEventListener('keydown', handleKeyDown);\n    };\n  }, [shortcuts]);\n}\n", "tag": "", "tokens": 458, "metadata": {}}], "modify_time": 1733125234.6257606}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/useSnapScroll.ts", "relative_path": "bolt.new/app/lib/hooks/useSnapScroll.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/useSnapScroll.ts", "source_code": "import { useRef, useCallback } from 'react';\n\nexport function useSnapScroll() {\n  const autoScrollRef = useRef(true);\n  const scrollNodeRef = useRef<HTMLDivElement>();\n  const onScrollRef = useRef<() => void>();\n  const observerRef = useRef<ResizeObserver>();\n\n  const messageRef = useCallback((node: HTMLDivElement | null) => {\n    if (node) {\n      const observer = new ResizeObserver(() => {\n        if (autoScrollRef.current && scrollNodeRef.current) {\n          const { scrollHeight, clientHeight } = scrollNodeRef.current;\n          const scrollTarget = scrollHeight - clientHeight;\n\n          scrollNodeRef.current.scrollTo({\n            top: scrollTarget,\n          });\n        }\n      });\n\n      observer.observe(node);\n    } else {\n      observerRef.current?.disconnect();\n      observerRef.current = undefined;\n    }\n  }, []);\n\n  const scrollRef = useCallback((node: HTMLDivElement | null) => {\n    if (node) {\n      onScrollRef.current = () => {\n        const { scrollTop, scrollHeight, clientHeight } = node;\n        const scrollTarget = scrollHeight - clientHeight;\n\n        autoScrollRef.current = Math.abs(scrollTop - scrollTarget) <= 10;\n      };\n\n      node.addEventListener('scroll', onScrollRef.current);\n\n      scrollNodeRef.current = node;\n    } else {\n      if (onScrollRef.current) {\n        scrollNodeRef.current?.removeEventListener('scroll', onScrollRef.current);\n      }\n\n      scrollNodeRef.current = undefined;\n      onScrollRef.current = undefined;\n    }\n  }, []);\n\n  return [messageRef, scrollRef];\n}\n", "tag": "", "tokens": 430, "metadata": {}}], "modify_time": 1733125234.6258683}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/useMessageParser.ts", "relative_path": "bolt.new/app/lib/hooks/useMessageParser.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/useMessageParser.ts", "source_code": "import type { Message } from 'ai';\nimport { useCallback, useState } from 'react';\nimport { StreamingMessageParser } from '~/lib/runtime/message-parser';\nimport { workbenchStore } from '~/lib/stores/workbench';\nimport { createScopedLogger } from '~/utils/logger';\n\nconst logger = createScopedLogger('useMessageParser');\n\nconst messageParser = new StreamingMessageParser({\n  callbacks: {\n    onArtifactOpen: (data) => {\n      logger.trace('onArtifactOpen', data);\n\n      workbenchStore.showWorkbench.set(true);\n      workbenchStore.addArtifact(data);\n    },\n    onArtifactClose: (data) => {\n      logger.trace('onArtifactClose');\n\n      workbenchStore.updateArtifact(data, { closed: true });\n    },\n    onActionOpen: (data) => {\n      logger.trace('onActionOpen', data.action);\n\n      // we only add shell actions when when the close tag got parsed because only then we have the content\n      if (data.action.type !== 'shell') {\n        workbenchStore.addAction(data);\n      }\n    },\n    onActionClose: (data) => {\n      logger.trace('onActionClose', data.action);\n\n      if (data.action.type === 'shell') {\n        workbenchStore.addAction(data);\n      }\n\n      workbenchStore.runAction(data);\n    },\n  },\n});\n\nexport function useMessageParser() {\n  const [parsedMessages, setParsedMessages] = useState<{ [key: number]: string }>({});\n\n  const parseMessages = useCallback((messages: Message[], isLoading: boolean) => {\n    let reset = false;\n\n    if (import.meta.env.DEV && !isLoading) {\n      reset = true;\n      messageParser.reset();\n    }\n\n    for (const [index, message] of messages.entries()) {\n      if (message.role === 'assistant') {\n        const newParsedContent = messageParser.parse(message.id, message.content);\n\n        setParsedMessages((prevParsed) => ({\n          ...prevParsed,\n          [index]: !reset ? (prevParsed[index] || '') + newParsedContent : newParsedContent,\n        }));\n      }\n    }\n  }, []);\n\n  return { parsedMessages, parseMessages };\n}\n", "tag": "", "tokens": 565, "metadata": {}}], "modify_time": 1733125234.6255314}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/index.ts", "relative_path": "bolt.new/app/lib/hooks/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/hooks/index.ts", "source_code": "export * from './useMessageParser';\nexport * from './usePromptEnhancer';\nexport * from './useShortcuts';\nexport * from './useSnapScroll';\n", "tag": "", "tokens": 45, "metadata": {}}], "modify_time": 1733125234.6253994}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/webcontainer/auth.client.ts", "relative_path": "bolt.new/app/lib/webcontainer/auth.client.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/webcontainer/auth.client.ts", "source_code": "/**\n * This client-only module that contains everything related to auth and is used\n * to avoid importing `@webcontainer/api` in the server bundle.\n */\n\nexport { auth, type AuthAPI } from '@webcontainer/api';\n", "tag": "", "tokens": 62, "metadata": {}}], "modify_time": 1733125234.6282427}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/webcontainer/index.ts", "relative_path": "bolt.new/app/lib/webcontainer/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/webcontainer/index.ts", "source_code": "import { WebContainer } from '@webcontainer/api';\nimport { WORK_DIR_NAME } from '~/utils/constants';\n\ninterface WebContainerContext {\n  loaded: boolean;\n}\n\nexport const webcontainerContext: WebContainerContext = import.meta.hot?.data.webcontainerContext ?? {\n  loaded: false,\n};\n\nif (import.meta.hot) {\n  import.meta.hot.data.webcontainerContext = webcontainerContext;\n}\n\nexport let webcontainer: Promise<WebContainer> = new Promise(() => {\n  // noop for ssr\n});\n\nif (!import.meta.env.SSR) {\n  webcontainer =\n    import.meta.hot?.data.webcontainer ??\n    Promise.resolve()\n      .then(() => {\n        return WebContainer.boot({ workdirName: WORK_DIR_NAME });\n      })\n      .then((webcontainer) => {\n        webcontainerContext.loaded = true;\n        return webcontainer;\n      });\n\n  if (import.meta.hot) {\n    import.meta.hot.data.webcontainer = webcontainer;\n  }\n}\n", "tag": "", "tokens": 271, "metadata": {}}], "modify_time": 1733125234.6283576}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/persistence/useChatHistory.ts", "relative_path": "bolt.new/app/lib/persistence/useChatHistory.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/persistence/useChatHistory.ts", "source_code": "import { useLoaderData, useNavigate } from '@remix-run/react';\nimport { useState, useEffect } from 'react';\nimport { atom } from 'nanostores';\nimport type { Message } from 'ai';\nimport { toast } from 'react-toastify';\nimport { workbenchStore } from '~/lib/stores/workbench';\nimport { getMessages, getNextId, getUrlId, openDatabase, setMessages } from './db';\n\nexport interface ChatHistoryItem {\n  id: string;\n  urlId?: string;\n  description?: string;\n  messages: Message[];\n  timestamp: string;\n}\n\nconst persistenceEnabled = !import.meta.env.VITE_DISABLE_PERSISTENCE;\n\nexport const db = persistenceEnabled ? await openDatabase() : undefined;\n\nexport const chatId = atom<string | undefined>(undefined);\nexport const description = atom<string | undefined>(undefined);\n\nexport function useChatHistory() {\n  const navigate = useNavigate();\n  const { id: mixedId } = useLoaderData<{ id?: string }>();\n\n  const [initialMessages, setInitialMessages] = useState<Message[]>([]);\n  const [ready, setReady] = useState<boolean>(false);\n  const [urlId, setUrlId] = useState<string | undefined>();\n\n  useEffect(() => {\n    if (!db) {\n      setReady(true);\n\n      if (persistenceEnabled) {\n        toast.error(`Chat persistence is unavailable`);\n      }\n\n      return;\n    }\n\n    if (mixedId) {\n      getMessages(db, mixedId)\n        .then((storedMessages) => {\n          if (storedMessages && storedMessages.messages.length > 0) {\n            setInitialMessages(storedMessages.messages);\n            setUrlId(storedMessages.urlId);\n            description.set(storedMessages.description);\n            chatId.set(storedMessages.id);\n          } else {\n            navigate(`/`, { replace: true });\n          }\n\n          setReady(true);\n        })\n        .catch((error) => {\n          toast.error(error.message);\n        });\n    }\n  }, []);\n\n  return {\n    ready: !mixedId || ready,\n    initialMessages,\n    storeMessageHistory: async (messages: Message[]) => {\n      if (!db || messages.length === 0) {\n        return;\n      }\n\n      const { firstArtifact } = workbenchStore;\n\n      if (!urlId && firstArtifact?.id) {\n        const urlId = await getUrlId(db, firstArtifact.id);\n\n        navigateChat(urlId);\n        setUrlId(urlId);\n      }\n\n      if (!description.get() && firstArtifact?.title) {\n        description.set(firstArtifact?.title);\n      }\n\n      if (initialMessages.length === 0 && !chatId.get()) {\n        const nextId = await getNextId(db);\n\n        chatId.set(nextId);\n\n        if (!urlId) {\n          navigateChat(nextId);\n        }\n      }\n\n      await setMessages(db, chatId.get() as string, messages, urlId, description.get());\n    },\n  };\n}\n\nfunction navigateChat(nextId: string) {\n  /**\n   * FIXME: Using the intended navigate function causes a rerender for <Chat /> that breaks the app.\n   *\n   * `navigate(`/chat/${nextId}`, { replace: true });`\n   */\n  const url = new URL(window.location.href);\n  url.pathname = `/chat/${nextId}`;\n\n  window.history.replaceState({}, '', url);\n}\n", "tag": "", "tokens": 874, "metadata": {}}], "modify_time": 1733125234.626394}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/persistence/index.ts", "relative_path": "bolt.new/app/lib/persistence/index.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/persistence/index.ts", "source_code": "export * from './db';\nexport * from './useChatHistory';\n", "tag": "", "tokens": 24, "metadata": {}}], "modify_time": 1733125234.626276}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/persistence/ChatDescription.client.tsx", "relative_path": "bolt.new/app/lib/persistence/ChatDescription.client.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/persistence/ChatDescription.client.tsx", "source_code": "import { useStore } from '@nanostores/react';\nimport { description } from './useChatHistory';\n\nexport function ChatDescription() {\n  return useStore(description);\n}\n", "tag": "", "tokens": 51, "metadata": {}}], "modify_time": 1733125234.6260402}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/persistence/db.ts", "relative_path": "bolt.new/app/lib/persistence/db.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/lib/persistence/db.ts", "source_code": "import type { Message } from 'ai';\nimport { createScopedLogger } from '~/utils/logger';\nimport type { ChatHistoryItem } from './useChatHistory';\n\nconst logger = createScopedLogger('ChatHistory');\n\n// this is used at the top level and never rejects\nexport async function openDatabase(): Promise<IDBDatabase | undefined> {\n  return new Promise((resolve) => {\n    const request = indexedDB.open('boltHistory', 1);\n\n    request.onupgradeneeded = (event: IDBVersionChangeEvent) => {\n      const db = (event.target as IDBOpenDBRequest).result;\n\n      if (!db.objectStoreNames.contains('chats')) {\n        const store = db.createObjectStore('chats', { keyPath: 'id' });\n        store.createIndex('id', 'id', { unique: true });\n        store.createIndex('urlId', 'urlId', { unique: true });\n      }\n    };\n\n    request.onsuccess = (event: Event) => {\n      resolve((event.target as IDBOpenDBRequest).result);\n    };\n\n    request.onerror = (event: Event) => {\n      resolve(undefined);\n      logger.error((event.target as IDBOpenDBRequest).error);\n    };\n  });\n}\n\nexport async function getAll(db: IDBDatabase): Promise<ChatHistoryItem[]> {\n  return new Promise((resolve, reject) => {\n    const transaction = db.transaction('chats', 'readonly');\n    const store = transaction.objectStore('chats');\n    const request = store.getAll();\n\n    request.onsuccess = () => resolve(request.result as ChatHistoryItem[]);\n    request.onerror = () => reject(request.error);\n  });\n}\n\nexport async function setMessages(\n  db: IDBDatabase,\n  id: string,\n  messages: Message[],\n  urlId?: string,\n  description?: string,\n): Promise<void> {\n  return new Promise((resolve, reject) => {\n    const transaction = db.transaction('chats', 'readwrite');\n    const store = transaction.objectStore('chats');\n\n    const request = store.put({\n      id,\n      messages,\n      urlId,\n      description,\n      timestamp: new Date().toISOString(),\n    });\n\n    request.onsuccess = () => resolve();\n    request.onerror = () => reject(request.error);\n  });\n}\n\nexport async function getMessages(db: IDBDatabase, id: string): Promise<ChatHistoryItem> {\n  return (await getMessagesById(db, id)) || (await getMessagesByUrlId(db, id));\n}\n\nexport async function getMessagesByUrlId(db: IDBDatabase, id: string): Promise<ChatHistoryItem> {\n  return new Promise((resolve, reject) => {\n    const transaction = db.transaction('chats', 'readonly');\n    const store = transaction.objectStore('chats');\n    const index = store.index('urlId');\n    const request = index.get(id);\n\n    request.onsuccess = () => resolve(request.result as ChatHistoryItem);\n    request.onerror = () => reject(request.error);\n  });\n}\n\nexport async function getMessagesById(db: IDBDatabase, id: string): Promise<ChatHistoryItem> {\n  return new Promise((resolve, reject) => {\n    const transaction = db.transaction('chats', 'readonly');\n    const store = transaction.objectStore('chats');\n    const request = store.get(id);\n\n    request.onsuccess = () => resolve(request.result as ChatHistoryItem);\n    request.onerror = () => reject(request.error);\n  });\n}\n\nexport async function deleteById(db: IDBDatabase, id: string): Promise<void> {\n  return new Promise((resolve, reject) => {\n    const transaction = db.transaction('chats', 'readwrite');\n    const store = transaction.objectStore('chats');\n    const request = store.delete(id);\n\n    request.onsuccess = () => resolve(undefined);\n    request.onerror = () => reject(request.error);\n  });\n}\n\nexport async function getNextId(db: IDBDatabase): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const transaction = db.transaction('chats', 'readonly');\n    const store = transaction.objectStore('chats');\n    const request = store.getAllKeys();\n\n    request.onsuccess = () => {\n      const highestId = request.result.reduce((cur, acc) => Math.max(+cur, +acc), 0);\n      resolve(String(+highestId + 1));\n    };\n\n    request.onerror = () => reject(request.error);\n  });\n}\n\nexport async function getUrlId(db: IDBDatabase, id: string): Promise<string> {\n  const idList = await getUrlIds(db);\n\n  if (!idList.includes(id)) {\n    return id;\n  } else {\n    let i = 2;\n\n    while (idList.includes(`${id}-${i}`)) {\n      i++;\n    }\n\n    return `${id}-${i}`;\n  }\n}\n\nasync function getUrlIds(db: IDBDatabase): Promise<string[]> {\n  return new Promise((resolve, reject) => {\n    const transaction = db.transaction('chats', 'readonly');\n    const store = transaction.objectStore('chats');\n    const idList: string[] = [];\n\n    const request = store.openCursor();\n\n    request.onsuccess = (event: Event) => {\n      const cursor = (event.target as IDBRequest<IDBCursorWithValue>).result;\n\n      if (cursor) {\n        idList.push(cursor.value.urlId);\n        cursor.continue();\n      } else {\n        resolve(idList);\n      }\n    };\n\n    request.onerror = () => {\n      reject(request.error);\n    };\n  });\n}\n", "tag": "", "tokens": 1448, "metadata": {}}], "modify_time": 1733125234.6261666}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/routes/api.chat.ts", "relative_path": "bolt.new/app/routes/api.chat.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/routes/api.chat.ts", "source_code": "import { type ActionFunctionArgs } from '@remix-run/cloudflare';\nimport { MAX_RESPONSE_SEGMENTS, MAX_TOKENS } from '~/lib/.server/llm/constants';\nimport { CONTINUE_PROMPT } from '~/lib/.server/llm/prompts';\nimport { streamText, type Messages, type StreamingOptions } from '~/lib/.server/llm/stream-text';\nimport SwitchableStream from '~/lib/.server/llm/switchable-stream';\n\nexport async function action(args: ActionFunctionArgs) {\n  return chatAction(args);\n}\n\nasync function chatAction({ context, request }: ActionFunctionArgs) {\n  const { messages } = await request.json<{ messages: Messages }>();\n\n  const stream = new SwitchableStream();\n\n  try {\n    const options: StreamingOptions = {\n      toolChoice: 'none',\n      onFinish: async ({ text: content, finishReason }) => {\n        if (finishReason !== 'length') {\n          return stream.close();\n        }\n\n        if (stream.switches >= MAX_RESPONSE_SEGMENTS) {\n          throw Error('Cannot continue message: Maximum segments reached');\n        }\n\n        const switchesLeft = MAX_RESPONSE_SEGMENTS - stream.switches;\n\n        console.log(`Reached max token limit (${MAX_TOKENS}): Continuing message (${switchesLeft} switches left)`);\n\n        messages.push({ role: 'assistant', content });\n        messages.push({ role: 'user', content: CONTINUE_PROMPT });\n\n        const result = await streamText(messages, context.cloudflare.env, options);\n\n        return stream.switchSource(result.toAIStream());\n      },\n    };\n\n    const result = await streamText(messages, context.cloudflare.env, options);\n\n    stream.switchSource(result.toAIStream());\n\n    return new Response(stream.readable, {\n      status: 200,\n      headers: {\n        contentType: 'text/plain; charset=utf-8',\n      },\n    });\n  } catch (error) {\n    console.log(error);\n\n    throw new Response(null, {\n      status: 500,\n      statusText: 'Internal Server Error',\n    });\n  }\n}\n", "tag": "", "tokens": 546, "metadata": {}}], "modify_time": 1733125234.628781}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/routes/chat.$id.tsx", "relative_path": "bolt.new/app/routes/chat.$id.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/routes/chat.$id.tsx", "source_code": "import { json, type LoaderFunctionArgs } from '@remix-run/cloudflare';\nimport { default as IndexRoute } from './_index';\n\nexport async function loader(args: LoaderFunctionArgs) {\n  return json({ id: args.params.id });\n}\n\nexport default IndexRoute;\n", "tag": "", "tokens": 76, "metadata": {}}], "modify_time": 1733125234.6290364}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/routes/api.enhancer.ts", "relative_path": "bolt.new/app/routes/api.enhancer.ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/routes/api.enhancer.ts", "source_code": "import { type ActionFunctionArgs } from '@remix-run/cloudflare';\nimport { StreamingTextResponse, parseStreamPart } from 'ai';\nimport { streamText } from '~/lib/.server/llm/stream-text';\nimport { stripIndents } from '~/utils/stripIndent';\n\nconst encoder = new TextEncoder();\nconst decoder = new TextDecoder();\n\nexport async function action(args: ActionFunctionArgs) {\n  return enhancerAction(args);\n}\n\nasync function enhancerAction({ context, request }: ActionFunctionArgs) {\n  const { message } = await request.json<{ message: string }>();\n\n  try {\n    const result = await streamText(\n      [\n        {\n          role: 'user',\n          content: stripIndents`\n          I want you to improve the user prompt that is wrapped in \\`<original_prompt>\\` tags.\n\n          IMPORTANT: Only respond with the improved prompt and nothing else!\n\n          <original_prompt>\n            ${message}\n          </original_prompt>\n        `,\n        },\n      ],\n      context.cloudflare.env,\n    );\n\n    const transformStream = new TransformStream({\n      transform(chunk, controller) {\n        const processedChunk = decoder\n          .decode(chunk)\n          .split('\\n')\n          .filter((line) => line !== '')\n          .map(parseStreamPart)\n          .map((part) => part.value)\n          .join('');\n\n        controller.enqueue(encoder.encode(processedChunk));\n      },\n    });\n\n    const transformedStream = result.toAIStream().pipeThrough(transformStream);\n\n    return new StreamingTextResponse(transformedStream);\n  } catch (error) {\n    console.log(error);\n\n    throw new Response(null, {\n      status: 500,\n      statusText: 'Internal Server Error',\n    });\n  }\n}\n", "tag": "", "tokens": 450, "metadata": {}}], "modify_time": 1733125234.6289284}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/routes/_index.tsx", "relative_path": "bolt.new/app/routes/_index.tsx", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/app/routes/_index.tsx", "source_code": "import { json, type MetaFunction } from '@remix-run/cloudflare';\nimport { ClientOnly } from 'remix-utils/client-only';\nimport { BaseChat } from '~/components/chat/BaseChat';\nimport { Chat } from '~/components/chat/Chat.client';\nimport { Header } from '~/components/header/Header';\n\nexport const meta: MetaFunction = () => {\n  return [{ title: 'Bolt' }, { name: 'description', content: 'Talk with Bolt, an AI assistant from StackBlitz' }];\n};\n\nexport const loader = () => json({});\n\nexport default function Index() {\n  return (\n    <div className=\"flex flex-col h-full w-full\">\n      <Header />\n      <ClientOnly fallback={<BaseChat />}>{() => <Chat />}</ClientOnly>\n    </div>\n  );\n}\n", "tag": "", "tokens": 213, "metadata": {}}], "modify_time": 1733125234.6286495}
{"file_path": "/Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/functions/[[path]].ts", "relative_path": "bolt.new/functions/[[path]].ts", "content": [{"module_name": "##File: /Users/allwefantasy/projects/auto-coder.web/ref_repos/bolt.new/functions/[[path]].ts", "source_code": "import type { ServerBuild } from '@remix-run/cloudflare';\nimport { createPagesFunctionHandler } from '@remix-run/cloudflare-pages';\n\n// @ts-ignore because the server build file is generated by `remix vite:build`\nimport * as serverBuild from '../build/server';\n\nexport const onRequest = createPagesFunctionHandler({\n  build: serverBuild as unknown as ServerBuild,\n});\n", "tag": "", "tokens": 104, "metadata": {}}], "modify_time": 1733125234.6331031}
